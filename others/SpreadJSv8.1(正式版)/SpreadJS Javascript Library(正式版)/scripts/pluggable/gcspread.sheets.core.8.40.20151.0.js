/*
 *
 * SpreadJS Library 8.40.20151.0
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 *
 * Licensed under the SpreadJS Commercial License. 
 * spread.sales@grapecity.com
 * http://spread.grapecity.com/Pages/Spread-JS-License/
 *
 *
 **/
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        var $ = jQuery,
            keyword_null = null;
        var Feature = (function()
            {
                function Feature(prop, getter, setter)
                {
                    this.prop = prop;
                    this.getter = getter;
                    this.setter = setter
                }
                Feature.parse = function(name)
                {
                    if (name !== undefined && name !== keyword_null && name.length > 0)
                    {
                        var parts = name.split('.');
                        var func = keyword_null;
                        do
                        {
                            var prop = parts.shift();
                            var curFunc = new Feature(prop, function()
                                {
                                    var self = this;
                                    if (!self.base)
                                    {
                                        return Sheets.features[self.prop]
                                    }
                                    return self.base.getter()[self.prop]
                                }, function(value)
                                {
                                    var self = this;
                                    if (self.base)
                                    {
                                        var container = self.base.getter();
                                        if (container === keyword_null || container === undefined)
                                        {
                                            self.base.setter(container = {})
                                        }
                                        container[self.prop] = value
                                    }
                                    else
                                    {
                                        Sheets.features[self.prop] = value
                                    }
                                });
                            if (func)
                            {
                                curFunc.base = func
                            }
                            func = curFunc
                        } while (parts.length > 0);
                        return func
                    }
                    return keyword_null
                };
                Feature.ensure = function(name)
                {
                    var desc = Feature.parse(name);
                    if (desc)
                    {
                        desc.setter(true)
                    }
                };
                Feature.check = function(list)
                {
                    var passed = true;
                    $.each(list, function(i, v)
                    {
                        var desc = Feature.parse(v);
                        if (desc)
                        {
                            if (!desc.getter())
                            {
                                return (passed = false)
                            }
                        }
                        return true
                    });
                    return passed
                };
                return Feature
            })();
        function feature(name, depends)
        {
            Feature.ensure(name);
            if (depends && depends.length > 0)
            {
                if (!Feature.check(depends))
                {
                    var console = window.console;
                    if (console && console.error)
                    {
                        console.error("[" + name + "]: One or more dependency in [" + depends + "] are not found!")
                    }
                }
            }
        }
        Sheets.feature = feature;
        Sheets.features = (function(features)
        {
            if (features)
            {
                return features
            }
            return {
                    core: {
                        migrate: false, mousewheel: false, stringResource: false, common: false, imageLoader: false, theme: false, globalize: false, spreadpanelex: false, basecelltype: false, sheet_model: false, sheet_action: false, sheet_event: false, sheet_border: false, sheet_render: false, sheet_ui: false, sheet: false, spread: false, spread_ui: false, cultureInfo: false
                    }, calc: {
                            common: false, functions: false, functions_db: false, functions_eng: false, functions_fin: false, functions_lookup: false, functions_stat: false
                        }, filter: false, filter_ui: false, sparkline: false, table: false, binding: false, group: false, celltype: false, conditionalFormat: false, dataValidator: false, fill: false, fill_ui: false, formatter: false, search: false, touch: false, floatingObject: false, comment: false, sparklineEx: false, formulatextbox: false, formulatextbox_resource: false, basedialog: false
                }
        })(Sheets.features)
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        (function(migrate)
        {
            Sheets.feature("core.migrate");
            (function(window, $)
            {
                var version = $().jquery ? $().jquery.split('.') : "";
                if ((parseInt(version[0], 10) > 1) || (parseInt(version[0], 10) === 1 && parseInt(version[1], 10) >= 9))
                {
                    $.event.handle = $.event.dispatch;
                    var matched,
                        browser;
                    $.uaMatch = function(ua)
                    {
                        ua = ua.toLowerCase();
                        var match = /(chrome)[ \/]([\w.]+)/.exec(ua) || /(webkit)[ \/]([\w.]+)/.exec(ua) || /(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua) || /(msie) ([\w.]+)/.exec(ua) || ua.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua) || [];
                        return {
                                browser: match[1] || "", version: match[2] || "0"
                            }
                    };
                    if (!$.browser)
                    {
                        matched = $.uaMatch(navigator.userAgent);
                        browser = {};
                        if (matched.browser)
                        {
                            browser[matched.browser] = true;
                            browser.version = matched.version
                        }
                        if (browser.chrome)
                        {
                            browser.webkit = true
                        }
                        else if (browser.webkit)
                        {
                            browser.safari = true
                        }
                        $.browser = browser
                    }
                    var oldToggle = $.fn.toggle;
                    $.fn.toggle = function(fn, fn2)
                    {
                        if (!$.isFunction(fn) || !$.isFunction(fn2))
                        {
                            return oldToggle.apply(this, arguments)
                        }
                        var args = arguments,
                            guid = fn.guid || $.guid++,
                            i = 0,
                            toggler;
                        toggler = function(event)
                        {
                            var lastToggle = ($._data(this, "lastToggle" + fn.guid) || 0) % i;
                            $._data(this, "lastToggle" + fn.guid, lastToggle + 1);
                            event.preventDefault();
                            return args[lastToggle].apply(this, arguments) || false
                        };
                        toggler.guid = guid;
                        while (i < args.length)
                        {
                            args[i++].guid = guid
                        }
                        return this.click(toggler)
                    };
                    var oldSelf = $.fn.andSelf || $.fn.addBack;
                    $.fn.andSelf = function()
                    {
                        return oldSelf.apply(this, arguments)
                    }
                }
                var uaForIE = navigator.userAgent.toLowerCase();
                var isIE11 = uaForIE.indexOf("compatible") < 0 && (/(trident)(?:.*? rv ([\w.]+)|)/.exec(uaForIE) !== null);
                if (isIE11)
                {
                    if ($.browser)
                    {
                        $.browser.mozilla = undefined;
                        $.browser["msie"] = true
                    }
                }
                var metrotest = function()
                    {
                        var errorName = null;
                        var supported = null;
                        try
                        {
                            new ActiveXObject("")
                        }
                        catch(e)
                        {
                            errorName = e.name
                        }
                        try
                        {
                            supported = !!new ActiveXObject("htmlfile")
                        }
                        catch(e)
                        {
                            supported = false
                        }
                        if (errorName != 'ReferenceError' && supported == false)
                        {
                            supported = false
                        }
                        else
                        {
                            supported = true
                        }
                        return !supported
                    };
                if ($.browser.msie && metrotest())
                {
                    $.browser.metroMode = true
                }
            })(window, jQuery)
        })(Sheets.migrate || (Sheets.migrate = {}));
        var migrate = Sheets.migrate
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        (function(_mousewheel)
        {
            Sheets.feature("core.mousewheel", ["core.migrate"]);
            var domMS = 'DOMMouseScroll',
                mousewheel = 'mousewheel',
                cundefined = 'undefined',
                on = 'on',
                types = [domMS, mousewheel];
            if (typeof jQuery.event.special.gcmousewheel === cundefined)
            {
                (function($)
                {
                    function handler(event)
                    {
                        var args = [].slice.call(arguments, 1),
                            delta = 0,
                            returnValue = true;
                        event = $.event.fix(event || window.event);
                        event.type = "gc" + mousewheel;
                        if ((typeof event.wheelDelta === cundefined || event.wheelDelta === null) && (typeof event.detail === cundefined || event.detail === null))
                        {
                            event.wheelDelta = event.originalEvent.wheelDelta;
                            event.detail = event.originalEvent.detail
                        }
                        if (event.wheelDelta)
                        {
                            delta = event.wheelDelta / 120
                        }
                        if (event.detail)
                        {
                            delta = -event.detail / 3
                        }
                        args.unshift(event, delta);
                        return $.event.handle.apply((event.target || event.srcElement), args)
                    }
                    $.event.special.gcmousewheel = {
                        setup: function()
                        {
                            if (this.addEventListener)
                            {
                                for (var i = types.length; i; )
                                {
                                    var t = types[--i];
                                    if (t === mousewheel)
                                    {
                                        this.addEventListener(domMS, handler, false)
                                    }
                                    this.addEventListener(t, handler, false)
                                }
                            }
                            else
                            {
                                this.attachEvent(on + mousewheel, handler)
                            }
                        }, teardown: function()
                            {
                                if (this.removeEventListener)
                                {
                                    for (var i = types.length; i; )
                                    {
                                        var t = types[--i];
                                        if (t === mousewheel)
                                        {
                                            this.removeEventListener(domMS, handler, false)
                                        }
                                        this.removeEventListener(t, handler, false)
                                    }
                                }
                                else
                                {
                                    this.detachEvent(on + mousewheel, handler)
                                }
                            }
                    };
                    $.fn.extend({
                        handlegcmousewheel: function(fn)
                        {
                            return fn ? this.bind(mousewheel, fn) : this.trigger(mousewheel)
                        }, unhandlegcmousewheel: function(fn)
                            {
                                return this.unbind(mousewheel, fn)
                            }
                    })
                }(jQuery))
            }
        })(Sheets.mousewheel || (Sheets.mousewheel = {}));
        var mousewheel = Sheets.mousewheel
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.stringResource");
        var _ENStringResource = (function()
            {
                function _ENStringResource(){}
                _ENStringResource.getHelpFuncs = function()
                {
                    var fbxResource = GcSpread.Sheets.FormulaTextBoxResource_EN;
                    if (fbxResource)
                    {
                        return fbxResource.Functions
                    }
                    return null
                };
                _ENStringResource.getHelpTableFuncs = function()
                {
                    var fbxResource = GcSpread.Sheets.FormulaTextBoxResource_EN;
                    if (fbxResource)
                    {
                        return fbxResource.Table_Functions
                    }
                    return null
                };
                _ENStringResource.Exp_InvalidArgument = "Invalid argument";
                _ENStringResource.Exp_InvalidCast = "InvalidCastException";
                _ENStringResource.Exp_NotSupport = "NotSupportException";
                _ENStringResource.Exp_FormulaInvalid = "The formula you typed contains an invalid char: ";
                _ENStringResource.Exp_InvalidTokenAt = "invalid token at ";
                _ENStringResource.Exp_InvalidArrayAt = "Invalid array at ";
                _ENStringResource.Exp_InvalidCellReference = "Invalid cell reference or name at ";
                _ENStringResource.Exp_InvalidFunctionName = "Invalid function name";
                _ENStringResource.Exp_InvalidOverrideFunction = "Cannot override built-in function";
                _ENStringResource.Exp_OverrideNotAllowed = "Attempt to override function while override is not allowed";
                _ENStringResource.Exp_NoSyntax = "no syntax '";
                _ENStringResource.Exp_MatchSyntax = "'to match the syntax '";
                _ENStringResource.SingleQuotesFullStop = "'.";
                _ENStringResource.SingleQuote = "'";
                _ENStringResource.Exp_IsValid = "' is invalid.";
                _ENStringResource.Exp_InvalidArray = "Invalid array";
                _ENStringResource.AtIndexOn = "' at index on ";
                _ENStringResource.FullStop = ".";
                _ENStringResource.SingleQuoteAt = "' at ";
                _ENStringResource.Exp_InvalidParameters = "Invalid function parameters at ";
                _ENStringResource.Exp_InvalidArrayColumns = "The length of array columns are unequal at ";
                _ENStringResource.Exp_ExprIsNull = "The argument 'expr' is null";
                _ENStringResource.Exp_RuleIsNull = "The argument 'rule' is null";
                _ENStringResource.CopyCells = "Copy Cells";
                _ENStringResource.FillSeries = "Fill Series";
                _ENStringResource.FillFormattingOnly = "Fill Formatting Only";
                _ENStringResource.FillWithoutFormatting = "Fill Without Formatting";
                _ENStringResource.Exp_NumberOnly = "Only works for Numbers";
                _ENStringResource.Exp_RangeContainsMergedCell = "Range should not have merged cell.";
                _ENStringResource.Exp_ChangeMergedCell = "Cannot change part of merged cell.";
                _ENStringResource.Exp_TargetContainsMergedCells = "Target range should not have merged cells.";
                _ENStringResource.Exp_MergedCellsIdentical = "This operation requires the merged cells to be identically sized.";
                _ENStringResource.SortAscending = "Sort Ascending";
                _ENStringResource.SortDescending = "Sort Descending";
                _ENStringResource.OK = "OK";
                _ENStringResource.Cancel = "Cancel";
                _ENStringResource.Search = "Search";
                _ENStringResource.CheckAll = "Check all";
                _ENStringResource.UncheckAll = "Uncheck all";
                _ENStringResource.Blanks = "(Blanks)";
                _ENStringResource.ls = ["", "506f776572656420627920477261706543697479205370726561642e53686565747320547269616c2056657273696f6e0d0a4e6f74204c6963656e73656420666f7220446973747269627574696f6e"];
                _ENStringResource.Exp_FilterItemIsNull = "FilterItem is null.";
                _ENStringResource.Exp_InvalidColumnIndex = "Invalid column index.";
                _ENStringResource.Exp_TokenIsNull = "token is null";
                _ENStringResource.Exp_InvalidBackslash = "the '\\' cannot be evaluated";
                _ENStringResource.Exp_FormatIllegal = "format is illegal.";
                _ENStringResource.Exp_ValueIsNull = "value is null";
                _ENStringResource.Exp_PartIsNull = "part is null";
                _ENStringResource.Exp_DuplicatedDescriptor = "The type of descriptor was added.";
                _ENStringResource.Exp_TokenIllegal = "token is illegal.";
                _ENStringResource.Exp_ValueIllegal = "value is illegal.";
                _ENStringResource.Exp_StringIllegal = "string is illegal.";
                _ENStringResource.Exp_InvalidNull = "InvalidNullException";
                _ENStringResource.Exp_InvalidOperation = "InvalidOperationException";
                _ENStringResource.Exp_ArgumentNull = "ArgumentNullException";
                _ENStringResource.Exp_CriteriaIsNull = "criteria is null";
                _ENStringResource.Exp_InvalidString = "Invalid string";
                _ENStringResource.Exp_InvalidDateFormat = "Invalid date format pattern";
                _ENStringResource.Exp_InvalidOADate = "invalid OADate";
                _ENStringResource.Exp_InvalidExponentFormat = "invalid exponent format";
                _ENStringResource.Exp_InvalidSemicolons = "invalid format: too many semicolons";
                _ENStringResource.Exp_InvalidNumberGroupSize = "NumberGroupSize must be between 1 and 9.";
                _ENStringResource.Exp_BadFormatSpecifier = "Bad Format Specifier";
                _ENStringResource.Exp_InvalidNumberFormat = "Invalid number format pattern";
                _ENStringResource.Exp_InvalidIndex = "Invalid index";
                _ENStringResource.Exp_InvalidCount = "Invalid count";
                _ENStringResource.Exp_InvalidLevel = "Invalid level";
                _ENStringResource.Exp_GroupInfoIsNull = "groupInfo is null";
                _ENStringResource.Exp_SheetIsNull = "sheet is null.";
                _ENStringResource.Exp_DestSheetIsNull = "destSheet is null";
                _ENStringResource.Exp_PasteExtentIsNull = "pasteExtent is null";
                _ENStringResource.Exp_InvalidPastedArea = "The pasted area should have the same size as the copy or cut area.";
                _ENStringResource.Exp_ChangePartOfArray = "Cannot change part of an array.";
                _ENStringResource.Exp_ColumnReadOnly = "The column you are trying to change is protected and therefore read-only.";
                _ENStringResource.Exp_RowReadOnly = "The row you are trying to change is protected and therefore read-only.";
                _ENStringResource.Exp_CellReadOnly = "The row you are trying to change is protected and therefore read-only.";
                _ENStringResource.Exp_FillRangeContainsMergedCell = "Cannot fill range that contains a merged cell.";
                _ENStringResource.Exp_FillCellsReadOnly = "The cells you are trying to fill is protected and therefore read-only.";
                _ENStringResource.Exp_OverlappingSpans = "This operation will cause overlapping spans.";
                _ENStringResource.Exp_InvalidAndSpace = "Invalid ";
                _ENStringResource.ColonSpace = ": ";
                _ENStringResource.MustBeBetween = " (must be between ";
                _ENStringResource.SpaceAndSpace = " and ";
                _ENStringResource.RightBracketFullStop = ").";
                _ENStringResource.Exp_SrcIsNull = "The argument 'src' is null";
                _ENStringResource.Exp_DestIsNull = "The argument 'dest' is null";
                _ENStringResource.Exp_InvalidCustomFunction = "invalid custom function";
                _ENStringResource.Exp_InvalidCustomName = "invalid custom name";
                _ENStringResource.Exp_IndexOutOfRange = "Index is out of range!";
                _ENStringResource.Exp_InvalidRange = "Invalid range";
                _ENStringResource.Exp_RangeIsNull = "range is null";
                _ENStringResource.Exp_NotAFunction = "is not a function";
                _ENStringResource.Exp_Format = 'Format';
                _ENStringResource.Exp_BraceMismatch = 'format: brace mis-match';
                _ENStringResource.Exp_InvalidFormat = 'invalid format';
                _ENStringResource.Exp_ArgumentOutOfRange = "ArgumentOutOfRange";
                _ENStringResource.Exp_DragDropShiftTableCell = "This operation is not allowed. The operation is attempting to shift cells in a table on your worksheet.";
                _ENStringResource.Exp_DragDropChangePartOfTable = "Cannot complete operation: You are attempting to change a portion of a table row or column in a way that is not allowed.";
                _ENStringResource.Exp_TableEmptyNameError = "The table name cannot be empty.";
                _ENStringResource.Exp_TableInvalidRow = "Invalid row index or row count.";
                _ENStringResource.Exp_TableInvalidColumn = "Invalid column index or column count.";
                _ENStringResource.Exp_TableIntersectError = "The tables cannot be intersected.";
                _ENStringResource.Exp_TableHasSameNameError = "The current worksheet already exists in a table with the same name.";
                _ENStringResource.Exp_TableDataSourceNullError = "Table datasource cannot be null.";
                _ENStringResource.Exp_TableStyleAddCustomStyleError = "The style with the same name already exists in the styles.";
                _ENStringResource.Exp_TableMoveOutOfRange = "The table cannot be moved out of the sheet.";
                _ENStringResource.Exp_TableResizeOutOfRange = "The invalid row count, column count and table cannot be resize out of the sheet.";
                _ENStringResource.Exp_PasteSourceCellsLocked = "Source sheet's cells are locked.";
                _ENStringResource.Exp_InvalidCopyPasteSize = "The copy and paste areas are not the same size.";
                _ENStringResource.Exp_PasteDestinationCellsLocked = "The cell you are trying to change is protected and therefore read-only.";
                _ENStringResource.Exp_PasteChangeMergeCell = "Cannot change part of a merged cell.";
                _ENStringResource.Tip_Row = "Row: ";
                _ENStringResource.Tip_Column = "Column: ";
                _ENStringResource.Tip_Height = "Height: ";
                _ENStringResource.Tip_Width = "Width: ";
                _ENStringResource.Tip_pixels = " pixels";
                _ENStringResource.NewTab = "New...";
                _ENStringResource.Exp_EmptyNamedStyle = "The name of named style cannot be empty or null";
                _ENStringResource.Exp_FloatingObjectHasSameNameError = "The current worksheet already has a floating object with the same name.";
                _ENStringResource.Exp_FloatingObjectNameEmptyError = "Floating object must have name";
                _ENStringResource.ToolStrip_PasteText = "Paste";
                _ENStringResource.ToolStrip_CutText = "Cut";
                _ENStringResource.ToolStrip_CopyText = "Copy";
                _ENStringResource.ToolStrip_AutoFillText = "AutoFill";
                _ENStringResource.Exp_ArrayFromulaPart = "You cannot change part of an array.";
                _ENStringResource.Exp_ArrayFromulaSpan = "Array formulas are not valid in merged cells.";
                _ENStringResource.Exp_ArrayFormulaTable = "multi-cell array formulas are not allowed in tables.";
                _ENStringResource.Fbx_Summary = "Summary";
                _ENStringResource.Fbx_TableName_Description = "Table name for ";
                _ENStringResource.Fbx_CustomName_Description = "Custom name for ";
                return _ENStringResource
            })();
        Sheets._ENStringResource = _ENStringResource;
        var _JPStringResource = (function()
            {
                function _JPStringResource(){}
                _JPStringResource.getHelpFuncs = function()
                {
                    var fbxResource = GcSpread.Sheets.FormulaTextBoxResource_JP;
                    if (fbxResource)
                    {
                        return fbxResource.Functions
                    }
                    return null
                };
                _JPStringResource.getHelpTableFuncs = function()
                {
                    var fbxResource = GcSpread.Sheets.FormulaTextBoxResource_JP;
                    if (fbxResource)
                    {
                        return fbxResource.Table_Functions
                    }
                    return null
                };
                _JPStringResource.Exp_InvalidArgument = "\u7121\u52b9\u306a\u5f15\u6570";
                _JPStringResource.Exp_InvalidCast = "\u4f8b\u5916:\u7121\u52b9\u306a\u30ad\u30e3\u30b9\u30c8";
                _JPStringResource.Exp_NotSupport = "\u4f8b\u5916:\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u306a\u3044\u6a5f\u80fd\u306e\u5229\u7528\u3092\u8a66\u307f\u307e\u3057\u305f";
                _JPStringResource.Exp_FormulaInvalid = "\u5165\u529b\u3055\u308c\u305f\u6570\u5f0f\u306f\u7121\u52b9\u306a\u6587\u5b57\u3092\u542b\u3093\u3067\u3044\u307e\u3059 : ";
                _JPStringResource.Exp_InvalidTokenAt = "\u7121\u52b9\u306a\u30c8\u30fc\u30af\u30f3 : ";
                _JPStringResource.Exp_InvalidArrayAt = "\u7121\u52b9\u306a\u914d\u5217 : ";
                _JPStringResource.Exp_InvalidCellReference = "\u30bb\u30eb\u540d\u3082\u3057\u304f\u306f\u30bb\u30eb\u53c2\u7167\u304c\u7121\u52b9\u3067\u3059 : ";
                _JPStringResource.Exp_InvalidFunctionName = "\u7121\u52b9\u306a\u95a2\u6570\u540d";
                _JPStringResource.Exp_InvalidOverrideFunction = "\u7d44\u8fbc\u95a2\u6570\u3092\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093";
                _JPStringResource.Exp_OverrideNotAllowed = "\u8a31\u53ef\u3055\u308c\u3066\u3044\u306a\u3044\u95a2\u6570\u30aa\u30fc\u30d0\u30fc\u30e9\u30a4\u30c9\u306e\u5b9f\u884c\u3067\u3059";
                _JPStringResource.Exp_NoSyntax = "\u69cb\u6587 '";
                _JPStringResource.Exp_MatchSyntax = "' \u306f\u6b21\u306e\u69cb\u6587 '";
                _JPStringResource.SingleQuotesFullStop = "' \u3068\u30de\u30c3\u30c1\u3057\u307e\u305b\u3093\u3067\u3057\u305f\u3002";
                _JPStringResource.SingleQuote = "'";
                _JPStringResource.Exp_IsValid = "' \u306f\u7121\u52b9\u3067\u3059\u3002";
                _JPStringResource.Exp_InvalidArray = "\u7121\u52b9\u306a\u914d\u5217 : ";
                _JPStringResource.AtIndexOn = "' \u8a72\u5f53\u3059\u308b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9 : ";
                _JPStringResource.FullStop = "";
                _JPStringResource.SingleQuoteAt = "' \u4f4d\u7f6e : ";
                _JPStringResource.Exp_InvalidParameters = "\u7121\u52b9\u306a\u30d1\u30e9\u30e1\u30fc\u30bf\u306e\u691c\u51fa : ";
                _JPStringResource.Exp_InvalidArrayColumns = "\u914d\u5217\u306e\u30ab\u30e9\u30e0\u9577\u304c\u4e00\u81f4\u3057\u307e\u305b\u3093 \u4f4d\u7f6e : ";
                _JPStringResource.Exp_ExprIsNull = "\u5f15\u6570 'expr' \u304c null \u3067\u3059";
                _JPStringResource.Exp_RuleIsNull = "\u5f15\u6570 'rule' \u304c null \u3067\u3059";
                _JPStringResource.CopyCells = "\u30bb\u30eb\u306e\u30b3\u30d4\u30fc";
                _JPStringResource.FillSeries = "\u9023\u7d50\u30c7\u30fc\u30bf";
                _JPStringResource.FillFormattingOnly = "\u66f8\u5f0f\u306e\u307f\u30b3\u30d4\u30fc";
                _JPStringResource.FillWithoutFormatting = "\u66f8\u5f0f\u306a\u3057\u30b3\u30d4\u30fc";
                _JPStringResource.Exp_NumberOnly = "\u6570\u5b57\u306e\u307f\u6709\u52b9\u3067\u3059";
                _JPStringResource.Exp_RangeContainsMergedCell = "\u7d50\u5408\u3055\u308c\u305f\u30bb\u30eb\u304c\u7bc4\u56f2\u306b\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_ChangeMergedCell = "\u7d50\u5408\u3055\u308c\u305f\u30bb\u30eb\u306e\u4e00\u90e8\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_TargetContainsMergedCells = "\u7d50\u5408\u3055\u308c\u305f\u30bb\u30eb\u304c\u6307\u5b9a\u306e\u7bc4\u56f2\u306b\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_MergedCellsIdentical = "\u3053\u306e\u64cd\u4f5c\u306b\u306f\u540c\u3058\u30b5\u30a4\u30ba\u306e\u7d50\u5408\u30bb\u30eb\u304c\u5fc5\u8981\u3067\u3059\u3002";
                _JPStringResource.SortAscending = "\u6607\u9806";
                _JPStringResource.SortDescending = "\u964d\u9806";
                _JPStringResource.OK = "OK";
                _JPStringResource.Cancel = "\u30ad\u30e3\u30f3\u30bb\u30eb";
                _JPStringResource.Search = "\u691c\u7d22";
                _JPStringResource.CheckAll = "\u3059\u3079\u3066\u9078\u629e";
                _JPStringResource.UncheckAll = "\u3059\u3079\u3066\u89e3\u9664";
                _JPStringResource.Blanks = "(\u7a7a\u767d\u30bb\u30eb)";
                _JPStringResource.ls = ["30303030303030685f4f790000000000000000000000000000303030303072000067303030303030915e30796b303030303030", "b0ecfcd7b7c6a32a0f1a3e205370726561642e536865657473c8e9a4a2eb480d0a2cd0fcb8e7f36e4d036f8162558c66447e59"];
                _JPStringResource.Exp_FilterItemIsNull = "\u30d5\u30a3\u30eb\u30bf\u9805\u76ee\u304c null \u3067\u3059\u3002";
                _JPStringResource.Exp_InvalidColumnIndex = "\u7121\u52b9\u306a\u5217\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3067\u3059\u3002";
                _JPStringResource.Exp_TokenIsNull = "\u30c8\u30fc\u30af\u30f3\u304c null \u3067\u3059";
                _JPStringResource.Exp_InvalidBackslash = "'\\' \u3092\u8a55\u4fa1\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_FormatIllegal = "\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u4e0d\u6b63\u3067\u3059\u3002";
                _JPStringResource.Exp_ValueIsNull = "\u5024\u306f null \u3067\u3059";
                _JPStringResource.Exp_PartIsNull = "part \u306f null \u3067\u3059";
                _JPStringResource.Exp_DuplicatedDescriptor = "\u305d\u306e\u7a2e\u985e\u306e\u8a18\u8ff0\u5b50\u306f\u65e2\u306b\u8ffd\u52a0\u3055\u308c\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_TokenIllegal = "\u30c8\u30fc\u30af\u30f3\u304c\u4e0d\u6b63\u3067\u3059\u3002";
                _JPStringResource.Exp_ValueIllegal = "\u5024\u304c\u4e0d\u6b63\u3067\u3059\u3002";
                _JPStringResource.Exp_StringIllegal = "\u6587\u5b57\u5217\u304c\u4e0d\u6b63\u3067\u3059\u3002";
                _JPStringResource.Exp_InvalidNull = "\u7121\u52b9\u306a null \u306b\u3088\u308b\u4f8b\u5916";
                _JPStringResource.Exp_InvalidOperation = "\u7121\u52b9\u306a\u64cd\u4f5c\u306b\u3088\u308b\u4f8b\u5916";
                _JPStringResource.Exp_ArgumentNull = "null \u5f15\u6570\u306b\u3088\u308b\u4f8b\u5916";
                _JPStringResource.Exp_CriteriaIsNull = "\u6761\u4ef6\u3068\u306a\u308b\u5f15\u6570\u304c null \u3067\u3059";
                _JPStringResource.Exp_InvalidString = "\u7121\u52b9\u306a\u6587\u5b57\u5217";
                _JPStringResource.Exp_InvalidDateFormat = "\u7121\u52b9\u306a\u65e5\u4ed8\u30d5\u30a9\u30fc\u30de\u30c3\u30c8";
                _JPStringResource.Exp_InvalidOADate = "\u7121\u52b9\u306a OADate";
                _JPStringResource.Exp_InvalidExponentFormat = "\u7121\u52b9\u306a\u6307\u6570\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u3067\u3059";
                _JPStringResource.Exp_InvalidSemicolons = "\u7121\u52b9\u306a\u30d5\u30a9\u30fc\u30de\u30c3\u30c8: \u30bb\u30df\u30b3\u30ed\u30f3\u304c\u591a\u3059\u304e\u307e\u3059";
                _JPStringResource.Exp_InvalidNumberGroupSize = "NumberGroupSize \u306f1\u304b\u30899\u306e\u5024\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002";
                _JPStringResource.Exp_BadFormatSpecifier = "\u8aa4\u3063\u305f\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u6307\u793a\u5b50";
                _JPStringResource.Exp_InvalidNumberFormat = "\u7121\u52b9\u306a\u6570\u5024\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u306e\u30d1\u30bf\u30fc\u30f3\u3067\u3059";
                _JPStringResource.Exp_InvalidIndex = "\u7121\u52b9\u306a\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3067\u3059";
                _JPStringResource.Exp_InvalidCount = "\u7121\u52b9\u306a\u30ab\u30a6\u30f3\u30c8\u3067\u3059";
                _JPStringResource.Exp_InvalidLevel = "\u7121\u52b9\u306a\u30ec\u30d9\u30eb\u3067\u3059";
                _JPStringResource.Exp_GroupInfoIsNull = "groupInfo \u304c null \u3067\u3059";
                _JPStringResource.Exp_SheetIsNull = "sheet \u304c null\u3067\u3059\u3002";
                _JPStringResource.Exp_DestSheetIsNull = "destSheet \u304c null \u3067\u3059\u3002";
                _JPStringResource.Exp_PasteExtentIsNull = "pasteExtent \u304c null \u3067\u3059";
                _JPStringResource.Exp_InvalidPastedArea = "\u8cbc\u308a\u4ed8\u3051\u9818\u57df\u306f\u30b3\u30d4\u30fc/\u5207\u308a\u53d6\u308a\u7bc4\u56f2\u3068\u540c\u30b5\u30a4\u30ba\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002";
                _JPStringResource.Exp_ChangePartOfArray = "\u914d\u5217\u306e\u4e00\u90e8\u3092\u5909\u66f4\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_ColumnReadOnly = "\u5909\u66f4\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u5217\u306f\u4fdd\u8b77\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u8aad\u307f\u53d6\u308a\u5c02\u7528\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_RowReadOnly = "\u5909\u66f4\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u884c\u306f\u4fdd\u8b77\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u8aad\u307f\u53d6\u308a\u5c02\u7528\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_CellReadOnly = "\u5909\u66f4\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u30bb\u30eb\u306f\u4fdd\u8b77\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u8aad\u307f\u53d6\u308a\u5c02\u7528\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_FillRangeContainsMergedCell = "\u7d50\u5408\u3057\u305f\u30bb\u30eb\u304c\u542b\u307e\u308c\u308b\u7bc4\u56f2\u3092\u30d5\u30a3\u30eb\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_FillCellsReadOnly = "\u30d5\u30a3\u30eb\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u7bc4\u56f2\u306f\u4fdd\u8b77\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u8aad\u307f\u53d6\u308a\u5c02\u7528\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_OverlappingSpans = "\u3053\u306e\u64cd\u4f5c\u306f\u7d50\u5408\u90e8\u5206\u306e\u91cd\u8907\u3092\u5f15\u304d\u8d77\u3053\u3057\u307e\u3059\u3002";
                _JPStringResource.Exp_InvalidAndSpace = "\u7121\u52b9\u306a ";
                _JPStringResource.ColonSpace = " : ";
                _JPStringResource.MustBeBetween = " \u306f ";
                _JPStringResource.SpaceAndSpace = " \u304b\u3089 ";
                _JPStringResource.RightBracketFullStop = " \u306e\u9593\u3067\u3042\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002";
                _JPStringResource.Exp_SrcIsNull = "\u5f15\u6570 'src' \u306f null \u3067\u3059";
                _JPStringResource.Exp_DestIsNull = "\u5f15\u6570 'dest' \u306f null \u3067\u3059";
                _JPStringResource.Exp_InvalidCustomFunction = "\u7121\u52b9\u306a\u30ab\u30b9\u30bf\u30e0\u95a2\u6570";
                _JPStringResource.Exp_InvalidCustomName = "\u7121\u52b9\u306a\u540d\u524d";
                _JPStringResource.Exp_IndexOutOfRange = "\u7bc4\u56f2\u5916\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3067\u3059!";
                _JPStringResource.Exp_InvalidRange = "\u7121\u52b9\u306a\u7bc4\u56f2";
                _JPStringResource.Exp_RangeIsNull = "\u7bc4\u56f2\u304c null \u3067\u3059";
                _JPStringResource.Exp_NotAFunction = "\u306f\u95a2\u6570\u3067\u306f\u3042\u308a\u307e\u305b\u3093";
                _JPStringResource.Exp_Format = '\u30d5\u30a9\u30fc\u30de\u30c3\u30c8';
                _JPStringResource.Exp_BraceMismatch = '\u30d5\u30a9\u30fc\u30de\u30c3\u30c8: \u62ec\u5f27\u306e\u500b\u6570\u304c\u4e00\u81f4\u3057\u3066\u3044\u307e\u305b\u3093';
                _JPStringResource.Exp_InvalidFormat = '\u7121\u52b9\u306a\u30d5\u30a9\u30fc\u30de\u30c3\u30c8';
                _JPStringResource.Exp_ArgumentOutOfRange = "\u7bc4\u56f2\u5916\u306e\u5f15\u6570";
                _JPStringResource.Exp_DragDropShiftTableCell = "\u3053\u306e\u64cd\u4f5c\u306f\u30ef\u30fc\u30af\u30b7\u30fc\u30c8\u4e0a\u306e\u30c6\u30fc\u30d6\u30eb\u5185\u3067\u30bb\u30eb\u3092\u30b7\u30d5\u30c8\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u305f\u3081\u8a31\u53ef\u3055\u308c\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_DragDropChangePartOfTable = "\u64cd\u4f5c\u3092\u5b8c\u4e86\u3067\u304d\u307e\u305b\u3093\u3002\u8a31\u53ef\u3055\u308c\u3066\u3044\u306a\u3044\u65b9\u6cd5\u3067\u30c6\u30fc\u30d6\u30eb\u306e\u884c\u307e\u305f\u306f\u5217\u306e\u4e00\u90e8\u3092\u5909\u66f4\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_TableEmptyNameError = "\u30c6\u30fc\u30d6\u30eb\u540d\u3092\u7a7a\u306b\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_TableInvalidRow = "\u7121\u52b9\u306a\u884c\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3082\u3057\u304f\u306f\u884c\u6570\u3067\u3059\u3002";
                _JPStringResource.Exp_TableInvalidColumn = "\u7121\u52b9\u306a\u5217\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3082\u3057\u304f\u306f\u5217\u6570\u3067\u3059\u3002";
                _JPStringResource.Exp_TableIntersectError = "\u30c6\u30fc\u30d6\u30eb\u3092\u91cd\u306d\u5408\u308f\u305b\u308b\u3053\u3068\u306f\u51fa\u6765\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_TableHasSameNameError = "\u3059\u3067\u306b\u540c\u540d\u306e\u30ef\u30fc\u30af\u30b7\u30fc\u30c8\u304c\u5b58\u5728\u3057\u307e\u3059\u3002";
                _JPStringResource.Exp_TableDataSourceNullError = "\u30c6\u30fc\u30d6\u30eb\u306e\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u3092 null \u306b\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_TableStyleAddCustomStyleError = "\u3059\u3067\u306b\u540c\u540d\u306e\u30b9\u30bf\u30a4\u30eb\u540d\u304c\u5b58\u5728\u3057\u307e\u3059\u3002";
                _JPStringResource.Exp_TableMoveOutOfRange = "\u30c6\u30fc\u30d6\u30eb\u3092\u30b7\u30fc\u30c8\u5916\u306b\u79fb\u52d5\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_TableResizeOutOfRange = "\u7121\u52b9\u306a\u884c\u6570\u3001\u5217\u6570\u3067\u3059\u3002\u30c6\u30fc\u30d6\u30eb\u3092\u30b7\u30fc\u30c8\u7bc4\u56f2\u5916\u306b\u30ea\u30b5\u30a4\u30ba\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_PasteSourceCellsLocked = "\u53c2\u7167\u5143\u3068\u306a\u3063\u3066\u3044\u308b\u30b7\u30fc\u30c8\u306e\u30bb\u30eb\u306f\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_InvalidCopyPasteSize = "\u30b3\u30d4\u30fc\u3068\u8cbc\u308a\u4ed8\u3051\u306e\u7bc4\u56f2\u30b5\u30a4\u30ba\u304c\u7570\u306a\u3063\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_PasteDestinationCellsLocked = "\u5909\u66f4\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u308b\u30bb\u30eb\u306f\u4fdd\u8b77\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001\u8aad\u307f\u53d6\u308a\u5c02\u7528\u3068\u306a\u3063\u3066\u3044\u307e\u3059\u3002";
                _JPStringResource.Exp_PasteChangeMergeCell = "\u7d50\u5408\u3057\u305f\u30bb\u30eb\u306e\u4e00\u90e8\u306f\u5909\u66f4\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Tip_Row = "\u884c: ";
                _JPStringResource.Tip_Column = "\u5217: ";
                _JPStringResource.Tip_Height = "\u9ad8\u3055: ";
                _JPStringResource.Tip_Width = "\u5e45: ";
                _JPStringResource.Tip_pixels = " \u30d4\u30af\u30bb\u30eb";
                _JPStringResource.NewTab = "New...";
                _JPStringResource.Exp_EmptyNamedStyle = "\u540d\u524d\u4ed8\u304d\u30b9\u30bf\u30a4\u30eb\u306e\u540d\u79f0\u3092\u7a7a\u306b\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_FloatingObjectHasSameNameError = "\u3059\u3067\u306b\u540c\u540d\u306e\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u540d\u304c\u5b58\u5728\u3057\u307e\u3059\u3002";
                _JPStringResource.Exp_FloatingObjectNameEmptyError = "\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u540d\u3092\u7a7a\u306b\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.ToolStrip_PasteText = "\u8cbc\u308a\u4ed8\u3051";
                _JPStringResource.ToolStrip_CutText = "\u5207\u308a\u53d6\u308a";
                _JPStringResource.ToolStrip_CopyText = "\u30b3\u30d4\u30fc";
                _JPStringResource.ToolStrip_AutoFillText = "\u30aa\u30fc\u30c8\u30d5\u30a3\u30eb";
                _JPStringResource.Exp_ArrayFromulaPart = "\u914d\u5217\u306e\u4e00\u90e8\u3092\u5909\u66f4\u3067\u304d\u307e\u305b\u3093\u3002";
                _JPStringResource.Exp_ArrayFromulaSpan = "\u914d\u5217\u6570\u5f0f\u306f\u3001\u7d50\u5408\u3057\u305f\u30bb\u30eb\u3067\u306f\u7121\u52b9\u3067\u3059\u3002";
                _JPStringResource.Exp_ArrayFormulaTable = "\u8907\u6570\u30bb\u30eb\u306e\u914d\u5217\u6570\u5f0f\u306f\u30c6\u30fc\u30d6\u30eb\u3067\u306f\u8a31\u53ef\u3055\u308c\u3066\u3044\u307e\u305b\u3093\u3002";
                _JPStringResource.Fbx_Summary = "\u6982\u8981";
                _JPStringResource.Fbx_TableName_Description = "\u30c6\u30fc\u30d6\u30eb\u540d ";
                _JPStringResource.Fbx_CustomName_Description = "\u30ab\u30b9\u30bf\u30e0\u540d ";
                return _JPStringResource
            })();
        Sheets._JPStringResource = _JPStringResource;
        Sheets.SR = _ENStringResource
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.common", ["core.migrate", "core.stringResource"]);
        var $ = jQuery,
            const_boolean = "boolean",
            const_date = "date",
            const_undefined = "undefined",
            keyword_undefined = undefined,
            keyword_null = null,
            Math_abs = Math.abs,
            Math_floor = Math.floor,
            Math_ceil = Math.ceil,
            Math_min = Math.min,
            Math_max = Math.max;
        var productInfo = (function()
            {
                function productInfo(){}
                productInfo.productVersion = "8.40.20151.0";
                return productInfo
            })();
        Sheets.productInfo = productInfo;
        function getTypeFromString(typeString)
        {
            var found = false;
            var t = window;
            if (typeof typeString === "string")
            {
                var arr = typeString.split(".");
                for (var i = 0, length = arr.length; i < length; i++)
                {
                    if (!t)
                    {
                        break
                    }
                    t = t[arr[i]]
                }
                if (t && i === length && length > 0)
                {
                    found = true
                }
            }
            return found ? t : keyword_undefined
        }
        Sheets.getTypeFromString = getTypeFromString;
        var util = (function()
            {
                function util(){}
                util.createEventHandler = function(element, method)
                {
                    return function()
                        {
                            return method.apply(element, arguments)
                        }
                };
                util.cancelDefault = function(e)
                {
                    if (e.preventDefault)
                    {
                        e.preventDefault();
                        e.stopPropagation()
                    }
                    else
                    {
                        e.cancelBubble = false;
                        e.returnValue = false
                    }
                    return false
                };
                util._isStandardCanvas = function()
                {
                    if (typeof util.canvasApiFound === const_undefined)
                    {
                        util.canvasApiFound = (typeof document.createElement("canvas").getContext !== const_undefined)
                    }
                    return util.canvasApiFound
                };
                util._isSilverlightCanvas = function()
                {
                    if (util._isStandardCanvas())
                    {
                        return true
                    }
                    if (typeof(util.slCanvasApiFound) === const_undefined)
                    {
                        util.slCanvasApiFound = (typeof window.slcanvas !== const_undefined)
                    }
                    return util.slCanvasApiFound
                };
                util._useDoubleBuffer = function()
                {
                    var _self = util;
                    return _self._isStandardCanvas() || _self._isSilverlightCanvas()
                };
                util.getHAlignByValueType = function(hAlign, value, formatter)
                {
                    if (hAlign === 3)
                    {
                        var type = $.type(value);
                        if (formatter && formatter === '@')
                        {
                            hAlign = 0
                        }
                        else if (type === "boolean")
                        {
                            hAlign = 1
                        }
                        else if (type === "number" || type === "date")
                        {
                            hAlign = 2
                        }
                        else
                        {
                            hAlign = 0
                        }
                    }
                    return hAlign
                };
                util.inArray = function(elem, arr, i)
                {
                    if (arr)
                    {
                        if (Array.prototype.indexOf)
                        {
                            return Array.prototype.indexOf.call(arr, elem, i)
                        }
                        var len = arr.length;
                        i = i ? i < 0 ? Math_max(0, len + i) : i : 0;
                        for (; i < len; i++)
                        {
                            if (i in arr && arr[i] === elem)
                            {
                                return i
                            }
                        }
                    }
                    return -1
                };
                util.parseColorString = function(value)
                {
                    var rrggbbPattern = /^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i;
                    var rgbPattern = /^#([0-9a-f])([0-9a-f])([0-9a-f])$/i;
                    var rgbFunctionPattern = /^rgb\(([\s\d]*),([\s\d]*),([\s\d]*)\)$/i;
                    var rgbaFunctionPattern = /^rgba\(([\s\d]*),([\s\d]*),([\s\d]*),([\s\d]*)\)$/i;
                    var normalizeColorString = (function(useCanvas)
                        {
                            var _dummyColorSpan,
                                _canvasContext;
                            return useCanvas ? function(strColor1)
                                {
                                    if (!_canvasContext)
                                    {
                                        var c = window.document.createElement('canvas');
                                        if (c && c.getContext)
                                        {
                                            _canvasContext = c.getContext('2d')
                                        }
                                    }
                                    if (!_canvasContext)
                                    {
                                        return strColor1
                                    }
                                    _canvasContext.fillStyle = strColor1;
                                    strColor1 = _canvasContext.fillStyle;
                                    return strColor1
                                } : function(strColor2)
                                {
                                    if (typeof _dummyColorSpan === const_undefined)
                                    {
                                        _dummyColorSpan = $("<span></span>")
                                    }
                                    _dummyColorSpan.css("color", strColor2);
                                    return _dummyColorSpan.css("color")
                                }
                        }(util._isStandardCanvas()));
                    var hexToColorUnit = function(x)
                        {
                            return parseInt(x, 16)
                        };
                    var hex2ToColorUnit2 = function(x)
                        {
                            return parseInt(x + x, 16)
                        };
                    var decOrPercentToColorUnit = function(x)
                        {
                            return x.indexOf("%") > 0 ? parseFloat(x) * 2.55 : x | 0
                        };
                    var sColor = normalizeColorString(value);
                    var re = RegExp;
                    if (rrggbbPattern.test(sColor))
                    {
                        return ArrayHelper.map([re.$1, re.$2, re.$3], hexToColorUnit)
                    }
                    else if (rgbaFunctionPattern.test(sColor))
                    {
                        var v = ArrayHelper.map([re.$1, re.$2, re.$3], decOrPercentToColorUnit);
                        v.splice(0, 0, parseFloat(re.$4) * 255);
                        return v
                    }
                    else if (rgbFunctionPattern.test(sColor))
                    {
                        return ArrayHelper.map([re.$1, re.$2, re.$3], decOrPercentToColorUnit)
                    }
                    else if (rgbPattern.test(sColor))
                    {
                        return ArrayHelper.map([re.$1, re.$2, re.$3], hex2ToColorUnit2)
                    }
                    return keyword_null
                };
                util.position = function(target, options)
                {
                    if (!options || !options.offset)
                    {
                        return util._position.call(target, options)
                    }
                    var offset = options.offset.split(" "),
                        at = options.at.split(" ");
                    if (offset.length === 1)
                    {
                        offset[1] = offset[0]
                    }
                    if (/^\d/.test(offset[0]))
                    {
                        offset[0] = "+" + offset[0]
                    }
                    if (/^\d/.test(offset[1]))
                    {
                        offset[1] = "+" + offset[1]
                    }
                    if (at.length === 1)
                    {
                        if (/left|center|right/.test(at[0]))
                        {
                            at[1] = "center"
                        }
                        else
                        {
                            at[1] = at[0];
                            at[0] = "center"
                        }
                    }
                    return util._position.call(target, $.extend(options, {
                            at: at[0] + offset[0] + " " + at[1] + offset[1], offset: ""
                        }))
                };
                util.hasCalc = function()
                {
                    return Sheets.features.calc && Sheets.features.calc.common
                };
                util.toString = function(value)
                {
                    if (value === keyword_null || value === keyword_undefined)
                    {
                        value = ""
                    }
                    else if ($.type(value) === const_boolean)
                    {
                        value = value.toString().toUpperCase()
                    }
                    else if ($.type(value) === const_date)
                    {
                        if (value.getHours() === 0 && value.getMinutes() === 0 && value.getSeconds() === 0 && value.getMilliseconds() === 0)
                        {
                            value = new Sheets._DateTimeHelper(value).format("M/d/yyyy")
                        }
                        else
                        {
                            value = new Sheets._DateTimeHelper(value).format("M/d/yyyy h:mm:ss")
                        }
                    }
                    else
                    {
                        value = value.toString()
                    }
                    return value
                };
                util._applyBackgroundImageLayout = function(element, contentWidth, contentHeight, imgWidth, imgHeight, layout)
                {
                    var content = $(element),
                        width = contentWidth,
                        height = contentHeight,
                        cssBackgroundPosition = "background-position",
                        cssBackgroundSize = "background-size";
                    switch (layout)
                    {
                        case 0:
                            content.css(cssBackgroundPosition, "0% 0%").css(cssBackgroundSize, "100% 100%");
                            break;
                        case 1:
                            var posX = "50%",
                                posY = "50%";
                            if (imgWidth > width)
                            {
                                posX = "0%"
                            }
                            if (imgHeight > height)
                            {
                                posY = "0%"
                            }
                            content.css(cssBackgroundPosition, posX + " " + posY).css(cssBackgroundSize, "auto auto");
                            break;
                        case 2:
                            var posX1 = 0,
                                posY1 = 0,
                                sizeW = width,
                                sizeH = height;
                            if (height > 0 && imgHeight > 0 && width / height > imgWidth / imgHeight)
                            {
                                sizeW = imgWidth / imgHeight * height;
                                posX1 = posX1 + width / 2 - sizeW / 2
                            }
                            else if (width > 0 && imgWidth > 0 && height / width > imgHeight / imgWidth)
                            {
                                sizeH = imgHeight / imgWidth * width;
                                posY1 = posY1 + height / 2 - sizeH / 2
                            }
                            content.css(cssBackgroundPosition, posX1 + "px " + posY1 + "px").css(cssBackgroundSize, sizeW + "px " + sizeH + "px");
                            break;
                        case 3:
                            content.css(cssBackgroundPosition, "0% 0%").css(cssBackgroundSize, "auto auto");
                            break;
                        default:
                            break
                    }
                };
                util.device = function()
                {
                    var ua = navigator.userAgent;
                    var result = ua.match(/iPad/i),
                        firstMatch,
                        isIpad,
                        isIphone,
                        isAndroid;
                    if (result)
                    {
                        firstMatch = result[0];
                        if (firstMatch)
                        {
                            isIpad = firstMatch.toLowerCase() === "ipad"
                        }
                    }
                    result = ua.match(/iPhone/i);
                    if (result)
                    {
                        firstMatch = result[0];
                        if (firstMatch)
                        {
                            isIphone = firstMatch.toLowerCase() === "iphone"
                        }
                    }
                    result = ua.match(/android/i);
                    if (result)
                    {
                        firstMatch = result[0];
                        if (firstMatch)
                        {
                            isIphone = firstMatch.toLowerCase() === "android"
                        }
                    }
                    return {
                            ipad: isIpad, iphone: isIphone, android: isAndroid
                        }
                };
                util.initPaint = function(id)
                {
                    var isStandardCanvas = util._isStandardCanvas();
                    if (isStandardCanvas)
                    {
                        return
                    }
                    var host = document.getElementById(id);
                    var self = $(host).data('spread');
                    if (!self)
                    {
                        return
                    }
                    if (self._initPaintTimeout !== keyword_undefined && self._initPaintTimeout !== keyword_null)
                    {
                        window.clearTimeout(self._initPaintTimeout)
                    }
                    var control = self.canvas.firstChild;
                    if (control && control.loaded)
                    {
                        var spreadsheetObject = control.Content.SpreadsheetObject;
                        self.attachSpreadsheetObject(spreadsheetObject)
                    }
                    else
                    {
                        self._initPaintTimeout = window.setTimeout(function()
                        {
                            util.initPaint(id)
                        }, 10)
                    }
                };
                util.isType = function(obj, type)
                {
                    if (obj === keyword_undefined || obj === keyword_null)
                    {
                        return type === "null"
                    }
                    if (!type)
                    {
                        return false
                    }
                    var basetypes = util._basetypes;
                    if (basetypes[typeof obj] === type)
                    {
                        return true
                    }
                    if (type === "function" && /^\s*\bfunction\b/.test("" + obj))
                    {
                        return true
                    }
                    if (Object.prototype.toString.call(obj).slice(8, -1).toLowerCase() === type.toLowerCase())
                    {
                        return true
                    }
                    if (obj && obj._classNames)
                    {
                        for (var index = 0; index < obj._classNames.length; index++)
                        {
                            var classname = obj._classNames[index];
                            if (classname === type)
                            {
                                return true
                            }
                        }
                        return false
                    }
                    else
                    {
                        if (obj === keyword_undefined || obj === keyword_null)
                        {
                            return false
                        }
                        if (type === "DateTime" || type === "TimeSpan")
                        {
                            return obj instanceof Date
                        }
                    }
                    if (typeof type === "string")
                    {
                        if (basetypes[type])
                        {
                            return false
                        }
                    }
                    return obj instanceof type
                };
                util.isCustomType = function(obj, type)
                {
                    if (obj === keyword_undefined || obj === keyword_null)
                    {
                        return type === "null"
                    }
                    if (!type)
                    {
                        return false
                    }
                    if (obj && obj._classNames)
                    {
                        for (var index = 0; index < obj._classNames.length; index++)
                        {
                            var classname = obj._classNames[index];
                            if (classname === type)
                            {
                                return true
                            }
                        }
                        return false
                    }
                    else
                    {
                        if (type === "DateTime" || type === "TimeSpan")
                        {
                            return obj instanceof Date
                        }
                    }
                    if (type === "function" && /^\s*\bfunction\b/.test("" + obj))
                    {
                        return true
                    }
                    if (Object.prototype.toString.call(obj).slice(8, -1).toLowerCase() === type.toLowerCase())
                    {
                        return true
                    }
                    return obj instanceof type
                };
                util.asCustomType = function(obj, typename)
                {
                    if (obj && obj._classNames)
                    {
                        for (var index = 0; index < obj._classNames.length; index++)
                        {
                            var classname = obj._classNames[index];
                            if (classname === typename)
                            {
                                return obj
                            }
                        }
                        return keyword_null
                    }
                    if (util.isType(obj, typename))
                    {
                        return obj
                    }
                    else
                    {
                        return keyword_null
                    }
                };
                util.isStringNumber = function(obj)
                {
                    if (obj === keyword_undefined || obj === keyword_null)
                    {
                        return false
                    }
                    return /^[-,.\d]+$/.test(obj.toString())
                };
                util.parseText2Value = function(style, text, autoFormat, formaterRef)
                {
                    var cellFormatter = keyword_null;
                    if (style)
                    {
                        if (style.formatter)
                        {
                            cellFormatter = style.formatter;
                            if (typeof cellFormatter === 'string')
                            {
                                cellFormatter = new Sheets.GeneralFormatter(cellFormatter)
                            }
                        }
                        else
                        {
                            cellFormatter = style._autoFormatter
                        }
                    }
                    if (cellFormatter && !(cellFormatter instanceof Sheets.AutoFormatter))
                    {
                        var customerValue = keyword_null;
                        try
                        {
                            var textWithoutCulture = text;
                            var isNumber = util.isStringNumber(text);
                            if (isNumber)
                            {
                                textWithoutCulture = Sheets._NumberHelper.replaceCultureSymbolToNormal(text)
                            }
                            customerValue = cellFormatter.Parse(textWithoutCulture);
                            if (typeof customerValue === "number")
                            {
                                return customerValue
                            }
                            else if (isNumber)
                            {
                                return text
                            }
                        }
                        catch(ex) {}
                        return (customerValue === keyword_undefined || customerValue === keyword_null) ? text : customerValue
                    }
                    else if (autoFormat)
                    {
                        var textWithoutCulture = text;
                        var isNumber = util.isStringNumber(text);
                        if (isNumber)
                        {
                            textWithoutCulture = Sheets._NumberHelper.replaceCultureSymbolToNormal(text)
                        }
                        var aValRef = {};
                        var autoDisplayFormatter = keyword_null;
                        try
                        {
                            autoDisplayFormatter = (new Sheets.GeneralFormatter).GetPreferredDisplayFormatter(textWithoutCulture, aValRef)
                        }
                        catch(ex) {}
                        if (typeof aValRef.value === "number")
                        {
                            text = textWithoutCulture
                        }
                        else if (isNumber)
                        {
                            aValRef.value = text
                        }
                        if (formaterRef)
                        {
                            formaterRef.value = autoDisplayFormatter
                        }
                        return (aValRef.hasOwnProperty("value") && aValRef.value !== keyword_undefined && aValRef.value !== keyword_null) ? aValRef.value : text
                    }
                    return text
                };
                util.getPreferredZIndex = function(context)
                {
                    var element = context;
                    while (element && element.parentElement && element.parentElement !== document.body)
                    {
                        element = element.parentElement
                    }
                    var zindex = 1000,
                        index;
                    if (element && element.parentElement === document.body)
                    {
                        index = parseInt($(element).css("z-index"));
                        if (!isNaN(index))
                        {
                            zindex += index
                        }
                    }
                    return zindex
                };
                util.getLinearGradientColors = function(backgroundImg)
                {
                    if (!backgroundImg)
                    {
                        return []
                    }
                    var colorsStart = backgroundImg.indexOf("("),
                        colorsEnd = backgroundImg.lastIndexOf(")");
                    var colorsStr = backgroundImg.substring(colorsStart + 1, colorsEnd);
                    if (!colorsStr)
                    {
                        return []
                    }
                    var colorStrArray = [],
                        searchStartIndex = 0,
                        subStr = "",
                        rgbStartIndex = 0,
                        rgbEndIndex = 0;
                    while (rgbEndIndex < colorsStr.length)
                    {
                        var rgbStartIndex = colorsStr.indexOf("rgb", searchStartIndex),
                            rgbEndIndex = colorsStr.indexOf("rgb", searchStartIndex + 1);
                        if (rgbEndIndex === -1)
                        {
                            rgbEndIndex = colorsStr.length
                        }
                        subStr = colorsStr.substring(rgbStartIndex, rgbEndIndex);
                        colorStrArray.push(subStr);
                        searchStartIndex = rgbStartIndex = rgbEndIndex
                    }
                    var colors = [];
                    for (var i = 0, len = colorStrArray.length; i < len; i++)
                    {
                        var temp = colorStrArray[i];
                        var rightBracketIndex = temp.indexOf(")");
                        var color = temp.substring(0, rightBracketIndex + 1);
                        var point = parseFloat(temp.substring(rightBracketIndex + 1, temp.length));
                        if (isNaN(point))
                        {
                            if (i === len - 1)
                            {
                                point = 100
                            }
                            else if (i <= 1)
                            {
                                point = 0
                            }
                        }
                        if (!color && i === 0)
                        {
                            continue
                        }
                        point = point / 100.0;
                        colors.push({
                            color: color, point: point
                        })
                    }
                    return colors
                };
                util._position = $.fn.position;
                util._basetypes = {
                    undefined: 'undefined', number: 'number', boolean: 'boolean', string: 'string'
                };
                return util
            })();
        Sheets.util = util;
        var FocusHelper = (function()
            {
                function FocusHelper(){}
                FocusHelper.showSelection = function(sheet)
                {
                    FocusHelper._showSelectionImp(sheet)
                };
                FocusHelper.hideSelection = function(sheet)
                {
                    FocusHelper._hideSelectionImp(sheet)
                };
                FocusHelper.isActiveElement = function(sheet)
                {
                    return FocusHelper.getActiveElement() === sheet
                };
                FocusHelper.getActiveElement = function()
                {
                    return window.gcGlobal.activeElement
                };
                FocusHelper.setActiveElement = function(sheet)
                {
                    var oldActiveElement = FocusHelper.getActiveElement();
                    FocusHelper._setActiveElementImp(sheet);
                    if (sheet !== oldActiveElement)
                    {
                        FocusHelper._hideSelectionImp(oldActiveElement);
                        FocusHelper._showSelectionImp(sheet)
                    }
                };
                FocusHelper._setActiveElementImp = function(sheet)
                {
                    window.gcGlobal.activeElement = sheet
                };
                FocusHelper._showSelectionImp = function(sheet)
                {
                    if (!sheet)
                    {
                        return
                    }
                    sheet._render.repaintSelection()
                };
                FocusHelper._hideSelectionImp = function(sheet)
                {
                    if (!sheet)
                    {
                        return
                    }
                    if (!FocusHelper.isActiveElement(sheet) && sheet.parent && sheet.parent.hideSelection())
                    {
                        var layout = sheet._getSheetLayout(),
                            render = sheet._render,
                            ctx = render._getCtx(),
                            selections = sheet.getSelections(),
                            sel,
                            rect;
                        for (var i = 0, length = selections.length; i < length; i++)
                        {
                            sel = selections[i];
                            rect = sheet._getRangeRect2(sel);
                            if (rect.width >= 0 && rect.height >= 0)
                            {
                                rect.x -= 9;
                                rect.y -= 9;
                                rect.width += 18;
                                rect.height += 30;
                                render.copyDoubleBufferRect(rect)
                            }
                        }
                        rect = layout.headerCornerRect();
                        sheet._dirty = true;
                        render.paintBody(ctx, rect);
                        for (var r = 0; r <= 2; r++)
                        {
                            rect = layout.rowHeaderRect(r);
                            if (!rect || rect.width === 0 || rect.height === 0)
                            {
                                continue
                            }
                            sheet._dirty = true;
                            render.paintBody(ctx, rect)
                        }
                        for (var c = 0; c <= 2; c++)
                        {
                            rect = layout.colHeaderRect(c);
                            if (!rect || rect.width === 0 || rect.height === 0)
                            {
                                continue
                            }
                            sheet._dirty = true;
                            render.paintBody(ctx, rect)
                        }
                    }
                };
                return FocusHelper
            })();
        Sheets.FocusHelper = FocusHelper;
        var Global = (function()
            {
                function Global()
                {
                    this._eventSuspended = 0;
                    if (typeof window.gcGlobal == const_undefined)
                    {
                        this._init()
                    }
                }
                Global.prototype._isIELessThan9 = function($, documentMode)
                {
                    return $.browser.msie && (typeof documentMode === const_undefined || documentMode < 9)
                };
                Global.prototype._createDummyObjects = function()
                {
                    var _globalPrototype = Global.prototype;
                    _globalPrototype.getDummyHeader();
                    _globalPrototype.getDummyContent();
                    _globalPrototype.getDummyHover();
                    _globalPrototype.getDummyHighlight()
                };
                Global.prototype.createSpan = function(className)
                {
                    var t = document.createElement("span");
                    t.className = className;
                    t.style.display = "none";
                    document.body.insertBefore(t, keyword_null);
                    return t
                };
                Global.prototype.getDummyHeader = function()
                {
                    var _globalPrototype = Global.prototype;
                    if (!_globalPrototype._dummyHeader)
                    {
                        _globalPrototype._dummyHeader = _globalPrototype.createSpan("ui-widget-header ui-state-default wijmoThemeHelper btn-default")
                    }
                    else if ($(document).find(_globalPrototype._dummyHeader).length <= 0)
                    {
                        document.body.insertBefore(_globalPrototype._dummyHeader, keyword_null)
                    }
                    return _globalPrototype._dummyHeader
                };
                Global.prototype.getDummyContent = function()
                {
                    var _globalPrototype = Global.prototype;
                    if (!_globalPrototype._dummyContent)
                    {
                        _globalPrototype._dummyContent = _globalPrototype.createSpan("ui-widget-content wijmoThemeHelper btn-default")
                    }
                    else if ($(document).find(_globalPrototype._dummyContent).length <= 0)
                    {
                        document.body.insertBefore(_globalPrototype._dummyContent, keyword_null)
                    }
                    return _globalPrototype._dummyContent
                };
                Global.prototype.getDummyHover = function()
                {
                    var _globalPrototype = Global.prototype;
                    if (!_globalPrototype._dummyHover)
                    {
                        _globalPrototype._dummyHover = _globalPrototype.createSpan("ui-state-hover wijmoThemeHelper btn-primary")
                    }
                    else if ($(document).find(_globalPrototype._dummyHover).length <= 0)
                    {
                        document.body.insertBefore(_globalPrototype._dummyHover, keyword_null)
                    }
                    return _globalPrototype._dummyHover
                };
                Global.prototype.getDummyHighlight = function()
                {
                    var _globalPrototype = Global.prototype;
                    if (!_globalPrototype._dummyHighlight)
                    {
                        _globalPrototype._dummyHighlight = _globalPrototype.createSpan("ui-state-highlight wijmoThemeHelper btn-warning")
                    }
                    else if ($(document).find(_globalPrototype._dummyHighlight).length <= 0)
                    {
                        document.body.insertBefore(_globalPrototype._dummyHighlight, keyword_null)
                    }
                    return _globalPrototype._dummyHighlight
                };
                Global.prototype._init = function()
                {
                    window.gcGlobal = this;
                    this._eventSuspended = 0;
                    var _globalPrototype = Global.prototype;
                    if (window.addEventListener)
                    {
                        window.addEventListener('keydown', _globalPrototype.keyDown, true);
                        window.addEventListener('keyup', _globalPrototype.keyUp, true);
                        window.addEventListener('compositionstart', _globalPrototype.compositionStart, true);
                        document.addEventListener('selectstart', _globalPrototype.docSelectStart, true)
                    }
                    $(document).bind("mousedown touchstart MSPointerDown pointerdown", function(e)
                    {
                        var ae = FocusHelper.getActiveElement();
                        if (ae)
                        {
                            var hitElement = _globalPrototype.getUIElement(e.target);
                            var isAfbx = (hitElement && hitElement.getAttribute("gcUIElement") === "gcAttachedFormulaTextBox");
                            if (!hitElement && ae.endEdit && !isAfbx)
                            {
                                var ftbAcrossSheet = IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                                if (ftbAcrossSheet && ftbAcrossSheet.dom)
                                {
                                    var sheetTmp = ftbAcrossSheet.sheet;
                                    ae._formulaTextBox.destroy();
                                    ae._formulaTextBox = keyword_null;
                                    ftbAcrossSheet.clear()
                                }
                                ae.endEdit();
                                var device = util.device();
                                if (device.ipad || device.iphone)
                                {
                                    var eventHanlder = ae._eventHandler;
                                    if (eventHanlder && eventHanlder.setFocusToReadonlyFocusElem)
                                    {
                                        eventHanlder.setFocusToReadonlyFocusElem()
                                    }
                                }
                            }
                            if (!hitElement && ae._disposeValidationUI)
                            {
                                ae._disposeValidationUI()
                            }
                            if (!hitElement)
                            {
                                FocusHelper.setActiveElement(keyword_null)
                            }
                        }
                    });
                    $(document).ready(function()
                    {
                        Global.prototype._createDummyObjects()
                    })
                };
                Global.prototype.keyDown = function(event)
                {
                    var gcGlobal = window.gcGlobal;
                    if (gcGlobal._eventSuspended > 0)
                    {
                        return
                    }
                    var activeElement = FocusHelper.getActiveElement(),
                        validationSelect = activeElement && activeElement._validationSelect;
                    if (validationSelect)
                    {
                        var $select = $(validationSelect);
                        if ($select.is(":visible"))
                        {
                            return
                        }
                    }
                    if (activeElement && activeElement.doKeyDown)
                    {
                        activeElement.doKeyDown(event);
                        if (!activeElement.isEditing())
                        {
                            if ((event.keyCode === 90 || event.keyCode === 89) && event.ctrlKey && !event.altKey)
                            {
                                util.cancelDefault(event)
                            }
                        }
                    }
                };
                Global.prototype.keyUp = function(event)
                {
                    var gcGlobal = window.gcGlobal;
                    if (gcGlobal._eventSuspended > 0)
                    {
                        return
                    }
                    var activeElement = FocusHelper.getActiveElement();
                    if (activeElement && activeElement.doKeyUp)
                    {
                        activeElement.doKeyUp(event)
                    }
                };
                Global.prototype.compositionStart = function(event)
                {
                    var gcGlobal = window.gcGlobal;
                    if (gcGlobal._eventSuspended > 0)
                    {
                        return
                    }
                    var activeElement = FocusHelper.getActiveElement();
                    if (activeElement && activeElement.doCompositionStart)
                    {
                        activeElement.doCompositionStart()
                    }
                };
                Global.prototype.docSelectStart = function(event)
                {
                    if (document.all === keyword_undefined && FocusHelper.getActiveElement())
                    {
                        util.cancelDefault(event)
                    }
                    return false
                };
                Global.prototype.getUIElement = function(e)
                {
                    var w = e;
                    while (w && w.tagName !== "BODY")
                    {
                        if (typeof(w.getAttribute) !== "function")
                        {
                            break
                        }
                        var t = w.getAttribute("gcUIElement");
                        if (!t)
                        {
                            t = w.gcUIElement
                        }
                        if (t)
                        {
                            return w
                        }
                        w = w.parentNode
                    }
                    return keyword_null
                };
                Global.prototype.getExternalThemeStyle = function(visualState, defaultClass)
                {
                    var globalTemplate = Global.prototype;
                    var t = globalTemplate.getDummyHeader();
                    if (visualState === 1 || visualState === 2)
                    {
                        t = globalTemplate.getDummyHighlight()
                    }
                    else if (visualState === 4)
                    {
                        t = globalTemplate.getDummyHover()
                    }
                    var className = t.className;
                    $(t).removeClass(className).addClass(defaultClass);
                    var ts = t.currentStyle;
                    if (document.defaultView && document.defaultView.getComputedStyle)
                    {
                        ts = document.defaultView.getComputedStyle(t, '')
                    }
                    var defaultCss = {
                            backgroundColor: ts.backgroundColor, backgroundImage: ts.backgroundImage
                        };
                    $(t).addClass(className);
                    if (document.defaultView && document.defaultView.getComputedStyle)
                    {
                        ts = document.defaultView.getComputedStyle(t, '')
                    }
                    var resultCss = {
                            backgroundColor: ts.backgroundColor, backgroundImage: ts.backgroundImage, color: ts.color
                        };
                    if (resultCss.backgroundImage === defaultCss.backgroundImage && resultCss.backgroundColor !== defaultCss.backgroundColor)
                    {
                        resultCss.backgroundImage = keyword_undefined
                    }
                    $(t).removeClass(defaultClass);
                    return resultCss
                };
                Global.prototype.suspendEvent = function()
                {
                    var gcGlobal = window.gcGlobal;
                    gcGlobal._eventSuspended++
                };
                Global.prototype.resumeEvent = function()
                {
                    var gcGlobal = window.gcGlobal;
                    gcGlobal._eventSuspended--;
                    if (gcGlobal._eventSuspended < 0)
                    {
                        gcGlobal._eventSuspended = 0
                    }
                };
                return Global
            })();
        Sheets.Global = Global;
        window.gcGlobal = new Global;
        var ArrayHelper = (function()
            {
                function ArrayHelper(){}
                ArrayHelper.insert = function(array, index, item)
                {
                    array.splice(index, 0, item)
                };
                ArrayHelper.add = function(array, item)
                {
                    array[array.length] = item
                };
                ArrayHelper.contains = function(array, item)
                {
                    for (var i = 0; i < array.length; i++)
                    {
                        if (array[i] === item)
                        {
                            return true
                        }
                    }
                    return false
                };
                ArrayHelper.remove = function(array, item)
                {
                    for (var i = 0; i < array.length; i++)
                    {
                        if (array[i] === item)
                        {
                            array.splice(i, 1);
                            return
                        }
                    }
                };
                ArrayHelper.removeByIndex = function(array, index)
                {
                    return array = array.slice(0, index).concat(array.slice(index + 1))
                };
                ArrayHelper.indexOf = function(array, item, start)
                {
                    if (typeof(item) === const_undefined)
                    {
                        return -1
                    }
                    start = start || 0;
                    for (var i = start; i < array.length; i++)
                    {
                        if (array[i] === item)
                        {
                            return i
                        }
                    }
                    return -1
                };
                ArrayHelper.map = function(array, callback, thisArg)
                {
                    if (!Array.prototype.map)
                    {
                        var T,
                            A,
                            k;
                        var O = window.Object(array);
                        var len = O.length >>> 0;
                        if (typeof callback !== "function")
                        {
                            throw new TypeError(callback + Sheets.SR.Exp_NotAFunction);
                        }
                        if (thisArg)
                        {
                            T = thisArg
                        }
                        A = new Array(len);
                        k = 0;
                        while (k < len)
                        {
                            var kValue,
                                mappedValue;
                            if (k in O)
                            {
                                kValue = O[k];
                                mappedValue = callback.call(T, kValue, k, O);
                                A[k] = mappedValue
                            }
                            k++
                        }
                        return A
                    }
                    return array.map(callback, thisArg)
                };
                ArrayHelper.clear = function(array, index, count)
                {
                    if (index < 0)
                    {
                        return
                    }
                    var n = 0;
                    for (var i = 0; n < count && i < array.length; i++)
                    {
                        array[index + i] = keyword_null;
                        n++
                    }
                };
                ArrayHelper.nextNonEmptyIndex = function(array, index)
                {
                    if (index < 0)
                    {
                        index = -1
                    }
                    var n = index + 1;
                    for (var i = n; i < array.length; i++)
                    {
                        if (array[i] !== keyword_undefined && array[i] !== keyword_null)
                        {
                            return i
                        }
                    }
                    return -1
                };
                return ArrayHelper
            })();
        Sheets.ArrayHelper = ArrayHelper;
        (function(Key)
        {
            Key[Key["left"] = 37] = "left";
            Key[Key["right"] = 39] = "right";
            Key[Key["up"] = 38] = "up";
            Key[Key["down"] = 40] = "down";
            Key[Key["tab"] = 9] = "tab";
            Key[Key["enter"] = 13] = "enter";
            Key[Key["shift"] = 16] = "shift";
            Key[Key["ctrl"] = 17] = "ctrl";
            Key[Key["space"] = 32] = "space";
            Key[Key["altkey"] = 18] = "altkey";
            Key[Key["home"] = 36] = "home";
            Key[Key["end"] = 35] = "end";
            Key[Key["pup"] = 33] = "pup";
            Key[Key["pdn"] = 34] = "pdn";
            Key[Key["backspace"] = 8] = "backspace";
            Key[Key["del"] = 46] = "del";
            Key[Key["esc"] = 27] = "esc";
            Key[Key["a"] = 65] = "a";
            Key[Key["c"] = 67] = "c";
            Key[Key["v"] = 86] = "v";
            Key[Key["x"] = 88] = "x";
            Key[Key["z"] = 90] = "z";
            Key[Key["y"] = 89] = "y"
        })(Sheets.Key || (Sheets.Key = {}));
        var Key = Sheets.Key;
        var KeyMap = (function()
            {
                function KeyMap(key, ctrl, shift, alt, meta, action)
                {
                    var self = this;
                    self.key = key;
                    self.ctrl = ctrl;
                    self.shift = shift;
                    self.alt = alt;
                    self.meta = action && meta || false;
                    self.action = action || meta
                }
                return KeyMap
            })();
        Sheets.KeyMap = KeyMap;
        var Point = (function()
            {
                function Point(x, y)
                {
                    this.x = x;
                    this.y = y
                }
                Point.prototype.clone = function()
                {
                    return new Point(this.x, this.y)
                };
                return Point
            })();
        Sheets.Point = Point;
        var Rect = (function()
            {
                function Rect(x, y, w, h)
                {
                    var self = this;
                    self.x = x;
                    self.y = y;
                    self.width = w;
                    self.height = h
                }
                Rect.prototype.intersect = function(x, y, width, height)
                {
                    var self = this;
                    return ((((x < (self.x + self.width)) && (self.x < (x + width))) && (y < (self.y + self.height))) && (self.y < (y + height)))
                };
                Rect.prototype.intersectRect = function(rect)
                {
                    var self = this;
                    return ((((rect.x < (self.x + self.width)) && (self.x < (rect.x + rect.width))) && (rect.y < (self.y + self.height))) && (self.y < (rect.y + rect.height)))
                };
                Rect.prototype.contains = function(x, y)
                {
                    var self = this;
                    return ((((x < (self.x + self.width)) && (self.x < x)) && (y < (self.y + self.height))) && (self.y < y))
                };
                Rect.prototype.containsRect = function(rect)
                {
                    var self = this;
                    return ((self.x < rect.x) && (rect.x + rect.width < self.x + self.width) && (self.y < rect.y) && (rect.y + rect.height < self.y + self.height))
                };
                Rect.prototype.getIntersectRect = function(rect)
                {
                    return this.getIntersect(rect.x, rect.y, rect.width, rect.height)
                };
                Rect.prototype.getIntersect = function(x, y, width, height)
                {
                    var self = this,
                        x1_s = self.x,
                        y1_s = self.y,
                        x1_e = self.x + self.width,
                        y1_e = self.y + self.height,
                        x2_s = x,
                        y2_s = y,
                        x2_e = x + width,
                        y2_e = y + height,
                        intersectX_s = Math_max(x1_s, x2_s),
                        intersectY_s = Math_max(y1_s, y2_s),
                        intersectX_e = Math_min(x1_e, x2_e),
                        intersectY_e = Math_min(y1_e, y2_e),
                        newX = intersectX_s,
                        newY = intersectY_s,
                        newWidth = intersectX_e - intersectX_s,
                        newHeight = intersectY_e - intersectY_s;
                    if (newWidth > 0 && newHeight > 0)
                    {
                        return new Rect(newX, newY, newWidth, newHeight)
                    }
                    return keyword_null
                };
                Rect.prototype.round = function()
                {
                    var self = this;
                    self.x = Math_floor(self.x);
                    self.y = Math_floor(self.y);
                    self.width = Math_ceil(self.width);
                    self.height = Math_ceil(self.height)
                };
                Rect.empty = function()
                {
                    return new Rect(0, 0, 0, 0)
                };
                return Rect
            })();
        Sheets.Rect = Rect;
        var Range = (function()
            {
                function Range(r, c, rc, cc)
                {
                    var self = this;
                    self.row = r;
                    self.rowCount = rc;
                    self.col = c;
                    self.colCount = cc
                }
                Range.prototype.intersect = function(row, col, rowCount, colCount)
                {
                    var self = this;
                    return (row === -1 || self.row === -1 || (self.row < row + rowCount && row < self.row + self.rowCount)) && (col === -1 || self.col === -1 || (self.col < col + colCount && col < self.col + self.colCount))
                };
                Range.prototype.getIntersect = function(range, maxRowCount, maxColumnCount)
                {
                    if (range == keyword_null)
                    {
                        return keyword_null
                    }
                    var self = this;
                    if (!self.intersect(range.row, range.col, range.rowCount, range.colCount))
                    {
                        return keyword_null
                    }
                    var num1 = (self.col == -1) ? maxColumnCount : (self.col + self.colCount - 1);
                    var num2 = (range.col == -1) ? maxColumnCount : (range.col + range.colCount - 1);
                    var num3 = (self.row == -1) ? maxRowCount : (self.row + self.rowCount - 1);
                    var num4 = (range.row == -1) ? maxRowCount : (range.row + range.rowCount - 1);
                    var column = Math_max(self.col, range.col);
                    var num6 = Math_min(num1, num2);
                    var row = Math_max(self.row, range.row);
                    var num8 = Math_min(num3, num4);
                    var rowCount = (row == -1 ? -1 : num8 - row + 1);
                    var columnCount = (column == -1 ? -1 : num6 - column + 1);
                    return new Range(row, column, rowCount, columnCount)
                };
                Range.prototype.contains = function(row, col, rowCount, colCount)
                {
                    var self = this;
                    if (arguments.length === 2)
                    {
                        return (self.row === -1 || (self.row <= row && row < self.row + self.rowCount)) && (self.col === -1 || (self.col <= col && col < self.col + self.colCount))
                    }
                    else if (arguments.length === 4)
                    {
                        return self.containsRange(new Range(row, col, rowCount, colCount))
                    }
                    return false
                };
                Range.prototype.containsRange = function(range)
                {
                    var self = this;
                    return (self.row === -1 || (self.row <= range.row && range.row + range.rowCount <= self.row + self.rowCount)) && (self.col === -1 || (self.col <= range.col && range.col + range.colCount <= self.col + self.colCount))
                };
                Range.prototype.offset = function(x, y)
                {
                    var self = this;
                    var column = self.col;
                    var row = self.row;
                    if (self.col !== -1)
                    {
                        column += x
                    }
                    if (self.row !== -1)
                    {
                        row += y
                    }
                    return new Range(row, column, self.rowCount, self.colCount)
                };
                Range.prototype.union = function(range)
                {
                    var self = this;
                    var ltr = Math_min(self.row, range.row);
                    var ltc = Math_min(self.col, range.col);
                    var rbr = Math_max(self.row + self.rowCount - 1, range.row + range.rowCount - 1);
                    var rbc = Math_max(self.col + self.colCount - 1, range.col + range.colCount - 1);
                    return new Range(ltr, ltc, rbr - ltr + 1, rbc - ltc + 1)
                };
                Range.prototype.equals = function(range)
                {
                    var self = this;
                    if (range instanceof Range)
                    {
                        return (self.row === range.row && self.col === range.col && self.rowCount === range.rowCount && self.colCount === range.colCount)
                    }
                    return false
                };
                return Range
            })();
        Sheets.Range = Range;
        var CellPosition = (function()
            {
                function CellPosition(row, col)
                {
                    this.row = row;
                    this.col = col
                }
                return CellPosition
            })();
        Sheets.CellPosition = CellPosition;
        (function(RangeChangedAction)
        {
            RangeChangedAction[RangeChangedAction["DragDrop"] = 0] = "DragDrop";
            RangeChangedAction[RangeChangedAction["DragFill"] = 1] = "DragFill";
            RangeChangedAction[RangeChangedAction["Clear"] = 2] = "Clear";
            RangeChangedAction[RangeChangedAction["Paste"] = 3] = "Paste";
            RangeChangedAction[RangeChangedAction["Sort"] = 4] = "Sort";
            RangeChangedAction[RangeChangedAction["SetArrayFormula"] = 5] = "SetArrayFormula"
        })(Sheets.RangeChangedAction || (Sheets.RangeChangedAction = {}));
        var RangeChangedAction = Sheets.RangeChangedAction;
        (function(Direction)
        {
            Direction[Direction["up"] = 1] = "up";
            Direction[Direction["down"] = 2] = "down";
            Direction[Direction["left"] = 3] = "left";
            Direction[Direction["right"] = 4] = "right"
        })(Sheets.Direction || (Sheets.Direction = {}));
        var Direction = Sheets.Direction;
        (function(HorizontalAlign)
        {
            HorizontalAlign[HorizontalAlign["left"] = 0] = "left";
            HorizontalAlign[HorizontalAlign["center"] = 1] = "center";
            HorizontalAlign[HorizontalAlign["right"] = 2] = "right";
            HorizontalAlign[HorizontalAlign["general"] = 3] = "general"
        })(Sheets.HorizontalAlign || (Sheets.HorizontalAlign = {}));
        var HorizontalAlign = Sheets.HorizontalAlign;
        (function(VerticalAlign)
        {
            VerticalAlign[VerticalAlign["top"] = 0] = "top";
            VerticalAlign[VerticalAlign["center"] = 1] = "center";
            VerticalAlign[VerticalAlign["bottom"] = 2] = "bottom"
        })(Sheets.VerticalAlign || (Sheets.VerticalAlign = {}));
        var VerticalAlign = Sheets.VerticalAlign;
        (function(HorizontalPosition)
        {
            HorizontalPosition[HorizontalPosition["left"] = 0] = "left";
            HorizontalPosition[HorizontalPosition["center"] = 1] = "center";
            HorizontalPosition[HorizontalPosition["right"] = 2] = "right";
            HorizontalPosition[HorizontalPosition["nearest"] = 3] = "nearest"
        })(Sheets.HorizontalPosition || (Sheets.HorizontalPosition = {}));
        var HorizontalPosition = Sheets.HorizontalPosition;
        (function(VerticalPosition)
        {
            VerticalPosition[VerticalPosition["top"] = 0] = "top";
            VerticalPosition[VerticalPosition["center"] = 1] = "center";
            VerticalPosition[VerticalPosition["bottom"] = 2] = "bottom";
            VerticalPosition[VerticalPosition["nearest"] = 3] = "nearest"
        })(Sheets.VerticalPosition || (Sheets.VerticalPosition = {}));
        var VerticalPosition = Sheets.VerticalPosition;
        (function(HeaderAutoText)
        {
            HeaderAutoText[HeaderAutoText["blank"] = 0] = "blank";
            HeaderAutoText[HeaderAutoText["numbers"] = 1] = "numbers";
            HeaderAutoText[HeaderAutoText["letters"] = 2] = "letters"
        })(Sheets.HeaderAutoText || (Sheets.HeaderAutoText = {}));
        var HeaderAutoText = Sheets.HeaderAutoText;
        (function(ClipboardPasteOptions)
        {
            ClipboardPasteOptions[ClipboardPasteOptions["All"] = 0] = "All";
            ClipboardPasteOptions[ClipboardPasteOptions["Values"] = 1] = "Values";
            ClipboardPasteOptions[ClipboardPasteOptions["Formatting"] = 2] = "Formatting";
            ClipboardPasteOptions[ClipboardPasteOptions["Formulas"] = 3] = "Formulas"
        })(Sheets.ClipboardPasteOptions || (Sheets.ClipboardPasteOptions = {}));
        var ClipboardPasteOptions = Sheets.ClipboardPasteOptions;
        (function(TextFileOpenFlags)
        {
            TextFileOpenFlags[TextFileOpenFlags["None"] = 0] = "None";
            TextFileOpenFlags[TextFileOpenFlags["IncludeRowHeader"] = 1] = "IncludeRowHeader";
            TextFileOpenFlags[TextFileOpenFlags["IncludeColumnHeader"] = 2] = "IncludeColumnHeader";
            TextFileOpenFlags[TextFileOpenFlags["UnFormatted"] = 8] = "UnFormatted";
            TextFileOpenFlags[TextFileOpenFlags["ImportFormula"] = 16] = "ImportFormula"
        })(Sheets.TextFileOpenFlags || (Sheets.TextFileOpenFlags = {}));
        var TextFileOpenFlags = Sheets.TextFileOpenFlags;
        (function(VisualState)
        {
            VisualState[VisualState["Normal"] = 0] = "Normal";
            VisualState[VisualState["Highlight"] = 1] = "Highlight";
            VisualState[VisualState["Selected"] = 2] = "Selected";
            VisualState[VisualState["Active"] = 3] = "Active";
            VisualState[VisualState["Hover"] = 4] = "Hover"
        })(Sheets.VisualState || (Sheets.VisualState = {}));
        var VisualState = Sheets.VisualState;
        (function(ReferenceStyle)
        {
            ReferenceStyle[ReferenceStyle["A1"] = 0] = "A1";
            ReferenceStyle[ReferenceStyle["R1C1"] = 1] = "R1C1"
        })(Sheets.ReferenceStyle || (Sheets.ReferenceStyle = {}));
        var ReferenceStyle = Sheets.ReferenceStyle;
        (function(LineStyle)
        {
            LineStyle[LineStyle["empty"] = 0] = "empty";
            LineStyle[LineStyle["thin"] = 1] = "thin";
            LineStyle[LineStyle["medium"] = 2] = "medium";
            LineStyle[LineStyle["dashed"] = 3] = "dashed";
            LineStyle[LineStyle["dotted"] = 4] = "dotted";
            LineStyle[LineStyle["thick"] = 5] = "thick";
            LineStyle[LineStyle["double"] = 6] = "double";
            LineStyle[LineStyle["hair"] = 7] = "hair";
            LineStyle[LineStyle["mediumDashed"] = 8] = "mediumDashed";
            LineStyle[LineStyle["dashDot"] = 9] = "dashDot";
            LineStyle[LineStyle["mediumDashDot"] = 10] = "mediumDashDot";
            LineStyle[LineStyle["dashDotDot"] = 11] = "dashDotDot";
            LineStyle[LineStyle["mediumDashDotDot"] = 12] = "mediumDashDotDot";
            LineStyle[LineStyle["slantedDashDot"] = 13] = "slantedDashDot"
        })(Sheets.LineStyle || (Sheets.LineStyle = {}));
        var LineStyle = Sheets.LineStyle;
        (function(SheetArea)
        {
            SheetArea[SheetArea["corner"] = 0] = "corner";
            SheetArea[SheetArea["colHeader"] = 1] = "colHeader";
            SheetArea[SheetArea["rowHeader"] = 2] = "rowHeader";
            SheetArea[SheetArea["viewport"] = 3] = "viewport"
        })(Sheets.SheetArea || (Sheets.SheetArea = {}));
        var SheetArea = Sheets.SheetArea;
        (function(CopyToOption)
        {
            CopyToOption[CopyToOption["Value"] = 0x01] = "Value";
            CopyToOption[CopyToOption["Formula"] = 0x02] = "Formula";
            CopyToOption[CopyToOption["Comment"] = 0x04] = "Comment";
            CopyToOption[CopyToOption["RangeGroup"] = 0x08] = "RangeGroup";
            CopyToOption[CopyToOption["Sparkline"] = 0x10] = "Sparkline";
            CopyToOption[CopyToOption["Span"] = 0x20] = "Span";
            CopyToOption[CopyToOption["Style"] = 0x40] = "Style";
            CopyToOption[CopyToOption["Tag"] = 0x80] = "Tag";
            CopyToOption[CopyToOption["BindingPath"] = 0x100] = "BindingPath";
            CopyToOption[CopyToOption["ConditionalFormat"] = 0x200] = "ConditionalFormat";
            CopyToOption[CopyToOption["All"] = 0x3ff] = "All"
        })(Sheets.CopyToOption || (Sheets.CopyToOption = {}));
        var CopyToOption = Sheets.CopyToOption;
        (function(SelectionPolicy)
        {
            SelectionPolicy[SelectionPolicy["Single"] = 0] = "Single";
            SelectionPolicy[SelectionPolicy["Range"] = 1] = "Range";
            SelectionPolicy[SelectionPolicy["MultiRange"] = 2] = "MultiRange"
        })(Sheets.SelectionPolicy || (Sheets.SelectionPolicy = {}));
        var SelectionPolicy = Sheets.SelectionPolicy;
        (function(SelectionUnit)
        {
            SelectionUnit[SelectionUnit["Cell"] = 0] = "Cell";
            SelectionUnit[SelectionUnit["Row"] = 1] = "Row";
            SelectionUnit[SelectionUnit["Column"] = 2] = "Column"
        })(Sheets.SelectionUnit || (Sheets.SelectionUnit = {}));
        var SelectionUnit = Sheets.SelectionUnit;
        (function(AutoFillType)
        {
            AutoFillType[AutoFillType["CopyCells"] = 0] = "CopyCells";
            AutoFillType[AutoFillType["FillSeries"] = 1] = "FillSeries";
            AutoFillType[AutoFillType["FillFormattingOnly"] = 2] = "FillFormattingOnly";
            AutoFillType[AutoFillType["FillWithoutFormatting"] = 3] = "FillWithoutFormatting";
            AutoFillType[AutoFillType["ClearValues"] = 4] = "ClearValues";
            AutoFillType[AutoFillType["Auto"] = 5] = "Auto"
        })(Sheets.AutoFillType || (Sheets.AutoFillType = {}));
        var AutoFillType = Sheets.AutoFillType;
        (function(FillDirection)
        {
            FillDirection[FillDirection["Left"] = 0] = "Left";
            FillDirection[FillDirection["Right"] = 1] = "Right";
            FillDirection[FillDirection["Up"] = 2] = "Up";
            FillDirection[FillDirection["Down"] = 3] = "Down"
        })(Sheets.FillDirection || (Sheets.FillDirection = {}));
        var FillDirection = Sheets.FillDirection;
        (function(FillSeries)
        {
            FillSeries[FillSeries["Column"] = 0] = "Column";
            FillSeries[FillSeries["Row"] = 1] = "Row"
        })(Sheets.FillSeries || (Sheets.FillSeries = {}));
        var FillSeries = Sheets.FillSeries;
        (function(StorageType)
        {
            StorageType[StorageType["Data"] = 0x01] = "Data";
            StorageType[StorageType["Style"] = 0x02] = "Style";
            StorageType[StorageType["Comment"] = 0x04] = "Comment";
            StorageType[StorageType["Tag"] = 0x08] = "Tag";
            StorageType[StorageType["Sparkline"] = 0x10] = "Sparkline";
            StorageType[StorageType["Axis"] = 0x20] = "Axis";
            StorageType[StorageType["BindingPath"] = 0x40] = "BindingPath"
        })(Sheets.StorageType || (Sheets.StorageType = {}));
        var StorageType = Sheets.StorageType;
        (function(DragFillDirection)
        {
            DragFillDirection[DragFillDirection["Left"] = 0] = "Left";
            DragFillDirection[DragFillDirection["Right"] = 1] = "Right";
            DragFillDirection[DragFillDirection["Up"] = 2] = "Up";
            DragFillDirection[DragFillDirection["Down"] = 3] = "Down";
            DragFillDirection[DragFillDirection["LeftClear"] = 4] = "LeftClear";
            DragFillDirection[DragFillDirection["UpClear"] = 5] = "UpClear"
        })(Sheets.DragFillDirection || (Sheets.DragFillDirection = {}));
        var DragFillDirection = Sheets.DragFillDirection;
        (function(EditorStatus)
        {
            EditorStatus[EditorStatus["Ready"] = 0] = "Ready";
            EditorStatus[EditorStatus["Enter"] = 1] = "Enter";
            EditorStatus[EditorStatus["Edit"] = 2] = "Edit"
        })(Sheets.EditorStatus || (Sheets.EditorStatus = {}));
        var EditorStatus = Sheets.EditorStatus;
        (function(CriteriaType)
        {
            CriteriaType[CriteriaType["AnyValue"] = 0] = "AnyValue";
            CriteriaType[CriteriaType["WholeNumber"] = 0x1] = "WholeNumber";
            CriteriaType[CriteriaType["DecimalValues"] = 0x2] = "DecimalValues";
            CriteriaType[CriteriaType["List"] = 0x3] = "List";
            CriteriaType[CriteriaType["Date"] = 0x4] = "Date";
            CriteriaType[CriteriaType["Time"] = 0x5] = "Time";
            CriteriaType[CriteriaType["TextLength"] = 0x6] = "TextLength";
            CriteriaType[CriteriaType["Custom"] = 0x7] = "Custom"
        })(Sheets.CriteriaType || (Sheets.CriteriaType = {}));
        var CriteriaType = Sheets.CriteriaType;
        (function(DataValidationResult)
        {
            DataValidationResult[DataValidationResult["ForceApply"] = 0] = "ForceApply";
            DataValidationResult[DataValidationResult["Discard"] = 1] = "Discard";
            DataValidationResult[DataValidationResult["Retry"] = 2] = "Retry"
        })(Sheets.DataValidationResult || (Sheets.DataValidationResult = {}));
        var DataValidationResult = Sheets.DataValidationResult;
        (function(ErrorStyle)
        {
            ErrorStyle[ErrorStyle["Stop"] = 0] = "Stop";
            ErrorStyle[ErrorStyle["Warning"] = 1] = "Warning";
            ErrorStyle[ErrorStyle["Information"] = 2] = "Information"
        })(Sheets.ErrorStyle || (Sheets.ErrorStyle = {}));
        var ErrorStyle = Sheets.ErrorStyle;
        (function(GeneralCompareType)
        {
            GeneralCompareType[GeneralCompareType["EqualsTo"] = 0] = "EqualsTo";
            GeneralCompareType[GeneralCompareType["NotEqualsTo"] = 1] = "NotEqualsTo";
            GeneralCompareType[GeneralCompareType["GreaterThan"] = 2] = "GreaterThan";
            GeneralCompareType[GeneralCompareType["GreaterThanOrEqualsTo"] = 3] = "GreaterThanOrEqualsTo";
            GeneralCompareType[GeneralCompareType["LessThan"] = 4] = "LessThan";
            GeneralCompareType[GeneralCompareType["LessThanOrEqualsTo"] = 5] = "LessThanOrEqualsTo"
        })(Sheets.GeneralCompareType || (Sheets.GeneralCompareType = {}));
        var GeneralCompareType = Sheets.GeneralCompareType;
        (function(RelationCompareType)
        {
            RelationCompareType[RelationCompareType["Or"] = 0] = "Or";
            RelationCompareType[RelationCompareType["And"] = 1] = "And"
        })(Sheets.RelationCompareType || (Sheets.RelationCompareType = {}));
        var RelationCompareType = Sheets.RelationCompareType;
        (function(ComparisonOperator)
        {
            ComparisonOperator[ComparisonOperator["EqualsTo"] = 0] = "EqualsTo";
            ComparisonOperator[ComparisonOperator["NotEqualsTo"] = 1] = "NotEqualsTo";
            ComparisonOperator[ComparisonOperator["GreaterThan"] = 2] = "GreaterThan";
            ComparisonOperator[ComparisonOperator["GreaterThanOrEqualsTo"] = 3] = "GreaterThanOrEqualsTo";
            ComparisonOperator[ComparisonOperator["LessThan"] = 4] = "LessThan";
            ComparisonOperator[ComparisonOperator["LessThanOrEqualsTo"] = 5] = "LessThanOrEqualsTo";
            ComparisonOperator[ComparisonOperator["Between"] = 6] = "Between";
            ComparisonOperator[ComparisonOperator["NotBetween"] = 7] = "NotBetween"
        })(Sheets.ComparisonOperator || (Sheets.ComparisonOperator = {}));
        var ComparisonOperator = Sheets.ComparisonOperator;
        (function(TextComparisonOperator)
        {
            TextComparisonOperator[TextComparisonOperator["Contains"] = 0] = "Contains";
            TextComparisonOperator[TextComparisonOperator["DoesNotContain"] = 1] = "DoesNotContain";
            TextComparisonOperator[TextComparisonOperator["BeginsWith"] = 2] = "BeginsWith";
            TextComparisonOperator[TextComparisonOperator["EndsWith"] = 3] = "EndsWith"
        })(Sheets.TextComparisonOperator || (Sheets.TextComparisonOperator = {}));
        var TextComparisonOperator = Sheets.TextComparisonOperator;
        (function(TextCompareType)
        {
            TextCompareType[TextCompareType["EqualsTo"] = 0] = "EqualsTo";
            TextCompareType[TextCompareType["NotEqualsTo"] = 1] = "NotEqualsTo";
            TextCompareType[TextCompareType["BeginsWith"] = 2] = "BeginsWith";
            TextCompareType[TextCompareType["DoesNotBeginWith"] = 3] = "DoesNotBeginWith";
            TextCompareType[TextCompareType["EndsWith"] = 4] = "EndsWith";
            TextCompareType[TextCompareType["DoesNotEndWith"] = 5] = "DoesNotEndWith";
            TextCompareType[TextCompareType["Contains"] = 6] = "Contains";
            TextCompareType[TextCompareType["DoesNotContain"] = 7] = "DoesNotContain"
        })(Sheets.TextCompareType || (Sheets.TextCompareType = {}));
        var TextCompareType = Sheets.TextCompareType;
        (function(ColorCompareType)
        {
            ColorCompareType[ColorCompareType["BackgroundColor"] = 0] = "BackgroundColor";
            ColorCompareType[ColorCompareType["ForegroundColor"] = 1] = "ForegroundColor"
        })(Sheets.ColorCompareType || (Sheets.ColorCompareType = {}));
        var ColorCompareType = Sheets.ColorCompareType;
        (function(CustomValueType)
        {
            CustomValueType[CustomValueType["Empty"] = 0] = "Empty";
            CustomValueType[CustomValueType["NonEmpty"] = 1] = "NonEmpty";
            CustomValueType[CustomValueType["Error"] = 2] = "Error";
            CustomValueType[CustomValueType["NonError"] = 3] = "NonError";
            CustomValueType[CustomValueType["Formula"] = 4] = "Formula"
        })(Sheets.CustomValueType || (Sheets.CustomValueType = {}));
        var CustomValueType = Sheets.CustomValueType;
        (function(DateCompareType)
        {
            DateCompareType[DateCompareType["EqualsTo"] = 0] = "EqualsTo";
            DateCompareType[DateCompareType["NotEqualsTo"] = 1] = "NotEqualsTo";
            DateCompareType[DateCompareType["Before"] = 2] = "Before";
            DateCompareType[DateCompareType["BeforeEqualsTo"] = 3] = "BeforeEqualsTo";
            DateCompareType[DateCompareType["After"] = 4] = "After";
            DateCompareType[DateCompareType["AfterEqualsTo"] = 5] = "AfterEqualsTo"
        })(Sheets.DateCompareType || (Sheets.DateCompareType = {}));
        var DateCompareType = Sheets.DateCompareType;
        (function(Top10ConditionType)
        {
            Top10ConditionType[Top10ConditionType["Top"] = 0] = "Top";
            Top10ConditionType[Top10ConditionType["Bottom"] = 1] = "Bottom"
        })(Sheets.Top10ConditionType || (Sheets.Top10ConditionType = {}));
        var Top10ConditionType = Sheets.Top10ConditionType;
        (function(DateOccurringType)
        {
            DateOccurringType[DateOccurringType["Today"] = 0] = "Today";
            DateOccurringType[DateOccurringType["Yesterday"] = 1] = "Yesterday";
            DateOccurringType[DateOccurringType["Tomorrow"] = 2] = "Tomorrow";
            DateOccurringType[DateOccurringType["Last7Days"] = 3] = "Last7Days";
            DateOccurringType[DateOccurringType["ThisMonth"] = 4] = "ThisMonth";
            DateOccurringType[DateOccurringType["LastMonth"] = 5] = "LastMonth";
            DateOccurringType[DateOccurringType["NextMonth"] = 6] = "NextMonth";
            DateOccurringType[DateOccurringType["ThisWeek"] = 7] = "ThisWeek";
            DateOccurringType[DateOccurringType["LastWeek"] = 8] = "LastWeek";
            DateOccurringType[DateOccurringType["NextWeek"] = 9] = "NextWeek"
        })(Sheets.DateOccurringType || (Sheets.DateOccurringType = {}));
        var DateOccurringType = Sheets.DateOccurringType;
        (function(QuarterType)
        {
            QuarterType[QuarterType["Quarter1"] = 0] = "Quarter1";
            QuarterType[QuarterType["Quarter2"] = 1] = "Quarter2";
            QuarterType[QuarterType["Quarter3"] = 2] = "Quarter3";
            QuarterType[QuarterType["Quarter4"] = 3] = "Quarter4"
        })(Sheets.QuarterType || (Sheets.QuarterType = {}));
        var QuarterType = Sheets.QuarterType;
        (function(SortState)
        {
            SortState[SortState["None"] = 0] = "None";
            SortState[SortState["Ascending"] = 1] = "Ascending";
            SortState[SortState["Descending"] = 2] = "Descending"
        })(Sheets.SortState || (Sheets.SortState = {}));
        var SortState = Sheets.SortState;
        (function(AverageConditionType)
        {
            AverageConditionType[AverageConditionType["Above"] = 0] = "Above";
            AverageConditionType[AverageConditionType["Below"] = 1] = "Below";
            AverageConditionType[AverageConditionType["EqualOrAbove"] = 2] = "EqualOrAbove";
            AverageConditionType[AverageConditionType["EqualOrBelow"] = 3] = "EqualOrBelow";
            AverageConditionType[AverageConditionType["Above1StdDev"] = 4] = "Above1StdDev";
            AverageConditionType[AverageConditionType["Below1StdDev"] = 5] = "Below1StdDev";
            AverageConditionType[AverageConditionType["Above2StdDev"] = 6] = "Above2StdDev";
            AverageConditionType[AverageConditionType["Below2StdDev"] = 7] = "Below2StdDev";
            AverageConditionType[AverageConditionType["Above3StdDev"] = 8] = "Above3StdDev";
            AverageConditionType[AverageConditionType["Below3StdDev"] = 9] = "Below3StdDev"
        })(Sheets.AverageConditionType || (Sheets.AverageConditionType = {}));
        var AverageConditionType = Sheets.AverageConditionType;
        (function(ScaleValueType)
        {
            ScaleValueType[ScaleValueType["Number"] = 0] = "Number";
            ScaleValueType[ScaleValueType["LowestValue"] = 1] = "LowestValue";
            ScaleValueType[ScaleValueType["HighestValue"] = 2] = "HighestValue";
            ScaleValueType[ScaleValueType["Percent"] = 3] = "Percent";
            ScaleValueType[ScaleValueType["Percentile"] = 4] = "Percentile";
            ScaleValueType[ScaleValueType["Automin"] = 5] = "Automin";
            ScaleValueType[ScaleValueType["Formula"] = 6] = "Formula";
            ScaleValueType[ScaleValueType["Automax"] = 7] = "Automax"
        })(Sheets.ScaleValueType || (Sheets.ScaleValueType = {}));
        var ScaleValueType = Sheets.ScaleValueType;
        (function(BarDirection)
        {
            BarDirection[BarDirection["LeftToRight"] = 0] = "LeftToRight";
            BarDirection[BarDirection["RightToLeft"] = 1] = "RightToLeft"
        })(Sheets.BarDirection || (Sheets.BarDirection = {}));
        var BarDirection = Sheets.BarDirection;
        (function(DataBarAxisPosition)
        {
            DataBarAxisPosition[DataBarAxisPosition["Automatic"] = 0] = "Automatic";
            DataBarAxisPosition[DataBarAxisPosition["CellMidPoint"] = 1] = "CellMidPoint";
            DataBarAxisPosition[DataBarAxisPosition["None"] = 2] = "None"
        })(Sheets.DataBarAxisPosition || (Sheets.DataBarAxisPosition = {}));
        var DataBarAxisPosition = Sheets.DataBarAxisPosition;
        (function(IconSetType)
        {
            IconSetType[IconSetType["ThreeArrowsColored"] = 0x00] = "ThreeArrowsColored";
            IconSetType[IconSetType["ThreeArrowsGray"] = 0x01] = "ThreeArrowsGray";
            IconSetType[IconSetType["ThreeTriangles"] = 0x02] = "ThreeTriangles";
            IconSetType[IconSetType["ThreeStars"] = 0x03] = "ThreeStars";
            IconSetType[IconSetType["ThreeFlags"] = 0x04] = "ThreeFlags";
            IconSetType[IconSetType["ThreeTrafficLightsUnrimmed"] = 0x05] = "ThreeTrafficLightsUnrimmed";
            IconSetType[IconSetType["ThreeTrafficLightsRimmed"] = 0x06] = "ThreeTrafficLightsRimmed";
            IconSetType[IconSetType["ThreeSigns"] = 0x07] = "ThreeSigns";
            IconSetType[IconSetType["ThreeSymbolsCircled"] = 0x08] = "ThreeSymbolsCircled";
            IconSetType[IconSetType["ThreeSymbolsUncircled"] = 0x09] = "ThreeSymbolsUncircled";
            IconSetType[IconSetType["FourArrowsColored"] = 0x0A] = "FourArrowsColored";
            IconSetType[IconSetType["FourArrowsGray"] = 0x0B] = "FourArrowsGray";
            IconSetType[IconSetType["FourRedToBlack"] = 0x0C] = "FourRedToBlack";
            IconSetType[IconSetType["FourRatings"] = 0x0D] = "FourRatings";
            IconSetType[IconSetType["FourTrafficLights"] = 0x0E] = "FourTrafficLights";
            IconSetType[IconSetType["FiveArrowsColored"] = 0x0F] = "FiveArrowsColored";
            IconSetType[IconSetType["FiveArrowsGray"] = 0x10] = "FiveArrowsGray";
            IconSetType[IconSetType["FiveRatings"] = 0x11] = "FiveRatings";
            IconSetType[IconSetType["FiveQuarters"] = 0x12] = "FiveQuarters";
            IconSetType[IconSetType["FiveBoxes"] = 0x13] = "FiveBoxes"
        })(Sheets.IconSetType || (Sheets.IconSetType = {}));
        var IconSetType = Sheets.IconSetType;
        (function(IconValueType)
        {
            IconValueType[IconValueType["Number"] = 1] = "Number";
            IconValueType[IconValueType["Percent"] = 4] = "Percent";
            IconValueType[IconValueType["Formula"] = 7] = "Formula";
            IconValueType[IconValueType["Percentile"] = 5] = "Percentile"
        })(Sheets.IconValueType || (Sheets.IconValueType = {}));
        var IconValueType = Sheets.IconValueType;
        (function(RangeGroupDirection)
        {
            RangeGroupDirection[RangeGroupDirection["Backward"] = 0] = "Backward";
            RangeGroupDirection[RangeGroupDirection["Forward"] = 1] = "Forward"
        })(Sheets.RangeGroupDirection || (Sheets.RangeGroupDirection = {}));
        var RangeGroupDirection = Sheets.RangeGroupDirection;
        (function(ShowResizeTip)
        {
            ShowResizeTip[ShowResizeTip["None"] = 0] = "None";
            ShowResizeTip[ShowResizeTip["Column"] = 1] = "Column";
            ShowResizeTip[ShowResizeTip["Row"] = 2] = "Row";
            ShowResizeTip[ShowResizeTip["Both"] = 3] = "Both"
        })(Sheets.ShowResizeTip || (Sheets.ShowResizeTip = {}));
        var ShowResizeTip = Sheets.ShowResizeTip;
        (function(ShowScrollTip)
        {
            ShowScrollTip[ShowScrollTip["None"] = 0] = "None";
            ShowScrollTip[ShowScrollTip["Horizontal"] = 1] = "Horizontal";
            ShowScrollTip[ShowScrollTip["Vertical"] = 2] = "Vertical";
            ShowScrollTip[ShowScrollTip["Both"] = 3] = "Both"
        })(Sheets.ShowScrollTip || (Sheets.ShowScrollTip = {}));
        var ShowScrollTip = Sheets.ShowScrollTip;
        (function(AutoFitType)
        {
            AutoFitType[AutoFitType["Cell"] = 0] = "Cell";
            AutoFitType[AutoFitType["CellWithHeader"] = 1] = "CellWithHeader"
        })(Sheets.AutoFitType || (Sheets.AutoFitType = {}));
        var AutoFitType = Sheets.AutoFitType;
        (function(ImageLayout)
        {
            ImageLayout[ImageLayout["Stretch"] = 0] = "Stretch";
            ImageLayout[ImageLayout["Center"] = 1] = "Center";
            ImageLayout[ImageLayout["Zoom"] = 2] = "Zoom";
            ImageLayout[ImageLayout["None"] = 3] = "None"
        })(Sheets.ImageLayout || (Sheets.ImageLayout = {}));
        var ImageLayout = Sheets.ImageLayout;
        (function(InvalidOperationType)
        {
            InvalidOperationType[InvalidOperationType["SetFormula"] = 0] = "SetFormula";
            InvalidOperationType[InvalidOperationType["CopyPaste"] = 1] = "CopyPaste";
            InvalidOperationType[InvalidOperationType["DragFill"] = 2] = "DragFill";
            InvalidOperationType[InvalidOperationType["DragDrop"] = 3] = "DragDrop";
            InvalidOperationType[InvalidOperationType["ChangePartOfArrayFormula"] = 4] = "ChangePartOfArrayFormula"
        })(Sheets.InvalidOperationType || (Sheets.InvalidOperationType = {}));
        var InvalidOperationType = Sheets.InvalidOperationType;
        (function(StringComparison)
        {
            StringComparison[StringComparison["CurrentCulture"] = 0] = "CurrentCulture";
            StringComparison[StringComparison["CurrentCultureIgnoreCase"] = 1] = "CurrentCultureIgnoreCase";
            StringComparison[StringComparison["InvariantCulture"] = 2] = "InvariantCulture";
            StringComparison[StringComparison["InvariantCultureIgnoreCase"] = 3] = "InvariantCultureIgnoreCase";
            StringComparison[StringComparison["Ordinal"] = 4] = "Ordinal";
            StringComparison[StringComparison["OrdinalIgnoreCase"] = 5] = "OrdinalIgnoreCase"
        })(Sheets.StringComparison || (Sheets.StringComparison = {}));
        var StringComparison = Sheets.StringComparison;
        (function(TextDecorationType)
        {
            TextDecorationType[TextDecorationType["Underline"] = 0x01] = "Underline";
            TextDecorationType[TextDecorationType["LineThrough"] = 0x02] = "LineThrough";
            TextDecorationType[TextDecorationType["Overline"] = 0x04] = "Overline";
            TextDecorationType[TextDecorationType["None"] = 0x00] = "None"
        })(Sheets.TextDecorationType || (Sheets.TextDecorationType = {}));
        var TextDecorationType = Sheets.TextDecorationType;
        (function(FilterActionType)
        {
            FilterActionType[FilterActionType["Filter"] = 0] = "Filter";
            FilterActionType[FilterActionType["Unfilter"] = 1] = "Unfilter"
        })(Sheets.FilterActionType || (Sheets.FilterActionType = {}));
        var FilterActionType = Sheets.FilterActionType;
        (function(ImeMode)
        {
            ImeMode[ImeMode["Auto"] = 0x01] = "Auto";
            ImeMode[ImeMode["Active"] = 0x02] = "Active";
            ImeMode[ImeMode["Inactive"] = 0x04] = "Inactive";
            ImeMode[ImeMode["Disabled"] = 0x00] = "Disabled"
        })(Sheets.ImeMode || (Sheets.ImeMode = {}));
        var ImeMode = Sheets.ImeMode;
        (function(CommentState)
        {
            CommentState[CommentState["Active"] = 1] = "Active";
            CommentState[CommentState["Edit"] = 2] = "Edit";
            CommentState[CommentState["Normal"] = 3] = "Normal"
        })(Sheets.CommentState || (Sheets.CommentState = {}));
        var CommentState = Sheets.CommentState;
        var LineBorder = (function()
            {
                function LineBorder(color, style)
                {
                    this.color = color || "black";
                    this.style = style || 0
                }
                LineBorder.prototype.width = function(border)
                {
                    var lineStyle = LineStyle;
                    if (border && border.style)
                    {
                        switch (border.style)
                        {
                            case 9:
                            case 1:
                            case 3:
                            case 4:
                            case 7:
                            case 11:
                                return 1;
                            case 2:
                            case 10:
                            case 12:
                            case 8:
                            case 13:
                                return 2;
                            case 5:
                            case 6:
                                return 3
                        }
                    }
                    return 0
                };
                LineBorder.getLineWeight = function(style)
                {
                    var cache = LineBorder._styleWeightCache;
                    if (!cache)
                    {
                        cache = [];
                        LineBorder._styleWeightCache = cache;
                        var lineStyle = LineStyle;
                        cache[9] = 100;
                        cache[3] = 100;
                        cache[4] = 100;
                        cache[11] = 100;
                        cache[7] = 100;
                        cache[1] = 101;
                        cache[13] = 198;
                        cache[8] = 198;
                        cache[10] = 198;
                        cache[12] = 198;
                        cache[2] = 199;
                        cache[5] = 300;
                        cache[6] = 90;
                        cache[0] = 0
                    }
                    return cache[style]
                };
                LineBorder.prototype.toJSON = function()
                {
                    var jsData = {};
                    if (this.color !== "black")
                    {
                        jsData["color"] = this.color
                    }
                    if (this.style !== 0)
                    {
                        jsData["style"] = this.style
                    }
                    if ($.isEmptyObject(jsData))
                    {
                        return keyword_undefined
                    }
                    return jsData
                };
                LineBorder.prototype.fromJSON = function(jsData, isNoneSchema)
                {
                    if (!jsData)
                    {
                        return
                    }
                    if (jsData.color !== keyword_undefined)
                    {
                        this.color = jsData.color
                    }
                    if (jsData.style !== keyword_undefined)
                    {
                        this.style = jsData.style
                    }
                };
                return LineBorder
            })();
        Sheets.LineBorder = LineBorder;
        var _fontProps = (function()
            {
                var dict = {};
                dict['font-style'] = function(value, domElement)
                {
                    if (value)
                    {
                        $(domElement).css("fontStyle", value)
                    }
                };
                dict['font-variant'] = function(value, domElement)
                {
                    if (value)
                    {
                        $(domElement).css("fontVariant", value)
                    }
                };
                dict['font-weight'] = function(value, domElement)
                {
                    if (value)
                    {
                        $(domElement).css("fontWeight", value)
                    }
                };
                dict['font-size'] = function(value, domElement)
                {
                    if (value)
                    {
                        $(domElement).css("fontSize", value)
                    }
                };
                dict['line-height'] = function(value, domElement)
                {
                    if (value)
                    {
                        $(domElement).css("lineHeight", value)
                    }
                };
                dict['font-family'] = function(value, domElement)
                {
                    if (value)
                    {
                        $(domElement).css("fontFamily", value)
                    }
                };
                return dict
            }());
        function buildFontString(cssStyle)
        {
            if ($.browser.safari)
            {
                return cssStyle.font
            }
            var f = "";
            var normal = "normal";
            var defaultFontWeight = "400";
            if (cssStyle.fontStyle !== normal)
            {
                f = cssStyle.fontStyle
            }
            if (cssStyle.fontVariant !== normal)
            {
                f += (f ? " " : "") + cssStyle.fontVariant
            }
            if (cssStyle.fontWeight !== normal && cssStyle.fontWeight !== defaultFontWeight)
            {
                f += (f ? " " : "") + cssStyle.fontWeight
            }
            f += (f ? " " : "") + cssStyle.fontSize;
            if (cssStyle.lineHeight !== normal)
            {
                f += "/" + cssStyle.lineHeight
            }
            f += " " + cssStyle.fontFamily;
            return f
        }
        function beginBulidFont(sheet)
        {
            var span = document.createElement("span");
            $(span).css("visibility", "hidden").css("top", "-10000px").css("left", "-10000px").css("position", "absolute").attr("className", "gcFontDetectSpanStyle").attr("gcUIElement", "gcFontDetectSpan");
            document.body.insertBefore(span, keyword_null);
            return {
                    span: span, dispose: function()
                        {
                            document.body.removeChild(span);
                            delete this.span
                        }
                }
        }
        var FontFactory = (function()
            {
                function FontFactory(sheet)
                {
                    this._sheet = sheet
                }
                FontFactory.prototype.buildFont = function(opt, font)
                {
                    var f = '';
                    if (opt)
                    {
                        var res = beginBulidFont(this._sheet);
                        try
                        {
                            if (font)
                            {
                                $(res.span).css("font", font)
                            }
                            $.each(_fontProps, function(k, fn)
                            {
                                fn(opt.hasOwnProperty(k) ? opt[k] : keyword_null, res.span)
                            })
                        }
                        finally
                        {
                            var fs = res.span.currentStyle;
                            if (document.defaultView && document.defaultView.getComputedStyle)
                            {
                                fs = document.defaultView.getComputedStyle(res.span, '')
                            }
                            f = buildFontString(fs);
                            res.dispose()
                        }
                    }
                    return f
                };
                return FontFactory
            })();
        Sheets.FontFactory = FontFactory;
        (function(CellTypeKind)
        {
            CellTypeKind[CellTypeKind["BaseCellType"] = 0] = "BaseCellType";
            CellTypeKind[CellTypeKind["TextCellType"] = 1] = "TextCellType";
            CellTypeKind[CellTypeKind["ColumnHeaderCellType"] = 2] = "ColumnHeaderCellType";
            CellTypeKind[CellTypeKind["RowHeaderCellType"] = 3] = "RowHeaderCellType";
            CellTypeKind[CellTypeKind["CornerCellType"] = 4] = "CornerCellType";
            CellTypeKind[CellTypeKind["CheckBoxCellType"] = 5] = "CheckBoxCellType";
            CellTypeKind[CellTypeKind["ButtonCellType"] = 6] = "ButtonCellType";
            CellTypeKind[CellTypeKind["ComboBoxCellType"] = 7] = "ComboBoxCellType";
            CellTypeKind[CellTypeKind["HyperLinkCellType"] = 8] = "HyperLinkCellType"
        })(Sheets.CellTypeKind || (Sheets.CellTypeKind = {}));
        var CellTypeKind = Sheets.CellTypeKind;
        (function(FocusPolicy)
        {
            FocusPolicy[FocusPolicy["Never"] = 0] = "Never";
            FocusPolicy[FocusPolicy["Always"] = 1] = "Always";
            FocusPolicy[FocusPolicy["Auto"] = 2] = "Auto"
        })(Sheets.FocusPolicy || (Sheets.FocusPolicy = {}));
        var FocusPolicy = Sheets.FocusPolicy;
        var Style = (function()
            {
                function Style(backColor, foreColor, hAlign, vAlign, font, themeFont, formatter, borderLeft, borderTop, borderRight, borderBottom, locked, textIndent, wordWrap, shrinkToFit, backgroundImage, cellType, backgroundImageLayout, tabStop, textDecoration, imeMode, name, parentName, watermark)
                {
                    this._id = Style._styleId++;
                    if (arguments.length === 0)
                    {
                        return
                    }
                    var self = this;
                    self.backgroundImage = backgroundImage;
                    self.backgroundImageLayout = backgroundImageLayout;
                    self.backColor = backColor;
                    self.foreColor = foreColor;
                    self.hAlign = hAlign;
                    self.vAlign = vAlign;
                    self.font = font;
                    self.themeFont = themeFont;
                    self.formatter = formatter;
                    self.borderLeft = borderLeft;
                    self.borderTop = borderTop;
                    self.borderRight = borderRight;
                    self.borderBottom = borderBottom;
                    self.locked = locked;
                    self.textIndent = textIndent;
                    self.wordWrap = wordWrap;
                    self.shrinkToFit = shrinkToFit;
                    self.validator = keyword_undefined;
                    self.cellType = cellType;
                    self.tabStop = tabStop;
                    self.textDecoration = textDecoration;
                    self.imeMode = imeMode;
                    self.name = name;
                    self.parentName = parentName;
                    self.watermark = watermark
                }
                Style.prototype._initDefault = function()
                {
                    var self = this;
                    self.backgroundImage = keyword_undefined;
                    self.backgroundImageLayout = keyword_undefined;
                    self.backColor = keyword_undefined;
                    self.foreColor = keyword_undefined;
                    self.hAlign = keyword_undefined;
                    self.vAlign = keyword_undefined;
                    self.font = keyword_undefined;
                    self.themeFont = keyword_undefined;
                    self.formatter = keyword_undefined;
                    self.validator = keyword_undefined;
                    self.borderLeft = keyword_undefined;
                    self.borderTop = keyword_undefined;
                    self.borderRight = keyword_undefined;
                    self.borderBottom = keyword_undefined;
                    self.locked = keyword_undefined;
                    self.textIndent = keyword_undefined;
                    self.wordWrap = keyword_undefined;
                    self.shrinkToFit = keyword_undefined;
                    self.cellType = keyword_undefined;
                    self.name = keyword_undefined;
                    self.parentName = keyword_undefined;
                    self.tabStop = keyword_undefined;
                    self.textDecoration = keyword_undefined;
                    self.imeMode = keyword_undefined;
                    self.watermark = keyword_undefined
                };
                Style.prototype.copyFrom = function(style)
                {
                    this.fromJSON(style);
                    if (style._autoFormatter)
                    {
                        this._autoFormatter = style._autoFormatter
                    }
                };
                Style.prototype._copyFormat = function(format)
                {
                    var formatter = format;
                    if (Sheets.features.formatter)
                    {
                        if (formatter && formatter.constructor === Object)
                        {
                            var typeName = format.typeName;
                            if (!typeName)
                            {
                                formatter = new Sheets.GeneralFormatter(format.formatCached, format.formatModeType, format.customerCultureName)
                            }
                            else
                            {
                                var customFormatterClass = GcSpread.Sheets.getTypeFromString(typeName);
                                if (customFormatterClass)
                                {
                                    formatter = new customFormatterClass;
                                    formatter.fromJSON(format)
                                }
                            }
                        }
                    }
                    return formatter
                };
                Style.prototype._cloneLineBorder = function(border)
                {
                    if (border && (border instanceof LineBorder))
                    {
                        return new LineBorder(border.color, border.style)
                    }
                    return border
                };
                Style.prototype.compose = function(style, force)
                {
                    var self = this,
                        cloneLineBorder = self._cloneLineBorder;
                    if (force)
                    {
                        self._autoFormatter = style._autoFormatter;
                        self.backgroundImage = style.backgroundImage;
                        self.backgroundImageLayout = style.backgroundImageLayout;
                        self.backColor = style.backColor;
                        self.foreColor = style.foreColor;
                        self.hAlign = style.hAlign;
                        self.vAlign = style.vAlign;
                        self.font = style.font;
                        self.themeFont = style.themeFont;
                        self.formatter = style.formatter;
                        var borderLeft = style.borderLeft;
                        self.borderLeft = ((borderLeft && cloneLineBorder(borderLeft)) || borderLeft);
                        var borderTop = style.borderTop;
                        self.borderTop = ((borderTop && cloneLineBorder(borderTop)) || borderTop);
                        var borderRight = style.borderRight;
                        self.borderRight = ((borderRight && cloneLineBorder(borderRight)) || borderRight);
                        var borderBottom = style.borderBottom;
                        self.borderBottom = ((borderBottom && cloneLineBorder(borderBottom)) || borderBottom);
                        self.locked = style.locked;
                        self.textIndent = style.textIndent;
                        self.wordWrap = style.wordWrap;
                        self.shrinkToFit = style.shrinkToFit;
                        self.validator = style.validator;
                        self.cellType = style.cellType;
                        self.name = style.name;
                        self.parentName = style.parentName;
                        self.tabStop = style.tabStop;
                        self.textDecoration = style.textDecoration;
                        self.imeMode = style.imeMode;
                        self.watermark = style.watermark
                    }
                    else
                    {
                        if (self.backgroundImage === keyword_undefined)
                        {
                            self.backgroundImage = style.backgroundImage
                        }
                        if (self.backgroundImageLayout === keyword_undefined)
                        {
                            self.backgroundImageLayout = style.backgroundImageLayout
                        }
                        if (self.backColor === keyword_undefined)
                        {
                            self.backColor = style.backColor
                        }
                        if (self.foreColor === keyword_undefined)
                        {
                            self.foreColor = style.foreColor
                        }
                        if (self.hAlign === keyword_undefined)
                        {
                            self.hAlign = style.hAlign
                        }
                        if (self.vAlign === keyword_undefined)
                        {
                            self.vAlign = style.vAlign
                        }
                        if (self.font === keyword_undefined)
                        {
                            self.font = style.font
                        }
                        if (self.themeFont === keyword_undefined)
                        {
                            self.themeFont = style.themeFont
                        }
                        if (self.formatter === keyword_undefined)
                        {
                            self.formatter = style.formatter
                        }
                        if (self.validator === keyword_undefined)
                        {
                            self.validator = style.validator
                        }
                        if (self._autoFormatter === keyword_undefined)
                        {
                            self._autoFormatter = style._autoFormatter
                        }
                        if (self.borderLeft === keyword_undefined)
                        {
                            var borderLeft = style.borderLeft;
                            self.borderLeft = ((borderLeft && cloneLineBorder(borderLeft)) || borderLeft)
                        }
                        if (self.borderTop === keyword_undefined)
                        {
                            var borderTop = style.borderTop;
                            self.borderTop = ((borderTop && cloneLineBorder(borderTop)) || borderTop)
                        }
                        if (self.borderRight === keyword_undefined)
                        {
                            var borderRight = style.borderRight;
                            self.borderRight = ((borderRight && cloneLineBorder(borderRight)) || borderRight)
                        }
                        if (self.borderBottom === keyword_undefined)
                        {
                            var borderBottom = style.borderBottom;
                            self.borderBottom = ((borderBottom && cloneLineBorder(borderBottom)) || borderBottom)
                        }
                        if (self.locked === keyword_undefined)
                        {
                            self.locked = style.locked
                        }
                        if (self.textIndent === keyword_undefined)
                        {
                            self.textIndent = style.textIndent
                        }
                        if (self.wordWrap === keyword_undefined)
                        {
                            self.wordWrap = style.wordWrap
                        }
                        if (self.shrinkToFit === keyword_undefined)
                        {
                            self.shrinkToFit = style.shrinkToFit
                        }
                        if (self.cellType === keyword_undefined)
                        {
                            self.cellType = style.cellType
                        }
                        if (self.tabStop === keyword_undefined)
                        {
                            self.tabStop = style.tabStop
                        }
                        if (self.textDecoration === keyword_undefined)
                        {
                            self.textDecoration = style.textDecoration
                        }
                        if (self.imeMode === keyword_undefined)
                        {
                            self.imeMode = style.imeMode
                        }
                        if (self.name === keyword_undefined)
                        {
                            self.name = style.name
                        }
                        if (self.parentName === keyword_undefined)
                        {
                            self.parentName = style.parentName
                        }
                        if (self.watermark === keyword_undefined)
                        {
                            self.watermark = style.watermark
                        }
                    }
                };
                Style.prototype.clear = function(propertyName)
                {
                    if (arguments.length === 0)
                    {
                        this._initDefault();
                        return
                    }
                    if (propertyName === "dataValidator")
                    {
                        propertyName = "validator"
                    }
                    this[propertyName] = keyword_undefined
                };
                Style.prototype.clone = function(noDeepClone)
                {
                    var self = this,
                        cloneLineBorder = self._cloneLineBorder;
                    var style = new Style(self.backColor, self.foreColor, self.hAlign, self.vAlign, self.font, self.themeFont, self.formatter, ((self.borderLeft && !noDeepClone && cloneLineBorder(self.borderLeft)) || self.borderLeft), ((self.borderTop && !noDeepClone && cloneLineBorder(self.borderTop)) || self.borderTop), ((self.borderRight && !noDeepClone && cloneLineBorder(self.borderRight)) || self.borderRight), ((self.borderBottom && !noDeepClone && cloneLineBorder(self.borderBottom)) || self.borderBottom), self.locked, self.textIndent, self.wordWrap, self.shrinkToFit, self.backgroundImage, self.cellType, self.backgroundImageLayout, self.tabStop, self.textDecoration, self.imeMode, self.name, self.parentName, self.watermark);
                    style._autoFormatter = self._autoFormatter;
                    if (self.validator && self.validator.clone)
                    {
                        style.validator = self.validator.clone()
                    }
                    return style
                };
                Style.prototype._normalize = function(theme)
                {
                    var self = this;
                    if (theme && theme.getColor)
                    {
                        var colorValue = self.foreColor;
                        if (colorValue)
                        {
                            colorValue = theme.getColor(colorValue);
                            if (colorValue)
                            {
                                self.foreColor = colorValue
                            }
                        }
                        colorValue = self.backColor;
                        if (colorValue)
                        {
                            colorValue = theme.getColor(colorValue);
                            if (colorValue)
                            {
                                self.backColor = colorValue
                            }
                        }
                        var borderLines = [self.borderLeft, self.borderTop, self.borderRight, self.borderBottom];
                        for (var i = 0, count = borderLines.length; i < count; i++)
                        {
                            var borderLine = borderLines[i];
                            if (borderLine && borderLine.color)
                            {
                                colorValue = theme.getColor(borderLine.color);
                                if (colorValue)
                                {
                                    borderLine.color = colorValue
                                }
                            }
                        }
                    }
                    if (self.themeFont && theme && theme.getFont)
                    {
                        self.font = StyleHelper.composeFont(self.font, theme.getFont(self.themeFont))
                    }
                    return self
                };
                Style.prototype._setActualAutoFormatter = function(value)
                {
                    var self = this;
                    if (!self || !self._autoFormatter || !self._autoFormatter._innerFormatter)
                    {
                        return
                    }
                    if (value === keyword_null)
                    {
                        return
                    }
                    var formatter = self._autoFormatter._innerFormatter;
                    var oldFormat = formatter.formatCached;
                    var newFormatObj = formatter.GetPreferredEditingFormatter(value);
                    if (oldFormat !== newFormatObj.formatCached)
                    {
                        self._autoFormatter._innerFormatter = newFormatObj
                    }
                };
                Style.prototype._getCellTypeKinds = function()
                {
                    var dict = {};
                    dict[0] = GcSpread.Sheets["BaseCellType"];
                    dict[1] = GcSpread.Sheets["TextCellType"];
                    dict[2] = GcSpread.Sheets["ColumnHeaderCellType"];
                    dict[3] = GcSpread.Sheets["RowHeaderCellType"];
                    dict[4] = GcSpread.Sheets["CornerCellType"];
                    if (Sheets.features.celltype)
                    {
                        dict[5] = GcSpread.Sheets["CheckBoxCellType"];
                        dict[6] = GcSpread.Sheets["ButtonCellType"];
                        dict[7] = GcSpread.Sheets["ComboBoxCellType"];
                        dict[8] = GcSpread.Sheets["HyperLinkCellType"]
                    }
                    return dict
                };
                Style.prototype.toJSON = function(sheetArea, checkDefaultValue)
                {
                    var self = this;
                    var dicData = {
                            backgroundImage: self.backgroundImage, backgroundImageLayout: self.backgroundImageLayout, backColor: self.backColor, foreColor: self.foreColor, hAlign: self.hAlign, vAlign: self.vAlign, font: self.font, themeFont: self.themeFont, formatter: self.formatter, locked: self.locked, textIndent: self.textIndent, wordWrap: self.wordWrap, shrinkToFit: self.shrinkToFit, validator: self.validator ? self.validator.toJSON() : self.validator, cellType: self.cellType ? self.cellType.toJSON() : self.cellType, name: self.name, parentName: self.parentName, tabStop: self.tabStop, textDecoration: self.textDecoration, imeMode: self.imeMode, borderLeft: self.borderLeft ? self.borderLeft.toJSON() : keyword_undefined, borderRight: self.borderRight ? self.borderRight.toJSON() : keyword_undefined, borderTop: self.borderTop ? self.borderTop.toJSON() : keyword_undefined, borderBottom: self.borderBottom ? self.borderBottom.toJSON() : keyword_undefined, watermark: self.watermark
                        };
                    var jsonData = {};
                    for (var item in dicData)
                    {
                        var value = dicData[item];
                        if (value !== keyword_undefined && (!checkDefaultValue || !self._isDefaultValue(item, value, sheetArea)))
                        {
                            jsonData[item] = value
                        }
                    }
                    if ($.isEmptyObject(jsonData))
                    {
                        return keyword_undefined
                    }
                    return jsonData
                };
                Style.prototype._isDefaultValue = function(propertyName, value, sheetArea)
                {
                    switch (propertyName)
                    {
                        case"hAlign":
                            if (sheetArea === 2)
                            {
                                return value === 1
                            }
                            else if (sheetArea === 1)
                            {
                                return value === 1
                            }
                            else
                            {
                                return value === 3
                            }
                        case"vAlign":
                            if (sheetArea === 2)
                            {
                                return value === 1
                            }
                            else if (sheetArea === 1)
                            {
                                return value === 1
                            }
                            else
                            {
                                return value === 0
                            }
                        case"imeMode":
                            return value === 1
                    }
                };
                Style.prototype.fromJSON = function(jsonData, isNoneSchema)
                {
                    if (!jsonData)
                    {
                        return
                    }
                    var self = this;
                    if (jsonData.backgroundImage !== keyword_undefined)
                    {
                        self.backgroundImage = jsonData.backgroundImage
                    }
                    if (jsonData.backgroundImageLayout !== keyword_undefined)
                    {
                        self.backgroundImageLayout = jsonData.backgroundImageLayout
                    }
                    if (jsonData.backColor !== keyword_undefined)
                    {
                        self.backColor = jsonData.backColor
                    }
                    if (jsonData.foreColor !== keyword_undefined)
                    {
                        self.foreColor = jsonData.foreColor
                    }
                    if (jsonData.hAlign !== keyword_undefined)
                    {
                        self.hAlign = jsonData.hAlign
                    }
                    if (jsonData.vAlign !== keyword_undefined)
                    {
                        self.vAlign = jsonData.vAlign
                    }
                    if (jsonData.font !== keyword_undefined)
                    {
                        self.font = jsonData.font
                    }
                    if (jsonData.themeFont !== keyword_undefined)
                    {
                        self.themeFont = jsonData.themeFont
                    }
                    if (jsonData.formatter !== keyword_undefined)
                    {
                        self.formatter = this._copyFormat(jsonData.formatter)
                    }
                    if (jsonData.locked !== keyword_undefined)
                    {
                        self.locked = jsonData.locked
                    }
                    if (jsonData.textIndent !== keyword_undefined)
                    {
                        self.textIndent = jsonData.textIndent
                    }
                    if (jsonData.wordWrap !== keyword_undefined)
                    {
                        self.wordWrap = jsonData.wordWrap
                    }
                    if (jsonData.shrinkToFit !== keyword_undefined)
                    {
                        self.shrinkToFit = jsonData.shrinkToFit
                    }
                    if (jsonData.validator !== keyword_undefined)
                    {
                        var validator = new GcSpread.Sheets["DefaultDataValidator"];
                        validator.fromJSON(jsonData.validator);
                        self.validator = validator
                    }
                    var jsonDataCellType = jsonData.cellType;
                    if (jsonDataCellType !== keyword_undefined)
                    {
                        var celltype;
                        var dict = self._getCellTypeKinds();
                        var type = jsonDataCellType.type;
                        var typeName = jsonDataCellType.typeName;
                        var celltypeClass = dict[type];
                        if (!celltypeClass)
                        {
                            celltypeClass = dict[typeName]
                        }
                        if (!celltypeClass)
                        {
                            celltypeClass = GcSpread.Sheets.getTypeFromString(typeName)
                        }
                        if (celltypeClass)
                        {
                            celltype = new celltypeClass;
                            celltype.fromJSON(jsonDataCellType, isNoneSchema)
                        }
                        self.cellType = celltype
                    }
                    if (jsonData.name !== keyword_undefined)
                    {
                        self.name = jsonData.name
                    }
                    if (jsonData.parentName !== keyword_undefined)
                    {
                        self.parentName = jsonData.parentName
                    }
                    if (jsonData.tabStop !== keyword_undefined)
                    {
                        self.tabStop = jsonData.tabStop
                    }
                    if (jsonData.textDecoration !== keyword_undefined)
                    {
                        self.textDecoration = jsonData.textDecoration
                    }
                    if (jsonData.imeMode !== keyword_undefined)
                    {
                        self.imeMode = jsonData.imeMode
                    }
                    if (jsonData.borderLeft !== keyword_undefined)
                    {
                        var left = new LineBorder;
                        left.fromJSON(jsonData.borderLeft, isNoneSchema);
                        self.borderLeft = left
                    }
                    if (jsonData.borderRight !== keyword_undefined)
                    {
                        var right = new LineBorder;
                        right.fromJSON(jsonData.borderRight, isNoneSchema);
                        self.borderRight = right
                    }
                    if (jsonData.borderTop !== keyword_undefined)
                    {
                        var top = new LineBorder;
                        top.fromJSON(jsonData.borderTop, isNoneSchema);
                        self.borderTop = top
                    }
                    if (jsonData.borderBottom !== keyword_undefined)
                    {
                        var bottom = new LineBorder;
                        bottom.fromJSON(jsonData.borderBottom, isNoneSchema);
                        self.borderBottom = bottom
                    }
                    if (jsonData.watermark !== keyword_undefined)
                    {
                        self.watermark = jsonData.watermark
                    }
                };
                Style._styleId = 0;
                return Style
            })();
        Sheets.Style = Style;
        var StyleHelper = (function()
            {
                function StyleHelper(){}
                StyleHelper.composeFont = function(font, fontFamily)
                {
                    if (!fontFamily)
                    {
                        return font
                    }
                    return StyleHelper.normalizeFont(font, fontFamily)
                };
                StyleHelper.normalizeFont = function(font, fontFamily)
                {
                    if (!font && !fontFamily)
                        return font;
                    var helper = StyleHelper;
                    if (!helper.measureSpan)
                    {
                        helper._createMeasureSpan()
                    }
                    else
                    {
                        helper._resetMeasureSpan()
                    }
                    var span = helper.measureSpan;
                    var key;
                    var stringCatch;
                    if (font)
                    {
                        key = fontFamily ? font + "+" + fontFamily : font;
                        stringCatch = helper._fontStringCatch[key];
                        if (stringCatch)
                        {
                            return stringCatch
                        }
                        $(span).css("font", font)
                    }
                    else
                    {
                        key = fontFamily;
                        stringCatch = helper._fontStringCatch[key];
                        if (stringCatch)
                        {
                            return stringCatch
                        }
                        $(span).css("fontSize", "10pt")
                    }
                    if (fontFamily)
                    {
                        $(span).css("fontFamily", fontFamily)
                    }
                    var fs = span.currentStyle;
                    if (document.defaultView && document.defaultView.getComputedStyle)
                    {
                        fs = document.defaultView.getComputedStyle(span, '')
                    }
                    stringCatch = buildFontString(fs);
                    helper._fontStringCatch[key] = stringCatch;
                    helper._fontStringCatch[stringCatch] = stringCatch;
                    return stringCatch
                };
                StyleHelper._scaleFont = function(font, factor, minFont, ignoreCache)
                {
                    var helper = StyleHelper,
                        cache = helper.scaleFontInfoCache[factor],
                        fontInfo;
                    if (!ignoreCache)
                    {
                        if (cache)
                        {
                            fontInfo = cache[font];
                            if (fontInfo)
                            {
                                return fontInfo
                            }
                        }
                        else
                        {
                            cache = helper.scaleFontInfoCache[factor] = {}
                        }
                    }
                    if (!helper.measureSpan)
                    {
                        helper._createMeasureSpan()
                    }
                    else
                    {
                        helper._resetMeasureSpan()
                    }
                    var span = helper.measureSpan;
                    span.style.font = font;
                    var style = span.currentStyle,
                        docView = document.defaultView;
                    if (docView && docView.getComputedStyle)
                    {
                        style = docView.getComputedStyle(span, '')
                    }
                    var fontSize = style.fontSize;
                    var type = "px";
                    if (fontSize.indexOf(type) !== -1)
                    {
                        var size = Math_max(1, Math_floor(parseFloat(fontSize.replace(type, "")) * factor));
                        if (minFont && size === 1)
                        {
                            minFont.value = true
                        }
                        fontSize = size + type
                    }
                    var lineHeight = style.lineHeight;
                    if (lineHeight.indexOf(type) !== -1)
                    {
                        var height = Math_max(1, Math_floor(parseFloat(lineHeight.replace(type, "")) * factor));
                        lineHeight = height + type
                    }
                    if (factor === 1)
                    {
                        fontInfo = {
                            font: font, fontSize: size
                        }
                    }
                    else
                    {
                        span.style.fontSize = fontSize;
                        span.style.lineHeight = lineHeight;
                        fontInfo = {
                            font: span.style.font, fontSize: size
                        }
                    }
                    if (!ignoreCache)
                    {
                        cache[font] = fontInfo
                    }
                    return fontInfo
                };
                StyleHelper._createMeasureSpan = function()
                {
                    var span = document.createElement("span"),
                        spanStyle = span.style;
                    spanStyle.visibility = "hidden";
                    spanStyle.top = "-10000px";
                    spanStyle.left = "-10000px";
                    document.body.insertBefore(span, keyword_null);
                    this.measureSpan = span;
                    this.measureSpanOriginalStyle = spanStyle
                };
                StyleHelper._resetMeasureSpan = function()
                {
                    this.measureSpan.style = this.measureSpanOriginalStyle
                };
                StyleHelper._disposeMeasureSpan = function()
                {
                    var span = this.measureSpan;
                    if (span)
                    {
                        $(span).remove();
                        this.measureSpan = keyword_undefined;
                        this.measureSpanOriginalStyle = keyword_undefined
                    }
                };
                StyleHelper._fontStringCatch = {};
                StyleHelper.scaleFontInfoCache = {};
                return StyleHelper
            })();
        Sheets.StyleHelper = StyleHelper;
        var NameInfo = (function()
            {
                function NameInfo(name, expr, row, column)
                {
                    var self = this;
                    self._name = name;
                    self._baseRow = row;
                    self._baseColumn = column;
                    self._expr = expr
                }
                NameInfo.prototype.getName = function()
                {
                    return this._name
                };
                NameInfo.prototype.getRow = function()
                {
                    return this._baseRow
                };
                NameInfo.prototype.getColumn = function()
                {
                    return this._baseColumn
                };
                NameInfo.prototype.getExpression = function()
                {
                    return this._expr
                };
                NameInfo.prototype.setExpression = function(expr)
                {
                    this._expr = expr
                };
                return NameInfo
            })();
        Sheets.NameInfo = NameInfo;
        var _ThemeContext = (function()
            {
                function _ThemeContext(){}
                _ThemeContext.getColor = function(owner, name)
                {
                    if (owner && name)
                    {
                        var currentTheme = owner._currentTheme;
                        if (currentTheme)
                        {
                            return currentTheme.getColor(name)
                        }
                    }
                    return name
                };
                _ThemeContext.getFont = function(owner, name)
                {
                    if (owner && name)
                    {
                        var currentTheme = owner._currentTheme;
                        if (currentTheme)
                        {
                            return currentTheme.getFont(name)
                        }
                        return name
                    }
                    return keyword_null
                };
                return _ThemeContext
            })();
        Sheets._ThemeContext = _ThemeContext;
        var Timer = (function()
            {
                function Timer(host)
                {
                    var self = this;
                    self.host = host;
                    self.interval = keyword_null;
                    self.action = keyword_null;
                    self.intervalId = keyword_null;
                    self.result = keyword_null;
                    self.working = false;
                    self._needIncrease = false
                }
                Timer.prototype.setAction = function(action)
                {
                    if (typeof(action) === "function")
                    {
                        this.action = action
                    }
                };
                Timer.prototype.setInterval = function(interval)
                {
                    var self = this;
                    if (!isNaN(interval) && interval !== 0)
                    {
                        if (interval > 0)
                        {
                            self._needIncrease = true
                        }
                        else
                        {
                            self._needIncrease = false
                        }
                        interval = Math_abs(interval);
                        var oldInterval = self.interval;
                        self.interval = interval;
                        if (oldInterval !== interval)
                        {
                            self.start()
                        }
                    }
                    else
                    {
                        self.stop()
                    }
                };
                Timer.prototype.start = function()
                {
                    var self = this;
                    self.clear();
                    if (!isNaN(self.interval))
                    {
                        self.intervalId = setInterval(function()
                        {
                            self.run()
                        }, self.interval)
                    }
                };
                Timer.prototype.run = function()
                {
                    var self = this;
                    self.working = true;
                    if (typeof(self.action) === "function")
                    {
                        self.result = self.action.call(self.host, self._needIncrease)
                    }
                };
                Timer.prototype.stop = function()
                {
                    var self = this;
                    self.clear();
                    self.interval = keyword_null;
                    self.intervalId = keyword_null;
                    self.result = keyword_null;
                    self.working = false
                };
                Timer.prototype.clear = function()
                {
                    if (this.intervalId)
                    {
                        clearInterval(this.intervalId)
                    }
                };
                Timer.prototype._dispose = function()
                {
                    this.stop()
                };
                return Timer
            })();
        Sheets.Timer = Timer;
        var Events = (function()
            {
                function Events(){}
                Events.ValidationError = "ValidationError";
                Events.CellClick = "CellClick";
                Events.CellDoubleClick = "CellDoubleClick";
                Events.EnterCell = "EnterCell";
                Events.LeaveCell = "LeaveCell";
                Events.ValueChanged = "ValueChanged";
                Events.TopRowChanged = "TopRowChanged";
                Events.LeftColumnChanged = "LeftColumnChanged";
                Events.InvalidOperation = "InvalidOperation";
                Events.RangeFiltering = "RangeFiltering";
                Events.RangeFiltered = "RangeFiltered";
                Events.TableFiltering = "TableFiltering";
                Events.TableFiltered = "TableFiltered";
                Events.RangeSorting = "RangeSorting";
                Events.RangeSorted = "RangeSorted";
                Events.ClipboardChanging = "ClipboardChanging";
                Events.ClipboardChanged = "ClipboardChanged";
                Events.ClipboardPasting = "ClipboardPasting";
                Events.ClipboardPasted = "ClipboardPasted";
                Events.ColumnWidthChanging = "ColumnWidthChanging";
                Events.ColumnWidthChanged = "ColumnWidthChanged";
                Events.RowHeightChanging = "RowHeightChanging";
                Events.RowHeightChanged = "RowHeightChanged";
                Events.DragDropBlock = "DragDropBlock";
                Events.DragDropBlockCompleted = "DragDropBlockCompleted";
                Events.DragFillBlock = "DragFillBlock";
                Events.DragFillBlockCompleted = "DragFillBlockCompleted";
                Events.EditStarting = "EditStarting";
                Events.EditStarted = "EditStarted";
                Events.EditChange = "EditChange";
                Events.EditEnding = "EditEnding";
                Events.EditEnd = "EditEnd";
                Events.EditEnded = "EditEnded";
                Events.RangeGroupStateChanging = "RangeGroupStateChanging";
                Events.RangeGroupStateChanged = "RangeGroupStateChanged";
                Events.SelectionChanging = "SelectionChanging";
                Events.SelectionChanged = "SelectionChanged";
                Events.SheetTabClick = "SheetTabClick";
                Events.SheetTabDoubleClick = "SheetTabDoubleClick";
                Events.SheetNameChanging = "SheetNameChanging";
                Events.SheetNameChanged = "SheetNameChanged";
                Events.UserZooming = "UserZooming";
                Events.UserFormulaEntered = "UserFormulaEntered";
                Events.CellChanged = "CellChanged";
                Events.ColumnChanged = "ColumnChanged";
                Events.RowChanged = "RowChanged";
                Events.ActiveSheetChanging = "ActiveSheetChanging";
                Events.ActiveSheetChanged = "ActiveSheetChanged";
                Events.SparklineChanged = "SparklineChanged";
                Events.RangeChanged = "RangeChanged";
                Events.ButtonClicked = "ButtonClicked";
                Events.EditorStatusChanged = "EditorStatusChanged";
                Events.CultureChanged = "SpreadJSCultureChanged";
                Events.FloatingObjectChanged = "FloatingObjectChanged";
                Events.FloatingObjectSelectionChanged = "FloatingObjectSelectionChanged";
                Events.PictureChanged = "PictureChanged";
                Events.PictureSelectionChanged = "PictureSelectionChanged";
                Events.CustomFloatingObjectLoaded = "CustomFloatingObjectLoaded";
                Events.TouchToolStripOpening = "TouchToolStripOpening";
                Events.CommentChanged = "CommentChanged";
                return Events
            })();
        Sheets.Events = Events;
        var _XArray = (function()
            {
                function _XArray()
                {
                    Array.apply(this, arguments);
                    return []
                }
                _XArray.prototype.pop = function()
                {
                    return keyword_null
                };
                _XArray.prototype.push = function(val)
                {
                    return 0
                };
                _XArray.prototype.splice = function(start, deleteCount)
                {
                    var items = [];
                    for (var _i = 0; _i < (arguments.length - 2); _i++)
                    {
                        items[_i] = arguments[_i + 2]
                    }
                    return keyword_null
                };
                _XArray.prototype.slice = function(start, end)
                {
                    return null
                };
                return _XArray
            })();
        Sheets._XArray = _XArray;
        _XArray["prototype"] = [];
        var _CachePool = (function()
            {
                function _CachePool(sheet)
                {
                    this._sheet = sheet
                }
                _CachePool.prototype.getCellOverflowBuilder = function(rowViewportIndex, colViewportIndex, createBuilder)
                {
                    var caches = this._cellOverflowBuilderCache,
                        index = rowViewportIndex << 4 + colViewportIndex;
                    if (!caches)
                    {
                        return createBuilder()
                    }
                    var cache = caches[index];
                    if (!cache)
                    {
                        cache = createBuilder();
                        caches[index] = cache
                    }
                    return cache
                };
                _CachePool.prototype.getConditionalFormat = function(row, col)
                {
                    var caches = this._conditionalFormatCache;
                    if (!caches)
                    {
                        return null
                    }
                    var rowCaches = caches[row];
                    if (rowCaches)
                    {
                        return rowCaches[col]
                    }
                    return null
                };
                _CachePool.prototype.setConditionalFormat = function(row, col, dataBar, iconSet)
                {
                    var caches = this._conditionalFormatCache;
                    if (!caches)
                    {
                        return
                    }
                    var rowCaches = caches[row];
                    if (!rowCaches)
                    {
                        rowCaches = {};
                        caches[row] = rowCaches
                    }
                    rowCaches[col] = {
                        d: dataBar, i: iconSet
                    }
                };
                _CachePool.prototype.getValue = function(row, col, sheetArea)
                {
                    var cache = this._valueCache;
                    if (!cache)
                    {
                        return this._sheet.getValue(row, col, sheetArea)
                    }
                    if (sheetArea === undefined)
                    {
                        sheetArea = 3
                    }
                    var sCache = cache[sheetArea],
                        rowCache,
                        cellCache;
                    if (!sCache)
                    {
                        sCache = {};
                        cache[sheetArea] = sCache
                    }
                    rowCache = sCache[row];
                    if (!rowCache)
                    {
                        rowCache = {};
                        sCache[row] = rowCache
                    }
                    cellCache = rowCache[col];
                    if (cellCache === undefined)
                    {
                        cellCache = this._sheet.getValue(row, col, sheetArea);
                        rowCache[col] = cellCache
                    }
                    return cellCache
                };
                _CachePool.prototype.getActualStyle = function(row, col, sheetArea)
                {
                    var cache = this._styleCache;
                    if (!cache)
                    {
                        return this._sheet.getActualStyle(row, col, sheetArea, false, false)
                    }
                    if (sheetArea === undefined)
                    {
                        sheetArea = 3
                    }
                    var sCache = cache[sheetArea],
                        rowCache,
                        cellCache;
                    if (!sCache)
                    {
                        sCache = {};
                        cache[sheetArea] = sCache
                    }
                    rowCache = sCache[row];
                    if (!rowCache)
                    {
                        rowCache = {};
                        sCache[row] = rowCache
                    }
                    cellCache = rowCache[col];
                    if (!cellCache)
                    {
                        cellCache = this._sheet.getActualStyle(row, col, sheetArea, false, true);
                        rowCache[col] = cellCache
                    }
                    return cellCache.clone(true)
                };
                _CachePool.prototype.getZoomRowHeight = function(row)
                {
                    var cache = this._rowHeightCache;
                    if (!cache)
                    {
                        return this._sheet._getZoomRowHeight(row)
                    }
                    var c = cache[row];
                    if (c === undefined)
                    {
                        c = cache[row] = this._sheet._getZoomRowHeight(row)
                    }
                    return c
                };
                _CachePool.prototype.getZoomColWidth = function(col)
                {
                    var cache = this._colWidthCache;
                    if (!cache)
                    {
                        return this._sheet._getZoomColumnWidth(col)
                    }
                    var c = cache[col];
                    if (c === undefined)
                    {
                        c = cache[col] = this._sheet._getZoomColumnWidth(col)
                    }
                    return c
                };
                _CachePool.prototype.getRowGroups = function(createFunction)
                {
                    var self = this;
                    if (!self._valueCache)
                    {
                        return createFunction()
                    }
                    if (!self._rowGroups)
                    {
                        self._rowGroups = createFunction()
                    }
                    return self._rowGroups
                };
                _CachePool.prototype.getColGroups = function(createFunction)
                {
                    var self = this;
                    if (!self._valueCache)
                    {
                        return createFunction()
                    }
                    if (!self._colGroups)
                    {
                        self._colGroups = createFunction()
                    }
                    return self._colGroups
                };
                _CachePool.prototype.startCacheBeforPan = function()
                {
                    var self = this;
                    self._isCaching = true;
                    self._cellOverflowBuilderCache = {};
                    self._conditionalFormatCache = {};
                    self._valueCache = {};
                    self._styleCache = {};
                    self._rowHeightCache = {};
                    self._colWidthCache = {}
                };
                _CachePool.prototype.endCache = function()
                {
                    this._isCaching = false
                };
                _CachePool.prototype.clearCacheEndPan = function()
                {
                    var self = this;
                    self._isCaching = false;
                    self._cellOverflowBuilderCache = null;
                    self._conditionalFormatCache = null;
                    self._valueCache = null;
                    self._styleCache = null;
                    self._colWidthCache = null;
                    self._rowHeightCache = null;
                    self._rowGroups = null;
                    self._colGroups = null
                };
                _CachePool.prototype.isCaching = function()
                {
                    return this._isCaching
                };
                return _CachePool
            })();
        Sheets._CachePool = _CachePool;
        var _CacheMgr = (function()
            {
                function _CacheMgr(){}
                _CacheMgr.startCache = function(sheet, startRow, startColumn, endRow, endColumn)
                {
                    var mgr = _CacheMgr;
                    mgr._cached = true;
                    var rowCount = sheet.getRowCount();
                    if (sheet._hasTable(startRow, startColumn, endRow - startRow + 1, endColumn - startColumn + 1))
                    {
                        var vIndex = -1;
                        var vIndexCache = mgr._visibleRowIndexCache = [];
                        for (var r = 0; r <= endRow; r++)
                        {
                            if (sheet.getRowVisible(r))
                            {
                                vIndex++;
                                vIndexCache[r] = vIndex
                            }
                            else
                            {
                                vIndexCache[r] = -1
                            }
                        }
                    }
                };
                _CacheMgr.clearCache = function()
                {
                    _CacheMgr._visibleRowIndexCache = null;
                    _CacheMgr._cached = false
                };
                _CacheMgr.getFormatter = function(format)
                {
                    var mgr = _CacheMgr;
                    var formatter = mgr._formatterCache[format];
                    if (!formatter)
                    {
                        formatter = new Sheets.GeneralFormatter(format);
                        mgr._formatterCache[format] = formatter
                    }
                    return formatter
                };
                _CacheMgr.getFormattedText = function(value, format, conditionalForeColor)
                {
                    var mgr = _CacheMgr;
                    var mgrCache = mgr._formattedTextCache;
                    if (Sheets.features.formatter)
                    {
                        var formatCache = mgrCache[format];
                        if (!formatCache)
                        {
                            formatCache = {};
                            mgrCache[format] = formatCache
                        }
                        var formattedTextCache = formatCache[value];
                        if (formattedTextCache)
                        {
                            if (conditionalForeColor)
                            {
                                conditionalForeColor.value = formattedTextCache.color
                            }
                            return formattedTextCache.text
                        }
                        var formatter = keyword_null;
                        formatter = mgr._formatterCache[format];
                        if (!formatter)
                        {
                            formatter = new Sheets.GeneralFormatter(format);
                            mgr._formatterCache[format] = formatter
                        }
                        var isNumber = typeof value === "number",
                            colorResult = {};
                        var result = formatter.Format(value, colorResult);
                        if (isNumber)
                        {
                            result = Sheets._NumberHelper.replaceNormalToCultureSymble(result)
                        }
                        var formatResult = formatCache[value] = {};
                        formatResult.text = result;
                        formatResult.color = colorResult.value;
                        if (conditionalForeColor)
                        {
                            conditionalForeColor.value = colorResult.value
                        }
                        return result
                    }
                    else
                    {
                        return value.toString()
                    }
                };
                _CacheMgr.getFormattedTextByStyle = function(sheet, style, value, conditionalForeColor)
                {
                    var ct = style.cellType || sheet.getDefaultCellType();
                    var format = (style.formatter || style._autoFormatter);
                    return ct.format(value, format, conditionalForeColor, keyword_null)
                };
                _CacheMgr.clearFormatCache = function()
                {
                    _CacheMgr._formatterCache = {};
                    _CacheMgr._formattedTextCache = {}
                };
                _CacheMgr._cached = false;
                _CacheMgr._formatterCache = {};
                _CacheMgr._formattedTextCache = {};
                return _CacheMgr
            })();
        Sheets._CacheMgr = _CacheMgr;
        var _DataValidatorCache = (function()
            {
                function _DataValidatorCache(){}
                _DataValidatorCache.setStyle = function(style, sheet, row, col)
                {
                    if (style)
                    {
                        var self = _DataValidatorCache;
                        self.removeDataValidator(sheet, row, col);
                        var condition = style.validator && style.validator.condition;
                        if (condition && condition.getFormulas && condition.getFormulas().length > 0)
                        {
                            self.addDataValidator(style.validator, sheet, row, col)
                        }
                    }
                };
                _DataValidatorCache.addDataValidator = function(validator, sheet, row, col)
                {
                    var sheetId = sheet._id;
                    var cache = _DataValidatorCache._cache;
                    var cacheValue = cache[validator.id];
                    if (!cacheValue)
                    {
                        cacheValue = cache[validator.id] = {
                            validator: validator, sheet: sheet
                        }
                    }
                    var sheetCache = cacheValue[sheetId];
                    if (!sheetCache)
                    {
                        sheetCache = cacheValue[sheetId] = {}
                    }
                    var key = row + "_" + col;
                    if (!sheetCache[key])
                    {
                        sheetCache[key] = true
                    }
                };
                _DataValidatorCache.removeDataValidator = function(sheet, row, col)
                {
                    var sheetId = sheet._id;
                    var cache = _DataValidatorCache._cache;
                    for (var id in cache)
                    {
                        var validatorCache = cache[id];
                        if (validatorCache)
                        {
                            var sheetCache = validatorCache[sheetId];
                            if (!sheetCache)
                            {
                                sheetCache = validatorCache[sheetId] = {}
                            }
                            var key = row + "_" + col;
                            if (sheetCache[key])
                            {
                                delete sheetCache[key];
                                for (var tmp in sheetCache)
                                {
                                    return
                                }
                                delete validatorCache[sheetId];
                                for (tmp in validatorCache)
                                {
                                    return
                                }
                                delete cache[id];
                                return
                            }
                        }
                    }
                };
                _DataValidatorCache.removeSheet = function(sheetId)
                {
                    var cache = _DataValidatorCache._cache;
                    for (var id in cache)
                    {
                        var validatorCache = cache[id];
                        if (validatorCache[sheetId])
                        {
                            delete validatorCache[sheetId];
                            for (var tmp in validatorCache)
                            {
                                return
                            }
                            delete cache[id]
                        }
                    }
                };
                _DataValidatorCache.getAllValidators = function()
                {
                    var result = [];
                    var cache = _DataValidatorCache._cache;
                    for (var id in cache)
                    {
                        result.push(cache[id])
                    }
                    return result
                };
                _DataValidatorCache._cache = {};
                return _DataValidatorCache
            })();
        Sheets._DataValidatorCache = _DataValidatorCache;
        var _ModelHelper = (function()
            {
                function _ModelHelper(){}
                _ModelHelper.addElements = function(a, aCount, index, count)
                {
                    if (a && 0 <= index && index < aCount)
                    {
                        var rows = [],
                            rowCount,
                            i;
                        for (i = index; i < aCount; i++)
                        {
                            if (typeof(a[i]) !== 'undefined')
                            {
                                rows.push(i)
                            }
                        }
                        rowCount = rows.length;
                        for (i = 0; i < rowCount; i++)
                        {
                            var k = rows[rowCount - i - 1];
                            var value = a[k];
                            a[k] = null;
                            a[Math.floor(k) + count] = value
                        }
                    }
                };
                _ModelHelper.deleteElements = function(a, aCount, index, count)
                {
                    if (a && 0 <= index && index < aCount)
                    {
                        var rows = [],
                            rowCount,
                            index2 = index + count,
                            i;
                        for (i = index; i < aCount; i++)
                        {
                            if (typeof(a[i]) !== 'undefined')
                            {
                                if (index <= i && i < index2)
                                {
                                    a[i] = null
                                }
                                else if (i >= index2)
                                {
                                    rows.push(i)
                                }
                            }
                        }
                        rowCount = rows.length;
                        for (i = 0; i < rowCount; i++)
                        {
                            var k = rows[i];
                            var value = a[k];
                            a[k] = null;
                            a[Math.floor(k) - count] = value
                        }
                    }
                };
                return _ModelHelper
            })();
        Sheets._ModelHelper = _ModelHelper;
        (function(_DataSourceType)
        {
            _DataSourceType[_DataSourceType["None"] = 0] = "None";
            _DataSourceType[_DataSourceType["Normal"] = 1] = "Normal";
            _DataSourceType[_DataSourceType["Knockout"] = 2] = "Knockout";
            _DataSourceType[_DataSourceType["DataView"] = 3] = "DataView";
            _DataSourceType[_DataSourceType["CellBinding"] = 4] = "CellBinding"
        })(Sheets._DataSourceType || (Sheets._DataSourceType = {}));
        var _DataSourceType = Sheets._DataSourceType;
        (function(EndEditType)
        {
            EndEditType[EndEditType["normal"] = 0] = "normal";
            EndEditType[EndEditType["arrayFormula"] = 1] = "arrayFormula";
            EndEditType[EndEditType["sharedFormula"] = 2] = "sharedFormula"
        })(Sheets.EndEditType || (Sheets.EndEditType = {}));
        var EndEditType = Sheets.EndEditType;
        var FormulaInformation = (function()
            {
                function FormulaInformation(){}
                return FormulaInformation
            })();
        Sheets.FormulaInformation = FormulaInformation;
        var RegUtil = (function()
            {
                function RegUtil(){}
                RegUtil.getReg = function(regStr)
                {
                    var reg = RegUtil.regDict[regStr];
                    if (!reg)
                    {
                        reg = RegUtil.regDict[regStr] = new RegExp(regStr, 'g')
                    }
                    reg.lastIndex = 0;
                    return reg
                };
                RegUtil.getRegIgnoreCase = function(regStr)
                {
                    var reg = RegUtil.regDictIgnoreCase[regStr];
                    if (!reg)
                    {
                        reg = RegUtil.regDictIgnoreCase[regStr] = new RegExp(regStr, 'gi')
                    }
                    reg.lastIndex = 0;
                    return reg
                };
                RegUtil.getWildcardCriteria = function(criteria)
                {
                    if (RegUtil.wildcardParseRecord[criteria])
                    {
                        return RegUtil.wildcardParseResultBuffer[criteria]
                    }
                    if (RegUtil.getReg("[~?*]+").test(criteria))
                    {
                        var criteriaTemp = criteria;
                        var asteriskSymbol = RegUtil.getReplaceSymbol("asterisk", criteriaTemp);
                        var questionSymbol = RegUtil.getReplaceSymbol("question", criteriaTemp);
                        var tildeSymbol = RegUtil.getReplaceSymbol("tilde", criteriaTemp);
                        criteriaTemp = StringUtil.replace(criteriaTemp, "~~", tildeSymbol);
                        criteriaTemp = StringUtil.replace(criteriaTemp, "~*", asteriskSymbol);
                        criteriaTemp = StringUtil.replace(criteriaTemp, "~?", questionSymbol);
                        criteriaTemp = criteriaTemp.replace(RegUtil.getReg("([.+$^\\[\\](){}|\/])"), "\\$1");
                        criteriaTemp = StringUtil.replace(criteriaTemp, "*", ".*");
                        criteriaTemp = StringUtil.replace(criteriaTemp, "?", ".");
                        criteriaTemp = StringUtil.replace(criteriaTemp, asteriskSymbol, "\\*");
                        criteriaTemp = StringUtil.replace(criteriaTemp, questionSymbol, "\\?");
                        criteriaTemp = StringUtil.replace(criteriaTemp, tildeSymbol, "~");
                        RegUtil.wildcardParseResultBuffer[criteria] = criteriaTemp;
                        RegUtil.wildcardParseRecord[criteria] = true;
                        return criteriaTemp
                    }
                    return keyword_null
                };
                RegUtil.getWildcardCriteriaFullMatch = function(criteria)
                {
                    var criteriaTemp = RegUtil.getWildcardCriteria(criteria);
                    if (criteriaTemp)
                    {
                        criteriaTemp = '^' + criteriaTemp + '$'
                    }
                    return criteriaTemp
                };
                RegUtil.getReplaceSymbol = function(expectSymbol, srcStr)
                {
                    var asteriskSymbol = '#' + expectSymbol + "0#";
                    for (var i = 1; i < 10000; i++)
                    {
                        if (srcStr.indexOf(asteriskSymbol) > 0)
                        {
                            asteriskSymbol = StringUtil.replace(asteriskSymbol, "#" + expectSymbol + (i - 1) + "#", "#" + expectSymbol + i + "#");
                            continue
                        }
                        return asteriskSymbol
                    }
                };
                RegUtil.regDict = {};
                RegUtil.regDictIgnoreCase = {};
                RegUtil.wildcardParseRecord = {};
                RegUtil.wildcardParseResultBuffer = {};
                return RegUtil
            })();
        Sheets.RegUtil = RegUtil;
        var StringUtil = (function()
            {
                function StringUtil(){}
                StringUtil.replace = function(src, substr, replacement)
                {
                    return src.split(substr).join(replacement)
                };
                StringUtil.startsWith = function(src, prefix)
                {
                    return src.indexOf(prefix) === 0
                };
                StringUtil.endsWith = function(src, suffix)
                {
                    var l = src.length - suffix.length;
                    return l >= 0 && src.indexOf(suffix, l) === l
                };
                StringUtil.leftBefore = function(src, suffex)
                {
                    var index = src.indexOf(suffex);
                    if (index < 0 || index >= src.length)
                    {
                        return src
                    }
                    else
                    {
                        return src.substr(0, index)
                    }
                };
                StringUtil.contains = function(src, ss)
                {
                    return src.indexOf(ss) >= 0
                };
                StringUtil.count = function(src, ss)
                {
                    var count = 0,
                        pos = src.indexOf(ss);
                    while (pos >= 0)
                    {
                        count += 1;
                        pos = src.indexOf(ss, pos + 1)
                    }
                    return count
                };
                return StringUtil
            })();
        Sheets.StringUtil = StringUtil;
        var DPIHelper = (function()
            {
                function DPIHelper(){}
                DPIHelper.getDevicePixel = function()
                {
                    var ratio = window.devicePixelRatio || window.screen.deviceXDPI && window.screen.deviceXDPI / window.screen.logicalXDPI || 1;
                    var x = ratio * 20;
                    var rx = Math.round(x);
                    var delta = rx - x;
                    if ((Math.round(x) - x) > 0.82)
                    {
                        return rx / 20
                    }
                    else
                    {
                        return Math.round(ratio * 100) / 100
                    }
                };
                DPIHelper.adjustDevicePixel = function(canvas, spread, sheet, ctx)
                {
                    var self = DPIHelper;
                    self.setScaleX(canvas, canvas.getContext("2d"), 1);
                    self.setScaleY(canvas, canvas.getContext("2d"), 1);
                    var ratio = self.getDevicePixel();
                    if (ratio === 1 && self.dpr === 1)
                    {
                        return
                    }
                    self.dpr = ratio;
                    var ownerSpread = spread ? spread : sheet && sheet.parent;
                    if (ownerSpread)
                    {
                        var cache = self._spreadConvasCaches,
                            spreadCache;
                        for (var i = 0; i < cache.length; i++)
                        {
                            if (ownerSpread === cache[i].spread)
                            {
                                spreadCache = cache[i];
                                break
                            }
                        }
                        if (!spreadCache)
                        {
                            spreadCache = {
                                spread: ownerSpread, sheets: [], canvases: []
                            };
                            cache.push(spreadCache)
                        }
                        if (spread)
                        {
                            spreadCache.canvases.push(canvas)
                        }
                        else
                        {
                            var cacheSheet,
                                sheets = spreadCache.sheets;
                            for (var i = 0; i < sheets.length; i++)
                            {
                                if (sheets[i].sheet === sheet)
                                {
                                    cacheSheet = sheets[i];
                                    break
                                }
                            }
                            if (!cacheSheet)
                            {
                                cacheSheet = {
                                    sheet: sheet, canvases: []
                                };
                                sheets.push(cacheSheet)
                            }
                            cacheSheet.canvases.push(canvas)
                        }
                    }
                    return
                };
                DPIHelper.getScaleX = function(canvas)
                {
                    if (!canvas)
                    {
                        return 1
                    }
                    return canvas._gcDPIScaleX
                };
                DPIHelper.getScaleY = function(canvas)
                {
                    if (!canvas)
                    {
                        return 1
                    }
                    return canvas._gcDPIScaleY
                };
                DPIHelper.setScaleX = function(canvas, ctx, scaleX)
                {
                    if (!canvas)
                    {
                        return
                    }
                    canvas._gcDPIScaleX = scaleX;
                    ctx._gcDPIScaleX = scaleX
                };
                DPIHelper.setScaleY = function(canvas, ctx, scaleY)
                {
                    if (!canvas)
                    {
                        return
                    }
                    canvas._gcDPIScaleY = scaleY;
                    ctx._gcDPIScaleY = scaleY
                };
                DPIHelper.getLogicWidth = function(canvas)
                {
                    return canvas._gcLogicWidth
                };
                DPIHelper.getLogicHeight = function(canvas)
                {
                    return canvas._gcLogicHeight
                };
                DPIHelper.setLogicWidth = function(canvas, width)
                {
                    canvas._gcLogicWidth = width
                };
                DPIHelper.setLogicHeight = function(canvas, height)
                {
                    canvas._gcLogicHeight = height
                };
                DPIHelper.setSize = function(canvas, width, height)
                {
                    var self = DPIHelper,
                        ratio = self.dpr;
                    var oldScaleX = self.getScaleX(canvas),
                        oldScaleY = self.getScaleY(canvas);
                    self.setLogicWidth(canvas, width);
                    self.setLogicHeight(canvas, height);
                    if (ratio === 1 && oldScaleX === 1 && oldScaleY === 1)
                    {
                        canvas.width = width;
                        canvas.height = height
                    }
                    else
                    {
                        var ctx = canvas.getContext("2d");
                        ctx.scale(1 / oldScaleX, 1 / oldScaleY);
                        if ($.browser.mozilla)
                        {
                            canvas.width = Math.ceil(width * ratio);
                            canvas.height = Math.ceil(height * ratio)
                        }
                        else
                        {
                            canvas.width = Math.round(width * ratio);
                            canvas.height = Math.round(height * ratio)
                        }
                        canvas.style.width = width + 'px';
                        canvas.style.height = height + 'px';
                        var newScaleX = canvas.width / width,
                            newScaleY = canvas.height / height;
                        if (newScaleX !== oldScaleX || newScaleY !== oldScaleY)
                        {
                            self.setScaleX(canvas, ctx, newScaleX);
                            self.setScaleY(canvas, ctx, newScaleY)
                        }
                        ctx.scale(newScaleX, newScaleY)
                    }
                };
                DPIHelper.disposeCanvasForSheet = function(sheet, canvas)
                {
                    var caches = DPIHelper._spreadConvasCaches;
                    var spread = sheet.parent;
                    var sheets;
                    var canvases;
                    for (var i = 0; i < caches.length; i++)
                    {
                        if (!spread || caches[i].spread === spread)
                        {
                            sheets = caches[i].sheets;
                            for (var j = 0; j < sheets.length; j++)
                            {
                                if (sheets[j].sheet === sheet)
                                {
                                    canvases = sheets[j].canvases;
                                    for (var k = 0; k < canvases.length; k++)
                                    {
                                        if (canvases[k] === canvas)
                                        {
                                            canvases.splice(k, 1);
                                            break
                                        }
                                    }
                                    break
                                }
                            }
                        }
                    }
                };
                DPIHelper.disposeCanvasForSpread = function(spread, canvas)
                {
                    var caches = DPIHelper._spreadConvasCaches;
                    var canvases;
                    for (var i = 0; i < caches.length; i++)
                    {
                        if (caches[i].spread === spread)
                        {
                            canvases = caches[i].canvases;
                            for (var k = 0; k < canvases.length; k++)
                            {
                                if (canvases[k] === canvas)
                                {
                                    canvases.splice(k, 1);
                                    break
                                }
                            }
                        }
                    }
                };
                DPIHelper.disposeSheet = function(sheet)
                {
                    var caches = DPIHelper._spreadConvasCaches;
                    var spread = sheet.parent;
                    var sheets;
                    for (var i = 0; i < caches.length; i++)
                    {
                        if (!spread || caches[i].spread === spread)
                        {
                            sheets = caches[i].sheets;
                            for (var j = 0; j < sheets.length; j++)
                                if (sheets[j].sheet === sheet)
                                {
                                    sheets.splice(j, 1)
                                }
                            return
                        }
                    }
                };
                DPIHelper.disposeSpread = function(spread)
                {
                    var caches = DPIHelper._spreadConvasCaches;
                    for (var i = 0; i < caches.length; i++)
                    {
                        if (caches[i].spread === spread)
                        {
                            caches.splice(i, 1);
                            return
                        }
                    }
                };
                DPIHelper.updateDPI = function(scaleX, scaleY)
                {
                    var self = DPIHelper;
                    var dpr = self.getDevicePixel();
                    if (self.dpr != dpr)
                    {
                        var caches = self._spreadConvasCaches,
                            sheets,
                            spreadCache,
                            canvas;
                        self.dpr = dpr;
                        for (var i = 0; i < caches.length; i++)
                        {
                            spreadCache = caches[i];
                            for (var j = 0; j < spreadCache.canvases.length; j++)
                            {
                                canvas = spreadCache.canvases[j];
                                self.setSize(canvas, self.getLogicWidth(canvas), self.getLogicHeight(canvas))
                            }
                            sheets = spreadCache.sheets;
                            for (var sIndex = 0; sIndex < sheets.length; sIndex++)
                            {
                                for (var j = 0; j < sheets[sIndex].canvases.length; j++)
                                {
                                    canvas = sheets[sIndex].canvases[j];
                                    self.setSize(canvas, self.getLogicWidth(canvas), self.getLogicHeight(canvas))
                                }
                            }
                        }
                    }
                };
                DPIHelper.dpr = 1;
                DPIHelper._spreadConvasCaches = [];
                return DPIHelper
            })();
        Sheets.DPIHelper = DPIHelper;
        var IFormulatextboxAcrossSheetSingleton = (function()
            {
                function IFormulatextboxAcrossSheetSingleton(){}
                IFormulatextboxAcrossSheetSingleton.handleFormulatextboxAcrossSheetBeforeTabChange = function(e, eData){};
                IFormulatextboxAcrossSheetSingleton.handleFormulatextboxAcrossSheetAfterTabChange = function(e, eData){};
                return IFormulatextboxAcrossSheetSingleton
            })();
        Sheets.IFormulatextboxAcrossSheetSingleton = IFormulatextboxAcrossSheetSingleton;
        (function(ExpressionType)
        {
            ExpressionType[ExpressionType["Cell"] = 0] = "Cell";
            ExpressionType[ExpressionType["ExternalCell"] = 1] = "ExternalCell";
            ExpressionType[ExpressionType["Range"] = 2] = "Range";
            ExpressionType[ExpressionType["ExternalRange"] = 3] = "ExternalRange";
            ExpressionType[ExpressionType["Double"] = 4] = "Double";
            ExpressionType[ExpressionType["String"] = 5] = "String";
            ExpressionType[ExpressionType["Boolean"] = 6] = "Boolean";
            ExpressionType[ExpressionType["Function"] = 7] = "Function";
            ExpressionType[ExpressionType["Name"] = 8] = "Name";
            ExpressionType[ExpressionType["ExternalName"] = 9] = "ExternalName";
            ExpressionType[ExpressionType["BinaryOperator"] = 10] = "BinaryOperator";
            ExpressionType[ExpressionType["UnaryOperator"] = 11] = "UnaryOperator";
            ExpressionType[ExpressionType["Error"] = 12] = "Error";
            ExpressionType[ExpressionType["ExternalError"] = 13] = "ExternalError";
            ExpressionType[ExpressionType["Parentheses"] = 14] = "Parentheses";
            ExpressionType[ExpressionType["Array"] = 15] = "Array";
            ExpressionType[ExpressionType["SheetRange"] = 16] = "SheetRange";
            ExpressionType[ExpressionType["StructReference"] = 17] = "StructReference";
            ExpressionType[ExpressionType["BangName"] = 18] = "BangName";
            ExpressionType[ExpressionType["SheetRangeError"] = 19] = "SheetRangeError";
            ExpressionType[ExpressionType["BangError"] = 20] = "BangError";
            ExpressionType[ExpressionType["MissingArgument"] = 21] = "MissingArgument";
            ExpressionType[ExpressionType["BangCell"] = 22] = "BangCell";
            ExpressionType[ExpressionType["BangRange"] = 23] = "BangRange";
            ExpressionType[ExpressionType["Expand"] = 24] = "Expand"
        })(Sheets.ExpressionType || (Sheets.ExpressionType = {}));
        var ExpressionType = Sheets.ExpressionType
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.imageLoader", ["core.common"]);
        var _GcImageLoader = (function()
            {
                function _GcImageLoader(loadedCallBack)
                {
                    this._imageCount = 0;
                    this._loadedCount = 0;
                    this.onLoadedComplete = loadedCallBack
                }
                _GcImageLoader.prototype.addImage = function(imgUrl)
                {
                    var self = this;
                    var imgs = self._imgs;
                    if (!imgs)
                    {
                        imgs = self._imgs = {}
                    }
                    var imgObj = imgs[imgUrl];
                    if (!imgObj)
                    {
                        imgObj = {};
                        var imgElement = $("<img/>");
                        imgElement.bind("load", function()
                        {
                            self.imageLoaded(imgUrl)
                        });
                        imgElement.bind("error", function()
                        {
                            self.imageLoaded(imgUrl)
                        });
                        imgElement.bind("abort", function()
                        {
                            self.imageLoaded(imgUrl)
                        });
                        self._imageCount++;
                        imgObj.state = false;
                        imgObj.img = imgElement;
                        imgs[imgUrl] = imgObj;
                        imgElement[0].src = imgUrl
                    }
                };
                _GcImageLoader.prototype.getImage = function(imgUrl)
                {
                    return this._imgs[imgUrl].img[0]
                };
                _GcImageLoader.prototype.getState = function(imgUrl)
                {
                    var imgs = this._imgs,
                        img = (imgs && imgs[imgUrl]);
                    if (img)
                    {
                        return img.state
                    }
                    return false
                };
                _GcImageLoader.prototype.imageLoaded = function(imgUrl)
                {
                    var self = this;
                    self._loadedCount++;
                    self._imgs[imgUrl].state = true;
                    if (self._loadedCount >= self._imageCount)
                    {
                        if (self.onLoadedComplete)
                        {
                            self.onLoadedComplete()
                        }
                    }
                };
                return _GcImageLoader
            })();
        Sheets._GcImageLoader = _GcImageLoader
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var __extends = this.__extends || function(d, b)
    {
        for (var p in b)
            if (b.hasOwnProperty(p))
                d[p] = b[p];
        function __()
        {
            this.constructor = d
        }
        __.prototype = b.prototype;
        d.prototype = new __
    };
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.cultureInfo");
        var CultureInfo = (function()
            {
                function CultureInfo()
                {
                    this.currencyDecimalDigits = 2;
                    this.currencyDecimalSeparator = ".";
                    this.currencyPositivePattern = 0;
                    this.currencyGroupSeparator = ",";
                    this.currencySymbol = "\u00A4";
                    this.currencyGroupSizes = [3];
                    this.currencyNegativePattern = 0;
                    this.digitSubstitution = 1;
                    this.isReadOnly = true;
                    this.numberGroupSizes = [3];
                    this.nanSymbol = "NaN";
                    this.nativeDigits = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
                    this.numberNegativePattern = 1;
                    this.negativeInfinitySymbol = "-Infinity";
                    this.negativeSign = "-";
                    this.numberDecimalDigits = 2;
                    this.numberDecimalSeparator = ".";
                    this.numberGroupSeparator = ",";
                    this.arrayGroupSeparator = ";";
                    this.listSeparator = ",";
                    this.positiveInfinitySymbol = "Infinity";
                    this.positiveSign = "+";
                    this.percentDecimalDigits = 2;
                    this.percentDecimalSeparator = ".";
                    this.percentGroupSeparator = ",";
                    this.percentSymbol = "%";
                    this.perMilleSymbol = "\u2030";
                    this.percentPositivePattern = 0;
                    this.percentNegativePattern = 0;
                    this.percentGroupSizes = [3];
                    this.amDesignator = "AM";
                    this.abbreviatedMonthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", ""];
                    this.abbreviatedDayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                    this.abbreviatedMonthGenitiveNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", ""];
                    this.calendarWeekRule = 0;
                    this.dateSeparator = "/";
                    this.dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                    this.firstDayOfWeek = 0;
                    this.fullDateTimePattern = "dddd, dd MMMM yyyy HH:mm:ss";
                    this.longDatePattern = "dddd, dd MMMM yyyy";
                    this.longTimePattern = "HH:mm:ss";
                    this.monthDayPattern = "MMMM dd";
                    this.monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December", ""];
                    this.monthGenitiveNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December", ""];
                    this.nativeCalendarName = "Gregorian Calendar";
                    this.pmDesignator = "PM";
                    this.rfc1123Pattern = "ddd, dd MMM yyyy HH\':\'mm\':\'ss \'GMT\'";
                    this.shortDatePattern = "MM/dd/yyyy";
                    this.shortTimePattern = "HH:mm";
                    this.sortableDateTimePattern = "yyyy\'-\'MM\'-\'dd\'T\'HH\':\'mm\':\'ss";
                    this.shortestDayNames = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
                    this.timeSeparator = ":";
                    this.universalSortableDateTimePattern = "yyyy\'-\'MM\'-\'dd HH\':\'mm\':\'ss\'Z\'";
                    this.yearMonthPattern = "yyyy MMMM";
                    this.calendarIsReadOnly = true
                }
                return CultureInfo
            })();
        Sheets.CultureInfo = CultureInfo;
        var _ENCultureInfo = (function(_super)
            {
                __extends(_ENCultureInfo, _super);
                function _ENCultureInfo()
                {
                    _super.apply(this, arguments);
                    this.currencySymbol = "$";
                    this.isReadOnly = false;
                    this.fullDateTimePattern = "dddd, MMMM dd, yyyy h:mm:ss tt";
                    this.longDatePattern = "dddd, MMMM dd, yyyy";
                    this.longTimePattern = "h:mm:ss tt";
                    this.shortDatePattern = "M/d/yyyy";
                    this.shortTimePattern = "h:mm tt";
                    this.yearMonthPattern = "MMMM, yyyy";
                    this.calendarIsReadOnly = false
                }
                return _ENCultureInfo
            })(CultureInfo);
        Sheets._ENCultureInfo = _ENCultureInfo;
        var _JPCultureInfo = (function(_super)
            {
                __extends(_JPCultureInfo, _super);
                function _JPCultureInfo()
                {
                    _super.apply(this, arguments);
                    this.currencyDecimalDigits = 0;
                    this.currencySymbol = "\uffe5";
                    this.isReadOnly = false;
                    this.percentPositivePattern = 1;
                    this.percentNegativePattern = 1;
                    this.amDesignator = "\u5348\u524d";
                    this.abbreviatedMonthNames = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", ""];
                    this.abbreviatedDayNames = ["\u65e5", "\u6708", "\u706b", "\u6c34", "\u6728", "\u91d1", "\u571f"];
                    this.abbreviatedMonthGenitiveNames = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", ""];
                    this.dayNames = ["\u65e5\u66dc\u65e5", "\u6708\u66dc\u65e5", "\u706b\u66dc\u65e5", "\u6c34\u66dc\u65e5", "\u6728\u66dc\u65e5", "\u91d1\u66dc\u65e5", "\u571f\u66dc\u65e5"];
                    this.fullDateTimePattern = "yyyy'\u5e74'M'\u6708'd'\u65e5' H:mm:ss";
                    this.longDatePattern = "yyyy'\u5e74'M'\u6708'd'\u65e5'";
                    this.longTimePattern = "H:mm:ss";
                    this.monthDayPattern = "M'\u6708'd'\u65e5'";
                    this.monthNames = ["1\u6708", "2\u6708", "3\u6708", "4\u6708", "5\u6708", "6\u6708", "7\u6708", "8\u6708", "9\u6708", "10\u6708", "11\u6708", "12\u6708", ""];
                    this.monthGenitiveNames = ["1\u6708", "2\u6708", "3\u6708", "4\u6708", "5\u6708", "6\u6708", "7\u6708", "8\u6708", "9\u6708", "10\u6708", "11\u6708", "12\u6708", ""];
                    this.nativeCalendarName = "\u897f\u66a6 (\u65e5\u672c\u8a9e)";
                    this.pmDesignator = "\u5348\u5f8c";
                    this.shortDatePattern = "yyyy/MM/dd";
                    this.shortTimePattern = "H:mm";
                    this.shortestDayNames = ["\u65e5", "\u6708", "\u706b", "\u6c34", "\u6728", "\u91d1", "\u571f"];
                    this.yearMonthPattern = "yyyy'\u5e74'M'\u6708'";
                    this.calendarIsReadOnly = false
                }
                return _JPCultureInfo
            })(CultureInfo);
        Sheets._JPCultureInfo = _JPCultureInfo;
        Sheets.cultureInfoDict = {
            "": new CultureInfo, "en-us": new _ENCultureInfo, "ja-jp": new _JPCultureInfo
        };
        Sheets.CR = Sheets.cultureInfoDict["en-us"];
        Sheets.dateTimeFormats = ["yy/MM/dd", "yy/MM/d", "yy/M/dd", "yy/M/d", "yyyy/MM/dd", "yyyy/MM/d", "yyyy/M/dd", "yyyy/M/d", "MM/dd/yyyy", "MM/d/yyyy", "M/dd/yyyy", "M/d/yyyy", "hh:mm:ss", "hh:mm:s", "hh:m:ss", "hh:m:s", "h:mm:ss", "h:mm:s", "h:m:ss", "h:m:s", "hh:mm:ss tt", "hh:mm:s tt", "hh:m:ss tt", "hh:m:s tt", "h:mm:ss tt", "h:mm:s tt", "h:m:ss tt", "h:m:s tt", "hh:mm", "hh:m", "h:mm", "h:m", "yy/MM/dd hh:mm:ss", "yy/MM/dd hh:mm:s", "yy/MM/dd hh:m:ss", "yy/MM/dd hh:m:s", "yy/MM/dd h:mm:ss", "yy/MM/dd h:mm:s", "yy/MM/dd h:m:ss", "yy/MM/dd h:m:s", "yy/MM/dd hh:mm:ss tt", "yy/MM/dd hh:mm:s tt", "yy/MM/dd hh:m:ss tt", "yy/MM/dd hh:m:s tt", "yy/MM/dd h:mm:ss tt", "yy/MM/dd h:mm:s tt", "yy/MM/dd h:m:ss tt", "yy/MM/dd h:m:s tt", "yy/MM/d hh:mm:ss", "yy/MM/d hh:mm:s", "yy/MM/d hh:m:ss", "yy/MM/d hh:m:s", "yy/MM/d hh:mm:ss", "yy/MM/d h:mm:s", "yy/MM/d h:m:ss", "yy/MM/d h:m:s", "yy/MM/d hh:mm:ss tt", "yy/MM/d hh:mm:s tt", "yy/MM/d hh:m:ss tt", "yy/MM/d hh:m:s tt", "yy/MM/d h:mm:ss tt", "yy/MM/d h:mm:s tt", "yy/MM/d h:m:ss tt", "yy/MM/d h:m:s tt", "yy/M/dd hh:mm:ss", "yy/M/dd hh:mm:s", "yy/M/dd hh:m:ss", "yy/M/dd hh:m:s", "yy/M/dd hh:mm:ss", "yy/M/dd h:mm:s", "yy/M/dd h:m:ss", "yy/M/dd h:m:s", "yy/M/dd hh:mm:ss tt", "yy/M/dd hh:mm:s tt", "yy/M/dd hh:m:ss tt", "yy/M/dd hh:m:s tt", "yy/M/dd h:mm:ss tt", "yy/M/dd h:mm:s tt", "yy/M/dd h:m:ss tt", "yy/M/dd h:m:s tt", "yy/M/d hh:mm:ss", "yy/M/d hh:mm:s", "yy/M/d hh:m:ss", "yy/M/d hh:m:s", "yy/M/d hh:mm:ss", "yy/M/d h:mm:s", "yy/M/d h:m:ss", "yy/M/d h:m:s", "yy/M/d hh:mm:ss tt", "yy/M/d hh:mm:s tt", "yy/M/d hh:m:ss tt", "yy/M/d hh:m:s tt", "yy/M/d h:mm:ss tt", "yy/M/d h:mm:s tt", "yy/M/d h:m:ss tt", "yy/M/d h:m:s tt", "yyyy/MM/dd hh:mm:ss", "yyyy/MM/dd hh:mm:s", "yyyy/MM/dd hh:m:ss", "yyyy/MM/dd hh:m:s", "yyyy/MM/dd hh:mm:ss", "yyyy/MM/dd h:mm:s", "yyyy/MM/dd h:m:ss", "yyyy/MM/dd h:m:s", "yyyy/MM/dd hh:mm:ss tt", "yyyy/MM/dd hh:mm:s tt", "yyyy/MM/dd hh:m:ss tt", "yyyy/MM/dd hh:m:s tt", "yyyy/MM/dd h:mm:ss tt", "yyyy/MM/dd h:mm:s tt", "yyyy/MM/dd h:m:ss tt", "yyyy/MM/dd h:m:s tt", "yyyy/MM/d hh:mm:ss", "yyyy/MM/d hh:mm:s", "yyyy/MM/d hh:m:ss", "yyyy/MM/d hh:m:s", "yyyy/MM/d hh:mm:ss", "yyyy/MM/d h:mm:s", "yyyy/MM/d h:m:ss", "yyyy/MM/d h:m:s", "yyyy/MM/d hh:mm:ss tt", "yyyy/MM/d hh:mm:s tt", "yyyy/MM/d hh:m:ss tt", "yyyy/MM/d hh:m:s tt", "yyyy/MM/d h:mm:ss tt", "yyyy/MM/d h:mm:s tt", "yyyy/MM/d h:m:ss tt", "yyyy/MM/d h:m:s tt", "yyyy/M/dd hh:mm:ss", "yyyy/M/dd hh:mm:s", "yyyy/M/dd hh:m:ss", "yyyy/M/dd hh:m:s", "yyyy/M/dd hh:mm:ss", "yyyy/M/dd h:mm:s", "yyyy/M/dd h:m:ss", "yyyy/M/dd h:m:s", "yyyy/M/dd hh:mm:ss tt", "yyyy/M/dd hh:mm:s tt", "yyyy/M/dd hh:m:ss tt", "yyyy/M/dd hh:m:s tt", "yyyy/M/dd h:mm:ss tt", "yyyy/M/dd h:mm:s tt", "yyyy/M/dd h:m:ss tt", "yyyy/M/dd h:m:s tt", "yyyy/M/d hh:mm:ss", "yyyy/M/d hh:mm:s", "yyyy/M/d hh:m:ss", "yyyy/M/d hh:m:s", "yyyy/M/d hh:mm:ss", "yyyy/M/d h:mm:s", "yyyy/M/d h:m:ss", "yyyy/M/d h:m:s", "yyyy/M/d hh:mm:ss tt", "yyyy/M/d hh:mm:s tt", "yyyy/M/d hh:m:ss tt", "yyyy/M/d hh:m:s tt", "yyyy/M/d h:mm:ss tt", "yyyy/M/d h:mm:s tt", "yyyy/M/d h:m:ss tt", "yyyy/M/d h:m:s tt", "MM/dd/yyyy hh:mm:ss", "MM/dd/yyyy hh:mm:s", "MM/dd/yyyy hh:m:ss", "MM/dd/yyyy hh:m:s", "MM/dd/yyyy hh:mm:ss", "MM/dd/yyyy h:mm:s", "MM/dd/yyyy h:m:ss", "MM/dd/yyyy h:m:s", "MM/dd/yyyy hh:mm:ss tt", "MM/dd/yyyy hh:mm:s tt", "MM/dd/yyyy hh:m:ss tt", "MM/dd/yyyy hh:m:s tt", "MM/dd/yyyy h:mm:ss tt", "MM/dd/yyyy h:mm:s tt", "MM/dd/yyyy h:m:ss tt", "MM/dd/yyyy h:m:s tt", "MM/d/yyyy hh:mm:ss", "MM/d/yyyy hh:mm:s", "MM/d/yyyy hh:m:ss", "MM/d/yyyy hh:m:s", "MM/d/yyyy hh:mm:ss", "MM/d/yyyy h:mm:s", "MM/d/yyyy h:m:ss", "MM/d/yyyy h:m:s", "MM/d/yyyy hh:mm:ss tt", "MM/d/yyyy hh:mm:s tt", "MM/d/yyyy hh:m:ss tt", "MM/d/yyyy hh:m:s tt", "MM/d/yyyy h:mm:ss tt", "MM/d/yyyy h:mm:s tt", "MM/d/yyyy h:m:ss tt", "MM/d/yyyy h:m:s tt", "M/dd/yyyy hh:mm:ss", "M/dd/yyyy hh:mm:s", "M/dd/yyyy hh:m:ss", "M/dd/yyyy hh:m:s", "M/dd/yyyy hh:mm:ss", "M/dd/yyyy h:mm:s", "M/dd/yyyy h:m:ss", "M/dd/yyyy h:m:s", "M/dd/yyyy hh:mm:ss tt", "M/dd/yyyy hh:mm:s tt", "M/dd/yyyy hh:m:ss tt", "M/dd/yyyy hh:m:s tt", "M/dd/yyyy h:mm:ss tt", "M/dd/yyyy h:mm:s tt", "M/dd/yyyy h:m:ss tt", "M/dd/yyyy h:m:s tt", "M/d/yyyy hh:mm:ss", "M/d/yyyy hh:mm:s", "M/d/yyyy hh:m:ss", "M/d/yyyy hh:m:s", "M/d/yyyy hh:mm:ss", "M/d/yyyy h:mm:s", "M/d/yyyy h:m:ss", "M/d/yyyy h:m:s", "M/d/yyyy hh:mm:ss tt", "M/d/yyyy hh:mm:s tt", "M/d/yyyy hh:m:ss tt", "M/d/yyyy hh:m:s tt", "M/d/yyyy h:mm:ss tt", "M/d/yyyy h:mm:s tt", "M/d/yyyy h:m:ss tt", "M/d/yyyy h:m:s tt", "yy-MM-dd", "yy-MM-d", "yy-M-dd", "yy-M-d", "yyyy-MM-dd", "yyyy-MM-d", "yyyy-M-dd", "yyyy-M-d", "MM-dd-yyyy", "MM-d-yyyy", "M-dd-yyyy", "M-d-yyyy", "yy-MM-dd hh:mm:ss", "yy-MM-dd hh:mm:s", "yy-MM-dd hh:m:ss", "yy-MM-dd hh:m:s", "yy-MM-dd h:mm:ss", "yy-MM-dd h:mm:s", "yy-MM-dd h:m:ss", "yy-MM-dd h:m:s", "yy-MM-dd hh:mm:ss tt", "yy-MM-dd hh:mm:s tt", "yy-MM-dd hh:m:ss tt", "yy-MM-dd hh:m:s tt", "yy-MM-dd h:mm:ss tt", "yy-MM-dd h:mm:s tt", "yy-MM-dd h:m:ss tt", "yy-MM-dd h:m:s tt", "yy-MM-d hh:mm:ss", "yy-MM-d hh:mm:s", "yy-MM-d hh:m:ss", "yy-MM-d hh:m:s", "yy-MM-d hh:mm:ss", "yy-MM-d h:mm:s", "yy-MM-d h:m:ss", "yy-MM-d h:m:s", "yy-MM-d hh:mm:ss tt", "yy-MM-d hh:mm:s tt", "yy-MM-d hh:m:ss tt", "yy-MM-d hh:m:s tt", "yy-MM-d h:mm:ss tt", "yy-MM-d h:mm:s tt", "yy-MM-d h:m:ss tt", "yy-MM-d h:m:s tt", "yy-M-dd hh:mm:ss", "yy-M-dd hh:mm:s", "yy-M-dd hh:m:ss", "yy-M-dd hh:m:s", "yy-M-dd hh:mm:ss", "yy-M-dd h:mm:s", "yy-M-dd h:m:ss", "yy-M-dd h:m:s", "yy-M-dd hh:mm:ss tt", "yy-M-dd hh:mm:s tt", "yy-M-dd hh:m:ss tt", "yy-M-dd hh:m:s tt", "yy-M-dd h:mm:ss tt", "yy-M-dd h:mm:s tt", "yy-M-dd h:m:ss tt", "yy-M-dd h:m:s tt", "yy-M-d hh:mm:ss", "yy-M-d hh:mm:s", "yy-M-d hh:m:ss", "yy-M-d hh:m:s", "yy-M-d hh:mm:ss", "yy-M-d h:mm:s", "yy-M-d h:m:ss", "yy-M-d h:m:s", "yy-M-d hh:mm:ss tt", "yy-M-d hh:mm:s tt", "yy-M-d hh:m:ss tt", "yy-M-d hh:m:s tt", "yy-M-d h:mm:ss tt", "yy-M-d h:mm:s tt", "yy-M-d h:m:ss tt", "yy-M-d h:m:s tt", "yyyy-MM-dd hh:mm:ss", "yyyy-MM-dd hh:mm:s", "yyyy-MM-dd hh:m:ss", "yyyy-MM-dd hh:m:s", "yyyy-MM-dd hh:mm:ss", "yyyy-MM-dd h:mm:s", "yyyy-MM-dd h:m:ss", "yyyy-MM-dd h:m:s", "yyyy-MM-dd hh:mm:ss tt", "yyyy-MM-dd hh:mm:s tt", "yyyy-MM-dd hh:m:ss tt", "yyyy-MM-dd hh:m:s tt", "yyyy-MM-dd h:mm:ss tt", "yyyy-MM-dd h:mm:s tt", "yyyy-MM-dd h:m:ss tt", "yyyy-MM-dd h:m:s tt", "yyyy-MM-d hh:mm:ss", "yyyy-MM-d hh:mm:s", "yyyy-MM-d hh:m:ss", "yyyy-MM-d hh:m:s", "yyyy-MM-d hh:mm:ss", "yyyy-MM-d h:mm:s", "yyyy-MM-d h:m:ss", "yyyy-MM-d h:m:s", "yyyy-MM-d hh:mm:ss tt", "yyyy-MM-d hh:mm:s tt", "yyyy-MM-d hh:m:ss tt", "yyyy-MM-d hh:m:s tt", "yyyy-MM-d h:mm:ss tt", "yyyy-MM-d h:mm:s tt", "yyyy-MM-d h:m:ss tt", "yyyy-MM-d h:m:s tt", "yyyy-M-dd hh:mm:ss", "yyyy-M-dd hh:mm:s", "yyyy-M-dd hh:m:ss", "yyyy-M-dd hh:m:s", "yyyy-M-dd hh:mm:ss", "yyyy-M-dd h:mm:s", "yyyy-M-dd h:m:ss", "yyyy-M-dd h:m:s", "yyyy-M-dd hh:mm:ss tt", "yyyy-M-dd hh:mm:s tt", "yyyy-M-dd hh:m:ss tt", "yyyy-M-dd hh:m:s tt", "yyyy-M-dd h:mm:ss tt", "yyyy-M-dd h:mm:s tt", "yyyy-M-dd h:m:ss tt", "yyyy-M-dd h:m:s tt", "yyyy-M-d hh:mm:ss", "yyyy-M-d hh:mm:s", "yyyy-M-d hh:m:ss", "yyyy-M-d hh:m:s", "yyyy-M-d hh:mm:ss", "yyyy-M-d h:mm:s", "yyyy-M-d h:m:ss", "yyyy-M-d h:m:s", "yyyy-M-d hh:mm:ss tt", "yyyy-M-d hh:mm:s tt", "yyyy-M-d hh:m:ss tt", "yyyy-M-d hh:m:s tt", "yyyy-M-d h:mm:ss tt", "yyyy-M-d h:mm:s tt", "yyyy-M-d h:m:ss tt", "yyyy-M-d h:m:s tt", "MM-dd-yyyy hh:mm:ss", "MM-dd-yyyy hh:mm:s", "MM-dd-yyyy hh:m:ss", "MM-dd-yyyy hh:m:s", "MM-dd-yyyy hh:mm:ss", "MM-dd-yyyy h:mm:s", "MM-dd-yyyy h:m:ss", "MM-dd-yyyy h:m:s", "MM-dd-yyyy hh:mm:ss tt", "MM-dd-yyyy hh:mm:s tt", "MM-dd-yyyy hh:m:ss tt", "MM-dd-yyyy hh:m:s tt", "MM-dd-yyyy h:mm:ss tt", "MM-dd-yyyy h:mm:s tt", "MM-dd-yyyy h:m:ss tt", "MM-dd-yyyy h:m:s tt", "MM-d-yyyy hh:mm:ss", "MM-d-yyyy hh:mm:s", "MM-d-yyyy hh:m:ss", "MM-d-yyyy hh:m:s", "MM-d-yyyy hh:mm:ss", "MM-d-yyyy h:mm:s", "MM-d-yyyy h:m:ss", "MM-d-yyyy h:m:s", "MM-d-yyyy hh:mm:ss tt", "MM-d-yyyy hh:mm:s tt", "MM-d-yyyy hh:m:ss tt", "MM-d-yyyy hh:m:s tt", "MM-d-yyyy h:mm:ss tt", "MM-d-yyyy h:mm:s tt", "MM-d-yyyy h:m:ss tt", "MM-d-yyyy h:m:s tt", "M-dd-yyyy hh:mm:ss", "M-dd-yyyy hh:mm:s", "M-dd-yyyy hh:m:ss", "M-dd-yyyy hh:m:s", "M-dd-yyyy hh:mm:ss", "M-dd-yyyy h:mm:s", "M-dd-yyyy h:m:ss", "M-dd-yyyy h:m:s", "M-dd-yyyy hh:mm:ss tt", "M-dd-yyyy hh:mm:s tt", "M-dd-yyyy hh:m:ss tt", "M-dd-yyyy hh:m:s tt", "M-dd-yyyy h:mm:ss tt", "M-dd-yyyy h:mm:s tt", "M-dd-yyyy h:m:ss tt", "M-dd-yyyy h:m:s tt", "M-d-yyyy hh:mm:ss", "M-d-yyyy hh:mm:s", "M-d-yyyy hh:m:ss", "M-d-yyyy hh:m:s", "M-d-yyyy hh:mm:ss", "M-d-yyyy h:mm:s", "M-d-yyyy h:m:ss", "M-d-yyyy h:m:s", "M-d-yyyy hh:mm:ss tt", "M-d-yyyy hh:mm:s tt", "M-d-yyyy hh:m:ss tt", "M-d-yyyy hh:m:s tt", "M-d-yyyy h:mm:ss tt", "M-d-yyyy h:mm:s tt", "M-d-yyyy h:m:ss tt", "M-d-yyyy h:m:s tt"]
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.globalize", ["core.stringResource", "core.migrate", "core.cultureInfo"]);
        var keyword_null = null,
            keyword_undefined = undefined,
            Math_max = Math.max,
            Math_min = Math.min,
            Math_ceil = Math.ceil,
            Math_floor = Math.floor,
            Math_abs = Math.abs,
            Math_pow = Math.pow,
            Math_round = Math.round,
            const_undefined = "undefined";
        var _StringBuilder = (function()
            {
                function _StringBuilder(str)
                {
                    this._value = {};
                    this._len = 0;
                    this._init(str)
                }
                _StringBuilder.prototype._init = function(initialText)
                {
                    this._parts = (typeof(initialText) !== const_undefined && initialText !== keyword_null && initialText !== '') ? [initialText.toString()] : [];
                    this._value = {};
                    this._len = 0
                };
                _StringBuilder.prototype._insert = function(text)
                {
                    this._parts.splice(0, 0, text)
                };
                _StringBuilder.prototype.insert = function(text, position)
                {
                    var self = this;
                    if (position === keyword_undefined || position === keyword_null)
                    {
                        position = 0
                    }
                    if (position === 0)
                    {
                        self._insert(text);
                        return
                    }
                    var content = self.toString();
                    if (position >= content.length)
                    {
                        self.append(text);
                        return
                    }
                    var first = content.substring(0, position);
                    var left = content.substr(position);
                    self._init(first + text + left)
                };
                _StringBuilder.prototype.append = function(text)
                {
                    this._parts[this._parts.length] = text
                };
                _StringBuilder.prototype.appendLine = function(text)
                {
                    this._parts[this._parts.length] = ((typeof(text) === const_undefined) || (text === keyword_null) || (text === '')) ? '\r\n' : text + '\r\n'
                };
                _StringBuilder.prototype.clear = function()
                {
                    this._init()
                };
                _StringBuilder.prototype.isEmpty = function()
                {
                    if (this._parts.length === 0)
                    {
                        return true
                    }
                    return this.toString() === ''
                };
                _StringBuilder.prototype.toString = function(separator)
                {
                    var self = this;
                    separator = separator || '';
                    var parts = self._parts;
                    if (self._len !== parts.length)
                    {
                        self._value = {};
                        self._len = parts.length
                    }
                    var val = self._value;
                    if (typeof(val[separator]) === const_undefined)
                    {
                        if (separator !== '')
                        {
                            for (var i = 0; i < parts.length; )
                            {
                                if ((typeof(parts[i]) === const_undefined) || (parts[i] === '') || (parts[i] === keyword_null))
                                {
                                    parts.splice(i, 1)
                                }
                                else
                                {
                                    i++
                                }
                            }
                        }
                        val[separator] = self._parts.join(separator)
                    }
                    return val[separator]
                };
                return _StringBuilder
            })();
        Sheets._StringBuilder = _StringBuilder;
        function __toUpper(value)
        {
            return value.split("\u00A0").join(' ').toUpperCase()
        }
        function __toUpperArray(arr)
        {
            var result = [];
            for (var i = 0, il = arr.length; i < il; i++)
            {
                result[i] = __toUpper(arr[i])
            }
            return result
        }
        function __getIndex(value, a1, a2)
        {
            var upper = __toUpper(value),
                i = Sheets.ArrayHelper.indexOf(a1, upper);
            if (i === -1)
            {
                i = Sheets.ArrayHelper.indexOf(a2, upper)
            }
            return i
        }
        var _NumberFormatInfo = (function()
            {
                function _NumberFormatInfo()
                {
                    var self = this;
                    var cultureInfo = Sheets._currentCultureResouce;
                    self.currencyDecimalDigits = cultureInfo.currencyDecimalDigits;
                    self.currencyDecimalSeparator = cultureInfo.currencyDecimalSeparator;
                    self.currencyPositivePattern = cultureInfo.currencyPositivePattern;
                    self.currencyGroupSeparator = cultureInfo.currencyGroupSeparator;
                    self.currencySymbol = cultureInfo.currencySymbol;
                    self.currencyGroupSizes = cultureInfo.currencyGroupSizes;
                    self.currencyNegativePattern = cultureInfo.currencyNegativePattern;
                    self.digitSubstitution = cultureInfo.digitSubstitution;
                    self.isReadOnly = cultureInfo.isReadOnly;
                    self.numberGroupSizes = cultureInfo.numberGroupSizes;
                    self.nanSymbol = cultureInfo.nanSymbol;
                    self.nativeDigits = cultureInfo.nativeDigits;
                    self.numberNegativePattern = cultureInfo.numberNegativePattern;
                    self.negativeInfinitySymbol = cultureInfo.negativeInfinitySymbol;
                    self.negativeSign = cultureInfo.negativeSign;
                    self.numberDecimalDigits = cultureInfo.numberDecimalDigits;
                    self.numberDecimalSeparator = cultureInfo.numberDecimalSeparator;
                    self.numberGroupSeparator = cultureInfo.numberGroupSeparator;
                    self.positiveInfinitySymbol = cultureInfo.positiveInfinitySymbol;
                    self.positiveSign = cultureInfo.positiveSign;
                    self.percentDecimalDigits = cultureInfo.percentDecimalDigits;
                    self.percentDecimalSeparator = cultureInfo.percentDecimalSeparator;
                    self.percentGroupSeparator = cultureInfo.percentGroupSeparator;
                    self.percentSymbol = cultureInfo.percentSymbol;
                    self.perMilleSymbol = cultureInfo.perMilleSymbol;
                    self.percentPositivePattern = cultureInfo.percentPositivePattern;
                    self.percentNegativePattern = cultureInfo.percentNegativePattern;
                    self.percentGroupSizes = cultureInfo.percentGroupSizes
                }
                return _NumberFormatInfo
            })();
        Sheets._NumberFormatInfo = _NumberFormatInfo;
        var _Calendar = (function()
            {
                function _Calendar()
                {
                    var self = this;
                    self.MinSupportedDateTime = "@-62135568000000@";
                    self.MaxSupportedDateTime = "@253402300799999@";
                    self.AlgorithmType = 1;
                    self.CalendarType = 1;
                    self.Eras = [1];
                    self.TwoDigitYearMax = 2029;
                    self.isReadOnly = true
                }
                return _Calendar
            })();
        Sheets._Calendar = _Calendar;
        var _DateTimeFormatInfo = (function()
            {
                function _DateTimeFormatInfo()
                {
                    var self = this;
                    var cultureInfo = Sheets._currentCultureResouce;
                    self.amDesignator = cultureInfo.amDesignator;
                    self.abbreviatedMonthNames = cultureInfo.abbreviatedMonthNames;
                    self.abbreviatedDayNames = cultureInfo.abbreviatedDayNames;
                    self.abbreviatedMonthGenitiveNames = cultureInfo.abbreviatedMonthGenitiveNames;
                    self.Calendar = new _Calendar;
                    self.calendarWeekRule = cultureInfo.calendarWeekRule;
                    self.dateSeparator = cultureInfo.dateSeparator;
                    self.dayNames = cultureInfo.dayNames;
                    self.firstDayOfWeek = cultureInfo.firstDayOfWeek;
                    self.fullDateTimePattern = cultureInfo.fullDateTimePattern;
                    self.isReadOnly = cultureInfo.isReadOnly;
                    self.longDatePattern = cultureInfo.longDatePattern;
                    self.longTimePattern = cultureInfo.longTimePattern;
                    self.monthDayPattern = cultureInfo.monthDayPattern;
                    self.monthNames = cultureInfo.monthNames;
                    self.monthGenitiveNames = cultureInfo.monthGenitiveNames;
                    self.nativeCalendarName = cultureInfo.nativeCalendarName;
                    self.pmDesignator = cultureInfo.pmDesignator;
                    self.rfc1123Pattern = cultureInfo.rfc1123Pattern;
                    self.shortDatePattern = cultureInfo.shortDatePattern;
                    self.shortTimePattern = cultureInfo.shortTimePattern;
                    self.sortableDateTimePattern = cultureInfo.sortableDateTimePattern;
                    self.shortestDayNames = cultureInfo.shortestDayNames;
                    self.timeSeparator = cultureInfo.timeSeparator;
                    self.universalSortableDateTimePattern = cultureInfo.universalSortableDateTimePattern;
                    self.yearMonthPattern = cultureInfo.yearMonthPattern;
                    self.Calendar.isReadOnly = cultureInfo.calendarIsReadOnly
                }
                return _DateTimeFormatInfo
            })();
        Sheets._DateTimeFormatInfo = _DateTimeFormatInfo;
        var _EraHelper = (function()
            {
                function _EraHelper(){}
                _EraHelper.isValidEraDate = function(date)
                {
                    if (date < this.getEraMin() || date > this.getEraMax())
                    {
                        return false
                    }
                    return true
                };
                _EraHelper.getEraDates = function()
                {
                    var eras = window.spreadJSEras;
                    if (eras != keyword_undefined)
                    {
                        var eraDates = new Array;
                        for (var i = 0; i < eras.length; i++)
                        {
                            var date = new Date(eras[i].startDate.replace(/-/g, "/"));
                            eraDates[i] = date
                        }
                        return eraDates
                    }
                    return this.EraDates
                };
                _EraHelper.getEraNames = function()
                {
                    var eras = window.spreadJSEras;
                    var eraNames = new Array;
                    if (eras != keyword_undefined)
                    {
                        for (var i = 0; i < eras.length; i++)
                        {
                            eraNames[i] = eras[i].name
                        }
                        return eraNames
                    }
                    for (var i = 0; i < this.EraCount; i++)
                    {
                        eraNames[i] = this.EraNames[i + 2 * this.EraCount]
                    }
                    return eraNames
                };
                _EraHelper.getEraSymbols = function()
                {
                    var eras = window.spreadJSEras;
                    var eraSymbol = new Array;
                    if (eras != keyword_undefined)
                    {
                        for (var i = 0; i < eras.length; i++)
                        {
                            eraSymbol[i] = eras[i].symbol
                        }
                        return eraSymbol
                    }
                    for (var i = 0; i < this.EraCount; i++)
                    {
                        eraSymbol[i] = this.EraNames[i];
                        ;
                    }
                    return eraSymbol
                };
                _EraHelper.getEraAbbreviations = function()
                {
                    var eras = window.spreadJSEras;
                    var eraAbbreviation = new Array;
                    if (eras != keyword_undefined)
                    {
                        for (var i = 0; i < eras.length; i++)
                        {
                            eraAbbreviation[i] = eras[i].abbreviation
                        }
                        return eraAbbreviation
                    }
                    for (var i = 0; i < this.EraCount; i++)
                    {
                        eraAbbreviation[i] = this.EraNames[i + this.EraCount]
                    }
                    return eraAbbreviation
                };
                _EraHelper.getEraShortcuts = function()
                {
                    var eras = window.spreadJSEras;
                    var eraShortcuts = new Array;
                    if (eras != keyword_undefined)
                    {
                        for (var i = 0; i < eras.length; i++)
                        {
                            eraShortcuts[i] = eras[i].shortcuts.split(',')[0]
                        }
                        return eraShortcuts
                    }
                    for (var i = 0; i < this.EraCount; i++)
                    {
                        eraShortcuts[i] = this.EraKeys[i]
                    }
                    return eraShortcuts
                };
                _EraHelper.getEraMax = function()
                {
                    var eras = window.spreadJSEras;
                    if (eras != keyword_undefined)
                    {
                        if (eras.length > 0)
                        {
                            var date = new Date(eras[eras.length - 1].startDate.replace(/-/g, "/"));
                            date.setFullYear(date.getFullYear() + 99);
                            return date
                        }
                    }
                    return this.EraMax
                };
                _EraHelper.getEraMin = function()
                {
                    var eras = window.spreadJSEras;
                    if (eras != keyword_undefined)
                    {
                        if (eras.length > 0)
                        {
                            var date = new Date(eras[0].startDate.replace(/-/g, "/"));
                            return date
                        }
                    }
                    return this.EraMin
                };
                _EraHelper.getEraCount = function()
                {
                    var eras = window.spreadJSEras;
                    if (eras != keyword_undefined)
                    {
                        return eras.length
                    }
                    return this.EraCount
                };
                _EraHelper.getEraYears = function()
                {
                    var eras = window.spreadJSEras;
                    if (eras != keyword_undefined)
                    {
                        var eraYears = new Array;
                        for (var i = 1; i < eras.length; i++)
                        {
                            var date1 = new Date(eras[i - 1].startDate.replace(/-/g, "/"));
                            var date2 = new Date(eras[i].startDate.replace(/-/g, "/"));
                            eraYears[i - 1] = date2.getFullYear() - date1.getFullYear() + 1
                        }
                        eraYears[i - 1] = 99;
                        return eraYears
                    }
                    return this.EraYears
                };
                _EraHelper.getEraDate = function(date)
                {
                    var eraDate = new Object;
                    eraDate.era = -1;
                    eraDate.eraYear = -1;
                    var self = this;
                    if (!self.isValidEraDate(date))
                    {
                        return eraDate
                    }
                    for (var i = 0; i < self.getEraCount(); i++)
                    {
                        var nextDate = i + 1 != self.getEraCount() ? self.getEraDates()[i + 1] : self.addMilliseconds(self.getEraMax(), 1);
                        if (date < nextDate)
                        {
                            eraDate.era = i;
                            eraDate.eraYear = date.getFullYear() - self.getEraDates()[i].getFullYear() + 1;
                            break
                        }
                    }
                    return eraDate
                };
                _EraHelper.addMilliseconds = function(date, msec)
                {
                    var newDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
                    newDate.setMilliseconds(newDate.getMilliseconds() + msec);
                    return new Date(newDate.valueOf())
                };
                _EraHelper.getYearFromEra = function(era, eraYear)
                {
                    var startYear = _EraHelper.getEraDates()[era].getFullYear();
                    var year = startYear + eraYear - 1;
                    return year
                };
                _EraHelper.parseEraPart = function(format, text)
                {
                    text = text.toUpperCase();
                    var eras = _EraHelper;
                    switch (format)
                    {
                        case"g":
                            var eraSymbols = eras.getEraSymbols();
                            for (var i = 0; i < eraSymbols.length; i++)
                            {
                                if (eraSymbols[i] === text)
                                {
                                    return i
                                }
                            }
                            break;
                        case"gg":
                            var eraAbbreviations = eras.getEraAbbreviations();
                            for (var i = 0; i < eraAbbreviations.length; i++)
                            {
                                if (eraAbbreviations[i] === text)
                                {
                                    return i
                                }
                            }
                            break;
                        case"ggg":
                            var eraNames = eras.getEraNames();
                            for (var i = 0; i < eraNames.length; i++)
                            {
                                if (eraNames[i] === text)
                                {
                                    return i
                                }
                            }
                            break
                    }
                    return -1
                };
                _EraHelper.formatEraPart = function(format, date)
                {
                    var eras = _EraHelper;
                    var eraDateInfo = eras.getEraDate(date);
                    switch (format)
                    {
                        case"g":
                            if (eraDateInfo.era < 0)
                            {
                                break
                            }
                            var eraName = (eras.getEraSymbols()[eraDateInfo.era]);
                            return eraName;
                            break;
                        case"gg":
                            if (eraDateInfo.era < 0)
                            {
                                break
                            }
                            var eraName = (eras.getEraAbbreviations()[eraDateInfo.era]);
                            return eraName;
                            break;
                        case"ggg":
                            if (eraDateInfo.era < 0)
                            {
                                break
                            }
                            var eraName = (eras.getEraNames()[eraDateInfo.era]);
                            return eraName;
                            break;
                        case"ee":
                            if (eraDateInfo.eraYear < 0)
                            {
                                break
                            }
                            var eraYear = eraDateInfo.eraYear.toString();
                            if (eraYear.length === 1)
                            {
                                eraYear = '0' + eraYear
                            }
                            return eraYear;
                            break;
                        case"e":
                            if (eraDateInfo.eraYear < 0)
                            {
                                break
                            }
                            var eraYear = eraDateInfo.eraYear.toString();
                            return eraYear;
                            break
                    }
                    return ""
                };
                _EraHelper.EraDates = new Array(new Date(1868, 9 - 1, 8), new Date(1912, 7 - 1, 30), new Date(1926, 12 - 1, 25), new Date(1989, 1 - 1, 8));
                _EraHelper.EraCount = 4;
                _EraHelper.EraYears = new Array(45, 15, 64, 99);
                _EraHelper.EraMax = new Date(2087, 12 - 1, 31, 23, 59, 59);
                _EraHelper.EraMin = new Date(1868, 9 - 1, 8);
                _EraHelper.EraKeys = new Array("1", "2", "3", "4", "m", "t", "s", "h");
                _EraHelper.EraIndices = new Array(0, 1, 2, 3, 0, 1, 2, 3);
                _EraHelper.EraNames = new Array("M", "T", "S", "H", "\u660E", "\u5927", "\u662D", "\u5E73", "\u660E\u6CBB", "\u5927\u6B63", "\u662D\u548C", "\u5E73\u6210");
                _EraHelper.EraYearMax = 99;
                return _EraHelper
            })();
        Sheets._EraHelper = _EraHelper;
        var _CultureInfo = (function()
            {
                function _CultureInfo(name)
                {
                    var self = this;
                    name = name ? name : "";
                    self.name = name;
                    Sheets._currentCultureResouce = getCultureInfoCore(name);
                    self.numberFormat = new _NumberFormatInfo;
                    self.dateTimeFormat = new _DateTimeFormatInfo
                }
                _CultureInfo.prototype.Name = function()
                {
                    return this.name
                };
                _CultureInfo.prototype.NumberFormat = function()
                {
                    return this.numberFormat
                };
                _CultureInfo.prototype.DateTimeFormat = function()
                {
                    return this.dateTimeFormat
                };
                _CultureInfo.prototype._getDateTimeFormats = function()
                {
                    if (!this._dateTimeFormats)
                    {
                        this._dateTimeFormats = Sheets.dateTimeFormats
                    }
                    return this._dateTimeFormats
                };
                _CultureInfo.prototype._getMonthIndex = function(value)
                {
                    var self = this;
                    if (!self._upperMonths)
                    {
                        self._upperMonths = __toUpperArray(self.dateTimeFormat.monthNames);
                        self._upperMonthsGenitive = __toUpperArray(self.dateTimeFormat.monthGenitiveNames)
                    }
                    return __getIndex(value, self._upperMonths, self._upperMonthsGenitive)
                };
                _CultureInfo.prototype._getAbbrMonthIndex = function(value)
                {
                    var self = this;
                    if (!self._upperAbbrMonths)
                    {
                        self._upperAbbrMonths = __toUpperArray(self.dateTimeFormat.abbreviatedMonthNames);
                        self._upperAbbrMonthsGenitive = __toUpperArray(self.dateTimeFormat.abbreviatedMonthGenitiveNames)
                    }
                    return __getIndex(value, self._upperAbbrMonths, self._upperAbbrMonthsGenitive)
                };
                _CultureInfo.prototype._getDayIndex = function(value)
                {
                    var self = this;
                    if (!self._upperDays)
                    {
                        self._upperDays = __toUpperArray(self.dateTimeFormat.dayNames)
                    }
                    return Sheets.ArrayHelper.indexOf(self._upperDays, __toUpper(value))
                };
                _CultureInfo.prototype._getAbbrDayIndex = function(value)
                {
                    var self = this;
                    if (!self._upperAbbrDays)
                    {
                        self._upperAbbrDays = __toUpperArray(self.dateTimeFormat.abbreviatedDayNames)
                    }
                    return Sheets.ArrayHelper.indexOf(self._upperAbbrDays, __toUpper(value))
                };
                _CultureInfo.invariantCulture = function()
                {
                    var cultureClass = _CultureInfo;
                    if (!cultureClass._invariantCulture)
                    {
                        cultureClass._invariantCulture = new _CultureInfo("")
                    }
                    return cultureClass._invariantCulture
                };
                _CultureInfo.currentCulture = function(cultureName)
                {
                    if (typeof cultureName === "undefined")
                    {
                        return _CultureInfo._currentCulture
                    }
                    var cultureClass = _CultureInfo;
                    cultureClass._currentCulture = cultureClass.getCulture(cultureName);
                    return cultureClass._currentCulture
                };
                _CultureInfo.enCulture = function()
                {
                    var cultureClass = _CultureInfo;
                    if (!cultureClass._enCulture)
                    {
                        cultureClass._enCulture = new _CultureInfo("en-US")
                    }
                    return cultureClass._enCulture
                };
                _CultureInfo.japanCulture = function()
                {
                    var cultureClass = _CultureInfo;
                    if (!cultureClass._japanCulture)
                    {
                        var jpCulture = new _CultureInfo("ja-JP");
                        jpCulture.dateTimeFormat.eras = _EraHelper;
                        var dateTimeFormats = jpCulture._getDateTimeFormats().slice(0);
                        dateTimeFormats.push("");
                        cultureClass._japanCulture = jpCulture
                    }
                    return cultureClass._japanCulture
                };
                _CultureInfo.customCulture = function(cultureName)
                {
                    var cultureClass = _CultureInfo;
                    if (!cultureClass._customCulture || cultureClass._customCulture.Name() !== cultureName)
                    {
                        var customCulture = new _CultureInfo(cultureName);
                        cultureClass._customCulture = customCulture
                    }
                    return cultureClass._customCulture
                };
                _CultureInfo.getCulture = function(cultureName)
                {
                    cultureName = cultureName ? cultureName : "";
                    cultureName = cultureName.toLowerCase();
                    Sheets._currentCultureResouce = getCultureInfoCore(cultureName);
                    switch (cultureName)
                    {
                        case"ja-jp":
                            return _CultureInfo.japanCulture();
                        case"en-us":
                            return _CultureInfo.enCulture();
                        default:
                            return _CultureInfo.customCulture(cultureName)
                    }
                };
                return _CultureInfo
            })();
        Sheets._CultureInfo = _CultureInfo;
        var _StringHelper = (function()
            {
                function _StringHelper(str)
                {
                    this._str = str
                }
                _StringHelper.__toFormattedString = function(useLocale, args)
                {
                    var result = '';
                    var format = args[0];
                    for (var i = 0; ; )
                    {
                        var open = format.indexOf('{', i);
                        var close = format.indexOf('}', i);
                        if ((open < 0) && (close < 0))
                        {
                            result += format.slice(i);
                            break
                        }
                        if ((close > 0) && ((close < open) || (open < 0)))
                        {
                            if (format.charAt(close + 1) !== '}')
                            {
                                throw new Error(Sheets.SR.Exp_BraceMismatch);
                            }
                            result += format.slice(i, close + 1);
                            i = close + 2;
                            continue
                        }
                        result += format.slice(i, open);
                        i = open + 1;
                        if (format.charAt(i) === '{')
                        {
                            result += '{';
                            i++;
                            continue
                        }
                        if (close < 0)
                        {
                            throw new Error(Sheets.SR.Exp_BraceMismatch);
                        }
                        var brace = format.substring(i, close);
                        var colonIndex = brace.indexOf(':');
                        var argNumber = parseInt((colonIndex < 0) ? brace : brace.substring(0, colonIndex), 10) + 1;
                        if (isNaN(argNumber))
                        {
                            throw new Error(Sheets.SR.Exp_InvalidFormat);
                        }
                        var argFormat = (colonIndex < 0) ? '' : brace.substring(colonIndex + 1);
                        var arg = args[argNumber];
                        if (typeof(arg) === const_undefined || arg === keyword_null)
                        {
                            arg = ''
                        }
                        if (arg.toFormattedString)
                        {
                            result += arg.toFormattedString(argFormat)
                        }
                        else if (useLocale && arg.localeFormat)
                        {
                            result += arg.localeFormat(argFormat)
                        }
                        else if (arg.format)
                        {
                            result += arg.format(argFormat)
                        }
                        else
                        {
                            result += arg.toString()
                        }
                        i = close + 1
                    }
                    return result
                };
                _StringHelper.prototype.startsWith = function(prefix)
                {
                    return (this._str.substr(0, prefix.length) === prefix)
                };
                _StringHelper.prototype.endsWith = function(suffix)
                {
                    return this._str.indexOf(suffix, this._str.length - suffix.length) !== -1
                };
                _StringHelper.prototype.trim = function()
                {
                    return this._str.replace(/^\s+|\s+$/g, '')
                };
                _StringHelper.prototype.trimEnd = function()
                {
                    return this._str.replace(/\s+$/, '')
                };
                _StringHelper.prototype.trimStart = function()
                {
                    return this._str.replace(/^\s+/, '')
                };
                _StringHelper.prototype.format = function(format, args)
                {
                    var args2 = [];
                    args2.push(format);
                    for (var i = 0; i < args.length; i++)
                    {
                        args2.push(args[i])
                    }
                    return _StringHelper.__toFormattedString(false, args2)
                };
                return _StringHelper
            })();
        Sheets._StringHelper = _StringHelper;
        var StringHelper = (function()
            {
                function StringHelper(){}
                StringHelper.Contains = function(str, value)
                {
                    return value === "" || str.indexOf(value) >= 0
                };
                StringHelper.IndexOf = function(str, value, comparisonType)
                {
                    if (!comparisonType)
                    {
                        return str.indexOf(value)
                    }
                    else if (comparisonType === 1)
                    {
                        var tempStr = str.toLowerCase();
                        var tempValue = value.toLowerCase();
                        return tempStr.indexOf(tempValue)
                    }
                    else
                    {
                        return str.indexOf(value)
                    }
                };
                StringHelper.TrimStart = function(str, trimChar)
                {
                    if (!trimChar)
                    {
                        return str
                    }
                    var temp = str;
                    while (true)
                    {
                        if (temp.substr(0, trimChar.length) !== trimChar)
                        {
                            break
                        }
                        temp = temp.substr(trimChar.length)
                    }
                    return temp
                };
                StringHelper.TrimEnd = function(str, trimChar)
                {
                    if (!trimChar)
                    {
                        return str
                    }
                    var temp = str;
                    while (true)
                    {
                        if (temp.substr(temp.length - trimChar.length, trimChar.length) !== trimChar)
                        {
                            break
                        }
                        temp = temp.substr(0, temp.length - trimChar.length)
                    }
                    return temp
                };
                StringHelper.Trim = function(str, trimChar)
                {
                    var temp = trimChar;
                    if (!trimChar)
                    {
                        temp = " "
                    }
                    str = StringHelper.TrimStart(str, temp);
                    str = StringHelper.TrimEnd(str, temp);
                    return str
                };
                StringHelper.Insert = function(str, startIndex, value)
                {
                    if (startIndex < 0 || startIndex > str.length || value === keyword_null || value === keyword_undefined)
                    {
                        throw new Error;
                    }
                    var tempStrStart = str.substr(0, startIndex);
                    var tempStrEnd = str.substr(startIndex, str.length - startIndex);
                    return tempStrStart + value + tempStrEnd
                };
                StringHelper.Remove = function(str, startIndex, count)
                {
                    if (count === keyword_undefined || count === keyword_null)
                    {
                        count = str.length - startIndex
                    }
                    if (startIndex < 0 || count < 0 || startIndex + count > str.length)
                    {
                        throw new Error;
                    }
                    var valueStart = str.substr(0, startIndex);
                    var valueEnd = str.substr(startIndex + count, str.length - startIndex - count);
                    return valueStart + valueEnd
                };
                StringHelper.StartsWith = function(str, value, comparisonType)
                {
                    if (!value)
                    {
                        throw new Error;
                    }
                    if (value === "")
                    {
                        return true
                    }
                    if (value.length > str.length)
                    {
                        return false
                    }
                    var thisStr = str;
                    var valueStr = value;
                    if (comparisonType === 1)
                    {
                        thisStr = thisStr.toLowerCase();
                        valueStr = valueStr.toLowerCase()
                    }
                    return thisStr.search(new RegExp("^" + valueStr)) > -1
                };
                StringHelper.EndsWith = function(str, value, comparisonType)
                {
                    if (!value)
                    {
                        throw new Error;
                    }
                    if (value === "")
                    {
                        return true
                    }
                    if (value.length > str.length)
                    {
                        return false
                    }
                    var thisStr = str;
                    var valueStr = value;
                    if (comparisonType === 1)
                    {
                        thisStr = thisStr.toLowerCase();
                        valueStr = valueStr.toLowerCase()
                    }
                    return thisStr.search(new RegExp(valueStr + "$")) > -1
                };
                StringHelper.Replace = function(str, oldValue, newValue)
                {
                    if (!oldValue || oldValue === "")
                    {
                        throw new Error;
                    }
                    var re = new RegExp(oldValue, "g");
                    return str.replace(re, newValue)
                };
                return StringHelper
            })();
        Sheets.StringHelper = StringHelper;
        var _DateTimeHelper = (function()
            {
                function _DateTimeHelper(date)
                {
                    this._date = date
                }
                _DateTimeHelper.prototype.Hour = function()
                {
                    return this._date.getHours()
                };
                _DateTimeHelper.prototype.Minute = function()
                {
                    return this._date.getMinutes()
                };
                _DateTimeHelper.prototype.Second = function()
                {
                    return this._date.getSeconds()
                };
                _DateTimeHelper.prototype.Millisecond = function()
                {
                    return this._date.getMilliseconds()
                };
                _DateTimeHelper.prototype.TotalDays = function()
                {
                    return Math_floor(this.toOADate())
                };
                _DateTimeHelper.prototype.toOADate = function()
                {
                    return _DateTimeHelper.___toOADate(this._date)
                };
                _DateTimeHelper.prototype.format = function(format)
                {
                    return this._toFormattedString(format, _CultureInfo._currentCulture)
                };
                _DateTimeHelper.prototype.customCultureFormat = function(format, cultureInfo)
                {
                    if (!cultureInfo)
                    {
                        cultureInfo = _CultureInfo._currentCulture
                    }
                    return this._toFormattedString(format, cultureInfo)
                };
                _DateTimeHelper.prototype.localeFormat = function(format)
                {
                    return this._toFormattedString(format, _CultureInfo._currentCulture)
                };
                _DateTimeHelper.prototype._toFormattedString = function(format, cultureInfo)
                {
                    var self = this;
                    var dtf = cultureInfo.DateTimeFormat(),
                        convert = dtf.Calendar.convert;
                    if (!format || !format.length || (format === 'i'))
                    {
                        if (cultureInfo && cultureInfo.Name().length)
                        {
                            if (convert)
                            {
                                return self._toFormattedString(dtf.fullDateTimePattern, cultureInfo)
                            }
                            else
                            {
                                return self._date.toLocaleString()
                            }
                        }
                        else
                        {
                            return self._date.toString()
                        }
                    }
                    var eras = dtf.eras,
                        sortable = (format === "s");
                    format = _DateTimeHelper.__expandFormat(dtf, format);
                    var ret = "";
                    var hour;
                    var foundDay,
                        checkedDay,
                        dayPartRegExp = /([^d]|^)(d|dd)([^d]|$)/g;
                    function hasDay()
                    {
                        if (foundDay || checkedDay)
                        {
                            return foundDay
                        }
                        foundDay = dayPartRegExp.test(format);
                        checkedDay = true;
                        return foundDay
                    }
                    var quoteCount = 0,
                        tokenRegExp = _DateTimeHelper.__getTokenRegExp(),
                        converted;
                    if (!sortable && convert)
                    {
                        converted = convert.fromGregorian(self._date)
                    }
                    function getPart(date, part)
                    {
                        if (converted)
                        {
                            return converted[part]
                        }
                        switch (part)
                        {
                            case 0:
                                return date.getFullYear();
                            case 1:
                                return date.getMonth();
                            case 2:
                                return date.getDate()
                        }
                    }
                    var eraDateInfo = keyword_null;
                    var eraIndex = -2;
                    var eraYearIndex = -2;
                    var stringValue = {value: ""};
                    for (var tokenIndex = 0; ; tokenIndex++)
                    {
                        var index = tokenRegExp.lastIndex;
                        var ar = tokenRegExp.exec(format);
                        var preMatch = format.slice(index, ar ? ar.index : format.length);
                        stringValue.value = "";
                        quoteCount += _DateTimeHelper.__appendPreOrPostMatch(preMatch, stringValue);
                        ret += stringValue.value;
                        if (!ar)
                        {
                            break
                        }
                        if ((quoteCount % 2) === 1)
                        {
                            ret += (ar[0]);
                            continue
                        }
                        switch (ar[0])
                        {
                            case"dddd":
                                ret += (dtf.dayNames[self._date.getDay()]);
                                break;
                            case"ddd":
                                ret += (dtf.abbreviatedDayNames[self._date.getDay()]);
                                break;
                            case"dd":
                                foundDay = true;
                                ret += (_DateTimeHelper.___addLeadingZero(getPart(self._date, 2)));
                                break;
                            case"d":
                                foundDay = true;
                                ret += (getPart(self._date, 2));
                                break;
                            case"MMMM":
                                ret += ((dtf.monthGenitiveNames && hasDay()) ? dtf.monthGenitiveNames[getPart(self._date, 1)] : dtf.monthNames[getPart(self._date, 1)]);
                                break;
                            case"MMM":
                                ret += ((dtf.abbreviatedMonthGenitiveNames && hasDay()) ? dtf.abbreviatedMonthGenitiveNames[getPart(self._date, 1)] : dtf.abbreviatedMonthNames[getPart(self._date, 1)]);
                                break;
                            case"MM":
                                ret += (_DateTimeHelper.___addLeadingZero(getPart(self._date, 1) + 1));
                                break;
                            case"M":
                                ret += (getPart(self._date, 1) + 1);
                                break;
                            case"yyyy":
                            case"yyy":
                                if (eraIndex >= 0)
                                {
                                    ret += eras.formatEraPart("ee", self._date)
                                }
                                else
                                {
                                    ret += (_DateTimeHelper.___padYear(converted ? converted[0] : self._date.getFullYear()))
                                }
                                break;
                            case"yy":
                                if (eraIndex >= 0)
                                {
                                    ret += eras.formatEraPart("ee", self._date)
                                }
                                else
                                {
                                    ret += (_DateTimeHelper.___addLeadingZero((converted ? converted[0] : self._date.getFullYear()) % 100))
                                }
                                break;
                            case"y":
                                if (eraIndex >= 0)
                                {
                                    ret += eras.formatEraPart("e", self._date)
                                }
                                else
                                {
                                    ret += (((converted ? converted[0] : self._date.getFullYear()) % 100).toString())
                                }
                                break;
                            case"hh":
                                hour = self._date.getHours() % 12;
                                if (hour === 0)
                                {
                                    hour = 12
                                }
                                ret += (_DateTimeHelper.___addLeadingZero(hour));
                                break;
                            case"h":
                                hour = self._date.getHours() % 12;
                                if (hour === 0)
                                {
                                    hour = 12
                                }
                                ret += (hour);
                                break;
                            case"HH":
                                ret += (_DateTimeHelper.___addLeadingZero(self._date.getHours()));
                                break;
                            case"H":
                                ret += (self._date.getHours().toString());
                                break;
                            case"mm":
                                ret += (_DateTimeHelper.___addLeadingZero(self._date.getMinutes()));
                                break;
                            case"m":
                                ret += (self._date.getMinutes().toString());
                                break;
                            case"ss":
                                ret += (_DateTimeHelper.___addLeadingZero(self._date.getSeconds()));
                                break;
                            case"s":
                                ret += (self._date.getSeconds().toString());
                                break;
                            case"tt":
                                ret += ((self._date.getHours() < 12) ? dtf.amDesignator : dtf.pmDesignator);
                                break;
                            case"t":
                                ret += (((self._date.getHours() < 12) ? dtf.amDesignator : dtf.pmDesignator).charAt(0));
                                break;
                            case"f":
                                ret += (_DateTimeHelper.___addLeadingZeros(self._date.getMilliseconds()).charAt(0));
                                break;
                            case"ff":
                                ret += (_DateTimeHelper.___addLeadingZeros(self._date.getMilliseconds()).substr(0, 2));
                                break;
                            case"fff":
                                ret += (_DateTimeHelper.___addLeadingZeros(self._date.getMilliseconds()));
                                break;
                            case"z":
                                hour = self._date.getTimezoneOffset() / 60;
                                ret += (((hour <= 0) ? '+' : '-') + Math_floor(Math_abs(hour)));
                                break;
                            case"zz":
                                hour = self._date.getTimezoneOffset() / 60;
                                ret += (((hour <= 0) ? '+' : '-') + _DateTimeHelper.___addLeadingZero(Math_floor(Math_abs(hour))));
                                break;
                            case"zzz":
                                hour = self._date.getTimezoneOffset() / 60;
                                ret += (((hour <= 0) ? '+' : '-') + _DateTimeHelper.___addLeadingZero(Math_floor(Math_abs(hour))) + ":" + _DateTimeHelper.___addLeadingZero(Math_abs(self._date.getTimezoneOffset() % 60)));
                                break;
                            case"g":
                            case"gg":
                            case"ggg":
                                if (!eras)
                                {
                                    break
                                }
                                if (eraIndex === tokenIndex - 1)
                                {
                                    eraIndex = tokenIndex;
                                    break
                                }
                                else
                                {
                                    ret += eras.formatEraPart(ar[0], self._date);
                                    eraIndex = tokenIndex
                                }
                                break;
                            case"e":
                            case"ee":
                                if (!eras)
                                {
                                    ret += (_DateTimeHelper.___padYear(converted ? converted[0] : self._date.getFullYear()));
                                    break
                                }
                                else if (eraYearIndex === tokenIndex - 1)
                                {
                                    eraYearIndex = tokenIndex;
                                    break
                                }
                                else
                                {
                                    ret += eras.formatEraPart(ar[0], self._date);
                                    eraYearIndex = tokenIndex
                                }
                                break;
                            case"/":
                                ret += (dtf.dateSeparator);
                                break;
                            case"[h]":
                                ret += ("[h]");
                                break;
                            case"[hh]":
                                ret += ("[hh]");
                                break;
                            case"[mm]":
                                ret += ("[mm]");
                                break;
                            case"[ss]":
                                ret += ("[ss]");
                                break;
                            default:
                                throw new Error(Sheets.SR.Exp_InvalidDateFormat);
                        }
                    }
                    return ret.toString()
                };
                _DateTimeHelper.parseLocale = function(value, formats)
                {
                    var args;
                    if (formats)
                    {
                        args = [value, formats]
                    }
                    else
                    {
                        args = [value]
                    }
                    return _DateTimeHelper._parseDate(value, _CultureInfo._currentCulture, args)
                };
                _DateTimeHelper.parseInvariant = function(value, formats)
                {
                    return _DateTimeHelper._parseDate(value, _CultureInfo.invariantCulture(), [value, formats])
                };
                _DateTimeHelper.__appendPreOrPostMatch = function(preMatch, strBuilder)
                {
                    var quoteCount = 0;
                    var escaped = false;
                    for (var i = 0, il = preMatch.length; i < il; i++)
                    {
                        var c = preMatch.charAt(i);
                        switch (c)
                        {
                            case'\'':
                            case'\"':
                                if (escaped)
                                {
                                    strBuilder.value += "'"
                                }
                                else
                                {
                                    quoteCount++
                                }
                                escaped = false;
                                break;
                            case'\\':
                                if (escaped)
                                {
                                    strBuilder.value += "\\"
                                }
                                escaped = !escaped;
                                break;
                            default:
                                strBuilder.value += c;
                                escaped = false;
                                break
                        }
                    }
                    return quoteCount
                };
                _DateTimeHelper.__expandFormat = function(dtf, format)
                {
                    if (!format)
                    {
                        format = "F"
                    }
                    var len = format.length;
                    if (len === 1)
                    {
                        switch (format)
                        {
                            case"d":
                                return dtf.shortDatePattern;
                            case"D":
                                return dtf.longDatePattern;
                            case"t":
                                return dtf.shortTimePattern;
                            case"T":
                                return dtf.longTimePattern;
                            case"f":
                                return dtf.longDatePattern + " " + dtf.shortTimePattern;
                            case"F":
                                return dtf.fullDateTimePattern;
                            case"M":
                            case"m":
                                return dtf.monthDayPattern;
                            case"s":
                                return dtf.sortableDateTimePattern;
                            case"Y":
                            case"y":
                                return dtf.yearMonthPattern;
                            case"g":
                                return dtf.shortDatePattern + " " + dtf.shortTimePattern;
                            case"G":
                                return dtf.shortDatePattern + " " + dtf.longTimePattern;
                            case"e":
                                return format;
                            case"R":
                            case"r":
                                return dtf.rfc1123Pattern;
                            case"u":
                                return dtf.universalSortableDateTimePattern;
                            case"U":
                                return dtf.fullDateTimePattern;
                            case"o":
                            case"O":
                                return "yyyy\'-\'MM\'-\'dd\'T\'HH\':\'mm\':\'ss\'.\'fffffff";
                            default:
                                throw new Error(Sheets.SR.Exp_InvalidString);
                        }
                    }
                    else if ((len === 2) && (format.charAt(0) === "%"))
                    {
                        format = format.charAt(1)
                    }
                    return format
                };
                _DateTimeHelper.__expandYear = function(cultureInfo, year)
                {
                    var now = new Date;
                    var eras = cultureInfo.DateTimeFormat().eras;
                    if (eras && year < 100)
                    {
                        var curr = eras.getEraDate(now).eraYear;
                        year += curr - (curr % 100);
                        if (year > cultureInfo.DateTimeFormat().Calendar.TwoDigitYearMax)
                        {
                            year -= 100
                        }
                    }
                    return year
                };
                _DateTimeHelper.__getTokenRegExp = function()
                {
                    return /\/|dddd|ddd|dd|d|MMMM|MMM|MM|M|yyyy|yyy|yy|y|hh|h|HH|H|mm|m|ss|s|tt|t|fff|ff|f|zzz|zz|z|ggg|gg|g|ee|e|\[h\]|\[hh\]|\[mm\]|\[ss\]/g
                };
                _DateTimeHelper.__getParseRegExp = function(dtf, format)
                {
                    if (!dtf._parseRegExp)
                    {
                        dtf._parseRegExp = {}
                    }
                    else if (dtf._parseRegExp[format])
                    {
                        return dtf._parseRegExp[format]
                    }
                    var expFormat = _DateTimeHelper.__expandFormat(dtf, format);
                    expFormat = expFormat.replace("%M", "M");
                    expFormat = expFormat.replace(/([\^\$\.\*\+\?\|\[\]\(\)\{\}])/g, "\\\\$1");
                    var regexp = "^";
                    var stringValue = {value: ""};
                    var groups = [];
                    var index = 0;
                    var quoteCount = 0;
                    var tokenRegExp = _DateTimeHelper.__getTokenRegExp();
                    var match;
                    while ((match = tokenRegExp.exec(expFormat)) !== keyword_null)
                    {
                        stringValue.value = "";
                        var preMatch = expFormat.slice(index, match.index);
                        index = tokenRegExp.lastIndex;
                        quoteCount += _DateTimeHelper.__appendPreOrPostMatch(preMatch, stringValue);
                        regexp += stringValue.value;
                        if ((quoteCount % 2) === 1)
                        {
                            regexp += match[0];
                            continue
                        }
                        switch (match[0])
                        {
                            case'dddd':
                            case'ddd':
                            case'MMMM':
                            case'MMM':
                            case'gggg':
                            case'ggg':
                            case'gg':
                            case'g':
                                regexp += "(\\D+)";
                                break;
                            case'tt':
                            case't':
                                regexp += "(\\D*)";
                                break;
                            case'yyy':
                            case'yyyy':
                                regexp += "(\\d{4})";
                                break;
                            case'fff':
                                regexp += "(\\d{3})";
                                break;
                            case'ff':
                                regexp += "(\\d{2})";
                                break;
                            case'f':
                                regexp += "(\\d)";
                                break;
                            case'dd':
                            case'd':
                            case'MM':
                            case'M':
                            case'yy':
                            case'y':
                            case'eee':
                            case'ee':
                            case'e':
                            case'HH':
                            case'H':
                            case'hh':
                            case'h':
                            case'mm':
                            case'm':
                            case'ss':
                            case's':
                                regexp += "(\\d\\d?)";
                                break;
                            case'zzz':
                                regexp += "([+-]?\\d\\d?:\\d{2})";
                                break;
                            case'zz':
                            case'z':
                                regexp += "([+-]?\\d\\d?)";
                                break;
                            case'/':
                                regexp += "(\\" + dtf.dateSeparator + ")";
                                break;
                            default:
                                throw new Error(Sheets.SR.Exp_InvalidDateFormat);
                        }
                        Sheets.ArrayHelper.add(groups, match[0])
                    }
                    stringValue.value = "";
                    _DateTimeHelper.__appendPreOrPostMatch(expFormat.slice(index), stringValue);
                    regexp += stringValue.value;
                    regexp += "$";
                    var regexpStr = regexp.toString().replace(/\s+/g, "\\s+");
                    var parseRegExp = {
                            regExp: regexpStr, groups: groups, exp: new RegExp(regexpStr)
                        };
                    dtf._parseRegExp[format] = parseRegExp;
                    return parseRegExp
                };
                _DateTimeHelper._parseDateExact = function(value, format, cultureInfo)
                {
                    value = $.trim(value);
                    var dtf = cultureInfo.DateTimeFormat(),
                        parseInfo = _DateTimeHelper.__getParseRegExp(dtf, format),
                        match = parseInfo.exp.exec(value);
                    if (match === keyword_null)
                    {
                        return keyword_null
                    }
                    var groups = parseInfo.groups,
                        era = keyword_null,
                        year = keyword_null,
                        month = keyword_null,
                        date = keyword_null,
                        weekDay = keyword_null,
                        hour = 0,
                        hourOffset,
                        min = 0,
                        sec = 0,
                        msec = 0,
                        tzMinOffset = keyword_null,
                        pmHour = false;
                    var isTimeSpan = true;
                    for (var j = 0, jl = groups.length; j < jl; j++)
                    {
                        var matchGroup = match[j + 1];
                        if (matchGroup)
                        {
                            switch (groups[j])
                            {
                                case'dd':
                                case'd':
                                    isTimeSpan = false;
                                    date = parseInt(matchGroup, 10);
                                    if ((date < 1) || (date > 31))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'MMMM':
                                    isTimeSpan = false;
                                    month = cultureInfo._getMonthIndex(matchGroup);
                                    if ((month < 0) || (month > 11))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'MMM':
                                    isTimeSpan = false;
                                    month = cultureInfo._getAbbrMonthIndex(matchGroup);
                                    if ((month < 0) || (month > 11))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'M':
                                case'MM':
                                case'%M':
                                    isTimeSpan = false;
                                    month = parseInt(matchGroup, 10) - 1;
                                    if ((month < 0) || (month > 11))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'e':
                                case'ee':
                                    isTimeSpan = false;
                                    year = _DateTimeHelper.__expandYear(cultureInfo, parseInt(matchGroup, 10));
                                    if ((year < 0) || (year > 9999))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'y':
                                case'yy':
                                case'yyy':
                                case'yyyy':
                                    isTimeSpan = false;
                                    year = parseInt(matchGroup, 10);
                                    if ((year < 0) || (year > 9999))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'h':
                                case'hh':
                                case'H':
                                case'HH':
                                    hour = parseInt(matchGroup, 10);
                                    if ((hour < 0) || (hour > 23))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'm':
                                case'mm':
                                    min = parseInt(matchGroup, 10);
                                    if ((min < 0) || (min > 59))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case's':
                                case'ss':
                                    sec = parseInt(matchGroup, 10);
                                    if ((sec < 0) || (sec > 59))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'tt':
                                case't':
                                    var upperToken = matchGroup.toUpperCase();
                                    pmHour = (upperToken === dtf.pmDesignator.toUpperCase());
                                    if (!pmHour && (upperToken !== dtf.amDesignator.toUpperCase()))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'f':
                                    msec = parseInt(matchGroup, 10) * 100;
                                    if ((msec < 0) || (msec > 999))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'ff':
                                    msec = parseInt(matchGroup, 10) * 10;
                                    if ((msec < 0) || (msec > 999))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'fff':
                                    msec = parseInt(matchGroup, 10);
                                    if ((msec < 0) || (msec > 999))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'dddd':
                                    isTimeSpan = false;
                                    weekDay = cultureInfo._getDayIndex(matchGroup);
                                    if ((weekDay < 0) || (weekDay > 6))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'ddd':
                                    isTimeSpan = false;
                                    weekDay = cultureInfo._getAbbrDayIndex(matchGroup);
                                    if ((weekDay < 0) || (weekDay > 6))
                                    {
                                        return keyword_null
                                    }
                                    break;
                                case'zzz':
                                    var offsets = matchGroup.split(/:/);
                                    if (offsets.length !== 2)
                                    {
                                        return keyword_null
                                    }
                                    hourOffset = parseInt(offsets[0], 10);
                                    if ((hourOffset < -12) || (hourOffset > 13))
                                    {
                                        return keyword_null
                                    }
                                    var minOffset = parseInt(offsets[1], 10);
                                    if ((minOffset < 0) || (minOffset > 59))
                                    {
                                        return keyword_null
                                    }
                                    tzMinOffset = (hourOffset * 60) + (new _StringHelper(matchGroup).startsWith('-') ? -minOffset : minOffset);
                                    break;
                                case'z':
                                case'zz':
                                    hourOffset = parseInt(matchGroup, 10);
                                    if ((hourOffset < -12) || (hourOffset > 13))
                                    {
                                        return keyword_null
                                    }
                                    tzMinOffset = hourOffset * 60;
                                    break;
                                case'g':
                                case'gg':
                                case"ggg":
                                    var eraName = matchGroup;
                                    if (!eraName || !dtf.eras)
                                    {
                                        return keyword_null
                                    }
                                    era = dtf.eras.parseEraPart(groups[j], eraName);
                                    if (era < 0)
                                    {
                                        return keyword_null
                                    }
                                    break
                            }
                        }
                    }
                    var result = new Date(1899, 11, 30),
                        defaults,
                        convert = dtf.Calendar.convert;
                    if (convert)
                    {
                        defaults = convert.fromGregorian(result)
                    }
                    if (!convert)
                    {
                        defaults = [result.getFullYear(), result.getMonth(), result.getDate()]
                    }
                    if (year === keyword_null)
                    {
                        year = defaults[0]
                    }
                    else if (year < 100)
                    {
                        if (dtf.eras)
                        {
                            year = dtf.eras.getYearFromEra(era || 0, year)
                        }
                        else
                        {
                            if (year >= 30)
                            {
                                year += 1900
                            }
                            else
                            {
                                year += 2000
                            }
                        }
                    }
                    if (month === keyword_null)
                    {
                        month = defaults[1]
                    }
                    if (date === keyword_null)
                    {
                        date = defaults[2]
                    }
                    if (convert)
                    {
                        result = convert.toGregorian(year, month, date);
                        if (result === keyword_null)
                        {
                            return keyword_null
                        }
                    }
                    else
                    {
                        result.setFullYear(year, month, date);
                        if (result.getDate() !== date)
                        {
                            return keyword_null
                        }
                        if ((weekDay !== keyword_null) && (result.getDay() !== weekDay))
                        {
                            return keyword_null
                        }
                    }
                    if (pmHour && (hour < 12))
                    {
                        hour += 12
                    }
                    result.setHours(hour, min, sec, msec);
                    if (tzMinOffset !== keyword_null)
                    {
                        var adjustedMin = result.getMinutes() - (tzMinOffset + result.getTimezoneOffset());
                        result.setHours(result.getHours() + adjustedMin / 60, adjustedMin % 60)
                    }
                    return result
                };
                _DateTimeHelper.___addLeadingZero = function(num)
                {
                    return num < 10 ? ('0' + num) : num.toString()
                };
                _DateTimeHelper.___addLeadingZeros = function(num)
                {
                    return num < 10 ? ('00' + num) : (num < 100 ? ('0' + num) : num.toString())
                };
                _DateTimeHelper.___padYear = function(year)
                {
                    return year < 10 ? ('000' + year) : (year < 100 ? ('00' + year) : (year < 1000 ? ('0' + year) : year.toString()))
                };
                _DateTimeHelper._parseDate = function(value, cultureInfo, args)
                {
                    var i,
                        l,
                        date,
                        format,
                        formats,
                        custom = false;
                    for (i = 1, l = args.length; i < l; i++)
                    {
                        format = args[i];
                        if (format)
                        {
                            custom = true;
                            date = _DateTimeHelper._parseDateExact(value, format, cultureInfo);
                            if (date)
                            {
                                return date
                            }
                        }
                    }
                    if (!custom)
                    {
                        formats = cultureInfo._getDateTimeFormats();
                        for (i = 0, l = formats.length; i < l; i++)
                        {
                            date = _DateTimeHelper._parseDateExact(value, formats[i], cultureInfo);
                            if (date)
                            {
                                return date
                            }
                        }
                    }
                    return keyword_null
                };
                _DateTimeHelper.___toOADate = function(date)
                {
                    if (date === keyword_undefined || date === keyword_null)
                    {
                        return 0
                    }
                    if (typeof date === "number")
                    {
                        date = new Date(date)
                    }
                    return (date.getTime() * 1440 + 25569 * 86400000 * 1440 - date.getTimezoneOffset() * 86400000) / (86400000 * 1440)
                };
                _DateTimeHelper._fromOADate = function(oadate)
                {
                    var offsetDay = oadate - 25569;
                    var date = new Date(offsetDay * 86400000);
                    var adjustValue = offsetDay >= 0 ? 1 : -1;
                    return new Date((oadate * 86400000 * 1440 + adjustValue - 25569 * 86400000 * 1440 + date.getTimezoneOffset() * 86400000) / 1440)
                };
                _DateTimeHelper.parseExact = _DateTimeHelper._parseDateExact;
                _DateTimeHelper.fromOADate = _DateTimeHelper._fromOADate;
                return _DateTimeHelper
            })();
        Sheets._DateTimeHelper = _DateTimeHelper;
        var parsedFormat = (function()
            {
                function parsedFormat(normal, negative, zero)
                {
                    this.normal = normal;
                    this.negative = negative;
                    this.zero = zero
                }
                return parsedFormat
            })();
        var parsedFormatPart = (function()
            {
                function parsedFormatPart()
                {
                    var self = this;
                    self.intPart = keyword_null;
                    self.decPart = keyword_null;
                    self.group = false;
                    self.scale = 0;
                    self.percent = 0;
                    self.permile = 0;
                    self.exponent = keyword_null
                }
                return parsedFormatPart
            })();
        var _NumberHelper = (function()
            {
                function _NumberHelper(num)
                {
                    this._num = num
                }
                _NumberHelper.prototype.format = function(format)
                {
                    return this._toFormattedString(format, _CultureInfo.invariantCulture())
                };
                _NumberHelper.prototype.localeFormat = function(format)
                {
                    return this._toFormattedString(format, _CultureInfo._currentCulture)
                };
                _NumberHelper.prototype.customCultureFormat = function(format, cultureInfo)
                {
                    if (!cultureInfo)
                    {
                        cultureInfo = _CultureInfo._currentCulture
                    }
                    return this._toFormattedString(format, cultureInfo)
                };
                _NumberHelper.prototype._toFormattedString = function(format, cultureInfo)
                {
                    var self = this;
                    if (!format || (format.length === 0) || (format === 'i'))
                    {
                        if (cultureInfo && (cultureInfo.Name().length > 0))
                        {
                            return self._num.toLocaleString()
                        }
                        else
                        {
                            return self._num.toString()
                        }
                    }
                    if (_NumberHelper.__getStandardTokenRegExp().test(format))
                    {
                        return self._toStandardFormattedString(format, cultureInfo.NumberFormat())
                    }
                    else
                    {
                        return self._toCustomFormattedString(format, cultureInfo.NumberFormat())
                    }
                };
                _NumberHelper.prototype._toStandardFormattedString = function(format, nf)
                {
                    var self = this;
                    var num = Math_abs(self._num).toString();
                    if (!format)
                    {
                        format = "D"
                    }
                    var precision = -1;
                    if (format.length > 1)
                    {
                        precision = parseInt(format.slice(1), 10)
                    }
                    var pattern,
                        resultArray;
                    switch (format.charAt(0))
                    {
                        case"d":
                        case"D":
                            pattern = 'n';
                            if (precision !== -1)
                            {
                                num = _NumberHelper.___zeroPad("" + num, precision, true)
                            }
                            if (self._num < 0)
                            {
                                num = "-" + num
                            }
                            break;
                        case"c":
                        case"C":
                            if (self._num < 0)
                            {
                                pattern = _NumberHelper.___currencyNegativePattern[nf.currencyNegativePattern]
                            }
                            else
                            {
                                pattern = _NumberHelper.___currencyPositivePattern[nf.currencyPositivePattern]
                            }
                            if (precision === -1)
                            {
                                precision = nf.currencyDecimalDigits
                            }
                            num = _NumberHelper.___expandNumber(Math_abs(self._num), precision, nf.currencyGroupSizes, nf.currencyGroupSeparator, nf.currencyDecimalSeparator, nf.negativeSign);
                            break;
                        case"n":
                        case"N":
                            if (self._num < 0)
                            {
                                pattern = _NumberHelper.___numberNegativePattern[nf.numberNegativePattern]
                            }
                            else
                            {
                                pattern = 'n'
                            }
                            if (precision === -1)
                            {
                                precision = nf.numberDecimalDigits
                            }
                            num = _NumberHelper.___expandNumber(Math_abs(self._num), precision, nf.numberGroupSizes, ',', '.', nf.negativeSign);
                            break;
                        case"p":
                        case"P":
                            if (self._num < 0)
                            {
                                pattern = _NumberHelper.___percentNegativePattern[nf.percentNegativePattern]
                            }
                            else
                            {
                                pattern = _NumberHelper.___percentPositivePattern[nf.percentPositivePattern]
                            }
                            if (precision === -1)
                            {
                                precision = nf.percentDecimalDigits
                            }
                            num = _NumberHelper.___expandNumber(Math_abs(self._num) * 100, precision, nf.percentGroupSizes, nf.percentGroupSeparator, nf.percentDecimalSeparator, nf.negativeSign);
                            break;
                        case"F":
                        case"f":
                            resultArray = self._toFixedPoint(num, pattern, format, precision, nf);
                            num = resultArray[0];
                            pattern = resultArray[1];
                            break;
                        case"e":
                        case"E":
                            resultArray = self._toScientificNotation(num, pattern, format, precision, nf);
                            num = resultArray[0];
                            pattern = resultArray[1];
                            break;
                        case"x":
                        case"X":
                            pattern = "n";
                            num = _NumberHelper.___toHexString(self._num, format.charAt(0) === 'x', precision === -1 ? 0 : precision);
                            break;
                        case"g":
                        case"G":
                            var numToStr = self._num.toString();
                            resultArray = [];
                            if ((numToStr.indexOf("e")) === -1 && (numToStr.indexOf("E") === -1))
                            {
                                resultArray = self._toFixedPoint(num, pattern, format, precision, nf)
                            }
                            else
                            {
                                resultArray = self._toScientificNotation(num, pattern, format.replace("g", "e").replace("G", "E"), precision, nf)
                            }
                            num = resultArray[0];
                            pattern = resultArray[1];
                            break;
                        default:
                            throw new Error(Sheets.SR.Exp_BadFormatSpecifier);
                    }
                    var regex = /n|\$|-|%/g;
                    var ret = "";
                    for (; ; )
                    {
                        var index = regex.lastIndex;
                        var ar = regex.exec(pattern);
                        ret += pattern.slice(index, ar ? ar.index : pattern.length);
                        if (!ar)
                        {
                            break
                        }
                        switch (ar[0])
                        {
                            case"n":
                                ret += num;
                                break;
                            case"$":
                                ret += nf.currencySymbol;
                                break;
                            case"-":
                                if (/[1-9]/.test(num))
                                {
                                    ret += nf.negativeSign
                                }
                                break;
                            case"%":
                                ret += nf.percentSymbol;
                                break;
                            default:
                                throw new Error(Sheets.SR.Exp_InvalidNumberFormat);
                        }
                    }
                    return ret
                };
                _NumberHelper.prototype._toScientificNotation = function(num, pattern, format, precision, nf)
                {
                    pattern = "n";
                    num = _NumberHelper.___toScientific(Math_abs(this._num), format.charAt(0), precision === -1 ? 6 : precision, nf.numberGroupSizes, ',', '.', nf.negativeSign);
                    if (this._num < 0)
                    {
                        num = "-" + num
                    }
                    return [num, pattern]
                };
                _NumberHelper.prototype._toFixedPoint = function(num, pattern, format, precision, nf)
                {
                    if (this._num < 0)
                    {
                        pattern = _NumberHelper.___numberNegativePattern[nf.numberNegativePattern]
                    }
                    else
                    {
                        pattern = 'n'
                    }
                    if (precision === -1)
                    {
                        precision = 2
                    }
                    var numberValue = parseFloat(num);
                    var integer = Math_floor(numberValue);
                    var dec = numberValue - integer;
                    num = _NumberHelper.___expandNumber(dec, precision, nf.numberGroupSizes, ',', '.', nf.negativeSign);
                    num = "" + integer + num.substring(1);
                    return [num, pattern]
                };
                _NumberHelper.prototype._toCustomFormattedString = function(format, nf)
                {
                    var parsedFormat = _NumberHelper.___parseCustomNumberFormatter(format);
                    var formatter = keyword_null;
                    if (this._num === 0)
                    {
                        formatter = parsedFormat.zero
                    }
                    else if (this._num < 0)
                    {
                        formatter = parsedFormat.negative
                    }
                    if (!formatter)
                    {
                        formatter = parsedFormat.normal
                    }
                    var result = _NumberHelper.___formatNumber(this._num, formatter, nf) + "";
                    if ((result.indexOf(nf.negativeSign) === 1) && (result.indexOf(nf.currencySymbol) === 0))
                    {
                        result = result[1] + result[0] + result.substring(2)
                    }
                    return result
                };
                _NumberHelper.parseLocale = function(value)
                {
                    return _NumberHelper.__parseNumber(value, _CultureInfo._currentCulture)
                };
                _NumberHelper.parseInvariant = function(value)
                {
                    return _NumberHelper.__parseNumber(value, _CultureInfo.invariantCulture())
                };
                _NumberHelper.__getStandardTokenRegExp = function()
                {
                    return /^(C|c|D|d|E|e|F|f|G|g|N|n|P|p|R|r|X|x)(\d*)$/g
                };
                _NumberHelper.___getDigitLength = function(value, separator)
                {
                    var ip = Math_floor(Math_abs(value));
                    var digit = {
                            integer: 1, decimal: 0
                        };
                    while (ip >= 10)
                    {
                        ip = ip / 10;
                        digit.integer++
                    }
                    var valueStr = value.toString();
                    var exponentIndex = valueStr.search(/e/ig);
                    var pointIndex = valueStr.indexOf(separator);
                    var length;
                    if (exponentIndex !== -1)
                    {
                        var numPart = valueStr.substr(0, exponentIndex);
                        var expPart = valueStr.substr(exponentIndex + 1);
                        var decimalPartLength = 0;
                        if (pointIndex !== -1)
                        {
                            decimalPartLength = numPart.substr(pointIndex + 1).length
                        }
                        var expValue = parseFloat(expPart);
                        length = decimalPartLength - expValue;
                        if (length < 0)
                        {
                            length = 0
                        }
                        digit.decimal = length
                    }
                    else
                    {
                        length = 0;
                        if (pointIndex !== -1)
                        {
                            length = valueStr.substr(pointIndex + 1).length
                        }
                        digit.decimal = length
                    }
                    return digit
                };
                _NumberHelper.___parseExponentFormat = function(format)
                {
                    var exponent = {
                            symbol: format.charAt(0), sign: 0, exp: 0
                        };
                    var ss = '';
                    for (var si = 1; si < format.length; si++)
                    {
                        ss = format.charAt(si);
                        if (ss === '+')
                        {
                            exponent.sign = 1
                        }
                        else if (ss === '-')
                        {
                            exponent.sign = -1
                        }
                        else if (ss === '0')
                        {
                            exponent.exp = format.length - si;
                            break
                        }
                        else
                        {
                            throw new Error(Sheets.SR.Exp_InvalidExponentFormat);
                        }
                    }
                    return exponent
                };
                _NumberHelper.___parseCustomNumberFormatter = function(format)
                {
                    var partNormal = keyword_null,
                        partNegative = keyword_null,
                        partZero = keyword_null;
                    var partCurr = new parsedFormatPart;
                    var strBuf = '',
                        insqStr = false,
                        indqStr = false,
                        inESC = false,
                        inSci = false,
                        decPointFound = false,
                        groupSepFound = false,
                        sciFound = false,
                        intPlaceHoldFound = false;
                    var curChar = keyword_null,
                        prevChar = keyword_null,
                        curPart = [];
                    for (var i = 0; i < format.length; i++)
                    {
                        curChar = format.charAt(i);
                        if (insqStr)
                        {
                            if (curChar !== '\'')
                            {
                                strBuf += curChar
                            }
                            else
                            {
                                curPart.push(strBuf);
                                strBuf = '';
                                insqStr = false
                            }
                            prevChar = curChar;
                            continue
                        }
                        else if (indqStr)
                        {
                            if (curChar !== '"')
                            {
                                strBuf += curChar
                            }
                            else
                            {
                                curPart.push(strBuf);
                                strBuf = '';
                                indqStr = false
                            }
                            prevChar = curChar;
                            continue
                        }
                        else if (inESC)
                        {
                            curPart.push(strBuf + curChar);
                            strBuf = '';
                            prevChar = curChar;
                            continue
                        }
                        else if (inSci)
                        {
                            if (prevChar === 'E' || prevChar === 'e')
                            {
                                if (curChar === '+' || curChar === '-' || curChar === '0')
                                {
                                    strBuf += curChar;
                                    continue
                                }
                                else
                                {
                                    inSci = false
                                }
                            }
                            else if (prevChar === '+' || prevChar === '-')
                            {
                                if (curChar === '0')
                                {
                                    strBuf += curChar;
                                    continue
                                }
                                else
                                {
                                    inSci = false;
                                    curPart.push(strBuf);
                                    strBuf = ''
                                }
                            }
                            else if (prevChar === '0')
                            {
                                if (curChar === '0')
                                {
                                    strBuf += curChar;
                                    continue
                                }
                                else
                                {
                                    inSci = false;
                                    if (!sciFound)
                                    {
                                        sciFound = true;
                                        partCurr.exponent = _NumberHelper.___parseExponentFormat(strBuf)
                                    }
                                    curPart.push(strBuf);
                                    strBuf = ''
                                }
                            }
                        }
                        else if ((curChar === '0' || curChar === '#'))
                        {
                            intPlaceHoldFound = true;
                            if (prevChar === '0' || prevChar === '#')
                            {
                                strBuf += curChar;
                                prevChar = curChar;
                                continue
                            }
                            else if (strBuf !== '')
                            {
                                curPart.push(strBuf);
                                strBuf = ''
                            }
                        }
                        else if ((prevChar === '0' || prevChar === '#') && curChar !== '0' && curChar !== '#')
                        {
                            curPart.push(strBuf);
                            strBuf = ''
                        }
                        if (curChar === ';')
                        {
                            if (strBuf !== '')
                            {
                                if (inSci && !sciFound)
                                {
                                    partCurr.exponent = _NumberHelper.___parseExponentFormat(strBuf)
                                }
                                curPart.push(strBuf);
                                strBuf = ''
                            }
                            if (!decPointFound)
                            {
                                partCurr.intPart = curPart
                            }
                            else
                            {
                                partCurr.decPart = curChar
                            }
                            curPart = [];
                            if (partNormal === keyword_undefined || partNormal === keyword_null)
                            {
                                partNormal = partCurr
                            }
                            else if (partNegative === keyword_undefined || partNegative === keyword_null)
                            {
                                partNegative = partCurr
                            }
                            else if (partZero === keyword_undefined || partZero === keyword_null)
                            {
                                partZero = partCurr
                            }
                            else
                            {
                                throw new Error(Sheets.SR.Exp_InvalidSemicolons);
                            }
                            decPointFound = false;
                            intPlaceHoldFound = false;
                            if (groupSepFound)
                            {
                                partCurr.group = true;
                                groupSepFound = false
                            }
                            partCurr = new parsedFormatPart
                        }
                        else if (!decPointFound && curChar === '.')
                        {
                            if (prevChar !== '#' && prevChar !== '0')
                            {
                                curPart.push(strBuf);
                                strBuf = '#'
                            }
                            if (strBuf !== '')
                            {
                                curPart.push(strBuf);
                                strBuf = ''
                            }
                            partCurr.intPart = curPart;
                            curPart = [];
                            decPointFound = true;
                            intPlaceHoldFound = false;
                            if (groupSepFound)
                            {
                                partCurr.group = true;
                                groupSepFound = false
                            }
                        }
                        else if (curChar === '\'')
                        {
                            insqStr = true
                        }
                        else if (curChar === '"')
                        {
                            indqStr = true
                        }
                        else if (curChar === '%')
                        {
                            partCurr.percent++;
                            curPart.push(curChar)
                        }
                        else if (curChar === Sheets.CR.perMilleSymbol)
                        {
                            partCurr.permile++;
                            curPart.push(curChar)
                        }
                        else if (curChar === '0' || curChar === '#')
                        {
                            strBuf += curChar
                        }
                        else if (curChar === ',')
                        {
                            if (!decPointFound)
                            {
                                if (strBuf !== '')
                                {
                                    curPart.push(strBuf);
                                    strBuf = ''
                                }
                                if (!intPlaceHoldFound)
                                {
                                    continue
                                }
                                var isScale = true,
                                    strQuote = '';
                                for (var j = i + 1; j < format.length; j++)
                                {
                                    var nextChar = format.charAt(j);
                                    if (strQuote !== '')
                                    {
                                        if (nextChar === '\'' || nextChar === '"')
                                        {
                                            strQuote = ''
                                        }
                                        continue
                                    }
                                    if (nextChar === '\'' || nextChar === '"')
                                    {
                                        strQuote = nextChar
                                    }
                                    else if (nextChar === '0' || nextChar === '#')
                                    {
                                        isScale = false;
                                        break
                                    }
                                    else if (nextChar === '.' || nextChar === ';')
                                    {
                                        break
                                    }
                                }
                                if (isScale)
                                {
                                    partCurr.scale++
                                }
                                else
                                {
                                    groupSepFound = true
                                }
                            }
                            else
                            {
                                if (strBuf !== '')
                                {
                                    curPart.push(strBuf);
                                    strBuf = ''
                                }
                            }
                        }
                        else if (curChar === 'E' || curChar === 'e')
                        {
                            inSci = true;
                            if (strBuf !== '')
                            {
                                curPart.push(strBuf)
                            }
                            strBuf = curChar
                        }
                        else
                        {
                            strBuf += curChar
                        }
                        prevChar = curChar
                    }
                    if (strBuf !== '')
                    {
                        if (inSci && !sciFound)
                        {
                            partCurr.exponent = _NumberHelper.___parseExponentFormat(strBuf)
                        }
                        curPart.push(strBuf)
                    }
                    if (groupSepFound)
                    {
                        partCurr.group = true
                    }
                    if (!decPointFound)
                    {
                        partCurr.intPart = curPart
                    }
                    else
                    {
                        partCurr.decPart = curPart
                    }
                    if (partNormal === keyword_undefined || partNormal === keyword_null)
                    {
                        partNormal = partCurr
                    }
                    else if (partNegative === keyword_undefined || partNegative === keyword_null)
                    {
                        partNegative = partCurr
                    }
                    else if (partZero === keyword_undefined || partZero === keyword_null)
                    {
                        partZero = partCurr
                    }
                    return new parsedFormat(partNormal, partNegative, partZero)
                };
                _NumberHelper.___zeroPad = function(str, count, left)
                {
                    for (var l = str.length; l < count; l++)
                    {
                        str = (left ? ('0' + str) : (str + '0'))
                    }
                    return str
                };
                _NumberHelper.__insertGroupSeparator = function(numberString, groupSizes, sep, negativeSign)
                {
                    var curSize = groupSizes[0];
                    var curGroupIndex = 1;
                    var stringIndex = numberString.length - 1;
                    var stringBuilder = new _StringBuilder("");
                    var numberCount = 0;
                    var needSep = false;
                    while (stringIndex >= 0)
                    {
                        if (curSize < 1 || curSize > 9)
                        {
                            throw new Error(Sheets.SR.Exp_InvalidNumberGroupSize);
                        }
                        if (/\d/ig.test(numberString[stringIndex]))
                        {
                            if (needSep)
                            {
                                stringBuilder.insert(sep, 0);
                                needSep = false
                            }
                            numberCount++
                        }
                        else
                        {
                            numberCount = 0
                        }
                        stringBuilder.insert(numberString[stringIndex], 0);
                        if (numberCount === curSize)
                        {
                            needSep = true;
                            numberCount = 0;
                            if (curGroupIndex < groupSizes.length)
                            {
                                curSize = groupSizes[curGroupIndex];
                                curGroupIndex++
                            }
                        }
                        stringIndex--
                    }
                    return stringBuilder.toString()
                };
                _NumberHelper.___expandNumber = function(num, precision, groupSizes, sep, decimalChar, negativeSign, noGroupSep)
                {
                    var factor = Math_pow(10, precision);
                    var rounded = (Math_round(num * factor) / factor);
                    if (!isFinite(rounded))
                    {
                        rounded = num
                    }
                    num = rounded;
                    var numberString = num.toString();
                    var right;
                    var exponent;
                    var split = numberString.split(/e/i);
                    numberString = split[0];
                    exponent = (split.length > 1 ? parseInt(split[1], 10) : 0);
                    split = numberString.split('.');
                    numberString = split[0];
                    right = split.length > 1 ? split[1] : "";
                    if (exponent > 0)
                    {
                        right = _NumberHelper.___zeroPad(right, exponent, false);
                        numberString += right.slice(0, exponent);
                        right = right.substr(exponent)
                    }
                    else if (exponent < 0)
                    {
                        exponent = -exponent;
                        if (num < 0)
                        {
                            numberString = negativeSign + _NumberHelper.___zeroPad(numberString.replace(negativeSign, ""), exponent + 1, true)
                        }
                        else
                        {
                            numberString = _NumberHelper.___zeroPad(numberString, exponent + 1, true)
                        }
                        right = numberString.slice(-exponent, numberString.length) + right;
                        numberString = numberString.slice(0, -exponent)
                    }
                    if (precision > 0)
                    {
                        if (right.length > precision)
                        {
                            right = right.slice(0, precision)
                        }
                        else
                        {
                            right = _NumberHelper.___zeroPad(right, precision, false)
                        }
                        right = decimalChar + right
                    }
                    else
                    {
                        right = ""
                    }
                    if (noGroupSep === true)
                    {
                        return numberString + right
                    }
                    else
                    {
                        return _NumberHelper.__insertGroupSeparator(numberString, groupSizes, sep, negativeSign) + right
                    }
                };
                _NumberHelper.___formatNumber = function(value, formatter, nf)
                {
                    var resultBuilder = new _StringBuilder('');
                    value = value * (Math_pow(100, formatter.percent));
                    value = value * (Math_pow(1000, formatter.permile));
                    value = value / (Math_pow(10, formatter.scale * 3));
                    var intPart = formatter.intPart,
                        decPart = formatter.decPart;
                    if (!intPart && !decPart)
                    {
                        return ''
                    }
                    var partIntFormatter = keyword_null,
                        partDecFormatter = keyword_null;
                    var i,
                        ip,
                        d,
                        dp,
                        exp;
                    if (intPart)
                    {
                        partIntFormatter = '';
                        for (i = 0; i < intPart.length; i++)
                        {
                            ip = intPart[i];
                            if (/^(0|#)+/g.test(ip))
                            {
                                partIntFormatter += ip
                            }
                        }
                    }
                    if (decPart)
                    {
                        partDecFormatter = '';
                        for (d = 0; d < decPart.length; d++)
                        {
                            dp = decPart[d];
                            if (/^(0|#)+/g.test(dp))
                            {
                                partDecFormatter += dp
                            }
                        }
                    }
                    if (!partIntFormatter && !partDecFormatter)
                    {
                        return (intPart ? intPart.join('') : '') + (decPart ? decPart.join('') : '')
                    }
                    else
                    {
                        if (!partDecFormatter)
                        {
                            partDecFormatter = ''
                        }
                    }
                    var exponentValue = 0;
                    var dl = _NumberHelper.___getDigitLength(value, '.');
                    if (formatter.exponent)
                    {
                        var aValue = Math_abs(value);
                        var intLen = (!partIntFormatter) ? 1 : partIntFormatter.length;
                        if (aValue >= 1)
                        {
                            if (dl.integer > intLen)
                            {
                                dl.integer -= intLen;
                                dl.decimal += intLen;
                                value = value / Math_pow(10, dl.integer);
                                exponentValue = dl.integer
                            }
                            else if (dl.integer < intLen)
                            {
                                exponentValue = 0
                            }
                            else
                            {
                                exponentValue = 0
                            }
                            if (formatter.exponent.sign === -1)
                            {
                                formatter.exponent.sign = 0
                            }
                        }
                        else if (aValue < 1 && aValue > 0)
                        {
                            formatter.exponent.sign = -1;
                            dl.integer = intLen;
                            dl.decimal -= intLen;
                            var baseVal = Math_pow(10, intLen);
                            while (aValue * 10 < baseVal)
                            {
                                aValue *= 10;
                                exponentValue++
                            }
                            value *= Math_pow(10, exponentValue)
                        }
                    }
                    var zerophIndex = partDecFormatter.lastIndexOf('0');
                    var digitphIndex = partDecFormatter.lastIndexOf('#');
                    var precision = dl.decimal;
                    if (zerophIndex >= 0)
                    {
                        precision = zerophIndex + 1
                    }
                    if (digitphIndex > zerophIndex && digitphIndex < dl.decimal)
                    {
                        precision = digitphIndex + 1
                    }
                    if (!decPart)
                    {
                        precision = 0
                    }
                    var numbers = _NumberHelper.___expandNumber(value, precision, nf.numberGroupSizes, ',', '.', nf.negativeSign, true);
                    if (numbers === '')
                    {
                        return (intPart ? intPart.join('') : '') + (decPart ? decPart.join('') : '')
                    }
                    var replaceExponent = false;
                    if (intPart)
                    {
                        var numberIntPart = numbers.split('.')[0];
                        var neg = numberIntPart.substr(0, 1);
                        if (neg === nf.negativeSign)
                        {
                            numberIntPart = numberIntPart.substr(1)
                        }
                        var procDigitLen = 0,
                            procIntPart = '';
                        var firstZerophIndex = partIntFormatter.indexOf('0');
                        var intDigLen = (firstZerophIndex === -1) ? numberIntPart.length : (partIntFormatter.length - firstZerophIndex);
                        for (i = intPart.length - 1; i >= 0; i--)
                        {
                            ip = intPart[i];
                            if (/^(0|#)+/g.test(ip))
                            {
                                procIntPart = ip + procIntPart;
                                if (procIntPart !== partIntFormatter)
                                {
                                    var iplen = ip.length;
                                    for (var ipi = numberIntPart.length - procDigitLen - 1; ipi >= 0 && iplen > 0; ipi--)
                                    {
                                        var nc = numberIntPart.charAt(ipi);
                                        resultBuilder._insert(nc);
                                        iplen--;
                                        procDigitLen++
                                    }
                                    if (procDigitLen >= numberIntPart.length && procDigitLen < intDigLen && iplen > 0)
                                    {
                                        resultBuilder._insert(new Array(iplen + 1).join('0'));
                                        procDigitLen += iplen
                                    }
                                }
                                else
                                {
                                    var part = numberIntPart.substr(0, numberIntPart.length - procDigitLen);
                                    if (firstZerophIndex >= 0 && firstZerophIndex < partIntFormatter.length - procDigitLen - part.length)
                                    {
                                        part = new Array(partIntFormatter.length - procDigitLen - firstZerophIndex - part.length + 1).join('0') + part
                                    }
                                    resultBuilder._insert(part)
                                }
                            }
                            else if (formatter.exponent && !replaceExponent && /^((E(\+|-)?|e(\+|-)?)\d+)/g.test(ip))
                            {
                                replaceExponent = true;
                                exp = '';
                                exp += formatter.exponent.symbol;
                                exp += _NumberHelper.___signs[formatter.exponent.sign];
                                exp += _NumberHelper.___zeroPad(exponentValue.toString(), formatter.exponent.exp, true);
                                resultBuilder._insert(exp)
                            }
                            else
                            {
                                resultBuilder._insert(ip)
                            }
                        }
                        if (neg === nf.negativeSign)
                        {
                            resultBuilder._insert(neg)
                        }
                        if (formatter.group === true)
                        {
                            var str = _NumberHelper.__insertGroupSeparator(resultBuilder.toString(), nf.numberGroupSizes, ',', nf.negativeSign);
                            resultBuilder = new _StringBuilder(str)
                        }
                    }
                    if (decPart)
                    {
                        var numberDecPart = '';
                        if (precision > 0)
                        {
                            var decSepIndex = numbers.indexOf('.');
                            if (decSepIndex !== -1)
                            {
                                numberDecPart = numbers.substring(decSepIndex + 1);
                                if (partIntFormatter === '')
                                {
                                    resultBuilder.append(numbers.substr(0, decSepIndex))
                                }
                                resultBuilder.append('.')
                            }
                        }
                        else if (!/^(#+)$/ig.test(partDecFormatter) || decPart.join('').length !== partDecFormatter.length)
                        {
                            if (zerophIndex <= 0 && numbers.indexOf('.') < 0 && partIntFormatter === _NumberHelper.GeneralNumberInt && partDecFormatter === _NumberHelper.GeneralNumberDec)
                            {}
                            else
                            {
                                resultBuilder.append('.')
                            }
                            if (zerophIndex > 0)
                            {
                                numberDecPart = new Array(zerophIndex + 1).join('0')
                            }
                        }
                        var numDecIndex = 0;
                        for (d = 0; d < decPart.length; d++)
                        {
                            dp = decPart[d];
                            if (/^(0|#)+/g.test(dp))
                            {
                                resultBuilder.append(numberDecPart.substr(numDecIndex, dp.length));
                                numDecIndex += dp.length
                            }
                            else if (formatter.exponent && !replaceExponent && /^((E(\+|-)?|e(\+|-)?)\d+)/g.test(dp))
                            {
                                replaceExponent = true;
                                exp = '';
                                exp += formatter.exponent.symbol;
                                exp += _NumberHelper.___signs[formatter.exponent.sign];
                                exp += _NumberHelper.___zeroPad(exponentValue.toString(), formatter.exponent.exp, true);
                                resultBuilder.append(exp)
                            }
                            else
                            {
                                resultBuilder.append(dp)
                            }
                        }
                    }
                    var resultString = resultBuilder.toString();
                    var zeroDotIndex = resultString.indexOf("0.");
                    if (zeroDotIndex >= 0)
                    {
                        if (zeroDotIndex + 2 == resultString.length)
                        {
                            resultString = resultString.replace("0.", ".")
                        }
                        else if (zeroDotIndex + 2 < resultString.length)
                        {
                            if (!/[0-9]+/g.test(resultString.charAt(zeroDotIndex + 2)))
                            {
                                resultString = resultString.replace("0.", ".")
                            }
                        }
                    }
                    return resultString
                };
                _NumberHelper.__parseNumberNegativePattern = function(value, numFormat, numberNegativePattern)
                {
                    var neg = numFormat.negativeSign;
                    var pos = numFormat.positiveSign;
                    var valueStr = new _StringHelper(value);
                    if (numberNegativePattern === 4 || numberNegativePattern === 2)
                    {
                        neg = ' ' + neg;
                        pos = ' ' + pos
                    }
                    if (numberNegativePattern === 4 || numberNegativePattern === 3)
                    {
                        if (valueStr.endsWith(neg))
                        {
                            return ['-', value.substr(0, value.length - neg.length)]
                        }
                        else if (valueStr.endsWith(pos))
                        {
                            return ['+', value.substr(0, value.length - pos.length)]
                        }
                    }
                    else if (numberNegativePattern === 2 || numberNegativePattern === 1)
                    {
                        if (valueStr.startsWith(neg))
                        {
                            return ['-', value.substr(neg.length)]
                        }
                        else if (valueStr.startsWith(pos))
                        {
                            return ['+', value.substr(pos.length)]
                        }
                    }
                    else if (numberNegativePattern === 0)
                    {
                        if (valueStr.startsWith('(') && valueStr.endsWith(')'))
                        {
                            return ['-', value.substr(1, value.length - 2)]
                        }
                    }
                    else
                    {
                        throw new Error("");
                    }
                    return ['', value]
                };
                _NumberHelper.__parseNumber = function(value, cultureInfo)
                {
                    value = (value !== keyword_undefined && value !== keyword_null) ? new _StringHelper(value).trim() : "";
                    if (value.match(/^[+-]?infinity$/i))
                    {
                        return parseFloat(value)
                    }
                    if (value.match(/^0x[a-f0-9]+$/i))
                    {
                        return parseInt(value, 10)
                    }
                    var numFormat = cultureInfo.numberFormat;
                    var signInfo = _NumberHelper.__parseNumberNegativePattern(value, numFormat, numFormat.numberNegativePattern);
                    var sign = signInfo[0];
                    var num = signInfo[1];
                    if ((sign === '') && (numFormat.numberNegativePattern !== 1))
                    {
                        signInfo = _NumberHelper.__parseNumberNegativePattern(value, numFormat, 1);
                        sign = signInfo[0];
                        num = signInfo[1]
                    }
                    if (sign === '')
                    {
                        sign = '+'
                    }
                    if (num[0] === numFormat.currencySymbol)
                    {
                        num = num.substr(1)
                    }
                    var exponent;
                    var intAndFraction;
                    var exponentPos = num.indexOf('e');
                    if (exponentPos < 0)
                    {
                        exponentPos = num.indexOf('E')
                    }
                    if (exponentPos < 0)
                    {
                        intAndFraction = num;
                        exponent = keyword_null
                    }
                    else
                    {
                        intAndFraction = num.substr(0, exponentPos);
                        exponent = num.substr(exponentPos + 1)
                    }
                    var integer,
                        fraction;
                    var decimalPos = intAndFraction.indexOf('.');
                    if (decimalPos < 0)
                    {
                        integer = intAndFraction;
                        fraction = keyword_null
                    }
                    else
                    {
                        integer = intAndFraction.substr(0, decimalPos);
                        fraction = intAndFraction.substr(decimalPos + '.'.length)
                    }
                    integer = integer.split(',').join('');
                    var altNumGroupSeparator = ','.replace(/\u00A0/g, " ");
                    if (',' !== altNumGroupSeparator)
                    {
                        integer = integer.split(altNumGroupSeparator).join('')
                    }
                    var p = sign + integer;
                    if (fraction !== keyword_null)
                    {
                        p += '.' + fraction
                    }
                    var lastChar = p[p.length - 1];
                    if (lastChar === numFormat.percentSymbol)
                    {
                        p = p.substr(0, p.length - 1);
                        p = new _StringHelper(p).trimEnd();
                        var ndp = p.indexOf('.');
                        if (ndp === -1)
                        {
                            ndp = p.length
                        }
                        var resultBuilder = new _StringBuilder('');
                        resultBuilder.append(p.substr(0, ndp - 2));
                        resultBuilder.append('.');
                        resultBuilder.append(p.substr(ndp - 2, 2));
                        resultBuilder.append(p.substr(ndp + 1));
                        p = resultBuilder.toString()
                    }
                    if (exponent !== keyword_null)
                    {
                        var expSignInfo = _NumberHelper.__parseNumberNegativePattern(exponent, numFormat, 1);
                        if (expSignInfo[0] === '')
                        {
                            expSignInfo[0] = '+'
                        }
                        p += 'e' + expSignInfo[0] + expSignInfo[1]
                    }
                    if (p.match(/^[+-]?\d*\.?\d*(e[+-]?\d+)?$/))
                    {
                        return parseFloat(p)
                    }
                    return NaN
                };
                _NumberHelper.___toHexString = function(num, lowCase, precision)
                {
                    if (Math_abs(Math_floor(num) - num) !== 0)
                    {
                        throw new Error(Sheets.SR.Exp_BadFormatSpecifier);
                    }
                    var number = num >= 0 ? num.toString(16) : (_NumberHelper.___maxInt32 + num + 1).toString(16);
                    number = lowCase ? number.toLowerCase() : number.toUpperCase();
                    if (precision !== keyword_undefined && precision !== keyword_null && number.length < precision)
                    {
                        return _NumberHelper.___zeroPad(number, precision, true)
                    }
                    return number
                };
                _NumberHelper.___toScientific = function(num, e, precision, groupSizes, sep, decimalChar, negativeSign)
                {
                    var digitLen = 0;
                    var digSepMoveRight = (num >= 1 || num === 0);
                    while (digitLen < 1000)
                    {
                        var base = Math_pow(10, digitLen);
                        if (digSepMoveRight && (num / base < 10) || !digSepMoveRight && (num * base >= 1))
                            break;
                        digitLen++
                    }
                    num = digSepMoveRight ? Math_abs(num) / Math_pow(10, digitLen) : Math_abs(num) * Math_pow(10, digitLen);
                    var number = _NumberHelper.___expandNumber(num, precision, groupSizes, sep, decimalChar, negativeSign);
                    number += e + (digSepMoveRight ? "+" : "-") + _NumberHelper.___zeroPad(digitLen.toString(), 3, true);
                    return number
                };
                _NumberHelper.removeCultureSymbolInNum = function(obj)
                {
                    if (obj === keyword_undefined || obj === keyword_null)
                    {
                        return obj
                    }
                    var numberString = obj.toString();
                    numberString = numberString.replace(new RegExp('[,]', "g"), "");
                    return numberString.replace(new RegExp('[.]', "g"), ".")
                };
                _NumberHelper.replaceCultureSymbolToNormal = function(value)
                {
                    if (typeof value !== 'string')
                    {
                        return value
                    }
                    if (Sheets.CR.numberDecimalSeparator !== '.')
                    {
                        value = value.replace(Sheets.RegUtil.getReg('[' + Sheets.CR.numberDecimalSeparator + ']'), '#dot#')
                    }
                    if (Sheets.CR.numberGroupSeparator !== ',')
                    {
                        value = value.replace(Sheets.RegUtil.getReg('[' + Sheets.CR.numberGroupSeparator + ']'), '#group#')
                    }
                    if (Sheets.CR.numberDecimalSeparator !== '.')
                    {
                        value = value.replace(Sheets.RegUtil.getReg('#dot#'), '.')
                    }
                    if (Sheets.CR.numberGroupSeparator !== ',')
                    {
                        value = value.replace(Sheets.RegUtil.getReg('#group#'), ',')
                    }
                    return value
                };
                _NumberHelper.replaceNormalToCultureSymble = function(value)
                {
                    if (typeof value !== 'string')
                    {
                        return value
                    }
                    if (Sheets.CR.numberDecimalSeparator !== '.')
                    {
                        value = value.replace(Sheets.RegUtil.getReg('[.]'), '#dot#')
                    }
                    if (Sheets.CR.numberGroupSeparator !== ',')
                    {
                        value = value.replace(Sheets.RegUtil.getReg('[,]'), '#group#')
                    }
                    if (Sheets.CR.numberDecimalSeparator !== '.')
                    {
                        value = value.replace(Sheets.RegUtil.getReg('#dot#'), Sheets.CR.numberDecimalSeparator)
                    }
                    if (Sheets.CR.numberGroupSeparator !== ',')
                    {
                        value = value.replace(Sheets.RegUtil.getReg('#group#'), Sheets.CR.numberGroupSeparator)
                    }
                    return value
                };
                _NumberHelper.GeneralNumberInt = "##################0";
                _NumberHelper.GeneralNumberDec = "################";
                _NumberHelper.___signs = {
                    '1': '+', '0': '', '-1': '-'
                };
                _NumberHelper.___maxInt32 = 4294967295;
                _NumberHelper.___percentPositivePattern = ["n %", "n%", "%n", "% n"];
                _NumberHelper.___percentNegativePattern = ["-n %", "-n%", "-%n", "%-n", "%n-", "n-%", "n%-", "-% n", "n %-", "% n-", "% -n", "n- %"];
                _NumberHelper.___numberNegativePattern = ["(n)", "-n", "- n", "n-", "n -"];
                _NumberHelper.___currencyPositivePattern = ["$n", "n$", "$ n", "n $"];
                _NumberHelper.___currencyNegativePattern = ["($n)", "-$n", "$-n", "$n-", "(n$)", "-n$", "n-$", "n$-", "-n $", "-$ n", "n $-", "$ n-", "$ -n", "n- $", "($ n)", "(n $)"];
                return _NumberHelper
            })();
        Sheets._NumberHelper = _NumberHelper;
        Sheets._currentCulture;
        Sheets._currentCultureResouce;
        function Culture(culture)
        {
            if (arguments.length === 0)
            {
                return Sheets._currentCulture
            }
            if (typeof(culture) === const_undefined || culture === keyword_null)
                return;
            Sheets.switchCulture(culture);
            Sheets._CacheMgr.clearFormatCache();
            _cultureChanged(culture)
        }
        Sheets.Culture = Culture;
        function switchCulture(culture)
        {
            var cultureInfo = culture.toLowerCase();
            if (Sheets._currentCulture !== cultureInfo)
            {
                Sheets._currentCultureResouce = getCultureInfoCore(cultureInfo);
                Sheets.CR = Sheets._currentCultureResouce;
                switch (cultureInfo)
                {
                    case"ja-jp":
                        Sheets.SR = Sheets._JPStringResource;
                        _CultureInfo.currentCulture("ja-jp");
                        break;
                    case"en-us":
                        Sheets.SR = Sheets._ENStringResource;
                        _CultureInfo.currentCulture("en-us");
                        break;
                    default:
                        Sheets.SR = Sheets._ENStringResource;
                        _CultureInfo.currentCulture(cultureInfo);
                        break
                }
                Sheets._currentCulture = cultureInfo
            }
        }
        Sheets.switchCulture = switchCulture;
        Culture("en-us");
        function addCultureInfo(cultureName, culture)
        {
            if (culture.numberDecimalSeparator == culture.listSeparator)
            {
                culture.listSeparator = ";"
            }
            Sheets.cultureInfoDict[cultureName.toLowerCase()] = culture
        }
        Sheets.addCultureInfo = addCultureInfo;
        function getCultureInfo(cultureName)
        {
            var culture = getCultureInfoCore(cultureName);
            var result = new Sheets.CultureInfo;
            $.extend(result, culture);
            return result
        }
        Sheets.getCultureInfo = getCultureInfo;
        function getCultureInfoCore(cultureName)
        {
            cultureName = cultureName.toLowerCase();
            var culture = Sheets.cultureInfoDict[cultureName];
            if (!culture)
            {
                culture = Sheets.cultureInfoDict[""]
            }
            return culture
        }
        Sheets.getCultureInfoCore = getCultureInfoCore;
        function _cultureChanged(culture)
        {
            $("div[gcUIElement='gcSpread']").trigger(Sheets.Events.CultureChanged, [{CultureInfo: culture}])
        }
        (function()
        {
            var elements = $("meta[name='spreadjs culture']");
            if (elements.length > 0)
            {
                var culture = $(elements[elements.length - 1]).attr("content");
                if (culture !== keyword_null && culture != keyword_undefined && culture.toLowerCase() === "ja-jp")
                {
                    Sheets.SR = Sheets._JPStringResource;
                    Sheets._currentCulture = "ja-jp"
                }
            }
        })();
        var _WordWrapHelper = (function()
            {
                function _WordWrapHelper(){}
                _WordWrapHelper._getCtx = function()
                {
                    if (!_WordWrapHelper._ctx)
                    {
                        var canvas = document.createElement("canvas");
                        if (canvas.getContext)
                        {
                            _WordWrapHelper._ctx = canvas.getContext("2d")
                        }
                    }
                    return _WordWrapHelper._ctx
                };
                _WordWrapHelper._getWrapInfo = function(text, width, font)
                {
                    var wrapLines = [];
                    if (text.length === 0)
                    {
                        return wrapLines
                    }
                    var ctx = _WordWrapHelper._getCtx();
                    if (!ctx)
                    {
                        return wrapLines
                    }
                    ctx.font = font;
                    if (width <= 0)
                    {
                        var charMinWidth = -1;
                        var flag = true;
                        for (var index = 0; index < text.length; index++)
                        {
                            var tempChar = text.charAt(index);
                            if (tempChar !== " " && !flag)
                            {
                                charMinWidth = Math_min(charMinWidth, ctx.measureText(tempChar).width)
                            }
                            else if (tempChar !== " " && flag)
                            {
                                charMinWidth = ctx.measureText(tempChar).width;
                                flag = false
                            }
                        }
                        width = charMinWidth
                    }
                    var lines = text.split(/\r\n|\r|\n/);
                    for (var i = 0; i < lines.length; i++)
                    {
                        var wrapLine = _WordWrapHelper._getWrapInfoByWord(lines[i], width);
                        if (wrapLine != keyword_null)
                        {
                            for (var j = 0; j < wrapLine.length; j++)
                            {
                                wrapLines.push(wrapLine[j])
                            }
                        }
                    }
                    return wrapLines
                };
                _WordWrapHelper._getTextWords = function(text)
                {
                    var lines = [];
                    var startIndex = 0;
                    var space = " ";
                    for (var i = 0; i < text.length; i++)
                    {
                        if (lines[startIndex] === keyword_undefined)
                        {
                            lines[startIndex] = ""
                        }
                        var currentChar = text.charAt(i);
                        var nextChar = "";
                        if (i + 1 < text.length)
                        {
                            nextChar = text.charAt(i + 1)
                        }
                        if ((currentChar === space && nextChar !== space))
                        {
                            lines[startIndex] += currentChar;
                            startIndex++
                        }
                        else
                        {
                            lines[startIndex] += currentChar
                        }
                    }
                    return lines
                };
                _WordWrapHelper._measureText = function(text, font)
                {
                    var ctx = _WordWrapHelper._getCtx();
                    if (!ctx)
                    {
                        return 0
                    }
                    if (ctx.font !== font)
                    {
                        ctx.font = font
                    }
                    return ctx.measureText(text).width
                };
                _WordWrapHelper._measureTextWithoutEndSpaces = function(text, font)
                {
                    var ctx = _WordWrapHelper._getCtx();
                    if (!ctx)
                    {
                        return 0
                    }
                    if (font)
                    {
                        ctx.font = font
                    }
                    var tempText = _WordWrapHelper._removeEndSpace(text);
                    return ctx.measureText(tempText).width
                };
                _WordWrapHelper._removeEndSpace = function(text)
                {
                    var index = text.length - 1;
                    while (text.charAt(index) === ' ')
                    {
                        index--
                    }
                    if (index !== text.length - 1)
                    {
                        text = text.substring(0, index + 1)
                    }
                    return text
                };
                _WordWrapHelper._getWrapInfoByCharacter = function(text, width)
                {
                    var lines = [];
                    var ctx = _WordWrapHelper._getCtx();
                    if (!ctx)
                    {
                        return lines
                    }
                    var totalWidth = ctx.measureText(text).width;
                    var charWidth = totalWidth / text.length;
                    var targetLength = Math_ceil(width / charWidth);
                    if (totalWidth > width)
                    {
                        var isLong = false;
                        while (true)
                        {
                            var subText = text.substring(0, targetLength);
                            var subWidth = ctx.measureText(subText).width;
                            if (subWidth == width || isLong && subWidth < width)
                            {
                                lines.push(subText);
                                lines.push(text.substring(subText.length));
                                return lines
                            }
                            else if (subWidth > width)
                            {
                                if (subText.length === 1)
                                {
                                    var remainText = text.substring(subText.length);
                                    if (_WordWrapHelper._measureTextWithoutEndSpaces(remainText) !== 0)
                                    {
                                        lines.push(subText);
                                        lines.push(remainText)
                                    }
                                    else
                                    {
                                        lines.push(text)
                                    }
                                    return lines
                                }
                                targetLength -= 1;
                                isLong = true
                            }
                            else
                            {
                                var step = (width - subWidth) / charWidth;
                                step = step >= 1 ? step : 1;
                                targetLength += step
                            }
                        }
                    }
                    else
                    {
                        if (text != keyword_null && text.length > 0)
                        {
                            lines.push(text)
                        }
                    }
                    return lines
                };
                _WordWrapHelper._getWrapInfoByWord = function(text, width)
                {
                    var lines = [];
                    var words = _WordWrapHelper._getTextWords(text);
                    var ctx = _WordWrapHelper._getCtx();
                    if (!ctx)
                    {
                        return lines
                    }
                    var totalWidth = ctx.measureText(text).width;
                    var charWidth = totalWidth / text.length;
                    var averageLength = parseInt((width / charWidth) + "", 10);
                    var lineIndex = 0,
                        stackCharCount = 0,
                        tempCount = 0,
                        index = 0;
                    var stack = [];
                    var isLong = false;
                    while (index < words.length)
                    {
                        if (isLong === false)
                        {
                            var word = words[index];
                            stack.push(word);
                            stackCharCount += word.length;
                            if (stackCharCount < averageLength)
                            {
                                index++;
                                continue
                            }
                            else
                            {
                                tempCount = stackCharCount;
                                stackCharCount = 0
                            }
                        }
                        var subWidth = _WordWrapHelper._measureTextWithoutEndSpaces(stack.join(""));
                        if (subWidth > width)
                        {
                            var tempWord = stack.pop();
                            if (stack.length === 0)
                            {
                                var parts = _WordWrapHelper._getWrapInfoByCharacter(tempWord, width);
                                stack.push(parts[0]);
                                if (parts.length === 2)
                                {
                                    words[index] = parts[1]
                                }
                                else
                                {
                                    index++
                                }
                                lines[lineIndex++] = stack.join("");
                                isLong = false;
                                stack = []
                            }
                            else
                            {
                                isLong = true;
                                index--
                            }
                        }
                        else if ((subWidth < width && isLong === true) || subWidth === width)
                        {
                            isLong = false;
                            lines[lineIndex++] = _WordWrapHelper._removeEndSpace(stack.join(""));
                            stack = [];
                            index++
                        }
                        else if (subWidth < width)
                        {
                            index++;
                            stackCharCount = tempCount
                        }
                    }
                    if (stack.length !== 0)
                    {
                        lines[lineIndex] = _WordWrapHelper._removeEndSpace(stack.join(""))
                    }
                    return lines
                };
                return _WordWrapHelper
            })();
        Sheets._WordWrapHelper = _WordWrapHelper;
        var FormatConverter = (function()
            {
                function FormatConverter(){}
                FormatConverter.IsNumber = function(value)
                {
                    return Sheets.util.isType(value, "number") || Sheets.util.isType(value, "DateTime") || Sheets.util.isType(value, "TimeSpan") || (value && !Sheets.util.isType(value, "boolean") && !isNaN(value))
                };
                FormatConverter.ToDouble = function(value)
                {
                    if (value === keyword_null || value === keyword_undefined || value === "")
                    {
                        return 0.0
                    }
                    else if (Sheets.util.isType(value, "number"))
                    {
                        return value
                    }
                    else if (Sheets.util.isType(value, "string") && !isNaN(value))
                    {
                        return _NumberHelper.parseLocale(value)
                    }
                    else if (Sheets.util.isType(value, "boolean"))
                    {
                        return value ? 1.0 : 0.0
                    }
                    else if (Sheets.util.isType(value, "DateTime"))
                    {
                        return new _DateTimeHelper(value).toOADate()
                    }
                    else if (Sheets.util.isType(value, "TimeSpan"))
                    {
                        return new _DateTimeHelper(value).TotalDays()
                    }
                    else
                    {
                        return parseFloat(value)
                    }
                };
                FormatConverter.toString = function(value)
                {
                    try
                    {
                        if (value === keyword_null || value === keyword_undefined)
                            return "";
                        else if (typeof value === "boolean")
                            return value ? "TRUE" : "FALSE";
                        else if (typeof value === "string")
                            return value;
                        else
                            return value.toString()
                    }
                    catch(err)
                    {
                        return ""
                    }
                };
                return FormatConverter
            })();
        Sheets.FormatConverter = FormatConverter
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.theme", ["core.migrate", "core.common"]);
        var keyword_null = null,
            keyword_undefined = undefined,
            Math_min = Math.min,
            Math_max = Math.max;
        var _Color = (function()
            {
                function _Color(a, r, g, b)
                {
                    var self = this;
                    self.a = a;
                    self.r = r;
                    self.g = g;
                    self.b = b
                }
                _Color.prototype.toString = function()
                {
                    var self = this;
                    if (self.a === 255)
                    {
                        return '#' + self.getColorUnitString(self.r) + self.getColorUnitString(self.g) + self.getColorUnitString(self.b)
                    }
                    return "rgba(" + self.r + "," + self.g + "," + self.b + "," + self.a + ")"
                };
                _Color.prototype.getBrightness = function()
                {
                    return ((this.r * 299) + (this.g * 587) + (this.b * 114)) / 1000
                };
                _Color.prototype.getColorUnitString = function(unit)
                {
                    var s = unit.toString(16);
                    if (s.length === 1)
                    {
                        s = '0' + s
                    }
                    return s
                };
                _Color.hueToRGB = function(n1, n2, hue)
                {
                    if (hue < 0)
                    {
                        hue += 240
                    }
                    if (hue > 240)
                    {
                        hue -= 240
                    }
                    if (hue < 40)
                    {
                        return (n1 + ((((n2 - n1) * hue) + 20) / 40))
                    }
                    if (hue < 120)
                    {
                        return n2
                    }
                    if (hue < 160)
                    {
                        return (n1 + ((((n2 - n1) * (160 - hue)) + 20) / 40))
                    }
                    return n1
                };
                _Color.fromHLS = function(hue, luminosity, saturation)
                {
                    var r,
                        g,
                        b;
                    if (saturation === 0)
                    {
                        r = g = b = parseInt(((luminosity * 0xff) / 240), 10)
                    }
                    else
                    {
                        var n1,
                            n2;
                        if (luminosity <= 120)
                        {
                            n2 = ((luminosity * (240 + saturation)) + 120) / 240
                        }
                        else
                        {
                            n2 = (luminosity + saturation) - (((luminosity * saturation) + 120) / 240)
                        }
                        n1 = (2 * luminosity) - n2;
                        r = parseInt((((_Color.hueToRGB(n1, n2, hue + 80) * 0xff) + 120) / 240), 10);
                        g = parseInt((((_Color.hueToRGB(n1, n2, hue) * 0xff) + 120) / 240), 10);
                        b = parseInt((((_Color.hueToRGB(n1, n2, hue - 80) * 0xff) + 120) / 240), 10)
                    }
                    return new _Color(0xff, r, g, b)
                };
                _Color.parse = function(value)
                {
                    return parseToColor(value)
                };
                return _Color
            })();
        Sheets._Color = _Color;
        var HLSColor = (function()
            {
                function HLSColor(rgbColor)
                {
                    var self = this;
                    var r = rgbColor.r,
                        g = rgbColor.g,
                        b = rgbColor.b;
                    var maxUnit = Math_max(Math_max(r, g), b);
                    var minUnit = Math_min(Math_min(r, g), b);
                    var sum = maxUnit + minUnit;
                    self.luminosity = parseInt((((sum * 240) + 0xff) / 510), 10);
                    var diff = maxUnit - minUnit;
                    if (diff === 0)
                    {
                        self.saturation = 0;
                        self.hue = 160
                    }
                    else
                    {
                        if (self.luminosity <= 120)
                        {
                            self.saturation = parseInt((((diff * 240) + (sum / 2)) / sum), 10)
                        }
                        else
                        {
                            self.saturation = parseInt((((diff * 240) + ((510 - sum) / 2)) / (510 - sum)), 10)
                        }
                        var partR = (((maxUnit - r) * 40) + (diff / 2)) / diff;
                        var partG = (((maxUnit - g) * 40) + (diff / 2)) / diff;
                        var partB = (((maxUnit - b) * 40) + (diff / 2)) / diff;
                        if (r === maxUnit)
                        {
                            self.hue = parseInt((partB - partG), 10)
                        }
                        else if (g === maxUnit)
                        {
                            self.hue = parseInt(((80 + partR) - partB), 10)
                        }
                        else
                        {
                            self.hue = parseInt(((160 + partG) - partR), 10)
                        }
                        if (self.hue < 0)
                        {
                            self.hue += 240
                        }
                        if (self.hue > 240)
                        {
                            self.hue -= 240
                        }
                    }
                }
                HLSColor.prototype.toColor = function()
                {
                    return _Color.fromHLS(this.hue, this.luminosity, this.saturation)
                };
                HLSColor.prototype.getLighterColor = function(percentLighter)
                {
                    var self = this;
                    var luminosity = self.luminosity;
                    var newLuma = self.newLuma(self.luminosity, 500, true);
                    return _Color.fromHLS(self.hue, luminosity + ((newLuma - luminosity) * percentLighter), self.saturation)
                };
                HLSColor.prototype.getDrakerColor = function(percentDarker)
                {
                    var self = this;
                    var newLuma = self.newLuma(self.luminosity, -333, true);
                    return _Color.fromHLS(self.hue, newLuma * (1 - percentDarker), self.saturation)
                };
                HLSColor.prototype.newLuma = function(luminosity, n, scale)
                {
                    if (n === 0)
                    {
                        return luminosity
                    }
                    if (scale)
                    {
                        if (n > 0)
                        {
                            return (((luminosity * (0x3e8 - n)) + (0xf1 * n)) / 0x3e8)
                        }
                        return ((luminosity * (n + 0x3e8)) / 0x3e8)
                    }
                    luminosity += ((n * 240) / 0x3e8);
                    if (luminosity < 0)
                    {
                        luminosity = 0
                    }
                    if (luminosity > 240)
                    {
                        luminosity = 240
                    }
                    return luminosity
                };
                return HLSColor
            })();
        Sheets.HLSColor = HLSColor;
        function parseToColor(value)
        {
            if (value instanceof _Color)
            {
                return value
            }
            var a = 0,
                r = 0,
                g = 0,
                b = 0;
            if (value && value !== "")
            {
                var val = Sheets.util.parseColorString(value);
                if (val)
                {
                    if (val.length === 3)
                    {
                        a = 255;
                        r = val[0];
                        g = val[1];
                        b = val[2]
                    }
                    else if (val.length === 4)
                    {
                        a = val[0];
                        r = val[1];
                        g = val[2];
                        b = val[3]
                    }
                }
            }
            return new _Color(a, r, g, b)
        }
        var updateTint = function(color, tint)
            {
                if (tint === 0)
                {
                    return color
                }
                var hls = new HLSColor(color);
                var lumDiff = parseInt((tint > 0 ? ((240 - hls.luminosity) * tint) : (hls.luminosity * tint)), 10);
                return _Color.fromHLS(hls.hue, hls.luminosity + lumDiff, hls.saturation)
            };
        var BACKCOLOR1 = 0,
            BACKCOLOR2 = 1,
            TEXTCOLOR1 = 2,
            TEXTCOLOR2 = 3,
            ACCENT1 = 4,
            ACCENT2 = 5,
            ACCENT3 = 6,
            ACCENT4 = 7,
            ACCENT5 = 8,
            ACCENT6 = 9,
            HYPERLINK = 10,
            FHYPERLINK = 11;
        var ThemeColor = (function()
            {
                function ThemeColor(name, text1, text2, background1, background2, accent1, accent2, accent3, accent4, accent5, accent6, link, followedLink)
                {
                    this._name = name;
                    this._colorList = [parseToColor(background1), parseToColor(background2), parseToColor(text1), parseToColor(text2), parseToColor(accent1), parseToColor(accent2), parseToColor(accent3), parseToColor(accent4), parseToColor(accent5), parseToColor(accent6), parseToColor(link), parseToColor(followedLink)]
                }
                ThemeColor.prototype.name = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._name
                    }
                    this._name = value;
                    return this
                };
                ThemeColor.prototype.background1 = function(value)
                {
                    return this._property(BACKCOLOR1, arguments.length === 0, value)
                };
                ThemeColor.prototype.background2 = function(value)
                {
                    return this._property(BACKCOLOR2, arguments.length === 0, value)
                };
                ThemeColor.prototype.textColor1 = function(value)
                {
                    return this._property(TEXTCOLOR1, arguments.length === 0, value)
                };
                ThemeColor.prototype.textColor2 = function(value)
                {
                    return this._property(TEXTCOLOR2, arguments.length === 0, value)
                };
                ThemeColor.prototype.accent1 = function(value)
                {
                    return this._property(ACCENT1, arguments.length === 0, value)
                };
                ThemeColor.prototype.accent2 = function(value)
                {
                    return this._property(ACCENT2, arguments.length === 0, value)
                };
                ThemeColor.prototype.accent3 = function(value)
                {
                    return this._property(ACCENT3, arguments.length === 0, value)
                };
                ThemeColor.prototype.accent4 = function(value)
                {
                    return this._property(ACCENT4, arguments.length === 0, value)
                };
                ThemeColor.prototype.accent5 = function(value)
                {
                    return this._property(ACCENT5, arguments.length === 0, value)
                };
                ThemeColor.prototype.accent6 = function(value)
                {
                    return this._property(ACCENT6, arguments.length === 0, value)
                };
                ThemeColor.prototype.hyperline = function(value)
                {
                    return this._property(HYPERLINK, arguments.length === 0, value)
                };
                ThemeColor.prototype.followedHyperline = function(value)
                {
                    return this._property(FHYPERLINK, arguments.length === 0, value)
                };
                ThemeColor.prototype._property = function(index, isGet, value)
                {
                    if (isGet)
                    {
                        return this._colorList[index]
                    }
                    this._colorList[index] = parseToColor(value);
                    return this
                };
                ThemeColor.prototype.getColor = function(name)
                {
                    if (name)
                    {
                        var t = name.split(' ');
                        if (t)
                        {
                            var index = -1,
                                len = t.length;
                            if (len > 1)
                            {
                                if (!t[0])
                                {
                                    return name
                                }
                                var cn = t[0].toLowerCase();
                                if (cn === "background")
                                {
                                    index = parseInt(t[1], 10) - 1
                                }
                                else if (cn === "text")
                                {
                                    index = parseInt(t[1], 10) + 1
                                }
                                else if (cn === "accent")
                                {
                                    index = parseInt(t[1], 10) + 3
                                }
                            }
                            else if (len === 1)
                            {
                                var cn = t[0].toLowerCase();
                                if (cn === "hyperlink")
                                {
                                    index = HYPERLINK
                                }
                                else if (cn === "followedhyperlink")
                                {
                                    index = FHYPERLINK
                                }
                            }
                            if (index >= 0 && index <= 11)
                            {
                                if (len > 2)
                                {
                                    var tint = parseInt(t[2], 10) / 100.0;
                                    return updateTint(this._colorList[index], tint).toString()
                                }
                                else
                                {
                                    return this._colorList[index].toString()
                                }
                            }
                        }
                    }
                    return name
                };
                ThemeColor.prototype.toJSON = function()
                {
                    var self = this,
                        colorList = self._colorList;
                    return {
                            name: self._name, background1: colorList[BACKCOLOR1], background2: colorList[BACKCOLOR2], text1: colorList[TEXTCOLOR1], text2: colorList[TEXTCOLOR2], accent1: colorList[ACCENT1], accent2: colorList[ACCENT2], accent3: colorList[ACCENT3], accent4: colorList[ACCENT4], accent5: colorList[ACCENT5], accent6: colorList[ACCENT6], hyperlink: colorList[HYPERLINK], followedHyperlink: colorList[FHYPERLINK]
                        }
                };
                ThemeColor.prototype.fromJSON = function(jsonData, isNoneSchema)
                {
                    if (!jsonData)
                    {
                        return
                    }
                    var self = this;
                    if (isNoneSchema)
                    {
                        var name = jsonData.name ? jsonData.name : jsonData._name;
                        if (name !== keyword_undefined && name !== keyword_null)
                        {
                            self._name = name
                        }
                        var colorList = jsonData.colorList ? jsonData.colorList : jsonData._colorList;
                        if (colorList !== keyword_undefined && colorList !== keyword_null)
                        {
                            var background1 = colorList[BACKCOLOR1],
                                background2 = colorList[BACKCOLOR2],
                                text1 = colorList[TEXTCOLOR1],
                                text2 = colorList[TEXTCOLOR2],
                                accent1 = colorList[ACCENT1],
                                accent2 = colorList[ACCENT2],
                                accent3 = colorList[ACCENT3],
                                accent4 = colorList[ACCENT4],
                                accent5 = colorList[ACCENT5],
                                accent6 = colorList[ACCENT6],
                                hyperlink = colorList[HYPERLINK],
                                followedHyperlink = colorList[FHYPERLINK];
                            if (background1 !== keyword_undefined && background1 !== keyword_null)
                            {
                                self._colorList[BACKCOLOR1] = new _Color(background1.a, background1.r, background1.g, background1.b)
                            }
                            if (background2 !== keyword_undefined && background2 !== keyword_null)
                            {
                                self._colorList[BACKCOLOR2] = new _Color(background2.a, background2.r, background2.g, background2.b)
                            }
                            if (text1 !== keyword_undefined && text1 !== keyword_null)
                            {
                                self._colorList[TEXTCOLOR1] = new _Color(text1.a, text1.r, text1.g, text1.b)
                            }
                            if (text2 !== keyword_undefined && text2 !== keyword_null)
                            {
                                self._colorList[TEXTCOLOR2] = new _Color(text2.a, text2.r, text2.g, text2.b)
                            }
                            if (accent1 !== keyword_undefined && accent1 !== keyword_null)
                            {
                                self._colorList[ACCENT1] = new _Color(accent1.a, accent1.r, accent1.g, accent1.b)
                            }
                            if (accent2 !== keyword_undefined && accent2 !== keyword_null)
                            {
                                self._colorList[ACCENT2] = new _Color(accent2.a, accent2.r, accent2.g, accent2.b)
                            }
                            if (accent3 !== keyword_undefined && accent3 !== keyword_null)
                            {
                                self._colorList[ACCENT3] = new _Color(accent3.a, accent3.r, accent3.g, accent3.b)
                            }
                            if (accent4 !== keyword_undefined && accent4 !== keyword_null)
                            {
                                self._colorList[ACCENT4] = new _Color(accent4.a, accent4.r, accent4.g, accent4.b)
                            }
                            if (accent5 !== keyword_undefined && accent5 !== keyword_null)
                            {
                                self._colorList[ACCENT5] = new _Color(accent5.a, accent5.r, accent5.g, accent5.b)
                            }
                            if (accent6 !== keyword_undefined && accent6 !== keyword_null)
                            {
                                self._colorList[ACCENT6] = new _Color(accent6.a, accent6.r, accent6.g, accent6.b)
                            }
                            if (hyperlink !== keyword_undefined && hyperlink !== keyword_null)
                            {
                                self._colorList[HYPERLINK] = new _Color(hyperlink.a, hyperlink.r, hyperlink.g, hyperlink.b)
                            }
                            if (followedHyperlink !== keyword_undefined && followedHyperlink !== keyword_null)
                            {
                                self._colorList[FHYPERLINK] = new _Color(followedHyperlink.a, followedHyperlink.r, followedHyperlink.g, followedHyperlink.b)
                            }
                        }
                    }
                    else
                    {
                        if (jsonData.name !== keyword_undefined && jsonData.name !== keyword_null)
                        {
                            self._name = jsonData.name
                        }
                        var background1 = jsonData.background1,
                            background2 = jsonData.background2,
                            text1 = jsonData.text1,
                            text2 = jsonData.text2,
                            accent1 = jsonData.accent1,
                            accent2 = jsonData.accent2,
                            accent3 = jsonData.accent3,
                            accent4 = jsonData.accent4,
                            accent5 = jsonData.accent5,
                            accent6 = jsonData.accent6,
                            hyperlink = jsonData.hyperlink,
                            followedHyperlink = jsonData.followedHyperlink;
                        if (background1 !== keyword_undefined && background1 !== keyword_null)
                        {
                            self._colorList[BACKCOLOR1] = new _Color(background1.a, background1.r, background1.g, background1.b)
                        }
                        if (background2 !== keyword_undefined && background2 !== keyword_null)
                        {
                            self._colorList[BACKCOLOR2] = new _Color(background2.a, background2.r, background2.g, background2.b)
                        }
                        if (text1 !== keyword_undefined && text1 !== keyword_null)
                        {
                            self._colorList[TEXTCOLOR1] = new _Color(text1.a, text1.r, text1.g, text1.b)
                        }
                        if (text2 !== keyword_undefined && text2 !== keyword_null)
                        {
                            self._colorList[TEXTCOLOR2] = new _Color(text2.a, text2.r, text2.g, text2.b)
                        }
                        if (accent1 !== keyword_undefined && accent1 !== keyword_null)
                        {
                            self._colorList[ACCENT1] = new _Color(accent1.a, accent1.r, accent1.g, accent1.b)
                        }
                        if (accent2 !== keyword_undefined && accent2 !== keyword_null)
                        {
                            self._colorList[ACCENT2] = new _Color(accent2.a, accent2.r, accent2.g, accent2.b)
                        }
                        if (accent3 !== keyword_undefined && accent3 !== keyword_null)
                        {
                            self._colorList[ACCENT3] = new _Color(accent3.a, accent3.r, accent3.g, accent3.b)
                        }
                        if (accent4 !== keyword_undefined && accent4 !== keyword_null)
                        {
                            self._colorList[ACCENT4] = new _Color(accent4.a, accent4.r, accent4.g, accent4.b)
                        }
                        if (accent5 !== keyword_undefined && accent5 !== keyword_null)
                        {
                            self._colorList[ACCENT5] = new _Color(accent5.a, accent5.r, accent5.g, accent5.b)
                        }
                        if (accent6 !== keyword_undefined && accent6 !== keyword_null)
                        {
                            self._colorList[ACCENT6] = new _Color(accent6.a, accent6.r, accent6.g, accent6.b)
                        }
                        if (hyperlink !== keyword_undefined && hyperlink !== keyword_null)
                        {
                            self._colorList[HYPERLINK] = new _Color(hyperlink.a, hyperlink.r, hyperlink.g, hyperlink.b)
                        }
                        if (followedHyperlink !== keyword_undefined && followedHyperlink !== keyword_null)
                        {
                            self._colorList[FHYPERLINK] = new _Color(followedHyperlink.a, followedHyperlink.r, followedHyperlink.g, followedHyperlink.b)
                        }
                    }
                };
                return ThemeColor
            })();
        Sheets.ThemeColor = ThemeColor;
        var ThemeColors = (function()
            {
                function ThemeColors(){}
                ThemeColors.Default = new ThemeColor("Default", "#000000", "#1F497D", "#FFFFFF", "#EEECE1", "#4F81BD", "#C0504D", "#9BBB59", "#8064A2", "#4BACC6", "#F79646", "#0000FF", "#800080");
                ThemeColors.Office = new ThemeColor("Office", "#000000", "#1F497D", "#FFFFFF", "#EEECE1", "#4F81BD", "#C0504D", "#9BBB59", "#8064A2", "#4BACC6", "#F79646", "#0000FF", "#800080");
                ThemeColors.Apex = new ThemeColor("Apex", "#000000", "#69676D", "#FFFFFF", "#C9C2D1", "#CEB966", "#9CB084", "#6BB1C9", "#6585CF", "#7E6BC9", "#A379BB", "#410082", "#932968");
                ThemeColors.Aspect = new ThemeColor("Aspect", "#000000", "#323232", "#FFFFFF", "#E3DED1", "#F07F09", "#9F2936", "#1B587C", "#4E8542", "#604878", "#C19859", "#6B9F25", "#B26B02");
                ThemeColors.Concourse = new ThemeColor("Concourse", "#000000", "#464646", "#FFFFFF", "#DEF5FA", "#2DA2BF", "#DA1F28", "#EB641B", "#39639D", "#474B78", "#7D3C4A", "#FF8119", "#44B9E8");
                ThemeColors.Civic = new ThemeColor("Civic", "#000000", "#646B86", "#FFFFFF", "#C5D1D7", "#D16349", "#CCB400", "#8CADAE", "#8C7B70", "#8FB08C", "#D19049", "#00A3D6", "#694F07");
                ThemeColors.Oriel = new ThemeColor("Oriel", "#000000", "#575F6D", "#FFFFFF", "#FFF39D", "#FE8637", "#7598D9", "#B32C16", "#F5CD2D", "#AEBAD5", "#777C84", "#D2611C", "#3B435B");
                ThemeColors.Origin = new ThemeColor("Origin", "#000000", "#464653", "#FFFFFF", "#DDE9EC", "#727CA3", "#9FB8CD", "#D2DA7A", "#FADA7A", "#B88472", "#8E736A", "#B292CA", "#6B5680");
                ThemeColors.Paper = new ThemeColor("Paper", "#000000", "#444D26", "#FFFFFF", "#FEFAC9", "#A5B592", "#F3A447", "#E7BC29", "#D092A7", "#9C85C0", "#809EC2", "#8E58B6", "#7F6F6F");
                ThemeColors.Solstice = new ThemeColor("Solstice", "#000000", "#4F271C", "#FFFFFF", "#E7DEC9", "#3891A7", "#FEB80A", "#C32D2E", "#84AA33", "#964305", "#475A8D", "#8DC765", "#AA8A14");
                ThemeColors.Technic = new ThemeColor("Technic", "#000000", "#3B3B3B", "#FFFFFF", "#D4D2D0", "#6EA0B0", "#CCAF0A", "#8D89A4", "#748560", "#9E9273", "#7E848D", "#00C8C3", "#A116E0");
                ThemeColors.Trek = new ThemeColor("Trek", "#000000", "#4E3B30", "#FFFFFF", "#FBEEC9", "#F0A22E", "#A5644E", "#B58B80", "#C3986D", "#A19574", "#C17529", "#AD1F1F", "#FFC42F");
                ThemeColors.Urban = new ThemeColor("Urban", "#000000", "#424456", "#FFFFFF", "#DEDEDE", "#53548A", "#438086", "#A04DA3", "#C4652D", "#8B5D3D", "#5C92B5", "#67AFBD", "#C2A874");
                ThemeColors.Verve = new ThemeColor("Verve", "#000000", "#666666", "#FFFFFF", "#D2D2D2", "#FF388C", "#E40059", "#9C007F", "#68007F", "#005BD3", "#00349E", "#17BBFD", "#FF79C2");
                ThemeColors.Equity = new ThemeColor("Equity", "#000000", "#696464", "#FFFFFF", "#E9E5DC", "#D34817", "#9B2D1F", "#A28E6A", "#956251", "#918485", "#855D5D", "#CC9900", "#96A9A9");
                ThemeColors.Flow = new ThemeColor("Flow", "#000000", "#04617B", "#FFFFFF", "#DBF5F9", "#0F6FC6", "#009DD9", "#0BD0D9", "#10CF9B", "#7CCA62", "#A5C249", "#E2D700", "#85DFD0");
                ThemeColors.Foundry = new ThemeColor("Foundry", "#000000", "#676A55", "#FFFFFF", "#EAEBDE", "#72A376", "#B0CCB0", "#A8CDD7", "#C0BEAF", "#CEC597", "#E8B7B7", "#DB5353", "#903638");
                ThemeColors.Median = new ThemeColor("Median", "#000000", "#775F55", "#FFFFFF", "#EBDDC3", "#94B6D2", "#DD8047", "#A5AB81", "#D8B25C", "#7BA79D", "#968C8C", "#F7B615", "#704404");
                ThemeColors.Metro = new ThemeColor("Metro", "#000000", "#4E5B6F", "#FFFFFF", "#D6ECFF", "#7FD13B", "#EA157A", "#FEB80A", "#00ADDC", "#738AC8", "#1AB39F", "#EB8803", "#5F7791");
                ThemeColors.Module = new ThemeColor("Module", "#000000", "#5A6378", "#FFFFFF", "#D4D4D6", "#F0AD00", "#60B5CC", "#E66C7D", "#6BB76D", "#E88651", "#C64847", "#168BBA", "#680000");
                ThemeColors.Opulent = new ThemeColor("Opulent", "#000000", "#B13F9A", "#FFFFFF", "#F4E7ED", "#B83D68", "#AC66BB", "#DE6C36", "#F9B639", "#CF6DA4", "#FA8D3D", "#FFDE66", "#D490C5");
                return ThemeColors
            })();
        Sheets.ThemeColors = ThemeColors;
        var SpreadTheme = (function()
            {
                function SpreadTheme(name, themeColor, headingFont, bodyFont)
                {
                    var self = this;
                    self._name = name;
                    self._themeColor = themeColor ? themeColor : new ThemeColor(name);
                    self._headingFont = headingFont;
                    self._bodyFont = bodyFont
                }
                SpreadTheme.prototype.name = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._name
                    }
                    this._name = value;
                    return this
                };
                SpreadTheme.prototype.colors = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._themeColor
                    }
                    this._themeColor = value;
                    return this
                };
                SpreadTheme.prototype.headerFont = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._headingFont
                    }
                    this._headingFont = value;
                    return this
                };
                SpreadTheme.prototype.bodyFont = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._bodyFont
                    }
                    this._bodyFont = value;
                    return this
                };
                SpreadTheme.prototype.getColor = function(colorString)
                {
                    return this._themeColor.getColor(colorString)
                };
                SpreadTheme.prototype.getFont = function(fontString)
                {
                    if (fontString === "Body")
                    {
                        return this.bodyFont()
                    }
                    else if (fontString === "Headings")
                    {
                        return this.headerFont()
                    }
                    return fontString
                };
                SpreadTheme.prototype.toJSON = function()
                {
                    var self = this;
                    return {
                            name: self._name, themeColor: self._themeColor ? self._themeColor.toJSON() : undefined, headingFont: self._headingFont, bodyFont: self._bodyFont
                        }
                };
                return SpreadTheme
            })();
        Sheets.SpreadTheme = SpreadTheme;
        var SpreadThemes = (function()
            {
                function SpreadThemes(){}
                SpreadThemes.Default = new SpreadTheme("Default", ThemeColors.Default, "Cambria", "Calibri");
                SpreadThemes.Office = new SpreadTheme("Office", ThemeColors.Office, "Cambria", "Calibri");
                SpreadThemes.Apex = new SpreadTheme("Apex", ThemeColors.Apex, "Lucida Sans", "Book Antiqua");
                SpreadThemes.Aspect = new SpreadTheme("Aspect", ThemeColors.Aspect, "Verdana", "Verdana");
                SpreadThemes.Concourse = new SpreadTheme("Concourse", ThemeColors.Concourse, "Lucida Sans Unicode", "Lucida Sans Unicode");
                SpreadThemes.Civic = new SpreadTheme("Civic", ThemeColors.Civic, "Georgia", "Georgia");
                SpreadThemes.Oriel = new SpreadTheme("Oriel", ThemeColors.Oriel, "Century Schoolbook", "Century Schoolbook");
                SpreadThemes.Origin = new SpreadTheme("Origin", ThemeColors.Origin, "Bookman Old Style", "Gill Sans MT");
                SpreadThemes.Paper = new SpreadTheme("Paper", ThemeColors.Paper, "Constantia", "Constantia");
                SpreadThemes.Solstice = new SpreadTheme("Solstice", ThemeColors.Solstice, "Gill Sans MT", "Gill Sans MT");
                SpreadThemes.Technic = new SpreadTheme("Technic", ThemeColors.Technic, "Franklin Gothic Book", "Arial");
                SpreadThemes.Trek = new SpreadTheme("Trek", ThemeColors.Trek, "Franklin Gothic Medium", "Franklin Gothic Book");
                SpreadThemes.Urban = new SpreadTheme("Urban", ThemeColors.Urban, "Trebuchet MS", "Georgia");
                SpreadThemes.Verve = new SpreadTheme("Verve", ThemeColors.Verve, "Century Gothic", "Century Gothic");
                SpreadThemes.Equity = new SpreadTheme("Equity", ThemeColors.Equity, "Franklin Gothic Book", "Perpetua");
                SpreadThemes.Flow = new SpreadTheme("Flow", ThemeColors.Flow, "Calibri", "Constantia");
                SpreadThemes.Foundry = new SpreadTheme("Foundry", ThemeColors.Foundry, "Rockwell", "Rockwell");
                SpreadThemes.Median = new SpreadTheme("Median", ThemeColors.Median, "Tw Cen MT", "Tw Cen MT");
                SpreadThemes.Metro = new SpreadTheme("Metro", ThemeColors.Metro, "Consolas", "Corbel");
                SpreadThemes.Module = new SpreadTheme("Module", ThemeColors.Module, "Corbel", "Corbel");
                SpreadThemes.Opulent = new SpreadTheme("Opulent", ThemeColors.Opulent, "Trebuchet MS", "Trebuchet MS");
                return SpreadThemes
            })();
        Sheets.SpreadThemes = SpreadThemes
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.spreadpanelex", ["core.common"]);
        var keyword_null = null,
            const_undefined = "undefined";
        var CSS_CLASS_SCROLLCONTAINER = 'scroll-container',
            CSS_CLASS_SCROLLCONTAINERCORNER = 'scroll-corner-all',
            CSS_CLASS_SCROLLARROW = 'scroll-arrow',
            CSS_CLASS_SCROLLBARWRAPPER = 'scrollbar-wrapper',
            CSS_CLASS_SCROLLBAR = 'scroll-bar',
            CSS_CLASS_ARROWUP = 'scroll-arrowUp',
            CSS_CLASS_ARROWDOWN = 'scroll-arrowDown',
            CSS_CLASS_ARROWLEFT = 'scroll-arrowLeft',
            CSS_CLASS_ARROWRIGHT = 'scroll-arrowRight',
            CSS_CLASS_VERTICALSCROLL = 'scrollbar-vertical',
            CSS_CLASS_HORIZONTALSCROLL = 'scrollbar-horizontal',
            CSS_CLASS_NONE_USER_SELECT = 'scrollbar-none-user-select',
            css_width = 'width',
            css_height = 'height',
            css_left = 'left',
            css_right = 'right',
            css_top = 'top',
            css_bottom = 'bottom',
            css_marginLeft = 'margin-left',
            css_marginTop = 'margin-top',
            ns_scrollbar = '.gcScrollbar',
            e_mousedown = 'mousedown' + ns_scrollbar,
            e_mouseup = 'mouseup' + ns_scrollbar,
            e_mousemove = 'mousemove' + ns_scrollbar,
            e_mouseover = 'mouseover' + ns_scrollbar,
            e_mouseout = 'mouseout' + ns_scrollbar,
            e_mousewheel = 'mousewheel',
            e_dommousescroll = 'DOMMouseScroll',
            e_mouseout = 'mouseout' + ns_scrollbar,
            e_scroll = 'scroll' + ns_scrollbar;
        var EventUtil = {
                addHandler: function(element, type, handler)
                {
                    if (element.addEventListener)
                    {
                        element.addEventListener(type, handler, false)
                    }
                }, removeHandler: function(element, type, handler)
                    {
                        if (element.removeEventListener)
                        {
                            element.removeEventListener(type, handler, false)
                        }
                    }
            };
        (function(ScrollType)
        {
            ScrollType[ScrollType["pixels"] = 0] = "pixels";
            ScrollType[ScrollType["continuous"] = 1] = "continuous"
        })(Sheets.ScrollType || (Sheets.ScrollType = {}));
        var ScrollType = Sheets.ScrollType;
        (function(ScrollOrientation)
        {
            ScrollOrientation[ScrollOrientation["horizontalScroll"] = 0] = "horizontalScroll";
            ScrollOrientation[ScrollOrientation["verticalScroll"] = 1] = "verticalScroll"
        })(Sheets.ScrollOrientation || (Sheets.ScrollOrientation = {}));
        var ScrollOrientation = Sheets.ScrollOrientation;
        (function(ScrollEventType)
        {
            ScrollEventType[ScrollEventType["smallDecrement"] = 0] = "smallDecrement";
            ScrollEventType[ScrollEventType["smallIncrement"] = 1] = "smallIncrement";
            ScrollEventType[ScrollEventType["largeDecrement"] = 2] = "largeDecrement";
            ScrollEventType[ScrollEventType["largeIncrement"] = 3] = "largeIncrement";
            ScrollEventType[ScrollEventType["thumbPosition"] = 4] = "thumbPosition";
            ScrollEventType[ScrollEventType["thumbTrack"] = 5] = "thumbTrack";
            ScrollEventType[ScrollEventType["endScroll"] = 6] = "endScroll"
        })(Sheets.ScrollEventType || (Sheets.ScrollEventType = {}));
        var ScrollEventType = Sheets.ScrollEventType;
        var ScrollablePanel = (function()
            {
                function ScrollablePanel(superPanel, content)
                {
                    var self = this;
                    self._showHorizontalScrollbar = true;
                    self._showVerticalScrollbar = true;
                    self._hSmallChange = 10;
                    self._vSmallChange = 10;
                    self._defaultScrollbarSize = 18;
                    self._superPanel = superPanel;
                    self._content = content;
                    self.refreshLayout(true)
                }
                ScrollablePanel.prototype.content = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._content
                    }
                    if (value instanceof HTMLElement && self._content !== value)
                    {
                        self._content = value;
                        self.refreshLayout(true)
                    }
                    return self
                };
                ScrollablePanel.prototype.superPanel = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._superPanel
                    }
                    if (value instanceof HTMLElement && self._superPanel !== value)
                    {
                        self._superPanel = value;
                        self.refreshLayout(true)
                    }
                    return self
                };
                ScrollablePanel.prototype.horizontalSmallChange = function(smallChange)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._hSmallChange
                    }
                    if (typeof smallChange === 'number' && self._hSmallChange !== smallChange)
                    {
                        self._hSmallChange = smallChange
                    }
                    return self
                };
                ScrollablePanel.prototype.verticalSmallChange = function(smallChange)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._vSmallChange
                    }
                    if (typeof smallChange === 'number' && self._vSmallChange !== smallChange)
                    {
                        self._vSmallChange = smallChange
                    }
                    return self
                };
                ScrollablePanel.prototype.showHorizontalScrollbar = function()
                {
                    return this._showHorizontalScrollbar
                };
                ScrollablePanel.prototype.showVerticalScrollbar = function()
                {
                    return this._showVerticalScrollbar
                };
                ScrollablePanel.prototype.refreshLayout = function(isNewContent)
                {
                    var self = this;
                    if (!self._superPanel || !self._content)
                    {
                        return
                    }
                    var $superPanel = $(self._superPanel),
                        $content = $(self._content),
                        scrollbarSize = self._defaultScrollbarSize,
                        contentWidth = $content.width(),
                        contentHeight = $content.height(),
                        superPanelWidth = $superPanel.width(),
                        superPanelHeight = $superPanel.height(),
                        pageWidth = superPanelWidth - scrollbarSize,
                        pageHeight = superPanelHeight - scrollbarSize,
                        isInitEvent = false;
                    if (!self._container)
                    {
                        self._container = document.createElement('div');
                        $(self._container).css({
                            position: 'relative', left: 0, top: 0, overflow: 'hidden', border: 'none', padding: 0, margin: 0
                        });
                        isInitEvent = true
                    }
                    var $container = $(self._container);
                    $container.css({
                        width: superPanelWidth, height: superPanelHeight
                    });
                    if (!self._contentWrapper)
                    {
                        self._contentWrapper = document.createElement('div');
                        $(self._contentWrapper).css({
                            position: 'absolute', left: 0, top: 0, display: 'inline-block', overflow: 'hidden', border: 'none', padding: 0, margin: 0
                        });
                        $container.append(self._contentWrapper)
                    }
                    var $contentWrapper = $(self._contentWrapper);
                    if (!self._tempContentWrapper)
                    {
                        self._tempContentWrapper = document.createElement('div');
                        $(self._tempContentWrapper).css({position: 'relative'});
                        $contentWrapper.append(self._tempContentWrapper)
                    }
                    var $tempContentWrapper = $(self._tempContentWrapper);
                    if (isNewContent)
                    {
                        $tempContentWrapper.append(self._content).css({
                            top: 0, left: 0
                        })
                    }
                    if ($.browser.chrome)
                    {
                        contentWidth = Math.round(contentWidth);
                        contentHeight = Math.round(contentHeight);
                        superPanelWidth = Math.ceil(superPanelWidth);
                        superPanelHeight = Math.ceil(superPanelHeight)
                    }
                    var result = self._isNeedScrollbars(contentWidth, contentHeight, superPanelWidth, superPanelHeight);
                    var isNeedVScroll = result.isNeedVScroll,
                        isNeedHScroll = result.isNeedHScroll;
                    if (isNeedHScroll)
                    {
                        if (!isNeedVScroll)
                        {
                            pageWidth += scrollbarSize
                        }
                        if (!self._hScrollbar)
                        {
                            self._hScrollbar = new Scrollbar(true);
                            var hScrollbarElement = self._hScrollbar.getScrollbar();
                            self._hbarContainer = document.createElement('div');
                            var $hbarContainer = $(self._hbarContainer);
                            $hbarContainer.css({
                                position: 'absolute', left: 0, bottom: 0, border: 'none', padding: 0, margin: 0
                            });
                            $hbarContainer.append(hScrollbarElement);
                            $container.append(self._hbarContainer)
                        }
                        $(self._hbarContainer).css({
                            width: pageWidth, height: scrollbarSize
                        });
                        var scrollH = self._hScrollbar,
                            $hScrollbarElement = $(self._hScrollbar.getScrollbar());
                        scrollH.width(pageWidth);
                        scrollH.height(scrollbarSize);
                        scrollH.minimum(0);
                        scrollH.maximum(contentWidth - pageWidth);
                        scrollH.pageValue(pageWidth);
                        scrollH.smallChange(self.horizontalSmallChange());
                        scrollH.largeChange(pageWidth);
                        scrollH.refreshLayout();
                        $hScrollbarElement.bind(e_scroll, function(e, args)
                        {
                            $tempContentWrapper.css('left', 0 - args.newValue)
                        });
                        $(self._hbarContainer).show();
                        self._showHorizontalScrollbar = true
                    }
                    else
                    {
                        if (self._hbarContainer)
                        {
                            $(self._hbarContainer).hide()
                        }
                        self._showHorizontalScrollbar = false
                    }
                    if (isNeedVScroll)
                    {
                        if (!isNeedHScroll)
                        {
                            pageHeight += scrollbarSize
                        }
                        if (!self._vScrollbar)
                        {
                            self._vScrollbar = new Scrollbar(false);
                            var vScrollbarElement = self._vScrollbar.getScrollbar();
                            self._vbarContainer = document.createElement('div');
                            var $vbarContainer = $(self._vbarContainer);
                            $vbarContainer.css({
                                position: 'absolute', right: 0, top: 0, border: 'none', padding: 0, margin: 0
                            });
                            $vbarContainer.append(vScrollbarElement);
                            $container.append(self._vbarContainer)
                        }
                        $(self._vbarContainer).css({
                            width: scrollbarSize, height: pageHeight
                        });
                        var scrollV = self._vScrollbar,
                            $vScrollbarElement = $(self._vScrollbar.getScrollbar());
                        scrollV.width(scrollbarSize);
                        scrollV.height(pageHeight);
                        scrollV.minimum(0);
                        scrollV.maximum(contentHeight - pageHeight);
                        scrollV.pageValue(pageHeight);
                        scrollV.smallChange(self.verticalSmallChange());
                        scrollV.largeChange(pageHeight);
                        scrollV.refreshLayout();
                        $vScrollbarElement.bind(e_scroll, function(e, args)
                        {
                            $tempContentWrapper.css('top', 0 - args.newValue)
                        });
                        $(self._vbarContainer).show();
                        self._showVerticalScrollbar = true
                    }
                    else
                    {
                        if (self._vbarContainer)
                        {
                            $(self._vbarContainer).hide()
                        }
                        self._showVerticalScrollbar = false
                    }
                    if (!isNeedHScroll && !isNeedVScroll)
                    {
                        pageWidth += scrollbarSize;
                        pageHeight += scrollbarSize
                    }
                    self._pageWidth = pageWidth;
                    self._pageHeight = pageHeight;
                    $contentWrapper.css({
                        width: pageWidth, height: pageHeight
                    });
                    if (isInitEvent)
                    {
                        $superPanel.append(self._container);
                        self._initEvent()
                    }
                };
                ScrollablePanel.prototype.scrollChildIntoView = function(item)
                {
                    var self = this;
                    var offset = self._getScrollOffset(item),
                        left = offset.left,
                        top = offset.top;
                    if (left !== keyword_null && self._hScrollbar)
                    {
                        self.hScrollTo(left)
                    }
                    if (top !== keyword_null && self._vScrollbar)
                    {
                        self.vScrollTo(top)
                    }
                };
                ScrollablePanel.prototype.hScrollTo = function(left)
                {
                    var self = this;
                    self._hScrollbar.value(left);
                    var pageWidth = self._pageWidth,
                        contentHeight = $(self._content).width();
                    if (left >= 0 && left <= contentHeight - pageWidth)
                    {
                        $(self._tempContentWrapper).css(css_left, 0 - left)
                    }
                };
                ScrollablePanel.prototype.vScrollTo = function(top)
                {
                    var self = this;
                    self._vScrollbar.value(top);
                    var pageHeight = self._pageHeight,
                        contentHeight = $(self._content).height();
                    if (top >= 0 && top <= contentHeight - pageHeight)
                    {
                        $(self._tempContentWrapper).css(css_top, 0 - top)
                    }
                };
                ScrollablePanel.prototype._isNeedScrollbars = function(contentWidth, contentHeight, superPanelWidth, superPanelHeight)
                {
                    var scrollbarSize = this._defaultScrollbarSize,
                        pageWidth = superPanelWidth - scrollbarSize,
                        pageHeight = superPanelHeight - scrollbarSize,
                        result = {
                            isNeedHScroll: false, isNeedVScroll: false
                        };
                    if (contentWidth > superPanelWidth)
                    {
                        result.isNeedHScroll = true;
                        if (contentHeight > pageHeight)
                        {
                            result.isNeedVScroll = true
                        }
                        else
                        {
                            result.isNeedVScroll = false
                        }
                    }
                    if (contentHeight > superPanelHeight)
                    {
                        result.isNeedVScroll = true;
                        if (contentWidth > pageWidth)
                        {
                            result.isNeedHScroll = true
                        }
                        else
                        {
                            result.isNeedHScroll = false
                        }
                    }
                    return result
                };
                ScrollablePanel.prototype._getScrollOffset = function(item)
                {
                    var $child = $(item),
                        $contentWrapper = $(this._contentWrapper),
                        $tempContentWrapper = $(this._tempContentWrapper),
                        childOffset,
                        tempContentWrapperOffset,
                        contentWrapperOffset,
                        leftDistance,
                        rightDistance,
                        topDistance,
                        bottomDistance,
                        result = {
                            left: keyword_null, top: keyword_null
                        };
                    if (!item)
                    {
                        return result
                    }
                    childOffset = $child.offset();
                    tempContentWrapperOffset = $tempContentWrapper.offset();
                    contentWrapperOffset = $contentWrapper.offset();
                    childOffset.leftWidth = childOffset.left + $child.outerWidth();
                    childOffset.topHeight = childOffset.top + $child.outerHeight();
                    contentWrapperOffset.leftWidth = contentWrapperOffset.left + $contentWrapper.outerWidth();
                    contentWrapperOffset.topHeight = contentWrapperOffset.top + $contentWrapper.outerHeight();
                    leftDistance = childOffset.left - tempContentWrapperOffset.left;
                    if (childOffset.left < contentWrapperOffset.left)
                    {
                        result.left = leftDistance
                    }
                    else if (childOffset.leftWidth > contentWrapperOffset.leftWidth)
                    {
                        rightDistance = childOffset.leftWidth - tempContentWrapperOffset.left - $contentWrapper.innerWidth();
                        if (leftDistance < rightDistance)
                        {
                            result.left = leftDistance
                        }
                        else
                        {
                            result.left = rightDistance
                        }
                    }
                    topDistance = childOffset.top - tempContentWrapperOffset.top;
                    if (childOffset.top < contentWrapperOffset.top)
                    {
                        result.top = topDistance
                    }
                    else if (childOffset.topHeight > contentWrapperOffset.topHeight)
                    {
                        bottomDistance = childOffset.topHeight - tempContentWrapperOffset.top - $contentWrapper.innerHeight();
                        if (topDistance < bottomDistance)
                        {
                            result.top = topDistance
                        }
                        else
                        {
                            result.top = bottomDistance
                        }
                    }
                    return result
                };
                ScrollablePanel.prototype._initEvent = function()
                {
                    var self = this;
                    if (this._tempContentWrapper)
                    {
                        self._mousewheelHandler = function(event)
                        {
                            self._contentContainerMousewheel(event)
                        };
                        EventUtil.addHandler(self._tempContentWrapper, e_mousewheel, self._mousewheelHandler);
                        EventUtil.addHandler(self._tempContentWrapper, e_dommousescroll, self._mousewheelHandler)
                    }
                };
                ScrollablePanel.prototype._contentContainerMousewheel = function(e)
                {
                    var self = this;
                    if ((typeof e.wheelDelta === const_undefined || e.wheelDelta === keyword_null) && (typeof e.detail === const_undefined || e.detail === keyword_null))
                    {
                        e.wheelDelta = e.originalEvent.wheelDelta;
                        e.detail = e.originalEvent.detail
                    }
                    var wheelData = e.detail ? e.detail : e.wheelDelta / -40,
                        dragOffset = wheelData;
                    var vScrollbar = self._vScrollbar,
                        topOffset = parseInt($(self._tempContentWrapper).css(css_top)),
                        pageHeight = self._pageHeight,
                        contentHeight = $(self._content).height();
                    if (contentHeight < pageHeight)
                    {
                        contentHeight = pageHeight
                    }
                    if (isNaN(topOffset))
                    {
                        topOffset = 0
                    }
                    var posOffset = topOffset - dragOffset * self.verticalSmallChange();
                    if (posOffset >= 0)
                    {
                        posOffset = 0
                    }
                    if (posOffset < 0 && 0 - posOffset > contentHeight - pageHeight)
                    {
                        posOffset = 0 - (contentHeight - pageHeight)
                    }
                    if (posOffset !== topOffset)
                    {
                        $(self._tempContentWrapper).css(css_top, posOffset);
                        if (self._showVerticalScrollbar)
                        {
                            vScrollbar.value(0 - posOffset)
                        }
                    }
                    Sheets.util.cancelDefault(e)
                };
                ScrollablePanel.prototype.dispose = function()
                {
                    var self = this;
                    if (self._container)
                    {
                        if (self._hScrollbar)
                        {
                            self._hScrollbar.dispose()
                        }
                        if (self._vScrollbar)
                        {
                            self._vScrollbar.dispose()
                        }
                        if (self._tempContentWrapper && self._mousewheelHandler)
                        {
                            EventUtil.removeHandler(self._tempContentWrapper, e_mousewheel, self._mousewheelHandler);
                            EventUtil.removeHandler(self._tempContentWrapper, e_dommousescroll, self._mousewheelHandler)
                        }
                        $(self._container).remove()
                    }
                };
                return ScrollablePanel
            })();
        Sheets.ScrollablePanel = ScrollablePanel;
        var Scrollbar = (function()
            {
                function Scrollbar(isHorizontalScroll, width, height, pageValue, maximum, minimum, scrollType)
                {
                    var self = this;
                    self._pageValue = 10;
                    self._maximum = 100;
                    self._minimum = 0;
                    self._value = 0;
                    self._largeChange = 10;
                    self._smallChange = 1;
                    self._scrollType = 1;
                    self._scrollPosition = 0;
                    self._isMousedownInScrollbar = false;
                    self._isMousedownInArrowButton = false;
                    self._scrollTimeOutArrow = keyword_null;
                    self._scrollTimeOutContainer = keyword_null;
                    self._initialDelay = 300;
                    self._trackClickPepeatFreq = 70;
                    self._isHorizontalScroll = isHorizontalScroll;
                    self._width = (typeof width === 'number') ? width : 0;
                    self._height = (typeof height === 'number') ? height : 0;
                    self._pageValue = (typeof pageValue === 'number') ? pageValue : 0;
                    self._maximum = (typeof maximum === 'number') ? maximum : 0;
                    self._minimum = (typeof minimum === 'number') ? minimum : 0;
                    self._scrollType = (typeof scrollType === 'number') ? scrollType : 1;
                    self._isMouseCapture = false;
                    self._scrollPosition = 0;
                    self._value = self._minimum;
                    self.refreshLayout()
                }
                Scrollbar.prototype.getScrollbar = function()
                {
                    return this._scrollContainerDiv
                };
                Scrollbar.prototype.smallChange = function(smallChange)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._smallChange
                    }
                    if (typeof smallChange === 'number' && self._smallChange !== smallChange)
                    {
                        self._smallChange = smallChange
                    }
                    return self
                };
                Scrollbar.prototype.largeChange = function(largeChange)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._largeChange
                    }
                    if (typeof largeChange === 'number' && self._largeChange !== largeChange)
                    {
                        self._largeChange = largeChange
                    }
                    return self
                };
                Scrollbar.prototype.pageValue = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._pageValue
                    }
                    if (typeof value === 'number' && self._pageValue !== value)
                    {
                        if (value <= 0)
                        {
                            value = 1
                        }
                        self._pageValue = value
                    }
                    return self
                };
                Scrollbar.prototype.maximum = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._maximum
                    }
                    if (typeof value === 'number' && self._maximum !== value)
                    {
                        if (value <= 0)
                        {
                            value = 0
                        }
                        self._maximum = value
                    }
                    return self
                };
                Scrollbar.prototype.minimum = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._minimum
                    }
                    if (typeof value === 'number' && self._minimum !== value)
                    {
                        if (value <= 0)
                        {
                            value = 0
                        }
                        self._minimum = value
                    }
                    return self
                };
                Scrollbar.prototype.value = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._value
                    }
                    if (typeof value === 'number' && value <= self._maximum && value >= self._minimum)
                    {
                        self._value = value;
                        var scrollPosition = (value - self._minimum) * self._scrollUnit;
                        self.scrollTo(scrollPosition, true)
                    }
                    return self
                };
                Scrollbar.prototype.width = function(width)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._width
                    }
                    if (typeof width === 'number' && self._width !== width)
                    {
                        self._width = width
                    }
                    return self
                };
                Scrollbar.prototype.height = function(height)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._height
                    }
                    if (typeof height === 'number' && self._height !== height)
                    {
                        self._height = height
                    }
                    return self
                };
                Scrollbar.prototype.scrollType = function(scrollType)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._scrollType
                    }
                    if (typeof(ScrollType[scrollType]) !== const_undefined && self._scrollType !== scrollType)
                    {
                        self._scrollType = scrollType
                    }
                    return self
                };
                Scrollbar.prototype.refreshLayout = function()
                {
                    var self = this;
                    var height = self._height,
                        width = self._width,
                        arrowWidth = height,
                        scrollbarContainerWidth = width - 2 * height,
                        scrollbarContainerHeight = arrowWidth,
                        css_scrollbarContainerPos = css_left,
                        css_scrollbarPos = css_right,
                        scrollbarWidth = 0,
                        scrollbarHeight = 0,
                        isInitEvent = false,
                        borderWidth = 2,
                        cssClass_startArrow = CSS_CLASS_ARROWLEFT,
                        cssClass_endArrow = CSS_CLASS_ARROWRIGHT,
                        cssClass_scrollbar = CSS_CLASS_HORIZONTALSCROLL,
                        css_scrollSpanMargin = css_marginLeft,
                        externalCssClass_PanelDiv = 'ui-widget ui-corner-all',
                        externalCssClass_ArrowStartDiv = 'ui-state-default ui-corner-bl btn btn-default',
                        externalCssClass_ArrowStartSpan = 'ui-icon ui-icon-triangle-1-w',
                        externalCssClass_Scroll = 'scroll-handle ui-state-default ui-corner-all ui-draggable btn btn-default',
                        externalCssClass_ScrollSpan = 'ui-icon ui-icon-grip-solid-vertical',
                        externalCssClass_ArrowEndDiv = 'ui-state-default ui-corner-br btn btn-default',
                        externalCssClass_ArrowEndSpan = 'ui-icon ui-icon-triangle-1-e';
                    ;
                    if (self._isHorizontalScroll)
                    {
                        self._scrollSize = scrollbarContainerWidth
                    }
                    else
                    {
                        arrowWidth = width;
                        scrollbarContainerWidth = arrowWidth;
                        scrollbarContainerHeight = height - 2 * width;
                        css_scrollbarContainerPos = css_top;
                        css_scrollbarPos = css_bottom;
                        self._scrollSize = scrollbarContainerHeight;
                        cssClass_startArrow = CSS_CLASS_ARROWUP;
                        cssClass_endArrow = CSS_CLASS_ARROWDOWN;
                        cssClass_scrollbar = CSS_CLASS_VERTICALSCROLL;
                        css_scrollSpanMargin = css_marginTop;
                        externalCssClass_ArrowStartDiv = 'ui-state-default ui-corner-tr btn btn-default';
                        externalCssClass_ArrowStartSpan = 'ui-icon ui-icon-triangle-1-n';
                        externalCssClass_Scroll = 'scroll-handle ui-state-default ui-corner-all ui-draggable btn btn-default';
                        externalCssClass_ScrollSpan = 'ui-icon ui-icon-grip-solid-horizontal';
                        externalCssClass_ArrowEndDiv = 'ui-state-default ui-corner-br btn btn-default';
                        externalCssClass_ArrowEndSpan = 'ui-icon ui-icon-triangle-1-s'
                    }
                    var scrollSize = self._scrollSize,
                        valueScope = self._maximum - self._minimum;
                    self._scrollbarSize = self._pageValue * scrollSize / (valueScope + self._pageValue);
                    if (self._scrollbarSize > scrollSize)
                    {
                        self._scrollbarSize = scrollSize
                    }
                    if (self._scrollbarSize < 10)
                    {
                        self._scrollbarSize = 10
                    }
                    var scrollbarSize = self._scrollbarSize;
                    if (valueScope !== 0)
                    {
                        self._scrollUnit = (scrollSize - scrollbarSize) / valueScope
                    }
                    else
                    {
                        self._scrollUnit = 1
                    }
                    if (self._isHorizontalScroll)
                    {
                        scrollbarWidth = scrollbarSize;
                        scrollbarHeight = arrowWidth
                    }
                    else
                    {
                        scrollbarWidth = arrowWidth;
                        scrollbarHeight = scrollbarSize
                    }
                    if (!self._scrollContainerDiv)
                    {
                        isInitEvent = true;
                        self._scrollContainerDiv = document.createElement("div");
                        $(self._scrollContainerDiv).css({
                            position: 'relative', left: 0, top: 0, overflow: 'hidden', outline: 'none', border: 'none', padding: 0, margin: 0
                        }).addClass(CSS_CLASS_SCROLLCONTAINER + " " + CSS_CLASS_SCROLLCONTAINERCORNER + " " + externalCssClass_PanelDiv)
                    }
                    var $scrollContainerDiv = $(self._scrollContainerDiv);
                    $scrollContainerDiv.css(css_width, width).css(css_height, height);
                    if (!self._arrowStartDiv)
                    {
                        self._arrowStartDiv = document.createElement("div");
                        $(self._arrowStartDiv).css({
                            position: 'absolute', display: 'inline-block', borderWidth: '1px', padding: 0, margin: 0, boxSizing: 'content-box'
                        }).addClass(CSS_CLASS_SCROLLARROW + " " + externalCssClass_ArrowStartDiv);
                        self._arrowStartSpan = document.createElement("span");
                        $(self._arrowStartSpan).css({
                            display: 'block', border: 'none', padding: 0, margin: 0
                        });
                        $(self._arrowStartSpan).addClass(cssClass_startArrow + " " + externalCssClass_ArrowStartSpan);
                        $(self._arrowStartDiv).append(self._arrowStartSpan);
                        $scrollContainerDiv.append(self._arrowStartDiv)
                    }
                    $(self._arrowStartDiv).css(css_scrollbarContainerPos, 0).css(css_width, arrowWidth - borderWidth).css(css_height, arrowWidth - borderWidth);
                    $(self._arrowStartSpan).css({
                        width: '100%', height: '100%'
                    });
                    if (!self._scrollbarWrapperDiv)
                    {
                        self._scrollbarWrapperDiv = document.createElement("div");
                        $(self._scrollbarWrapperDiv).css({
                            position: 'absolute', display: 'inline-block', boxSizing: 'content-box', border: 'none', padding: 0, margin: 0
                        }).addClass(CSS_CLASS_SCROLLBARWRAPPER + " " + CSS_CLASS_SCROLLBARWRAPPER);
                        $scrollContainerDiv.append(self._scrollbarWrapperDiv)
                    }
                    var $scrollbarWrapperDiv = $(self._scrollbarWrapperDiv);
                    $scrollbarWrapperDiv.css(css_scrollbarContainerPos, arrowWidth).css(css_width, scrollbarContainerWidth).css(css_height, scrollbarContainerHeight);
                    if (!self._scrollbarDiv)
                    {
                        self._scrollbarDiv = document.createElement("div");
                        $(self._scrollbarDiv).css({
                            position: 'absolute', borderWidth: '1px', padding: 0, margin: 0, boxSizing: 'content-box'
                        }).addClass(CSS_CLASS_SCROLLBAR + " " + CSS_CLASS_NONE_USER_SELECT + " " + externalCssClass_Scroll);
                        self._scrollbarSpan = document.createElement("span");
                        $(self._scrollbarSpan).css({
                            display: 'block', border: 'none', padding: 0, margin: 0
                        });
                        $(self._scrollbarSpan).addClass(cssClass_scrollbar + " " + externalCssClass_ScrollSpan);
                        $(self._scrollbarDiv).append(self._scrollbarSpan);
                        $scrollbarWrapperDiv.append(self._scrollbarDiv)
                    }
                    $(self._scrollbarDiv).css(css_scrollbarContainerPos, self._scrollPosition).css(css_width, Math.round(scrollbarWidth - borderWidth)).css(css_height, Math.round(scrollbarHeight - borderWidth));
                    $(self._scrollbarSpan).css({
                        width: arrowWidth - borderWidth, height: arrowWidth - borderWidth
                    });
                    $(self._scrollbarSpan).css(css_scrollSpanMargin, Math.floor((self._scrollbarSize - arrowWidth) / 2));
                    if (!self._arrowEndDiv)
                    {
                        self._arrowEndDiv = document.createElement("div");
                        $(self._arrowEndDiv).css({
                            position: 'absolute', display: 'inline-block', borderWidth: '1px', padding: 0, margin: 0, boxSizing: 'content-box'
                        }).addClass(CSS_CLASS_SCROLLARROW + " " + externalCssClass_ArrowEndDiv);
                        self._arrowEndSpan = document.createElement("span");
                        $(self._arrowEndSpan).css({
                            display: 'block', border: 'none', padding: 0, margin: 0
                        });
                        $(self._arrowEndSpan).addClass(cssClass_endArrow + " " + externalCssClass_ArrowEndSpan);
                        $(self._arrowEndDiv).append(self._arrowEndSpan);
                        $scrollContainerDiv.append(self._arrowEndDiv)
                    }
                    $(self._arrowEndDiv).css(css_scrollbarPos, 0).css(css_width, arrowWidth - borderWidth).css(css_height, arrowWidth - borderWidth);
                    $(self._arrowEndSpan).css({
                        width: '100%', height: '100%'
                    });
                    if (isInitEvent)
                    {
                        self._initEvents()
                    }
                };
                Scrollbar.prototype._initEvents = function()
                {
                    var self = this;
                    $(self._arrowStartDiv).bind(e_mousedown, function(e)
                    {
                        self._arrowMousedown(e, true)
                    }).bind(e_mouseup, function(e)
                    {
                        self._arrowMouseup(e, true)
                    }).bind(e_mouseover, function(e)
                    {
                        self._arrowMouseover(e, true)
                    }).bind(e_mouseout, function(e)
                    {
                        self._arrowMouseout(e, true)
                    });
                    $(self._arrowEndDiv).bind(e_mousedown, function(e)
                    {
                        self._arrowMousedown(e, false)
                    }).bind(e_mouseup, function(e)
                    {
                        self._arrowMouseup(e, false)
                    }).bind(e_mouseover, function(e)
                    {
                        self._arrowMouseover(e, false)
                    }).bind(e_mouseout, function(e)
                    {
                        self._arrowMouseout(e, false)
                    });
                    $(self._scrollbarDiv).bind(e_mousedown, function(e)
                    {
                        self._scrollbarMousedown(e)
                    }).bind(e_mousemove, function(e)
                    {
                        self._scrollbarMousemove(e)
                    }).bind(e_mouseup, function(e)
                    {
                        self._scrollbarMouseup(e)
                    }).bind(e_mouseover, function(e)
                    {
                        self._scrollbarMouseover(e)
                    }).bind(e_mouseout, function(e)
                    {
                        self._scrollbarMouseout(e)
                    });
                    $(self._scrollbarWrapperDiv).bind(e_mousedown, function(e)
                    {
                        var isFirefox = $.browser && $.browser.mozilla;
                        if (isFirefox)
                        {
                            var thisMouseDownTime = (new Date).valueOf();
                            var lastMouseDownTime = self._lastMouseDownTime;
                            self._lastMouseDownTime = thisMouseDownTime;
                            if (lastMouseDownTime && (thisMouseDownTime - lastMouseDownTime < 100))
                            {
                                return
                            }
                        }
                        self._scrollbarContainerMousedown(e)
                    }).bind(e_mouseup, function(e)
                    {
                        self._scrollbarContainerMouseup(e)
                    });
                    self._mousewheelHandler = function(event)
                    {
                        self._scrollContainerMousewheel(event)
                    };
                    EventUtil.addHandler(self._scrollContainerDiv, e_mousewheel, self._mousewheelHandler);
                    EventUtil.addHandler(self._scrollContainerDiv, e_dommousescroll, self._mousewheelHandler);
                    if (Sheets.features.touch)
                    {
                        self._simulateMouseEvents = new GcSpread.Sheets._SimulateMouseEvents;
                        self._simulateMouseEvents.bindUnBindTouchEvents(self._scrollContainerDiv, true, ns_scrollbar)
                    }
                };
                Scrollbar.prototype.dispose = function()
                {
                    var self = this,
                        scrollContainerDiv = self._scrollContainerDiv;
                    if (self._arrowEndDiv)
                    {
                        $(self._arrowEndDiv).unbind(ns_scrollbar)
                    }
                    if (self._scrollbarDiv)
                    {
                        $(self._scrollbarDiv).unbind(ns_scrollbar)
                    }
                    if (self._arrowStartDiv)
                    {
                        $(self._arrowStartDiv).unbind(ns_scrollbar)
                    }
                    if (self._scrollbarWrapperDiv)
                    {
                        $(self._scrollbarWrapperDiv).unbind(ns_scrollbar)
                    }
                    if (scrollContainerDiv)
                    {
                        if (self._mousewheelHandler)
                        {
                            EventUtil.removeHandler(scrollContainerDiv, e_mousewheel, self._mousewheelHandler);
                            EventUtil.removeHandler(scrollContainerDiv, e_dommousescroll, self._mousewheelHandler)
                        }
                        if (self._simulateMouseEvents)
                        {
                            self._simulateMouseEvents.bindUnBindTouchEvents(self._scrollContainerDiv, false, ns_scrollbar)
                        }
                        $(scrollContainerDiv).unbind(ns_scrollbar).remove()
                    }
                };
                Scrollbar.prototype._handleDocumentMouseMove = function()
                {
                    var self = this;
                    if (!self._isMouseCapture)
                    {
                        $(document).bind(e_mousemove, function(e)
                        {
                            self._scrollbarMousemove(e)
                        }).bind(e_mouseup, function(e)
                        {
                            self._scrollbarMouseup(e)
                        });
                        self._isMouseCapture = true
                    }
                };
                Scrollbar.prototype._unhandleDocumentMouseMove = function()
                {
                    if (this._isMouseCapture)
                    {
                        this._isMouseCapture = false;
                        $(document).unbind(e_mousemove).unbind(e_mouseup)
                    }
                };
                Scrollbar.prototype._arrowMousedown = function(e, isStart)
                {
                    var scrollValue = 0,
                        self = this,
                        isFirst = true;
                    self._isMousedownInArrowButton = true;
                    if (self._scrollTimeOutArrow !== null)
                    {
                        return
                    }
                    if (isStart)
                    {
                        $(self._arrowStartDiv).addClass('scrollbar-stateActive ui-state-active');
                        scrollValue = 0 - self._smallChange;
                        self._scrollEventType = 0
                    }
                    else
                    {
                        $(self._arrowEndDiv).addClass('scrollbar-stateActive ui-state-active');
                        scrollValue = self._smallChange;
                        self._scrollEventType = 1
                    }
                    var doScroll = function()
                        {
                            self.scrollTo(self._scrollPosition + scrollValue * self._scrollUnit, false);
                            if (self._scrollType === 1)
                            {
                                self._scrollTimeOutArrow = setTimeout(doScroll, isFirst ? self._initialDelay : self._trackClickPepeatFreq)
                            }
                            isFirst = false
                        };
                    doScroll()
                };
                Scrollbar.prototype._arrowMouseup = function(e, isStart)
                {
                    var self = this,
                        $arrowDiv = $(self._arrowStartDiv);
                    if (!isStart)
                    {
                        $arrowDiv = $(self._arrowEndDiv)
                    }
                    $arrowDiv.removeClass('scrollbar-stateActive ui-state-active');
                    self._endArrowScroll()
                };
                Scrollbar.prototype._arrowMouseover = function(e, isStart)
                {
                    var self = this;
                    var $arrowDiv = $(self._arrowStartDiv);
                    if (!isStart)
                    {
                        $arrowDiv = $(self._arrowEndDiv)
                    }
                    $arrowDiv.addClass('scrollbar-stateHover ui-state-hover')
                };
                Scrollbar.prototype._arrowMouseout = function(e, isStart)
                {
                    var self = this;
                    var $arrowDiv = $(self._arrowStartDiv);
                    if (!isStart)
                    {
                        $arrowDiv = $(self._arrowEndDiv)
                    }
                    $arrowDiv.removeClass('scrollbar-stateHover scrollbar-stateActive ui-state-hover ui-state-active');
                    self._endArrowScroll()
                };
                Scrollbar.prototype._scrollbarMousedown = function(e)
                {
                    var self = this;
                    if (e.button === 0)
                    {
                        self._isMousedownInScrollbar = true;
                        self._oldPosition = {
                            x: e.pageX, y: e.pageY
                        };
                        self._handleDocumentMouseMove();
                        $(self._scrollbarDiv).addClass('scrollbar-stateActive ui-state-active');
                        var scrollbarOffset = $(self._scrollbarDiv).offset(),
                            scrollbarWidth = $(self._scrollbarDiv).outerWidth(true),
                            scrollbarHeight = $(self._scrollbarDiv).outerHeight(true),
                            scrollbarWrapperOffset = $(self._scrollbarWrapperDiv).offset(),
                            scrollbarWrapperWidth = $(self._scrollbarWrapperDiv).outerWidth(true),
                            scrollbarWrapperHeight = $(self._scrollbarWrapperDiv).outerHeight(true);
                        self._edgePosition = {
                            isBeyondEdge: false, startEdgePosition: {
                                    x: scrollbarWrapperOffset.left + e.pageX - scrollbarOffset.left, y: scrollbarWrapperOffset.top + e.pageY - scrollbarOffset.top
                                }, endEdgePosition: {
                                    x: scrollbarWrapperOffset.left + scrollbarWrapperWidth - (scrollbarWidth - e.pageX + scrollbarOffset.left), y: scrollbarWrapperOffset.top + scrollbarWrapperHeight - (scrollbarHeight - e.pageY + scrollbarOffset.top)
                                }
                        }
                    }
                };
                Scrollbar.prototype._scrollbarMousemove = function(e)
                {
                    var self = this;
                    if (self._isMousedownInScrollbar)
                    {
                        self._currentPosition = {
                            x: e.pageX, y: e.pageY
                        };
                        self._scrollbarDrag();
                        self._oldPosition = self._currentPosition;
                        $(document.body).addClass(CSS_CLASS_NONE_USER_SELECT)
                    }
                };
                Scrollbar.prototype._scrollbarMouseup = function(e)
                {
                    var self = this;
                    self._isMousedownInScrollbar = false;
                    self._scrollEventType = 4;
                    self._edgePosition = null;
                    var args = {
                            newValue: self._value, oldValue: self._value, scrollOrientation: self._isHorizontalScroll ? 0 : 1, scrollEventType: self._scrollEventType
                        };
                    $(self._scrollContainerDiv).trigger(e_scroll, args);
                    var value = self._value,
                        fixScrollPosition = (value - self._minimum) * self._scrollUnit,
                        css_direction = 'left';
                    if (!self._isHorizontalScroll)
                    {
                        css_direction = 'top'
                    }
                    self._scrollPosition = fixScrollPosition;
                    $(self._scrollbarDiv).css(css_direction, fixScrollPosition);
                    self._unhandleDocumentMouseMove();
                    $(document.body).removeClass(CSS_CLASS_NONE_USER_SELECT);
                    $(self._scrollbarDiv).removeClass('scrollbar-stateActive ui-state-active');
                    self._scrollEventType = 6;
                    var args = {
                            newValue: self._value, oldValue: self._value, scrollOrientation: self._isHorizontalScroll ? 0 : 1, scrollEventType: self._scrollEventType
                        };
                    $(self._scrollContainerDiv).trigger(e_scroll, args)
                };
                Scrollbar.prototype._scrollbarMouseover = function(e)
                {
                    $(this._scrollbarDiv).addClass('scrollbar-stateHover ui-state-hover')
                };
                Scrollbar.prototype._scrollbarMouseout = function(e)
                {
                    $(this._scrollbarDiv).removeClass('scrollbar-stateHover ui-state-hover')
                };
                Scrollbar.prototype._scrollContainerMousewheel = function(e)
                {
                    var self = this;
                    if ((typeof e.wheelDelta === const_undefined || e.wheelDelta === keyword_null) && (typeof e.detail === const_undefined || e.detail === keyword_null))
                    {
                        e.wheelDelta = e.originalEvent.wheelDelta;
                        e.detail = e.originalEvent.detail
                    }
                    var wheelData = e.detail ? e.detail : e.wheelDelta / -40,
                        dragOffset = wheelData / 3 * self._smallChange * self._scrollUnit;
                    self._scrollEventType = dragOffset >= 0 ? 1 : 0;
                    self.scrollTo(self._scrollPosition + dragOffset, false);
                    self._scrollEventType = 6;
                    var args = {
                            newValue: self._value, oldValue: self._value, scrollOrientation: self._isHorizontalScroll ? 0 : 1, scrollEventType: self._scrollEventType
                        };
                    $(self._scrollContainerDiv).trigger(e_scroll, args);
                    Sheets.util.cancelDefault(e)
                };
                Scrollbar.prototype._scrollbarContainerMousedown = function(e)
                {
                    var self = this,
                        isFirst = true,
                        pageX = e.pageX,
                        pageY = e.pageY,
                        direction = 0,
                        offset = $(self._scrollbarWrapperDiv).offset(),
                        largetStepValue = self._largeChange;
                    if (self._scrollTimeOutContainer !== null)
                    {
                        return
                    }
                    if (self._isHorizontalScroll)
                    {
                        direction = pageX - offset.left - self._scrollPosition
                    }
                    else
                    {
                        direction = pageY - offset.top - self._scrollPosition
                    }
                    var doScroll = function()
                        {
                            var offset = $(self._scrollbarWrapperDiv).offset(),
                                pos = 0,
                                scrollPosition = self._scrollPosition;
                            if (self._isHorizontalScroll)
                            {
                                pos = pageX - offset.left - scrollPosition
                            }
                            else
                            {
                                pos = pageY - offset.top - scrollPosition
                            }
                            if (pos * direction < 0 || pos >= 0 && pos < self._scrollbarSize)
                            {
                                self._endContainerScroll();
                                return
                            }
                            if (direction < 0)
                            {
                                self._scrollEventType = 2;
                                self.scrollTo(scrollPosition - largetStepValue * self._scrollUnit, false)
                            }
                            else if (direction > 0)
                            {
                                self._scrollEventType = 3;
                                self.scrollTo(scrollPosition + largetStepValue * self._scrollUnit, false)
                            }
                            else
                            {
                                self._endContainerScroll();
                                return
                            }
                            if (self._scrollType === 1)
                            {
                                self._scrollTimeOutContainer = setTimeout(doScroll, isFirst ? self._initialDelay : self._trackClickPepeatFreq)
                            }
                            isFirst = false
                        };
                    doScroll()
                };
                Scrollbar.prototype._scrollbarContainerMouseup = function(e)
                {
                    this._endContainerScroll()
                };
                Scrollbar.prototype._endContainerScroll = function()
                {
                    var self = this;
                    self._scrollTimeOutContainer && clearTimeout(self._scrollTimeOutContainer);
                    self._scrollTimeOutContainer = keyword_null;
                    self._scrollEventType = 6;
                    var args = {
                            newValue: self._value, oldValue: self._value, scrollOrientation: self._isHorizontalScroll ? 0 : 1, scrollEventType: self._scrollEventType
                        };
                    $(self._scrollContainerDiv).trigger(e_scroll, args)
                };
                Scrollbar.prototype._endArrowScroll = function()
                {
                    var self = this;
                    if (self._isMousedownInArrowButton)
                    {
                        self._isMousedownInArrowButton = false;
                        self._scrollTimeOutArrow && clearTimeout(self._scrollTimeOutArrow);
                        self._scrollTimeOutArrow = keyword_null;
                        self._scrollEventType = 6;
                        var args = {
                                newValue: self._value, oldValue: self._value, scrollOrientation: self._isHorizontalScroll ? 0 : 1, scrollEventType: self._scrollEventType
                            };
                        $(self._scrollContainerDiv).trigger(e_scroll, args)
                    }
                };
                Scrollbar.prototype._scrollbarDrag = function()
                {
                    var self = this;
                    var destPosition = 0,
                        scrollPosition = self._scrollPosition,
                        currentPosition = self._currentPosition,
                        edgePosition = self._edgePosition;
                    if (self._isHorizontalScroll)
                    {
                        if (edgePosition && edgePosition.isBeyondEdge)
                        {
                            var startEdgePositionX = edgePosition.startEdgePosition.x,
                                endEdgePositionX = edgePosition.endEdgePosition.x,
                                isBeyondStart = currentPosition.x < startEdgePositionX,
                                isBeyondEnd = currentPosition.x > endEdgePositionX;
                            if (isBeyondStart || isBeyondEnd)
                            {
                                return
                            }
                            if (self._oldPosition.x < startEdgePositionX)
                            {
                                self._oldPosition.x = startEdgePositionX
                            }
                            if (self._oldPosition.x > endEdgePositionX)
                            {
                                self._oldPosition.x = endEdgePositionX
                            }
                        }
                        var dragOffsetH = currentPosition.x - self._oldPosition.x;
                        destPosition = scrollPosition + dragOffsetH
                    }
                    else
                    {
                        if (edgePosition && edgePosition.isBeyondEdge)
                        {
                            var startEdgePositionY = edgePosition.startEdgePosition.y,
                                endEdgePositionY = edgePosition.endEdgePosition.y,
                                isBeyondStart = currentPosition.y < startEdgePositionY,
                                isBeyondEnd = currentPosition.y > endEdgePositionY;
                            if (isBeyondStart || isBeyondEnd)
                            {
                                return
                            }
                        }
                        if (self._oldPosition.y < startEdgePositionY)
                        {
                            self._oldPosition.y = startEdgePositionY
                        }
                        if (self._oldPosition.y > endEdgePositionY)
                        {
                            self._oldPosition.y = endEdgePositionY
                        }
                        var dragOffsetV = currentPosition.y - self._oldPosition.y;
                        destPosition = scrollPosition + dragOffsetV
                    }
                    if (destPosition !== scrollPosition)
                    {
                        self._scrollEventType = 5;
                        self.scrollTo(destPosition, false)
                    }
                };
                Scrollbar.prototype.scrollTo = function(destPosition, notTriggerEvent)
                {
                    var self = this;
                    var css_direction = css_top,
                        scrollScope = self._scrollSize - self._scrollbarSize,
                        direction = '',
                        scrollPosition = self._scrollPosition,
                        ScrollOrientation = Sheets.ScrollOrientation;
                    if (self._isHorizontalScroll)
                    {
                        css_direction = css_left
                    }
                    var isBeyondEdge = false;
                    if (destPosition > scrollScope)
                    {
                        destPosition = scrollScope;
                        isBeyondEdge = true
                    }
                    if (destPosition < 0)
                    {
                        destPosition = 0;
                        isBeyondEdge = true
                    }
                    if (self._edgePosition)
                    {
                        self._edgePosition.isBeyondEdge = isBeyondEdge
                    }
                    var newValue = Math.round(destPosition / self._scrollUnit) + self._minimum,
                        oldValue = self._value,
                        ignoreUpdatePosition = false;
                    if (!notTriggerEvent)
                    {
                        var args = {
                                newValue: newValue, oldValue: oldValue, scrollOrientation: self._isHorizontalScroll ? 0 : 1, scrollEventType: self._scrollEventType
                            };
                        $(self._scrollContainerDiv).trigger(e_scroll, args);
                        ignoreUpdatePosition = args.ignoreUpdatePosition;
                        if (args.newValue > self._maximum)
                        {
                            args.newValue = self._maximum
                        }
                        newValue = args.newValue
                    }
                    self._value = newValue;
                    if (self._scrollEventType !== 5)
                    {
                        destPosition = (newValue - self._minimum) * self._scrollUnit
                    }
                    self._scrollPosition = destPosition;
                    if (!ignoreUpdatePosition)
                    {
                        $(self._scrollbarDiv).css(css_direction, destPosition)
                    }
                };
                return Scrollbar
            })();
        Sheets.Scrollbar = Scrollbar
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var __extends = this.__extends || function(d, b)
    {
        for (var p in b)
            if (b.hasOwnProperty(p))
                d[p] = b[p];
        function __()
        {
            this.constructor = d
        }
        __.prototype = b.prototype;
        d.prototype = new __
    };
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.basecelltype", ["core.common", "core.globalize", "core.theme"]);
        var document = window.document,
            cssPositoin = "position",
            cssAbsolute = "absolute",
            cssMargin = "margin",
            cssFont = "font",
            cssClass = "class",
            cssLeft = "left",
            cssRight = "right",
            cssTop = "top",
            cssAlphabetic = "alphabetic",
            cssCenter = "center",
            attrGcUIElement = "gcUIElement",
            cssNone = "none",
            attrTabIndex = "tabindex",
            zero = "0",
            selectedFillColor = "#9fa9c5",
            gradientColorStop1 = "#f6fafb",
            gradientColorStop2 = "#d2dbeb",
            _gcEditingInput = ".gcEditingInput",
            _keyDown_gcEditingInput = "keydown" + _gcEditingInput,
            _keyUp_gcEditingInput = "keyup" + _gcEditingInput,
            _paste_gcEditingInput = "paste" + _gcEditingInput,
            _mousedown_gcEditingInput = "mousedown" + _gcEditingInput,
            _compositionstart_gcEditingInput = "compositionstart" + _gcEditingInput,
            _compositionupdaten_gcEditingInput = "compositionupdate" + _gcEditingInput,
            _compositionend_gcEditingInput = "compositionend" + _gcEditingInput,
            cssWidth = "width",
            cssHeight = "height",
            cssPadding = "padding",
            cssPaddingLeft = "padding-left",
            cssPaddingRight = "padding-right",
            cssPaddingTop = "padding-top",
            cssPaddingBottom = "padding-bottom",
            cssTextAlign = "text-align",
            cssHidden = "hidden",
            cssVisibility = "visibility",
            cssWordWrap = "word-wrap",
            cssOverflow = "overflow",
            cssNormal = "normal",
            cssBreakWord = "break-word",
            cssOverflowY = "overflow-y",
            cssResize = "resize",
            cssBorder = "border",
            cssOutline = "outline",
            cssBoxShadow = "box-shadow",
            cssBoxSizing = "box-sizing",
            cssAutoComplete = "autocomplete",
            cssColor = "color",
            cssBorderWidth = "border-width",
            cssBackgroundColor = "background-color",
            cssZIndex = "z-index",
            cssTextDecoration = "text-decoration",
            cssImeMode = "ime-mode",
            cssOverline = "overline",
            cssLineThrough = "line-through",
            cssUnderline = "underline",
            watermarkOpacity = 0.337,
            const_undefined = "undefined",
            keyword_undefined = undefined,
            keyword_null = null,
            Math_floor = Math.floor,
            Math_ceil = Math.ceil,
            Math_min = Math.min,
            Math_max = Math.max;
        var CellTypeContext = (function()
            {
                function CellTypeContext(){}
                CellTypeContext.getAutoFitWidth = function(value, text, cellStyle, zoomFactor, context)
                {
                    var width = 0;
                    var sheet = context && context.sheet;
                    if (sheet && typeof text === "string" && text !== "")
                    {
                        if (cellStyle.wordWrap)
                        {
                            var indent = 0,
                                textIndent = cellStyle.textIndent;
                            if (textIndent > 0)
                            {
                                indent = textIndent * 8
                            }
                            var lines = text.split(/\r\n|\r|\n/);
                            for (var i = 0; i < lines.length; i++)
                            {
                                width = Math_max(width, Sheets._WordWrapHelper._measureTextWithoutEndSpaces(lines[i], cellStyle.font) / zoomFactor)
                            }
                        }
                        else
                        {
                            width = sheet._getStringWidthByCanvas(text, cellStyle.font) / zoomFactor
                        }
                        if (cellStyle.hAlign !== 1 && cellStyle.textIndent > 0)
                        {
                            width += cellStyle.textIndent * 8 / zoomFactor
                        }
                    }
                    return width
                };
                CellTypeContext.getAutoFitHeight = function(value, text, cellStyle, zoomFactor, context)
                {
                    var height = 0;
                    var sheet = context && context.sheet;
                    if (sheet && typeof text === "string" && text !== "")
                    {
                        var lineHeight = sheet._getFontHeight(cellStyle.font) / zoomFactor;
                        if (cellStyle.wordWrap)
                        {
                            var indent = 0,
                                textIndent = cellStyle.textIndent;
                            if (textIndent > 0)
                            {
                                indent = textIndent * 8
                            }
                            var row = context.row,
                                col = context.col,
                                sheetArea = context.sheetArea;
                            var columnWidth = 0;
                            var span = sheet._getSpanModel(sheetArea).find(row, col);
                            if (span)
                            {
                                if (span.row < row || span.rowCount > 1 || span.col < col)
                                {}
                                else if (col == span.col)
                                {
                                    columnWidth = sheet.getColumnWidth(col);
                                    if (span.colCount > 1)
                                    {
                                        for (var colIdx = (col + 1); colIdx < (col + span.colCount); colIdx++)
                                        {
                                            columnWidth += sheet.getColumnWidth(colIdx)
                                        }
                                    }
                                }
                            }
                            else
                            {
                                columnWidth = sheet.getColumnWidth(col)
                            }
                            var lines = Sheets._WordWrapHelper._getWrapInfo(text, columnWidth - 3 - indent, cellStyle.font);
                            height = lines.length * lineHeight
                        }
                        else
                        {
                            height = lineHeight
                        }
                    }
                    return height
                };
                CellTypeContext.paintBackground = function(ctx, x, y, w, h, backColor, backgroundImage, backgroundImageLayout, imageLoader)
                {
                    if (!backColor && !backgroundImage)
                    {
                        return
                    }
                    ctx.save();
                    ctx.beginPath();
                    if (backColor)
                    {
                        if (ctx.fillStyle !== backColor)
                        {
                            ctx.fillStyle = backColor
                        }
                        ctx.fillRect(x, y, w, h)
                    }
                    if (backgroundImage && backgroundImage !== cssNone && imageLoader)
                    {
                        try
                        {
                            if (imageLoader.getState(backgroundImage))
                            {
                                var bkImg = imageLoader.getImage(backgroundImage);
                                var imgWidth = bkImg.width;
                                var imgHeight = bkImg.height;
                                var sx = 0,
                                    sy = 0,
                                    swidth = imgWidth,
                                    sheight = imgHeight,
                                    useWidth = w,
                                    useHeight = h;
                                var px = x,
                                    py = y;
                                switch (backgroundImageLayout)
                                {
                                    case 0:
                                        break;
                                    case 1:
                                        swidth = w >= imgWidth ? imgWidth : w;
                                        sheight = h >= imgHeight ? imgHeight : h;
                                        px = (w > imgWidth) && (imgWidth > 0) ? Math_ceil(x + w / 2 - imgWidth / 2) : x;
                                        py = (h > imgHeight) && (imgHeight > 0) ? Math_ceil(y + h / 2 - imgHeight / 2) : y;
                                        useWidth = swidth;
                                        useHeight = sheight;
                                        break;
                                    case 2:
                                        if (h > 0 && imgHeight > 0 && w / h > imgWidth / imgHeight)
                                        {
                                            useWidth = imgWidth / imgHeight * h;
                                            px = x + w / 2 - useWidth / 2
                                        }
                                        else if (w > 0 && imgWidth > 0 && h / w > imgHeight / imgWidth)
                                        {
                                            useHeight = imgHeight / imgWidth * w;
                                            py = y + h / 2 - useHeight / 2
                                        }
                                        break;
                                    case 3:
                                        swidth = w >= imgWidth ? imgWidth : w;
                                        sheight = h >= imgHeight ? imgHeight : h;
                                        useWidth = swidth;
                                        useHeight = sheight;
                                        break;
                                    default:
                                        break
                                }
                                var ratioX = Sheets.DPIHelper.getScaleX(ctx),
                                    ratioY = Sheets.DPIHelper.getScaleY(ctx);
                                ctx.drawImage(bkImg, sx * ratioX, sy * ratioY, swidth * ratioX, sheight * ratioY, px * ratioX, py * ratioY, useWidth * ratioX, useHeight * ratioY)
                            }
                            else
                            {
                                imageLoader.addImage(backgroundImage)
                            }
                        }
                        catch(ex) {}
                    }
                    ctx.restore()
                };
                CellTypeContext.paintConditionalFormats = function(ctx, value, x, y, w, h, style, options)
                {
                    var conditionalFormats = options.conditionalFormats;
                    if (!conditionalFormats || conditionalFormats.count() <= 0)
                    {
                        return
                    }
                    var sheet = options.sheet,
                        row = options.row,
                        col = options.col,
                        iconSet,
                        dataBar;
                    var caches = sheet._cachePool.getConditionalFormat(row, col);
                    if (caches)
                    {
                        iconSet = caches.i;
                        dataBar = caches.d;
                        if (!iconSet && !dataBar)
                        {
                            return false
                        }
                    }
                    else
                    {
                        var rules = conditionalFormats.getRules(row, col),
                            rulesLength = rules.length;
                        if (rulesLength <= 0)
                        {
                            sheet._cachePool.setConditionalFormat(row, col, dataBar, iconSet);
                            return false
                        }
                        var showBarOnly = false,
                            showIconOnly = false,
                            dataBarRule = keyword_null,
                            iconSetRule = keyword_null,
                            rule = keyword_null,
                            obj = keyword_null;
                        rules.sort(function(a, b)
                        {
                            return a.priority() - b.priority()
                        });
                        for (var n = 0; n < rulesLength; n++)
                        {
                            rule = rules[n];
                            if (rule)
                            {
                                if (!dataBarRule && rule instanceof Sheets.DataBarRule)
                                {
                                    dataBarRule = rule
                                }
                                else if (!iconSetRule && rule instanceof Sheets.IconSetRule)
                                {
                                    iconSetRule = rule
                                }
                                if (rule.stopIfTrue())
                                {
                                    obj = rule.evaluate(sheet, row, col, value);
                                    if (obj)
                                    {
                                        break
                                    }
                                }
                            }
                        }
                        if (dataBarRule)
                        {
                            dataBar = dataBarRule.evaluate(sheet, row, col, value)
                        }
                        if (iconSetRule)
                        {
                            iconSet = iconSetRule.evaluate(sheet, row, col, value)
                        }
                        sheet._cachePool.setConditionalFormat(row, col, dataBar, iconSet)
                    }
                    ctx.save();
                    ctx.beginPath();
                    if (dataBar)
                    {
                        Sheets.DataBarRule.paintDataBar(ctx, dataBar, x, y, w, h);
                        showBarOnly = dataBar.showBarOnly
                    }
                    if (iconSet)
                    {
                        if (w < 16 || h < 16)
                        {
                            ctx.rect(x, y, w, h);
                            ctx.clip();
                            ctx.beginPath()
                        }
                        Sheets.IconSetRule.paintIconSet(ctx, iconSet, x, y, w, h, style, options.imageLoader);
                        showIconOnly = iconSet.showIconOnly
                    }
                    ctx.restore();
                    return (showBarOnly || showIconOnly)
                };
                CellTypeContext.paintSparkline = function(ctx, x, y, w, h, sparkline)
                {
                    if (sparkline)
                    {
                        sparkline.paintSparkline(ctx, x, y, w, h)
                    }
                };
                CellTypeContext.paintSparklineEx = function(ctx, value, x, y, w, h, sheet)
                {
                    if (Sheets.features.sparklineEx && value instanceof Sheets.SparklineExValue)
                    {
                        var sp = sheet && sheet.parent;
                        if (sp)
                        {
                            var sparklineEx = sp.getSparklineEx(value.name);
                            if (sparklineEx)
                            {
                                sparklineEx._paintSparkline(ctx, value.value, x, y, w, h, sheet);
                                return true
                            }
                        }
                    }
                    return false
                };
                return CellTypeContext
            })();
        Sheets.CellTypeContext = CellTypeContext;
        var BaseCellType = (function()
            {
                function BaseCellType()
                {
                    this.allowOverflow = false;
                    this.typeName = 0 + ''
                }
                BaseCellType.prototype.paintValue = function(ctx, value, x, y, w, h, style, options)
                {
                    var conditionalForeColor = {value: keyword_null},
                        text;
                    text = this.format(value, style.formatter || style._autoFormatter, conditionalForeColor);
                    if (!text)
                    {
                        return
                    }
                    this.paintText(ctx, value, x, y, w, h, style, options, text, conditionalForeColor)
                };
                BaseCellType.prototype.paintText = function(ctx, value, x, y, w, h, style, options, text, conditionalForeColor, opacity)
                {
                    ctx.save();
                    ctx.beginPath();
                    var fillStyle = style.foreColor,
                        font = style.font;
                    if (conditionalForeColor.value)
                    {
                        fillStyle = conditionalForeColor.value
                    }
                    if (typeof opacity !== const_undefined)
                    {
                        var color = Sheets._Color.parse(fillStyle);
                        color.a = opacity;
                        fillStyle = color.toString()
                    }
                    if (fillStyle && ctx.fillStyle !== fillStyle)
                    {
                        ctx.fillStyle = fillStyle
                    }
                    if (font && ctx.font !== font)
                    {
                        ctx.font = font
                    }
                    var indent = 0,
                        textIndent = style.textIndent,
                        wordWrap = style.wordWrap,
                        hAlign = style.hAlign,
                        vAlign = style.vAlign,
                        textDecoration = style.textDecoration,
                        textAlign = cssLeft,
                        textBaseline = cssAlphabetic,
                        adjX = 2,
                        adjY = 2,
                        textHeight = 0,
                        lineHeight = options.lineHeight,
                        lines = [],
                        lineCount = 0,
                        fontSize = options.fontInfo.fontSize;
                    if (textIndent > 0)
                    {
                        indent = textIndent * 8
                    }
                    if (hAlign === 3)
                    {
                        hAlign = Sheets.util.getHAlignByValueType(hAlign, value, style.formatter)
                    }
                    adjX += indent;
                    if (hAlign === 1)
                    {
                        adjX = w / 2;
                        textAlign = cssCenter
                    }
                    else if (hAlign === 2)
                    {
                        adjX = w - 1 - 2;
                        adjX -= indent;
                        textAlign = cssRight
                    }
                    if (ctx.textAlign !== textAlign)
                    {
                        ctx.textAlign = textAlign
                    }
                    if (wordWrap)
                    {
                        lines = Sheets._WordWrapHelper._getWrapInfo(text, w - 3 - indent, font);
                        lineCount = lines.length;
                        if (lineCount > 1 && vAlign !== 0)
                        {
                            textHeight = (lineCount - 1) * lineHeight
                        }
                    }
                    var baselineOffset = fontSize > 8 ? Math_floor((fontSize - 8) / 5 + 2) : 1,
                        lineOffset = lineHeight / 2 - fontSize / 2 + baselineOffset - 1;
                    adjY += lineHeight - lineOffset;
                    if (vAlign === 1)
                    {
                        adjY = (h - textHeight) / 2 + lineHeight / 2 - lineOffset
                    }
                    else if (vAlign === 2)
                    {
                        adjY = h - textHeight - 2 - lineOffset
                    }
                    if (ctx.textBaseline !== textBaseline)
                    {
                        ctx.textBaseline = textBaseline
                    }
                    var clipRect = {
                            x: x, y: y, width: w - 1, height: h
                        },
                        cellOverflowlayout = options.cellOverflowLayout,
                        layout = (cellOverflowlayout && cellOverflowlayout.layout);
                    if (layout)
                    {
                        clipRect = {
                            x: layout.x, y: layout.y, width: layout.width, height: layout.height
                        }
                    }
                    if (wordWrap)
                    {
                        ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                        ctx.clip();
                        ctx.beginPath();
                        var vpos = y + adjY;
                        for (var i = 0; i < lineCount; i++)
                        {
                            ctx.fillText(lines[i], x + adjX, vpos);
                            if (textDecoration)
                            {
                                var textLength = ctx.measureText(lines[i]).width;
                                this._renderTextDecoration(ctx, textDecoration, x + adjX, vpos, textLength, fontSize, baselineOffset)
                            }
                            vpos += lineHeight
                        }
                    }
                    else
                    {
                        var txtWidth = ctx.measureText(text).width,
                            clipWidth = clipRect.width,
                            clipHeight = clipRect.height,
                            needClip = (txtWidth > clipWidth || lineHeight > clipHeight);
                        if (!needClip)
                        {
                            if (hAlign === 1)
                            {
                                if (cellOverflowlayout)
                                {
                                    var txtHalfWidth = txtWidth / 2;
                                    if (txtHalfWidth > cellOverflowlayout.backgroundLeftWidth || txtHalfWidth > cellOverflowlayout.backgroundRightWidth)
                                    {
                                        needClip = true
                                    }
                                }
                            }
                            else
                            {
                                if (txtWidth + indent > clipWidth)
                                {
                                    needClip = true
                                }
                            }
                        }
                        if (needClip)
                        {
                            ctx.rect(clipRect.x, clipRect.y, clipWidth, clipHeight);
                            ctx.clip();
                            ctx.beginPath()
                        }
                        ctx.fillText(text, x + adjX, y + adjY);
                        if (textDecoration)
                        {
                            this._renderTextDecoration(ctx, textDecoration, x + adjX, y + adjY, txtWidth, fontSize, baselineOffset)
                        }
                    }
                    ctx.restore()
                };
                BaseCellType.prototype.paint = function(ctx, value, x, y, w, h, style, context){};
                BaseCellType.prototype.createEditorElement = function(context)
                {
                    return keyword_null
                };
                BaseCellType.prototype._getLocator = function()
                {
                    var span = document.createElement("span");
                    $(span).css(cssPositoin, cssAbsolute).css(cssVisibility, cssHidden).css(cssBackgroundColor, "#68E").css(cssMargin, zero).css(cssPadding, "2px").css(cssFont, "normal 12px Arial").css(cssColor, "white").css(cssBorderWidth, zero).attr(cssClass, "gc-input-locator").attr(attrGcUIElement, "gcEditingLocator");
                    return span
                };
                BaseCellType.prototype.getEditorValue = function(editorContext, context)
                {
                    return keyword_null
                };
                BaseCellType.prototype._formatEditorValue = function(editorContext, cellStyle, value, context)
                {
                    return value
                };
                BaseCellType.prototype.setEditorValue = function(editorContext, value, context){};
                BaseCellType.prototype.getEditingElement = function()
                {
                    return keyword_null
                };
                BaseCellType.prototype.parse = function(text, formatStr, context)
                {
                    var formatStrIsNull = (typeof(formatStr) === const_undefined || formatStr === keyword_null),
                        textIsNull = (typeof(text) === const_undefined || text === keyword_null);
                    if (formatStrIsNull || textIsNull)
                    {
                        return textIsNull ? "" : text.toString()
                    }
                    else
                    {
                        try
                        {
                            if (Sheets.features.formatter)
                            {
                                var formatter = (typeof(formatStr) === 'string' ? new Sheets.GeneralFormatter(formatStr) : formatStr);
                                return formatter.Parse(text)
                            }
                            else
                            {
                                return text.toString()
                            }
                        }
                        catch(ex)
                        {
                            return text.toString()
                        }
                    }
                };
                BaseCellType.prototype.format = function(value, format, conditionalForeColor, context)
                {
                    if (value === keyword_undefined || value === keyword_null || value === "")
                    {
                        return ''
                    }
                    if (typeof format === "string" && typeof value !== "object")
                    {
                        return Sheets._CacheMgr.getFormattedText(value, format, conditionalForeColor)
                    }
                    if (!format)
                    {
                        if (typeof value === 'boolean' || value instanceof Boolean)
                        {
                            return value.toString().toUpperCase()
                        }
                        else if (value instanceof Date)
                        {
                            return new Sheets._DateTimeHelper(value).localeFormat("M/d/yyyy h:mm:ss")
                        }
                        if (typeof value === "number")
                        {
                            value = Sheets._NumberHelper.replaceNormalToCultureSymble(value.toString())
                        }
                        return value.toString()
                    }
                    else
                    {
                        try
                        {
                            if (Sheets.features.formatter)
                            {
                                var formatter = keyword_null;
                                if (typeof format === "string")
                                {
                                    formatter = Sheets._CacheMgr.getFormatter(format)
                                }
                                else
                                {
                                    formatter = format
                                }
                                var isNumber = typeof value === "number";
                                var isNumberString = Sheets.util.isStringNumber(value);
                                if (!isNumber && isNumberString)
                                {
                                    value = Sheets._NumberHelper.replaceCultureSymbolToNormal(value)
                                }
                                var result = formatter.Format(value, conditionalForeColor);
                                if (isNumberString)
                                {
                                    result = Sheets._NumberHelper.replaceNormalToCultureSymble(result)
                                }
                                return result
                            }
                            else
                            {
                                return value.toString()
                            }
                        }
                        catch(ex)
                        {
                            return value.toString()
                        }
                    }
                };
                BaseCellType.prototype.focus = function(editorContext, context)
                {
                    if (editorContext && editorContext.focus)
                    {
                        editorContext.focus()
                    }
                };
                BaseCellType.prototype.getThemeStyle = function(visualState, defaultClass)
                {
                    return Sheets.Global.prototype.getExternalThemeStyle(visualState, defaultClass)
                };
                BaseCellType.prototype.activateEditor = function(editorContext, cellStyle, cellRect, context){};
                BaseCellType.prototype.deactivateEditor = function(editorContext, context){};
                BaseCellType.prototype.selectAll = function(editorContext, context)
                {
                    if (editorContext && editorContext.select)
                    {
                        editorContext.select()
                    }
                };
                BaseCellType.prototype.updateEditor = function(editorContext, cellStyle, cellRect, context){};
                BaseCellType.prototype.setImeMode = function(editorContext, imeMode, context)
                {
                    if (this.isImeAware(context))
                    {
                        this.updateImeMode(editorContext, imeMode, context)
                    }
                    else if (editorContext)
                    {
                        $(editorContext).css(cssImeMode, this._getImeModeString(0))
                    }
                };
                BaseCellType.prototype.updateImeMode = function(editorContext, imeMode, context)
                {
                    if (editorContext)
                    {
                        $(editorContext).css(cssImeMode, this._getImeModeString(imeMode))
                    }
                };
                BaseCellType.prototype._getImeModeString = function(imeMode)
                {
                    var cssImeModeString = "";
                    if (imeMode === keyword_undefined)
                    {
                        imeMode = 1
                    }
                    switch (imeMode)
                    {
                        case 1:
                            cssImeModeString = "auto";
                            break;
                        case 2:
                            cssImeModeString = "active";
                            break;
                        case 4:
                            cssImeModeString = "inactive";
                            break;
                        case 0:
                            cssImeModeString = "disabled";
                            break
                    }
                    return cssImeModeString
                };
                BaseCellType.prototype._updateEditorLocator = function(editorContext, context)
                {
                    var sheet = (editorContext && context && context.sheet);
                    if (sheet && sheet.isEditing() && sheet.showEditingLocator)
                    {
                        var locator = editorContext._editingLocator,
                            $editor = $(editorContext);
                        if (locator)
                        {
                            $(locator).css(cssTop, parseInt($editor.css(cssTop), 10) - 18).css(cssLeft, parseInt($editor.css(cssLeft), 10))
                        }
                    }
                };
                BaseCellType.prototype.getHitInfo = function(x, y, cellStyle, cellRect, context)
                {
                    return keyword_null
                };
                BaseCellType.prototype.processMouseDown = function(hitInfo)
                {
                    return false
                };
                BaseCellType.prototype.processMouseMove = function(hitInfo)
                {
                    return false
                };
                BaseCellType.prototype.processMouseUp = function(hitInfo)
                {
                    return false
                };
                BaseCellType.prototype.processMouseEnter = function(hitInfo){};
                BaseCellType.prototype.processMouseLeave = function(hitInfo){};
                BaseCellType.prototype.isReservedKey = function(e, context)
                {
                    return false
                };
                BaseCellType.prototype.isEditingValueChanged = function(oldValue, newValue, context)
                {
                    return oldValue !== newValue
                };
                BaseCellType.prototype.processKeyDown = function(event, context)
                {
                    return false
                };
                BaseCellType.prototype.processKeyUp = function(event, context)
                {
                    return false
                };
                BaseCellType.prototype.getAutoFitWidth = function(value, text, cellStyle, zoomFactor, context)
                {
                    return 0
                };
                BaseCellType.prototype.getAutoFitHeight = function(value, text, cellStyle, zoomFactor, context)
                {
                    return 0
                };
                BaseCellType.prototype._renderTextDecoration = function(ctx, textDecoration, x, y, textLength, fontSize, offset)
                {
                    ctx.strokeStyle = ctx.fillStyle;
                    var vposY = 0,
                        lineWidth = 0,
                        posOffset = 0.5,
                        fontSizeTemp;
                    fontSizeTemp = fontSize <= 12 ? 12 : fontSize;
                    lineWidth = Math_floor((fontSizeTemp - 12) / 21 + 1);
                    ctx.lineWidth = lineWidth;
                    if ((lineWidth & 1) === 0)
                    {
                        posOffset = 0
                    }
                    if (ctx.textAlign === cssCenter)
                    {
                        x = x - textLength / 2
                    }
                    else if (ctx.textAlign === cssRight)
                    {
                        x = x - textLength
                    }
                    ctx.beginPath();
                    if ((textDecoration & 4) === 4)
                    {
                        vposY = Math_ceil(y + offset - fontSize - 1) - posOffset;
                        ctx.moveTo(x, vposY);
                        ctx.lineTo(x + textLength, vposY)
                    }
                    if ((textDecoration & 2) === 2)
                    {
                        vposY = Math_ceil(y + offset - fontSize / 2) - posOffset;
                        ctx.moveTo(x, vposY);
                        ctx.lineTo(x + textLength, vposY)
                    }
                    if ((textDecoration & 1) === 1)
                    {
                        vposY = Math_ceil(y + offset - 1) - posOffset;
                        ctx.moveTo(x, vposY);
                        ctx.lineTo(x + textLength, vposY)
                    }
                    ctx.stroke()
                };
                BaseCellType.prototype._setEditStatusTextDecoration = function(content, textDecorationType)
                {
                    var textDecoration = "";
                    if ((textDecorationType & 4) === 4)
                    {
                        textDecoration = cssOverline
                    }
                    if ((textDecorationType & 2) === 2)
                    {
                        textDecoration += " " + cssLineThrough
                    }
                    if ((textDecorationType & 1) === 1)
                    {
                        textDecoration += " " + cssUnderline
                    }
                    content.css(cssTextDecoration, textDecoration)
                };
                BaseCellType.prototype.isImeAware = function(context)
                {
                    return false
                };
                BaseCellType.prototype.isEditting = function()
                {
                    return false
                };
                BaseCellType.prototype.toJSON = function()
                {
                    return {typeName: this.typeName}
                };
                BaseCellType.prototype.fromJSON = function(settings, isNoneSchema){};
                return BaseCellType
            })();
        Sheets.BaseCellType = BaseCellType;
        var TextCellType = (function(_super)
            {
                __extends(TextCellType, _super);
                function TextCellType()
                {
                    _super.call(this);
                    this.allowOverflow = true;
                    this.typeName = 1 + ''
                }
                TextCellType.prototype.paint = function(ctx, value, x, y, w, h, style, context)
                {
                    if (!ctx)
                    {
                        return
                    }
                    if (!context || !context.parentBackColor || context.parentBackColor !== style.backColor)
                    {
                        CellTypeContext.paintBackground(ctx, x, y, w, h, style.backColor, style.backgroundImage, style.backgroundImageLayout, context.imageLoader)
                    }
                    var showBarIconOnly = CellTypeContext.paintConditionalFormats(ctx, value, x, y, w, h, style, context);
                    context.showBarIconOnly = showBarIconOnly;
                    CellTypeContext.paintSparkline(ctx, x, y, w, h, context.sparkline);
                    var showSparklineEx = CellTypeContext.paintSparklineEx(ctx, value, x, y, w, h, context.sheet);
                    if (!context.cellOverflowLayout && !showBarIconOnly && !showSparklineEx)
                    {
                        this.paintValue(ctx, value, x, y, w, h, style, context)
                    }
                };
                TextCellType.prototype.getText = function(value, context)
                {
                    return value
                };
                TextCellType.prototype.paintValue = function(ctx, value, x, y, w, h, style, options)
                {
                    var self = this;
                    value = this.getText(value, options);
                    var conditionalForeColor = {value: keyword_null},
                        text;
                    text = self.format(value, style.formatter || style._autoFormatter, conditionalForeColor);
                    if (style.watermark && !text)
                    {
                        self.paintText(ctx, style.watermark, x, y, w, h, style, options, style.watermark, conditionalForeColor, watermarkOpacity);
                        return
                    }
                    if (!text)
                    {
                        return
                    }
                    self.paintText(ctx, value, x, y, w, h, style, options, text, conditionalForeColor)
                };
                TextCellType.prototype.createEditorElement = function(context)
                {
                    var $textarea = $("<textarea></textarea>").css(cssMargin, zero).css(cssPadding, "1px").css(cssBoxSizing, "content-box").css(cssFont, "normal 10pt Arial").css(cssWordWrap, "normal").css(cssOverflow, cssHidden).css(cssResize, cssNone).css(cssBorder, "2px #5292f7 solid").css(cssOutline, cssNone).css(cssBoxShadow, "1px 2px 5px rgba(0,0,0,0.4)").attr(attrTabIndex, -1).attr(cssAutoComplete, "off").attr(attrGcUIElement, "gcEditingInput");
                    var editor = document.createElement("div");
                    var host = context && context.sheet && context.sheet.parent && context.sheet.parent._host;
                    var zindex = Sheets.util.getPreferredZIndex(host) + 1000;
                    $(editor).css(cssPositoin, cssAbsolute).css(cssZIndex, zindex).append($textarea);
                    return editor
                };
                TextCellType.prototype.getEditorValue = function(editorContext, context)
                {
                    var textarea = editorContext && editorContext.children[0];
                    if (textarea)
                    {
                        var v = textarea.value;
                        if (v !== keyword_undefined && v !== keyword_null && v.length > 0)
                        {
                            return v
                        }
                    }
                    return keyword_null
                };
                TextCellType.prototype.setEditorValue = function(editorContext, value, context)
                {
                    var t = editorContext && editorContext.children[0];
                    if (t)
                    {
                        var startEditByKeydown = !$.browser.msie && ((context && context.sheet && context.sheet._startEditByKeydown) ? true : false);
                        t.value = (value === keyword_null || value === keyword_undefined || startEditByKeydown) ? "" : value;
                        t.selectionStart = t.selectionEnd = t.value.length
                    }
                };
                TextCellType.prototype.focus = function(editorContext, context)
                {
                    if (editorContext)
                    {
                        var t = editorContext.children[0];
                        if (this.isImeAware() && t)
                        {
                            t.focus();
                            t.selectionStart = t.value.length
                        }
                        else
                        {
                            editorContext.focus()
                        }
                    }
                };
                TextCellType.prototype._formatEditorValue = function(editorContext, cellStyle, value, context)
                {
                    var sheet = editorContext && context && context.sheet;
                    if (sheet)
                    {
                        var r = sheet._activeRowIndex,
                            c = sheet._activeColIndex;
                        var formatter = cellStyle.formatter ? cellStyle.formatter : cellStyle._autoFormatter;
                        if (Sheets.features.formatter && value !== keyword_null && value !== keyword_undefined)
                        {
                            var isNumber;
                            if (formatter instanceof Sheets.AutoFormatter && formatter._innerFormatter instanceof Sheets.GeneralFormatter)
                            {
                                isNumber = typeof value === "number";
                                var isNumberString = Sheets.util.isStringNumber(value);
                                if (!isNumber && isNumberString)
                                {
                                    value = Sheets._NumberHelper.replaceCultureSymbolToNormal(value)
                                }
                                value = formatter._innerFormatter.GetPreferredEditingFormatter(value).Format(value);
                                if (isNumberString)
                                {
                                    value = Sheets._NumberHelper.replaceNormalToCultureSymble(value)
                                }
                            }
                            else
                            {
                                if (typeof formatter === "string")
                                {
                                    formatter = new Sheets.GeneralFormatter(formatter)
                                }
                                if (formatter)
                                {
                                    try
                                    {
                                        var numberFormatType = formatter.GetFormatType(value);
                                        if (numberFormatType === 2)
                                        {
                                            if (value.getHours() === 0 && value.getMinutes() === 0 && value.getSeconds() === 0 && value.getMilliseconds() === 0)
                                            {
                                                formatter = new Sheets.GeneralFormatter("yyyy/mm/dd")
                                            }
                                            else
                                            {
                                                formatter = new Sheets.GeneralFormatter("yyyy/mm/dd hh:mm:ss")
                                            }
                                            sheet._editingTimeValue = true;
                                            value = formatter.Format(value)
                                        }
                                        isNumber = typeof value === "number";
                                        if (isNumber)
                                        {
                                            value = Sheets._NumberHelper.replaceNormalToCultureSymble(value)
                                        }
                                    }
                                    catch(ex)
                                    {
                                        value = sheet.getText(r, c)
                                    }
                                }
                                else
                                {
                                    value = sheet.getText(r, c)
                                }
                            }
                        }
                    }
                    if (value !== keyword_null && value !== keyword_undefined)
                    {
                        value = Sheets.util.toString(value)
                    }
                    return value
                };
                TextCellType.prototype.activateEditor = function(editorContext, cellStyle, cellRect, context)
                {
                    var sheet = editorContext && context && context.sheet;
                    if (sheet)
                    {
                        var $editor = $(editorContext);
                        var bounds = sheet._bounds;
                        var offset;
                        if (context.canvasOffset)
                        {
                            offset = context.canvasOffset
                        }
                        else
                        {
                            offset = sheet._eventHandler._getCanvasPosition()
                        }
                        $editor.css(cssTop, offset.top + bounds.y + cellRect.y - 2).css(cssLeft, offset.left + bounds.x + cellRect.x - 2);
                        var self = this;
                        var textarea = editorContext.children[0];
                        if (textarea)
                        {
                            var $textarea = $(textarea);
                            self._editingElement = $textarea.get(0);
                            $textarea.bind(_keyDown_gcEditingInput, function(event)
                            {
                                var isIme = event.keyCode === 229 || event.keyCode === 0;
                                if (!(isIme || self._isImeInputing))
                                {
                                    self._updateEditorImp(editorContext, cellStyle, cellRect, event, context, true)
                                }
                                if (self._processEditingWrap(event, context))
                                {
                                    return
                                }
                                var pressLeftOnStart = textarea.selectionStart === 0 && event.keyCode === 37 && !event.ctrlKey && !event.shiftKey && !event.altKey,
                                    pressRightOnEnd = textarea.selectionStart === textarea.value.length && event.keyCode === 39 && !event.ctrlKey && !event.shiftKey && !event.altKey,
                                    noSelection = textarea.selectionStart === textarea.selectionEnd;
                                if (noSelection && (pressLeftOnStart || pressRightOnEnd) && sheet._editorStatus === 2)
                                {
                                    Sheets.util.cancelDefault(event)
                                }
                            });
                            $textarea.bind(_keyUp_gcEditingInput, function(event)
                            {
                                if (event.keyCode === 46 || event.keyCode === 8 || ((event.keyCode === 90 || event.keyCode === 89) && event.ctrlKey && !event.altKey))
                                {
                                    self._updateEditorImp(editorContext, cellStyle, cellRect, event, context)
                                }
                                if ((event.keyCode === 13 || event.keyCode === 9) && !event.ctrlKey && !event.altKey)
                                {}
                                else
                                {
                                    sheet.triggerEditChange({
                                        sheet: sheet, sheetName: sheet._name, row: sheet._activeRowIndex, col: sheet._activeColIndex, editingText: self.getEditorValue(editorContext, context)
                                    })
                                }
                            });
                            $textarea.bind(_paste_gcEditingInput, function(event)
                            {
                                self._pasteInputSizingToken = window.setTimeout(function()
                                {
                                    self._updateEditorImp(editorContext, cellStyle, cellRect, event, context);
                                    if (self._pasteInputSizingToken)
                                    {
                                        window.clearTimeout(self._pasteInputSizingToken);
                                        delete self._pasteInputSizingToken
                                    }
                                }, 10)
                            });
                            $textarea.bind(_mousedown_gcEditingInput, function(event)
                            {
                                if (sheet._editorStatus === 1)
                                {
                                    sheet._editorStatus = 2;
                                    sheet.triggerEditorStatusChanged({
                                        sheet: sheet, sheetName: sheet._name, oldStatus: 1, newStatus: 2
                                    })
                                }
                            });
                            $textarea.bind(_compositionstart_gcEditingInput, function(event)
                            {
                                self._isImeInputing = true;
                                self._oldValueBeforeImeInputting = $textarea.val()
                            });
                            $textarea.bind(_compositionupdaten_gcEditingInput, function(event)
                            {
                                self._updateEditorImp(editorContext, cellStyle, cellRect, event ? event.originalEvent : keyword_null, context, true)
                            });
                            $textarea.bind(_compositionend_gcEditingInput, function(event)
                            {
                                self._updateEditorImp(editorContext, cellStyle, cellRect, event ? event.originalEvent : keyword_null, context);
                                self._isImeInputing = false
                            })
                        }
                    }
                };
                TextCellType.prototype.deactivateEditor = function(editorContext, context)
                {
                    if (editorContext)
                    {
                        var textarea = editorContext.children[0];
                        if (textarea)
                        {
                            $(textarea).unbind(_gcEditingInput)
                        }
                        var locator = editorContext._editingLocator;
                        if (locator)
                        {
                            var host = context && context.sheet && context.sheet._getHost();
                            if (host)
                            {
                                host.removeChild(locator)
                            }
                        }
                    }
                    this._editingElement = keyword_null
                };
                TextCellType.prototype.getEditingElement = function()
                {
                    return this._editingElement
                };
                TextCellType.prototype.selectAll = function(editorContext, context)
                {
                    var textarea = editorContext && editorContext.children[0];
                    if (textarea)
                    {
                        if (textarea.select)
                        {
                            textarea.select()
                        }
                    }
                };
                TextCellType.prototype._updateEditorImp = function(editorContext, cellStyle, cellRect, event, context, startEditByKeyDown)
                {
                    var textarea = editorContext && editorContext.children[0],
                        sheet = (context && context.sheet);
                    if (textarea && sheet)
                    {
                        var self = this,
                            $textarea = $(textarea),
                            render = sheet._render;
                        if (sheet.isEditing())
                        {
                            var hAlign = keyword_null,
                                hAlignValue = cssLeft;
                            var font = keyword_null;
                            if (cellStyle)
                            {
                                hAlign = Sheets.util.getHAlignByValueType(cellStyle.hAlign, editorContext._originalValue);
                                if (hAlign === 1)
                                {
                                    hAlignValue = cssCenter
                                }
                                else if (hAlign === 2)
                                {
                                    hAlignValue = cssRight
                                }
                                $textarea.css(cssTextAlign, hAlignValue);
                                if (cellStyle.backColor)
                                {
                                    $textarea.css(cssBackgroundColor, cellStyle.backColor)
                                }
                                if (cellStyle.foreColor)
                                {
                                    $textarea.css(cssColor, cellStyle.foreColor)
                                }
                                font = cellStyle.font || render._getDefaultFont();
                                if (font)
                                {
                                    if (sheet._zoomFactor > 1)
                                    {
                                        font = render._getZoomFont(font)
                                    }
                                    $textarea.css(cssFont, font)
                                }
                                if (cellStyle.textDecoration)
                                {
                                    self._setEditStatusTextDecoration($textarea, cellStyle.textDecoration)
                                }
                            }
                            if (cellRect)
                            {
                                $(editorContext).width(cellRect.width).height(cellRect.height);
                                var sheetLayout = sheet._getSheetLayout();
                                var adjustWidth = 1;
                                var adjustHeight = 1;
                                adjustWidth = adjustWidth + parseInt($textarea.css(cssPaddingLeft), 10) + parseInt($textarea.css(cssPaddingRight), 10);
                                adjustHeight = adjustHeight + parseInt($textarea.css(cssPaddingTop), 10) + parseInt($textarea.css(cssPaddingBottom), 10);
                                var width = cellRect.width;
                                if (cellRect.x + cellRect.width > sheetLayout.width)
                                {
                                    width = sheetLayout.width - cellRect.x
                                }
                                $textarea.css(cssWidth, width - adjustWidth).css(cssHeight, cellRect.height - adjustHeight);
                                if (hAlign === keyword_undefined || hAlign === keyword_null || hAlign === 0)
                                {
                                    textarea.maxWidth = sheetLayout.width - cellRect.x - adjustWidth
                                }
                                else if (hAlign === 1)
                                {
                                    textarea.maxWidth = Math_max(0, Math_min(sheetLayout.width - cellRect.x - cellRect.width - adjustWidth, cellRect.x - sheetLayout.rowHeaderWidth - adjustWidth)) * 2 + cellRect.width
                                }
                                else if (hAlign === 2)
                                {
                                    textarea.maxWidth = cellRect.x + cellRect.width - sheetLayout.rowHeaderWidth - adjustWidth
                                }
                                textarea.maxHeight = sheetLayout.height - cellRect.y - adjustHeight;
                                textarea.minWidth = parseInt(textarea.style.width, 10);
                                textarea.minHeight = parseInt(textarea.style.height, 10)
                            }
                            try
                            {
                                startEditByKeyDown = startEditByKeyDown && event && event.keyCode && sheet._eventHandler.allowEnterEditing(event) && textarea.selectionStart === 0 && textarea.selectionEnd === textarea.value.length;
                                startEditByKeyDown = startEditByKeyDown || ((context && context.sheet && context.sheet._startEditByKeydown) ? true : false)
                            }
                            catch(ex) {}
                            var value = startEditByKeyDown ? "" : textarea.value;
                            font = textarea.style.font;
                            if (!font)
                            {
                                font = render._getZoomFont(render._getDefaultFont())
                            }
                            var lineHeight = sheet._getFontHeight(font);
                            if (!startEditByKeyDown && event)
                            {
                                if (sheet._eventHandler.allowEnterEditing(event))
                                {
                                    var index = textarea.selectionStart;
                                    var preValue = value.substr(0, index);
                                    var endValue = value.substr(index, value.length - index);
                                    value = preValue + String.fromCharCode(event.keyCode) + endValue
                                }
                                if (self._isImeInputing)
                                {
                                    if ($.browser.msie)
                                    {
                                        value = $textarea.val()
                                    }
                                    else
                                    {
                                        value = self._oldValueBeforeImeInputting + event.data
                                    }
                                }
                            }
                            var lines = [];
                            if (cellStyle && cellStyle.wordWrap)
                            {
                                lines = Sheets._WordWrapHelper._getWrapInfo(value, $textarea.width(), font)
                            }
                            else
                            {
                                lines = value.split(/\r\n|\r|\n/)
                            }
                            var i,
                                lineWidth,
                                rowCount,
                                linesLength = lines.length;
                            textarea.minWidth = Math_min(textarea.minWidth, textarea.maxWidth);
                            textarea.minHeight = Math_min(textarea.minHeight, textarea.maxHeight);
                            if ((cellStyle && cellStyle.wordWrap) || linesLength > 0)
                            {
                                var wrapHeight = linesLength * lineHeight;
                                if (cellStyle && cellStyle.wordWrap)
                                {
                                    $textarea.css(cssWordWrap, cssBreakWord).css(cssOverflow, cssHidden)
                                }
                                else
                                {
                                    var maxLineWidth = 0;
                                    var lineWidthTemps = [];
                                    for (i = 0; i < linesLength; i++)
                                    {
                                        var lineValue = lines[i];
                                        lineWidth = sheet._getStringWidth(lineValue, font);
                                        lineWidthTemps.push(lineWidth);
                                        maxLineWidth = Math_max(maxLineWidth, lineWidth)
                                    }
                                    if (maxLineWidth <= textarea.minWidth)
                                    {
                                        $textarea.css(cssWidth, textarea.minWidth).css(cssWordWrap, cssNormal).css(cssOverflow, cssHidden)
                                    }
                                    else if (maxLineWidth > textarea.minWidth && maxLineWidth <= textarea.maxWidth)
                                    {
                                        $textarea.css(cssWidth, maxLineWidth).css(cssWordWrap, cssNormal).css(cssOverflow, cssHidden)
                                    }
                                    else if (maxLineWidth > textarea.maxWidth)
                                    {
                                        $textarea.css(cssWidth, textarea.maxWidth).css(cssWordWrap, cssBreakWord).css(cssOverflow, cssHidden);
                                        wrapHeight = 0;
                                        for (i = 0; i < lineWidthTemps.length; i++)
                                        {
                                            lineWidth = lineWidthTemps[i];
                                            if (lineWidth <= textarea.maxWidth)
                                            {
                                                wrapHeight += lineHeight
                                            }
                                            else if (lineWidth > textarea.maxWidth)
                                            {
                                                rowCount = Math_ceil(lineWidth / textarea.maxWidth);
                                                wrapHeight += lineHeight * rowCount
                                            }
                                        }
                                    }
                                }
                                if (wrapHeight <= textarea.minHeight)
                                {
                                    $textarea.css(cssHeight, textarea.minHeight)
                                }
                                else if (wrapHeight > textarea.minHeight && wrapHeight <= textarea.maxHeight)
                                {
                                    $textarea.css(cssHeight, wrapHeight)
                                }
                                else if (wrapHeight > textarea.maxHeight)
                                {
                                    $textarea.css(cssHeight, textarea.maxHeight).css(cssOverflowY, "scroll")
                                }
                            }
                            else
                            {
                                var width = sheet._getStringWidth(value, font);
                                if (width > textarea.minWidth && width <= textarea.maxWidth)
                                {
                                    $textarea.css(cssWidth, width).css(cssHeight, textarea.minHeight).css(cssWordWrap, cssNormal).css(cssOverflow, cssHidden)
                                }
                                else if (width <= textarea.minWidth)
                                {
                                    $textarea.css(cssWidth, textarea.minWidth).css(cssHeight, textarea.minHeight).css(cssWordWrap, cssNormal).css(cssOverflow, cssHidden)
                                }
                                else if (width > textarea.maxWidth)
                                {
                                    $textarea.css(cssWidth, textarea.maxWidth).css(cssWordWrap, cssBreakWord);
                                    rowCount = Math_ceil(width / textarea.maxWidth);
                                    var actualHeight = lineHeight * rowCount;
                                    if (actualHeight <= textarea.minHeight)
                                    {
                                        $textarea.css(cssHeight, textarea.minHeight).css(cssOverflow, cssHidden)
                                    }
                                    else if (actualHeight <= textarea.maxHeight)
                                    {
                                        $textarea.css(cssHeight, actualHeight).css(cssOverflow, cssHidden)
                                    }
                                    else if (actualHeight > textarea.maxHeight)
                                    {
                                        $textarea.css(cssHeight, textarea.maxHeight).css(cssOverflowY, "scroll")
                                    }
                                }
                            }
                            hAlign = $textarea.css(cssTextAlign);
                            var flowWidth = $textarea.width() - textarea.minWidth;
                            if (hAlign !== keyword_undefined && hAlign !== keyword_null && hAlign !== cssLeft)
                            {
                                if (hAlign === cssCenter)
                                {
                                    $textarea.css(cssLeft, textarea.originalLeft - flowWidth / 2)
                                }
                                else if (hAlign === cssRight)
                                {
                                    $textarea.css(cssLeft, textarea.originalLeft - flowWidth)
                                }
                            }
                            self._updateEditorLocator(editorContext, context)
                        }
                    }
                };
                TextCellType.prototype.updateEditor = function(editorContext, cellStyle, cellRect, context)
                {
                    var sheet = context && context.sheet;
                    if (sheet && cellRect)
                    {
                        var offset;
                        if (context.canvasOffset)
                        {
                            offset = context.canvasOffset
                        }
                        else
                        {
                            offset = sheet._eventHandler._getCanvasPosition()
                        }
                        var bounds = sheet._bounds;
                        $(editorContext).css(cssTop, offset.top + bounds.y + cellRect.y - 2).css(cssLeft, offset.left + bounds.x + cellRect.x - 2)
                    }
                    this._updateEditorImp(editorContext, cellStyle, cellRect, keyword_null, context);
                    if ($.browser.msie && editorContext)
                    {
                        var $textarea = $(editorContext.children[0]),
                            width = $textarea.width();
                        $textarea.width(width + 1).width(width)
                    }
                };
                TextCellType.prototype.updateImeMode = function(editorContext, imeMode, context)
                {
                    if (this.isImeAware())
                    {
                        var content = editorContext && editorContext.children[0];
                        if (content)
                        {
                            $(content).css(cssImeMode, this._getImeModeString(imeMode))
                        }
                    }
                };
                TextCellType.prototype.isReservedKey = function(event, context)
                {
                    var src = event.srcElement || event.target;
                    if (src && context && context.isEditing)
                    {
                        if (src.getAttribute(attrGcUIElement) === "gcEditingInput")
                        {
                            return event.keyCode === 13 && (event.ctrlKey && !event.shiftKey || event.altKey) || (event.keyCode === 90 && event.ctrlKey && !event.altKey) || (event.keyCode === 89 && event.ctrlKey && !event.altKey)
                        }
                    }
                    return false
                };
                TextCellType.prototype._processEditingWrap = function(event, context)
                {
                    var src = event.srcElement || event.target;
                    if (src)
                    {
                        if (src.getAttribute(attrGcUIElement) === "gcEditingInput")
                        {
                            if (event.keyCode === 13 && (event.ctrlKey || event.altKey))
                            {
                                var index = src.selectionStart;
                                var value = src.value;
                                var preValue = value.substr(0, index);
                                var endValue = value.substr(index, value.length - index);
                                src.value = preValue + "\n" + endValue;
                                src.selectionStart = index + 1;
                                src.selectionEnd = index + 1;
                                var ae = Sheets.FocusHelper.getActiveElement(),
                                    spreadns = GcSpread.Sheets;
                                if (ae instanceof spreadns.Sheet)
                                {
                                    var ct = ae.getCellType(ae._activeRowIndex, ae._activeColIndex);
                                    if (ct)
                                    {
                                        ct.updateEditor(ae._editor, keyword_null, keyword_null, context)
                                    }
                                }
                                Sheets.util.cancelDefault(event);
                                return true
                            }
                        }
                    }
                    return false
                };
                TextCellType.prototype.getAutoFitWidth = function(value, text, cellStyle, zoomFactor, context)
                {
                    return CellTypeContext.getAutoFitWidth(value, text, cellStyle, zoomFactor, context)
                };
                TextCellType.prototype.getAutoFitHeight = function(value, text, cellStyle, zoomFactor, context)
                {
                    return CellTypeContext.getAutoFitHeight(value, text, cellStyle, zoomFactor, context)
                };
                TextCellType.prototype.isImeAware = function(context)
                {
                    return true
                };
                return TextCellType
            })(BaseCellType);
        Sheets.TextCellType = TextCellType;
        var HeaderCellType = (function(_super)
            {
                __extends(HeaderCellType, _super);
                function HeaderCellType()
                {
                    _super.apply(this, arguments)
                }
                HeaderCellType.prototype._paint = function(ctx, value, x, y, w, h, style, options, headerTypeString, sheetArea)
                {
                    if (!ctx)
                    {
                        return
                    }
                    var self = this;
                    var themeStyle = keyword_null,
                        visualState = options.visualState;
                    if (typeof(visualState) !== const_undefined)
                    {
                        ctx.save();
                        ctx.beginPath();
                        var fillStyle;
                        if (visualState === 0 && style.backColor)
                        {
                            fillStyle = style.backColor;
                            if (ctx.fillStyle !== fillStyle)
                            {
                                ctx.fillStyle = fillStyle
                            }
                            ctx.fillRect(x, y, w, h)
                        }
                        else
                        {
                            try
                            {
                                themeStyle = self.getThemeStyle(options.visualState, "gc-" + headerTypeString + "-" + Sheets.VisualState[visualState].toLowerCase());
                                var backColor = themeStyle && themeStyle.backgroundColor,
                                    backgroundImg = themeStyle && themeStyle.backgroundImage;
                                if (backgroundImg && backgroundImg.indexOf("linear-gradient") !== -1)
                                {
                                    var colors = Sheets.util.getLinearGradientColors(backgroundImg);
                                    fillStyle = ctx.createLinearGradient(x + w / 2, y, x + w / 2, y + h);
                                    for (var i = 0, len = colors.length; i < len; i++)
                                    {
                                        var color = colors[i];
                                        fillStyle.addColorStop(color.point, color.color)
                                    }
                                    ctx.fillStyle = fillStyle;
                                    ctx.fillRect(x, y, w, h)
                                }
                                else if (backColor)
                                {
                                    ctx.fillStyle = backColor;
                                    ctx.fillRect(x, y, w, h)
                                }
                                else if (backgroundImg && backgroundImg !== cssNone)
                                {
                                    var img = new Image;
                                    var src = backgroundImg;
                                    src = src.replace("url(\"", '');
                                    src = src.replace("\")", '');
                                    img.src = src;
                                    ctx.drawImage(img, x, y, w, h)
                                }
                            }
                            catch(ex) {}
                        }
                        ctx.restore()
                    }
                    var text = self.format(value, style.formatter);
                    if (text)
                    {
                        var clipRect = {
                                x: x, y: y, width: w, height: h
                            };
                        ctx.save();
                        ctx.beginPath();
                        var sheet = options.sheet,
                            rowFilter = sheet.rowFilter();
                        var isFilterHeader = !!(rowFilter && rowFilter.isFilterHeader(options.row, options.col, sheetArea));
                        if (isFilterHeader)
                        {
                            var filterButtonZoom = Math_min(sheet._zoomFactor, 1);
                            var buttonwidth = Math_floor(sheet.defaults.rowHeight * filterButtonZoom);
                            w -= buttonwidth
                        }
                        var fillStyle = style.foreColor;
                        if (!fillStyle)
                        {
                            if (!themeStyle)
                            {
                                themeStyle = self.getThemeStyle(options.visualState, "gc-" + headerTypeString + "-" + Sheets.VisualState[visualState].toLowerCase())
                            }
                            fillStyle = themeStyle.color
                        }
                        if (fillStyle && ctx.fillStyle !== fillStyle)
                        {
                            ctx.fillStyle = fillStyle
                        }
                        var font = style.font;
                        if (font && ctx.font !== font)
                        {
                            ctx.font = font
                        }
                        var indent = 0,
                            textIndent = style.textIndent;
                        if (textIndent > 0)
                        {
                            indent = textIndent * 8
                        }
                        var hAlign = style.hAlign,
                            vAlign = style.vAlign;
                        var textAlign = cssLeft,
                            adjX = 2;
                        adjX += indent;
                        if (hAlign === 1)
                        {
                            adjX = w / 2;
                            textAlign = cssCenter
                        }
                        else if (hAlign === 2)
                        {
                            adjX = w - 1;
                            adjX -= indent;
                            textAlign = cssRight
                        }
                        if (ctx.textAlign !== textAlign)
                        {
                            ctx.textAlign = textAlign
                        }
                        var textHeight = 0,
                            textBaseline = cssAlphabetic,
                            adjY = 2,
                            wordWrap = style.wordWrap,
                            lineHeight = options.lineHeight,
                            fontSize = options.fontInfo.fontSize,
                            lines = [],
                            lineCount = 0;
                        if (wordWrap)
                        {
                            lines = Sheets._WordWrapHelper._getWrapInfo(text, w - 3 - indent, font);
                            lineCount = lines.length;
                            if (lineCount > 1 && vAlign !== 0)
                            {
                                textHeight = (lineCount - 1) * lineHeight
                            }
                        }
                        var baselineOffset = fontSize > 8 ? Math_floor((fontSize - 8) / 5 + 2) : 1,
                            lineOffset = lineHeight / 2 - fontSize / 2 + baselineOffset - 1;
                        adjY += lineHeight - lineOffset;
                        if (vAlign === 1)
                        {
                            adjY = (h - textHeight) / 2 + lineHeight / 2 - lineOffset
                        }
                        else if (vAlign === 2)
                        {
                            adjY = h - textHeight - 2 - lineOffset
                        }
                        if (ctx.textBaseline !== textBaseline)
                        {
                            ctx.textBaseline = textBaseline
                        }
                        var textDecoration = style.textDecoration;
                        if (style.wordWrap)
                        {
                            ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                            ctx.clip();
                            ctx.beginPath();
                            var vpos = y + adjY;
                            for (var i = 0; i < lineCount; i++)
                            {
                                ctx.fillText(lines[i], x + adjX, vpos);
                                if (textDecoration)
                                {
                                    var textLength = ctx.measureText(lines[i]).width;
                                    self._renderTextDecoration(ctx, textDecoration, x + adjX, vpos, textLength, fontSize, baselineOffset)
                                }
                                vpos += options.lineHeight
                            }
                        }
                        else
                        {
                            var txtWidth = ctx.measureText(text).width;
                            if (txtWidth > clipRect.width || lineHeight > clipRect.height)
                            {
                                ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                                ctx.clip();
                                ctx.beginPath()
                            }
                            ctx.fillText(text, x + adjX, y + adjY);
                            if (textDecoration)
                            {
                                self._renderTextDecoration(ctx, textDecoration, x + adjX, y + adjY, txtWidth, fontSize, baselineOffset)
                            }
                        }
                        ctx.restore()
                    }
                };
                HeaderCellType.prototype.getAutoFitWidth = function(value, text, cellStyle, zoomFactor, context)
                {
                    var width = CellTypeContext.getAutoFitWidth(value, text, cellStyle, zoomFactor, context);
                    return width
                };
                HeaderCellType.prototype.getAutoFitHeight = function(value, text, cellStyle, zoomFactor, context)
                {
                    var height = CellTypeContext.getAutoFitHeight(value, text, cellStyle, zoomFactor, context);
                    return height
                };
                return HeaderCellType
            })(BaseCellType);
        Sheets.HeaderCellType = HeaderCellType;
        var ColumnHeaderCellType = (function(_super)
            {
                __extends(ColumnHeaderCellType, _super);
                function ColumnHeaderCellType()
                {
                    _super.call(this);
                    this.typeName = 2 + ''
                }
                ColumnHeaderCellType.prototype.paint = function(ctx, value, x, y, w, h, style, context)
                {
                    _super.prototype._paint.call(this, ctx, value, x, y, w, h, style, context, "columnHeader", 1)
                };
                return ColumnHeaderCellType
            })(HeaderCellType);
        Sheets.ColumnHeaderCellType = ColumnHeaderCellType;
        var RowHeaderCellType = (function(_super)
            {
                __extends(RowHeaderCellType, _super);
                function RowHeaderCellType()
                {
                    _super.call(this);
                    this.typeName = 3 + ''
                }
                RowHeaderCellType.prototype.paint = function(ctx, value, x, y, w, h, style, context)
                {
                    _super.prototype._paint.call(this, ctx, value, x, y, w, h, style, context, "rowHeader", 2)
                };
                return RowHeaderCellType
            })(HeaderCellType);
        Sheets.RowHeaderCellType = RowHeaderCellType;
        var CornerCellType = (function(_super)
            {
                __extends(CornerCellType, _super);
                function CornerCellType()
                {
                    _super.call(this);
                    this.typeName = 4 + ''
                }
                CornerCellType.prototype.paint = function(ctx, value, x, y, w, h, style, context)
                {
                    if (!ctx)
                    {
                        return
                    }
                    ctx.save();
                    ctx.rect(x, y, w, h);
                    ctx.clip();
                    ctx.beginPath();
                    var visualState = context.visualState;
                    if (typeof(visualState) !== const_undefined)
                    {
                        try
                        {
                            var tmpStyle = this.getThemeStyle(context.visualState, "gc-corner-" + Sheets.VisualState[visualState].toLowerCase()),
                                backColor = (tmpStyle && tmpStyle.backgroundColor),
                                backgroundImg = (tmpStyle && tmpStyle.backgroundImage);
                            if (backColor)
                            {
                                ctx.fillStyle = backColor;
                                ctx.fillRect(x, y, w, h)
                            }
                            else if (backgroundImg && backgroundImg !== cssNone)
                            {
                                var img = new Image;
                                var src = backgroundImg;
                                src = src.replace("url(\"", '');
                                src = src.replace("\")", '');
                                img.src = src;
                                ctx.drawImage(img, x, y, w, h)
                            }
                        }
                        catch(ex) {}
                        var gradient = ctx.createLinearGradient(x + w / 2, y, x + w / 2, y + h);
                        gradient.addColorStop(0.125, gradientColorStop1);
                        var hoverStyle = this.getThemeStyle(4, "gc-corner-triangle");
                        gradient.addColorStop(1.0, hoverStyle.backgroundColor);
                        ctx.fillStyle = gradient;
                        ctx.beginPath();
                        var padding = 3;
                        var size = h;
                        if (w < h)
                        {
                            size = w
                        }
                        ctx.moveTo(x + w - size + padding, y + h - padding);
                        ctx.lineTo(x + w - padding, y + h - padding);
                        ctx.lineTo(x + w - padding, y + h - size + padding);
                        ctx.fill()
                    }
                    ctx.restore()
                };
                CornerCellType.prototype.getAutoFitWidth = function(value, text, cellStyle, zoomFactor, context)
                {
                    var width = CellTypeContext.getAutoFitWidth(value, text, cellStyle, zoomFactor, context);
                    return width
                };
                CornerCellType.prototype.getAutoFitHeight = function(value, text, cellStyle, zoomFactor, context)
                {
                    var height = CellTypeContext.getAutoFitHeight(value, text, cellStyle, zoomFactor, context);
                    return height
                };
                return CornerCellType
            })(BaseCellType);
        Sheets.CornerCellType = CornerCellType
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var __extends = this.__extends || function(d, b)
    {
        for (var p in b)
            if (b.hasOwnProperty(p))
                d[p] = b[p];
        function __()
        {
            this.constructor = d
        }
        __.prototype = b.prototype;
        d.prototype = new __
    };
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.sheet_model", ["core.common", "core.stringResource"]);
        var keyword_null = null,
            keyword_undefined = undefined,
            Math_min = Math.min,
            Math_floor = Math.floor;
        var SheetModelManager = (function()
            {
                function SheetModelManager(sheet, name)
                {
                    this._sheet = sheet;
                    this._dataModel = new _GcSheetModel;
                    this._dataModel.name = this._name = name;
                    this._rowHeaderModel = new _GcSheetModel(this._dataModel.rowCount, 1);
                    this._colHeaderModel = new _GcSheetModel(1, this._dataModel.colCount);
                    this._colFooterModel = new _GcSheetModel(1, this._dataModel.colCount, this._name + "cf");
                    this._rowInfos = new _AxieModel;
                    this._colInfos = new _AxieModel;
                    this._colHeaderRowInfos = new _AxieModel;
                    this._rowHeaderColInfos = new _AxieModel;
                    this._spanModel = new _SpanModel;
                    this._colHeaderSpanModel = new _SpanModel;
                    this._rowHeaderSpanModel = new _SpanModel
                }
                SheetModelManager.prototype.name = function(v)
                {
                    if (v)
                    {
                        this._name = v;
                        this._dataModel.name = name
                    }
                    else
                    {
                        return this._name
                    }
                };
                SheetModelManager.prototype.dataModel = function()
                {
                    return this._dataModel
                };
                SheetModelManager.prototype.rowHeaderModel = function()
                {
                    return this._rowHeaderModel
                };
                SheetModelManager.prototype.colHeaderModel = function()
                {
                    return this._colHeaderModel
                };
                SheetModelManager.prototype.colFooterModel = function()
                {
                    return this._colFooterModel
                };
                SheetModelManager.prototype.getDataModel = function(sheetArea)
                {
                    var SheetArea = Sheets.SheetArea;
                    if (sheetArea === 3 || sheetArea === keyword_undefined || sheetArea === null)
                    {
                        return this._dataModel
                    }
                    else if (sheetArea === 2)
                    {
                        return this._rowHeaderModel
                    }
                    else if (sheetArea === 1)
                    {
                        return this._colHeaderModel
                    }
                    return null
                };
                SheetModelManager.prototype.getRowInfos = function(sheetArea)
                {
                    if (sheetArea === 1 || sheetArea === 0)
                    {
                        return this._colHeaderRowInfos
                    }
                    else
                    {
                        return this._rowInfos
                    }
                };
                SheetModelManager.prototype.getColInfos = function(sheetArea)
                {
                    if (sheetArea === 2 || sheetArea === 0)
                    {
                        return this._rowHeaderColInfos
                    }
                    else
                    {
                        return this._colInfos
                    }
                };
                SheetModelManager.prototype.getSpanModel = function(sheetArea)
                {
                    if (sheetArea === undefined || sheetArea === null || sheetArea === 3)
                    {
                        return this._spanModel
                    }
                    else if (sheetArea === 1)
                    {
                        return this._colHeaderSpanModel
                    }
                    else if (sheetArea === 2)
                    {
                        return this._rowHeaderSpanModel
                    }
                };
                return SheetModelManager
            })();
        Sheets.SheetModelManager = SheetModelManager;
        var _SpanModel = (function(_super)
            {
                __extends(_SpanModel, _super);
                function _SpanModel()
                {
                    _super.call(this);
                    this._lastNonNullColumn = -1;
                    this._lastNonNullRow = -1
                }
                _SpanModel.prototype.find = function(row, col)
                {
                    var l = this.length;
                    var t;
                    for (var i = 0; i < l; i++)
                    {
                        t = this[i];
                        if (t && t.contains(row, col))
                            return t
                    }
                    return keyword_null
                };
                _SpanModel.prototype.remove = function(ele)
                {
                    for (var i = 0; i < this.length; i++)
                    {
                        if (this[i] === ele)
                        {
                            this.splice(i, 1);
                            return
                        }
                    }
                };
                _SpanModel.prototype._setLastNonNullRowAndColumn = function(range)
                {
                    var self = this,
                        lastRow = range.row + range.rowCount - 1,
                        lastCol = range.col + range.colCount - 1;
                    if (lastRow > self._lastNonNullRow)
                    {
                        self._lastNonNullRow = lastRow
                    }
                    if (lastCol > self._lastNonNullColumn)
                    {
                        self._lastNonNullColumn = lastCol
                    }
                };
                _SpanModel.prototype.addSpan = function(ele)
                {
                    this._setLastNonNullRowAndColumn(ele);
                    this.push(ele)
                };
                _SpanModel.prototype.removeSpan = function(index, count)
                {
                    this.splice(index, count)
                };
                _SpanModel.prototype.copy = function(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount)
                {
                    var self = this;
                    var changed = false;
                    var cellRangeCount = self.length;
                    var cs;
                    var cr,
                        i;
                    var temp;
                    if (fromRow === -1)
                    {
                        temp = [];
                        for (i = 0; i < cellRangeCount; i++)
                        {
                            cs = self[i];
                            if (fromColumn <= cs.col && cs.col < fromColumn + columnCount)
                            {
                                temp.push(new Sheets.Range(cs.row, toColumn + cs.col - fromColumn, cs.rowCount, cs.colCount));
                                changed = true
                            }
                            else if (toColumn <= cs.col && cs.col < toColumn + columnCount)
                            {
                                self.splice(i, 1);
                                i--;
                                cellRangeCount--;
                                changed = true
                            }
                        }
                        for (i = 0; i < temp.length; i++)
                        {
                            cr = temp[i];
                            if (!self.isValid(self, 0, self.length, cr))
                            {
                                throw new Error(Sheets.SR.Exp_OverlappingSpans);
                            }
                            self.addSpan(cr)
                        }
                    }
                    else if (fromColumn === -1)
                    {
                        temp = [];
                        for (i = 0; i < cellRangeCount; i++)
                        {
                            cs = self[i];
                            if (fromRow <= cs.row && cs.row < fromRow + rowCount)
                            {
                                temp.push(new Sheets.Range(toRow + cs.row - fromRow, cs.col, cs.rowCount, cs.colCount));
                                changed = true
                            }
                            else if (toRow <= cs.row && cs.row < toRow + rowCount)
                            {
                                self.splice(i, 1);
                                i--;
                                cellRangeCount--;
                                changed = true
                            }
                        }
                        for (i = 0; i < temp.length; i++)
                        {
                            cr = temp[i];
                            if (!self.isValid(self, 0, self.length, cr))
                            {
                                throw new Error(Sheets.SR.Exp_OverlappingSpans);
                            }
                            self.addSpan(cr)
                        }
                    }
                    else
                    {
                        temp = [];
                        for (i = 0; i < cellRangeCount; i++)
                        {
                            cs = self[i];
                            if (fromRow <= cs.row && cs.row < fromRow + rowCount && fromColumn <= cs.col && cs.col < fromColumn + columnCount)
                            {
                                temp.push(new Sheets.Range(toRow + cs.row - fromRow, toColumn + cs.col - fromColumn, cs.rowCount, cs.colCount));
                                changed = true
                            }
                            else if (toRow <= cs.row && cs.row < toRow + rowCount && toColumn <= cs.col && cs.col < toColumn + columnCount)
                            {
                                self.splice(i, 1);
                                i--;
                                cellRangeCount--;
                                changed = true
                            }
                        }
                        for (i = 0; i < temp.length; i++)
                        {
                            cr = temp[i];
                            if (!self.isValid(self, 0, self.length, cr))
                            {
                                throw new Error(Sheets.SR.Exp_OverlappingSpans);
                            }
                            self.addSpan(cr)
                        }
                    }
                };
                _SpanModel.prototype.isValid = function(list, start, end, cellRange)
                {
                    for (var i = start; i < end && i < list.length; i++)
                    {
                        var cr = list[i];
                        if (cr.intersect(cellRange.row, cellRange.col, cellRange.rowCount, cellRange.colCount))
                        {
                            return false
                        }
                    }
                    return true
                };
                _SpanModel.prototype.getEnumerator = function(row, col, rowCount, colCount)
                {
                    return new _SpanEnumerator(this, row, col, rowCount, colCount)
                };
                _SpanModel.prototype.getSpans = function(range)
                {
                    if (!range)
                    {
                        return this.slice(0)
                    }
                    var t = [];
                    for (var i = 0; i < this.length; i++)
                    {
                        var rg = this[i];
                        if (!range || rg.intersect(range.row, range.col, range.rowCount, range.colCount))
                        {
                            t.push(rg)
                        }
                    }
                    return t
                };
                _SpanModel.prototype.hasPartSpans = function(row, column, rowCount, columnCount)
                {
                    for (var i = 0; i < this.length; i++)
                    {
                        var rg = this[i];
                        if (rg.intersect(row, column, rowCount, columnCount))
                        {
                            if (rg.row < row || rg.row + rg.rowCount > row + rowCount || rg.col < column || rg.col + rg.colCount > column + columnCount)
                            {
                                return true
                            }
                        }
                    }
                    return false
                };
                _SpanModel.prototype.hasSpans = function(row, column, rowCount, columnCount)
                {
                    var spans = this.getEnumerator(row, column, rowCount, columnCount);
                    return spans.moveNext()
                };
                _SpanModel.prototype.clear = function(row, col, rowCount, colCount)
                {
                    for (var i = 0; i < this.length; i++)
                    {
                        var span = this[i];
                        if ((row === -1 || (row <= span.row && span.row < row + rowCount)) && (col === -1 || (col <= span.col && span.col < col + colCount)))
                        {
                            this.splice(i--, 1)
                        }
                    }
                };
                _SpanModel.prototype.move = function(fromRow, fromCol, toRow, toCol, rowCount, colCount)
                {
                    var self = this;
                    var changed = false;
                    var tmpList = new _SpanModel;
                    var changeList = [];
                    var cellRangeCount = self.length;
                    var cs;
                    var i,
                        cr;
                    if (fromRow === -1)
                    {
                        for (i = 0; i < cellRangeCount; i++)
                        {
                            cs = self[i];
                            if (fromCol <= cs.col && cs.col < fromCol + colCount)
                            {
                                cr = new Sheets.Range(cs.row, toCol + cs.col - fromCol, cs.rowCount, cs.colCount);
                                changeList.push(cr);
                                changed = true
                            }
                            else if (toCol < cs.col && cs.col < toCol + colCount)
                            {
                                changed = true
                            }
                            else
                            {
                                tmpList.push(cs)
                            }
                        }
                    }
                    else if (fromCol === -1)
                    {
                        for (i = 0; i < cellRangeCount; i++)
                        {
                            cs = self[i];
                            if (fromRow <= cs.row && cs.row < fromRow + rowCount)
                            {
                                cr = new Sheets.Range(toRow + cs.row - fromRow, cs.col, cs.rowCount, cs.colCount);
                                changeList.push(cr);
                                changed = true
                            }
                            else if (toRow <= cs.row && cs.row < toRow + rowCount)
                            {
                                changed = true
                            }
                            else
                            {
                                tmpList.push(cs)
                            }
                        }
                    }
                    else
                    {
                        for (i = 0; i < cellRangeCount; i++)
                        {
                            cs = self[i];
                            if (fromRow <= cs.row && cs.row < fromRow + rowCount && fromCol <= cs.col && cs.col < fromCol + colCount)
                            {
                                cr = new Sheets.Range(toRow + cs.row - fromRow, toCol + cs.col - fromCol, cs.rowCount, cs.colCount);
                                changeList.push(cr);
                                changed = true
                            }
                            else if (toRow <= cs.row && cs.row < toRow + rowCount && toCol <= cs.col && cs.col < toCol + colCount)
                            {
                                changed = true
                            }
                            else
                            {
                                tmpList.push(cs)
                            }
                        }
                    }
                    if (changed)
                    {
                        if (changeList.length > 0)
                        {
                            for (i = 0; i < changeList.length; i++)
                            {
                                cr = changeList[i];
                                if (!self.isValid(tmpList, 0, tmpList.length, cr))
                                {
                                    throw new Error(Sheets.SR.Exp_OverlappingSpans);
                                }
                                tmpList.push(cr)
                            }
                        }
                        self.length = 0;
                        for (i = 0; i < tmpList.length; i++)
                        {
                            self.addSpan(tmpList[i])
                        }
                    }
                };
                _SpanModel.prototype.isEmpty = function()
                {
                    if (this.length <= 0)
                    {
                        return true
                    }
                    return false
                };
                _SpanModel.prototype.addRows = function(row, count)
                {
                    var self = this;
                    var changed = false;
                    var countOld = self.length;
                    for (var i = 0; i < countOld; i++)
                    {
                        var cs = self[i];
                        if (cs.row >= row)
                        {
                            self[i] = new Sheets.Range(cs.row + count, cs.col, cs.rowCount, cs.colCount);
                            self._setLastNonNullRowAndColumn(self[i]);
                            changed = true
                        }
                        else if (cs.row < row && row < cs.row + cs.rowCount)
                        {
                            self[i] = new Sheets.Range(cs.row, cs.col, cs.rowCount + count, cs.colCount);
                            self._setLastNonNullRowAndColumn(self[i]);
                            changed = true
                        }
                    }
                };
                _SpanModel.prototype.addColumns = function(column, count)
                {
                    var self = this;
                    var changed = false;
                    var countOld = self.length;
                    for (var i = 0; i < countOld; i++)
                    {
                        var cs = self[i];
                        if (cs.col >= column)
                        {
                            self[i] = new Sheets.Range(cs.row, cs.col + count, cs.rowCount, cs.colCount);
                            self._setLastNonNullRowAndColumn(self[i]);
                            changed = true
                        }
                        else if (cs.col < column && column < cs.col + cs.colCount)
                        {
                            self[i] = new Sheets.Range(cs.row, cs.col, cs.rowCount, cs.colCount + count);
                            self._setLastNonNullRowAndColumn(self[i]);
                            changed = true
                        }
                    }
                };
                _SpanModel.prototype.removeRows = function(row, count)
                {
                    var self = this;
                    var changed = false;
                    var delList = [];
                    var countOld = self.length;
                    var i;
                    for (i = 0; i < countOld; i++)
                    {
                        var cs = self[i];
                        if (cs.row >= row)
                        {
                            if (cs.row < row + count)
                            {
                                delList.push(i);
                                changed = true
                            }
                            else
                            {
                                self[i] = new Sheets.Range(cs.row - count, cs.col, cs.rowCount, cs.colCount);
                                changed = true
                            }
                        }
                        else if (cs.row < row && row < cs.row + cs.rowCount)
                        {
                            self[i] = new Sheets.Range(cs.row, cs.col, cs.rowCount - Math_min(cs.row + cs.rowCount - row, count), cs.colCount);
                            if (self[i].rowCount === 1 && self[i].colCount === 1)
                            {
                                delList.push(i)
                            }
                            changed = true
                        }
                    }
                    for (i = 0; i < delList.length; i++)
                    {
                        var index = delList[i];
                        self.splice(index, 1)
                    }
                };
                _SpanModel.prototype.removeColumns = function(column, count)
                {
                    var self = this;
                    var changed = false;
                    var delList = [];
                    var countOld = self.length;
                    var i;
                    for (i = 0; i < countOld; i++)
                    {
                        var cs = self[i];
                        if (cs.col >= column)
                        {
                            if (cs.col < column + count)
                            {
                                delList.push(i);
                                changed = true
                            }
                            else
                            {
                                self[i] = new Sheets.Range(cs.row, cs.col - count, cs.rowCount, cs.colCount);
                                changed = true
                            }
                        }
                        else if (cs.col < column && column < cs.col + cs.colCount)
                        {
                            self[i] = new Sheets.Range(cs.row, cs.col, cs.rowCount, cs.colCount - Math_min(cs.col + cs.colCount - column, count));
                            if (self[i].rowCount === 1 && self[i].colCount === 1)
                            {
                                delList.push(i)
                            }
                            changed = true
                        }
                    }
                    for (i = 0; i < delList.length; i++)
                    {
                        var index = delList[i];
                        self.splice(index, 1)
                    }
                };
                _SpanModel.prototype.toJSON = function()
                {
                    var array = [];
                    for (var i = 0; i < this.length; i++)
                    {
                        array.push(this[i])
                    }
                    if (array.length === 0)
                    {
                        return keyword_undefined
                    }
                    return array
                };
                _SpanModel.prototype.fromJSON = function(setting, isNoneSchema)
                {
                    if (!setting)
                    {
                        return
                    }
                    var spans = setting;
                    for (var i = 0; i < spans.length; i++)
                    {
                        var cr = spans[i];
                        this.addSpan(new Sheets.Range(cr.row, cr.col, cr.rowCount, cr.colCount))
                    }
                };
                return _SpanModel
            })(Sheets._XArray);
        Sheets._SpanModel = _SpanModel;
        var _SpanEnumerator = (function()
            {
                function _SpanEnumerator(model, row, col, rowCount, colCount)
                {
                    var self = this;
                    self.model = model;
                    self.row = row;
                    self.column = col;
                    self.rowCount = rowCount;
                    self.columnCount = colCount;
                    self.currentIndex = -1;
                    if (row === -1 && col === -1)
                    {
                        self.all = true
                    }
                }
                _SpanEnumerator.prototype.current = function()
                {
                    var self = this;
                    if (0 <= self.currentIndex && self.currentIndex < self.model.length)
                    {
                        return self.model[self.currentIndex]
                    }
                    else
                    {
                        return keyword_null
                    }
                };
                _SpanEnumerator.prototype.moveNext = function()
                {
                    var self = this;
                    self.currentIndex++;
                    if (!self.all)
                    {
                        while (self.currentIndex < self.model.length && !(self.model[self.currentIndex]).intersect(self.row, self.column, self.rowCount, self.columnCount))
                        {
                            self.currentIndex++
                        }
                    }
                    return self.currentIndex < self.model.length
                };
                _SpanEnumerator.prototype.reset = function()
                {
                    this.currentIndex = -1
                };
                return _SpanEnumerator
            })();
        Sheets._SpanEnumerator = _SpanEnumerator;
        var _CellOverflowLayoutModel = (function(_super)
            {
                __extends(_CellOverflowLayoutModel, _super);
                function _CellOverflowLayoutModel()
                {
                    _super.call(this);
                    this.headingOverflowlayout = keyword_null;
                    this.trailingOverflowLayout = keyword_null
                }
                _CellOverflowLayoutModel.prototype.find = function(col)
                {
                    var self = this,
                        count = self.length,
                        cellOverflowLayout;
                    if (count > 0)
                    {
                        for (var i = 0; i < count; i++)
                        {
                            cellOverflowLayout = self[i];
                            if (cellOverflowLayout.contains(col))
                            {
                                return cellOverflowLayout
                            }
                        }
                    }
                    return keyword_null
                };
                return _CellOverflowLayoutModel
            })(Sheets._XArray);
        Sheets._CellOverflowLayoutModel = _CellOverflowLayoutModel;
        var _CellOverflowLayout = (function()
            {
                function _CellOverflowLayout(column, startColumn, endColumn, valueWidth, columnWidth, backgroundWidth, backgroundLeftWidth, backgroundRightWidth)
                {
                    var self = this;
                    self.column = column;
                    self.startColumn = startColumn;
                    self.endColumn = endColumn;
                    self.valueWidth = valueWidth;
                    self.columnWidth = columnWidth;
                    self.backgroundWidth = backgroundWidth;
                    self.backgroundLeftWidth = backgroundLeftWidth;
                    self.backgroundRightWidth = backgroundRightWidth
                }
                _CellOverflowLayout.prototype.contains = function(col)
                {
                    return col >= this.startColumn && col <= this.endColumn
                };
                return _CellOverflowLayout
            })();
        Sheets._CellOverflowLayout = _CellOverflowLayout;
        var _SelectionModel = (function(_super)
            {
                __extends(_SelectionModel, _super);
                function _SelectionModel()
                {
                    _super.call(this);
                    this.selectionPolicy = 2;
                    this.selectionUnit = 0
                }
                _SelectionModel.prototype.find = function(row, col)
                {
                    var self = this,
                        count = self.length,
                        selection;
                    if (count > 0)
                    {
                        for (var i = 0; i < count; i++)
                        {
                            selection = self[i];
                            if (selection.contains(row, col))
                            {
                                return selection
                            }
                        }
                    }
                    return keyword_null
                };
                _SelectionModel.prototype.clear = function()
                {
                    this.splice(0, this.length);
                    this.activeSelectedRangeIndex = -1
                };
                _SelectionModel.prototype.add = function(row, col, rowCount, colCount)
                {
                    var self = this;
                    if (self.selectionPolicy === 0)
                    {
                        rowCount = Math_min(rowCount, 1);
                        colCount = Math_min(colCount, 1);
                        self.clear()
                    }
                    else if (self.selectionPolicy === 1)
                    {
                        self.clear()
                    }
                    if (self.selectionUnit === 1)
                    {
                        col = -1;
                        colCount = -1
                    }
                    else if (self.selectionUnit === 2)
                    {
                        row = -1;
                        rowCount = -1
                    }
                    var r = new Sheets.Range(row, col, rowCount, colCount);
                    self.push(r);
                    self.activeSelectedRangeIndex = self.length - 1
                };
                _SelectionModel.prototype.toArray = function()
                {
                    var newArray = [];
                    for (var i = 0; i < this.length; i++)
                    {
                        newArray.push(this[i])
                    }
                    return newArray
                };
                _SelectionModel.prototype.fromArray = function(ranges)
                {
                    this.splice(0, this.length);
                    for (var i = 0; i < ranges.length; i++)
                    {
                        this.push(ranges[i])
                    }
                };
                _SelectionModel.prototype._isDefaultValue = function(propertyName, value)
                {
                    var self = this;
                    switch (propertyName)
                    {
                        case"selectionPolicy":
                            return value === 2;
                        case"selectionUnit":
                            return value === 0;
                        case"activeSelectedRangeIndex":
                            return value === 0;
                        case"0":
                            var r = value;
                            return (self.length === 1 && r.row === 0 && r.col === 0 && r.rowCount === 1 && r.colCount === 1);
                        case"length":
                            return value === 1;
                        default:
                            return false
                    }
                };
                _SelectionModel.prototype.toJSON = function()
                {
                    var self = this;
                    var sdata = {};
                    for (var item in self)
                    {
                        if (!self._isDefaultValue(item, self[item]) && self.hasOwnProperty(item))
                        {
                            sdata[item] = self[item]
                        }
                    }
                    if ($.isEmptyObject(sdata))
                    {
                        return keyword_undefined
                    }
                    return sdata
                };
                _SelectionModel.prototype.fromJSON = function(setting, isNoneSchema)
                {
                    if (!setting)
                    {
                        return
                    }
                    var self = this;
                    var selections = setting,
                        count = setting.length;
                    if (count === keyword_undefined)
                    {
                        count = 1
                    }
                    for (var i = 0; i < count; i++)
                    {
                        var cr = selections[i];
                        if (cr === keyword_undefined)
                        {
                            cr = {
                                row: 0, col: 0, rowCount: 1, colCount: 1
                            }
                        }
                        self.push(new Sheets.Range(cr.row, cr.col, cr.rowCount, cr.colCount))
                    }
                    var activeSelectedRangeIndex = setting.activeSelectedRangeIndex;
                    if (activeSelectedRangeIndex === keyword_undefined)
                    {
                        activeSelectedRangeIndex = 0
                    }
                    self.activeSelectedRangeIndex = activeSelectedRangeIndex;
                    if ((setting.selectionPolicy) !== keyword_undefined)
                    {
                        self.selectionPolicy = setting.selectionPolicy
                    }
                    if ((setting.selectionUnit) !== keyword_undefined)
                    {
                        self.selectionUnit = setting.selectionUnit
                    }
                };
                return _SelectionModel
            })(Sheets._XArray);
        Sheets._SelectionModel = _SelectionModel;
        var _LayoutModel = (function(_super)
            {
                __extends(_LayoutModel, _super);
                function _LayoutModel()
                {
                    _super.call(this)
                }
                _LayoutModel.prototype.findCell = function(row, col)
                {
                    var self = this,
                        count = self.length,
                        layout;
                    if (count > 0)
                    {
                        for (var i = 0; i < count; i++)
                        {
                            layout = self[i];
                            if (layout.contains(row, col))
                            {
                                return layout
                            }
                        }
                    }
                    return keyword_null
                };
                _LayoutModel.prototype.findRow = function(row)
                {
                    var self = this,
                        count = self.length,
                        layout;
                    if (count > 0)
                    {
                        for (var i = 0; i < count; i++)
                        {
                            layout = self[i];
                            if (layout.row === row)
                            {
                                return layout
                            }
                        }
                    }
                    return keyword_null
                };
                _LayoutModel.prototype.findCol = function(col)
                {
                    var self = this,
                        count = self.length,
                        layout;
                    if (count > 0)
                    {
                        for (var i = 0; i < count; i++)
                        {
                            layout = self[i];
                            if (layout.col === col)
                            {
                                return layout
                            }
                        }
                    }
                    return keyword_null
                };
                _LayoutModel.prototype.findX = function(x)
                {
                    var self = this,
                        count = self.length,
                        layout;
                    if (count > 0)
                    {
                        for (var i = 0; i < count; i++)
                        {
                            layout = self[i];
                            if (layout.containsX(x))
                            {
                                return layout
                            }
                        }
                    }
                    return keyword_null
                };
                _LayoutModel.prototype.findY = function(y)
                {
                    var self = this,
                        count = self.length,
                        layout;
                    if (count > 0)
                    {
                        for (var i = 0; i < count; i++)
                        {
                            layout = self[i];
                            if (layout.containsY(y))
                            {
                                return layout
                            }
                        }
                    }
                    return keyword_null
                };
                _LayoutModel.prototype.findNearX = function(x)
                {
                    var ret = keyword_null,
                        self = this,
                        count = self.length;
                    if (count > 0)
                    {
                        ret = self.findX(x);
                        if (!ret)
                        {
                            ret = (x < self[0].x) ? self[0] : self[count - 1]
                        }
                    }
                    return ret
                };
                _LayoutModel.prototype.findNearY = function(y)
                {
                    var ret = keyword_null,
                        self = this,
                        count = self.length;
                    if (count > 0)
                    {
                        ret = self.findY(y);
                        if (!ret)
                        {
                            ret = (y < self[0].y) ? self[0] : self[count - 1]
                        }
                    }
                    return ret
                };
                return _LayoutModel
            })(Sheets._XArray);
        Sheets._LayoutModel = _LayoutModel;
        var _Layout = (function()
            {
                function _Layout(row, col, x, y, width, height, rowCount, colCount)
                {
                    var self = this;
                    self.rowCount = rowCount;
                    self.colCount = colCount;
                    self.row = row;
                    self.col = col;
                    self.x = x;
                    self.y = y;
                    self.width = width;
                    self.height = height
                }
                _Layout.prototype.contains = function(row, col)
                {
                    var self = this;
                    return ((((row < (self.row + self.rowCount)) && (self.row <= row)) && (col < (self.col + self.colCount))) && (self.col <= col))
                };
                _Layout.prototype.intersect = function(rect)
                {
                    var self = this;
                    return ((self.x < 0 || (rect.x < self.x + self.width && self.x < rect.x + rect.width)) && (self.y < 0 || (rect.y < self.y + self.height && self.y < rect.y + rect.height)))
                };
                _Layout.prototype.containsX = function(x)
                {
                    return this.x <= x && x < this.x + this.width
                };
                _Layout.prototype.containsY = function(y)
                {
                    return this.y <= y && y < this.y + this.height
                };
                return _Layout
            })();
        Sheets._Layout = _Layout;
        var _GcSheetModel = (function()
            {
                function _GcSheetModel(rowCount, colCount, name)
                {
                    this._isSuspendDirty = false;
                    var self = this;
                    self.rowCount = (rowCount !== keyword_null && rowCount !== keyword_undefined) ? rowCount : 200;
                    self.colCount = (colCount !== keyword_null && colCount !== keyword_undefined) ? colCount : 20;
                    self.name = name;
                    self.dataTable = {};
                    self._rowDataArray = [];
                    self._columnDataArray = [];
                    self._defaultDataNode = keyword_null;
                    self.dirtyNodes = {};
                    self._lastNonNullColumn = -1;
                    self._lastNonNullRow = -1
                }
                _GcSheetModel.prototype.getRowCount = function()
                {
                    return this.rowCount
                };
                _GcSheetModel.prototype.getColumnCount = function()
                {
                    return this.colCount
                };
                _GcSheetModel.prototype.setRowCount = function(c)
                {
                    this.rowCount = c
                };
                _GcSheetModel.prototype.setColumnCount = function(c)
                {
                    this.colCount = c
                };
                _GcSheetModel.prototype._updateDirty = function(row, col, dirtyOption)
                {
                    if (this._isSuspendDirty)
                    {
                        return
                    }
                    if (row >= 0 && col >= 0)
                    {
                        if (!this.dirtyNodes[row])
                        {
                            this.dirtyNodes[row] = {}
                        }
                        var dnr = this.dirtyNodes[row];
                        if (dnr.rs !== "n")
                        {
                            dnr.rs = "e"
                        }
                        if (dirtyOption.originalItem !== keyword_undefined)
                        {
                            dnr.originalItem = dirtyOption.originalItem
                        }
                        if (!dnr[col])
                        {
                            dnr[col] = {}
                        }
                        if (dirtyOption.oldValue !== keyword_undefined)
                        {
                            dnr[col].oldValue = dirtyOption.oldValue
                        }
                    }
                };
                _GcSheetModel.prototype._suspendDirty = function()
                {
                    this._isSuspendDirty = true
                };
                _GcSheetModel.prototype._resumeDirty = function()
                {
                    this._isSuspendDirty = false
                };
                _GcSheetModel.prototype.getValue = function(row, col)
                {
                    var node = this.getNode(row, col);
                    if (node && node.value !== keyword_undefined && node.value !== keyword_null)
                    {
                        return node.value
                    }
                    return keyword_null
                };
                _GcSheetModel.prototype.setValue = function(row, col, value)
                {
                    var node = this.getNode(row, col, true);
                    if (node.value !== value)
                    {
                        var oldValue = node.value;
                        node.value = value;
                        this._updateDirty(row, col, {oldValue: oldValue})
                    }
                };
                _GcSheetModel.prototype.getBindingPath = function(row, col)
                {
                    var node = this.getNode(row, col);
                    if (node && node.bindingPath !== keyword_undefined && node.bindingPath !== keyword_null)
                    {
                        return node.bindingPath
                    }
                    return keyword_null
                };
                _GcSheetModel.prototype.setBindingPath = function(row, col, value)
                {
                    var node = this.getNode(row, col, true);
                    if (node.bindingPath !== value)
                    {
                        node.bindingPath = value
                    }
                };
                _GcSheetModel.prototype.getSparkline = function(row, col)
                {
                    if (row < 0 || col < 0)
                    {
                        return keyword_null
                    }
                    var rowData = this.dataTable[row];
                    var node = rowData && rowData[col];
                    return ((node && node.sparkline) || keyword_null)
                };
                _GcSheetModel.prototype.setSparkline = function(row, col, sparkline)
                {
                    var node = this.getNode(row, col, true);
                    if (node.sparkline !== sparkline)
                    {
                        node.sparkline = sparkline
                    }
                };
                _GcSheetModel.prototype.setFormula = function(row, col, value, arrayInfo)
                {
                    var node = this.getNode(row, col, true);
                    if (node.formula !== value)
                    {
                        node.formula = value;
                        node.arrayInfo = arrayInfo
                    }
                };
                _GcSheetModel.prototype.getFormula = function(row, col)
                {
                    var node = this.getNode(row, col);
                    return (node && node.formula)
                };
                _GcSheetModel.prototype.getStyle = function(row, col)
                {
                    var node = this.getNode(row, col);
                    return (node && node.style)
                };
                _GcSheetModel.prototype.setStyle = function(row, col, value)
                {
                    var node = this.getNode(row, col, true);
                    if (node && node.style !== value)
                    {
                        node.style = value
                    }
                };
                _GcSheetModel.prototype.getComment = function(row, col)
                {
                    var node = this.getNode(row, col);
                    return (node && node.comment)
                };
                _GcSheetModel.prototype.setComment = function(row, col, comment)
                {
                    var node = this.getNode(row, col, true);
                    if (node && node.comment !== comment)
                    {
                        node.comment = comment
                    }
                };
                _GcSheetModel.prototype.setTag = function(row, col, tag)
                {
                    var node = this.getNode(row, col, true);
                    if (node && node.tag != tag)
                    {
                        node.tag = tag
                    }
                };
                _GcSheetModel.prototype.getTag = function(row, col)
                {
                    var node = this.getNode(row, col);
                    if (node && node.tag !== keyword_undefined && node.tag !== keyword_null)
                    {
                        return node.tag
                    }
                    return keyword_null
                };
                _GcSheetModel.prototype.getVisualState = function(row, col)
                {
                    var node = this.getNode(row, col);
                    return (node && node.visualState)
                };
                _GcSheetModel.prototype.setVisualState = function(row, col, value)
                {
                    var node = this.getNode(row, col, true);
                    if (node.visualState !== value)
                    {
                        node.visualState = value
                    }
                };
                _GcSheetModel.prototype.addRows = function(row, count)
                {
                    var self = this;
                    if (row < 0 || row > self.rowCount || count < 0)
                    {
                        return
                    }
                    Sheets._ModelHelper.addElements(self.dataTable, self.rowCount, row, count);
                    Sheets._ModelHelper.addElements(self._rowDataArray, self.rowCount, row, count);
                    Sheets._ModelHelper.addElements(self.dirtyNodes, self.rowCount, row, count);
                    this.rowCount += count;
                    for (var i = 0; i < count; i++)
                    {
                        self.dataTable[row + i] = {rs: "n"};
                        self.dirtyNodes[row + i] = self.dataTable[row + i]
                    }
                };
                _GcSheetModel.prototype.deleteRows = function(row, count)
                {
                    var self = this;
                    var n = self.rowCount;
                    if (row < 0 || row >= n || count <= 0)
                    {
                        return
                    }
                    if (row + count > n)
                    {
                        count = n - row
                    }
                    Sheets._ModelHelper.deleteElements(self.dataTable, n, row, count);
                    Sheets._ModelHelper.deleteElements(self._rowDataArray, n, row, count);
                    Sheets._ModelHelper.deleteElements(self.dirtyNodes, n, row, count);
                    self.rowCount -= count
                };
                _GcSheetModel.prototype.addColumns = function(col, count)
                {
                    var self = this;
                    if (col < 0 || col > self.colCount || count < 0)
                    {
                        return
                    }
                    for (var i = 0; i < self.rowCount; i++)
                    {
                        var tr = self.dataTable[i];
                        if (tr && col < self.colCount)
                        {
                            Sheets._ModelHelper.addElements(tr, self.colCount, col, count)
                        }
                    }
                    Sheets._ModelHelper.addElements(this._columnDataArray, this.colCount, col, count);
                    this.colCount += count
                };
                _GcSheetModel.prototype.deleteColumns = function(col, count)
                {
                    var self = this;
                    var n = self.colCount;
                    if (col < 0 || col >= n || count < 0)
                    {
                        return
                    }
                    for (var i = 0; i < self.rowCount; i++)
                    {
                        var tr = this.dataTable[i];
                        if (tr && col < self.colCount)
                        {
                            Sheets._ModelHelper.deleteElements(tr, self.colCount, col, count)
                        }
                    }
                    Sheets._ModelHelper.deleteElements(this._columnDataArray, this.colCount, col, count);
                    if (col + count > n)
                    {
                        count = n - col
                    }
                    self.colCount -= count
                };
                _GcSheetModel.prototype.getNode = function(row, col, create)
                {
                    var self = this;
                    if (row >= self.rowCount || col >= self.colCount)
                    {
                        return keyword_null
                    }
                    var node = keyword_null;
                    if (row >= 0 && col >= 0)
                    {
                        var dr = self.dataTable[row];
                        if (create && !dr)
                        {
                            dr = self.dataTable[row] = {};
                            if (row > self._lastNonNullRow)
                            {
                                self._lastNonNullRow = row
                            }
                        }
                        if (dr)
                        {
                            node = dr[col];
                            if (create && !node)
                            {
                                node = dr[col] = {};
                                if (col > self._lastNonNullColumn)
                                {
                                    self._lastNonNullColumn = col
                                }
                            }
                        }
                    }
                    else if (row === -1 && col >= 0)
                    {
                        node = self._columnDataArray[col];
                        if (create && !node)
                        {
                            node = self._columnDataArray[col] = {};
                            if (col > self._lastNonNullColumn)
                            {
                                self._lastNonNullColumn = col
                            }
                        }
                    }
                    else if (row >= 0 && col === -1)
                    {
                        node = self._rowDataArray[row];
                        if (create && !node)
                        {
                            node = self._rowDataArray[row] = {};
                            if (col > self._lastNonNullColumn)
                            {
                                self._lastNonNullColumn = col
                            }
                        }
                    }
                    else if (row === -1 && col === -1)
                    {
                        node = self._defaultDataNode;
                        if (create && !node)
                        {
                            node = self._defaultDataNode = {}
                        }
                    }
                    return node
                };
                _GcSheetModel.prototype._setNode4Swap = function(or, oc, row, col, node)
                {
                    var self = this;
                    if (row >= 0 && col >= 0)
                    {
                        var dr = self.dataTable[row];
                        if (!dr)
                        {
                            dr = self.dataTable[row] = {}
                        }
                        dr[col] = node;
                        if (node && node.calc)
                        {
                            delete node.calc
                        }
                    }
                    else if (row >= 0 && col === -1 && or >= 0 && oc === -1)
                    {
                        self._rowDataArray[row] = node
                    }
                    else if (col >= 0 && row === -1 && oc >= 0 && or === -1)
                    {
                        self._columnDataArray[col] = node
                    }
                };
                _GcSheetModel.prototype.swapNode = function(row, col, row2, col2)
                {
                    var self = this;
                    var node = self.getNode(row, col);
                    var node2 = self.getNode(row2, col2);
                    if (node)
                    {
                        self._setNode4Swap(row, col, row2, col2, node)
                    }
                    else if (node2)
                    {
                        self._setNode4Swap(row, col, row2, col2, keyword_null)
                    }
                    if (node2)
                    {
                        self._setNode4Swap(row2, col2, row, col, node2)
                    }
                    else if (node)
                    {
                        self._setNode4Swap(row2, col2, row, col, keyword_null)
                    }
                };
                _GcSheetModel.prototype.getDataRowIndex = function(row)
                {
                    return row
                };
                _GcSheetModel.prototype.nextNonNullRow = function(row)
                {
                    row++;
                    var rowCount = this.rowCount,
                        dataTable = this.dataTable;
                    while (row >= 0 && row < rowCount)
                    {
                        if (dataTable[row])
                        {
                            break
                        }
                        row++
                    }
                    if (row < rowCount)
                    {
                        return row
                    }
                    return -1
                };
                _GcSheetModel.prototype.nextNonNullColumn = function(row, col)
                {
                    var self = this;
                    var dr = keyword_null,
                        colCount = self.colCount;
                    if (row >= 0 && row < self.rowCount)
                    {
                        dr = self.dataTable[row]
                    }
                    if (!dr)
                    {
                        return -1
                    }
                    col++;
                    while (col >= 0 && col < colCount)
                    {
                        if (dr[col])
                        {
                            break
                        }
                        col++
                    }
                    if (col < colCount)
                    {
                        return col
                    }
                    return -1
                };
                _GcSheetModel.prototype.clear = function(row, column, rowCount, columnCount, type, ignoredRowList)
                {
                    var self = this;
                    var nodes = [];
                    var node,
                        c,
                        r;
                    if (row >= 0 && column >= 0)
                    {
                        if (row + rowCount > self.rowCount)
                        {
                            rowCount = self.rowCount - row
                        }
                        if (rowCount <= 0)
                        {
                            return
                        }
                        if (column + columnCount > self.colCount)
                        {
                            columnCount = self.colCount - column
                        }
                        if (columnCount <= 0)
                        {
                            return
                        }
                        for (r = row; r < row + rowCount; r++)
                        {
                            if (ignoredRowList && Sheets.ArrayHelper.indexOf(ignoredRowList, r) >= 0)
                            {
                                continue
                            }
                            for (c = column; c < column + columnCount; c++)
                            {
                                node = self.getNode(r, c);
                                if (node)
                                {
                                    nodes.push(node);
                                    if ((type & 1) > 0 && node.value && node.value !== keyword_null)
                                    {
                                        self._updateDirty(r, c, {oldValue: node.value})
                                    }
                                }
                            }
                        }
                    }
                    else if (row >= 0 && column === -1)
                    {
                        if (row + rowCount > self.rowCount)
                        {
                            rowCount = self.rowCount - row
                        }
                        if (rowCount <= 0)
                        {
                            return
                        }
                        for (r = row; r < row + rowCount; r++)
                        {
                            node = self.getNode(r, -1);
                            if (node)
                            {
                                nodes.push(node)
                            }
                        }
                    }
                    else if (row === -1 && column >= 0)
                    {
                        if (column + columnCount > self.colCount)
                        {
                            columnCount = self.colCount - column
                        }
                        if (columnCount <= 0)
                        {
                            return
                        }
                        for (c = column; c < column + columnCount; c++)
                        {
                            node = self.getNode(-1, c);
                            if (node)
                            {
                                nodes.push(node)
                            }
                        }
                    }
                    else if (row === -1 && column === -1)
                    {
                        node = self._defaultDataNode;
                        if (node)
                        {
                            nodes.push(node)
                        }
                    }
                    self.clearCore(nodes, type)
                };
                _GcSheetModel.prototype.clearCore = function(nodes, type)
                {
                    for (var i = 0; i < nodes.length; i++)
                    {
                        if (nodes[i])
                        {
                            if ((type & 8) > 0)
                            {
                                nodes[i].tag = keyword_null
                            }
                            if ((type & 2) > 0)
                            {
                                nodes[i].style = keyword_null
                            }
                            if ((type & 1) > 0)
                            {
                                nodes[i].value = keyword_null;
                                nodes[i].formula = keyword_null;
                                nodes[i].arrayInfo = keyword_null
                            }
                            if ((type & 16) > 0)
                            {
                                nodes[i].sparkline = keyword_null
                            }
                            if ((type & 64) > 0)
                            {
                                nodes[i].bindingPath = keyword_null
                            }
                            if ((type & 4) > 0)
                            {
                                nodes[i].comment = keyword_null
                            }
                        }
                    }
                };
                _GcSheetModel.prototype.clearFormula = function(row, column, rowCount, columnCount)
                {
                    for (var r = 0; r < rowCount; r++)
                    {
                        for (var c = 0; c < columnCount; c++)
                        {
                            var node = this.getNode(row + r, column + c);
                            if (node)
                            {
                                node.formula = keyword_null;
                                node.arrayInfo = keyword_null
                            }
                        }
                    }
                };
                _GcSheetModel.prototype.toJSON = function(sheetArea)
                {
                    var self = this;
                    var jsonData = {};
                    var ndata = {};
                    var r = self.nextNonNullRow(-1);
                    while (r >= 0)
                    {
                        var ndr = ndata[r] = {};
                        var c = self.nextNonNullColumn(r, -1);
                        while (c >= 0)
                        {
                            var node = self.getNode(r, c);
                            if (node)
                            {
                                ndr[c] = self._toJSONNode(node)
                            }
                            c = self.nextNonNullColumn(r, c)
                        }
                        r = self.nextNonNullRow(r)
                    }
                    if (!$.isEmptyObject(ndata))
                    {
                        jsonData["dataTable"] = ndata
                    }
                    var nRowData = [];
                    var rowData = self._rowDataArray;
                    for (var r = 0; r < self.rowCount; r++)
                    {
                        if (rowData.hasOwnProperty(r) && rowData[r])
                        {
                            nRowData[r] = self._toJSONNode(rowData[r])
                        }
                    }
                    if (nRowData.length > 0)
                    {
                        jsonData["rowDataArray"] = nRowData
                    }
                    var nColData = [];
                    var colData = self._columnDataArray;
                    for (var c = 0; c < self.colCount; c++)
                    {
                        if (colData.hasOwnProperty(c) && colData[c])
                        {
                            nColData[c] = self._toJSONNode(colData[c])
                        }
                    }
                    if (nColData.length > 0)
                    {
                        jsonData["columnDataArray"] = nColData
                    }
                    var defaultDataNode = self._toJSONNode(self._defaultDataNode, sheetArea, true);
                    if (!$.isEmptyObject(defaultDataNode))
                    {
                        jsonData["defaultDataNode"] = defaultDataNode
                    }
                    return jsonData
                };
                _GcSheetModel.prototype.fromJSON = function(setting, isNoneSchema)
                {
                    if (!setting)
                    {
                        return
                    }
                    var self = this;
                    var dt = setting;
                    this._suspendDirty();
                    if (dt.name !== keyword_undefined)
                    {
                        self.name = dt.name
                    }
                    var data = dt.dataTable;
                    if (data)
                    {
                        var dr,
                            node;
                        var rowCount = self.rowCount;
                        var colCount = self.colCount;
                        for (var r = 0; r < rowCount; r++)
                        {
                            dr = data[r];
                            if (!dr)
                            {
                                continue
                            }
                            for (var c = 0; c < colCount; c++)
                            {
                                node = dr[c];
                                if (!node)
                                {
                                    continue
                                }
                                self._copyFromJSONNode(r, c, node, isNoneSchema)
                            }
                        }
                    }
                    var rowData = dt.rowDataArray ? dt.rowDataArray : dt._rowDataArray;
                    if (rowData)
                    {
                        for (var r = 0; r < self.rowCount; r++)
                        {
                            if (rowData.hasOwnProperty(r) && rowData[r])
                            {
                                self._copyFromJSONNode(r, -1, rowData[r], isNoneSchema)
                            }
                        }
                    }
                    var colData = dt.columnDataArray ? dt.columnDataArray : dt._columnDataArray;
                    if (colData)
                    {
                        for (var c = 0; c < self.colCount; c++)
                        {
                            if (colData.hasOwnProperty(c) && colData[c])
                            {
                                self._copyFromJSONNode(-1, c, colData[c], isNoneSchema)
                            }
                        }
                    }
                    var defDataNode = dt.defaultDataNode ? dt.defaultDataNode : dt._defaultDataNode;
                    if (defDataNode)
                    {
                        self._copyFromJSONNode(-1, -1, defDataNode, isNoneSchema)
                    }
                    this._resumeDirty()
                };
                _GcSheetModel.prototype._toJSONNode = function(node, sheetArea, checkDefaultValue)
                {
                    if (!node)
                    {
                        return keyword_null
                    }
                    var jsonNode = {};
                    if (node.value !== keyword_undefined && node.value !== keyword_null)
                    {
                        jsonNode.value = node.value
                    }
                    if (node.formula !== keyword_undefined && node.formula !== keyword_null)
                    {
                        jsonNode.formula = node.formula;
                        if (node.arrayInfo)
                        {
                            jsonNode.arrayInfo = node.arrayInfo
                        }
                    }
                    var nodeStyle = node.style;
                    if (typeof nodeStyle === "string")
                    {
                        jsonNode.style = nodeStyle
                    }
                    else if (nodeStyle)
                    {
                        var style = nodeStyle.toJSON(sheetArea, checkDefaultValue);
                        if (!$.isEmptyObject(style))
                        {
                            jsonNode.style = style;
                            if (nodeStyle.font)
                            {
                                jsonNode.style.font = Sheets.StyleHelper.normalizeFont(nodeStyle.font)
                            }
                        }
                    }
                    if (node.bindingPath !== keyword_undefined && node.bindingPath !== keyword_null)
                    {
                        jsonNode.bindingPath = node.bindingPath
                    }
                    if (node.tag !== keyword_null && node.tag !== keyword_undefined)
                    {
                        jsonNode.tag = node.tag
                    }
                    return jsonNode
                };
                _GcSheetModel.prototype._copyFromJSONNode = function(toRow, toCol, node, isNoneSchema)
                {
                    if (!node)
                    {
                        return
                    }
                    var self = this;
                    var r = toRow,
                        c = toCol;
                    var targetNode = self.getNode(r, c, true);
                    if (node.value !== keyword_undefined)
                    {
                        if (node.value != keyword_null && node.value._calcError)
                        {
                            var value = Sheets.Calc.CalcError._parseCore(node.value._calcError);
                            if (value !== keyword_undefined)
                            {
                                node.value = value
                            }
                        }
                        targetNode.value = node.value
                    }
                    if (node.formula !== keyword_undefined)
                    {
                        targetNode.formula = node.formula;
                        if (node.arrayInfo)
                        {
                            targetNode.arrayInfo = node.arrayInfo
                        }
                    }
                    if (node.style !== keyword_undefined)
                    {
                        var style = keyword_null;
                        if (typeof(node.style) === 'string')
                        {
                            style = node.style
                        }
                        else if (node.style)
                        {
                            style = new Sheets.Style;
                            style.fromJSON(node.style, isNoneSchema)
                        }
                        targetNode.style = style
                    }
                    if (node.visualState !== keyword_undefined)
                    {
                        targetNode.visualState = node.visualState
                    }
                    if (node.bindingPath !== keyword_undefined)
                    {
                        targetNode.bindingPath = node.bindingPath
                    }
                    var tagObj = node.tag;
                    if (tagObj !== keyword_undefined)
                    {
                        var typeName = tagObj.typeName;
                        if (typeof typeName === "string")
                        {
                            var tagClass = Sheets.getTypeFromString(typeName);
                            if (tagClass)
                            {
                                tagObj = new tagClass;
                                if (tagObj.fromJSON)
                                {
                                    tagObj.fromJSON(node.tag)
                                }
                            }
                        }
                        targetNode.tag = tagObj
                    }
                };
                return _GcSheetModel
            })();
        Sheets._GcSheetModel = _GcSheetModel;
        var _UndoManager = (function()
            {
                function _UndoManager(context, maxLength, allowUndo)
                {
                    this.changed = keyword_null;
                    var self = this;
                    self._context = context;
                    if (parseInt(maxLength.toString(), 10) < 0)
                    {
                        maxLength = 2147483647
                    }
                    self._maxLength = maxLength;
                    self._allowUndo = allowUndo;
                    self._undoStack = [];
                    self._redoStack = []
                }
                _UndoManager.prototype.context = function()
                {
                    return this._context
                };
                _UndoManager.prototype.canUndo = function()
                {
                    return this._undoStack.length > 0
                };
                _UndoManager.prototype.canRedo = function()
                {
                    return this._redoStack.length > 0
                };
                _UndoManager.prototype._shrinkUndoStack = function(count)
                {
                    for (var i = 0; i < count; i++)
                    {
                        this._undoStack.shift()
                    }
                };
                _UndoManager.prototype._raiseChanged = function()
                {
                    var self = this;
                    if (self.changed && typeof(self.changed) === 'function')
                    {
                        self.changed(self)
                    }
                };
                _UndoManager.prototype.doAction = function(action)
                {
                    if (!action || !action.execute)
                    {
                        return false
                    }
                    var self = this;
                    if (!action.canExecute(self._context))
                    {
                        return false
                    }
                    var success = true;
                    try
                    {
                        action.execute(self._context)
                    }
                    catch(e)
                    {
                        success = false
                    }
                    if (self._allowUndo)
                    {
                        if (success && action.canUndo() && action.undo)
                        {
                            if (self._maxLength > 0 && self._undoStack.length >= self._maxLength)
                            {
                                self._shrinkUndoStack(self._undoStack.length - self._maxLength + 1)
                            }
                            self._undoStack.push(action);
                            self._redoStack = [];
                            self._raiseChanged()
                        }
                    }
                    return success
                };
                _UndoManager.prototype.undo = function()
                {
                    var self = this;
                    var result = true;
                    if (self._allowUndo && self.canUndo())
                    {
                        var undoAction = self._undoStack[self._undoStack.length - 1];
                        try
                        {
                            if (undoAction && undoAction.canUndo && undoAction.canUndo() && undoAction.undo)
                            {
                                result = undoAction.undo(self._context)
                            }
                        }
                        catch(e)
                        {
                            result = false
                        }
                        if (result)
                        {
                            self._redoStack.push(self._undoStack.pop());
                            self._raiseChanged()
                        }
                    }
                    return result
                };
                _UndoManager.prototype.redo = function()
                {
                    var self = this;
                    var result = true;
                    if (self._allowUndo && self.canRedo())
                    {
                        var redoAction = self._redoStack[self._redoStack.length - 1];
                        try
                        {
                            if (redoAction && redoAction.execute)
                            {
                                redoAction.execute(self._context)
                            }
                        }
                        catch(e)
                        {
                            result = false
                        }
                        if (result)
                        {
                            self._undoStack.push(self._redoStack.pop());
                            self._raiseChanged()
                        }
                    }
                    return result
                };
                _UndoManager.prototype.getUndoList = function()
                {
                    return this._undoStack.slice(0)
                };
                _UndoManager.prototype.getRedoList = function()
                {
                    return this._redoStack.slice(0)
                };
                _UndoManager.prototype.clear = function()
                {
                    this._undoStack = [];
                    this._redoStack = []
                };
                return _UndoManager
            })();
        Sheets._UndoManager = _UndoManager;
        var _AxieModel = (function()
            {
                function _AxieModel()
                {
                    this._infos = []
                }
                _AxieModel.prototype.addItems = function(index, count)
                {
                    if (index < 0 || index > this.length || count < 0)
                    {
                        return
                    }
                    Sheets._ModelHelper.addElements(this._infos, this.length, index, count);
                    this.length += count
                };
                _AxieModel.prototype.deleteItems = function(index, count)
                {
                    var n = this.length;
                    if (index < 0 || index >= n || count <= 0)
                    {
                        return
                    }
                    if (index + count > n)
                    {
                        count = n - index
                    }
                    var aa;
                    aa = index;
                    Sheets._ModelHelper.deleteElements(this._infos, n, index, count);
                    this.length -= count
                };
                _AxieModel.prototype.reset = function(index)
                {
                    if (this._infos.length > index)
                    {
                        this._infos[index] = null
                    }
                };
                _AxieModel.prototype._getItems = function()
                {
                    return this._infos
                };
                _AxieModel.prototype._setItems = function(items)
                {
                    this._infos = items;
                    this.length = items.length
                };
                _AxieModel.prototype._getItem = function(index)
                {
                    return this._infos[index]
                };
                _AxieModel.prototype._setItem = function(index, item)
                {
                    this._infos[index] = item;
                    this.length = this._infos.length
                };
                _AxieModel.prototype.getSize = function(index)
                {
                    var info = this._infos[index];
                    if (info)
                    {
                        if (info.visible === false)
                        {
                            return 0
                        }
                        else
                        {
                            return Math.floor(info.size)
                        }
                    }
                    else
                    {
                        return null
                    }
                };
                _AxieModel.prototype.getActualSize = function(index)
                {
                    var info = this._infos[index];
                    if (info)
                    {
                        return Math.floor(info.size)
                    }
                    else
                    {
                        return null
                    }
                };
                _AxieModel.prototype.setSize = function(index, value)
                {
                    var info = this._infos[index];
                    if (!info)
                    {
                        this._infos[index] = info = {};
                        this.length = this._infos.length
                    }
                    if (info.size !== value)
                    {
                        info.size = value;
                        info.dirty = true
                    }
                };
                _AxieModel.prototype.getVisible = function(index)
                {
                    var v = true;
                    var info = this._infos[index];
                    if (info && info.visible !== keyword_undefined && info.visible !== keyword_null)
                    {
                        v = info.visible
                    }
                    return v
                };
                _AxieModel.prototype.setVisible = function(index, value)
                {
                    var info = this._infos[index];
                    if (!info)
                    {
                        this._infos[index] = info = {};
                        this.length = this._infos.length
                    }
                    if (info.visible !== value)
                    {
                        info.visible = value;
                        info.dirty = true
                    }
                };
                _AxieModel.prototype.getResizeable = function(index)
                {
                    var v = true;
                    var info = this._infos[index];
                    if (info && info.resizable !== keyword_undefined && info.resizable !== keyword_null)
                    {
                        v = info.resizable
                    }
                    return v
                };
                _AxieModel.prototype.setResizeable = function(index, value)
                {
                    var info = this._infos[index];
                    if (!info)
                    {
                        this._infos[index] = info = {};
                        this.length = this._infos.length
                    }
                    if (info.resizable != value)
                    {
                        info.resizable = value;
                        info.dirty = true
                    }
                };
                _AxieModel.prototype.getDirty = function(index)
                {
                    var info = this._infos[index];
                    return info && info.dirty
                };
                _AxieModel.prototype.clearDirty = function()
                {
                    for (var i = 0; i < this._infos.length; i++)
                    {
                        var info = this._infos[i];
                        if (info && info.dirty)
                        {
                            info.dirty = null
                        }
                    }
                };
                return _AxieModel
            })();
        Sheets._AxieModel = _AxieModel
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var __extends = this.__extends || function(d, b)
    {
        for (var p in b)
            if (b.hasOwnProperty(p))
                d[p] = b[p];
        function __()
        {
            this.constructor = d
        }
        __.prototype = b.prototype;
        d.prototype = new __
    };
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.sheet_action", ["core.common", "core.sheet_model"]);
        var keyword_null = null,
            keyword_undefined = undefined;
        function __navigateNoWrap(sheet, direction)
        {
            if (sheet)
            {
                if (sheet._editorStatus === 2)
                {
                    return false
                }
                var fbx = sheet._formulaTextBox;
                if (fbx && fbx.canAppendRange())
                {
                    sheet._moveFormulaTextBoxCell(direction, false);
                    return true
                }
                else if (fbx)
                {
                    sheet = SpreadActions.handleFormulaTextboxAcrossSheet(sheet)
                }
                sheet.moveActiveCell(direction, false);
                return true
            }
            return false
        }
        function __navigateNoWrapFrom(sheet, direction, row, col)
        {
            if (sheet)
            {
                if (sheet._editorStatus === 2)
                {
                    return false
                }
                var fbx = sheet._formulaTextBox;
                if (fbx && fbx.canAppendRange())
                {
                    sheet._moveFormulaTextBoxCell(direction, false, row, col);
                    return true
                }
                else if (fbx)
                {
                    sheet = SpreadActions.handleFormulaTextboxAcrossSheet(sheet)
                }
                sheet.moveActiveCell(direction, false, row, col);
                return true
            }
            return false
        }
        function __alterSelection(sheet, key, isCtrl)
        {
            if (sheet)
            {
                if (sheet._editorStatus === 2)
                {
                    return false
                }
                var fbx = sheet._formulaTextBox;
                if (fbx && fbx.canAppendRange())
                {
                    sheet._changeFormulaTextBoxActiveRange(key, isCtrl);
                    return true
                }
                else if (fbx)
                {
                    sheet = SpreadActions.handleFormulaTextboxAcrossSheet(sheet)
                }
                sheet.endEdit();
                sheet._changeActiveSelectedRange(key, isCtrl);
                return true
            }
            return false
        }
        function __createFloatingObjectActionExtent(sheet, onlySelected)
        {
            var names = [];
            for (var i = 0, len = sheet._floatingObjectArray.length; i < len; i++)
            {
                var item = sheet._floatingObjectArray[i];
                if (onlySelected && item.isSelected())
                {
                    names.push(item.name())
                }
                else
                {
                    names.push(item.name)
                }
            }
            return names
        }
        var SpreadActions = (function()
            {
                function SpreadActions(){}
                SpreadActions.navigationLeft = function()
                {
                    return __navigateNoWrap(this, 3)
                };
                SpreadActions.navigationRight = function()
                {
                    return __navigateNoWrap(this, 4)
                };
                SpreadActions.navigationUp = function()
                {
                    return __navigateNoWrap(this, 1)
                };
                SpreadActions.navigationDown = function()
                {
                    return __navigateNoWrap(this, 2)
                };
                SpreadActions.commitArrayFormula = function()
                {
                    var sheet = SpreadActions.handleFormulaTextboxAcrossSheet(this);
                    sheet.commitArrayFormula();
                    return true
                };
                SpreadActions.commitInputNavigationDown = function()
                {
                    var sheet = SpreadActions.handleFormulaTextboxAcrossSheet(this);
                    sheet.moveActiveCell(2, false);
                    return true
                };
                SpreadActions.commitInputNavigationUp = function()
                {
                    var sheet = SpreadActions.handleFormulaTextboxAcrossSheet(this);
                    sheet.moveActiveCell(1, false);
                    return true
                };
                SpreadActions.handleFormulaTextboxAcrossSheet = function(sheet)
                {
                    var actualSheet = sheet;
                    var ftbAcrossSheet = Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                    if (Sheets.features.formulatextbox && ftbAcrossSheet && ftbAcrossSheet.text)
                    {
                        actualSheet = ftbAcrossSheet.sheet;
                        SpreadActions.changeSheetForFormulaTextboxAcrossSheet(actualSheet)
                    }
                    return actualSheet
                };
                SpreadActions.changeSheetForFormulaTextboxAcrossSheet = function(sheet, saveValue)
                {
                    if (typeof saveValue === "undefined")
                    {
                        saveValue = true
                    }
                    var spreadTmp = sheet.parent;
                    var ftbAcrossSheet = Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                    if (Sheets.features.formulatextbox && ftbAcrossSheet && ftbAcrossSheet.text)
                    {
                        spreadTmp._changeSheetForFormulaAcrossSheet(sheet, saveValue)
                    }
                };
                SpreadActions.navigationHome = function()
                {
                    var sheet = this;
                    return __navigateNoWrapFrom(sheet, 4, keyword_null, sheet.frozenColCount ? sheet.frozenColCount - 1 : -1)
                };
                SpreadActions.navigationHome2 = function()
                {
                    var sheet = this;
                    return __navigateNoWrapFrom(sheet, 4, keyword_null, -1)
                };
                SpreadActions.navigationEnd = function()
                {
                    var sheet = this;
                    return __navigateNoWrapFrom(this, 3, keyword_null, sheet.getColumnCount() - sheet._frozenTrailingColCount)
                };
                SpreadActions.navigationEnd2 = function()
                {
                    var sheet = this;
                    return __navigateNoWrapFrom(sheet, 3, keyword_null, sheet.getColumnCount())
                };
                SpreadActions.navigationTop = function()
                {
                    var sheet = this;
                    return __navigateNoWrapFrom(sheet, 2, -1, keyword_null)
                };
                SpreadActions.navigationBottom = function()
                {
                    var sheet = this;
                    return __navigateNoWrapFrom(sheet, 1, sheet.getRowCount(), keyword_null)
                };
                SpreadActions.navigationPageUp = function()
                {
                    var sheet = this;
                    if (!sheet || sheet._editorStatus === 2)
                    {
                        return false
                    }
                    var prevPageTopRow = sheet._getPrevPageTopRow();
                    if (prevPageTopRow === keyword_null || prevPageTopRow === sheet._scrollTopRow)
                    {
                        return true
                    }
                    var rls = sheet._getRowLayout(1, 3);
                    var newActiveRow = sheet._getNextVisualRow(sheet._activeRowIndex - rls.length);
                    if (newActiveRow < prevPageTopRow)
                    {
                        newActiveRow = prevPageTopRow
                    }
                    var fbx = sheet._formulaTextBox;
                    if (fbx && fbx.canAppendRange())
                    {
                        var appendingInfo = sheet._getKeyboardAppendingInfo();
                        appendingInfo.anchorRow = newActiveRow;
                        appendingInfo.leadingRow = newActiveRow;
                        var rangeString = sheet._eventHandler.rangeToString(new Sheets.Range(appendingInfo.anchorRow, appendingInfo.anchorCol, 1, 1));
                        if (rangeString)
                        {
                            fbx.appendRange(rangeString, false, true)
                        }
                        sheet._setTopRow(prevPageTopRow);
                        return true
                    }
                    else if (fbx)
                    {
                        sheet = SpreadActions.handleFormulaTextboxAcrossSheet(sheet)
                    }
                    sheet.endEdit();
                    sheet._setActiveCellCore(newActiveRow, keyword_null);
                    sheet._leadingCellRow = newActiveRow;
                    sheet.moveActiveCell();
                    sheet._setTopRow(prevPageTopRow);
                    return true
                };
                SpreadActions.navigationPageDown = function()
                {
                    var sheet = this;
                    if (!sheet || sheet._editorStatus === 2)
                    {
                        return false
                    }
                    var nextPageTopRow = sheet._getNextPageTopRow();
                    if (nextPageTopRow === keyword_null || nextPageTopRow === sheet._scrollTopRow)
                    {
                        return true
                    }
                    var rls = sheet._getRowLayout(1, 3);
                    var newActiveRow = sheet._getPrevVisualRow(sheet._activeRowIndex + rls.length);
                    if (newActiveRow < nextPageTopRow)
                    {
                        newActiveRow = nextPageTopRow
                    }
                    var fbx = sheet._formulaTextBox;
                    if (fbx && fbx.canAppendRange())
                    {
                        var appendingInfo = sheet._getKeyboardAppendingInfo();
                        appendingInfo.anchorRow = newActiveRow;
                        appendingInfo.leadingRow = newActiveRow;
                        var rangeString = sheet._eventHandler.rangeToString(new Sheets.Range(appendingInfo.anchorRow, appendingInfo.anchorCol, 1, 1));
                        if (rangeString)
                        {
                            fbx.appendRange(rangeString, false, true)
                        }
                        sheet._setTopRow(nextPageTopRow);
                        return true
                    }
                    else if (fbx)
                    {
                        sheet = SpreadActions.handleFormulaTextboxAcrossSheet(sheet)
                    }
                    sheet.endEdit();
                    sheet._setActiveCellCore(newActiveRow, keyword_null);
                    sheet._leadingCellRow = newActiveRow;
                    sheet.moveActiveCell();
                    sheet._setTopRow(nextPageTopRow);
                    return true
                };
                SpreadActions.navigationNextSheet = function()
                {
                    var sheetTmp = this,
                        spreadTmp = sheetTmp.parent,
                        spreadns = GcSpread.Sheets;
                    if (spreadTmp || spreadTmp instanceof spreadns.Spread)
                    {
                        var count = spreadTmp.getSheetCount();
                        var index = spreadTmp.getActiveSheetIndex();
                        if (index < count - 1)
                        {
                            index++;
                            spreadTmp._setActiveSheetIndexImp(index, 1);
                            spreadTmp.repaint()
                        }
                    }
                };
                SpreadActions.navigationPreviousSheet = function()
                {
                    var sheetTmp = this,
                        spreadTmp = sheetTmp.parent,
                        spreadns = GcSpread.Sheets;
                    if (spreadTmp || spreadTmp instanceof spreadns.Spread)
                    {
                        var index = spreadTmp.getActiveSheetIndex();
                        if (index > 0)
                        {
                            index--;
                            spreadTmp._setActiveSheetIndexImp(index, 1);
                            spreadTmp.repaint()
                        }
                    }
                };
                SpreadActions.navigationPrevious = function(){};
                SpreadActions.navigationNext = function(){};
                SpreadActions.navigationFirst = function()
                {
                    var sheet = this;
                    if (!sheet || sheet._editorStatus === 2)
                    {
                        return false
                    }
                    var prevCol = sheet.frozenColCount ? sheet.frozenColCount - 1 : -1;
                    var prevRow = sheet.frozenRowCount ? sheet.frozenRowCount - 1 : -1;
                    var fbx = sheet._formulaTextBox;
                    if (fbx && fbx.canAppendRange())
                    {
                        var eventHandler = sheet._eventHandler,
                            appendingInfo;
                        if (fbx.isAppending)
                        {
                            appendingInfo = eventHandler._formulaRangeAppendingInfo
                        }
                        else
                        {
                            appendingInfo = eventHandler._formulaRangeAppendingInfo = {
                                anchorRow: sheet._activeRowIndex, anchorCol: sheet._activeColIndex, leadingRow: sheet._leadingCellRow, leadingCol: sheet._leadingCellCol
                            }
                        }
                        sheet._moveFormulaTextBoxCell(4, false, appendingInfo.anchorRow, prevCol);
                        sheet._moveFormulaTextBoxCell(2, false, prevRow, appendingInfo.anchorCol);
                        return true
                    }
                    else if (fbx)
                    {
                        sheet = SpreadActions.handleFormulaTextboxAcrossSheet(sheet)
                    }
                    sheet.moveActiveCell(4, false, sheet._activeRowIndex, prevCol);
                    sheet.moveActiveCell(2, false, prevRow, sheet._activeColIndex);
                    return true
                };
                SpreadActions.navigationLast = function()
                {
                    var sheet = this;
                    if (!sheet || sheet._editorStatus === 2)
                    {
                        return false
                    }
                    var fbx = sheet._formulaTextBox;
                    if (fbx && fbx.canAppendRange())
                    {
                        var eventHandler = sheet._eventHandler,
                            appendingInfo;
                        if (fbx.isAppending)
                        {
                            appendingInfo = eventHandler._formulaRangeAppendingInfo
                        }
                        else
                        {
                            appendingInfo = eventHandler._formulaRangeAppendingInfo = {
                                anchorRow: sheet._activeRowIndex, anchorCol: sheet._activeColIndex, leadingRow: sheet._leadingCellRow, leadingCol: sheet._leadingCellCol
                            }
                        }
                        sheet._moveFormulaTextBoxCell(3, false, appendingInfo.anchorRow, sheet.getColumnCount() - sheet._frozenTrailingColCount);
                        sheet._moveFormulaTextBoxCell(1, false, sheet.getRowCount() - sheet._frozenTrailingRowCount, appendingInfo.anchorCol);
                        return true
                    }
                    else if (fbx)
                    {
                        sheet = SpreadActions.handleFormulaTextboxAcrossSheet(sheet)
                    }
                    sheet.moveActiveCell(3, false, sheet._activeRowIndex, sheet.getColumnCount() - sheet._frozenTrailingColCount);
                    sheet.moveActiveCell(1, false, sheet.getRowCount() - sheet._frozenTrailingRowCount, sheet._activeColIndex);
                    return true
                };
                SpreadActions.commitInputNavigationTabNext = function()
                {
                    var sheet = SpreadActions.handleFormulaTextboxAcrossSheet(this);
                    sheet._isTabNavigation = true;
                    if (sheet._isNavigateInSelection)
                    {
                        sheet._moveActiveCellInSelection(4)
                    }
                    else
                    {
                        sheet.moveActiveCell(4, true)
                    }
                    sheet._isTabNavigation = false
                };
                SpreadActions.commitInputNavigationTabPrevious = function()
                {
                    var sheet = SpreadActions.handleFormulaTextboxAcrossSheet(this);
                    sheet._isTabNavigation = true;
                    if (sheet._isNavigateInSelection)
                    {
                        sheet._moveActiveCellInSelection(3)
                    }
                    else
                    {
                        sheet.moveActiveCell(3, true)
                    }
                    sheet._isTabNavigation = false
                };
                SpreadActions.selectNextControl = function()
                {
                    var sheet = this;
                    sheet.endEdit();
                    var eventHandler = sheet._eventHandler;
                    eventHandler.clearRepeatKeyDownTimeout();
                    eventHandler.resetMetaKeyState();
                    Sheets.FocusHelper.setActiveElement(keyword_null);
                    var needCancelDefault = false;
                    var sheetParent = sheet.parent;
                    if (sheetParent)
                    {
                        var nextControl = sheetParent.nextControl();
                        if (nextControl && nextControl.focus)
                        {
                            nextControl.focus();
                            needCancelDefault = true
                        }
                        else
                        {
                            sheetParent.focusTabFocusElement()
                        }
                    }
                    return needCancelDefault
                };
                SpreadActions.selectPreviousControl = function()
                {
                    var sheet = this;
                    sheet.endEdit();
                    var eventHandler = sheet._eventHandler;
                    eventHandler.clearRepeatKeyDownTimeout();
                    eventHandler.resetMetaKeyState();
                    Sheets.FocusHelper.setActiveElement(keyword_null);
                    var needCancelDefault = false;
                    var sheetParent = sheet.parent;
                    if (sheetParent)
                    {
                        var previousControl = sheetParent.previousControl();
                        if (previousControl && previousControl.focus)
                        {
                            previousControl.focus();
                            needCancelDefault = true
                        }
                        else
                        {
                            sheetParent.focusTabFocusElement()
                        }
                    }
                    return needCancelDefault
                };
                SpreadActions.moveToNextCell = function()
                {
                    SpreadActions.commitInputNavigationTabNext.apply(this);
                    return true
                };
                SpreadActions.moveToPreviousCell = function()
                {
                    SpreadActions.commitInputNavigationTabPrevious.apply(this);
                    return true
                };
                SpreadActions.moveToNextCellThenControl = function()
                {
                    var sheet = this;
                    var leadingCellRow = sheet._leadingCellRow;
                    sheet._isTabNavigation = true;
                    var rightCell = sheet._getMoveRightCell(sheet.getActiveRowIndex(), sheet.getActiveColumnIndex(), true, leadingCellRow);
                    sheet._isTabNavigation = false;
                    var isLastVisibleCell = rightCell ? rightCell.leadingCellRow < leadingCellRow : true;
                    if (isLastVisibleCell)
                    {
                        return SpreadActions.selectNextControl.apply(this)
                    }
                    else
                    {
                        return SpreadActions.moveToNextCell.apply(this)
                    }
                };
                SpreadActions.moveToPreviousCellThenControl = function()
                {
                    var sheet = this;
                    var leadingCellRow = sheet._leadingCellRow;
                    sheet._isTabNavigation = true;
                    var leftCell = sheet._getMoveLeftCell(sheet.getActiveRowIndex(), sheet.getActiveColumnIndex(), true, leadingCellRow);
                    sheet._isTabNavigation = false;
                    var isFirstVisibleCell = leftCell ? leftCell.leadingCellRow > leadingCellRow : true;
                    if (isFirstVisibleCell)
                    {
                        return SpreadActions.selectPreviousControl.apply(this)
                    }
                    else
                    {
                        return SpreadActions.moveToPreviousCell.apply(this)
                    }
                };
                SpreadActions.cancelInput = function()
                {
                    var sheet = this;
                    var ftbAcrossSheet = Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                    if (Sheets.features.formulatextbox && ftbAcrossSheet && ftbAcrossSheet.text)
                    {
                        sheet = ftbAcrossSheet.sheet;
                        var rowIndex = ftbAcrossSheet.rowIndex;
                        var columnIndex = ftbAcrossSheet.columnIndex;
                        SpreadActions.changeSheetForFormulaTextboxAcrossSheet(sheet, false);
                        sheet._detachFormulaTextBox();
                        sheet._setActiveCellAndSelection(rowIndex, columnIndex, keyword_undefined, keyword_undefined, 1)
                    }
                    if (sheet.isEditing())
                    {
                        var cacheValue = sheet.getValue(sheet._activeRowIndex, sheet._activeColIndex, 3);
                        sheet.endEdit(true);
                        sheet.setValue(sheet._activeRowIndex, sheet._activeColIndex, cacheValue, 3, true);
                        return true
                    }
                    else
                    {
                        var tempSpread = sheet.parent;
                        if (tempSpread && tempSpread.sheets)
                        {
                            var sheets = tempSpread.sheets;
                            for (var index = 0, len = sheets.length; index < len; index++)
                            {
                                var item = sheets[index];
                                if (item)
                                {
                                    item._cutCopyIndicatorManager.cancelIndicator()
                                }
                            }
                        }
                    }
                };
                SpreadActions.clear = function()
                {
                    var sheet = this;
                    if (!sheet.isEditing())
                    {
                        var ranges = sheet.getSelections();
                        var action = new Sheets.UndoRedo.ClearValueUndoAction(sheet, ranges);
                        if (action.canExecute(sheet))
                        {
                            sheet._doCommand(action)
                        }
                    }
                };
                SpreadActions.clearAndEditing = function()
                {
                    var sheet = this;
                    if (!sheet.isEditing())
                    {
                        sheet.startEdit(true, "");
                        return true
                    }
                    return false
                };
                SpreadActions.copy = function()
                {
                    var sheet = this;
                    sheet._doCopy()
                };
                SpreadActions.cut = function()
                {
                    var sheet = this;
                    sheet._doCut()
                };
                SpreadActions.paste = function()
                {
                    var sheet = this;
                    sheet._doPaste()
                };
                SpreadActions.selectionLeft = function()
                {
                    return __alterSelection(this, 37)
                };
                SpreadActions.selectionRight = function()
                {
                    return __alterSelection(this, 39)
                };
                SpreadActions.selectionUp = function()
                {
                    return __alterSelection(this, 38)
                };
                SpreadActions.selectionDown = function()
                {
                    return __alterSelection(this, 40)
                };
                SpreadActions.selectionHome = function()
                {
                    return __alterSelection(this, 37, true)
                };
                SpreadActions.selectionEnd = function()
                {
                    return __alterSelection(this, 39, true)
                };
                SpreadActions.selectionPageUp = function()
                {
                    return __alterSelection(this, 33)
                };
                SpreadActions.selectionPageDown = function()
                {
                    return __alterSelection(this, 34)
                };
                SpreadActions.selectionTop = function()
                {
                    return __alterSelection(this, 38, true)
                };
                SpreadActions.selectionBottom = function()
                {
                    return __alterSelection(this, 40, true)
                };
                SpreadActions.selectionFirst = function()
                {
                    return __alterSelection(this, 36, true)
                };
                SpreadActions.selectionLast = function()
                {
                    return __alterSelection(this, 35, true)
                };
                SpreadActions.unSelectAllFloatingObjects = function()
                {
                    var sheet = this;
                    if (sheet._hasFloatingObjectsSelected())
                    {
                        sheet._suspendInvalidate();
                        sheet.unSelectAllFloatingObjects();
                        sheet._loadAndSetSheetSelections();
                        sheet._resumeInvalidate()
                    }
                };
                SpreadActions.selectAllFloatingObjects = function()
                {
                    var sheet = this;
                    if (sheet._hasFloatingObjectsSelected())
                    {
                        sheet._suspendInvalidate();
                        for (var i = 0, len = sheet._floatingObjectArray.length; i < len; i++)
                        {
                            var item = sheet._floatingObjectArray[i];
                            if (!item.isSelected())
                            {
                                item.isSelected(true)
                            }
                        }
                        sheet._resumeInvalidate()
                    }
                };
                SpreadActions.deleteFloatingObject = function()
                {
                    var sheet = this;
                    var names = __createFloatingObjectActionExtent(sheet, true);
                    if (names.length > 0)
                    {
                        var deleteExtent = {names: names};
                        var deleteFloationgObjectUndoAction = new Sheets.UndoRedo.DeleteFloatingObjectUndoAction(sheet, deleteExtent);
                        sheet._doCommand(deleteFloationgObjectUndoAction)
                    }
                };
                SpreadActions.navigationNextFloatingObject = function()
                {
                    var sheet = this;
                    if (sheet._hasFloatingObjectsSelected())
                    {
                        sheet._suspendInvalidate();
                        var i,
                            len,
                            selectedIndex = 0;
                        ;
                        for (i = 0, len = sheet._floatingObjectArray.length; i < len; i++)
                        {
                            var item = sheet._floatingObjectArray[i];
                            if (item.isSelected())
                            {
                                selectedIndex = i
                            }
                        }
                        sheet.unSelectAllFloatingObjects();
                        selectedIndex += 1;
                        if (selectedIndex == sheet._floatingObjectArray.length)
                        {
                            selectedIndex = 0
                        }
                        sheet._floatingObjectArray[selectedIndex].isSelected(true);
                        sheet._resumeInvalidate();
                        return true
                    }
                    return false
                };
                SpreadActions.navigationPreviousFloatingObject = function()
                {
                    var sheet = this;
                    if (sheet._hasFloatingObjectsSelected())
                    {
                        sheet._suspendInvalidate();
                        var i,
                            len,
                            selectedIndex = 0;
                        ;
                        for (i = 0, len = sheet._floatingObjectArray.length; i < len; i++)
                        {
                            var item = sheet._floatingObjectArray[i];
                            if (item.isSelected())
                            {
                                selectedIndex = i
                            }
                        }
                        sheet.unSelectAllFloatingObjects();
                        selectedIndex -= 1;
                        if (selectedIndex < 0)
                        {
                            selectedIndex = sheet._floatingObjectArray.length - 1
                        }
                        sheet._floatingObjectArray[selectedIndex].isSelected(true);
                        sheet._resumeInvalidate();
                        return true
                    }
                    return false
                };
                SpreadActions.clipboardCutFloatingObject = function()
                {
                    var sheet = this;
                    sheet._doFloatingObjectCut()
                };
                SpreadActions.clipboardCopyFloatingObject = function()
                {
                    var sheet = this;
                    sheet._doFloatingObjectCopy()
                };
                SpreadActions.clipboardPasteFloatingObject = function()
                {
                    var sheet = this;
                    sheet._doFloatingObjectPaste()
                };
                SpreadActions.moveFloatingObjectUp = function()
                {
                    var sheet = this;
                    var names = [];
                    var i,
                        len,
                        selectedIndex = 0;
                    ;
                    for (i = 0, len = sheet._floatingObjectArray.length; i < len; i++)
                    {
                        var item = sheet._floatingObjectArray[i];
                        if (item.isSelected())
                        {
                            names.push(item.name())
                        }
                    }
                    var movingFloatingObjectUndoAction = new Sheets.UndoRedo.MovingFloatingObjectUndoAction(sheet, {names: names}, {
                            offsetX: 0, offsetY: -1
                        });
                    sheet._doCommand(movingFloatingObjectUndoAction)
                };
                SpreadActions.moveFloatingObjectDown = function()
                {
                    var sheet = this;
                    var names = [];
                    var i,
                        len,
                        selectedIndex = 0;
                    ;
                    for (i = 0, len = sheet._floatingObjectArray.length; i < len; i++)
                    {
                        var item = sheet._floatingObjectArray[i];
                        if (item.isSelected())
                        {
                            names.push(item.name())
                        }
                    }
                    var movingFloatingObjectUndoAction = new Sheets.UndoRedo.MovingFloatingObjectUndoAction(sheet, {names: names}, {
                            offsetX: 0, offsetY: 1
                        });
                    sheet._doCommand(movingFloatingObjectUndoAction)
                };
                SpreadActions.moveFloatingObjectLeft = function()
                {
                    var sheet = this;
                    var names = [];
                    var i,
                        len,
                        selectedIndex = 0;
                    ;
                    for (i = 0, len = sheet._floatingObjectArray.length; i < len; i++)
                    {
                        var item = sheet._floatingObjectArray[i];
                        if (item.isSelected())
                        {
                            names.push(item.name())
                        }
                    }
                    var movingFloatingObjectUndoAction = new Sheets.UndoRedo.MovingFloatingObjectUndoAction(sheet, {names: names}, {
                            offsetX: -1, offsetY: 0
                        });
                    sheet._doCommand(movingFloatingObjectUndoAction)
                };
                SpreadActions.moveFloatingObjectRight = function()
                {
                    var sheet = this;
                    var names = [];
                    var i,
                        len,
                        selectedIndex = 0;
                    ;
                    for (i = 0, len = sheet._floatingObjectArray.length; i < len; i++)
                    {
                        var item = sheet._floatingObjectArray[i];
                        if (item.isSelected())
                        {
                            names.push(item.name())
                        }
                    }
                    var movingFloatingObjectUndoAction = new Sheets.UndoRedo.MovingFloatingObjectUndoAction(sheet, {names: names}, {
                            offsetX: 1, offsetY: 0
                        });
                    sheet._doCommand(movingFloatingObjectUndoAction)
                };
                SpreadActions.deleteComment = function()
                {
                    var sheet = this;
                    var activeComment = sheet._commentManager.getActiveComment();
                    if (activeComment)
                    {
                        var commentDeleteUndoAction = new Sheets.UndoRedo.CommentDeleteUndoAction(sheet, activeComment);
                        sheet._doCommand(commentDeleteUndoAction)
                    }
                };
                SpreadActions.deactivateComment = function()
                {
                    var sheet = this;
                    sheet._commentManager.deactivateComment();
                    sheet._loadAndSetSheetSelections();
                    sheet.repaint()
                };
                SpreadActions.moveCommentUp = function()
                {
                    var sheet = this;
                    var activeComment = sheet._commentManager.getActiveComment();
                    if (activeComment)
                    {
                        var action = new Sheets.UndoRedo.CommentPropertyUndoAction(sheet, activeComment, activeComment.location().clone(), new Sheets.Point(activeComment.location().x, activeComment.location().y - 1), "location");
                        sheet._doCommand(action)
                    }
                };
                SpreadActions.moveCommentDown = function()
                {
                    var sheet = this;
                    var activeComment = sheet._commentManager.getActiveComment();
                    if (activeComment)
                    {
                        var action = new Sheets.UndoRedo.CommentPropertyUndoAction(sheet, activeComment, activeComment.location().clone(), new Sheets.Point(activeComment.location().x, activeComment.location().y + 1), "location");
                        sheet._doCommand(action)
                    }
                };
                SpreadActions.moveCommentLeft = function()
                {
                    var sheet = this;
                    var activeComment = sheet._commentManager.getActiveComment();
                    if (activeComment)
                    {
                        var action = new Sheets.UndoRedo.CommentPropertyUndoAction(sheet, activeComment, activeComment.location().clone(), new Sheets.Point(activeComment.location().x - 1, activeComment.location().y), "location");
                        sheet._doCommand(action)
                    }
                };
                SpreadActions.moveCommentRight = function()
                {
                    var sheet = this;
                    var activeComment = sheet._commentManager.getActiveComment();
                    if (activeComment)
                    {
                        var action = new Sheets.UndoRedo.CommentPropertyUndoAction(sheet, activeComment, activeComment.location().clone(), new Sheets.Point(activeComment.location().x + 1, activeComment.location().y), "location");
                        sheet._doCommand(action)
                    }
                };
                SpreadActions.changeFormulaReference = function()
                {
                    var sheet = this;
                    if (!sheet || !sheet._formulaTextBox)
                    {
                        return
                    }
                    var eventHandler = sheet._eventHandler;
                    if (eventHandler)
                    {
                        sheet._suspendInvalidate();
                        try
                        {
                            eventHandler.changeFormulaReference()
                        }
                        finally
                        {
                            sheet._resumeInvalidate()
                        }
                    }
                };
                SpreadActions.undo = function()
                {
                    var sheet = this;
                    var undoManager = sheet.undoManager();
                    if (undoManager.canUndo())
                    {
                        undoManager.undo()
                    }
                };
                SpreadActions.redo = function()
                {
                    var sheet = this;
                    var undoManager = sheet.undoManager();
                    if (undoManager.canRedo())
                    {
                        undoManager.redo()
                    }
                };
                return SpreadActions
            })();
        Sheets.SpreadActions = SpreadActions
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        (function(UndoRedo)
        {
            var keyword_null = null,
                keyword_undefined = undefined,
                Math_min = Math.min,
                Math_max = Math.max,
                Math_ceil = Math.ceil,
                Math_floor = Math.floor;
            var CellData = (function()
                {
                    function CellData(row, column, value)
                    {
                        var self = this;
                        self.row = row;
                        self.column = column;
                        self.value = value
                    }
                    return CellData
                })();
            UndoRedo.CellData = CellData;
            var ChangedCells = (function()
                {
                    function ChangedCells(sheet, range, dataType)
                    {
                        var self = this;
                        self.sheet = sheet;
                        self.range = range;
                        self.dataType = dataType;
                        self.cellsHasData = [];
                        self.changedCells = [];
                        self.initCellsHasData()
                    }
                    ChangedCells.prototype.initCellsHasData = function()
                    {
                        var self = this,
                            range = self.range,
                            sheet = self.sheet;
                        if (!sheet || !range)
                        {
                            return
                        }
                        var dataType = self.dataType,
                            baseRow = range.row,
                            baseColumn = range.col,
                            rowCount = range.rowCount,
                            columnCount = range.colCount,
                            cellsHasData = self.cellsHasData;
                        for (var r = 0; r < rowCount; r++)
                        {
                            for (var c = 0; c < columnCount; c++)
                            {
                                var formulaInfo;
                                if ((dataType & 2) > 0)
                                {
                                    formulaInfo = sheet.getFormulaInformation(baseRow + r, baseColumn + c);
                                    if (formulaInfo.hasFormula)
                                    {
                                        if (formulaInfo.isArrayFormula)
                                        {
                                            var baseRange = formulaInfo.baseRange;
                                            if (baseRange.row === baseRow + r && baseRange.col === baseColumn + c)
                                            {
                                                for (var rowIndex = baseRange.row, len = baseRange.row + baseRange.rowCount; rowIndex < len; rowIndex++)
                                                {
                                                    for (var colIndex = baseRange.col, len1 = baseRange.col + baseRange.colCount; colIndex < len1; colIndex++)
                                                    {
                                                        self.setCellDatas(cellsHasData, rowIndex - baseRow, colIndex - baseColumn, formulaInfo, 2)
                                                    }
                                                }
                                            }
                                        }
                                        else
                                        {
                                            self.setCellDatas(cellsHasData, r, c, formulaInfo.formula, 2)
                                        }
                                    }
                                }
                                if ((dataType & 1) > 0 && (!formulaInfo || !formulaInfo.hasFormula))
                                {
                                    self.setCellDatas(cellsHasData, r, c, sheet.getValue(baseRow + r, baseColumn + c, 3), 1)
                                }
                                if ((dataType & 16) > 0)
                                {
                                    var sparkline = sheet.getSparkline(baseRow + r, baseColumn + c);
                                    var dataRange = keyword_null;
                                    if (sparkline)
                                    {
                                        dataRange = sparkline.data()
                                    }
                                    if (sparkline && dataRange)
                                    {
                                        self.setCellDatas(cellsHasData, r, c, sparkline, 16)
                                    }
                                }
                                if ((dataType & 64) > 0)
                                {
                                    var styleObject = sheet.getStyleObject(baseRow + r, baseColumn + c, 3);
                                    var styleString = keyword_undefined;
                                    if (styleObject && styleObject.toJSON)
                                    {
                                        styleString = JSON.stringify(styleObject.toJSON(3, true))
                                    }
                                    self.setCellDatas(cellsHasData, r, c, styleString, 64)
                                }
                                if ((dataType & 4) > 0)
                                {
                                    self.setCellDatas(cellsHasData, r, c, sheet.getComment(baseRow + r, baseColumn + c), 4)
                                }
                                if ((dataType & 128) > 0)
                                {
                                    self.setCellDatas(cellsHasData, r, c, sheet.getTag(baseRow + r, baseColumn + c, 3), 128)
                                }
                                if ((dataType & 256) > 0)
                                {
                                    self.setCellDatas(cellsHasData, r, c, sheet.getBindingPath(baseRow + r, baseColumn + c, 3), 256)
                                }
                            }
                        }
                    };
                    ChangedCells.prototype.getCellsHasData = function()
                    {
                        return this.cellsHasData
                    };
                    ChangedCells.prototype.setCellDatas = function(cellsHasData, r, c, data, dataType)
                    {
                        if (data === keyword_undefined || data === keyword_null || !cellsHasData)
                        {
                            return
                        }
                        if (cellsHasData[r] === keyword_undefined)
                        {
                            cellsHasData[r] = []
                        }
                        if (cellsHasData[r][c] === keyword_undefined)
                        {
                            cellsHasData[r][c] = {}
                        }
                        cellsHasData[r][c][Sheets.CopyToOption[dataType]] = data
                    };
                    ChangedCells.prototype.mergeCellsHasDiffData = function(outerData)
                    {
                        if (!outerData)
                        {
                            return
                        }
                        var self = this;
                        var cellsHasData = self.cellsHasData;
                        for (var r = 0, len = outerData.length; r < len; r++)
                        {
                            var outerRowData = outerData[r];
                            if (outerRowData)
                            {
                                for (var c = 0, len1 = outerRowData.length; c < len1; c++)
                                {
                                    var outerCellData = outerRowData[c];
                                    if (outerCellData)
                                    {
                                        if (!cellsHasData[r])
                                        {
                                            cellsHasData[r] = []
                                        }
                                        var cellData = cellsHasData[r][c];
                                        if (!cellData)
                                        {
                                            cellsHasData[r][c] = outerCellData
                                        }
                                        else
                                        {
                                            if (self.isDataEqual(outerCellData, cellData))
                                            {
                                                cellsHasData[r][c] = keyword_undefined
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    };
                    ChangedCells.prototype.isDataEqual = function(obj1, obj2)
                    {
                        var dataType = this.dataType,
                            dataPropStrs = [];
                        if (dataType & 256)
                        {
                            dataPropStrs.push(Sheets.CopyToOption[256])
                        }
                        if (dataType & 4)
                        {
                            dataPropStrs.push(Sheets.CopyToOption[4])
                        }
                        if (dataType & 2)
                        {
                            dataPropStrs.push(Sheets.CopyToOption[2])
                        }
                        if (dataType & 16)
                        {
                            dataPropStrs.push(Sheets.CopyToOption[16])
                        }
                        if (dataType & 64)
                        {
                            dataPropStrs.push(Sheets.CopyToOption[64])
                        }
                        if (dataType & 128)
                        {
                            dataPropStrs.push(Sheets.CopyToOption[128])
                        }
                        if (dataType & 1)
                        {
                            dataPropStrs.push(Sheets.CopyToOption[1])
                        }
                        for (var i = 0, len = dataPropStrs.length; i < len; i++)
                        {
                            var dataPropStr = dataPropStrs[i];
                            if (obj1[dataPropStr] !== obj2[dataPropStr])
                            {
                                return false
                            }
                        }
                        return true
                    };
                    ChangedCells.prototype.getChangedCells = function()
                    {
                        var self = this,
                            changedCells = [],
                            baseRow = self.range.row,
                            baseColumn = self.range.col,
                            cellsHasData = self.cellsHasData;
                        if (self.changedCells && self.changedCells.length > 0)
                        {
                            return self.changedCells
                        }
                        for (var r = 0, len = cellsHasData.length; r < len; r++)
                        {
                            var rowData = cellsHasData[r];
                            if (rowData)
                            {
                                for (var c = 0, len1 = rowData.length; c < len1; c++)
                                {
                                    if (rowData[c])
                                    {
                                        changedCells.push(new Sheets.CellPosition(r + baseRow, c + baseColumn))
                                    }
                                }
                            }
                        }
                        self.changedCells = changedCells;
                        return changedCells
                    };
                    return ChangedCells
                })();
            UndoRedo.ChangedCells = ChangedCells;
            var CopyMoveSheetInfo = (function()
                {
                    function CopyMoveSheetInfo(){}
                    CopyMoveSheetInfo.prototype.saveDefaultStyle = function(style)
                    {
                        this._defaultStyle = style;
                        this._defaultStyleSaved = true
                    };
                    CopyMoveSheetInfo.prototype.getDefaultStyle = function()
                    {
                        return this._defaultStyle
                    };
                    CopyMoveSheetInfo.prototype.saveDefaultColumnWidth = function(width)
                    {
                        this._defaultColumnWidth = width;
                        this._defaultColumnWidthSaved = true
                    };
                    CopyMoveSheetInfo.prototype.getDefaultColumnWidth = function()
                    {
                        return this._defaultColumnWidth
                    };
                    CopyMoveSheetInfo.prototype.saveDefaultRowHeight = function(height)
                    {
                        this._defaultRowHeight = height;
                        this._defaultRowHeightSaved = true
                    };
                    CopyMoveSheetInfo.prototype.getDefaultRowHeight = function()
                    {
                        return this._defaultRowHeight
                    };
                    CopyMoveSheetInfo.prototype.getTag = function()
                    {
                        return this._tag
                    };
                    CopyMoveSheetInfo.prototype.saveColumnHeaderDefaultStyle = function(style)
                    {
                        this._columnHeaderDefaultStyle = style;
                        this._columnHeaderDefaultStyleSaved = true
                    };
                    CopyMoveSheetInfo.prototype.getColumnHeaderDefaultStyle = function()
                    {
                        return this._columnHeaderDefaultStyle
                    };
                    CopyMoveSheetInfo.prototype.saveColumnHeaderDefaultRowHeight = function(height)
                    {
                        this._columnHeaderDefaultRowHeight = height;
                        this._columnHeaderDefaultRowHeightSaved = true
                    };
                    CopyMoveSheetInfo.prototype.getColumnHeaderDefaultRowHeight = function()
                    {
                        return this._columnHeaderDefaultRowHeight
                    };
                    CopyMoveSheetInfo.prototype.saveRowHeaderDefaultStyle = function(style)
                    {
                        this._rowHeaderDefaultStyle = style;
                        this._rowHeaderDefaultStyleSaved = true
                    };
                    CopyMoveSheetInfo.prototype.getRowHeaderDefaultStyle = function()
                    {
                        return this._rowHeaderDefaultStyle
                    };
                    CopyMoveSheetInfo.prototype.saveRowHeaderDefaultColumnWidth = function(width)
                    {
                        this._rowHeaderDefaultColumnWidth = width;
                        this._rowHeaderDefaultColumnWidthSaved = true
                    };
                    CopyMoveSheetInfo.prototype.getRowHeaderDefaultColumnWidth = function()
                    {
                        return this._rowHeaderDefaultColumnWidth
                    };
                    CopyMoveSheetInfo.prototype.saveCommentManager = function(commentManager)
                    {
                        this._commentManager = commentManager;
                        this._commentManagerSaved = true
                    };
                    CopyMoveSheetInfo.prototype.saveTag = function(value)
                    {
                        this._tag = value;
                        this._tagSaved = true
                    };
                    CopyMoveSheetInfo.prototype.isDefaultStyleSaved = function()
                    {
                        return this._defaultStyleSaved
                    };
                    CopyMoveSheetInfo.prototype.isDefaultColumnWidthSaved = function()
                    {
                        return this._defaultColumnWidthSaved
                    };
                    CopyMoveSheetInfo.prototype.isDefaultRowHeightSaved = function()
                    {
                        return this._defaultRowHeightSaved
                    };
                    CopyMoveSheetInfo.prototype.isColumnHeaderDefaultStyleSaved = function()
                    {
                        return this._columnHeaderDefaultStyleSaved
                    };
                    CopyMoveSheetInfo.prototype.isColumnHeaderDefaultRowHeightSaved = function()
                    {
                        return this._columnHeaderDefaultRowHeightSaved
                    };
                    CopyMoveSheetInfo.prototype.isRowHeaderDefaultStyleSaved = function()
                    {
                        return this._rowHeaderDefaultStyleSaved
                    };
                    CopyMoveSheetInfo.prototype.isRowHeaderDefaultColumnWidthSaved = function()
                    {
                        return this._rowHeaderDefaultColumnWidthSaved
                    };
                    CopyMoveSheetInfo.prototype.isCommentManagerSaved = function()
                    {
                        return this._commentManagerSaved
                    };
                    CopyMoveSheetInfo.prototype.isTagSaved = function()
                    {
                        return this._tagSaved
                    };
                    return CopyMoveSheetInfo
                })();
            UndoRedo.CopyMoveSheetInfo = CopyMoveSheetInfo;
            var CopyMoveCellsInfo = (function()
                {
                    function CopyMoveCellsInfo(rowCount, columnCount)
                    {
                        var self = this;
                        self._rowCount = rowCount;
                        self._columnCount = columnCount;
                        self._init()
                    }
                    CopyMoveCellsInfo.prototype._init = function()
                    {
                        var self = this;
                        self._values = [];
                        self._formulas = [];
                        self._sparklines = [];
                        self._styles = [];
                        self._comments = [];
                        self._tags = [];
                        self._bindingPaths = [];
                        self._spans = keyword_null;
                        self._arrayFormulas = [];
                        self._valueSaved = false;
                        self._formulaSaved = false;
                        self._sparklineSaved = false;
                        self._styleSaved = false;
                        self._commentSaved = false;
                        self._tagSaved = false;
                        self._spanSaved = false;
                        self._arrayFormulaSaved = false;
                        self._bindingPathSaved = false
                    };
                    CopyMoveCellsInfo.prototype.saveValue = function(row, column, value)
                    {
                        if (value !== keyword_undefined && value !== keyword_null)
                        {
                            this._values.push(new CellData(row, column, value))
                        }
                        this._valueSaved = true
                    };
                    CopyMoveCellsInfo.prototype.getValues = function()
                    {
                        return this._values
                    };
                    CopyMoveCellsInfo.prototype.saveFormula = function(row, column, formula)
                    {
                        if (formula && formula !== "")
                        {
                            this._formulas.push(new CellData(row, column, formula))
                        }
                        this._formulaSaved = true
                    };
                    CopyMoveCellsInfo.prototype.getFormulas = function()
                    {
                        return this._formulas
                    };
                    CopyMoveCellsInfo.prototype.saveArrayFormula = function(arrayFormulaInfo)
                    {
                        this._arrayFormulas.push(arrayFormulaInfo);
                        this._arrayFormulaSaved = true
                    };
                    CopyMoveCellsInfo.prototype.getArrayFormula = function()
                    {
                        return this._arrayFormulas
                    };
                    CopyMoveCellsInfo.prototype.saveSparkline = function(row, column, sparkline)
                    {
                        if (sparkline)
                        {
                            this._sparklines.push(new CellData(row, column, sparkline))
                        }
                        this._sparklineSaved = true
                    };
                    CopyMoveCellsInfo.prototype.getSparklines = function()
                    {
                        return this._sparklines
                    };
                    CopyMoveCellsInfo.prototype.saveStyle = function(row, column, style)
                    {
                        if (style)
                        {
                            this._styles.push(new CellData(row, column, style))
                        }
                        this._styleSaved = true
                    };
                    CopyMoveCellsInfo.prototype.getStyles = function()
                    {
                        return this._styles
                    };
                    CopyMoveCellsInfo.prototype.saveComment = function(row, column, comment)
                    {
                        if (comment)
                        {
                            this._comments.push(new CellData(row, column, comment))
                        }
                        this._commentSaved = true
                    };
                    CopyMoveCellsInfo.prototype.getComments = function()
                    {
                        return this._comments
                    };
                    CopyMoveCellsInfo.prototype.saveTag = function(row, column, tag)
                    {
                        if (tag !== keyword_undefined && tag !== keyword_null)
                        {
                            this._tags.push(new CellData(row, column, tag))
                        }
                        this._tagSaved = true
                    };
                    CopyMoveCellsInfo.prototype.getTags = function()
                    {
                        return this._tags
                    };
                    CopyMoveCellsInfo.prototype.saveBindingPath = function(row, column, path)
                    {
                        if (path !== keyword_undefined && path !== keyword_null)
                        {
                            this._bindingPaths.push(new CellData(row, column, path))
                        }
                        this._bindingPathSaved = true
                    };
                    CopyMoveCellsInfo.prototype.getBindingPaths = function()
                    {
                        return this._bindingPaths
                    };
                    CopyMoveCellsInfo.prototype.saveSpan = function(span)
                    {
                        var self = this;
                        if (!self._spans)
                        {
                            self._spans = []
                        }
                        self._spans.push(span);
                        self._spanSaved = true
                    };
                    CopyMoveCellsInfo.prototype.isValueOrFormulaSaved = function()
                    {
                        return this._valueSaved || this._formulaSaved || this._arrayFormulaSaved
                    };
                    CopyMoveCellsInfo.prototype.isValueSaved = function()
                    {
                        return this._valueSaved
                    };
                    CopyMoveCellsInfo.prototype.isFormulaSaved = function()
                    {
                        return this._formulaSaved
                    };
                    CopyMoveCellsInfo.prototype.isArrayFormulaSaved = function()
                    {
                        return this._arrayFormulaSaved
                    };
                    CopyMoveCellsInfo.prototype.isSparklineSaved = function()
                    {
                        return this._sparklineSaved
                    };
                    CopyMoveCellsInfo.prototype.isStyleSaved = function()
                    {
                        return this._styleSaved
                    };
                    CopyMoveCellsInfo.prototype.isCommentSaved = function()
                    {
                        return this._commentSaved
                    };
                    CopyMoveCellsInfo.prototype.isTagSaved = function()
                    {
                        return this._tagSaved
                    };
                    CopyMoveCellsInfo.prototype.isSpanSaved = function()
                    {
                        return this._spanSaved
                    };
                    CopyMoveCellsInfo.prototype.isBindingPathSaved = function()
                    {
                        return this._bindingPathSaved
                    };
                    return CopyMoveCellsInfo
                })();
            UndoRedo.CopyMoveCellsInfo = CopyMoveCellsInfo;
            var CopyMoveColumnsInfo = (function()
                {
                    function CopyMoveColumnsInfo(columnCount)
                    {
                        this._columnCount = columnCount;
                        this._init()
                    }
                    CopyMoveColumnsInfo.prototype._init = function()
                    {
                        var self = this;
                        self._widths = {};
                        self._visibles = {};
                        self._resizables = {};
                        self._tags = {};
                        self._viewportColumnStyles = {};
                        self._headerColumnStyles = {};
                        self._levels = {};
                        self._collapsed = {};
                        self._bindingFields = {};
                        self._widthSaved = false;
                        self._visibleSaved = false;
                        self._resizableSaved = false;
                        self._tagSaved = false;
                        self._viewportColumnStyleSaved = false;
                        self._headerColumnStyleSaved = false;
                        self._rangeGroupSaved = false;
                        self._bindingFieldSaved = false
                    };
                    CopyMoveColumnsInfo.prototype.saveWidth = function(index, width)
                    {
                        var self = this;
                        if (self._widths[index] !== keyword_null)
                        {
                            if (width < 0)
                            {
                                self._widths[index] = keyword_null
                            }
                            else
                            {
                                self._widths[index] = width
                            }
                        }
                        else
                        {
                            if (width >= 0)
                            {
                                self._widths[index] = width
                            }
                        }
                        self._widthSaved = true
                    };
                    CopyMoveColumnsInfo.prototype.getWidth = function(index)
                    {
                        if (this._widths[index] !== keyword_null)
                        {
                            return this._widths[index]
                        }
                        return -1
                    };
                    CopyMoveColumnsInfo.prototype.saveVisible = function(index, visible)
                    {
                        var self = this;
                        if (self._visibles[index] !== keyword_null)
                        {
                            if (visible)
                            {
                                self._visibles[index] = keyword_null
                            }
                            else
                            {
                                self._visibles[index] = visible
                            }
                        }
                        else
                        {
                            if (!visible)
                            {
                                self._visibles[index] = visible
                            }
                        }
                        self._visibleSaved = true
                    };
                    CopyMoveColumnsInfo.prototype.getVisible = function(index)
                    {
                        if (this._visibles[index] !== keyword_null)
                        {
                            return this._visibles[index]
                        }
                        return true
                    };
                    CopyMoveColumnsInfo.prototype.saveResizable = function(index, resizable)
                    {
                        var self = this;
                        if (self._resizables[index] !== keyword_null)
                        {
                            if (resizable)
                            {
                                self._resizables[index] = keyword_null
                            }
                            else
                            {
                                self._resizables[index] = resizable
                            }
                        }
                        else
                        {
                            if (!resizable)
                            {
                                self._resizables[index] = resizable
                            }
                        }
                        self._resizableSaved = true
                    };
                    CopyMoveColumnsInfo.prototype.getResizable = function(index)
                    {
                        if (this._resizables[index] !== keyword_null)
                        {
                            return this._resizables[index]
                        }
                        return true
                    };
                    CopyMoveColumnsInfo.prototype.saveTag = function(index, tag)
                    {
                        var self = this;
                        if (tag !== keyword_undefined && tag !== keyword_null)
                        {
                            self._tags[index] = tag
                        }
                        else
                        {
                            self._tags[index] = keyword_null
                        }
                        self._tagSaved = true
                    };
                    CopyMoveColumnsInfo.prototype.getTag = function(index)
                    {
                        return this._tags[index]
                    };
                    CopyMoveColumnsInfo.prototype.saveViewportColumnStyle = function(index, style)
                    {
                        var self = this;
                        if (self._viewportColumnStyles[index])
                        {
                            if (!style)
                            {
                                self._viewportColumnStyles[index] = keyword_null
                            }
                            else
                            {
                                self._viewportColumnStyles[index] = style
                            }
                        }
                        else
                        {
                            if (style)
                            {
                                self._viewportColumnStyles[index] = style
                            }
                        }
                        self._viewportColumnStyleSaved = true
                    };
                    CopyMoveColumnsInfo.prototype.getViewportColumnStyle = function(index)
                    {
                        if (this._viewportColumnStyles[index])
                        {
                            return this._viewportColumnStyles[index]
                        }
                        return keyword_null
                    };
                    CopyMoveColumnsInfo.prototype.saveHeaderColumnStyle = function(index, style)
                    {
                        var self = this;
                        if (self._headerColumnStyles[index])
                        {
                            if (!style)
                            {
                                self._headerColumnStyles[index] = keyword_null
                            }
                            else
                            {
                                self._headerColumnStyles[index] = style
                            }
                        }
                        else
                        {
                            if (style)
                            {
                                self._headerColumnStyles[index] = style
                            }
                        }
                        self._headerColumnStyleSaved = true
                    };
                    CopyMoveColumnsInfo.prototype.getHeaderColumnStyle = function(index)
                    {
                        if (this._headerColumnStyles[index])
                        {
                            return this._headerColumnStyles[index]
                        }
                        return keyword_null
                    };
                    CopyMoveColumnsInfo.prototype.saveRangeGroup = function(index, level, collapsed)
                    {
                        var self = this;
                        if (self._levels[index] !== keyword_null)
                        {
                            if (level < 0)
                            {
                                self._levels[index] = keyword_null
                            }
                            else
                            {
                                self._levels[index] = level
                            }
                        }
                        else
                        {
                            if (level >= 0)
                            {
                                self._levels[index] = level
                            }
                        }
                        if (self._collapsed[index] !== keyword_null)
                        {
                            if (collapsed)
                            {
                                self._collapsed[index] = collapsed
                            }
                            else
                            {
                                self._collapsed[index] = keyword_null
                            }
                        }
                        else
                        {
                            if (collapsed)
                            {
                                self._collapsed[index] = collapsed
                            }
                        }
                        self._rangeGroupSaved = true
                    };
                    CopyMoveColumnsInfo.prototype.getRangeGroup = function(index, outData)
                    {
                        var self = this;
                        outData.level = -1;
                        outData.collapsed = false;
                        if (self._levels[index] !== keyword_null)
                        {
                            outData.level = self._levels[index]
                        }
                        if (self._collapsed[index] !== keyword_null)
                        {
                            outData.collapsed = self._collapsed[index]
                        }
                    };
                    CopyMoveColumnsInfo.prototype.saveBindingField = function(index, fieldName)
                    {
                        this._bindingFields[index] = fieldName;
                        this._bindingFieldSaved = true
                    };
                    CopyMoveColumnsInfo.prototype.getBindingField = function(index, outData)
                    {
                        outData.fieldName = keyword_null;
                        if (this._bindingFields[index] !== keyword_null)
                        {
                            outData.fieldName = this._bindingFields[index];
                            return true
                        }
                        return false
                    };
                    CopyMoveColumnsInfo.prototype.isWidthSaved = function()
                    {
                        return this._widthSaved
                    };
                    CopyMoveColumnsInfo.prototype.isVisibleSaved = function()
                    {
                        return this._visibleSaved
                    };
                    CopyMoveColumnsInfo.prototype.isResizableSaved = function()
                    {
                        return this._resizableSaved
                    };
                    CopyMoveColumnsInfo.prototype.isTagSaved = function()
                    {
                        return this._tagSaved
                    };
                    CopyMoveColumnsInfo.prototype.isViewportColumnStyleSaved = function()
                    {
                        return this._viewportColumnStyleSaved
                    };
                    CopyMoveColumnsInfo.prototype.isHeaderColumnStyleSaved = function()
                    {
                        return this._headerColumnStyleSaved
                    };
                    CopyMoveColumnsInfo.prototype.isRangeGroupSaved = function()
                    {
                        return this._rangeGroupSaved
                    };
                    CopyMoveColumnsInfo.prototype.isBindingFieldSaved = function()
                    {
                        return this._bindingFieldSaved
                    };
                    return CopyMoveColumnsInfo
                })();
            UndoRedo.CopyMoveColumnsInfo = CopyMoveColumnsInfo;
            var CopyMoveRowsInfo = (function()
                {
                    function CopyMoveRowsInfo(rowCount)
                    {
                        this._rowCount = rowCount;
                        this._init()
                    }
                    CopyMoveRowsInfo.prototype._init = function()
                    {
                        var self = this;
                        self._heights = {};
                        self._visibles = {};
                        self._resizables = {};
                        self._tags = {};
                        self._viewportRowStyles = {};
                        self._headerRowStyles = {};
                        self._levels = {};
                        self._collapsed = {};
                        self._heightSaved = false;
                        self._visibleSaved = false;
                        self._resizableSaved = false;
                        self._tagSaved = false;
                        self._viewportRowStyleSaved = false;
                        self._headerRowStyleSaved = false;
                        self._rangeGroupSaved = false
                    };
                    CopyMoveRowsInfo.prototype.saveHeight = function(index, height)
                    {
                        var self = this;
                        if (self._heights[index] !== keyword_null)
                        {
                            if (height < 0)
                            {
                                self._heights[index] = keyword_null
                            }
                            else
                            {
                                self._heights[index] = height
                            }
                        }
                        else
                        {
                            if (height >= 0)
                            {
                                self._heights[index] = height
                            }
                        }
                        self._heightSaved = true
                    };
                    CopyMoveRowsInfo.prototype.getHeight = function(index)
                    {
                        if (this._heights[index] !== keyword_null)
                        {
                            return this._heights[index]
                        }
                        return -1
                    };
                    CopyMoveRowsInfo.prototype.saveVisible = function(index, visible)
                    {
                        var self = this;
                        if (self._visibles[index] !== keyword_null)
                        {
                            if (visible)
                            {
                                self._visibles[index] = keyword_null
                            }
                            else
                            {
                                self._visibles[index] = visible
                            }
                        }
                        else
                        {
                            if (!visible)
                            {
                                self._visibles[index] = visible
                            }
                        }
                        self._visibleSaved = true
                    };
                    CopyMoveRowsInfo.prototype.getVisible = function(index)
                    {
                        if (this._visibles[index] !== keyword_null)
                        {
                            return this._visibles[index]
                        }
                        return true
                    };
                    CopyMoveRowsInfo.prototype.saveResizable = function(index, resizable)
                    {
                        var self = this;
                        if (self._resizables[index] !== keyword_null)
                        {
                            if (resizable)
                            {
                                self._resizables[index] = keyword_null
                            }
                            else
                            {
                                self._resizables[index] = resizable
                            }
                        }
                        else
                        {
                            if (!resizable)
                            {
                                self._resizables[index] = resizable
                            }
                        }
                        self._resizableSaved = true
                    };
                    CopyMoveRowsInfo.prototype.getResizable = function(index)
                    {
                        if (this._resizables[index] !== keyword_null)
                        {
                            return this._resizables[index]
                        }
                        return true
                    };
                    CopyMoveRowsInfo.prototype.saveTag = function(index, tag)
                    {
                        var self = this;
                        if (tag !== keyword_undefined && tag !== keyword_null)
                        {
                            self._tags[index] = tag
                        }
                        else
                        {
                            self._tags[index] = keyword_null
                        }
                        self._tagSaved = true
                    };
                    CopyMoveRowsInfo.prototype.getTag = function(index)
                    {
                        return this._tags[index]
                    };
                    CopyMoveRowsInfo.prototype.saveViewportRowStyle = function(index, style)
                    {
                        var self = this;
                        if (self._viewportRowStyles[index])
                        {
                            if (!style)
                            {
                                self._viewportRowStyles[index] = keyword_null
                            }
                            else
                            {
                                self._viewportRowStyles[index] = style
                            }
                        }
                        else
                        {
                            if (style)
                            {
                                self._viewportRowStyles[index] = style
                            }
                        }
                        self._viewportRowStyleSaved = true
                    };
                    CopyMoveRowsInfo.prototype.getViewportRowStyle = function(index)
                    {
                        if (this._viewportRowStyles[index])
                        {
                            return this._viewportRowStyles[index]
                        }
                        return keyword_null
                    };
                    CopyMoveRowsInfo.prototype.saveHeaderRowStyle = function(index, style)
                    {
                        var self = this;
                        if (self._headerRowStyles[index])
                        {
                            if (!style)
                            {
                                self._headerRowStyles[index] = keyword_null
                            }
                            else
                            {
                                self._headerRowStyles[index] = style
                            }
                        }
                        else
                        {
                            if (style)
                            {
                                self._headerRowStyles[index] = style
                            }
                        }
                        self._headerRowStyleSaved = true
                    };
                    CopyMoveRowsInfo.prototype.getHeaderRowStyle = function(index)
                    {
                        if (this._headerRowStyles[index])
                        {
                            return this._headerRowStyles[index]
                        }
                        return keyword_null
                    };
                    CopyMoveRowsInfo.prototype.saveRangeGroup = function(index, level, collapsed)
                    {
                        var self = this;
                        if (self._levels[index] !== keyword_null)
                        {
                            if (level < 0)
                            {
                                self._levels[index] = keyword_null
                            }
                            else
                            {
                                self._levels[index] = level
                            }
                        }
                        else
                        {
                            if (level >= 0)
                            {
                                self._levels[index] = level
                            }
                        }
                        if (self._collapsed[index] !== keyword_null)
                        {
                            if (collapsed)
                            {
                                self._collapsed[index] = collapsed
                            }
                            else
                            {
                                self._collapsed[index] = keyword_null
                            }
                        }
                        else
                        {
                            if (collapsed)
                            {
                                self._collapsed[index] = collapsed
                            }
                        }
                        self._rangeGroupSaved = true
                    };
                    CopyMoveRowsInfo.prototype.getRangeGroup = function(index, outData)
                    {
                        var self = this;
                        outData.level = -1;
                        outData.collapsed = false;
                        if (self._levels[index] !== keyword_null)
                        {
                            outData.level = self._levels[index]
                        }
                        if (self._collapsed[index] !== keyword_null)
                        {
                            outData.collapsed = self._collapsed[index]
                        }
                    };
                    CopyMoveRowsInfo.prototype.isHeightSaved = function()
                    {
                        return this._heightSaved
                    };
                    CopyMoveRowsInfo.prototype.isVisibleSaved = function()
                    {
                        return this._visibleSaved
                    };
                    CopyMoveRowsInfo.prototype.isResizableSaved = function()
                    {
                        return this._resizableSaved
                    };
                    CopyMoveRowsInfo.prototype.isTagSaved = function()
                    {
                        return this._tagSaved
                    };
                    CopyMoveRowsInfo.prototype.isViewportRowStyleSaved = function()
                    {
                        return this._viewportRowStyleSaved
                    };
                    CopyMoveRowsInfo.prototype.isHeaderRowStyleSaved = function()
                    {
                        return this._headerRowStyleSaved
                    };
                    CopyMoveRowsInfo.prototype.isRangeGroupSaved = function()
                    {
                        return this._rangeGroupSaved
                    };
                    return CopyMoveRowsInfo
                })();
            UndoRedo.CopyMoveRowsInfo = CopyMoveRowsInfo;
            var CopyMoveHelper = (function()
                {
                    function CopyMoveHelper(){}
                    CopyMoveHelper.getStyleObject = function(sheet, row, column, area)
                    {
                        return sheet.getStyleObject(row, column, area)
                    };
                    CopyMoveHelper.setStyleObject = function(sheet, row, column, area, style)
                    {
                        sheet.setStyleObject(row, column, style, area)
                    };
                    CopyMoveHelper.getComment = function(sheet, row, col)
                    {
                        return sheet.getComment(row, col)
                    };
                    CopyMoveHelper.setComment = function(sheet, row, col, comment)
                    {
                        sheet.setComment(row, col, comment)
                    };
                    CopyMoveHelper.saveSheetInfo = function(sheet, sheetInfo, option)
                    {
                        if ((option & 64) > 0)
                        {
                            sheetInfo.saveDefaultStyle(sheet.getDefaultStyle());
                            sheetInfo.saveColumnHeaderDefaultStyle(sheet.getDefaultStyle(1));
                            sheetInfo.saveRowHeaderDefaultStyle(sheet.getDefaultStyle(2))
                        }
                        if ((option & 128) > 0)
                        {
                            sheetInfo.saveTag(sheet.tag())
                        }
                        sheetInfo.saveDefaultColumnWidth(sheet.defaults.colWidth);
                        sheetInfo.saveDefaultRowHeight(sheet.defaults.rowHeight);
                        sheetInfo.saveColumnHeaderDefaultRowHeight(sheet.defaults.colHeaderRowHeight);
                        sheetInfo.saveRowHeaderDefaultColumnWidth(sheet.defaults.rowHeaderColWidth)
                    };
                    CopyMoveHelper.saveColumnHeaderInfo = function(sheet, headerCellsInfo, columnsInfo, baseColumn, option)
                    {
                        var rowCount = headerCellsInfo._rowCount;
                        var columnCount = headerCellsInfo._columnCount;
                        var r,
                            c;
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                if ((option & 1) > 0)
                                {
                                    var value = sheet._getModel(1).getValue(r, baseColumn + c);
                                    headerCellsInfo.saveValue(r, c, value)
                                }
                                if ((option & 64) > 0)
                                {
                                    headerCellsInfo.saveStyle(r, c, CopyMoveHelper.getStyleObject(sheet, r, baseColumn + c, 1))
                                }
                                if ((option & 128) > 0)
                                {
                                    headerCellsInfo.saveTag(r, c, sheet.getTag(r, baseColumn + c, 1))
                                }
                            }
                        }
                        if ((option & 1) > 0)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                if (sheet.isColumnBound(baseColumn + c))
                                {
                                    columnsInfo.saveBindingField(c, sheet.getDataColumnName(baseColumn + c))
                                }
                            }
                        }
                        if ((option & 32) > 0)
                        {
                            var spanEnumerator = sheet._getSpanModel(1).getEnumerator(0, baseColumn, rowCount, columnCount);
                            while (spanEnumerator.moveNext())
                            {
                                headerCellsInfo.saveSpan(spanEnumerator.current())
                            }
                        }
                        columnCount = columnsInfo._columnCount;
                        for (c = 0; c < columnCount; c++)
                        {
                            columnsInfo.saveWidth(c, sheet._getActualColumnWidth(baseColumn + c));
                            columnsInfo.saveVisible(c, sheet.getColumnVisible(baseColumn + c));
                            columnsInfo.saveResizable(c, sheet.getColumnResizable(baseColumn + c))
                        }
                        if ((option & 128) > 0)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                columnsInfo.saveTag(c, sheet.getTag(-1, baseColumn + c))
                            }
                        }
                        if ((option & 64) > 0)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                columnsInfo.saveViewportColumnStyle(c, CopyMoveHelper.getStyleObject(sheet, -1, baseColumn + c, 3));
                                columnsInfo.saveHeaderColumnStyle(c, CopyMoveHelper.getStyleObject(sheet, -1, baseColumn + c, 1))
                            }
                        }
                        if ((option & 8) > 0)
                        {
                            var group = sheet.colRangeGroup;
                            if (group && !group._isEmpty())
                            {
                                for (c = 0; c < columnCount; c++)
                                {
                                    columnsInfo.saveRangeGroup(c, group.getLevel(baseColumn + c), group.getCollapsed(baseColumn + c))
                                }
                            }
                        }
                    };
                    CopyMoveHelper.saveRowHeaderInfo = function(sheet, headerCellsInfo, rowsInfo, baseRow, option)
                    {
                        if ((option & 1023) <= 0)
                        {
                            return
                        }
                        var rowCount = headerCellsInfo._rowCount;
                        var columnCount = headerCellsInfo._columnCount;
                        var r,
                            c;
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                if ((option & 1) > 0)
                                {
                                    var value = sheet._getModel(2).getValue(baseRow + r, c);
                                    headerCellsInfo.saveValue(r, c, value)
                                }
                                if ((option & 64) > 0)
                                {
                                    headerCellsInfo.saveStyle(r, c, CopyMoveHelper.getStyleObject(sheet, baseRow + r, c, 2))
                                }
                                if ((option & 128) > 0)
                                {
                                    headerCellsInfo.saveTag(r, c, sheet.getTag(baseRow + r, c, 2))
                                }
                            }
                        }
                        if ((option & 32) > 0)
                        {
                            var spanEnumerator = sheet._getSpanModel(2).getEnumerator(baseRow, 0, rowCount, columnCount);
                            while (spanEnumerator.moveNext())
                            {
                                headerCellsInfo.saveSpan(spanEnumerator.current())
                            }
                        }
                        rowCount = rowsInfo._rowCount;
                        for (r = 0; r < rowCount; r++)
                        {
                            rowsInfo.saveHeight(r, sheet._getActualRowHeight(baseRow + r));
                            rowsInfo.saveVisible(r, sheet.getRowVisible(baseRow + r));
                            rowsInfo.saveResizable(r, sheet.getRowResizable(baseRow + r))
                        }
                        if ((option & 128) > 0)
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                rowsInfo.saveTag(r, sheet.getTag(baseRow + r, -1))
                            }
                        }
                        if ((option & 64) > 0)
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                rowsInfo.saveViewportRowStyle(r, CopyMoveHelper.getStyleObject(sheet, baseRow + r, -1, 3));
                                rowsInfo.saveHeaderRowStyle(r, CopyMoveHelper.getStyleObject(sheet, baseRow + r, -1, 2))
                            }
                        }
                        if ((option & 8) > 0)
                        {
                            var group = sheet.rowRangeGroup;
                            if (group && !group._isEmpty())
                            {
                                for (r = 0; r < rowCount; r++)
                                {
                                    rowsInfo.saveRangeGroup(r, group.getLevel(baseRow + r), group.getCollapsed(baseRow + r))
                                }
                            }
                        }
                    };
                    CopyMoveHelper.saveViewportInfo = function(sheet, cellsInfo, baseRow, baseColumn, option)
                    {
                        if ((option & 1023) <= 0)
                        {
                            return
                        }
                        var rowCount = cellsInfo._rowCount;
                        var columnCount = cellsInfo._columnCount;
                        for (var r = 0; r < rowCount; r++)
                        {
                            for (var c = 0; c < columnCount; c++)
                            {
                                var formulaInfo;
                                if ((option & 2) > 0)
                                {
                                    formulaInfo = sheet.getFormulaInformation(baseRow + r, baseColumn + c);
                                    if (formulaInfo.hasFormula)
                                    {
                                        if (formulaInfo.isArrayFormula)
                                        {
                                            if (formulaInfo.baseRange.row === baseRow + r && formulaInfo.baseRange.col === baseColumn + c)
                                            {
                                                cellsInfo.saveArrayFormula(formulaInfo)
                                            }
                                        }
                                        else
                                        {
                                            cellsInfo.saveFormula(r, c, formulaInfo.formula)
                                        }
                                    }
                                    else
                                    {
                                        cellsInfo.saveFormula(r, c, keyword_null)
                                    }
                                }
                                if ((option & 1) > 0 && (!formulaInfo || !formulaInfo.hasFormula))
                                {
                                    cellsInfo.saveValue(r, c, sheet.getValue(baseRow + r, baseColumn + c, 3))
                                }
                                if ((option & 16) > 0)
                                {
                                    var sparkline = sheet.getSparkline(baseRow + r, baseColumn + c);
                                    var dataRange = keyword_null;
                                    var dataAxisRange = keyword_null;
                                    if (sparkline)
                                    {
                                        dataRange = sparkline.data();
                                        dataAxisRange = sparkline.dateAxisData()
                                    }
                                    if (sparkline && dataRange)
                                    {
                                        cellsInfo.saveSparkline(r, c, sparkline.clone())
                                    }
                                    else
                                    {
                                        cellsInfo.saveSparkline(r, c, keyword_null)
                                    }
                                }
                                if ((option & 64) > 0)
                                {
                                    cellsInfo.saveStyle(r, c, CopyMoveHelper.getStyleObject(sheet, baseRow + r, baseColumn + c, 3))
                                }
                                if ((option & 4) > 0)
                                {
                                    cellsInfo.saveComment(r, c, (CopyMoveHelper.getComment(sheet, baseRow + r, baseColumn + c)))
                                }
                                if ((option & 128) > 0)
                                {
                                    cellsInfo.saveTag(r, c, sheet.getTag(baseRow + r, baseColumn + c, 3))
                                }
                                if ((option & 256) > 0)
                                {
                                    cellsInfo.saveBindingPath(r, c, sheet.getBindingPath(baseRow + r, baseColumn + c, 3))
                                }
                            }
                        }
                        if ((option & 32) > 0)
                        {
                            var spanEnumerator = sheet._getSpanModel().getEnumerator(baseRow, baseColumn, rowCount, columnCount);
                            while (spanEnumerator.moveNext())
                            {
                                cellsInfo.saveSpan(spanEnumerator.current())
                            }
                        }
                    };
                    CopyMoveHelper.saveTableInfo = function(sheet, tableArray, saveRange)
                    {
                        var tables = sheet.getTables();
                        if (tables)
                        {
                            for (var i = 0, length = tables.length; i < length; i++)
                            {
                                var table = tables[i];
                                if (saveRange.containsRange(table.range()))
                                {
                                    var cloneTable = table.clone();
                                    cloneTable.copyDataSource(table);
                                    tableArray.push(cloneTable)
                                }
                            }
                        }
                    };
                    CopyMoveHelper.undoCellsInfo = function(sheet, cellsInfo, baseRow, baseColumn, area)
                    {
                        var rowCount = cellsInfo._rowCount;
                        var columnCount = cellsInfo._columnCount;
                        var key,
                            cs,
                            cr,
                            formula,
                            count,
                            i;
                        sheet.suspendCalcService();
                        sheet.suspendEvent();
                        try
                        {
                            for (var r = 0; r < rowCount; r++)
                            {
                                for (var c = 0; c < columnCount; c++)
                                {
                                    if (cellsInfo.isBindingPathSaved())
                                    {
                                        sheet.setBindingPath(baseRow + r, baseColumn + c, keyword_null, area)
                                    }
                                    if (cellsInfo.isFormulaSaved() && area === 3)
                                    {
                                        sheet.setFormula(baseRow + r, baseColumn + c, keyword_null)
                                    }
                                    if (cellsInfo.isSparklineSaved() && area === 3)
                                    {
                                        sheet.removeSparkline(baseRow + r, baseColumn + c)
                                    }
                                    if (cellsInfo.isValueSaved())
                                    {
                                        sheet.setValue(baseRow + r, baseColumn + c, keyword_null, area)
                                    }
                                    if (cellsInfo.isStyleSaved())
                                    {
                                        CopyMoveHelper.setStyleObject(sheet, baseRow + r, baseColumn + c, area, keyword_null)
                                    }
                                    if (cellsInfo.isCommentSaved())
                                    {
                                        CopyMoveHelper.setComment(sheet, baseRow + r, baseColumn + c, keyword_null)
                                    }
                                    if (cellsInfo.isTagSaved())
                                    {
                                        sheet.setTag(baseRow + r, baseColumn + c, keyword_null, area)
                                    }
                                }
                            }
                            if (cellsInfo.isBindingPathSaved())
                            {
                                var paths = cellsInfo.getBindingPaths();
                                for (key = 0; key < paths.length; key++)
                                {
                                    var p = paths[key];
                                    sheet.setBindingPath(baseRow + p.row, baseColumn + p.column, p.value, area)
                                }
                            }
                            if (cellsInfo.isValueSaved())
                            {
                                var values = cellsInfo.getValues();
                                for (key = 0; key < values.length; key++)
                                {
                                    var v = values[key];
                                    sheet.setValue(baseRow + v.row, baseColumn + v.column, v.value, area)
                                }
                            }
                            if (cellsInfo.isFormulaSaved() && area === 3)
                            {
                                var formulas = cellsInfo.getFormulas();
                                for (key = 0; key < formulas.length; key++)
                                {
                                    formula = formulas[key];
                                    sheet.setFormula(baseRow + formula.row, baseColumn + formula.column, formula.value)
                                }
                            }
                            if (cellsInfo.isSparklineSaved() && area === 3)
                            {
                                var sparklines = cellsInfo.getSparklines();
                                for (var s = 0; s < sparklines.length; s++)
                                {
                                    var item = sparklines[s];
                                    var sparkline = item.value;
                                    if (!sparkline)
                                    {
                                        sheet.removeSparkline(baseRow + item.row, baseColumn + item.column)
                                    }
                                    else if (!sparkline.dateAxisData())
                                    {
                                        sheet.setSparkline(baseRow + item.row, baseColumn + item.column, sparkline.data(), sparkline.dataOrientation(), sparkline.sparklineType(), sparkline.setting())
                                    }
                                    else
                                    {
                                        sheet.setSparkline(baseRow + item.row, baseColumn + item.column, sparkline.data(), sparkline.dataOrientation(), sparkline.sparklineType(), sparkline.setting(), sparkline.dateAxisData(), sparkline.dateAxisOrientation())
                                    }
                                }
                            }
                            if (cellsInfo.isStyleSaved())
                            {
                                var styles = cellsInfo.getStyles();
                                for (key = 0; key < styles.length; key++)
                                {
                                    var style = styles[key];
                                    CopyMoveHelper.setStyleObject(sheet, baseRow + style.row, baseColumn + style.column, area, style.value)
                                }
                            }
                            if (cellsInfo.isCommentSaved())
                            {
                                var comments = cellsInfo.getComments();
                                for (key = 0; key < comments.length; key++)
                                {
                                    var cellData = comments[key];
                                    var comment = cellData.value;
                                    CopyMoveHelper.setComment(sheet, baseRow + cellData.row, baseColumn + cellData.column, comment)
                                }
                            }
                            if (cellsInfo.isTagSaved())
                            {
                                var tags = cellsInfo.getTags();
                                var len = tags.length;
                                for (var index = 0; index < len; index++)
                                {
                                    var item = tags[index];
                                    sheet.setTag(baseRow + item.row, baseColumn + item.column, item.value, area)
                                }
                            }
                            if (cellsInfo.isArrayFormulaSaved() && area === 3)
                            {
                                var arrayFormulas = sheet._getsArrayFormulas(baseRow, baseColumn, rowCount, columnCount);
                                if (arrayFormulas && arrayFormulas.length > 0)
                                {
                                    count = arrayFormulas.getLength(0);
                                    for (i = 0; i < count; i++)
                                    {
                                        cr = arrayFormulas[i][0];
                                        sheet.setArrayFormula(cr.row, cr.col, cr.rowCount, cr.colCount, keyword_null)
                                    }
                                }
                                arrayFormulas = cellsInfo.getArrayFormula();
                                if (arrayFormulas && arrayFormulas.length > 0)
                                {
                                    count = arrayFormulas.length;
                                    for (i = 0; i < count; i++)
                                    {
                                        var formulaInfo = arrayFormulas[i];
                                        sheet.setArrayFormula(formulaInfo.baseRange.row, formulaInfo.baseRange.col, formulaInfo.baseRange.rowCount, formulaInfo.baseRange.colCount, formulaInfo.formula)
                                    }
                                }
                            }
                        }
                        finally
                        {
                            sheet.resumeCalcService();
                            sheet.resumeEvent()
                        }
                        var spanModel = sheet._getSpanModel(area);
                        if (spanModel && spanModel.length > 0)
                        {
                            var removedSpans = [];
                            var spans = spanModel.getEnumerator(baseRow, baseColumn, rowCount, columnCount);
                            while (spans.moveNext())
                            {
                                cs = spans.current();
                                if (cs)
                                {
                                    removedSpans.push(cs)
                                }
                            }
                            for (key = 0; key < removedSpans.length; key++)
                            {
                                cs = removedSpans[key];
                                spanModel.remove(cs)
                            }
                        }
                        if (cellsInfo.isSpanSaved())
                        {
                            if (spanModel)
                            {
                                for (key = 0; key < cellsInfo._spans.length; key++)
                                {
                                    cs = cellsInfo._spans[key];
                                    spanModel.addSpan(cs)
                                }
                            }
                        }
                    };
                    CopyMoveHelper.undoColumnsInfo = function(sheet, columnsInfo, baseColumn)
                    {
                        var columnCount = columnsInfo._columnCount;
                        var c;
                        if (columnsInfo.isBindingFieldSaved())
                        {
                            var outdata = {fieldName: keyword_null};
                            for (c = 0; c < columnCount; c++)
                            {
                                if (columnsInfo.getBindingField(c, outdata))
                                {
                                    sheet.bindColumn(baseColumn + c, outdata.fieldName)
                                }
                            }
                        }
                        if (columnsInfo.isWidthSaved())
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                sheet.setColumnWidth(baseColumn + c, columnsInfo.getWidth(c), 3)
                            }
                        }
                        if (columnsInfo.isVisibleSaved())
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                sheet.setColumnVisible(baseColumn + c, columnsInfo.getVisible(c), 3)
                            }
                        }
                        if (columnsInfo.isResizableSaved())
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                sheet.setColumnResizable(baseColumn + c, columnsInfo.getResizable(c), 3)
                            }
                        }
                        if (columnsInfo.isTagSaved())
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                sheet.setTag(-1, baseColumn + c, columnsInfo.getTag(c), 3)
                            }
                        }
                        if (columnsInfo.isViewportColumnStyleSaved())
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                CopyMoveHelper.setStyleObject(sheet, -1, baseColumn + c, 3, columnsInfo.getViewportColumnStyle(c))
                            }
                        }
                        if (columnsInfo.isHeaderColumnStyleSaved())
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                CopyMoveHelper.setStyleObject(sheet, -1, baseColumn + c, 1, columnsInfo.getHeaderColumnStyle(c))
                            }
                        }
                        if (columnsInfo.isRangeGroupSaved())
                        {
                            var group = sheet.colRangeGroup;
                            if (group)
                            {
                                var outData = {
                                        level: keyword_null, collapsed: keyword_null
                                    };
                                for (c = 0; c < columnCount; c++)
                                {
                                    columnsInfo.getRangeGroup(c, outData);
                                    group._setLevel(baseColumn + c, outData.level);
                                    group.setCollapsed(baseColumn + c, outData.collapsed)
                                }
                            }
                        }
                    };
                    CopyMoveHelper.undoRowsInfo = function(sheet, rowsInfo, baseRow)
                    {
                        var rowCount = rowsInfo._rowCount;
                        var r;
                        if (rowsInfo.isHeightSaved())
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                sheet.setRowHeight(baseRow + r, rowsInfo.getHeight(r), 3)
                            }
                        }
                        if (rowsInfo.isVisibleSaved())
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                sheet.setRowVisible(baseRow + r, rowsInfo.getVisible(r), 3)
                            }
                        }
                        if (rowsInfo.isResizableSaved())
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                sheet.setRowResizable(baseRow + r, rowsInfo.getResizable(r), 3)
                            }
                        }
                        if (rowsInfo.isTagSaved())
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                sheet.setTag(baseRow + r, -1, rowsInfo.getTag(r), 3)
                            }
                        }
                        if (rowsInfo.isViewportRowStyleSaved())
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                CopyMoveHelper.setStyleObject(sheet, baseRow + r, -1, 3, rowsInfo.getViewportRowStyle(r))
                            }
                        }
                        if (rowsInfo.isHeaderRowStyleSaved())
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                CopyMoveHelper.setStyleObject(sheet, baseRow + r, -1, 2, rowsInfo.getHeaderRowStyle(r))
                            }
                        }
                        if (rowsInfo.isRangeGroupSaved())
                        {
                            var group = sheet.rowRangeGroup;
                            if (group)
                            {
                                var outData = {
                                        level: keyword_null, collapsed: keyword_null
                                    };
                                for (r = 0; r < rowCount; r++)
                                {
                                    rowsInfo.getRangeGroup(r, outData);
                                    group._setLevel(baseRow + r, outData.level);
                                    group.setCollapsed(baseRow + r, outData.collapsed)
                                }
                            }
                        }
                    };
                    CopyMoveHelper.undoSheetInfo = function(sheet, sheetInfo)
                    {
                        if (sheetInfo.isDefaultStyleSaved())
                        {
                            sheet.setDefaultStyle(sheetInfo.getDefaultStyle())
                        }
                        if (sheetInfo.isDefaultColumnWidthSaved())
                        {
                            sheet.defaults.colWidth = sheetInfo.getDefaultColumnWidth()
                        }
                        if (sheetInfo.isDefaultRowHeightSaved())
                        {
                            sheet.defaults.rowHeight = sheetInfo.getDefaultRowHeight()
                        }
                        if (sheetInfo.isTagSaved())
                        {
                            sheet.tag(sheetInfo.getTag())
                        }
                        if (sheetInfo.isColumnHeaderDefaultStyleSaved())
                        {
                            sheet.setDefaultStyle(sheetInfo.getColumnHeaderDefaultStyle(), 1)
                        }
                        if (sheetInfo.isColumnHeaderDefaultRowHeightSaved())
                        {
                            sheet.defaults.colHeaderRowHeight = sheetInfo.getColumnHeaderDefaultRowHeight()
                        }
                        if (sheetInfo.isRowHeaderDefaultStyleSaved())
                        {
                            sheet.setDefaultStyle(sheetInfo.getRowHeaderDefaultStyle(), 2)
                        }
                        if (sheetInfo.isRowHeaderDefaultColumnWidthSaved())
                        {
                            sheet.defaults.rowHeaderColWidth = sheetInfo.getRowHeaderDefaultColumnWidth()
                        }
                    };
                    CopyMoveHelper.undoTableInfo = function(sheet, tableArray, undoRange)
                    {
                        var length = tableArray.length;
                        if (length > 0)
                        {
                            for (var i = 0; i < length; i++)
                            {
                                var table = tableArray[i];
                                sheet._tableManager.add(table)
                            }
                        }
                        else
                        {
                            var tables = sheet.getTables();
                            if (tables)
                            {
                                for (var i = 0, length = tables.length; i < length; i++)
                                {
                                    var table = tables[i];
                                    if (undoRange.containsRange(table.range()))
                                    {
                                        sheet._tableManager.remove(table, false)
                                    }
                                }
                            }
                        }
                    };
                    CopyMoveHelper.getValues = function(sheet, row, column, rowCount, columnCount)
                    {
                        if (row < 0)
                        {
                            row = 0;
                            rowCount = sheet.getRowCount()
                        }
                        if (column < 0)
                        {
                            column = 0;
                            columnCount = sheet.getColumnCount()
                        }
                        var values = [];
                        for (var r = 0; r < rowCount; r++)
                        {
                            for (var c = 0; c < columnCount; c++)
                            {
                                var value = sheet.getValue(row + r, column + c);
                                if (value !== keyword_undefined && value !== keyword_null)
                                {
                                    values.push(new CellData(r, c, value))
                                }
                            }
                        }
                        return values
                    };
                    CopyMoveHelper.raiseRangeDataChanged = function(sheetView, row, column, rowCount, columnCount, changedCells, action, oldValues)
                    {
                        if (!sheetView)
                        {
                            return
                        }
                        if (row < 0)
                        {
                            row = 0;
                            rowCount = sheetView.getRowCount()
                        }
                        if (column < 0)
                        {
                            column = 0;
                            columnCount = sheetView.getColumnCount()
                        }
                        sheetView._raiseRangeDataChanged(row, column, rowCount, columnCount, changedCells, action)
                    };
                    CopyMoveHelper.convertToKey = function(row, column)
                    {
                        var key = 0;
                        key = row;
                        key <<= 32;
                        key |= column;
                        return key
                    };
                    CopyMoveHelper.remove = function(cellDatas, row, column)
                    {
                        var ret = keyword_null;
                        var index = -1;
                        var count = cellDatas.length;
                        if (count > 0)
                        {
                            for (var i = 0; i < count; i++)
                            {
                                if (cellDatas[i].row === row && cellDatas[i].column === column)
                                {
                                    index = i;
                                    break
                                }
                            }
                        }
                        if (index !== -1)
                        {
                            ret = cellDatas[index];
                            cellDatas.splice(index, 1)
                        }
                        return ret
                    };
                    CopyMoveHelper.clearFormula = function(sheet, row, column, rowCount, columnCount)
                    {
                        var calcBlock = sheet._getCalcModel();
                        calcBlock.clear(row, column, rowCount, columnCount);
                        var model = sheet._getModel();
                        model.clearFormula(row, column, rowCount, columnCount)
                    };
                    return CopyMoveHelper
                })();
            UndoRedo.CopyMoveHelper = CopyMoveHelper;
            var ActionBase = (function()
                {
                    function ActionBase()
                    {
                        this.canExecuteChanged = keyword_null
                    }
                    ActionBase.prototype.execute = function(arg){};
                    ActionBase.prototype.canExecute = function(arg)
                    {
                        return true
                    };
                    ActionBase.prototype.canUndo = function()
                    {
                        return true
                    };
                    ActionBase.prototype.saveState = function(){};
                    ActionBase.prototype.undo = function(arg)
                    {
                        return true
                    };
                    ActionBase.prototype._raiseCanExecuteChanged = function()
                    {
                        var self = this;
                        if (self.canExecuteChanged && typeof(self.canExecuteChanged) === 'function')
                        {
                            self.canExecuteChanged(self)
                        }
                    };
                    ActionBase.prototype._suspendInvalidate = function(sender)
                    {
                        if (sender && sender._suspendInvalidate)
                        {
                            sender._suspendInvalidate()
                        }
                    };
                    ActionBase.prototype._resumeInvalidate = function(sender)
                    {
                        if (sender && sender._resumeInvalidate)
                        {
                            return sender._resumeInvalidate()
                        }
                        return false
                    };
                    return ActionBase
                })();
            UndoRedo.ActionBase = ActionBase;
            var ColumnResizeUndoAction = (function(_super)
                {
                    __extends(ColumnResizeUndoAction, _super);
                    function ColumnResizeUndoAction(sheet, columns, size, rowHeader)
                    {
                        _super.call(this);
                        var self = this;
                        self._sheet = sheet;
                        self._columns = columns;
                        self._size = size;
                        self._rowHeader = rowHeader;
                        self._oldSizes = [];
                        self._oldVisibles = []
                    }
                    ColumnResizeUndoAction.prototype.canExecute = function(arg)
                    {
                        return true
                    };
                    ColumnResizeUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet,
                            columns = self._columns,
                            columnsLength = (columns && columns.length),
                            maxValue = Number.MAX_VALUE;
                        if (sheet && columnsLength > 0)
                        {
                            self._suspendInvalidate(arg);
                            var resizedColumns = self._getColumnsReiszed(columns);
                            var args = {
                                    sheet: sheet, sheetName: sheet._name, colList: resizedColumns, header: self._rowHeader, cancel: false
                                };
                            sheet.triggerColumnWidthChanging(args);
                            if (args && args.cancel === true)
                            {
                                self._canUndo = false;
                                self._resumeInvalidate(arg);
                                return
                            }
                            else
                            {
                                self._canUndo = true
                            }
                            self.saveState();
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.suspendEvent();
                            try
                            {
                                var rowHeaderArea = 2,
                                    viewportArea = 3,
                                    isRowHeader = self._rowHeader,
                                    columnCount = (isRowHeader ? sheet.getColumnCount(rowHeaderArea) : sheet.getColumnCount(viewportArea));
                                var leftColumn = sheet._scrollLeftCol,
                                    newLeftColumn = leftColumn;
                                for (var col = leftColumn - 1; col >= sheet.frozenColCount; col--)
                                {
                                    if (sheet.getColumnVisible(col) && sheet._getZoomColumnWidth(col) > 0)
                                    {
                                        break
                                    }
                                    if (sheet.getColumnResizable(col))
                                    {
                                        newLeftColumn = col
                                    }
                                }
                                var minCol = maxValue,
                                    newSize = self._size;
                                for (var c = 0; c < columnsLength; c++)
                                {
                                    var cw = columns[c],
                                        firstCol = cw.firstCol,
                                        lastCol = cw.lastCol;
                                    for (var c2 = firstCol; c2 <= lastCol; c2++)
                                    {
                                        if (0 <= c2 && c2 < columnCount)
                                        {
                                            if (isRowHeader && sheet.getColumnResizable(c2, rowHeaderArea) && newSize !== sheet._getActualColumnWidth(c2, rowHeaderArea))
                                            {
                                                sheet.setColumnWidth(c2, newSize, rowHeaderArea)
                                            }
                                            else if (sheet.getColumnResizable(c2, viewportArea) && newSize !== sheet._getActualColumnWidth(c2, viewportArea))
                                            {
                                                sheet.setColumnWidth(c2, newSize, viewportArea)
                                            }
                                            minCol = Math_min(c2, minCol)
                                        }
                                    }
                                }
                                if (minCol !== maxValue && minCol <= leftColumn && newLeftColumn !== leftColumn)
                                {
                                    sheet._scrollLeftCol = newLeftColumn
                                }
                            }
                            finally
                            {
                                sheet.resumeEvent();
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            sheet.triggerColumnWidthChanged({
                                sheet: sheet, sheetName: sheet._name, colList: resizedColumns, header: self._rowHeader
                            });
                            sheet._syncHScollbarPosition()
                        }
                    };
                    ColumnResizeUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        var sizes = [],
                            visibles = [],
                            sheet = self._sheet,
                            columns = self._columns,
                            columnsLength = (columns && columns.length);
                        if (sheet && columnsLength > 0)
                        {
                            var isRowHeader = self._rowHeader,
                                sheetArea = (isRowHeader ? 2 : 3),
                                columnCount = sheet.getColumnCount(sheetArea),
                                dw = (isRowHeader ? sheet.defaults.rowHeaderColWidth : sheet.defaults.colWidth),
                                colInfos = sheet._sheetModelManager.getColInfos();
                            for (var c = 0; c < columnsLength; c++)
                            {
                                var cw = columns[c],
                                    firstCol = cw.firstCol,
                                    lastCol = cw.lastCol,
                                    index,
                                    v,
                                    w;
                                sizes[c] = [];
                                visibles[c] = [];
                                for (var c2 = firstCol; c2 <= lastCol; c2++)
                                {
                                    index = c2 - firstCol;
                                    if (0 <= c2 && c2 < columnCount)
                                    {
                                        w = colInfos.getActualSize(c2);
                                        if (isNaN(w) || w === null)
                                        {
                                            w = dw
                                        }
                                        else
                                        {
                                            w = Math_floor(w)
                                        }
                                        sizes[c][index] = w;
                                        visibles[c][index] = colInfos.getVisible(c2)
                                    }
                                    else
                                    {
                                        sizes[c][index] = -1;
                                        visibles[c][index] = false
                                    }
                                }
                            }
                        }
                        self._oldSizes = sizes;
                        self._oldVisibles = visibles
                    };
                    ColumnResizeUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet,
                            columns = self._columns,
                            columnsLength = (columns && columns.length);
                        if (sheet && columnsLength > 0)
                        {
                            self._suspendInvalidate(arg);
                            var resizedColumns = self._getColumnsReiszed(columns);
                            var args = {
                                    sheet: sheet, sheetName: sheet._name, colList: resizedColumns, header: self._rowHeader, cancel: false
                                };
                            sheet.triggerColumnWidthChanging(args);
                            if (args && args.cancel === true)
                            {
                                self._resumeInvalidate(arg);
                                return false
                            }
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.suspendEvent();
                            try
                            {
                                var rowHeaderArea = 2,
                                    viewportArea = 3,
                                    isRowHeader = self._rowHeader,
                                    columnCount = (isRowHeader ? sheet.getColumnCount(2) : sheet.getColumnCount(viewportArea));
                                var oldsize,
                                    oldVisible;
                                for (var c = 0; c < columnsLength; c++)
                                {
                                    var cw = columns[c],
                                        firstCol = cw.firstCol,
                                        lastCol = cw.lastCol;
                                    for (var c2 = firstCol; c2 <= lastCol; c2++)
                                    {
                                        oldsize = self._oldSizes[c][c2 - cw.firstCol];
                                        oldVisible = self._oldVisibles[c][c2 - cw.firstCol];
                                        if (0 <= c2 && c2 < columnCount && oldsize !== -1)
                                        {
                                            if (isRowHeader && sheet.getColumnResizable(c2, rowHeaderArea))
                                            {
                                                sheet.setColumnWidth(c2, oldsize, rowHeaderArea);
                                                ret = true
                                            }
                                            else if (sheet.getColumnResizable(c2, viewportArea))
                                            {
                                                sheet.setColumnWidth(c2, oldsize, viewportArea);
                                                ret = true
                                            }
                                            if (isRowHeader && sheet.getColumnVisible(c2, rowHeaderArea) !== oldVisible)
                                            {
                                                sheet.setColumnVisible(c2, oldVisible, rowHeaderArea);
                                                ret = true
                                            }
                                            else if (sheet.getColumnVisible(c2, viewportArea) !== oldVisible)
                                            {
                                                sheet.setColumnVisible(c2, oldVisible, viewportArea);
                                                ret = true
                                            }
                                        }
                                    }
                                }
                            }
                            finally
                            {
                                sheet.resumeEvent();
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            sheet.triggerColumnWidthChanged({
                                sheet: sheet, sheetName: sheet._name, colList: resizedColumns, header: self._rowHeader
                            })
                        }
                        return ret
                    };
                    ColumnResizeUndoAction.prototype._getColumnsReiszed = function(columnWidthChangeExtents)
                    {
                        var columns = [];
                        for (var i = 0, len = columnWidthChangeExtents.length; i < len; i++)
                        {
                            var item = columnWidthChangeExtents[i],
                                firstCol = item.firstCol,
                                lastCol = item.lastCol;
                            for (var col = firstCol; col <= lastCol; col++)
                            {
                                columns.push(col)
                            }
                        }
                        return columns
                    };
                    ColumnResizeUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    return ColumnResizeUndoAction
                })(ActionBase);
            UndoRedo.ColumnResizeUndoAction = ColumnResizeUndoAction;
            var RowResizeUndoAction = (function(_super)
                {
                    __extends(RowResizeUndoAction, _super);
                    function RowResizeUndoAction(sheet, rows, size, columnHeader)
                    {
                        _super.call(this);
                        var self = this;
                        self._sheet = sheet;
                        self._rows = rows;
                        self._size = size;
                        self._columnHeader = columnHeader;
                        self._oldSizes = [];
                        self._oldVisibles = []
                    }
                    RowResizeUndoAction.prototype.canExecute = function(arg)
                    {
                        return true
                    };
                    RowResizeUndoAction.prototype.execute = function(arg)
                    {
                        var self = this,
                            sheet = self._sheet,
                            rows = self._rows,
                            rowsLength = (rows && rows.length),
                            maxValue = Number.MAX_VALUE;
                        if (sheet && rowsLength > 0)
                        {
                            self._suspendInvalidate(arg);
                            var resizedRows = self._getRowsReiszed(rows);
                            var args = {
                                    sheet: sheet, sheetName: sheet._name, rowList: resizedRows, header: self._columnHeader, cancel: false
                                };
                            sheet.triggerRowHeightChanging(args);
                            if (args && args.cancel === true)
                            {
                                self._canUndo = false;
                                self._resumeInvalidate(arg);
                                return
                            }
                            else
                            {
                                self._canUndo = true
                            }
                            self.saveState();
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.suspendEvent();
                            try
                            {
                                var viewportArea = 3,
                                    colHeaderArea = 1,
                                    isColumnHeader = self._columnHeader,
                                    rowCount = (isColumnHeader ? sheet.getRowCount(colHeaderArea) : sheet.getRowCount(viewportArea));
                                var topRow = sheet._scrollTopRow,
                                    newTopRow = topRow;
                                for (var row = topRow - 1; row >= sheet.frozenRowCount; row--)
                                {
                                    if (sheet.getRowVisible(row) && sheet._getZoomRowHeight(row) > 0)
                                    {
                                        break
                                    }
                                    if (sheet.getRowResizable(row))
                                    {
                                        newTopRow = row
                                    }
                                }
                                var minRow = maxValue,
                                    newSize = self._size;
                                for (var r = 0; r < rowsLength; r++)
                                {
                                    var rh = rows[r],
                                        firstRow = rh.firstRow,
                                        lastRow = rh.lastRow;
                                    for (var r2 = firstRow; r2 <= lastRow; r2++)
                                    {
                                        if (0 <= r2 && r2 < rowCount)
                                        {
                                            if (isColumnHeader && sheet.getRowResizable(r2, colHeaderArea) && newSize !== sheet._getActualRowHeight(r2, colHeaderArea))
                                            {
                                                sheet.setRowHeight(r2, newSize, colHeaderArea)
                                            }
                                            else if (sheet.getRowResizable(r2, viewportArea) && newSize !== sheet._getActualRowHeight(r2, viewportArea))
                                            {
                                                sheet.setRowHeight(r2, newSize, viewportArea);
                                                if (sheet.rowFilter())
                                                {
                                                    sheet.rowFilter()._addRowFilteredIn(r2)
                                                }
                                            }
                                            minRow = Math_min(r2, minRow)
                                        }
                                    }
                                }
                                if (minRow !== maxValue && minRow <= topRow && newTopRow !== topRow)
                                {
                                    sheet._scrollTopRow = newTopRow
                                }
                            }
                            finally
                            {
                                sheet.resumeEvent();
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            sheet.triggerRowHeightChanged({
                                sheet: sheet, sheetName: sheet._name, rowList: resizedRows, header: self._columnHeader
                            });
                            sheet._syncVScrollbarPosition()
                        }
                    };
                    RowResizeUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        var sizes = [],
                            visibles = [],
                            sheet = self._sheet,
                            rows = self._rows,
                            rowsLength = (rows && rows.length);
                        if (sheet && rowsLength > 0)
                        {
                            var isColumnHeader = self._columnHeader,
                                sheetArea = (isColumnHeader ? 1 : 3),
                                rowCount = sheet.getRowCount(sheetArea),
                                dh = (isColumnHeader ? sheet.defaults.colHeaderRowHeight : sheet.defaults.rowHeight),
                                infos = sheet._sheetModelManager.getRowInfos();
                            for (var r = 0; r < rowsLength; r++)
                            {
                                var rh = rows[r],
                                    firstRow = rh.firstRow,
                                    lastRow = rh.lastRow,
                                    index,
                                    v,
                                    h;
                                sizes[r] = [];
                                visibles[r] = [];
                                for (var r2 = firstRow; r2 <= lastRow; r2++)
                                {
                                    index = r2 - firstRow;
                                    if (0 <= r2 && r2 < rowCount)
                                    {
                                        h = infos.getActualSize(r2);
                                        if (isNaN(h) || h === null)
                                        {
                                            h = dh
                                        }
                                        else
                                        {
                                            h = Math_floor(h)
                                        }
                                        sizes[r][index] = h;
                                        visibles[r][index] = infos.getVisible(r2)
                                    }
                                    else
                                    {
                                        sizes[r][index] = -1;
                                        visibles[r][index] = false
                                    }
                                }
                            }
                        }
                        self._oldVisibles = visibles;
                        self._oldSizes = sizes
                    };
                    RowResizeUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        var rows = self._rows,
                            rowsLength = (rows && rows.length);
                        if (sheet && rowsLength > 0)
                        {
                            self._suspendInvalidate(arg);
                            var resizedRows = self._getRowsReiszed(rows);
                            var args = {
                                    sheet: sheet, sheetName: sheet._name, rowList: resizedRows, header: self._columnHeader, cancel: false
                                };
                            sheet.triggerRowHeightChanging(args);
                            if (args && args.cancel === true)
                            {
                                self._resumeInvalidate(arg);
                                return false
                            }
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.suspendEvent();
                            try
                            {
                                var viewportArea = 3,
                                    colHeaderArea = 1,
                                    isColumnHeader = self._columnHeader;
                                var rowCount = (isColumnHeader ? sheet.getRowCount(colHeaderArea) : sheet.getRowCount(viewportArea));
                                var oldSizes = self._oldSizes,
                                    oldVisibles = self._oldVisibles,
                                    oldsize,
                                    oldVisible;
                                for (var r = 0; r < rowsLength; r++)
                                {
                                    var rh = rows[r],
                                        firstRow = rh.firstRow,
                                        lastRow = rh.lastRow;
                                    for (var r2 = firstRow; r2 <= lastRow; r2++)
                                    {
                                        oldsize = oldSizes[r][r2 - firstRow];
                                        oldVisible = oldVisibles[r][r2 - firstRow];
                                        if (0 <= r2 && r2 < rowCount && oldsize !== -1)
                                        {
                                            if (isColumnHeader && sheet.getRowResizable(r2, colHeaderArea))
                                            {
                                                sheet.setRowHeight(r2, oldsize, colHeaderArea);
                                                ret = true
                                            }
                                            else if (sheet.getRowResizable(r2, viewportArea))
                                            {
                                                sheet.setRowHeight(r2, oldsize, viewportArea);
                                                ret = true
                                            }
                                            if (isColumnHeader && sheet.getRowVisible(r2, colHeaderArea) !== oldVisible)
                                            {
                                                sheet.setRowVisible(r2, oldVisible, colHeaderArea);
                                                ret = true
                                            }
                                            else if (sheet.getRowVisible(r2, viewportArea) !== oldVisible)
                                            {
                                                sheet.setRowVisible(r2, oldVisible, viewportArea);
                                                ret = true
                                            }
                                        }
                                    }
                                }
                            }
                            finally
                            {
                                sheet.resumeEvent();
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            sheet.triggerRowHeightChanged({
                                sheet: sheet, sheetName: sheet._name, rowList: resizedRows, header: self._columnHeader
                            })
                        }
                        return ret
                    };
                    RowResizeUndoAction.prototype._getRowsReiszed = function(rowHeightChangeExtents)
                    {
                        var rows = [];
                        for (var i = 0, len = rowHeightChangeExtents.length; i < len; i++)
                        {
                            var item = rowHeightChangeExtents[i],
                                firstRow = item.firstRow,
                                lastRow = item.lastRow;
                            for (var row = firstRow; row <= lastRow; row++)
                            {
                                rows.push(row)
                            }
                        }
                        return rows
                    };
                    RowResizeUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    return RowResizeUndoAction
                })(ActionBase);
            UndoRedo.RowResizeUndoAction = RowResizeUndoAction;
            var ColumnAutoFitUndoAction = (function(_super)
                {
                    __extends(ColumnAutoFitUndoAction, _super);
                    function ColumnAutoFitUndoAction(sheet, columns, rowHeader, autoFitType)
                    {
                        _super.call(this);
                        var self = this;
                        self._sheet = sheet;
                        self._columns = columns;
                        self._sheetArea = rowHeader ? 2 : 3;
                        if (arguments.length === 3)
                        {
                            autoFitType = sheet._getAutoFitType()
                        }
                        self._autofitType = autoFitType;
                        self._oldSizes = [];
                        self._oldVisibles = []
                    }
                    ColumnAutoFitUndoAction.prototype.canExecute = function(arg)
                    {
                        return this._sheet && this._columns && this._columns.length > 0
                    };
                    ColumnAutoFitUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        if (self.canExecute(arg))
                        {
                            var sheet = self._sheet;
                            var sheetArea = self._sheetArea;
                            self._suspendInvalidate(arg);
                            var resizedColumns = self._getColumnsReiszed(self._columns);
                            var isHeader = sheetArea === 2;
                            var args = {
                                    sheet: sheet, sheetName: sheet._name, colList: resizedColumns, header: isHeader, cancel: false
                                };
                            sheet.triggerColumnWidthChanging(args);
                            if (args && args.cancel === true)
                            {
                                self._canUndo = false;
                                self._resumeInvalidate(arg);
                                return
                            }
                            else
                            {
                                self._canUndo = true
                            }
                            self.saveState();
                            var columnCount = sheet.getColumnCount(sheetArea);
                            var startCol = columnCount - 1,
                                endCol = 0,
                                cTemp;
                            for (var c = 0, len = self._columns.length; c < len; c++)
                            {
                                cTemp = self._columns[c].col;
                                startCol = startCol > cTemp ? cTemp : startCol;
                                endCol = endCol < cTemp ? cTemp : endCol
                            }
                            Sheets._CacheMgr.startCache(sheet, 0, startCol, sheet.getRowCount() - 1, endCol);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.suspendEvent();
                            try
                            {
                                var fitValue;
                                for (var c = 0, len = self._columns.length; c < len; c++)
                                {
                                    var ce = self._columns[c];
                                    if (0 <= ce.col && ce.col < columnCount)
                                    {
                                        if (sheet.getColumnResizable(ce.col, sheetArea))
                                        {
                                            fitValue = self._getColumnAutoFitValue(ce.col);
                                            if (fitValue !== sheet.getColumnWidth(ce.col, sheetArea))
                                            {
                                                sheet.setColumnWidth(ce.col, fitValue, sheetArea)
                                            }
                                        }
                                    }
                                }
                            }
                            finally
                            {
                                Sheets._CacheMgr.clearCache();
                                sheet.resumeEvent();
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            sheet.triggerColumnWidthChanged({
                                sheet: sheet, sheetName: sheet._name, colList: resizedColumns, header: isHeader
                            })
                        }
                    };
                    ColumnAutoFitUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        var sizes = keyword_null;
                        var visibles = keyword_null;
                        var sheet = self._sheet;
                        var sheetArea = self._sheetArea;
                        if (sheet && self._columns && self._columns.length > 0)
                        {
                            var columnCount = sheet.getColumnCount(sheetArea);
                            sizes = [self._columns.length];
                            visibles = [self._columns.length];
                            for (var c = 0, len = self._columns.length; c < len; c++)
                            {
                                var ce = self._columns[c];
                                if (0 <= ce.col && ce.col < columnCount)
                                {
                                    sizes[c] = sheet.getColumnWidth(ce.col, sheetArea);
                                    visibles[c] = sheet.getColumnVisible(ce.col, sheetArea)
                                }
                                else
                                {
                                    sizes[c] = -1;
                                    visibles[c] = false
                                }
                            }
                        }
                        self._oldSizes = sizes;
                        self._oldVisibles = visibles
                    };
                    ColumnAutoFitUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheetArea = self._sheetArea;
                        if (self._sheet && self._columns && self._columns.length > 0)
                        {
                            var isHeader = sheetArea === 2;
                            var sheet = self._sheet;
                            self._suspendInvalidate(arg);
                            var resizedColumns = self._getColumnsReiszed(self._columns);
                            var args = {
                                    sheet: sheet, sheetName: sheet._name, colList: resizedColumns, header: isHeader, cancel: false
                                };
                            sheet.triggerColumnWidthChanging(args);
                            if (args && args.cancel === true)
                            {
                                self._resumeInvalidate(arg);
                                return false
                            }
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.suspendEvent();
                            try
                            {
                                var columnCount = sheet.getColumnCount(sheetArea);
                                var oldSize,
                                    oldVisible;
                                for (var c = 0; c < self._columns.length; c++)
                                {
                                    var ce = self._columns[c];
                                    oldSize = self._oldSizes[c];
                                    oldVisible = self._oldVisibles[c];
                                    if (0 <= c && c < columnCount && oldSize !== -1)
                                    {
                                        if (sheet.getColumnResizable(ce.col, sheetArea))
                                        {
                                            sheet.setColumnWidth(ce.col, oldSize, sheetArea);
                                            sheet.setColumnVisible(ce.col, oldVisible, sheetArea);
                                            ret = true
                                        }
                                    }
                                }
                            }
                            finally
                            {
                                sheet.resumeEvent();
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            sheet.triggerColumnWidthChanged({
                                sheet: sheet, sheetName: sheet._name, colList: resizedColumns, header: isHeader
                            })
                        }
                        return ret
                    };
                    ColumnAutoFitUndoAction.prototype._getColumnsReiszed = function(columnWidthChangeExtents)
                    {
                        var columns = [];
                        for (var i = 0; i < columnWidthChangeExtents.length; i++)
                        {
                            var item = columnWidthChangeExtents[i];
                            columns.push(item.col)
                        }
                        return columns
                    };
                    ColumnAutoFitUndoAction.prototype._nextAutoFitRow = function(row, col)
                    {
                        var sheet = this._sheet;
                        var sheetArea = this._sheetArea;
                        var nextNonNullRow = -1;
                        var rowCount = sheet.getRowCount(sheetArea);
                        for (var i = row + 1; i < rowCount; i++)
                        {
                            var text = sheet.getText(i, col, sheetArea);
                            if (text)
                            {
                                nextNonNullRow = i;
                                break
                            }
                            var style = sheet.getActualStyle(i, col, sheetArea);
                            if (style && style.cellType)
                            {
                                nextNonNullRow = i;
                                break
                            }
                        }
                        return nextNonNullRow
                    };
                    ColumnAutoFitUndoAction.prototype._getColumnAutoFitValue = function(col)
                    {
                        var self = this;
                        var sheet = self._sheet,
                            render = sheet._render;
                        var width = 0;
                        var sheetArea = self._sheetArea;
                        var areas = [sheetArea];
                        if (self._autofitType == 1)
                        {
                            if (sheetArea == 3)
                            {
                                areas.push(1)
                            }
                            else if (sheetArea == 2)
                            {
                                areas.push(0)
                            }
                        }
                        for (var i = 0; i < areas.length; i++)
                        {
                            var row = 0;
                            var sheetArea = areas[i];
                            var rowCount = sheet.getRowCount(sheetArea);
                            while (row >= 0 && row < rowCount)
                            {
                                var span = sheet._getSpanModel(sheetArea).find(row, col);
                                if (span && (span.col < col || span.colCount > 1 || span.row < row))
                                {
                                    row = span.row + span.rowCount;
                                    continue
                                }
                                var style = sheet.getActualStyle(row, col, sheetArea);
                                var valueWidth = 0;
                                var cellType = style.cellType || sheet.getDefaultCellType(sheetArea);
                                if (cellType)
                                {
                                    var font = style.font || render._getDefaultFont(sheetArea);
                                    style.font = render._getZoomFont(font);
                                    var isFilterHeader = !!(sheet.rowFilter() && sheet.rowFilter().isFilterHeader(row, col, sheetArea));
                                    if (!isFilterHeader && sheetArea === 3)
                                    {
                                        var table = sheet.findTable(row, col);
                                        if (table && table.showHeader() && table.headerIndex() === row && table.rowFilter() && table.rowFilter().filterButtonVisible(col))
                                        {
                                            isFilterHeader = true
                                        }
                                    }
                                    var fmt = style.formatter ? style.formatter : style._autoFormatter,
                                        context = {
                                            sheet: sheet, row: row, col: col, sheetArea: sheetArea
                                        };
                                    var value = sheet.getValue(row, col, sheetArea);
                                    var text = cellType.format(value, fmt, context);
                                    valueWidth = cellType.getAutoFitWidth(value, text, style, sheet._zoomFactor, context);
                                    if (isFilterHeader)
                                    {
                                        var filterButtonZoom = Math_min(sheet._zoomFactor, 1);
                                        var buttonwidth = parseInt((sheet.defaults.rowHeight * filterButtonZoom).toString(), 10);
                                        valueWidth += buttonwidth
                                    }
                                }
                                if (valueWidth > width)
                                {
                                    width = valueWidth
                                }
                                row++
                            }
                        }
                        if (width === 0)
                        {
                            width = sheet.defaults.colWidth
                        }
                        else
                        {
                            width += Math_ceil(3 / sheet._zoomFactor)
                        }
                        return width
                    };
                    ColumnAutoFitUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    return ColumnAutoFitUndoAction
                })(ActionBase);
            UndoRedo.ColumnAutoFitUndoAction = ColumnAutoFitUndoAction;
            var RowAutoFitUndoAction = (function(_super)
                {
                    __extends(RowAutoFitUndoAction, _super);
                    function RowAutoFitUndoAction(sheet, rows, columnHeader, autoFitType)
                    {
                        _super.call(this);
                        var self = this;
                        self._sheet = sheet;
                        self._rows = rows;
                        self._sheetArea = columnHeader ? 1 : 3;
                        if (arguments.length === 3)
                        {
                            autoFitType = sheet._getAutoFitType()
                        }
                        self._autofitType = autoFitType;
                        self._oldSizes = [];
                        self._oldVisibles = []
                    }
                    RowAutoFitUndoAction.prototype.canExecute = function(arg)
                    {
                        return this._sheet && this._rows && this._rows.length > 0
                    };
                    RowAutoFitUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        if (self.canExecute(arg))
                        {
                            var sheet = self._sheet;
                            self._suspendInvalidate(arg);
                            var resizedRows = self._getRowsResized(self._rows);
                            var sheetArea = self._sheetArea;
                            var inHeader = self._sheetArea === 1;
                            var args = {
                                    sheet: sheet, sheetName: sheet._name, rowList: resizedRows, header: inHeader, cancel: false
                                };
                            sheet.triggerRowHeightChanging(args);
                            if (args && args.cancel === true)
                            {
                                self._canUndo = false;
                                self._resumeInvalidate(arg);
                                return
                            }
                            else
                            {
                                self._canUndo = true
                            }
                            self.saveState();
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.suspendEvent();
                            try
                            {
                                var rowCount = sheet.getRowCount(sheetArea);
                                var fitValue;
                                for (var r = 0, len = self._rows.length; r < len; r++)
                                {
                                    var re = self._rows[r];
                                    if (0 <= re.row && re.row < rowCount)
                                    {
                                        if (sheet.getRowResizable(re.row, sheetArea))
                                        {
                                            fitValue = self._getRowAutoFitValue(re.row);
                                            if (fitValue !== sheet.getRowHeight(re.row, sheetArea))
                                            {
                                                sheet.setRowHeight(re.row, fitValue, sheetArea)
                                            }
                                        }
                                    }
                                }
                            }
                            finally
                            {
                                sheet.resumeEvent();
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            sheet.triggerRowHeightChanged({
                                sheet: sheet, sheetName: sheet._name, rowList: resizedRows, header: inHeader
                            })
                        }
                    };
                    RowAutoFitUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        var sizes = keyword_null;
                        var visibles = keyword_null;
                        var sheet = self._sheet;
                        var sheetArea = self._sheetArea;
                        if (sheet && self._rows && self._rows.length > 0)
                        {
                            sizes = [self._rows.length];
                            visibles = [self._rows.length];
                            var rowCount = sheet.getRowCount(sheetArea);
                            for (var r = 0, len = self._rows.length; r < len; r++)
                            {
                                var re = self._rows[r];
                                if (0 <= re.row && re.row < rowCount)
                                {
                                    sizes[r] = sheet.getRowHeight(re.row, sheetArea);
                                    visibles[r] = sheet.getRowVisible(re.row, sheetArea)
                                }
                                else
                                {
                                    sizes[r] = -1;
                                    visibles[r] = false
                                }
                            }
                        }
                        self._oldSizes = sizes;
                        self._oldVisibles = visibles
                    };
                    RowAutoFitUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        var sheetArea = self._sheetArea;
                        var inHeader = self._sheetArea === 1;
                        if (sheet && self._rows && self._rows.length > 0)
                        {
                            self._suspendInvalidate(arg);
                            var resizedRows = self._getRowsResized(self._rows);
                            var args = {
                                    sheet: sheet, sheetName: sheet._name, rowList: resizedRows, header: inHeader, cancel: false
                                };
                            sheet.triggerRowHeightChanging(args);
                            if (args && args.cancel === true)
                            {
                                self._resumeInvalidate(arg);
                                return false
                            }
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.suspendEvent();
                            try
                            {
                                var oldSize,
                                    oldVisible;
                                var rowCount = sheet.getRowCount(sheetArea);
                                for (var r = 0, len = self._rows.length; r < len; r++)
                                {
                                    var re = self._rows[r];
                                    oldSize = self._oldSizes[r];
                                    oldVisible = self._oldVisibles[r];
                                    if (0 <= r && r < rowCount && oldSize !== -1)
                                    {
                                        if (sheet.getRowResizable(re.row, sheetArea))
                                        {
                                            sheet.setRowHeight(re.row, oldSize, sheetArea);
                                            sheet.setRowVisible(re.row, oldVisible, sheetArea);
                                            ret = true
                                        }
                                    }
                                }
                            }
                            finally
                            {
                                sheet.resumeEvent();
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            sheet.triggerRowHeightChanged({
                                sheet: sheet, sheetName: sheet._name, rowList: resizedRows, header: inHeader
                            })
                        }
                        return ret
                    };
                    RowAutoFitUndoAction.prototype._getRowsResized = function(rowHeightChangeExtents)
                    {
                        var rows = [];
                        for (var i = 0, len = rowHeightChangeExtents.length; i < len; i++)
                        {
                            var item = rowHeightChangeExtents[i];
                            rows.push(item.row)
                        }
                        return rows
                    };
                    RowAutoFitUndoAction.prototype._nextAutoFitColumn = function(row, col)
                    {
                        var sheet = this._sheet;
                        var sheetArea = this._sheetArea;
                        var inHeader = this._sheetArea === 1;
                        var nextNonNullCol = sheet._nextNonNullColumn(row, col, inHeader);
                        var nextCellTypeCol = -1;
                        var colCount = sheet.getColumnCount(sheetArea);
                        for (var j = col + 1; j < colCount; j++)
                        {
                            var style = sheet.getActualStyle(row, j, sheetArea);
                            if (style && style.cellType)
                            {
                                nextCellTypeCol = j;
                                break
                            }
                        }
                        if (nextNonNullCol >= 0 && nextCellTypeCol >= 0)
                        {
                            return Math_min(nextNonNullCol, nextCellTypeCol)
                        }
                        else if (nextNonNullCol >= 0)
                        {
                            return nextNonNullCol
                        }
                        else if (nextCellTypeCol >= 0)
                        {
                            return nextCellTypeCol
                        }
                        else
                        {
                            return -1
                        }
                    };
                    RowAutoFitUndoAction.prototype._getRowAutoFitValue = function(row)
                    {
                        var self = this;
                        var sheet = self._sheet,
                            render = sheet._render;
                        var height = 0;
                        var sheetArea = self._sheetArea;
                        var inHeader = self._sheetArea === 1;
                        var areas = [sheetArea];
                        if (self._autofitType == 1)
                        {
                            if (sheetArea == 3)
                            {
                                areas.push(2)
                            }
                            else if (sheetArea == 1)
                            {
                                areas.push(0)
                            }
                        }
                        for (var i = 0; i < areas.length; i++)
                        {
                            sheetArea = areas[i];
                            var col = 0;
                            var colCount = sheet.getColumnCount(sheetArea);
                            var colIdx;
                            while (col >= 0 && col < colCount)
                            {
                                var span = sheet._getSpanModel(sheetArea).find(row, col);
                                if (span)
                                {
                                    if (span.row < row || span.rowCount > 1 || span.col < col)
                                    {
                                        col = span.col + span.colCount;
                                        continue
                                    }
                                }
                                var style = sheet.getActualStyle(row, col, sheetArea);
                                var font = style.font || render._getDefaultFont(sheetArea);
                                style.font = render._getZoomFont(font);
                                var valueHeight = 0;
                                var cellType = sheet.getCellType(row, col, sheetArea);
                                if (cellType)
                                {
                                    var text = sheet.getText(row, col, sheetArea);
                                    var value = sheet.getValue(row, col, sheetArea);
                                    var context = {
                                            sheet: sheet, row: row, col: col, sheetArea: sheetArea
                                        };
                                    valueHeight = cellType.getAutoFitHeight(value, text, style, sheet._zoomFactor, context)
                                }
                                if (valueHeight > height)
                                {
                                    height = valueHeight
                                }
                                if (sheetArea === 3)
                                {
                                    col = self._nextAutoFitColumn(row, col)
                                }
                                else
                                {
                                    col++
                                }
                            }
                        }
                        if (height === 0)
                        {
                            height = sheet.defaults.rowHeight
                        }
                        else
                        {
                            height += Math_ceil(3 / sheet._zoomFactor)
                        }
                        return height
                    };
                    RowAutoFitUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    return RowAutoFitUndoAction
                })(ActionBase);
            UndoRedo.RowAutoFitUndoAction = RowAutoFitUndoAction;
            var GroupExtent = (function()
                {
                    function GroupExtent(index, count)
                    {
                        this.index = index;
                        this.count = count
                    }
                    return GroupExtent
                })();
            UndoRedo.GroupExtent = GroupExtent;
            var ColumnGroupUndoAction = (function(_super)
                {
                    __extends(ColumnGroupUndoAction, _super);
                    function ColumnGroupUndoAction(sheet, groupExtent)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        this._columnGroupExtent = groupExtent;
                        this._canUndo = false
                    }
                    ColumnGroupUndoAction.prototype.canExecute = function(arg)
                    {
                        return true
                    };
                    ColumnGroupUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._columnGroupExtent && sheet.colRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._columnGroupExtent.index;
                            var count = self._columnGroupExtent.count;
                            sheet.colRangeGroup.group(index, count);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                            self._canUndo = true
                        }
                    };
                    ColumnGroupUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    ColumnGroupUndoAction.prototype.saveState = function(){};
                    ColumnGroupUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._columnGroupExtent && sheet.colRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._columnGroupExtent.index;
                            var count = self._columnGroupExtent.count;
                            sheet.colRangeGroup.ungroupRange(index, count);
                            ret = true;
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                        return ret
                    };
                    return ColumnGroupUndoAction
                })(ActionBase);
            UndoRedo.ColumnGroupUndoAction = ColumnGroupUndoAction;
            var ColumnUngroupUndoAction = (function(_super)
                {
                    __extends(ColumnUngroupUndoAction, _super);
                    function ColumnUngroupUndoAction(sheet, groupExtent)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        this._columnUngroupExtent = groupExtent;
                        this._canUndo = false
                    }
                    ColumnUngroupUndoAction.prototype.canExecute = function(arg)
                    {
                        return true
                    };
                    ColumnUngroupUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._columnUngroupExtent && sheet.colRangeGroup)
                        {
                            var index = self._columnUngroupExtent.index;
                            var count = self._columnUngroupExtent.count;
                            if (sheet.colRangeGroup.getLevel(index) >= 0 || sheet.colRangeGroup.getLevel(index + count - 1) >= 0)
                            {
                                self._suspendInvalidate(arg);
                                self._canUndo = true;
                                sheet.colRangeGroup.ungroupRange(index, count);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            else
                            {
                                self._canUndo = false
                            }
                        }
                    };
                    ColumnUngroupUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    ColumnUngroupUndoAction.prototype.saveState = function(){};
                    ColumnUngroupUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        if (Sheets.features.group && self._canUndo === true && sheet && self._columnUngroupExtent && sheet.colRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._columnUngroupExtent.index;
                            var count = self._columnUngroupExtent.count;
                            sheet.colRangeGroup.group(index, count);
                            ret = true;
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                        return ret
                    };
                    return ColumnUngroupUndoAction
                })(ActionBase);
            UndoRedo.ColumnUngroupUndoAction = ColumnUngroupUndoAction;
            var RowGroupUndoAction = (function(_super)
                {
                    __extends(RowGroupUndoAction, _super);
                    function RowGroupUndoAction(sheet, groupExtent)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        this._rowGroupExtent = groupExtent;
                        this._canUndo = false
                    }
                    RowGroupUndoAction.prototype.canExecute = function(arg)
                    {
                        return true
                    };
                    RowGroupUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._rowGroupExtent && sheet.rowRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._rowGroupExtent.index;
                            var count = self._rowGroupExtent.count;
                            sheet.rowRangeGroup.group(index, count);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                            self._canUndo = true
                        }
                    };
                    RowGroupUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    RowGroupUndoAction.prototype.saveState = function(){};
                    RowGroupUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._rowGroupExtent && sheet.rowRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._rowGroupExtent.index;
                            var count = self._rowGroupExtent.count;
                            sheet.rowRangeGroup.ungroupRange(index, count);
                            ret = true;
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                        return ret
                    };
                    return RowGroupUndoAction
                })(ActionBase);
            UndoRedo.RowGroupUndoAction = RowGroupUndoAction;
            var RowUngroupUndoAction = (function(_super)
                {
                    __extends(RowUngroupUndoAction, _super);
                    function RowUngroupUndoAction(sheet, groupExtent)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        this._rowUngroupExtent = groupExtent;
                        this._canUndo = false
                    }
                    RowUngroupUndoAction.prototype.canExecute = function(arg)
                    {
                        return true
                    };
                    RowUngroupUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._rowUngroupExtent && sheet.rowRangeGroup)
                        {
                            var index = self._rowUngroupExtent.index;
                            var count = self._rowUngroupExtent.count;
                            if (sheet.rowRangeGroup.getLevel(index) >= 0 || sheet.rowRangeGroup.getLevel(index + count - 1) >= 0)
                            {
                                self._suspendInvalidate(arg);
                                self._canUndo = true;
                                sheet.rowRangeGroup.ungroupRange(index, count);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                            else
                            {
                                self._canUndo = false
                            }
                        }
                    };
                    RowUngroupUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    RowUngroupUndoAction.prototype.saveState = function(){};
                    RowUngroupUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        if (Sheets.features.group && self._canUndo === true && sheet && self._rowUngroupExtent && sheet.rowRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._rowUngroupExtent.index;
                            var count = self._rowUngroupExtent.count;
                            sheet.rowRangeGroup.group(index, count);
                            ret = true;
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                        return ret
                    };
                    return RowUngroupUndoAction
                })(ActionBase);
            UndoRedo.RowUngroupUndoAction = RowUngroupUndoAction;
            var GroupExpandExtent = (function()
                {
                    function GroupExpandExtent(index, level, collapsed)
                    {
                        this.index = index;
                        this.level = level;
                        this.collapsed = collapsed
                    }
                    return GroupExpandExtent
                })();
            UndoRedo.GroupExpandExtent = GroupExpandExtent;
            var ColumnGroupExpandUndoAction = (function(_super)
                {
                    __extends(ColumnGroupExpandUndoAction, _super);
                    function ColumnGroupExpandUndoAction(sheet, columnExpandExtent)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        this._columnExpandExtent = columnExpandExtent;
                        this._canUndo = false
                    }
                    ColumnGroupExpandUndoAction.prototype.canExecute = function()
                    {
                        return true
                    };
                    ColumnGroupExpandUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._columnExpandExtent && sheet.colRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._columnExpandExtent.index;
                            var collapsed = self._columnExpandExtent.collapsed;
                            sheet.colRangeGroup.setCollapsed(index, collapsed);
                            self._showColumnRangeGroup(collapsed);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                            self._canUndo = true
                        }
                    };
                    ColumnGroupExpandUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    ColumnGroupExpandUndoAction.prototype.saveState = function(){};
                    ColumnGroupExpandUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._columnExpandExtent && sheet.colRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._columnExpandExtent.index;
                            var collapsed = self._columnExpandExtent.collapsed;
                            sheet.colRangeGroup.setCollapsed(index, !collapsed);
                            ret = true;
                            self._showColumnRangeGroup(!collapsed);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                        return ret
                    };
                    ColumnGroupExpandUndoAction.prototype._showColumnRangeGroup = function(collapsed)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        var summaryIndex = self._columnExpandExtent.index;
                        if (summaryIndex < 0 || summaryIndex >= sheet.getColumnCount())
                        {
                            return
                        }
                        var rangeGroup,
                            startIndex,
                            endIndex,
                            viewportIndex,
                            leftColumn,
                            viewportWidth,
                            needViewportWidth;
                        if (sheet.colRangeGroup.direction === 1)
                        {
                            rangeGroup = sheet.colRangeGroup.find(summaryIndex - 1, self._columnExpandExtent.level);
                            if (!rangeGroup)
                            {
                                return
                            }
                            startIndex = rangeGroup.start;
                            endIndex = summaryIndex;
                            viewportIndex = 1;
                            if (collapsed)
                            {
                                startIndex = summaryIndex
                            }
                            else
                            {
                                if (startIndex < sheet.frozenColCount)
                                {
                                    startIndex = sheet.frozenColCount
                                }
                            }
                            leftColumn = sheet.getViewportLeftColumn(viewportIndex);
                            if (startIndex < leftColumn)
                            {
                                leftColumn = startIndex
                            }
                            viewportWidth = sheet.getViewportWidth(viewportIndex);
                            needViewportWidth = self._getColsTotalWidth(sheet, leftColumn, endIndex);
                            if (needViewportWidth > viewportWidth)
                            {
                                leftColumn = self._getNewLeftColumn(sheet, leftColumn, needViewportWidth - viewportWidth)
                            }
                            sheet._scrollLeftCol = self._tryGetNextScrollableCol(sheet, leftColumn)
                        }
                        else
                        {
                            rangeGroup = sheet.colRangeGroup.find(summaryIndex + 1, self._columnExpandExtent.level);
                            if (!rangeGroup)
                            {
                                return
                            }
                            startIndex = summaryIndex;
                            endIndex = rangeGroup.end;
                            viewportIndex = 1;
                            if (collapsed)
                            {
                                endIndex = summaryIndex
                            }
                            else
                            {
                                var colCount = sheet.getColumnCount();
                                if (endIndex >= colCount)
                                {
                                    endIndex = colCount - 1
                                }
                            }
                            leftColumn = sheet.getViewportLeftColumn(viewportIndex);
                            if (startIndex < leftColumn)
                            {
                                sheet._scrollLeftCol = self._tryGetNextScrollableCol(sheet, startIndex)
                            }
                            else
                            {
                                viewportWidth = sheet.getViewportWidth(viewportIndex);
                                needViewportWidth = self._getColsTotalWidth(sheet, leftColumn, endIndex);
                                if (needViewportWidth > viewportWidth)
                                {
                                    leftColumn = self._getNewLeftColumn(sheet, leftColumn, needViewportWidth - viewportWidth);
                                    sheet._scrollLeftCol = self._tryGetNextScrollableCol(sheet, Math_min(startIndex, leftColumn))
                                }
                            }
                        }
                        sheet._syncHScollbarPosition()
                    };
                    ColumnGroupExpandUndoAction.prototype._getColsTotalWidth = function(sheet, leftColumn, rightColumn)
                    {
                        var columnWidthTotal = 0;
                        var colCount = sheet.getColumnCount();
                        for (var index = leftColumn; (index <= rightColumn) && (index < colCount); index++)
                        {
                            columnWidthTotal += sheet.getColumnWidth(index) * sheet._zoomFactor
                        }
                        return columnWidthTotal
                    };
                    ColumnGroupExpandUndoAction.prototype._getNewLeftColumn = function(sheet, oldLeftColumn, increasedWidth)
                    {
                        var columnWidthTotal = 0;
                        var colCount = sheet.getColumnCount();
                        for (var index = oldLeftColumn; (index < colCount) && (columnWidthTotal < increasedWidth); index++)
                        {
                            oldLeftColumn++;
                            columnWidthTotal += sheet.getColumnWidth(index) * sheet._zoomFactor
                        }
                        return (oldLeftColumn >= colCount ? colCount - 1 : oldLeftColumn)
                    };
                    ColumnGroupExpandUndoAction.prototype._tryGetNextScrollableCol = function(sheet, startColumn)
                    {
                        var min = sheet.frozenColCount;
                        var max = sheet.getColumnCount() - 1;
                        if (startColumn < min)
                        {
                            return min
                        }
                        if (startColumn > max)
                        {
                            return max
                        }
                        for (var i = startColumn; i <= max; i++)
                        {
                            var columnHeight = sheet.getColumnWidth(i);
                            if (columnHeight > 0)
                            {
                                return i
                            }
                        }
                        return -1
                    };
                    return ColumnGroupExpandUndoAction
                })(ActionBase);
            UndoRedo.ColumnGroupExpandUndoAction = ColumnGroupExpandUndoAction;
            var RowGroupExpandUndoAction = (function(_super)
                {
                    __extends(RowGroupExpandUndoAction, _super);
                    function RowGroupExpandUndoAction(sheet, rowExpandExtent)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        this._rowExpandExtent = rowExpandExtent;
                        this._canUndo = false
                    }
                    RowGroupExpandUndoAction.prototype.canExecute = function()
                    {
                        return true
                    };
                    RowGroupExpandUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._rowExpandExtent && sheet.rowRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._rowExpandExtent.index;
                            var collapsed = self._rowExpandExtent.collapsed;
                            sheet.rowRangeGroup.setCollapsed(index, collapsed);
                            self._showRowRangeGroup(collapsed);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                            self._canUndo = true
                        }
                    };
                    RowGroupExpandUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    RowGroupExpandUndoAction.prototype.saveState = function(){};
                    RowGroupExpandUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._rowExpandExtent && sheet.rowRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            var index = self._rowExpandExtent.index;
                            var collapsed = self._rowExpandExtent.collapsed;
                            sheet.rowRangeGroup.setCollapsed(index, !collapsed);
                            ret = true;
                            self._showRowRangeGroup(!collapsed);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                        return ret
                    };
                    RowGroupExpandUndoAction.prototype._showRowRangeGroup = function(collapsed)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        var summaryIndex = self._rowExpandExtent.index;
                        if (summaryIndex < 0 || summaryIndex >= sheet.getRowCount())
                        {
                            return
                        }
                        var rangeGroup,
                            startIndex,
                            endIndex,
                            viewportIndex,
                            topRow,
                            viewportHeight,
                            needViewportHeight;
                        if (sheet.rowRangeGroup.direction === 1)
                        {
                            rangeGroup = sheet.rowRangeGroup.find(summaryIndex - 1, self._rowExpandExtent.level);
                            if (!rangeGroup)
                            {
                                return
                            }
                            startIndex = rangeGroup.start;
                            endIndex = summaryIndex;
                            viewportIndex = 1;
                            if (collapsed)
                            {
                                startIndex = summaryIndex
                            }
                            else
                            {
                                if (startIndex < sheet.frozenRowCount)
                                {
                                    startIndex = sheet.frozenRowCount
                                }
                            }
                            topRow = sheet.getViewportTopRow(viewportIndex);
                            if (startIndex < topRow)
                            {
                                topRow = startIndex
                            }
                            viewportHeight = sheet.getViewportHeight(viewportIndex);
                            needViewportHeight = self._getRowsTotalHeight(sheet, topRow, endIndex);
                            if (needViewportHeight > viewportHeight)
                            {
                                topRow = self._getNewTopRow(sheet, topRow, needViewportHeight - viewportHeight)
                            }
                            sheet._scrollTopRow = self._tryGetNextScrollableRow(sheet, topRow)
                        }
                        else
                        {
                            rangeGroup = sheet.rowRangeGroup.find(summaryIndex + 1, self._rowExpandExtent.level);
                            if (!rangeGroup)
                            {
                                return
                            }
                            startIndex = summaryIndex;
                            endIndex = rangeGroup.end;
                            viewportIndex = 1;
                            if (collapsed)
                            {
                                endIndex = summaryIndex
                            }
                            else
                            {
                                var rowCount = sheet.getRowCount();
                                if (endIndex >= rowCount)
                                {
                                    endIndex = rowCount - 1
                                }
                            }
                            topRow = sheet.getViewportTopRow(viewportIndex);
                            if (startIndex < topRow)
                            {
                                sheet._scrollTopRow = self._tryGetNextScrollableRow(sheet, startIndex)
                            }
                            else
                            {
                                viewportHeight = sheet.getViewportHeight(viewportIndex);
                                needViewportHeight = self._getRowsTotalHeight(sheet, topRow, endIndex);
                                if (needViewportHeight > viewportHeight)
                                {
                                    topRow = self._getNewTopRow(sheet, topRow, needViewportHeight - viewportHeight);
                                    sheet._scrollTopRow = self._tryGetNextScrollableRow(sheet, Math_min(startIndex, topRow))
                                }
                            }
                        }
                        sheet._syncVScrollbarPosition()
                    };
                    RowGroupExpandUndoAction.prototype._getRowsTotalHeight = function(sheet, topRow, bottomRow)
                    {
                        var rowHeightTotal = 0;
                        var rowCount = sheet.getRowCount();
                        for (var index = topRow; (index <= bottomRow) && (index < rowCount); index++)
                        {
                            rowHeightTotal += sheet.getRowHeight(index) * sheet._zoomFactor
                        }
                        return rowHeightTotal
                    };
                    RowGroupExpandUndoAction.prototype._getNewTopRow = function(sheet, oldTopRow, increasedHeight)
                    {
                        var rowHeightTotal = 0;
                        var rowCount = sheet.getRowCount();
                        for (var index = oldTopRow; (index <= rowCount) && (rowHeightTotal < increasedHeight); index++)
                        {
                            oldTopRow++;
                            rowHeightTotal += sheet.getRowHeight(index) * sheet._zoomFactor
                        }
                        return (oldTopRow >= rowCount) ? (rowCount - 1) : oldTopRow
                    };
                    RowGroupExpandUndoAction.prototype._tryGetNextScrollableRow = function(sheet, startRow)
                    {
                        var min = sheet.frozenRowCount;
                        var max = sheet.getRowCount() - 1;
                        if (startRow < min)
                        {
                            return min
                        }
                        if (startRow > max)
                        {
                            return max
                        }
                        for (var i = startRow; i <= max; i++)
                        {
                            var rowHeight = sheet.getRowHeight(i);
                            if (rowHeight > 0)
                            {
                                return i
                            }
                        }
                        return -1
                    };
                    return RowGroupExpandUndoAction
                })(ActionBase);
            UndoRedo.RowGroupExpandUndoAction = RowGroupExpandUndoAction;
            var GroupHeaderExpandExtent = (function()
                {
                    function GroupHeaderExpandExtent(level)
                    {
                        this.level = level
                    }
                    return GroupHeaderExpandExtent
                })();
            UndoRedo.GroupHeaderExpandExtent = GroupHeaderExpandExtent;
            var ColumnGroupHeaderExpandUndoAction = (function(_super)
                {
                    __extends(ColumnGroupHeaderExpandUndoAction, _super);
                    function ColumnGroupHeaderExpandUndoAction(sheet, columnGroupHeaderExpandExtent)
                    {
                        _super.call(this);
                        var self = this;
                        self._sheet = sheet;
                        self._columnGroupHeaderExpandExtent = columnGroupHeaderExpandExtent;
                        self._oldStatus = {};
                        self._canUndo = false
                    }
                    ColumnGroupHeaderExpandUndoAction.prototype.canExecute = function()
                    {
                        return true
                    };
                    ColumnGroupHeaderExpandUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._columnGroupHeaderExpandExtent && sheet.colRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            self.saveState();
                            var level = self._columnGroupHeaderExpandExtent.level;
                            for (var index = 0; index < level; index++)
                            {
                                sheet.colRangeGroup.expand(index, true)
                            }
                            sheet.colRangeGroup.expand(level, false);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                            self._canUndo = true
                        }
                    };
                    ColumnGroupHeaderExpandUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    ColumnGroupHeaderExpandUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        var status = keyword_null;
                        var sheet = self._sheet;
                        if (sheet && self._columnGroupHeaderExpandExtent && sheet.colRangeGroup)
                        {
                            var level = self._columnGroupHeaderExpandExtent.level;
                            status = {};
                            for (var index = 0; index <= level; index++)
                            {
                                var columnIndex = 0;
                                var columnCount = sheet.getColumnCount();
                                var direction = sheet.colRangeGroup.direction;
                                while (columnIndex < columnCount)
                                {
                                    var group = sheet.colRangeGroup.find(columnIndex, index);
                                    if (group)
                                    {
                                        var summaryIndex = -1;
                                        switch (direction)
                                        {
                                            case 0:
                                                summaryIndex = group.start - 1;
                                                break;
                                            case 1:
                                                summaryIndex = group.end + 1;
                                                break;
                                            default:
                                                break
                                        }
                                        var isCollapsed = (group.getState() === 1);
                                        if (!status[summaryIndex])
                                        {
                                            status[summaryIndex] = isCollapsed
                                        }
                                        columnIndex += (group.end - group.start + 1)
                                    }
                                    columnIndex++
                                }
                            }
                        }
                        self._oldStatus = status
                    };
                    ColumnGroupHeaderExpandUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._oldStatus && sheet.colRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            for (var index in self._oldStatus)
                            {
                                if (index)
                                {
                                    sheet.colRangeGroup.setCollapsed(index, self._oldStatus[index]);
                                    ret = true
                                }
                            }
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                        return ret
                    };
                    return ColumnGroupHeaderExpandUndoAction
                })(ActionBase);
            UndoRedo.ColumnGroupHeaderExpandUndoAction = ColumnGroupHeaderExpandUndoAction;
            var RowGroupHeaderExpandUndoAction = (function(_super)
                {
                    __extends(RowGroupHeaderExpandUndoAction, _super);
                    function RowGroupHeaderExpandUndoAction(sheet, rowGroupHeaderExpandExtent)
                    {
                        _super.call(this);
                        var self = this;
                        self._sheet = sheet;
                        self._rowGroupHeaderExpandExtent = rowGroupHeaderExpandExtent;
                        self._oldStatus = {};
                        self._canUndo = false
                    }
                    RowGroupHeaderExpandUndoAction.prototype.canExecute = function()
                    {
                        return true
                    };
                    RowGroupHeaderExpandUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._rowGroupHeaderExpandExtent && sheet.rowRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            self.saveState();
                            var level = self._rowGroupHeaderExpandExtent.level;
                            for (var index = 0; index < level; index++)
                            {
                                sheet.rowRangeGroup.expand(index, true)
                            }
                            sheet.rowRangeGroup.expand(level, false);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                            self._canUndo = true
                        }
                    };
                    RowGroupHeaderExpandUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    RowGroupHeaderExpandUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        var status = keyword_null;
                        var sheet = self._sheet;
                        if (sheet && self._rowGroupHeaderExpandExtent && sheet.rowRangeGroup)
                        {
                            var level = self._rowGroupHeaderExpandExtent.level;
                            status = {};
                            for (var index = 0; index <= level; index++)
                            {
                                var rowIndex = 0;
                                var rowCount = sheet.getRowCount();
                                var direction = sheet.rowRangeGroup.direction;
                                while (rowIndex < rowCount)
                                {
                                    var group = sheet.rowRangeGroup.find(rowIndex, index);
                                    if (group)
                                    {
                                        var summaryIndex = -1;
                                        switch (direction)
                                        {
                                            case 0:
                                                summaryIndex = group.start - 1;
                                                break;
                                            case 1:
                                                summaryIndex = group.end + 1;
                                                break;
                                            default:
                                                break
                                        }
                                        var isCollapsed = (group.getState() === 1);
                                        if (!status[summaryIndex])
                                        {
                                            status[summaryIndex] = isCollapsed
                                        }
                                        rowIndex += (group.end - group.start + 1)
                                    }
                                    rowIndex++
                                }
                            }
                        }
                        self._oldStatus = status
                    };
                    RowGroupHeaderExpandUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var ret = false;
                        var sheet = self._sheet;
                        if (Sheets.features.group && sheet && self._oldStatus && sheet.rowRangeGroup)
                        {
                            self._suspendInvalidate(arg);
                            for (var index in self._oldStatus)
                            {
                                if (index)
                                {
                                    sheet.rowRangeGroup.setCollapsed(index, self._oldStatus[index]);
                                    ret = true
                                }
                            }
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                        return ret
                    };
                    return RowGroupHeaderExpandUndoAction
                })(ActionBase);
            UndoRedo.RowGroupHeaderExpandUndoAction = RowGroupHeaderExpandUndoAction;
            var DragDropExtent = (function()
                {
                    function DragDropExtent(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount)
                    {
                        var self = this;
                        self.fromRow = fromRow;
                        self.fromColumn = fromColumn;
                        self.toRow = toRow;
                        self.toColumn = toColumn;
                        self.rowCount = rowCount;
                        self.columnCount = columnCount
                    }
                    return DragDropExtent
                })();
            UndoRedo.DragDropExtent = DragDropExtent;
            var DragDropUndoAction = (function(_super)
                {
                    __extends(DragDropUndoAction, _super);
                    function DragDropUndoAction(sheet, dragMoveExtent, copy, insert, option)
                    {
                        _super.call(this);
                        var self = this;
                        self._sheet = sheet;
                        self._dragDropExtent = dragMoveExtent;
                        self._copy = copy;
                        self._insert = insert;
                        self._option = option
                    }
                    DragDropUndoAction.prototype.canExecute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        var dragExtent = self._dragDropExtent;
                        if (!sheet._isValidRange(dragExtent.fromRow, dragExtent.fromColumn, dragExtent.rowCount, dragExtent.columnCount, self._sheet.getRowCount(), self._sheet.getColumnCount()))
                        {
                            return false
                        }
                        if (!self._insert)
                        {
                            if (!sheet._isValidRange(dragExtent.toRow, dragExtent.toColumn, dragExtent.rowCount, dragExtent.columnCount, self._sheet.getRowCount(), self._sheet.getColumnCount()))
                            {
                                return false
                            }
                        }
                        return !(sheet.isProtected && sheet._isAnyCellInRangeLocked(new Sheets.Range(dragExtent.toRow, dragExtent.toColumn, dragExtent.rowCount, dragExtent.columnCount))) && sheet._checkArrayFormula(dragExtent.toRow, dragExtent.toColumn, dragExtent.rowCount, dragExtent.columnCount) && !(sheet.isProtected && sheet._isAnyCellInRangeLocked(new Sheets.Range(dragExtent.fromRow, dragExtent.fromColumn, dragExtent.rowCount, dragExtent.columnCount))) && sheet._checkArrayFormula(dragExtent.fromRow, dragExtent.fromColumn, dragExtent.rowCount, dragExtent.columnCount)
                    };
                    DragDropUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        self.saveState();
                        var from,
                            to,
                            count,
                            oldSelections,
                            newSelections;
                        if (self._insert)
                        {
                            var ifr = self._dragDropExtent.fromRow,
                                ifc = self._dragDropExtent.fromColumn;
                            if (ifc >= 0 && ifr < 0)
                            {
                                from = self._dragDropExtent.fromColumn;
                                to = self._dragDropExtent.toColumn;
                                count = self._dragDropExtent.columnCount;
                                var activeColumn = self._dragDropExtent.toColumn;
                                self._suspendInvalidate(arg);
                                var oldState = sheet.isPaintSuspended();
                                sheet.isPaintSuspended(true);
                                try
                                {
                                    self._sheet.addColumns(to, count);
                                    if (self._copy)
                                    {
                                        self._sheet.copyTo(-1, (to <= from ? from + count : from), -1, to, -1, count, self._option)
                                    }
                                    else
                                    {
                                        self._sheet.moveTo(-1, (to <= from ? from + count : from), -1, to, -1, count, self._option);
                                        self._sheet.deleteColumns((to <= from ? from + count : from), count);
                                        if (from < to)
                                        {
                                            activeColumn = to - count
                                        }
                                    }
                                    if (sheet)
                                    {
                                        oldSelections = sheet.getSelections();
                                        sheet._clearSelectionImp();
                                        sheet.addSelection(-1, activeColumn, sheet.getRowCount(), count);
                                        newSelections = sheet.getSelections();
                                        sheet.triggerSelectionChanging({
                                            sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                                        });
                                        sheet.triggerSelectionChanged({
                                            sheet: sheet, sheetName: sheet._name
                                        });
                                        sheet._setActiveCellImp(sheet._getFirstVisualRow(), activeColumn, sheet.activeRowViewportIndex, sheet.activeColViewportIndex)
                                    }
                                }
                                finally
                                {
                                    sheet._dragRect = {};
                                    sheet.isPaintSuspended(oldState);
                                    var repained = self._resumeInvalidate(arg);
                                    if (!repained)
                                    {
                                        sheet.invalidateLayout();
                                        sheet.repaint()
                                    }
                                }
                            }
                            else if (self._dragDropExtent.fromRow >= 0 && self._dragDropExtent.fromColumn < 0)
                            {
                                from = self._dragDropExtent.fromRow;
                                to = self._dragDropExtent.toRow;
                                count = self._dragDropExtent.rowCount;
                                var activeRow = self._dragDropExtent.toRow;
                                self._suspendInvalidate(arg);
                                var oldState = sheet.isPaintSuspended();
                                sheet.isPaintSuspended(true);
                                try
                                {
                                    self._sheet.addRows(to, count);
                                    if (self._copy)
                                    {
                                        self._sheet.copyTo((to <= from ? from + count : from), -1, to, -1, count, -1, self._option)
                                    }
                                    else
                                    {
                                        self._sheet.moveTo((to <= from ? from + count : from), -1, to, -1, count, -1, self._option);
                                        self._sheet.deleteRows((to <= from ? from + count : from), count);
                                        if (from < to)
                                        {
                                            activeRow = to - count
                                        }
                                    }
                                    if (sheet)
                                    {
                                        oldSelections = sheet.getSelections();
                                        sheet._clearSelectionImp();
                                        sheet.addSelection(activeRow, -1, count, sheet.getColumnCount());
                                        newSelections = sheet.getSelections();
                                        sheet.triggerSelectionChanging({
                                            sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                                        });
                                        sheet.triggerSelectionChanged({
                                            sheet: sheet, sheetName: sheet._name
                                        });
                                        sheet._setActiveCellImp(activeRow, sheet._getFirstVisualColumn(), sheet.activeRowViewportIndex, sheet.activeColViewportIndex)
                                    }
                                }
                                finally
                                {
                                    sheet._dragRect = {};
                                    sheet.isPaintSuspended(oldState);
                                    var repained = self._resumeInvalidate(arg);
                                    if (!repained)
                                    {
                                        sheet.invalidateLayout();
                                        sheet.repaint()
                                    }
                                }
                            }
                        }
                        else
                        {
                            var fromRow = self._dragDropExtent.fromRow;
                            var fromColumn = self._dragDropExtent.fromColumn;
                            var toRow = self._dragDropExtent.toRow;
                            var toColumn = self._dragDropExtent.toColumn;
                            var rowCount = self._dragDropExtent.rowCount;
                            var columnCount = self._dragDropExtent.columnCount;
                            self._suspendInvalidate(arg);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            try
                            {
                                if (self._copy)
                                {
                                    sheet.copyTo(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, self._option)
                                }
                                else
                                {
                                    sheet.moveTo(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, self._option)
                                }
                                if (sheet)
                                {
                                    oldSelections = sheet.getSelections();
                                    sheet._clearSelectionImp();
                                    sheet.addSelection(toRow, toColumn, rowCount, columnCount);
                                    newSelections = sheet.getSelections();
                                    sheet.triggerSelectionChanging({
                                        sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                                    });
                                    sheet.triggerSelectionChanged({
                                        sheet: sheet, sheetName: sheet._name
                                    });
                                    sheet._setActiveCellImp(Math_max(sheet._getFirstVisualRow(), toRow), Math_max(sheet._getFirstVisualColumn(), toColumn), sheet.activeRowViewportIndex, sheet.activeColViewportIndex);
                                    var savedFromViewportCells = self._savedFromViewportCells;
                                    if (!self._copy && savedFromViewportCells && savedFromViewportCells.isValueOrFormulaSaved())
                                    {
                                        self._savedFromAfterPastedChangedCells = new ChangedCells(self._sheet, new Sheets.Range(fromRow, fromColumn, rowCount, columnCount), self._option);
                                        self._savedFromAfterPastedChangedCells.mergeCellsHasDiffData(self._savedFromBeforePastedChangedCells.getCellsHasData());
                                        CopyMoveHelper.raiseRangeDataChanged(sheet, fromRow, fromColumn, rowCount, columnCount, self._savedFromAfterPastedChangedCells.getChangedCells(), 0, savedFromViewportCells.getValues())
                                    }
                                    var savedToViewportCells = self._savedToViewportCells;
                                    if (savedToViewportCells && savedToViewportCells.isValueOrFormulaSaved())
                                    {
                                        self._savedToAfterPastedChangedCells = new ChangedCells(self._sheet, new Sheets.Range(toRow, toColumn, rowCount, columnCount), self._option);
                                        self._savedToAfterPastedChangedCells.mergeCellsHasDiffData(self._savedToBeforePastedChangedCells.getCellsHasData());
                                        CopyMoveHelper.raiseRangeDataChanged(sheet, toRow, toColumn, rowCount, columnCount, self._savedToAfterPastedChangedCells.getChangedCells(), 0, savedToViewportCells.getValues())
                                    }
                                }
                            }
                            finally
                            {
                                sheet._dragRect = {};
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(arg);
                                if (!repained)
                                {
                                    sheet.invalidateLayout();
                                    sheet.repaint()
                                }
                            }
                        }
                    };
                    DragDropUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        self.initSaveState();
                        var fromRow = self._dragDropExtent.fromRow < 0 ? 0 : self._dragDropExtent.fromRow;
                        var fromColumn = self._dragDropExtent.fromColumn < 0 ? 0 : self._dragDropExtent.fromColumn;
                        var toRow = self._dragDropExtent.toRow < 0 ? 0 : self._dragDropExtent.toRow;
                        var toColumn = self._dragDropExtent.toColumn < 0 ? 0 : self._dragDropExtent.toColumn;
                        var rowCount = self._dragDropExtent.fromRow < 0 ? self._sheet.getRowCount() : self._dragDropExtent.rowCount;
                        var columnCount = self._dragDropExtent.fromColumn < 0 ? self._sheet.getColumnCount() : self._dragDropExtent.columnCount;
                        if (!self._insert)
                        {
                            if (self._dragDropExtent.fromRow < 0)
                            {
                                var toColumnHeaderCellsInfo = new CopyMoveCellsInfo(self._sheet.getRowCount(1), columnCount);
                                var toColumnsInfo = new CopyMoveColumnsInfo(columnCount);
                                CopyMoveHelper.saveColumnHeaderInfo(self._sheet, toColumnHeaderCellsInfo, toColumnsInfo, toColumn, self._option);
                                self._savedToColumnHeaderCells = toColumnHeaderCellsInfo;
                                self._savedToColumns = toColumnsInfo;
                                if (!self._copy)
                                {
                                    var fromColumnHeaderCellsInfo = new CopyMoveCellsInfo(self._sheet.getRowCount(1), columnCount);
                                    var fromColumnsInfo = new CopyMoveColumnsInfo(columnCount);
                                    CopyMoveHelper.saveColumnHeaderInfo(self._sheet, fromColumnHeaderCellsInfo, fromColumnsInfo, fromColumn, self._option);
                                    self._savedFromColumnHeaderCells = fromColumnHeaderCellsInfo;
                                    self._savedFromColumns = fromColumnsInfo
                                }
                            }
                            if (self._dragDropExtent.fromColumn < 0)
                            {
                                var toRowHeaderCellsInfo = new CopyMoveCellsInfo(rowCount, self._sheet.getColumnCount(2));
                                var toRowsInfo = new CopyMoveRowsInfo(rowCount);
                                CopyMoveHelper.saveRowHeaderInfo(self._sheet, toRowHeaderCellsInfo, toRowsInfo, toRow, self._option);
                                self._savedToRowHeaderCells = toRowHeaderCellsInfo;
                                self._savedToRows = toRowsInfo;
                                if (!self._copy)
                                {
                                    var fromRowHeaderCellsInfo = new CopyMoveCellsInfo(rowCount, self._sheet.getColumnCount(2));
                                    var fromRowsInfo = new CopyMoveRowsInfo(rowCount);
                                    CopyMoveHelper.saveRowHeaderInfo(self._sheet, fromRowHeaderCellsInfo, fromRowsInfo, fromRow, self._option);
                                    self._savedFromRowHeaderCells = fromRowHeaderCellsInfo;
                                    self._savedFromRows = fromRowsInfo
                                }
                            }
                            var toViewportCellsInfo = new CopyMoveCellsInfo(rowCount, columnCount);
                            CopyMoveHelper.saveViewportInfo(self._sheet, toViewportCellsInfo, toRow, toColumn, self._option);
                            self._savedToViewportCells = toViewportCellsInfo;
                            var toTables = [];
                            CopyMoveHelper.saveTableInfo(self._sheet, toTables, new Sheets.Range(toRow, toColumn, rowCount, columnCount));
                            self._savedToTables = toTables;
                            if (!self._copy)
                            {
                                var fromViewportCellsInfo = new CopyMoveCellsInfo(rowCount, columnCount);
                                CopyMoveHelper.saveViewportInfo(self._sheet, fromViewportCellsInfo, fromRow, fromColumn, self._option);
                                self._savedFromViewportCells = fromViewportCellsInfo;
                                var fromTables = [];
                                CopyMoveHelper.saveTableInfo(self._sheet, fromTables, new Sheets.Range(fromRow, fromColumn, rowCount, columnCount));
                                self._savedFromTables = fromTables;
                                self._savedFromBeforePastedChangedCells = new ChangedCells(self._sheet, new Sheets.Range(fromRow, fromColumn, rowCount, columnCount), self._option)
                            }
                            self._savedToBeforePastedChangedCells = new ChangedCells(self._sheet, new Sheets.Range(toRow, toColumn, rowCount, columnCount), self._option)
                        }
                        else
                        {
                            if (self._dragDropExtent.fromColumn >= 0 && self._dragDropExtent.fromRow >= 0)
                            {}
                            else if (self._dragDropExtent.fromColumn >= 0)
                            {}
                            else if (self._dragDropExtent.fromRow >= 0)
                            {
                                if (self._copy)
                                {}
                                else
                                {
                                    if (self._sheet._hasTable(toRow, -1, 1, -1))
                                    {
                                        var fromRowHeaderCellsInfo = new CopyMoveCellsInfo(rowCount, self._sheet.getColumnCount(2));
                                        var fromRowsInfo = new CopyMoveRowsInfo(rowCount);
                                        CopyMoveHelper.saveRowHeaderInfo(self._sheet, fromRowHeaderCellsInfo, fromRowsInfo, fromRow, self._option);
                                        self._savedFromRowHeaderCells = fromRowHeaderCellsInfo;
                                        self._savedFromRows = fromRowsInfo;
                                        var fromViewportCellsInfo = new CopyMoveCellsInfo(rowCount, columnCount);
                                        CopyMoveHelper.saveViewportInfo(self._sheet, fromViewportCellsInfo, fromRow, fromColumn, self._option);
                                        self._savedFromViewportCells = fromViewportCellsInfo
                                    }
                                }
                            }
                            else
                            {}
                        }
                        self._savedAcitveRowViewportIndex = self._sheet.activeRowViewportIndex;
                        self._savedAcitveColumnViewportIndex = self._sheet.activeColViewportIndex;
                        self._savedActiveRow = self._sheet._activeRowIndex;
                        self._savedActiveColumn = self._sheet._activeColIndex
                    };
                    DragDropUndoAction.prototype.initSaveState = function()
                    {
                        var self = this;
                        self._savedFromColumnHeaderCells = keyword_null;
                        self._savedFromColumns = keyword_null;
                        self._savedFromViewportCells = keyword_null;
                        self._savedFromRowHeaderCells = keyword_null;
                        self._savedFromRows = keyword_null;
                        self._savedToColumnHeaderCells = keyword_null;
                        self._savedToColumns = keyword_null;
                        self._savedToViewportCells = keyword_null;
                        self._savedToRowHeaderCells = keyword_null;
                        self._savedToRows = keyword_null;
                        self._savedAcitveRowViewportIndex = -2;
                        self._savedAcitveColumnViewportIndex = -2;
                        self._savedActiveRow = -1;
                        self._savedActiveColumn = -1
                    };
                    DragDropUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (!sheet._isValidRange(self._dragDropExtent.fromRow, self._dragDropExtent.fromColumn, self._dragDropExtent.rowCount, self._dragDropExtent.columnCount, self._sheet.getRowCount(), self._sheet.getColumnCount()))
                        {
                            return false
                        }
                        if (!self._insert)
                        {
                            if (!sheet._isValidRange(self._dragDropExtent.toRow, self._dragDropExtent.toColumn, self._dragDropExtent.rowCount, self._dragDropExtent.columnCount, self._sheet.getRowCount(), self._sheet.getColumnCount()))
                            {
                                return false
                            }
                        }
                        var ret = false,
                            oldSelections,
                            newSelections,
                            count,
                            from,
                            to;
                        if (self._insert)
                        {
                            if (!(self._dragDropExtent.fromColumn >= 0 && self._dragDropExtent.fromRow >= 0))
                            {
                                if (self._dragDropExtent.fromColumn >= 0)
                                {
                                    var activeColumn = self._dragDropExtent.fromColumn;
                                    count = self._dragDropExtent.columnCount;
                                    self._suspendInvalidate(arg);
                                    var oldState = sheet.isPaintSuspended();
                                    sheet.isPaintSuspended(true);
                                    try
                                    {
                                        if (self._copy)
                                        {
                                            self._sheet.deleteColumns(self._dragDropExtent.toColumn, count)
                                        }
                                        else
                                        {
                                            from = self._dragDropExtent.toColumn;
                                            to = self._dragDropExtent.fromColumn;
                                            if (self._dragDropExtent.fromColumn < self._dragDropExtent.toColumn)
                                            {
                                                from = self._dragDropExtent.toColumn - count
                                            }
                                            else
                                            {
                                                to = self._dragDropExtent.fromColumn + count
                                            }
                                            self._sheet.addColumns(to, count);
                                            self._sheet.copyTo(-1, (to <= from ? from + count : from), -1, to, -1, count, self._option);
                                            self._sheet.deleteColumns((to <= from ? from + count : from), count);
                                            if (from < to)
                                            {
                                                activeColumn = to - count
                                            }
                                        }
                                        if (sheet)
                                        {
                                            oldSelections = sheet.getSelections();
                                            sheet._clearSelectionImp();
                                            sheet.addSelection(-1, activeColumn, sheet.getRowCount(), count);
                                            newSelections = sheet.getSelections();
                                            sheet.triggerSelectionChanging({
                                                sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                                            });
                                            sheet.triggerSelectionChanged({
                                                sheet: sheet, sheetName: sheet._name
                                            })
                                        }
                                    }
                                    finally
                                    {
                                        sheet.isPaintSuspended(oldState);
                                        var repained = self._resumeInvalidate(arg);
                                        if (!repained)
                                        {
                                            sheet.invalidateLayout();
                                            sheet.repaint()
                                        }
                                    }
                                    ret = true
                                }
                                else if (self._dragDropExtent.fromRow >= 0)
                                {
                                    count = self._dragDropExtent.rowCount;
                                    var activeRow = self._dragDropExtent.fromRow;
                                    self._suspendInvalidate(arg);
                                    var oldState = sheet.isPaintSuspended();
                                    sheet.isPaintSuspended(true);
                                    try
                                    {
                                        if (self._copy)
                                        {
                                            self._sheet.deleteRows(self._dragDropExtent.toRow, count)
                                        }
                                        else
                                        {
                                            from = self._dragDropExtent.toRow;
                                            to = self._dragDropExtent.fromRow;
                                            if (self._dragDropExtent.fromRow < self._dragDropExtent.toRow)
                                            {
                                                from = self._dragDropExtent.toRow - count
                                            }
                                            else
                                            {
                                                to = self._dragDropExtent.fromRow + count
                                            }
                                            self._sheet.addRows(to, count);
                                            if (self._savedFromViewportCells)
                                            {
                                                CopyMoveHelper.undoCellsInfo(self._sheet, self._savedFromViewportCells, to, 0, 3);
                                                ret = true
                                            }
                                            if (self._savedFromRowHeaderCells)
                                            {
                                                CopyMoveHelper.undoCellsInfo(self._sheet, self._savedFromRowHeaderCells, to, 0, 2);
                                                ret = true
                                            }
                                            if (self._savedFromRows)
                                            {
                                                CopyMoveHelper.undoRowsInfo(self._sheet, self._savedFromRows, to);
                                                ret = true
                                            }
                                            if (!ret)
                                            {
                                                self._sheet.copyTo((to <= from ? from + count : from), -1, to, -1, count, -1, self._option)
                                            }
                                            self._sheet.deleteRows((to <= from ? from + count : from), count);
                                            if (from < to)
                                            {
                                                activeRow = to - count
                                            }
                                        }
                                        if (sheet)
                                        {
                                            oldSelections = sheet.getSelections();
                                            sheet._clearSelectionImp();
                                            sheet.addSelection(activeRow, -1, count, sheet.getColumnCount());
                                            newSelections = sheet.getSelections();
                                            sheet.triggerSelectionChanging({
                                                sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                                            });
                                            sheet.triggerSelectionChanged({
                                                sheet: sheet, sheetName: sheet._name
                                            })
                                        }
                                    }
                                    finally
                                    {
                                        sheet.isPaintSuspended(oldState);
                                        var repained = self._resumeInvalidate(arg);
                                        if (!repained)
                                        {
                                            sheet.invalidateLayout();
                                            sheet.repaint()
                                        }
                                    }
                                    ret = true
                                }
                            }
                        }
                        else
                        {
                            var fromRow = self._dragDropExtent.fromRow < 0 ? 0 : self._dragDropExtent.fromRow;
                            var fromColumn = self._dragDropExtent.fromColumn < 0 ? 0 : self._dragDropExtent.fromColumn;
                            var toRow = self._dragDropExtent.toRow < 0 ? 0 : self._dragDropExtent.toRow;
                            var toColumn = self._dragDropExtent.toColumn < 0 ? 0 : self._dragDropExtent.toColumn;
                            var rowCount = self._dragDropExtent.fromRow < 0 ? self._sheet.getRowCount() : self._dragDropExtent.rowCount;
                            var columnCount = self._dragDropExtent.fromColumn < 0 ? self._sheet.getColumnCount() : self._dragDropExtent.columnCount;
                            CopyMoveHelper.clearFormula(sheet, toRow, toColumn, rowCount, columnCount);
                            var oldToValues = keyword_null;
                            var oldFromValues = keyword_null;
                            var savedFromViewportCells = self._savedFromViewportCells;
                            if (!self._copy && savedFromViewportCells && savedFromViewportCells.isValueOrFormulaSaved())
                            {
                                oldFromValues = CopyMoveHelper.getValues(self._sheet, fromRow, fromColumn, rowCount, columnCount)
                            }
                            var savedToViewportCells = self._savedToViewportCells;
                            if (savedToViewportCells && savedToViewportCells.isValueOrFormulaSaved())
                            {
                                oldToValues = CopyMoveHelper.getValues(self._sheet, toRow, toColumn, rowCount, columnCount)
                            }
                            self._suspendInvalidate(arg);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            try
                            {
                                if (self._savedToTables)
                                {
                                    CopyMoveHelper.undoTableInfo(self._sheet, self._savedToTables, new Sheets.Range(toRow, toColumn, rowCount, columnCount))
                                }
                                if (self._savedToColumnHeaderCells)
                                {
                                    CopyMoveHelper.undoCellsInfo(self._sheet, self._savedToColumnHeaderCells, 0, toColumn, 1);
                                    ret = true
                                }
                                if (self._savedToColumns)
                                {
                                    CopyMoveHelper.undoColumnsInfo(self._sheet, self._savedToColumns, toColumn);
                                    ret = true
                                }
                                if (savedToViewportCells)
                                {
                                    CopyMoveHelper.undoCellsInfo(self._sheet, savedToViewportCells, toRow, toColumn, 3);
                                    ret = true
                                }
                                if (self._savedToRowHeaderCells)
                                {
                                    CopyMoveHelper.undoCellsInfo(self._sheet, self._savedToRowHeaderCells, toRow, 0, 2);
                                    ret = true
                                }
                                if (self._savedToRows)
                                {
                                    CopyMoveHelper.undoRowsInfo(self._sheet, self._savedToRows, toRow);
                                    ret = true
                                }
                                if (self._savedFromTables)
                                {
                                    CopyMoveHelper.undoTableInfo(self._sheet, self._savedFromTables, new Sheets.Range(fromRow, fromColumn, rowCount, columnCount))
                                }
                                if (self._savedFromColumnHeaderCells)
                                {
                                    CopyMoveHelper.undoCellsInfo(self._sheet, self._savedFromColumnHeaderCells, 0, fromColumn, 1);
                                    ret = true
                                }
                                if (self._savedFromColumns)
                                {
                                    CopyMoveHelper.undoColumnsInfo(self._sheet, self._savedFromColumns, fromColumn);
                                    ret = true
                                }
                                if (savedFromViewportCells)
                                {
                                    CopyMoveHelper.undoCellsInfo(self._sheet, savedFromViewportCells, fromRow, fromColumn, 3);
                                    ret = true
                                }
                                if (self._savedFromRowHeaderCells)
                                {
                                    CopyMoveHelper.undoCellsInfo(self._sheet, self._savedFromRowHeaderCells, fromRow, 0, 2);
                                    ret = true
                                }
                                if (self._savedFromRows)
                                {
                                    CopyMoveHelper.undoRowsInfo(self._sheet, self._savedFromRows, fromRow);
                                    ret = true
                                }
                                if (ret && sheet)
                                {
                                    oldSelections = sheet.getSelections();
                                    sheet._clearSelectionImp();
                                    sheet.addSelection(self._dragDropExtent.fromRow, self._dragDropExtent.fromColumn, self._dragDropExtent.rowCount, self._dragDropExtent.columnCount);
                                    newSelections = sheet.getSelections();
                                    sheet.triggerSelectionChanging({
                                        sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                                    });
                                    sheet.triggerSelectionChanged({
                                        sheet: sheet, sheetName: sheet._name
                                    });
                                    if (oldToValues)
                                    {
                                        CopyMoveHelper.raiseRangeDataChanged(sheet, toRow, toColumn, rowCount, columnCount, self._savedToAfterPastedChangedCells.getChangedCells(), 0, oldToValues)
                                    }
                                    if (oldFromValues)
                                    {
                                        CopyMoveHelper.raiseRangeDataChanged(sheet, fromRow, fromColumn, rowCount, columnCount, self._savedFromAfterPastedChangedCells.getChangedCells(), 0, oldFromValues)
                                    }
                                }
                            }
                            finally
                            {
                                sheet.isPaintSuspended(oldState);
                                self._resumeInvalidate(arg)
                            }
                        }
                        if (ret && sheet)
                        {
                            if (self._savedActiveRow !== -1 && self._savedActiveColumn !== -1)
                            {
                                var selection = sheet.getSelections()[0];
                                if (selection.contains(self._savedActiveRow, self._savedActiveColumn))
                                {
                                    sheet._setActiveCellImp(self._savedActiveRow, self._savedActiveColumn)
                                }
                                else
                                {
                                    sheet._setActiveCellImp(Math_max(sheet._getFirstVisualRow(), selection.row), Math_max(sheet._getFirstVisualColumn(), selection.col))
                                }
                            }
                            if (self._savedAcitveRowViewportIndex !== -2 && self._savedAcitveColumnViewportIndex !== -2 && self._savedActiveRow !== -1 && self._savedActiveColumn !== -1)
                            {
                                sheet.showCell(self._savedActiveRow, self._savedActiveColumn, 3, 3)
                            }
                            sheet.invalidateLayout();
                            sheet.repaint()
                        }
                        return ret
                    };
                    return DragDropUndoAction
                })(ActionBase);
            UndoRedo.DragDropUndoAction = DragDropUndoAction;
            var CellEditUndoAction = (function(_super)
                {
                    __extends(CellEditUndoAction, _super);
                    function CellEditUndoAction(sheet, cellEditInfo)
                    {
                        _super.call(this);
                        this._oldValueCatch = {};
                        this._oldValueIsFormulaCatch = {};
                        this._eventNS = ".cellEditaction";
                        this._sheet = sheet;
                        this._cellEditInfo = cellEditInfo;
                        this._canUndo = false;
                        if (cellEditInfo.ranges && cellEditInfo.endEditType === 1)
                        {
                            var range = cellEditInfo.ranges[0];
                            if (range.row === -1)
                            {
                                range.row = 0;
                                range.rowCount = sheet.getRowCount()
                            }
                            if (range.col === -1)
                            {
                                range.col = 0;
                                range.colCount = sheet.getColumnCount()
                            }
                            if (range.rowCount === 1 && range.colCount === 1)
                            {
                                var exFormulas = sheet._getsArrayFormulas(range.row, range.col, 1, 1);
                                if (exFormulas && exFormulas.ranges && exFormulas.ranges.length > 0)
                                {
                                    cellEditInfo.ranges = [exFormulas.ranges[0]]
                                }
                            }
                        }
                    }
                    CellEditUndoAction.prototype.canExecute = function(arg)
                    {
                        var self = this;
                        if (self._cellEditInfo.ranges)
                        {
                            for (var i = 0; i < self._cellEditInfo.ranges.length; i++)
                            {
                                var range = self._cellEditInfo.ranges[i];
                                if (self._sheet.isProtected && self._sheet._isAnyCellInRangeLocked(range))
                                {
                                    return false
                                }
                                if (!self._sheet._checkArrayFormula(range.row, range.col, range.rowCount, range.colCount))
                                {
                                    return false
                                }
                            }
                        }
                        else if (!self._sheet._checkArrayFormula(self._cellEditInfo.row, self._cellEditInfo.col, 1, 1) || self._sheet.isProtected && self._sheet._isAnyCellInRangeLocked(new Sheets.Range(self._cellEditInfo.row, self._cellEditInfo.col, 1, 1)))
                        {
                            return false
                        }
                        return true
                    };
                    CellEditUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        self.iteration(function(row, col)
                        {
                            var formulaInfo = self._sheet.getFormulaInformation(row, col);
                            var position = self._positionToString(row, col);
                            if (formulaInfo.hasFormula)
                            {
                                if (!formulaInfo.isArrayFormula || formulaInfo.baseRange.row === row && formulaInfo.baseRange.col === col)
                                {
                                    self._oldValueCatch[position] = formulaInfo.formula;
                                    self._oldValueIsFormulaCatch[position] = formulaInfo
                                }
                                else
                                {
                                    self._oldValueIsFormulaCatch[position] = false
                                }
                            }
                            else
                            {
                                self._oldValueCatch[position] = self._sheet.getValue(self._cellEditInfo.row, self._cellEditInfo.col)
                            }
                        })
                    };
                    CellEditUndoAction.prototype.iteration = function(func)
                    {
                        var self = this;
                        if (self._cellEditInfo.ranges)
                        {
                            for (var rangeIndex = 0; rangeIndex < self._cellEditInfo.ranges.length; rangeIndex++)
                            {
                                var range = self._cellEditInfo.ranges[rangeIndex];
                                for (var row = range.row; row < range.row + range.rowCount; row++)
                                {
                                    for (var col = range.col; col < range.col + range.colCount; col++)
                                    {
                                        func(row, col)
                                    }
                                }
                            }
                        }
                        else
                        {
                            func(self._cellEditInfo.row, self._cellEditInfo.col)
                        }
                    };
                    CellEditUndoAction.prototype.saveCellState = function(row, col){};
                    CellEditUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        var row = self._cellEditInfo.row;
                        var col = self._cellEditInfo.col;
                        var oldState = sheet._paintSuspended;
                        try
                        {
                            sheet._paintSuspended = true;
                            sheet._bind(Sheets.Events.CellChanged + self._eventNS, function(event, data)
                            {
                                if (data.propertyName === "value")
                                {
                                    sheet.triggerValueChanged({
                                        sheet: data.sheet, sheetName: data.sheetName, row: data.row, col: data.col, oldValue: data._oldValue, newValue: data.sheet.getValue(data.row, data.col)
                                    })
                                }
                            });
                            self.iteration(function(r, c)
                            {
                                var position = self._positionToString(r, c);
                                var formulaInfo = self._oldValueIsFormulaCatch[position];
                                if (formulaInfo === false)
                                {
                                    return
                                }
                                else if (formulaInfo)
                                {
                                    if (formulaInfo.isArrayFormula)
                                    {
                                        sheet.setArrayFormula(r, c, formulaInfo.baseRange.rowCount, formulaInfo.baseRange.colCount, formulaInfo.formula)
                                    }
                                    else
                                    {
                                        sheet.setFormula(r, c, self._oldValueCatch[position])
                                    }
                                }
                                else
                                {
                                    var formula = sheet.getFormula(r, c);
                                    if (!(formula === keyword_null || formula === ""))
                                    {
                                        sheet.setFormula(r, c, keyword_null)
                                    }
                                    sheet.setValue(r, c, self._oldValueCatch[position])
                                }
                            })
                        }
                        catch(ex)
                        {
                            return false
                        }
                        finally
                        {
                            sheet._unbind(Sheets.Events.CellChanged + self._eventNS);
                            sheet._paintSuspended = oldState
                        }
                        var layout = sheet._getSheetLayout(),
                            rect = new Sheets.Rect(layout.frozenX, layout.frozenY, layout.width - layout.frozenX, layout.height - layout.frozenY);
                        sheet.repaint(rect);
                        return true
                    };
                    CellEditUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        self.saveState();
                        var sheet = self._sheet;
                        var oldState = sheet._paintSuspended;
                        try
                        {
                            sheet._paintSuspended = true;
                            sheet._bind(Sheets.Events.CellChanged + self._eventNS, function(event, data)
                            {
                                if (data.propertyName === "value")
                                {
                                    sheet.triggerValueChanged({
                                        sheet: data.sheet, sheetName: data.sheetName, row: data.row, col: data.col, oldValue: data._oldValue, newValue: data.sheet.getValue(data.row, data.col)
                                    })
                                }
                            });
                            self.applyResult = self._applyEditing(arg)
                        }
                        finally
                        {
                            self._sheet._unbind(Sheets.Events.CellChanged + self._eventNS);
                            sheet._paintSuspended = oldState
                        }
                        var layout = sheet._getSheetLayout(),
                            rect = new Sheets.Rect(layout.frozenX, layout.frozenY, layout.width - layout.frozenX, layout.height - layout.frozenY);
                        sheet.repaint(rect);
                        self._canUndo = self.applyResult === 0
                    };
                    CellEditUndoAction.prototype._positionToString = function(row, col)
                    {
                        return row + "_" + col
                    };
                    CellEditUndoAction.prototype._stringToPosition = function(position)
                    {
                        var indexs = position.split("_");
                        return {
                                row: parseInt(indexs[0], 10), col: parseInt(indexs[1], 10)
                            }
                    };
                    CellEditUndoAction.prototype._validateEditingValue = function()
                    {
                        var self = this;
                        var action = 0;
                        var row = self._cellEditInfo.row;
                        var col = self._cellEditInfo.col;
                        var sheet = self._sheet;
                        var text = self._cellEditInfo.newValue;
                        var autoFormat = self._cellEditInfo.hasOwnProperty("autoFormat") ? self._cellEditInfo.autoFormat : true;
                        if (text && text.length > 0 && text[0] === "=")
                        {
                            if (sheet.getDataValidator(row, col))
                            {
                                var newFormula = text.substring(1);
                                if (newFormula !== '' && newFormula !== sheet.getFormula(row, col))
                                {
                                    var svc = sheet.getCalcService();
                                    if (svc)
                                    {
                                        var expr = svc.parse(sheet._getSheetSource(), newFormula, row >= 0 ? row : 0, col >= 0 ? col : 0);
                                        if (expr)
                                        {
                                            var calc = svc.evaluateParsedFormula(sheet._getSheetSource(), expr, row, col);
                                            if (!sheet.isValid(row, col, calc))
                                            {
                                                action = sheet._validationError(row, col, calc)
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            var value = self._getValueFromEditing(row, col, text, autoFormat);
                            var valid = sheet.isValid(row, col, value);
                            if (!valid)
                            {
                                action = sheet._validationError(row, col, text);
                                sheet._eventHandler._forceCancelSelectiong = true
                            }
                        }
                        return action
                    };
                    CellEditUndoAction.prototype._applyEditing = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        var text = self._cellEditInfo.newValue;
                        var action = self._validateEditingValue();
                        if (action === 1 || action === 2)
                        {
                            return action
                        }
                        var value;
                        var autoFormat = self._cellEditInfo.hasOwnProperty("autoFormat") ? self._cellEditInfo.autoFormat : true;
                        if (Sheets.util.hasCalc())
                        {
                            var canUserEditFormula = sheet.parent ? sheet.parent.canUserEditFormula() : true;
                            var baseRow = self._cellEditInfo.row;
                            baseRow = baseRow >= 0 ? baseRow : 0;
                            var baseCol = self._cellEditInfo.col;
                            baseCol = baseCol >= 0 ? baseCol : 0;
                            var oldOption = GcSpread.Sheets.Calc.Parser.getParserOption();
                            var option = {
                                    numberDecimalSeparator: GcSpread.Sheets.CR.numberDecimalSeparator, arrayGroupSeparator: GcSpread.Sheets.CR.arrayGroupSeparator, listSeparator: GcSpread.Sheets.CR.listSeparator
                                };
                            GcSpread.Sheets.Calc.Parser.setParserOption(option);
                            var svc = sheet.getCalcService();
                            var expr;
                            if (canUserEditFormula && svc && text && text.length > 0 && text[0] === "=")
                            {
                                try
                                {
                                    if (self._cellEditInfo.ranges && self._cellEditInfo.endEditType === 1)
                                    {
                                        var range = self._cellEditInfo.ranges[0];
                                        sheet.setArrayFormula(range.row, range.col, range.rowCount, range.colCount, text.substring(1));
                                        GcSpread.Sheets.Calc.Parser.setParserOption(oldOption);
                                        return action
                                    }
                                    else
                                    {
                                        expr = svc.parse(sheet._getSheetSource(), text.substring(1), baseRow, baseCol)
                                    }
                                }
                                catch(e)
                                {
                                    sheet._raiseInvalidOperation(0, typeof(e) === "string" ? e : e.message);
                                    throw e;
                                }
                            }
                            else if (self._cellEditInfo.ranges && self._cellEditInfo.endEditType === 1)
                            {
                                var range = self._cellEditInfo.ranges[0];
                                sheet.clear(range.row, range.col, range.rowCount, range.colCount, 3, 1)
                            }
                        }
                        if (!expr)
                        {
                            var needFix = false;
                            if ((/^('=)/ig).test(text))
                            {
                                text = text.substring(1);
                                needFix = true
                            }
                            if (value === keyword_undefined || value === keyword_null || needFix)
                            {
                                value = self._getValueFromEditing(baseRow, baseCol, text, autoFormat)
                            }
                        }
                        self.iteration(function(row, col)
                        {
                            if (expr)
                            {
                                try
                                {
                                    if (row == baseRow && col == baseCol)
                                    {
                                        sheet.setFormula(row, col, text.substring(1))
                                    }
                                    else
                                    {
                                        sheet.setFormula(row, col, svc.unparseWithoutCulture(sheet._getSheetSource(), expr, row, col))
                                    }
                                    sheet.triggerUserFormulaEntered({
                                        sheet: sheet, sheetName: sheet._name, row: row, col: col, formula: text.substring(1).toUpperCase()
                                    })
                                }
                                catch(e)
                                {
                                    sheet._raiseInvalidOperation(0, typeof(e) === "string" ? e : e.message);
                                    throw e;
                                }
                            }
                            else
                            {
                                try
                                {
                                    if (sheet.hasFormula(row, col))
                                    {
                                        sheet.setFormula(row, col, keyword_null)
                                    }
                                }
                                catch(e)
                                {
                                    sheet._raiseInvalidOperation(0, typeof(e) === "string" ? e : e.message);
                                    throw e;
                                }
                                try
                                {
                                    sheet._setValueInternal(row, col, value)
                                }
                                catch(ex)
                                {
                                    sheet.setValue(row, col, text)
                                }
                            }
                        });
                        if (Sheets.util.hasCalc())
                        {
                            GcSpread.Sheets.Calc.Parser.setParserOption(oldOption)
                        }
                        return action
                    };
                    CellEditUndoAction.prototype.canUndo = function()
                    {
                        return this._canUndo
                    };
                    CellEditUndoAction.prototype._getValueFromEditing = function(row, col, text, autoFormat)
                    {
                        if (!Sheets.features.formatter)
                        {
                            return text
                        }
                        var self = this;
                        var style = self._sheet.getActualStyle(row, col);
                        var styleRef = {};
                        var value = Sheets.util.parseText2Value(style, text, autoFormat, styleRef);
                        var autoDisplayFormatter = styleRef.value;
                        if (autoFormat && styleRef.value)
                        {
                            var af = keyword_null;
                            if (autoFormat && autoDisplayFormatter && (value !== keyword_null && autoDisplayFormatter.FormatString() !== "General" || !style._autoFormatter))
                            {
                                af = new Sheets.AutoFormatter(autoDisplayFormatter)
                            }
                            if (af)
                            {
                                var storedStyle = self._sheet.getStyleObject(row, col),
                                    isNamedStyle = (typeof(storedStyle) === 'string');
                                if (!storedStyle || isNamedStyle)
                                {
                                    var newStyle = new Sheets.Style;
                                    if (isNamedStyle)
                                    {
                                        newStyle.parentName = storedStyle
                                    }
                                    storedStyle = newStyle
                                }
                                storedStyle._autoFormatter = af;
                                self._sheet.setStyle(row, col, storedStyle)
                            }
                        }
                        return value
                    };
                    return CellEditUndoAction
                })(ActionBase);
            UndoRedo.CellEditUndoAction = CellEditUndoAction;
            var SheetRenameUndoAction = (function(_super)
                {
                    __extends(SheetRenameUndoAction, _super);
                    function SheetRenameUndoAction(sheet, newName)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        this._newName = newName;
                        this._oldName = keyword_null
                    }
                    SheetRenameUndoAction.prototype.canUndo = function()
                    {
                        return !!this._oldName
                    };
                    SheetRenameUndoAction.prototype.canExecute = function(arg)
                    {
                        var self = this;
                        return self._sheet && self._newName && self._newName !== self._oldName
                    };
                    SheetRenameUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (sheet && self._newName && self._newName !== self._oldName)
                        {
                            self.saveState();
                            self._suspendInvalidate(arg);
                            sheet.setNameCore(self._newName);
                            self._resumeInvalidate(arg);
                            sheet._refreshTabStrip()
                        }
                    };
                    SheetRenameUndoAction.prototype.saveState = function()
                    {
                        if (this._sheet)
                        {
                            this._oldName = this._sheet._name
                        }
                    };
                    SheetRenameUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (sheet)
                        {
                            self._suspendInvalidate(arg);
                            sheet.setNameCore(self._oldName);
                            self._resumeInvalidate(arg);
                            sheet._refreshTabStrip();
                            return true
                        }
                        return false
                    };
                    return SheetRenameUndoAction
                })(ActionBase);
            UndoRedo.SheetRenameUndoAction = SheetRenameUndoAction;
            var ZoomUndoAction = (function(_super)
                {
                    __extends(ZoomUndoAction, _super);
                    function ZoomUndoAction(sheet, newZoomFactor)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        if (newZoomFactor < 0.25)
                        {
                            newZoomFactor = 0.25
                        }
                        else if (newZoomFactor > 4)
                        {
                            newZoomFactor = 4
                        }
                        this._zoomFactor = newZoomFactor;
                        this._prevZoomFactor = -1
                    }
                    ZoomUndoAction.prototype.canExecute = function(arg)
                    {
                        var self = this;
                        return self._sheet && self._sheet.parent._allowUserZoom && self._sheet._zoomFactor !== self._zoomFactor
                    };
                    ZoomUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        self.saveState();
                        if (sheet && (!sheet.parent || sheet.parent._allowUserZoom === true) && sheet._zoomFactor !== self._zoomFactor)
                        {
                            if (sheet.isEditing() === true)
                            {
                                sheet.endEdit()
                            }
                            self._suspendInvalidate(arg);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.zoom(self._zoomFactor);
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                    };
                    ZoomUndoAction.prototype.canUndo = function()
                    {
                        return this._sheet && this._prevZoomFactor > 0
                    };
                    ZoomUndoAction.prototype.saveState = function()
                    {
                        if (this._sheet)
                        {
                            this._prevZoomFactor = this._sheet._zoomFactor
                        }
                    };
                    ZoomUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (sheet)
                        {
                            self._suspendInvalidate(arg);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.zoom(self._prevZoomFactor);
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                            return true
                        }
                        return false
                    };
                    return ZoomUndoAction
                })(ActionBase);
            UndoRedo.ZoomUndoAction = ZoomUndoAction;
            var CellValueEntry = (function()
                {
                    function CellValueEntry(value, formulaInfo)
                    {
                        this.value = value;
                        this.formulaInfo = formulaInfo
                    }
                    return CellValueEntry
                })();
            var ClearRangeValueUndoAction = (function(_super)
                {
                    __extends(ClearRangeValueUndoAction, _super);
                    function ClearRangeValueUndoAction(sheet, clearRange)
                    {
                        _super.call(this);
                        this._cachedFormulaInfos = [];
                        this._eventNS = ".clearRangeAction";
                        var self = this;
                        self._sheet = sheet;
                        self._clearRange = clearRange;
                        self._cachedFilteredColumns = keyword_null;
                        self._cachedValues = keyword_null;
                        self._cachedTables = keyword_null
                    }
                    ClearRangeValueUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        self.saveState();
                        var sheet = self._sheet;
                        if (sheet)
                        {
                            var range = sheet._getActualRange(self._clearRange);
                            if (range.colCount > 0 && range.rowCount > 0)
                            {
                                try
                                {
                                    sheet._bind(Sheets.Events.CellChanged + self._eventNS, function(event, data)
                                    {
                                        if (data.propertyName === "value")
                                        {
                                            sheet.triggerValueChanged({
                                                sheet: data.sheet, sheetName: data.sheetName, row: data.row, col: data.col
                                            })
                                        }
                                    });
                                    var oldState = sheet.isPaintSuspended();
                                    sheet.isPaintSuspended(true);
                                    sheet.suspendEvent();
                                    sheet.clear(range.row, range.col, range.rowCount, range.colCount, 3, 1);
                                    sheet.resumeEvent();
                                    sheet.isPaintSuspended(oldState);
                                    CopyMoveHelper.raiseRangeDataChanged(sheet, range.row, range.col, range.rowCount, range.colCount, self._changedCells.getChangedCells(), 2)
                                }
                                finally
                                {
                                    self._sheet._unbind(Sheets.Events.CellChanged + self._eventNS)
                                }
                            }
                        }
                    };
                    ClearRangeValueUndoAction.prototype.canExecute = function(arg)
                    {
                        var sheet = this._sheet;
                        var range = this._clearRange;
                        return !(sheet.isProtected === true && sheet._isAnyCellInRangeLocked(range)) && sheet._checkArrayFormula(range.row, range.col, range.rowCount, range.colCount)
                    };
                    ClearRangeValueUndoAction.prototype.canUndo = function()
                    {
                        return !!this._cachedValues
                    };
                    ClearRangeValueUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (sheet)
                        {
                            self._cachedTables = [];
                            var tables = sheet.getTables();
                            if (tables && tables.length > 0)
                            {
                                for (var i = 0; i < tables.length; i++)
                                {
                                    var tb = tables[i];
                                    if (self._clearRange.containsRange(tb.range()))
                                    {
                                        self._cachedTables.push(tb)
                                    }
                                }
                            }
                            self._cachedFilteredColumns = [];
                            var rowFilter = sheet.rowFilter(),
                                row,
                                column;
                            if (rowFilter && rowFilter.range && rowFilter.isFiltered())
                            {
                                row = rowFilter.range.row;
                                var rowCount = rowFilter.range.rowCount;
                                if (rowFilter.filterButtonVisible && rowFilter.filterButtonVisible())
                                {
                                    row = rowFilter.range.row - 1;
                                    rowCount = rowFilter.range.rowCount + 1;
                                    if (row < 0)
                                    {
                                        row = -1;
                                        rowCount = -1
                                    }
                                }
                                if ((self._clearRange.row === -1 || (self._clearRange.row <= row && row + rowCount <= self._clearRange.row + self._clearRange.rowCount)) && (self._clearRange.col === -1 || (self._clearRange.col <= rowFilter.range.col && rowFilter.range.col + rowFilter.range.colCount <= self._clearRange.col + self._clearRange.colCount)))
                                {
                                    column = rowFilter.range.col < 0 ? 0 : rowFilter.range.col;
                                    var columnCount = rowFilter.range.colCount < 0 ? sheet.getColumnCount() : rowFilter.range.colCount;
                                    for (var c = 0; c < columnCount; c++)
                                    {
                                        if (rowFilter.isColumnFiltered(column + c))
                                        {
                                            self._cachedFilteredColumns.push(column + c)
                                        }
                                    }
                                }
                            }
                            var range = sheet._getActualRange(self._clearRange);
                            if (range.colCount > 0 && range.rowCount > 0)
                            {
                                self._cachedValues = [range.row + range.rowCount];
                                for (var i = 0; i < range.rowCount; i++)
                                {
                                    self._cachedValues[range.row + i] = [range.col + range.colCount];
                                    self._cachedFormulaInfos[range.row + i] = [];
                                    for (var j = 0; j < range.colCount; j++)
                                    {
                                        row = range.row + i;
                                        column = range.col + j;
                                        var formulaInfo = sheet.getFormulaInformation(row, column);
                                        if (formulaInfo.hasFormula)
                                        {
                                            if (!formulaInfo.isArrayFormula || formulaInfo.baseRange.row === row && formulaInfo.baseRange.col === column)
                                            {
                                                self._cachedValues[row][column] = new CellValueEntry(formulaInfo.formula, formulaInfo)
                                            }
                                            else
                                            {
                                                self._cachedValues[row][column] = -1
                                            }
                                        }
                                        else
                                        {
                                            var value = sheet.getValue(row, column);
                                            if (value !== keyword_undefined && value !== keyword_null)
                                            {
                                                self._cachedValues[row][column] = new CellValueEntry(value, keyword_undefined)
                                            }
                                        }
                                    }
                                }
                            }
                            self._changedCells = new ChangedCells(sheet, sheet._getActualRange(self._clearRange), 1 | 2)
                        }
                    };
                    ClearRangeValueUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        if (sheet)
                        {
                            var ret = false,
                                i;
                            if (self._cachedTables && self._cachedTables.length > 0)
                            {
                                var tables = self._cachedTables,
                                    count = tables.length;
                                for (i = 0; i < count; i++)
                                {
                                    sheet._addTableInternal(tables[i])
                                }
                            }
                            var range = sheet._getActualRange(self._clearRange);
                            if (self._cachedValues && range.colCount > 0 && range.rowCount > 0)
                            {
                                try
                                {
                                    sheet._bind(Sheets.Events.CellChanged + self._eventNS, function(event, data)
                                    {
                                        if (data.propertyName === "value")
                                        {
                                            sheet.triggerValueChanged({
                                                sheet: data.sheet, sheetName: data.sheetName, row: data.row, col: data.col
                                            })
                                        }
                                    });
                                    var rc = range.rowCount;
                                    var cc = range.colCount;
                                    var oldAutoRefresh = sheet.isPaintSuspended();
                                    sheet.isPaintSuspended(true);
                                    sheet.suspendEvent();
                                    for (i = 0; i < rc; i++)
                                    {
                                        for (var j = 0; j < cc; j++)
                                        {
                                            var row = range.row + i;
                                            var column = range.col + j;
                                            var entry = self._cachedValues[row][column];
                                            if (entry === -1)
                                            {
                                                continue
                                            }
                                            else if (entry)
                                            {
                                                if (entry.formulaInfo)
                                                {
                                                    var formulaInfo = entry.formulaInfo;
                                                    if (formulaInfo && formulaInfo.isArrayFormula)
                                                    {
                                                        sheet.setArrayFormula(row, column, formulaInfo.baseRange.rowCount, formulaInfo.baseRange.colCount, formulaInfo.formula)
                                                    }
                                                    else
                                                    {
                                                        sheet.setFormula(row, column, entry.value)
                                                    }
                                                }
                                                else
                                                {
                                                    sheet.setFormula(row, column, keyword_null);
                                                    sheet.setValue(row, column, entry.value)
                                                }
                                            }
                                            else
                                            {
                                                sheet.setFormula(row, column, keyword_null);
                                                sheet.setValue(row, column, keyword_null)
                                            }
                                        }
                                    }
                                    sheet.resumeEvent();
                                    sheet.isPaintSuspended(oldAutoRefresh);
                                    CopyMoveHelper.raiseRangeDataChanged(sheet, range.row, range.col, range.rowCount, range.colCount, self._changedCells.getChangedCells(), 2);
                                    ret = true
                                }
                                finally
                                {
                                    sheet._unbind(Sheets.Events.CellChanged + self._eventNS)
                                }
                            }
                            var filter = sheet.rowFilter();
                            if (filter && self._cachedFilteredColumns && self._cachedFilteredColumns.length > 0)
                            {
                                for (i = 0; i < self._cachedFilteredColumns.length; i++)
                                {
                                    var col = self._cachedFilteredColumns[i];
                                    filter.filter(col)
                                }
                            }
                            if (ret)
                            {
                                sheet.repaint();
                                return true
                            }
                        }
                        return false
                    };
                    return ClearRangeValueUndoAction
                })(ActionBase);
            UndoRedo.ClearRangeValueUndoAction = ClearRangeValueUndoAction;
            var ClearValueUndoAction = (function(_super)
                {
                    __extends(ClearValueUndoAction, _super);
                    function ClearValueUndoAction(sheet, ranges)
                    {
                        _super.call(this);
                        this._cachedActions = [];
                        var self = this;
                        self._sheet = sheet;
                        self._cachedActions = keyword_null;
                        if (ranges && ranges.length > 0)
                        {
                            self._cachedActions = new Array;
                            for (var i = 0; i < ranges.length; i++)
                            {
                                self._cachedActions[i] = new ClearRangeValueUndoAction(sheet, ranges[i])
                            }
                        }
                    }
                    ClearValueUndoAction.prototype.canExecute = function(arg)
                    {
                        if (this._cachedActions)
                        {
                            for (var i = 0; i < this._cachedActions.length; i++)
                            {
                                var item = this._cachedActions[i];
                                if (!item.canExecute(arg))
                                {
                                    return false
                                }
                            }
                            return true
                        }
                        return false
                    };
                    ClearValueUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        self.saveState();
                        if (self._cachedActions)
                        {
                            self._suspendInvalidate(arg);
                            for (var i = 0; i < self._cachedActions.length; i++)
                            {
                                var item = self._cachedActions[i];
                                item.execute(arg)
                            }
                            var repained = self._resumeInvalidate(arg);
                            if (!repained)
                            {
                                self._sheet.invalidateLayout();
                                self._sheet.repaint()
                            }
                        }
                    };
                    ClearValueUndoAction.prototype.canUndo = function()
                    {
                        if (this._cachedActions)
                        {
                            for (var i = 0; i < this._cachedActions.length; i++)
                            {
                                var item = this._cachedActions[i];
                                if (!item.canUndo())
                                {
                                    return false
                                }
                            }
                            return true
                        }
                        return false
                    };
                    ClearValueUndoAction.prototype.saveState = function()
                    {
                        if (this._cachedActions)
                        {
                            for (var i = 0; i < this._cachedActions.length; i++)
                            {
                                var item = this._cachedActions[i];
                                item.saveState()
                            }
                        }
                    };
                    ClearValueUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        if (self._cachedActions)
                        {
                            for (var i = self._cachedActions.length - 1; i >= 0; i--)
                            {
                                var action = self._cachedActions[i];
                                self._suspendInvalidate(arg);
                                var ret = action.undo(arg);
                                var repained = self._resumeInvalidate(arg);
                                if (!ret)
                                {
                                    return false
                                }
                                else
                                {
                                    if (!repained)
                                    {
                                        self._sheet.invalidateLayout();
                                        self._sheet.repaint()
                                    }
                                }
                            }
                            return true
                        }
                        return false
                    };
                    return ClearValueUndoAction
                })(ActionBase);
            UndoRedo.ClearValueUndoAction = ClearValueUndoAction;
            var DragFillExtent = (function()
                {
                    function DragFillExtent(startRange, fillRange, autoFillType, fillDirection)
                    {
                        this.startRange = startRange;
                        this.fillRange = fillRange;
                        this.autoFillType = autoFillType;
                        this.fillDirection = fillDirection
                    }
                    return DragFillExtent
                })();
            UndoRedo.DragFillExtent = DragFillExtent;
            var DragFillUndoAction = (function(_super)
                {
                    __extends(DragFillUndoAction, _super);
                    function DragFillUndoAction(sheet, dragFillExtent)
                    {
                        _super.call(this);
                        var self = this;
                        self._workSheet = sheet;
                        self._dragFillExtent = dragFillExtent;
                        if (self._dragFillExtent.autoFillType === 4)
                        {
                            self._clearValueUndoAction = new ClearValueUndoAction(sheet, [self._dragFillExtent.fillRange])
                        }
                        else
                        {
                            self.initWholeFilledRange()
                        }
                        if (self._dragFillExtent.fillDirection === 0 || self._dragFillExtent.fillDirection === 1)
                        {
                            self._fillSeries = 1
                        }
                        else
                        {
                            self._fillSeries = 0
                        }
                    }
                    DragFillUndoAction.prototype.canExecute = function(arg)
                    {
                        var self = this;
                        var sheet = self._workSheet;
                        var dragExtent = self._dragFillExtent;
                        if (sheet.isProtected && sheet._isAnyCellInRangeLocked(dragExtent.fillRange))
                        {
                            return false
                        }
                        if (!sheet._checkArrayFormula(dragExtent.fillRange.row, dragExtent.fillRange.col, dragExtent.fillRange.rowCount, dragExtent.fillRange.colCount))
                        {
                            return false
                        }
                        if (this._dragFillExtent.autoFillType === 4)
                        {
                            return this.canExecuteDragClear()
                        }
                        else
                        {
                            return this.canExecuteDragFill()
                        }
                    };
                    DragFillUndoAction.prototype.canExecuteDragClear = function()
                    {
                        return true
                    };
                    DragFillUndoAction.prototype.canExecuteDragFill = function()
                    {
                        var startRange = this._dragFillExtent.startRange;
                        var fillRange = this._dragFillExtent.fillRange;
                        return !fillRange.intersect(startRange.row, startRange.col, startRange.rowCount, startRange.colCount)
                    };
                    DragFillUndoAction.prototype.execute = function(arg)
                    {
                        var self = this;
                        if (self.canExecute(arg))
                        {
                            var sheet = self._workSheet;
                            var oldSelections = sheet.getSelections();
                            var repained = false;
                            try
                            {
                                self._suspendInvalidate(sheet);
                                sheet.suspendCalcService();
                                sheet.suspendEvent();
                                self.saveState();
                                var oldState = sheet.isPaintSuspended();
                                sheet.isPaintSuspended(true);
                                if (self._dragFillExtent.autoFillType === 4)
                                {
                                    self.executeDragFillClear(sheet)
                                }
                                else
                                {
                                    self.executeDragFill(sheet)
                                }
                            }
                            finally
                            {
                                sheet.isPaintSuspended(oldState);
                                sheet.resumeCalcService();
                                sheet.resumeEvent();
                                var fillRange = self._dragFillExtent.fillRange;
                                self._savedAfterFilledChangedCells = new ChangedCells(self._workSheet, fillRange, 1023);
                                self._savedAfterFilledChangedCells.mergeCellsHasDiffData(self._savedBeforeFillChangedCells.getCellsHasData());
                                CopyMoveHelper.raiseRangeDataChanged(sheet, fillRange.row, fillRange.col, fillRange.rowCount, fillRange.colCount, self._savedAfterFilledChangedCells.getChangedCells(), 1, self._savedFilledViewportCells.getValues());
                                var newSelections = sheet.getSelections();
                                if (sheet._raiseSelectionChanging(oldSelections, newSelections))
                                {
                                    sheet._raiseSelectionChanged()
                                }
                                repained = self._resumeInvalidate(sheet)
                            }
                            if (!repained)
                            {
                                sheet.invalidateLayout();
                                sheet.repaint()
                            }
                        }
                    };
                    DragFillUndoAction.prototype.executeDragFillClear = function(sheetView)
                    {
                        var self = this;
                        self._clearValueUndoAction.execute(sheetView);
                        var startRange = self._dragFillExtent.startRange;
                        var clearRange = self._dragFillExtent.fillRange;
                        if (!startRange.equals(clearRange))
                        {
                            var newRange;
                            if (self._fillSeries === 0)
                            {
                                newRange = new Sheets.Range(startRange.row, startRange.col, Math_max(1, startRange.rowCount - clearRange.rowCount), startRange.colCount);
                                sheetView._setActiveCellImp(Math_max(sheetView._getFirstVisualRow(), newRange.row), Math_max(sheetView._getFirstVisualColumn(), newRange.col), sheetView.activeRowViewportIndex, sheetView.activeColViewportIndex);
                                sheetView._clearSelectionImp();
                                sheetView.addSelection(newRange.row, newRange.col, newRange.rowCount, newRange.colCount)
                            }
                            else
                            {
                                newRange = new Sheets.Range(startRange.row, startRange.col, startRange.rowCount, Math_max(1, startRange.colCount - clearRange.colCount));
                                sheetView._setActiveCellImp(Math_max(sheetView._getFirstVisualRow(), newRange.row), Math_max(sheetView._getFirstVisualColumn(), newRange.col), sheetView.activeRowViewportIndex, sheetView.activeColViewportIndex);
                                sheetView._clearSelectionImp();
                                sheetView.addSelection(newRange.row, newRange.col, newRange.rowCount, newRange.colCount)
                            }
                        }
                    };
                    DragFillUndoAction.prototype.executeDragFill = function(sheetView)
                    {
                        var self = this;
                        var sheet = self._workSheet;
                        var startRange = self._dragFillExtent.startRange;
                        var fillRange = self._dragFillExtent.fillRange;
                        var r,
                            c;
                        if (self._dragFillExtent.autoFillType === 1)
                        {
                            self.clearData(fillRange, true);
                            sheet.fillAuto(startRange, self._wholeFillRange, self._fillSeries)
                        }
                        else if (self._dragFillExtent.autoFillType === 0)
                        {
                            var copyToWithoutCommentOption = 1023 ^ 4;
                            self.copyCells(startRange, fillRange, copyToWithoutCommentOption)
                        }
                        else if (self._dragFillExtent.autoFillType === 2)
                        {
                            self.copyCells(startRange, fillRange, 64)
                        }
                        else if (self._dragFillExtent.autoFillType === 3)
                        {
                            self.clearData(fillRange, true);
                            var isDragSingleCell = (startRange.rowCount === 1 && startRange.colCount === 1) && !(startRange.row === -1 && startRange.col !== -1) && !(startRange.col === -1 && startRange.row !== -1);
                            if (isDragSingleCell)
                            {
                                var noStyleOption = 2 | 8 | 32 | 16 | 128 | 1;
                                self.copyCells(startRange, fillRange, noStyleOption)
                            }
                            else
                            {
                                var fixedRange = self.adjustRange(self._wholeFillRange);
                                var savedStyle = new Sheets._GcSheetModel(fixedRange.rowCount, fixedRange.colCount, keyword_null);
                                for (r = 0; r < fixedRange.rowCount; r++)
                                {
                                    for (c = 0; c < fixedRange.colCount; c++)
                                    {
                                        savedStyle.setStyle(r, c, CopyMoveHelper.getStyleObject(self._workSheet, fixedRange.row + r, fixedRange.col + c, 3))
                                    }
                                }
                                sheet.fillAuto(startRange, self._wholeFillRange, self._fillSeries);
                                for (r = 0; r < fixedRange.rowCount; r++)
                                {
                                    for (c = 0; c < fixedRange.colCount; c++)
                                    {
                                        CopyMoveHelper.setStyleObject(self._workSheet, fixedRange.row + r, fixedRange.col + c, 3, savedStyle.getStyle(r, c))
                                    }
                                }
                            }
                        }
                        sheet._setActiveCellImp(Math_max(sheetView._getFirstVisualRow(), self._wholeFillRange.row), Math_max(sheetView._getFirstVisualColumn(), self._wholeFillRange.col), sheetView.activeRowViewportIndex, sheetView.activeColViewportIndex);
                        if (sheetView._selectionModel)
                        {
                            sheetView._clearSelectionImp()
                        }
                        sheet.addSelection(self._wholeFillRange.row, self._wholeFillRange.col, self._wholeFillRange.rowCount, self._wholeFillRange.colCount)
                    };
                    DragFillUndoAction.prototype.clearData = function(cellRange, ignoreFilteredOutRow)
                    {
                        var allStorages = 1;
                        this._workSheet.clearCore(cellRange.row, cellRange.col, cellRange.rowCount, cellRange.colCount, 3, allStorages, ignoreFilteredOutRow)
                    };
                    DragFillUndoAction.prototype.adjustRange = function(range)
                    {
                        var row = range.row !== -1 ? range.row : 0;
                        var column = range.col !== -1 ? range.col : 0;
                        var rowCount = range.rowCount !== -1 ? range.rowCount : this._workSheet.getRowCount();
                        var columnCount = range.colCount !== -1 ? range.colCount : this._workSheet.getColumnCount();
                        return new Sheets.Range(row, column, rowCount, columnCount)
                    };
                    DragFillUndoAction.prototype.copyCells = function(fromRange, toRange, copyOption)
                    {
                        var self = this;
                        var sheet = self._workSheet;
                        var adjustedFromRange = self.adjustRange(fromRange);
                        var adjustedToRange = self.adjustRange(toRange);
                        var i,
                            fromRow,
                            fromColumn,
                            toRow,
                            toColumn,
                            bottomRow,
                            rowCount,
                            columnCount;
                        if (self._fillSeries === 0)
                        {
                            var rows = Math_floor(adjustedToRange.rowCount / adjustedFromRange.rowCount);
                            for (i = 0; i < rows; i++)
                            {
                                fromRow = adjustedFromRange.row;
                                fromColumn = adjustedFromRange.col;
                                if (self._dragFillExtent.fillDirection === 3)
                                {
                                    toRow = adjustedToRange.row + i * adjustedFromRange.rowCount
                                }
                                else
                                {
                                    bottomRow = adjustedToRange.row + adjustedToRange.rowCount;
                                    toRow = bottomRow - (i + 1) * adjustedFromRange.rowCount
                                }
                                toColumn = adjustedToRange.col;
                                rowCount = adjustedFromRange.rowCount;
                                columnCount = adjustedFromRange.colCount;
                                sheet.copyToCore(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, copyOption, true)
                            }
                            var lastCopyRows = adjustedToRange.rowCount % adjustedFromRange.rowCount;
                            if (lastCopyRows !== 0)
                            {
                                if (self._dragFillExtent.fillDirection === 3)
                                {
                                    fromRow = adjustedFromRange.row
                                }
                                else
                                {
                                    var lastRow = adjustedFromRange.rowCount - (adjustedToRange.rowCount - adjustedFromRange.rowCount * rows);
                                    fromRow = adjustedFromRange.row + lastRow
                                }
                                fromColumn = adjustedFromRange.col;
                                if (self._dragFillExtent.fillDirection === 3)
                                {
                                    toRow = adjustedToRange.row + adjustedFromRange.rowCount * rows
                                }
                                else
                                {
                                    bottomRow = adjustedToRange.row + adjustedToRange.rowCount;
                                    toRow = bottomRow - rows * adjustedFromRange.rowCount - lastCopyRows
                                }
                                toColumn = adjustedToRange.col;
                                rowCount = lastCopyRows;
                                columnCount = adjustedFromRange.colCount;
                                sheet.copyToCore(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, copyOption, true)
                            }
                        }
                        else
                        {
                            var columns = Math_floor(adjustedToRange.colCount / adjustedFromRange.colCount);
                            for (i = 0; i < columns; i++)
                            {
                                fromRow = adjustedFromRange.row;
                                fromColumn = adjustedFromRange.col;
                                toRow = adjustedToRange.row;
                                if (self._dragFillExtent.fillDirection === 1)
                                {
                                    toColumn = adjustedToRange.col + i * adjustedFromRange.colCount
                                }
                                else
                                {
                                    var bottomColumn = adjustedToRange.col + adjustedToRange.colCount;
                                    toColumn = bottomColumn - (i + 1) * adjustedFromRange.colCount
                                }
                                rowCount = adjustedFromRange.rowCount;
                                columnCount = adjustedFromRange.colCount;
                                sheet.copyToCore(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, copyOption, true)
                            }
                            var lastCopyColumns = adjustedToRange.colCount % adjustedFromRange.colCount;
                            if (lastCopyColumns !== 0)
                            {
                                fromRow = adjustedFromRange.row;
                                if (self._dragFillExtent.fillDirection === 1)
                                {
                                    fromColumn = adjustedFromRange.col
                                }
                                else
                                {
                                    var lastColumn = adjustedFromRange.colCount - (adjustedToRange.colCount - adjustedFromRange.colCount * columns);
                                    fromColumn = adjustedFromRange.col + lastColumn
                                }
                                toRow = adjustedToRange.row;
                                if (self._dragFillExtent.fillDirection === 1)
                                {
                                    toColumn = adjustedToRange.col + adjustedFromRange.colCount * columns
                                }
                                else
                                {
                                    var leftColumn = adjustedToRange.col + adjustedToRange.colCount;
                                    toColumn = leftColumn - columns * adjustedFromRange.colCount - lastCopyColumns
                                }
                                rowCount = adjustedFromRange.rowCount;
                                columnCount = lastCopyColumns;
                                sheet.copyToCore(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, copyOption, true)
                            }
                        }
                    };
                    DragFillUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        if (self._dragFillExtent.autoFillType === 4)
                        {
                            self.saveDragClearState()
                        }
                        else
                        {
                            self.saveDragFillState()
                        }
                        self._savedBeforeFillChangedCells = new ChangedCells(self._workSheet, self._dragFillExtent.fillRange, 1023);
                        self._savedFilledViewportCells = self.saveRangeStates(self._dragFillExtent.fillRange)
                    };
                    DragFillUndoAction.prototype.saveDragClearState = function()
                    {
                        this._clearValueUndoAction.saveState()
                    };
                    DragFillUndoAction.prototype.saveDragFillState = function()
                    {
                        this._savedStartViewportCells = this.saveRangeStates(this._dragFillExtent.startRange)
                    };
                    DragFillUndoAction.prototype.saveRangeStates = function(range)
                    {
                        var savedRange = this.adjustRange(range);
                        var savedCellsInfo = new CopyMoveCellsInfo(savedRange.rowCount, savedRange.colCount);
                        CopyMoveHelper.saveViewportInfo(this._workSheet, savedCellsInfo, savedRange.row, savedRange.col, 1023);
                        return savedCellsInfo
                    };
                    DragFillUndoAction.prototype.undo = function(arg)
                    {
                        var self = this;
                        var sheet = self._workSheet;
                        var result = false;
                        var repained = false;
                        try
                        {
                            self._suspendInvalidate(sheet);
                            sheet.suspendCalcService();
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            result = self._undo(sheet)
                        }
                        finally
                        {
                            sheet.isPaintSuspended(oldState);
                            sheet.resumeCalcService();
                            repained = self._resumeInvalidate(sheet)
                        }
                        if (!repained)
                        {
                            sheet.invalidateLayout();
                            sheet.repaint()
                        }
                        return result
                    };
                    DragFillUndoAction.prototype._undo = function(sheet)
                    {
                        var self = this;
                        var result;
                        var oldSelections = sheet.getSelections();
                        var fillRange = self._dragFillExtent.fillRange;
                        var filledRangeCellValues = CopyMoveHelper.getValues(self._workSheet, fillRange.row, fillRange.col, fillRange.rowCount, fillRange.colCount);
                        if (self._dragFillExtent.autoFillType === 4)
                        {
                            result = self.undoDragClear(sheet)
                        }
                        else
                        {
                            result = self.undoDragFill(sheet)
                        }
                        if (sheet._skipCloseDragFillSmartTag !== true)
                        {
                            sheet._closeDragFillPopup()
                        }
                        CopyMoveHelper.raiseRangeDataChanged(sheet, fillRange.row, fillRange.col, fillRange.rowCount, fillRange.colCount, self._savedAfterFilledChangedCells.getChangedCells(), 1, filledRangeCellValues);
                        var newSelections = sheet.getSelections();
                        if (sheet._raiseSelectionChanging(oldSelections, newSelections))
                        {
                            sheet._raiseSelectionChanged()
                        }
                        return result
                    };
                    DragFillUndoAction.prototype.undoDragClear = function(sheet)
                    {
                        var self = this;
                        var result = self._clearValueUndoAction.undo(sheet);
                        sheet._setActiveCellImp(Math_max(sheet._getFirstVisualRow(), self._dragFillExtent.startRange.row), Math_max(sheet._getFirstVisualColumn(), self._dragFillExtent.startRange.col), sheet.activeRowViewportIndex, sheet.activeColViewportIndex);
                        sheet._clearSelectionImp();
                        sheet.addSelection(self._dragFillExtent.startRange.row, self._dragFillExtent.startRange.col, self._dragFillExtent.startRange.rowCount, self._dragFillExtent.startRange.colCount);
                        return result
                    };
                    DragFillUndoAction.prototype.undoDragFill = function(sheet)
                    {
                        var self = this;
                        self._suspendInvalidate(sheet);
                        sheet.suspendCalcService();
                        try
                        {
                            self.undoRangeStates(self._savedFilledViewportCells, self._dragFillExtent.fillRange);
                            self.undoRangeStates(self._savedStartViewportCells, self._dragFillExtent.startRange);
                            sheet._setActiveCellImp(Math_max(sheet._getFirstVisualRow(), self._dragFillExtent.startRange.row), Math_max(sheet._getFirstVisualColumn(), self._dragFillExtent.startRange.col), sheet.activeRowViewportIndex, sheet.activeColViewportIndex);
                            sheet._clearSelectionImp();
                            sheet.addSelection(self._dragFillExtent.startRange.row, self._dragFillExtent.startRange.col, self._dragFillExtent.startRange.rowCount, self._dragFillExtent.startRange.colCount)
                        }
                        finally
                        {
                            sheet.resumeCalcService();
                            self._resumeInvalidate(sheet)
                        }
                        sheet.invalidateLayout();
                        return true
                    };
                    DragFillUndoAction.prototype.undoRangeStates = function(savedInfo, range)
                    {
                        var savedRange = this.adjustRange(range);
                        CopyMoveHelper.undoCellsInfo(this._workSheet, savedInfo, savedRange.row, savedRange.col, 3)
                    };
                    DragFillUndoAction.prototype.initWholeFilledRange = function()
                    {
                        var self = this;
                        var row = 0,
                            rowCount = 0,
                            column = 0,
                            columnCount = 0;
                        var direction = self._dragFillExtent.fillDirection;
                        var startRange = self._dragFillExtent.startRange;
                        var fillRange = self._dragFillExtent.fillRange;
                        if (direction === 0 || direction === 1)
                        {
                            row = startRange.row;
                            rowCount = startRange.rowCount;
                            column = direction === 0 ? fillRange.col : startRange.col;
                            columnCount = startRange.colCount + fillRange.colCount
                        }
                        else
                        {
                            row = direction === 2 ? fillRange.row : startRange.row;
                            rowCount = startRange.rowCount + fillRange.rowCount;
                            column = startRange.col;
                            columnCount = startRange.colCount
                        }
                        self._wholeFillRange = new Sheets.Range(row, column, rowCount, columnCount)
                    };
                    return DragFillUndoAction
                })(ActionBase);
            UndoRedo.DragFillUndoAction = DragFillUndoAction;
            var FillUndoAction = (function(_super)
                {
                    __extends(FillUndoAction, _super);
                    function FillUndoAction(sheet, fillType, isChangeFill, fillRange)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        this._isChangeFill = isChangeFill;
                        this._fillRange = fillRange;
                        this._fillType = fillType
                    }
                    FillUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        self._suspendInvalidate(sheet);
                        self.saveState();
                        var oldState = sheet.isPaintSuspended();
                        sheet.isPaintSuspended(true);
                        try
                        {
                            var savedRange = self.adjustRange(self._fillRange);
                            var savedCellsInfo = new CopyMoveCellsInfo(savedRange.rowCount, savedRange.colCount);
                            CopyMoveHelper.saveViewportInfo(self._sheet, savedCellsInfo, savedRange.row, savedRange.col, 1023);
                            self._savedFilledViewportCells = savedCellsInfo;
                            var eventHandler = sheet._eventHandler;
                            var args = {
                                    sheet: sheet, sheetName: sheet._name, fillRange: self._fillRange, autoFillType: self._fillType, fillDirection: eventHandler.getCurrentFillDirection()
                                };
                            var cancel = sheet._raiseDragFillBlock(args);
                            eventHandler._currentDragFillType = args.autoFillType;
                            eventHandler._isCancelDragFill = cancel;
                            if (this._isChangeFill)
                            {
                                self.executeChangeFill(sender, args)
                            }
                            else
                            {
                                self.executeDragFillAction(sender, args)
                            }
                            sheet._raiseDragFillBlockCompleted(args)
                        }
                        finally
                        {
                            sheet.isPaintSuspended(oldState);
                            var fillRange = self._fillRange;
                            self._savedAfterFilledChangedCells = new ChangedCells(sheet, fillRange, 1023);
                            self._savedAfterFilledChangedCells.mergeCellsHasDiffData(self._savedBeforeFillChangedCells.getCellsHasData());
                            CopyMoveHelper.raiseRangeDataChanged(sheet, fillRange.row, fillRange.col, fillRange.rowCount, fillRange.colCount, self._savedAfterFilledChangedCells.getChangedCells(), 1, self._savedFilledViewportCells.getValues())
                        }
                        var repained = self._resumeInvalidate(sheet);
                        if (!repained)
                        {
                            self.refreshUI(sender)
                        }
                    };
                    FillUndoAction.prototype.executeChangeFill = function(sender, args)
                    {
                        var sheet = this._sheet;
                        sheet._skipCloseDragFillSmartTag = true;
                        sheet.suspendEvent();
                        try
                        {
                            Sheets.SpreadActions.undo.call(sheet)
                        }
                        finally
                        {
                            sheet.resumeEvent()
                        }
                        sheet._skipCloseDragFillSmartTag = false;
                        this.executeDragFillAction(sender, args)
                    };
                    FillUndoAction.prototype.executeDragFillAction = function(sender, args)
                    {
                        var sheet = this._sheet,
                            eventHandler = sheet._eventHandler,
                            fillRange = this._fillRange,
                            autoFillType = this._fillType;
                        eventHandler._currentDragFillType = autoFillType;
                        var savedRange = sheet._getActualRange(fillRange);
                        eventHandler._preFillCellsInfo = new UndoRedo.CopyMoveCellsInfo(savedRange.rowCount, savedRange.colCount);
                        UndoRedo.CopyMoveHelper.saveViewportInfo(sheet, eventHandler._preFillCellsInfo, savedRange.row, savedRange.col, 1023);
                        if (!eventHandler._isCancelDragFill)
                        {
                            var dragFillActionFillType = args.autoFillType === 5 ? autoFillType : args.autoFillType;
                            var dragFillExtent = {
                                    startRange: eventHandler._dragFillStartRange, fillRange: fillRange, autoFillType: dragFillActionFillType, fillDirection: eventHandler.getCurrentFillDirection()
                                };
                            var dragFillUndoAction = new DragFillUndoAction(sheet, dragFillExtent);
                            sheet.suspendEvent();
                            dragFillUndoAction.execute(sender);
                            sheet.resumeEvent();
                            this._dragFillUndoAction = dragFillUndoAction
                        }
                    };
                    FillUndoAction.prototype.canExecute = function(sender)
                    {
                        return true
                    };
                    FillUndoAction.prototype.canUndo = function()
                    {
                        return true
                    };
                    FillUndoAction.prototype.refreshUI = function(sender)
                    {
                        var sheetView = this._sheet;
                        if (sheetView)
                        {
                            sheetView.invalidateLayout();
                            sheetView.repaint()
                        }
                    };
                    FillUndoAction.prototype.adjustRange = function(range)
                    {
                        var row = range.row !== -1 ? range.row : 0;
                        var column = range.col !== -1 ? range.col : 0;
                        var rowCount = range.rowCount !== -1 ? range.rowCount : this._sheet.getRowCount();
                        var columnCount = range.colCount !== -1 ? range.colCount : this._sheet.getColumnCount();
                        return new Sheets.Range(row, column, rowCount, columnCount)
                    };
                    FillUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        self._savedBeforeFillChangedCells = new ChangedCells(self._sheet, self._fillRange, 1023)
                    };
                    FillUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        var sheet = self._sheet;
                        var ret = true;
                        self._suspendInvalidate(sheet);
                        sheet.suspendEvent();
                        self.saveState();
                        var oldState = sheet.isPaintSuspended();
                        sheet.isPaintSuspended(true);
                        var filledRangeCellValues = keyword_null;
                        try
                        {
                            var fillRange = self._fillRange;
                            filledRangeCellValues = CopyMoveHelper.getValues(self._sheet, fillRange.row, fillRange.col, fillRange.rowCount, fillRange.colCount);
                            ret = self._dragFillUndoAction.undo(sender)
                        }
                        finally
                        {
                            sheet.isPaintSuspended(oldState);
                            sheet.resumeEvent();
                            self._savedAfterFilledChangedCells = new ChangedCells(sheet, fillRange, 1023);
                            self._savedAfterFilledChangedCells.mergeCellsHasDiffData(self._savedBeforeFillChangedCells.getCellsHasData());
                            CopyMoveHelper.raiseRangeDataChanged(sheet, fillRange.row, fillRange.col, fillRange.rowCount, fillRange.colCount, self._savedAfterFilledChangedCells.getChangedCells(), 1, filledRangeCellValues);
                            var repained = self._resumeInvalidate(sheet);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                        }
                        return ret
                    };
                    return FillUndoAction
                })(ActionBase);
            UndoRedo.FillUndoAction = FillUndoAction;
            var PasteRangeExtent = (function()
                {
                    function PasteRangeExtent(sourceRange, targetRange, isCutting, clipboardText)
                    {
                        this.sourceRange = sourceRange;
                        this.targetRange = targetRange;
                        this.isCutting = isCutting;
                        this.clipboardText = clipboardText
                    }
                    return PasteRangeExtent
                })();
            UndoRedo.PasteRangeExtent = PasteRangeExtent;
            var ClipboardPasteRangeUndoAction = (function(_super)
                {
                    __extends(ClipboardPasteRangeUndoAction, _super);
                    function ClipboardPasteRangeUndoAction(sheet, srcSheet, destSheet, pasteExtent, option)
                    {
                        _super.call(this);
                        var self = this;
                        self._sheet = sheet;
                        self._fromSheet = srcSheet;
                        self._toSheet = destSheet;
                        self._pasteExtent = pasteExtent;
                        self._pasteOption = option
                    }
                    ClipboardPasteRangeUndoAction.prototype.canUndo = function()
                    {
                        return true
                    };
                    ClipboardPasteRangeUndoAction.prototype.canExecute = function(arg)
                    {
                        var sheet = this._sheet;
                        var target = this._pasteExtent.targetRange;
                        var source = this._pasteExtent.sourceRange;
                        return !(sheet.isProtected && sheet._isAnyCellInRangeLocked(target)) && sheet._checkArrayFormula(target.row, target.col, target.rowCount, target.colCount) && (!this._pasteExtent.isCutting || !(sheet.isProtected && sheet._isAnyCellInRangeLocked(source)) && sheet._checkArrayFormula(source.row, source.col, source.rowCount, source.colCount))
                    };
                    ClipboardPasteRangeUndoAction.prototype.saveState = function()
                    {
                        var self = this;
                        self.initSaveState();
                        var isCutting = self._pasteExtent.isCutting;
                        var option = ClipboardPasteRangeUndoAction.convertPasteOption(self._pasteOption);
                        var fromRange = self._pasteExtent.sourceRange;
                        var toRange = self._pasteExtent.targetRange;
                        if (self._fromSheet && fromRange && isCutting)
                        {
                            var fromRow = fromRange.row < 0 ? 0 : fromRange.row;
                            var fromColumn = fromRange.col < 0 ? 0 : fromRange.col;
                            var fromRowCount = fromRange.row < 0 ? self._fromSheet.getRowCount() : fromRange.rowCount;
                            var fromColumnCount = fromRange.col < 0 ? self._fromSheet.getColumnCount() : fromRange.colCount;
                            if (fromRange.row < 0 && fromRange.col < 0 && toRange.row < 0 && toRange.col < 0)
                            {
                                if (self._fromSheet._name !== self._toSheet._name)
                                {
                                    var fromSheetInfo = new CopyMoveSheetInfo;
                                    CopyMoveHelper.saveSheetInfo(self._fromSheet, fromSheetInfo, option);
                                    self._savedFromSheetInfo = fromSheetInfo
                                }
                            }
                            if (fromRange.row < 0)
                            {
                                var fromColumnHeaderCellsInfo = new CopyMoveCellsInfo(self._fromSheet.getRowCount(1), fromColumnCount);
                                var fromColumnsInfo = new CopyMoveColumnsInfo(fromColumnCount);
                                CopyMoveHelper.saveColumnHeaderInfo(self._fromSheet, fromColumnHeaderCellsInfo, fromColumnsInfo, fromColumn, option);
                                self._savedFromColumnHeaderCells = fromColumnHeaderCellsInfo;
                                self._savedFromColumns = fromColumnsInfo
                            }
                            if (fromRange.col < 0)
                            {
                                var fromRowHeaderCellsInfo = new CopyMoveCellsInfo(fromRowCount, self._fromSheet.getColumnCount(2));
                                var fromRowsInfo = new CopyMoveRowsInfo(fromRowCount);
                                CopyMoveHelper.saveRowHeaderInfo(self._fromSheet, fromRowHeaderCellsInfo, fromRowsInfo, fromRow, option);
                                self._savedFromRowHeaderCells = fromRowHeaderCellsInfo;
                                self._savedFromRows = fromRowsInfo
                            }
                            var fromViewportCellsInfo = new CopyMoveCellsInfo(fromRowCount, fromColumnCount);
                            CopyMoveHelper.saveViewportInfo(self._fromSheet, fromViewportCellsInfo, fromRow, fromColumn, option);
                            self._savedFromViewportCells = fromViewportCellsInfo;
                            var fromTables = [];
                            CopyMoveHelper.saveTableInfo(self._sheet, fromTables, new Sheets.Range(fromRow, fromColumn, fromRowCount, fromColumnCount));
                            self._savedFromTables = fromTables;
                            self._savedFromBeforePastedChangedCells = new ChangedCells(self._fromSheet, fromRange, option)
                        }
                        var toRow = toRange.row < 0 ? 0 : toRange.row;
                        var toColumn = toRange.col < 0 ? 0 : toRange.col;
                        var toRowCount = toRange.row < 0 ? self._toSheet.getRowCount() : toRange.rowCount;
                        var toColumnCount = toRange.col < 0 ? self._toSheet.getColumnCount() : toRange.colCount;
                        if (self._fromSheet && fromRange)
                        {
                            if (fromRange.row < 0 && fromRange.col < 0 && toRange.row < 0 && toRange.col < 0)
                            {
                                if (self._fromSheet._name !== self._toSheet._name)
                                {
                                    var toSheetInfo = new CopyMoveSheetInfo;
                                    CopyMoveHelper.saveSheetInfo(self._toSheet, toSheetInfo, option);
                                    self._savedToSheetInfo = toSheetInfo
                                }
                            }
                            if (fromRange.row < 0)
                            {
                                var toColumnHeaderCellsInfo = new CopyMoveCellsInfo(self._toSheet.getRowCount(1), toColumnCount);
                                var toColumnsInfo = new CopyMoveColumnsInfo(toColumnCount);
                                CopyMoveHelper.saveColumnHeaderInfo(self._toSheet, toColumnHeaderCellsInfo, toColumnsInfo, toColumn, option);
                                self._savedToColumnHeaderCells = toColumnHeaderCellsInfo;
                                self._savedToColumns = toColumnsInfo
                            }
                            if (fromRange.col < 0)
                            {
                                var toRowHeaderCellsInfo = new CopyMoveCellsInfo(toRowCount, self._toSheet.getColumnCount(2));
                                var toRowsInfo = new CopyMoveRowsInfo(toRowCount);
                                CopyMoveHelper.saveRowHeaderInfo(self._toSheet, toRowHeaderCellsInfo, toRowsInfo, toRow, option);
                                self._savedToRowHeaderCells = toRowHeaderCellsInfo;
                                self._savedToRows = toRowsInfo
                            }
                        }
                        var toViewportCellsInfo = new CopyMoveCellsInfo(toRowCount, toColumnCount);
                        CopyMoveHelper.saveViewportInfo(self._toSheet, toViewportCellsInfo, toRow, toColumn, option);
                        self._savedToViewportCells = toViewportCellsInfo;
                        var toTables = [];
                        CopyMoveHelper.saveTableInfo(self._sheet, toTables, new Sheets.Range(toRow, toColumn, toRowCount, toColumnCount));
                        self._savedToTables = toTables;
                        self._savedToBeforePastedChangedCells = new ChangedCells(self._toSheet, toRange, option)
                    };
                    ClipboardPasteRangeUndoAction.prototype.initSaveState = function()
                    {
                        var self = this;
                        self._savedFromSheetInfo = keyword_null;
                        self._savedFromColumnHeaderCells = keyword_null;
                        self._savedFromColumns = keyword_null;
                        self._savedFromViewportCells = keyword_null;
                        self._savedFromRowHeaderCells = keyword_null;
                        self._savedFromRows = keyword_null;
                        self._savedToSheetInfo = keyword_null;
                        self._savedToColumnHeaderCells = keyword_null;
                        self._savedToColumns = keyword_null;
                        self._savedToViewportCells = keyword_null;
                        self._savedToRowHeaderCells = keyword_null;
                        self._savedToRows = keyword_null
                    };
                    ClipboardPasteRangeUndoAction.prototype.pasteOption = function()
                    {
                        return this._pasteOption
                    };
                    ClipboardPasteRangeUndoAction.prototype.pasteRange = function()
                    {
                        return this._pasteExtent.targetRange
                    };
                    ClipboardPasteRangeUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        var fromRange = self._pasteExtent.sourceRange;
                        var toRange = self._pasteExtent.targetRange;
                        if (self._fromSheet && fromRange && !self._fromSheet._isValidRange(fromRange.row, fromRange.col, fromRange.rowCount, fromRange.colCount, self._fromSheet.getRowCount(), self._fromSheet.getColumnCount()))
                        {
                            return
                        }
                        if (!(self._toSheet && toRange && self._toSheet._isValidRange(toRange.row, toRange.col, toRange.rowCount, toRange.colCount, self._toSheet.getRowCount(), self._toSheet.getColumnCount())))
                        {
                            return
                        }
                        self.saveState();
                        self._suspendInvalidate(sender);
                        self._toSheet.suspendEvent();
                        if (self._fromSheet)
                        {
                            self._fromSheet.suspendEvent()
                        }
                        try
                        {
                            self._toSheet._clipboardPaste(self._fromSheet, fromRange, self._toSheet, toRange, self._pasteExtent.isCutting, self._pasteExtent.clipboardText, self._pasteOption)
                        }
                        finally
                        {
                            self._toSheet.resumeEvent();
                            if (self._fromSheet)
                            {
                                self._fromSheet.resumeEvent()
                            }
                            self._resumeInvalidate(sender);
                            var sheet = self._sheet;
                            if (sheet)
                            {
                                var savedFromViewportCells = self._savedFromViewportCells;
                                if (self._pasteExtent.isCutting && savedFromViewportCells && self._fromSheet && savedFromViewportCells.isValueOrFormulaSaved())
                                {
                                    var option = ClipboardPasteRangeUndoAction.convertPasteOption(self._pasteOption);
                                    self._savedFromAfterPastedChangedCells = new ChangedCells(self._fromSheet, fromRange, option);
                                    self._savedFromAfterPastedChangedCells.mergeCellsHasDiffData(self._savedFromBeforePastedChangedCells.getCellsHasData());
                                    CopyMoveHelper.raiseRangeDataChanged(self._fromSheet, fromRange.row, fromRange.col, fromRange.rowCount, fromRange.colCount, self._savedFromAfterPastedChangedCells.getChangedCells(), 3, savedFromViewportCells.getValues())
                                }
                                var savedToViewportCells = self._savedToViewportCells;
                                if (savedToViewportCells && self._toSheet && savedToViewportCells.isValueOrFormulaSaved())
                                {
                                    var option = ClipboardPasteRangeUndoAction.convertPasteOption(self._pasteOption);
                                    self._savedToAfterPastedChangedCells = new ChangedCells(self._toSheet, toRange, option);
                                    self._savedToAfterPastedChangedCells.mergeCellsHasDiffData(self._savedToBeforePastedChangedCells.getCellsHasData());
                                    CopyMoveHelper.raiseRangeDataChanged(self._toSheet, toRange.row, toRange.col, toRange.rowCount, toRange.colCount, self._savedToAfterPastedChangedCells.getChangedCells(), 3, savedToViewportCells.getValues())
                                }
                            }
                        }
                    };
                    ClipboardPasteRangeUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        var fromRange = self._pasteExtent.sourceRange;
                        var toRange = self._pasteExtent.targetRange;
                        if (!self._toSheet || !toRange)
                        {
                            return false
                        }
                        if (!self._toSheet._isValidRange(toRange.row, toRange.col, toRange.rowCount, toRange.colCount, self._toSheet.getRowCount(), self._toSheet.getColumnCount()))
                        {
                            return false
                        }
                        if (self._fromSheet && fromRange)
                        {
                            if (!self._fromSheet._isValidRange(fromRange.row, fromRange.col, fromRange.rowCount, fromRange.colCount, self._fromSheet.getRowCount(), self._fromSheet.getColumnCount()))
                            {
                                return false
                            }
                            if (self._fromSheet && self._fromSheet._name === self._toSheet._name && (self._toSheet.parent && !Sheets.ArrayHelper.contains(self._toSheet.parent.sheets, self._fromSheet)))
                            {
                                return false
                            }
                        }
                        self._suspendInvalidate(sender);
                        var ret = false;
                        try
                        {
                            var oldToValues = keyword_null;
                            var oldFromValues = keyword_null;
                            var toRow = toRange.row < 0 ? 0 : toRange.row;
                            var toColumn = toRange.col < 0 ? 0 : toRange.col;
                            var toRowCount = toRange.row < 0 ? self._toSheet.getRowCount() : toRange.rowCount;
                            var toColumnCount = toRange.col < 0 ? self._toSheet.getColumnCount() : toRange.colCount;
                            CopyMoveHelper.clearFormula(self._toSheet, toRow, toColumn, toRowCount, toColumnCount);
                            if (self._savedToTables)
                            {
                                CopyMoveHelper.undoTableInfo(self._sheet, self._savedToTables, new Sheets.Range(toRow, toColumn, toRowCount, toColumnCount))
                            }
                            if (self._savedToSheetInfo)
                            {
                                CopyMoveHelper.undoSheetInfo(self._toSheet, self._savedToSheetInfo);
                                ret = true
                            }
                            var savedToViewportCells = self._savedToViewportCells;
                            if (savedToViewportCells && savedToViewportCells.isValueOrFormulaSaved())
                            {
                                oldToValues = CopyMoveHelper.getValues(self._toSheet, toRow, toColumn, toRowCount, toColumnCount)
                            }
                            if (self._savedToColumnHeaderCells)
                            {
                                CopyMoveHelper.undoCellsInfo(self._toSheet, self._savedToColumnHeaderCells, 0, toColumn, 1);
                                ret = true
                            }
                            if (self._savedToColumns)
                            {
                                CopyMoveHelper.undoColumnsInfo(self._toSheet, self._savedToColumns, toColumn);
                                ret = true
                            }
                            if (savedToViewportCells)
                            {
                                CopyMoveHelper.undoCellsInfo(self._toSheet, savedToViewportCells, toRow, toColumn, 3);
                                ret = true
                            }
                            if (self._savedToRowHeaderCells)
                            {
                                CopyMoveHelper.undoCellsInfo(self._toSheet, self._savedToRowHeaderCells, toRow, 0, 2);
                                ret = true
                            }
                            if (self._savedToRows)
                            {
                                CopyMoveHelper.undoRowsInfo(self._toSheet, self._savedToRows, toRow);
                                ret = true
                            }
                            var fromRow = 0;
                            var fromColumn = 0;
                            var fromRowCount = 0;
                            var fromColumnCount = 0;
                            if (self._fromSheet && fromRange)
                            {
                                fromRow = fromRange.row < 0 ? 0 : fromRange.row;
                                fromColumn = fromRange.col < 0 ? 0 : fromRange.col;
                                fromRowCount = fromRange.row < 0 ? self._fromSheet.getRowCount() : fromRange.rowCount;
                                fromColumnCount = fromRange.col < 0 ? self._fromSheet.getColumnCount() : fromRange.colCount;
                                if (self._savedFromTables)
                                {
                                    CopyMoveHelper.undoTableInfo(self._sheet, self._savedFromTables, new Sheets.Range(fromRow, fromColumn, fromRowCount, fromColumnCount))
                                }
                                var savedFromViewportCells = self._savedFromViewportCells;
                                if (savedFromViewportCells && savedFromViewportCells.isValueOrFormulaSaved())
                                {
                                    oldFromValues = CopyMoveHelper.getValues(self._fromSheet, fromRow, fromColumn, fromRowCount, fromColumnCount)
                                }
                                if (self._savedFromColumnHeaderCells)
                                {
                                    CopyMoveHelper.undoCellsInfo(self._fromSheet, self._savedFromColumnHeaderCells, 0, fromColumn, 1);
                                    ret = true
                                }
                                if (self._savedFromColumns)
                                {
                                    CopyMoveHelper.undoColumnsInfo(self._fromSheet, self._savedFromColumns, fromColumn);
                                    ret = true
                                }
                                if (savedFromViewportCells)
                                {
                                    CopyMoveHelper.undoCellsInfo(self._fromSheet, savedFromViewportCells, fromRow, fromColumn, 3);
                                    ret = true
                                }
                                if (self._savedFromRowHeaderCells)
                                {
                                    CopyMoveHelper.undoCellsInfo(self._fromSheet, self._savedFromRowHeaderCells, fromRow, 0, 2);
                                    ret = true
                                }
                                if (self._savedFromRows)
                                {
                                    CopyMoveHelper.undoRowsInfo(self._fromSheet, self._savedFromRows, fromRow);
                                    ret = true
                                }
                            }
                            var sheet = sender;
                            if (ret && sheet)
                            {
                                if (oldToValues && self._toSheet)
                                {
                                    CopyMoveHelper.raiseRangeDataChanged(self._toSheet, toRow, toColumn, toRowCount, toColumnCount, self._savedToAfterPastedChangedCells.getChangedCells(), 3, oldToValues)
                                }
                                if (oldFromValues && self._fromSheet)
                                {
                                    CopyMoveHelper.raiseRangeDataChanged(self._fromSheet, fromRow, fromColumn, fromRowCount, fromColumnCount, self._savedFromAfterPastedChangedCells.getChangedCells(), 3, oldFromValues)
                                }
                            }
                        }
                        finally
                        {
                            self._resumeInvalidate(sender)
                        }
                        return ret
                    };
                    ClipboardPasteRangeUndoAction.convertPasteOption = function(pasteOption)
                    {
                        var copyOption = 0;
                        if (pasteOption === 0 || pasteOption === 1)
                        {
                            copyOption |= 1
                        }
                        if (pasteOption === 0 || pasteOption === 2)
                        {
                            copyOption |= 64
                        }
                        if (pasteOption === 0 || pasteOption === 3)
                        {
                            copyOption |= 2
                        }
                        if (pasteOption === 0)
                        {
                            copyOption |= 32;
                            copyOption |= 16;
                            copyOption |= 256;
                            copyOption |= 4;
                            copyOption |= 512;
                            copyOption |= 128
                        }
                        return copyOption
                    };
                    return ClipboardPasteRangeUndoAction
                })(ActionBase);
            UndoRedo.ClipboardPasteRangeUndoAction = ClipboardPasteRangeUndoAction;
            var PasteExtent = (function()
                {
                    function PasteExtent(fromRange, pastedRanges, isCutting, clipboardText)
                    {
                        this.fromRange = fromRange;
                        this.pastedRanges = pastedRanges;
                        this.isCutting = isCutting;
                        this.clipboardText = clipboardText
                    }
                    return PasteExtent
                })();
            UndoRedo.PasteExtent = PasteExtent;
            var ClipboardPasteUndoAction = (function(_super)
                {
                    __extends(ClipboardPasteUndoAction, _super);
                    function ClipboardPasteUndoAction(sheet, srcSheet, destSheet, pasteExtent, option)
                    {
                        _super.call(this);
                        this._sheet = sheet;
                        if (!destSheet)
                        {
                            throw new Error(Sheets.SR.Exp_DestSheetIsNull);
                        }
                        if (!pasteExtent)
                        {
                            throw new Error(Sheets.SR.Exp_PasteExtentIsNull);
                        }
                        if (pasteExtent.pastedRanges && pasteExtent.pastedRanges.length > 0)
                        {
                            this._cachedActions = new Array;
                            for (var i = 0; i < pasteExtent.pastedRanges.length; i++)
                            {
                                var extent = {
                                        sourceRange: pasteExtent.fromRange, targetRange: pasteExtent.pastedRanges[i], isCutting: pasteExtent.isCutting, clipboardText: pasteExtent.clipboardText
                                    };
                                this._cachedActions[i] = new ClipboardPasteRangeUndoAction(sheet, srcSheet, destSheet, extent, option)
                            }
                        }
                    }
                    ClipboardPasteUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        if (self._cachedActions)
                        {
                            var sheetView = self._sheet;
                            self._suspendInvalidate(sheetView);
                            var oldState = sheetView.isPaintSuspended();
                            sheetView.isPaintSuspended(true);
                            try
                            {
                                for (var i = 0; i < self._cachedActions.length; i++)
                                {
                                    var action = self._cachedActions[i];
                                    if (!sheetView)
                                    {
                                        action.execute(sender)
                                    }
                                    else
                                    {
                                        var cancel = sheetView._raiseClipboardPasting(action.pasteRange(), action.pasteOption());
                                        if (!cancel)
                                        {
                                            action.execute(sender);
                                            sheetView._raiseClipboardPasted(action.pasteRange(), action.pasteOption())
                                        }
                                    }
                                }
                                self.refreshSelection(sender)
                            }
                            finally
                            {
                                sheetView.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(sheetView);
                                if (!repained)
                                {
                                    self.refreshUI(sender)
                                }
                            }
                        }
                    };
                    ClipboardPasteUndoAction.prototype.refreshSelection = function(sender)
                    {
                        var self = this;
                        var sheetView = self._sheet;
                        if (sheetView)
                        {
                            if (self._cachedActions)
                            {
                                var oldSelection = sheetView.getSelections();
                                sheetView._clearSelectionImp();
                                if (self._cachedActions.length > 1)
                                {
                                    for (var i = 0; i < self._cachedActions.length; i++)
                                    {
                                        var action = self._cachedActions[i];
                                        var range = action.pasteRange();
                                        sheetView.addSelection(range.row, range.col, range.rowCount, range.colCount)
                                    }
                                }
                                else if (self._cachedActions.length > 0)
                                {
                                    var toRange = self._cachedActions[0].pasteRange();
                                    sheetView.addSelection(toRange.row, toRange.col, toRange.rowCount, toRange.colCount);
                                    if (!toRange.contains(sheetView._activeRowIndex, sheetView._activeColIndex))
                                    {
                                        sheetView._setActiveCellImp(Math_max(sheetView._getFirstVisualRow(), toRange.row), Math_max(sheetView._getFirstVisualColumn(), toRange.col), sheetView.activeRowViewportIndex, sheetView.activeColViewportIndex)
                                    }
                                }
                                if (sheetView._raiseSelectionChanging(oldSelection, sheetView.getSelections()))
                                {
                                    sheetView._raiseSelectionChanged()
                                }
                            }
                        }
                    };
                    ClipboardPasteUndoAction.prototype.refreshUI = function(sender)
                    {
                        var sheetView = this._sheet;
                        if (sheetView)
                        {
                            sheetView.invalidateLayout();
                            sheetView.repaint()
                        }
                    };
                    ClipboardPasteUndoAction.prototype.canExecute = function(sender)
                    {
                        if (this._cachedActions)
                        {
                            for (var i = 0; i < this._cachedActions.length; i++)
                            {
                                var action = this._cachedActions[i];
                                if (!action.canExecute(sender))
                                {
                                    return false
                                }
                            }
                            return true
                        }
                        return false
                    };
                    ClipboardPasteUndoAction.prototype.canUndo = function()
                    {
                        if (this._cachedActions)
                        {
                            for (var i = 0; i < this._cachedActions.length; i++)
                            {
                                var action = this._cachedActions[i];
                                if (!action.canUndo())
                                {
                                    return false
                                }
                            }
                            return true
                        }
                        return false
                    };
                    ClipboardPasteUndoAction.prototype.saveState = function()
                    {
                        if (this._cachedActions)
                        {
                            for (var i = 0; i < this._cachedActions.length; i++)
                            {
                                var action = this._cachedActions[i];
                                action.saveState()
                            }
                        }
                    };
                    ClipboardPasteUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        if (self._cachedActions)
                        {
                            var sheet = self._sheet;
                            var ret = true;
                            self._suspendInvalidate(sheet);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            try
                            {
                                for (var i = 0; i < self._cachedActions.length; i++)
                                {
                                    var action = self._cachedActions[i];
                                    ret = (ret && action.undo(sender))
                                }
                            }
                            finally
                            {
                                sheet.isPaintSuspended(oldState);
                                var repained = self._resumeInvalidate(sheet);
                                if (!repained)
                                {
                                    self.refreshUI(sender)
                                }
                            }
                            return ret
                        }
                        return false
                    };
                    return ClipboardPasteUndoAction
                })(ActionBase);
            UndoRedo.ClipboardPasteUndoAction = ClipboardPasteUndoAction;
            var FloatingObjectExtent = (function()
                {
                    function FloatingObjectExtent(names)
                    {
                        this.names = names
                    }
                    return FloatingObjectExtent
                })();
            UndoRedo.FloatingObjectExtent = FloatingObjectExtent;
            var FloatingObjectUndoActionBase = (function(_super)
                {
                    __extends(FloatingObjectUndoActionBase, _super);
                    function FloatingObjectUndoActionBase()
                    {
                        _super.call(this)
                    }
                    FloatingObjectUndoActionBase.prototype.init = function(sheet, deleteExtent)
                    {
                        this._sheet = sheet;
                        this._floatingObjectExtent = deleteExtent;
                        this._savedFloatingObjects = []
                    };
                    FloatingObjectUndoActionBase.prototype.refreshUI = function(sender)
                    {
                        var sheetView = this._sheet;
                        if (sheetView)
                        {
                            sheetView.invalidateLayout();
                            sheetView.repaint()
                        }
                    };
                    FloatingObjectUndoActionBase.prototype.canExecute = function(sender)
                    {
                        if (this._sheet._hasFloatingObjectsSelected())
                        {
                            return true
                        }
                        return false
                    };
                    FloatingObjectUndoActionBase.prototype.canUndo = function()
                    {
                        if (this._savedFloatingObjects && this._savedFloatingObjects.length > 0)
                        {
                            return true
                        }
                        return false
                    };
                    FloatingObjectUndoActionBase.prototype.saveState = function()
                    {
                        var self = this;
                        if (self._floatingObjectExtent && self._floatingObjectExtent.names instanceof Array)
                        {
                            for (var i = 0, len = self._floatingObjectExtent.names.length; i < len; i++)
                            {
                                var item = self._sheet._findFloatingObjectInternal(self._floatingObjectExtent.names[i]);
                                if (item)
                                {
                                    self._savedFloatingObjects.push(item)
                                }
                            }
                        }
                    };
                    return FloatingObjectUndoActionBase
                })(ActionBase);
            UndoRedo.FloatingObjectUndoActionBase = FloatingObjectUndoActionBase;
            var DeleteFloatingObjectUndoAction = (function(_super)
                {
                    __extends(DeleteFloatingObjectUndoAction, _super);
                    function DeleteFloatingObjectUndoAction(sheet, deleteExtent)
                    {
                        _super.call(this);
                        this.init(sheet, deleteExtent)
                    }
                    DeleteFloatingObjectUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._floatingObjectExtent && self._floatingObjectExtent.names instanceof Array)
                        {
                            self.saveState();
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            for (var i = 0, len = self._floatingObjectExtent.names.length; i < len; i++)
                            {
                                var item = sheet._findFloatingObjectInternal(self._floatingObjectExtent.names[i]);
                                if (item)
                                {
                                    sheet._removeFloatingObjectInternal(self._floatingObjectExtent.names[i]);
                                    item.isSelected(false)
                                }
                            }
                            sheet._loadAndSetSheetSelections();
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                        }
                    };
                    DeleteFloatingObjectUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._savedFloatingObjects && self._savedFloatingObjects.length > 0)
                        {
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            for (var i = 0, len = self._savedFloatingObjects.length; i < len; i++)
                            {
                                var item = self._savedFloatingObjects[i];
                                item.isSelected(true);
                                sheet._addFloatingOjectInternal(item)
                            }
                            sheet._saveAndClearSheetSelections();
                            self._savedFloatingObjects.length = 0;
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                            return true
                        }
                        return false
                    };
                    return DeleteFloatingObjectUndoAction
                })(FloatingObjectUndoActionBase);
            UndoRedo.DeleteFloatingObjectUndoAction = DeleteFloatingObjectUndoAction;
            var MovingFloatingObjectExtent = (function()
                {
                    function MovingFloatingObjectExtent(offsetX, offsetY)
                    {
                        this.offsetX = offsetX;
                        this.offsetY = offsetY
                    }
                    return MovingFloatingObjectExtent
                })();
            UndoRedo.MovingFloatingObjectExtent = MovingFloatingObjectExtent;
            var MovingFloatingObjectUndoAction = (function(_super)
                {
                    __extends(MovingFloatingObjectUndoAction, _super);
                    function MovingFloatingObjectUndoAction(sheet, floatingObjectExtent, movingSettings)
                    {
                        _super.call(this);
                        this.init(sheet, floatingObjectExtent);
                        this._movingSettings = movingSettings
                    }
                    MovingFloatingObjectUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._floatingObjectExtent && self._floatingObjectExtent.names instanceof Array)
                        {
                            self.saveState();
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            for (var i = 0, len = self._floatingObjectExtent.names.length; i < len; i++)
                            {
                                var item = sheet._findFloatingObjectInternal(self._floatingObjectExtent.names[i]);
                                var position = item.position();
                                item.position(new Sheets.Point(position.x + self._movingSettings.offsetX, position.y + self._movingSettings.offsetY))
                            }
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                        }
                    };
                    MovingFloatingObjectUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._savedFloatingObjects && self._savedFloatingObjects.length > 0)
                        {
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            for (var i = 0, len = self._savedFloatingObjects.length; i < len; i++)
                            {
                                var item = self._savedFloatingObjects[i];
                                var position = item.position();
                                item.position(new Sheets.Point(position.x - self._movingSettings.offsetX, position.y - self._movingSettings.offsetY))
                            }
                            self._savedFloatingObjects.length = 0;
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                            return true
                        }
                        return false
                    };
                    return MovingFloatingObjectUndoAction
                })(FloatingObjectUndoActionBase);
            UndoRedo.MovingFloatingObjectUndoAction = MovingFloatingObjectUndoAction;
            var ReszingFloatingObjectExtent = (function()
                {
                    function ReszingFloatingObjectExtent(offsetX, offsetY, offsetWidth, offsetHeight)
                    {
                        this.offsetX = offsetX;
                        this.offsetY = offsetY;
                        this.offsetWidth = offsetWidth;
                        this.offsetHeight = offsetHeight
                    }
                    return ReszingFloatingObjectExtent
                })();
            UndoRedo.ReszingFloatingObjectExtent = ReszingFloatingObjectExtent;
            var ResizingFloatingObjectUndoAction = (function(_super)
                {
                    __extends(ResizingFloatingObjectUndoAction, _super);
                    function ResizingFloatingObjectUndoAction(sheet, floatingObjectExtent, resizingSettings)
                    {
                        _super.call(this);
                        this.init(sheet, floatingObjectExtent);
                        this._resizingSettings = resizingSettings
                    }
                    ResizingFloatingObjectUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._floatingObjectExtent && self._floatingObjectExtent.names instanceof Array)
                        {
                            self.saveState();
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            for (var i = 0, len = self._floatingObjectExtent.names.length; i < len; i++)
                            {
                                var item = sheet._findFloatingObjectInternal(self._floatingObjectExtent.names[i]);
                                var position = item.position();
                                item.width(item.width() + self._resizingSettings.offsetWidth);
                                item.height(item.height() + self._resizingSettings.offsetHeight);
                                item.position(new Sheets.Point(position.x + self._resizingSettings.offsetX, position.y + self._resizingSettings.offsetY))
                            }
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                        }
                    };
                    ResizingFloatingObjectUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._savedFloatingObjects && self._savedFloatingObjects.length > 0)
                        {
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            for (var i = 0, len = self._savedFloatingObjects.length; i < len; i++)
                            {
                                var item = self._savedFloatingObjects[i];
                                var position = item.position();
                                item.position(new Sheets.Point(position.x - self._resizingSettings.offsetX, position.y - self._resizingSettings.offsetY));
                                item.width(item.width() - self._resizingSettings.offsetWidth);
                                item.height(item.height() - self._resizingSettings.offsetHeight)
                            }
                            self._savedFloatingObjects.length = 0;
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                            return true
                        }
                        return false
                    };
                    return ResizingFloatingObjectUndoAction
                })(FloatingObjectUndoActionBase);
            UndoRedo.ResizingFloatingObjectUndoAction = ResizingFloatingObjectUndoAction;
            var ClipboardPasteFloatingObjectUndoAction = (function(_super)
                {
                    __extends(ClipboardPasteFloatingObjectUndoAction, _super);
                    function ClipboardPasteFloatingObjectUndoAction(sheet, floatingObjectExtent, fromSheet)
                    {
                        _super.call(this);
                        this._sheet = keyword_null;
                        this._fromSheet = keyword_null;
                        this._floatingObjectExtent = keyword_null;
                        this._savedObjects = keyword_null;
                        this.OFFSET = 15;
                        var self = this;
                        self._sheet = sheet;
                        self._fromSheet = fromSheet;
                        self._floatingObjectExtent = floatingObjectExtent;
                        self._savedObjects = [];
                        self._activeRowIndex = self._sheet.getActiveRowIndex();
                        self._activeColumnIndex = self._sheet.getActiveColumnIndex()
                    }
                    ClipboardPasteFloatingObjectUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._floatingObjectExtent && self._floatingObjectExtent.names && self._floatingObjectExtent.names.length > 0)
                        {
                            var sheet = self._sheet,
                                eventHandler = self._fromSheet._eventHandler;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            var names = self._floatingObjectExtent.names,
                                newLocations = [],
                                i,
                                len,
                                maxValue = Number.MAX_VALUE,
                                cutX = maxValue,
                                cutY = maxValue;
                            for (i = 0, len = names.length; i < len; i++)
                            {
                                var position = eventHandler._getClipboardFloatingObjectData().findByPropertyName(names[i]).position();
                                cutX = Math_min(cutX, position.x);
                                cutY = Math_min(cutY, position.y)
                            }
                            var relativePotions = [];
                            for (i = 0, len = names.length; i < len; i++)
                            {
                                var position = eventHandler._getClipboardFloatingObjectData().findByPropertyName(names[i]).position();
                                relativePotions.push(new Sheets.Point(position.x - cutX, position.y - cutY))
                            }
                            var pasteX = 0;
                            var pasteY = 0;
                            if (sheet._hasFloatingObjectsSelected())
                            {
                                var minX = maxValue,
                                    minY = maxValue;
                                var floatingObjects = sheet._floatingObjectArray;
                                for (i = 0, len = floatingObjects.length; i < len; i++)
                                {
                                    var floatingObject = floatingObjects[i];
                                    if (floatingObject && floatingObject.isSelected())
                                    {
                                        var position = floatingObject.position();
                                        minX = Math_min(minX, position.x);
                                        minY = Math_min(minY, position.y);
                                        floatingObject.isSelected(false)
                                    }
                                }
                                pasteX = (minX < maxValue) ? minX + self.OFFSET : 0;
                                pasteY = (minY < maxValue) ? minY + self.OFFSET : 0
                            }
                            else
                            {
                                for (var row = 0; row < self._activeRowIndex; row++)
                                {
                                    pasteY += sheet._getActualRowHeight(row, 3)
                                }
                                for (var column = 0; column < self._activeColumnIndex; column++)
                                {
                                    pasteX += sheet._getActualColumnWidth(column, 3)
                                }
                            }
                            for (i = 0, len = names.length; i < len; i++)
                            {
                                var relativePoint = relativePotions[i];
                                newLocations.push(new Sheets.Point(pasteX + relativePoint.x, pasteY + relativePoint.y))
                            }
                            for (i = 0, len = names.length; i < len; i++)
                            {
                                var cloneObj = eventHandler._getClipboardFloatingObjectData().findByPropertyName(names[i]).clone();
                                cloneObj.isVisible(true);
                                cloneObj.name(self._generateFloatingObjectName());
                                cloneObj.position(newLocations[i]);
                                cloneObj.isSelected(true);
                                sheet._addFloatingOjectInternal(cloneObj);
                                self._savedObjects.push(cloneObj)
                            }
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                        }
                    };
                    ClipboardPasteFloatingObjectUndoAction.prototype.refreshUI = function(sender)
                    {
                        var sheetView = this._sheet;
                        if (sheetView)
                        {
                            sheetView.invalidateLayout();
                            sheetView.repaint()
                        }
                    };
                    ClipboardPasteFloatingObjectUndoAction.prototype.canExecute = function(sender)
                    {
                        var self = this;
                        if (!self._sheet.isProtected && self._floatingObjectExtent && self._floatingObjectExtent.names && self._floatingObjectExtent.names.length > 0)
                        {
                            return true
                        }
                        return false
                    };
                    ClipboardPasteFloatingObjectUndoAction.prototype.canUndo = function()
                    {
                        if (this._savedObjects && this._savedObjects.length > 0)
                        {
                            return true
                        }
                        return false
                    };
                    ClipboardPasteFloatingObjectUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._savedObjects && self._savedObjects.length > 0)
                        {
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            for (var i = 0, len = self._savedObjects.length; i < len; i++)
                            {
                                var item = self._savedObjects[i];
                                sheet._removeFloatingObjectInternal(item.name())
                            }
                            self._savedObjects.length = 0;
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                            return true
                        }
                        return false
                    };
                    ClipboardPasteFloatingObjectUndoAction.prototype._generateFloatingObjectName = function()
                    {
                        var prefix = "FloatingObject";
                        var len = this._sheet._floatingObjectArray.length + 1;
                        var newName = prefix + len;
                        while (this._sheet._findFloatingObjectInternal(newName) !== keyword_null)
                        {
                            len++;
                            newName = prefix + len
                        }
                        return newName
                    };
                    return ClipboardPasteFloatingObjectUndoAction
                })(ActionBase);
            UndoRedo.ClipboardPasteFloatingObjectUndoAction = ClipboardPasteFloatingObjectUndoAction;
            var DragCopyFloatingObjectUndoAction = (function(_super)
                {
                    __extends(DragCopyFloatingObjectUndoAction, _super);
                    function DragCopyFloatingObjectUndoAction(sheet, floatingObjectExtent, movingInfo)
                    {
                        _super.call(this);
                        this._sheet = keyword_null;
                        this._floatingObjectExtent = keyword_null;
                        this._savedObjects = keyword_null;
                        this._movingInfo = keyword_null;
                        var self = this;
                        self._sheet = sheet;
                        self._floatingObjectExtent = floatingObjectExtent;
                        self._savedObjects = [];
                        self._movingInfo = movingInfo
                    }
                    DragCopyFloatingObjectUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._floatingObjectExtent && self._floatingObjectExtent.names && self._floatingObjectExtent.names.length > 0 && self._movingInfo)
                        {
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            var i,
                                len;
                            for (i = 0, len = self._floatingObjectExtent.names.length; i < len; i++)
                            {
                                var item = sheet._findFloatingObjectInternal(self._floatingObjectExtent.names[i]);
                                if (item)
                                {
                                    var cloneObj = item.clone();
                                    var position = item.position();
                                    cloneObj.position(new Sheets.Point(position.x + self._movingInfo.offsetX, position.y + self._movingInfo.offsetY));
                                    cloneObj.name(self._generateFloatingObjectName());
                                    cloneObj.isSelected(true);
                                    item.isSelected(false);
                                    sheet._addFloatingOjectInternal(cloneObj);
                                    self._savedObjects.push(cloneObj.name())
                                }
                            }
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                        }
                    };
                    DragCopyFloatingObjectUndoAction.prototype.refreshUI = function(sender)
                    {
                        var sheetView = this._sheet;
                        if (sheetView)
                        {
                            sheetView.invalidateLayout();
                            sheetView.repaint()
                        }
                    };
                    DragCopyFloatingObjectUndoAction.prototype.canExecute = function(sender)
                    {
                        var self = this;
                        if (!self._sheet.isProtected && self._floatingObjectExtent && self._floatingObjectExtent.names && self._floatingObjectExtent.names.length > 0)
                        {
                            return true
                        }
                        return false
                    };
                    DragCopyFloatingObjectUndoAction.prototype.canUndo = function()
                    {
                        if (this._savedObjects && this._savedObjects.length > 0)
                        {
                            return true
                        }
                        return false
                    };
                    DragCopyFloatingObjectUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        if (Sheets.features.floatingObject && self._savedObjects && self._savedObjects.length > 0)
                        {
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            for (var i = 0, len = self._savedObjects.length; i < len; i++)
                            {
                                sheet._removeFloatingObjectInternal(self._savedObjects[i])
                            }
                            self._savedObjects.length = 0;
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                            return true
                        }
                        return false
                    };
                    DragCopyFloatingObjectUndoAction.prototype._generateFloatingObjectName = function()
                    {
                        var prefix = "FloatingObject";
                        var len = this._sheet._floatingObjectArray.length + 1;
                        var newName = prefix + len;
                        while (this._sheet._findFloatingObjectInternal(newName) !== keyword_null)
                        {
                            len++;
                            newName = prefix + len
                        }
                        return newName
                    };
                    return DragCopyFloatingObjectUndoAction
                })(ActionBase);
            UndoRedo.DragCopyFloatingObjectUndoAction = DragCopyFloatingObjectUndoAction;
            var CommentUndoActionBase = (function(_super)
                {
                    __extends(CommentUndoActionBase, _super);
                    function CommentUndoActionBase()
                    {
                        _super.call(this)
                    }
                    CommentUndoActionBase.prototype.init = function(sheet, comment)
                    {
                        this._sheet = sheet;
                        this._comment = comment
                    };
                    CommentUndoActionBase.prototype.refreshUI = function(sender)
                    {
                        var sheetView = this._sheet;
                        if (sheetView)
                        {
                            sheetView.invalidateLayout();
                            sheetView.repaint()
                        }
                    };
                    CommentUndoActionBase.prototype.canExecute = function(sender)
                    {
                        return true
                    };
                    CommentUndoActionBase.prototype.canUndo = function()
                    {
                        if (this._savedComment)
                        {
                            return true
                        }
                        return false
                    };
                    CommentUndoActionBase.prototype.saveState = function()
                    {
                        this._savedComment = this._comment
                    };
                    return CommentUndoActionBase
                })(ActionBase);
            UndoRedo.CommentUndoActionBase = CommentUndoActionBase;
            var CommentDeleteUndoAction = (function(_super)
                {
                    __extends(CommentDeleteUndoAction, _super);
                    function CommentDeleteUndoAction(sheet, comment)
                    {
                        _super.call(this);
                        this.init(sheet, comment)
                    }
                    CommentDeleteUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        self.saveState();
                        var sheet = self._sheet;
                        self._suspendInvalidate(sender);
                        var oldState = sheet.isPaintSuspended();
                        sheet.isPaintSuspended(true);
                        var comment = self._comment,
                            commentManager = sheet._commentManager;
                        sheet.setComment(comment._rowIndex, comment._colIndex, keyword_null);
                        commentManager._activeComment = keyword_null;
                        sheet._loadAndSetSheetSelections();
                        sheet.isPaintSuspended(oldState);
                        var repained = self._resumeInvalidate(sender);
                        if (!repained)
                        {
                            self.refreshUI(sender)
                        }
                    };
                    CommentDeleteUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        if (self._savedComment)
                        {
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            sheet.setComment(self._savedComment._rowIndex, self._savedComment._colIndex, self._savedComment);
                            sheet._saveAndClearSheetSelections();
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                            return true
                        }
                        return false
                    };
                    return CommentDeleteUndoAction
                })(CommentUndoActionBase);
            UndoRedo.CommentDeleteUndoAction = CommentDeleteUndoAction;
            var CommentPropertyUndoAction = (function(_super)
                {
                    __extends(CommentPropertyUndoAction, _super);
                    function CommentPropertyUndoAction(sheet, comment, oldValue, newValue, propertyName)
                    {
                        _super.call(this);
                        var self = this;
                        self.init(sheet, comment);
                        self._oldValue = oldValue;
                        self._newValue = newValue;
                        self._propertyName = propertyName
                    }
                    CommentPropertyUndoAction.prototype.execute = function(sender)
                    {
                        var self = this;
                        if (self._comment)
                        {
                            self.saveState();
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            self._comment._changeProperty(self._propertyName, self._newValue);
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                        }
                    };
                    CommentPropertyUndoAction.prototype.undo = function(sender)
                    {
                        var self = this;
                        if (self._savedComment)
                        {
                            var sheet = self._sheet;
                            self._suspendInvalidate(sender);
                            var oldState = sheet.isPaintSuspended();
                            sheet.isPaintSuspended(true);
                            self._comment._changeProperty(self._propertyName, self._oldValue);
                            sheet.isPaintSuspended(oldState);
                            var repained = self._resumeInvalidate(sender);
                            if (!repained)
                            {
                                self.refreshUI(sender)
                            }
                            return true
                        }
                        return false
                    };
                    return CommentPropertyUndoAction
                })(CommentUndoActionBase);
            UndoRedo.CommentPropertyUndoAction = CommentPropertyUndoAction;
            var CommentUndoTransaction = (function(_super)
                {
                    __extends(CommentUndoTransaction, _super);
                    function CommentUndoTransaction()
                    {
                        _super.call(this);
                        this._commentUndoTransaction = []
                    }
                    CommentUndoTransaction.prototype.execute = function(sender)
                    {
                        var self = this;
                        if (self._commentUndoTransaction && self._commentUndoTransaction.length > 0)
                        {
                            for (var i = 0; i < self._commentUndoTransaction.length; i++)
                            {
                                var action = self._commentUndoTransaction[i];
                                if (action)
                                {
                                    action.execute(sender)
                                }
                            }
                        }
                    };
                    CommentUndoTransaction.prototype.undo = function(sender)
                    {
                        var self = this;
                        if (self._commentUndoTransaction && self._commentUndoTransaction.length > 0)
                        {
                            for (var i = 0; i < self._commentUndoTransaction.length; i++)
                            {
                                var action = self._commentUndoTransaction[i];
                                if (action)
                                {
                                    action.undo(sender)
                                }
                            }
                            return true
                        }
                        return false
                    };
                    CommentUndoTransaction.prototype.add = function(action)
                    {
                        this._commentUndoTransaction.push(action)
                    };
                    return CommentUndoTransaction
                })(ActionBase);
            UndoRedo.CommentUndoTransaction = CommentUndoTransaction
        })(Sheets.UndoRedo || (Sheets.UndoRedo = {}));
        var UndoRedo = Sheets.UndoRedo
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.sheet_event", ["core.migrate", "core.common", "core.sheet_action", "core.stringResource"]);
        var keyword_null = null,
            keyword_undefined = undefined,
            Math_max = Math.max,
            Math_min = Math.min,
            Math_abs = Math.abs,
            Math_ceil = Math.ceil,
            const_undefined = "undefined",
            cssPosition = "position",
            cssAbsolute = "absolute",
            cssBorder = "border",
            cssBorderRadius = "border-radius",
            cssPadding = "padding",
            cssBoxShadow = "box-shadow",
            cssFont = "font",
            cssBackgroundColor = "background-color",
            cssOverflow = "overflow",
            cssTop = "top",
            cssLeft = "left",
            cssZIndex = "z-index",
            cssOutline = "outline",
            cssWidth = "width",
            cssHeight = "height",
            cssResize = "resize",
            cssHidden = "hidden",
            cssVisible = "visible",
            cssAuto = "auto",
            cssWhite = "white",
            cssNone = "none",
            attrTabIndex = "tabindex",
            attrSize = "size",
            attrGcUIElement = "gcUIElement";
        var document = window.document;
        var _SheetEventHandler = (function()
            {
                function _SheetEventHandler(sheet)
                {
                    this.RESIZETOOLTIP_TOP = 30;
                    this.DRAGDROPTOOLTIP_OFFSET = 5;
                    this.DRAGFILLTOOLTIP_OFFSET = 3;
                    this.VSCROLLTOOLTIP_LEFT = 100;
                    this.HSCROLLTOOLTIP_LEFT = 30;
                    this.HSCROLLTOOLTIP_TOP = 40;
                    this._clipboardFloatingObjectData = keyword_null;
                    this._repeatKeyDownTimeoutID = 0;
                    this.waittime = 100;
                    this.newLeft = 0;
                    this.newTop = 0;
                    this._focusReleased = false;
                    this._init(sheet)
                }
                _SheetEventHandler.prototype._init = function(sheet)
                {
                    this._sheet = sheet;
                    this._elem = keyword_null;
                    this._eventSuspended = 0
                };
                _SheetEventHandler.prototype._getElem = function()
                {
                    if (!this._elem)
                    {
                        this._elem = document.createElement("input")
                    }
                    return this._elem
                };
                _SheetEventHandler.prototype._dispose = function()
                {
                    var self = this;
                    if (self._hScrollTimer)
                    {
                        self._hScrollTimer._dispose()
                    }
                    if (self._vScrollTimer)
                    {
                        self._vScrollTimer._dispose()
                    }
                };
                _SheetEventHandler.prototype._getHScrollTimer = function()
                {
                    var self = this;
                    if (!self._hScrollTimer)
                    {
                        self._hScrollTimer = new Sheets.Timer(self)
                    }
                    return self._hScrollTimer
                };
                _SheetEventHandler.prototype._getVScrollTimer = function()
                {
                    var self = this;
                    if (!self._vScrollTimer)
                    {
                        self._vScrollTimer = new Sheets.Timer(self)
                    }
                    return self._vScrollTimer
                };
                _SheetEventHandler.prototype.doResize = function()
                {
                    var sheet = this._sheet;
                    var canvas = sheet._getCanvas();
                    if (!canvas || !canvas.parentNode)
                    {
                        return
                    }
                    var computedStyle = getComputedStyle(canvas.parentNode);
                    var parentWidthCss = computedStyle.width;
                    var parentHeightCss = computedStyle.height;
                    var pxIndex = parentWidthCss.indexOf("px");
                    if (pxIndex > 0)
                    {
                        parentWidthCss = parentWidthCss.substring(0, pxIndex)
                    }
                    pxIndex = parentHeightCss.indexOf("px");
                    if (pxIndex > 0)
                    {
                        parentHeightCss = parentHeightCss.substring(0, pxIndex)
                    }
                    var parentWidth = parseInt(parentWidthCss);
                    var parentHeight = parseInt(parentHeightCss);
                    if (isNaN(parentWidth))
                    {
                        parentWidth = $(canvas.parentNode).width()
                    }
                    if (isNaN(parentHeight))
                    {
                        parentHeight = $(canvas.parentNode).height()
                    }
                    if (parentWidth === 0 || parentHeight === 0)
                    {
                        return
                    }
                    var deltx = 0;
                    var delty = 0;
                    var width,
                        height;
                    canvas.style.display = cssNone;
                    width = Math_max(parentWidth - deltx, 0);
                    height = Math_max(parentHeight - delty, 0);
                    canvas.style.display = "";
                    canvas.width = width;
                    canvas.height = height;
                    canvas.style.width = width + "px";
                    canvas.style.height = height + "px";
                    width = canvas.clientWidth || canvas.width;
                    height = canvas.clientHeight || canvas.height;
                    sheet._bounds.width = width;
                    sheet._bounds.height = height;
                    Sheets.DPIHelper.setSize(canvas, width, height);
                    if (!sheet._paintSuspended)
                    {
                        sheet.invalidateLayout();
                        sheet.repaint()
                    }
                };
                _SheetEventHandler.prototype._getCanvasOffset = function()
                {
                    var sheet = this._sheet;
                    var t = $(sheet._getCanvas()).offset();
                    if (t)
                    {
                        if (!isNaN(document.body.clientTop))
                        {
                            t.top += document.body.clientTop
                        }
                        if (!isNaN(document.body.clientLeft))
                        {
                            t.left += document.body.clientLeft
                        }
                    }
                    else
                    {
                        t = {
                            top: 0, left: 0
                        }
                    }
                    if (window.gcGlobal.canvasOffset)
                    {
                        t = window.gcGlobal.canvasOffset
                    }
                    return t
                };
                _SheetEventHandler.prototype._getCanvasPosition = function()
                {
                    var sheet = this._sheet;
                    var p = $(sheet._getCanvas()).position();
                    if (!p)
                    {
                        p = {
                            top: 0, left: 0
                        }
                    }
                    return p
                };
                _SheetEventHandler.prototype.doMouseDown = function(e)
                {
                    if (e.button === 2)
                    {
                        return true
                    }
                    var self = this;
                    var sheet = self._sheet;
                    if (!sheet.inCanvas)
                    {
                        self.handleDocumentMouseMove()
                    }
                    if ($.browser && $.browser.msie && e.offsetX !== keyword_undefined && e.offsetY !== keyword_undefined)
                    {
                        var canvasOffsetLeft = e.pageX - e.offsetX,
                            canvasOffsetTop = e.pageY - e.offsetY;
                        window.gcGlobal.canvasOffset = {
                            top: canvasOffsetTop, left: canvasOffsetLeft
                        }
                    }
                    var t = self._getCanvasOffset();
                    var ret = self.doMouseDownImp(e, e.pageX - t.left, e.pageY - t.top);
                    if (!sheet.isEditing() && !ret)
                    {
                        self.setFocus()
                    }
                    sheet._isMouseDownInSheet = true;
                    return false
                };
                _SheetEventHandler.prototype.handleDocumentMouseMove = function()
                {
                    var self = this;
                    if (!self._isMouseCapture)
                    {
                        $(document).bind("mousemove.gcSheet", function(e)
                        {
                            self.doMouseMove(e)
                        }).bind("mouseup.gcSheet", function(e)
                        {
                            self.doMouseUp(e)
                        });
                        self._isMouseCapture = true
                    }
                };
                _SheetEventHandler.prototype.unhandleDocumentMouseMove = function()
                {
                    if (this._isMouseCapture)
                    {
                        this._isMouseCapture = false;
                        $(document).unbind("mousemove.gcSheet").unbind("mouseup.gcSheet")
                    }
                };
                _SheetEventHandler.prototype.doMouseDownImp = function(e, x, y)
                {
                    var self = this,
                        sheet = self._sheet,
                        target = sheet.hitTest(x, y),
                        r = target.row,
                        c = target.col,
                        hitInfo = target.groupHitInfo,
                        dragInfo = target.dragInfo,
                        filterButtonHitInfo = target.filterButtonHitInfo,
                        frInfo = target.formulaRangeHitInfo,
                        cellTypeHitInfo = target.cellTypeHitInfo;
                    if (typeof sheet.unSelectAllFloatingObjects === 'function')
                    {
                        sheet.unSelectAllFloatingObjects()
                    }
                    var commentManager = sheet._commentManager;
                    if (commentManager)
                    {
                        commentManager.deactivateComment()
                    }
                    if (hitInfo)
                    {
                        if (!sheet.isEditing())
                        {
                            self._doClickRangeGroup(hitInfo)
                        }
                    }
                    else
                    {
                        sheet._currentTarget = target;
                        self.isMouseDown = true;
                        if (target.resizeInfo)
                        {
                            if (!sheet.endEdit())
                            {
                                return
                            }
                            self.startResizing(target)
                        }
                        else if (dragInfo && dragInfo.side && dragInfo.side !== "corner")
                        {
                            if (!sheet.endEdit())
                            {
                                return
                            }
                            self.startDragDropping(target)
                        }
                        else if (dragInfo && dragInfo.side === "corner")
                        {
                            if (!sheet.endEdit())
                            {
                                return
                            }
                            self.startDragFill(target)
                        }
                        else if (filterButtonHitInfo)
                        {
                            if (!sheet.endEdit())
                            {
                                return
                            }
                            if (!filterButtonHitInfo || !filterButtonHitInfo.rowFilter)
                            {
                                return
                            }
                            filterButtonHitInfo.rowFilter.openFilterDialog(filterButtonHitInfo)
                        }
                        else if (frInfo)
                        {
                            if (frInfo.inBorder)
                            {
                                self.startFormulaRangeMoving(target)
                            }
                            else if (frInfo.inTopLeft || frInfo.inTopRight || frInfo.inBottomLeft || frInfo.inBottomRight)
                            {
                                self.startFormulaRangeResizing(target)
                            }
                        }
                        else
                        {
                            var fbx = sheet._formulaTextBox;
                            if (fbx && fbx.canAppendRange())
                            {
                                self.startFormulaRangeAppending(target);
                                return
                            }
                            else if (self._clearFormulaTextbox(sheet))
                            {
                                return
                            }
                            var oldActiveRow = sheet.getActiveRowIndex();
                            var oldActiveCol = sheet.getActiveColumnIndex();
                            if (cellTypeHitInfo)
                            {
                                var sheetArea = cellTypeHitInfo.sheetArea;
                                if ((sheetArea === keyword_null || sheetArea === keyword_undefined || sheetArea === 3) && (r !== oldActiveRow || c !== oldActiveCol))
                                {
                                    var oldState = sheet.isPaintSuspended();
                                    sheet.isPaintSuspended(true);
                                    try
                                    {
                                        if (!sheet.endEdit())
                                        {
                                            return
                                        }
                                        var args = {
                                                sheet: sheet, sheetName: sheet._name, row: oldActiveRow, col: oldActiveCol, cancel: false
                                            };
                                        sheet.triggerLeaveCell(args);
                                        if (args && args.cancel === true)
                                        {
                                            return
                                        }
                                        var oldSels = sheet._selectionModel.toArray();
                                        var newSels = null;
                                        var span = sheet._getSpanModel().find(r, c);
                                        if (span)
                                        {
                                            newSels = [new Sheets.Range(span.row, span.col, span.rowCount, span.colCount)]
                                        }
                                        else
                                        {
                                            newSels = [new Sheets.Range(r, c, 1, 1)]
                                        }
                                        sheet.triggerSelectionChanging({
                                            sheet: sheet, sheetName: sheet._name, oldSelections: oldSels, newSelections: newSels
                                        });
                                        sheet._setActiveCellAndSelection(r, c, keyword_undefined, keyword_undefined, 1);
                                        sheet.triggerEnterCell({
                                            sheet: sheet, sheetName: sheet._name, row: r, col: c
                                        });
                                        sheet.triggerSelectionChanged({
                                            sheet: sheet, sheetName: sheet._name
                                        });
                                        self._updateValidationUI(r, c)
                                    }
                                    finally
                                    {
                                        sheet.isPaintSuspended(oldState)
                                    }
                                }
                                var ct = sheet.getCellType(r, c, target.hitTestType);
                                if (!cellTypeHitInfo.sheet)
                                {
                                    cellTypeHitInfo.sheet = sheet
                                }
                                ct.processMouseDown(cellTypeHitInfo)
                            }
                            if (cellTypeHitInfo && cellTypeHitInfo.isReservedLocation)
                            {
                                return true
                            }
                            else
                            {
                                self.setMetaKeyState(e);
                                try
                                {
                                    self._hitTestResult = target;
                                    if (sheet.isEditing() && oldActiveRow === sheet.getActiveRowIndex() && oldActiveCol === sheet.getActiveColumnIndex() && !sheet.endEdit())
                                    {
                                        return
                                    }
                                }
                                finally
                                {
                                    self._hitTestResult = keyword_null
                                }
                                if (r === keyword_undefined || r === keyword_null || c === keyword_undefined || c === keyword_null)
                                {
                                    return
                                }
                                if (target.hitTestType === 3)
                                {
                                    self._updateValidationUI(r, c)
                                }
                                var oldSelections = sheet._selectionModel.toArray();
                                self.startSelecting(target);
                                var newSelections = sheet._selectionModel.toArray();
                                if (self._notEqualSelecions(oldSelections, newSelections))
                                {
                                    sheet.triggerSelectionChanging({
                                        sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                                    })
                                }
                            }
                        }
                    }
                };
                _SheetEventHandler.prototype._clearFormulaTextbox = function(sheet)
                {
                    var crossSheet = false;
                    var ftbInfo = Sheets.features.formulatextbox && Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                    if (ftbInfo && ftbInfo.dom)
                    {
                        var orginalSheet = ftbInfo.sheet;
                        var formulaTextBox = sheet._formulaTextBox;
                        if (formulaTextBox)
                        {
                            orginalSheet.setFormula(ftbInfo.rowIndex, ftbInfo.columnIndex, formulaTextBox.text())
                        }
                        if (orginalSheet !== sheet)
                        {
                            Sheets.SpreadActions.changeSheetForFormulaTextboxAcrossSheet(orginalSheet);
                            orginalSheet.endEdit();
                            crossSheet = true
                        }
                        else
                        {
                            if (formulaTextBox)
                            {
                                formulaTextBox.destroy();
                                sheet._formulaTextBox = keyword_null
                            }
                            ftbInfo.clear()
                        }
                    }
                    return crossSheet
                };
                _SheetEventHandler.prototype._doClickRangeGroup = function(hitInfo)
                {
                    var sheet = this._sheet;
                    if (!sheet || !hitInfo || !Sheets.features.group)
                    {
                        return
                    }
                    var info = hitInfo.info,
                        level,
                        args,
                        action,
                        index,
                        isExpanded;
                    if (hitInfo.what === "rgh")
                    {
                        if (sheet && !sheet.isEditing())
                        {
                            level = info.index;
                            args = {
                                sheet: sheet, sheetName: sheet._name, isRowGroup: true, index: -1, level: level, cancel: false
                            };
                            sheet.triggerRangeGroupStateChanging(args);
                            if (args && args.cancel === false)
                            {
                                action = new Sheets.UndoRedo.RowGroupHeaderExpandUndoAction(sheet, {level: level});
                                sheet._doCommand(action);
                                sheet.triggerRangeGroupStateChanged({
                                    sheet: sheet, sheetName: sheet._name, isRowGroup: true, index: -1, level: level
                                })
                            }
                        }
                    }
                    else if (hitInfo.what === "cgh")
                    {
                        if (!sheet.isEditing())
                        {
                            level = info.index;
                            args = {
                                sheet: sheet, sheetName: sheet._name, isRowGroup: false, index: -1, level: level, cancel: false
                            };
                            sheet.triggerRangeGroupStateChanging(args);
                            if (args && args.cancel === false)
                            {
                                action = new Sheets.UndoRedo.ColumnGroupHeaderExpandUndoAction(sheet, {level: level});
                                sheet._doCommand(action);
                                sheet.triggerRangeGroupStateChanged({
                                    sheet: sheet, sheetName: sheet._name, isRowGroup: false, index: -1, level: level
                                })
                            }
                        }
                    }
                    else if (hitInfo.what === "rg")
                    {
                        if (sheet.rowRangeGroup)
                        {
                            index = info.index;
                            isExpanded = info.isExpanded;
                            if (info.lineDirection === 1)
                            {
                                index--
                            }
                            else
                            {
                                index++
                            }
                            args = {
                                sheet: sheet, sheetName: sheet._name, isRowGroup: true, index: index, level: info.level, cancel: false
                            };
                            sheet.triggerRangeGroupStateChanging(args);
                            if (args && args.cancel === false)
                            {
                                var rowGroupExpandUndoAction = new Sheets.UndoRedo.RowGroupExpandUndoAction(sheet, {
                                        index: info.index, level: info.level, collapsed: isExpanded
                                    });
                                sheet._doCommand(rowGroupExpandUndoAction);
                                sheet.triggerRangeGroupStateChanged({
                                    sheet: sheet, sheetName: sheet._name, isRowGroup: true, index: index, level: info.level
                                })
                            }
                        }
                    }
                    else if (hitInfo.what === "cg")
                    {
                        if (sheet.colRangeGroup)
                        {
                            index = info.index;
                            isExpanded = info.isExpanded;
                            if (info.lineDirection === 1)
                            {
                                index--
                            }
                            else
                            {
                                index++
                            }
                            args = {
                                sheet: sheet, sheetName: sheet._name, isRowGroup: false, index: index, level: info.level, cancel: false
                            };
                            sheet.triggerRangeGroupStateChanging(args);
                            if (args && args.cancel === false)
                            {
                                var columnGroupExpandUndoAction = new Sheets.UndoRedo.ColumnGroupExpandUndoAction(sheet, {
                                        index: info.index, level: info.level, collapsed: isExpanded
                                    });
                                sheet._doCommand(columnGroupExpandUndoAction);
                                sheet.triggerRangeGroupStateChanged({
                                    sheet: sheet, sheetName: sheet._name, isRowGroup: false, index: index, level: info.level
                                })
                            }
                        }
                    }
                };
                _SheetEventHandler.prototype._isInvalidRect = function(rect)
                {
                    var sheet = this._sheet;
                    if (!sheet)
                    {
                        return true
                    }
                    var sheetLayout = sheet._getSheetLayout();
                    return rect.x === keyword_null || rect.x === keyword_undefined || rect.y === keyword_null || rect.y === keyword_undefined || rect.width === keyword_null || rect.width === keyword_undefined || rect.height === keyword_null || rect.height === keyword_undefined || rect.x + rect.width > sheetLayout.viewportX + sheetLayout.viewportWidth + sheetLayout.frozenTrailingWidth || rect.y + rect.height > sheetLayout.viewportY + sheetLayout.viewportHeight + sheetLayout.frozenTrailingHeight
                };
                _SheetEventHandler.prototype._commitSelectValue = function(select, row, col, validList)
                {
                    var sheet = this._sheet,
                        newValue;
                    for (var i = 0, options = select.options, len = options.length; i < len; i++)
                    {
                        var op = options[i];
                        if (op.selected)
                        {
                            newValue = validList[i].value;
                            break
                        }
                    }
                    var actualLocked = false;
                    if (sheet.isProtected)
                    {
                        var style = sheet.getActualStyle(row, col);
                        if (style)
                        {
                            actualLocked = style.locked
                        }
                    }
                    if (newValue !== keyword_null && newValue !== keyword_undefined && !actualLocked)
                    {
                        var cellEditInfo = {
                                row: row, col: col, newValue: newValue, autoFormat: true
                            };
                        var undoAction = new Sheets.UndoRedo.CellEditUndoAction(sheet, cellEditInfo);
                        sheet._doCommand(undoAction)
                    }
                    $(select).hide()
                };
                _SheetEventHandler.prototype._updateValidationUI = function(row, col)
                {
                    var self = this;
                    var sheet = self._sheet,
                        sheetParent = (sheet && sheet.parent);
                    if (!sheetParent || !Sheets.features.dataValidator)
                    {
                        return
                    }
                    var disposed = sheet._disposeValidationUI();
                    if (!disposed)
                    {
                        return
                    }
                    var activeSheet = sheetParent.getActiveSheet();
                    if (!activeSheet || sheet.getName() !== activeSheet.getName())
                    {
                        return
                    }
                    var dv = sheet.getDataValidator(row, col);
                    if (!dv)
                    {
                        return
                    }
                    var offset = self._getCanvasOffset();
                    var rect = sheet.getCellRect(row, col);
                    if (self._isInvalidRect(rect))
                    {
                        return
                    }
                    var zIndex = Sheets.util.getPreferredZIndex(sheetParent.getHost());
                    if (dv && dv.showInputMessage && dv.inputMessage)
                    {
                        var span = document.createElement("span");
                        $(span).css(cssPosition, cssAbsolute).css(cssBorder, "1px #C0C0C0 solid").css(cssPadding, "3px 8px 3px 8px").css(cssBackgroundColor, "#FFFFFF").css(cssBoxShadow, "1px 2px 5px rgba(0,0,0,0.4)").css(cssFont, "normal normal normal 12px/normal Arial").width(cssAuto).height(cssAuto).css(cssTop, rect.y + rect.height + offset.top + 5).css(cssLeft, rect.x + rect.width / 2 + offset.left).css(cssZIndex, zIndex).html("<b>" + dv.inputTitle + "</b><br/>" + dv.inputMessage).attr(attrGcUIElement, "gcValidationInputMessage").appendTo(document.body);
                        sheet._validationInputMessage = span
                    }
                    if (dv && dv.type === 3 && dv.inCellDropdown)
                    {
                        var validList = dv.condition.getValidListImp(sheet, row, col);
                        var length = validList.length;
                        var select = document.createElement("select");
                        var cellValue = sheet.getValue(row, col);
                        var selectedIndex = -1;
                        var innerHtml = "";
                        for (var i = 0; i < length; i++)
                        {
                            var v = validList[i].text;
                            if (v === keyword_null || v === keyword_undefined || (Sheets.util.hasCalc() && v instanceof Sheets.Calc.CalcError))
                            {
                                continue
                            }
                            if (selectedIndex < 0 && v === cellValue)
                            {
                                selectedIndex = i
                            }
                            if (v instanceof Date)
                            {
                                v = new Sheets._DateTimeHelper(v).localeFormat("M/d/yyyy h:mm:ss")
                            }
                            innerHtml += "<option value=\"" + v + "\">" + v + "</option>"
                        }
                        if ($.browser.msie && parseInt($.browser.version, 10) < 10)
                        {
                            $(select).html(innerHtml)
                        }
                        else
                        {
                            select.innerHTML = innerHtml
                        }
                        select.selectedIndex = selectedIndex > 0 ? selectedIndex : 0;
                        var cellStyle = sheet.getActualStyle(row, col),
                            render = sheet._render;
                        var font = (cellStyle && cellStyle.font) ? cellStyle.font : render._getDefaultFont();
                        if (sheet._zoomFactor > 1)
                        {
                            font = render._getZoomFont(font)
                        }
                        var spans = sheet.getSpans(new Sheets.Range(row, col, 1, 1));
                        var colSpan = 1;
                        if (spans && spans.length > 0)
                        {
                            if (spans[0])
                            {
                                colSpan = spans[0].colCount
                            }
                        }
                        var isLastColumn = ((col + colSpan - 1) === sheet.getColumnCount() - 1);
                        var buttonSize = sheet.getRowHeight(row) * sheet._zoomFactor;
                        var useTouchLayout = sheet.parent && sheet.parent.useTouchLayout();
                        if (useTouchLayout)
                        {
                            buttonSize = Math_min(50, buttonSize)
                        }
                        else
                        {
                            buttonSize = Math_min(15, buttonSize)
                        }
                        var device = Sheets.util.device(),
                            isSafariOnIpad = $.browser.safari && (device.ipad || device.iphone);
                        var selectWidth,
                            selectHeight,
                            selectTop,
                            selectLeft,
                            backgroundColor;
                        if (isSafariOnIpad)
                        {
                            selectWidth = rect.width + 3;
                            selectHeight = rect.height + 3;
                            selectTop = rect.y + offset.top - 1.5;
                            selectLeft = rect.x + offset.left - 1.5;
                            backgroundColor = cssWhite
                        }
                        else
                        {
                            selectWidth = Math_max(rect.width + (isLastColumn ? 0 : buttonSize), sheet.defaults.colWidth);
                            selectHeight = length > 8 ? 140 : cssAuto;
                            selectTop = rect.y + rect.height + offset.top;
                            selectLeft = rect.x + rect.width + offset.left + (isLastColumn ? 0 : buttonSize) - selectWidth;
                            backgroundColor = ""
                        }
                        var $select = $(select).css(cssOutline, cssNone).css(cssPosition, cssAbsolute).css(cssFont, font).css(cssZIndex, zIndex).css(cssBackgroundColor, backgroundColor).width(selectWidth).height(selectHeight).css(cssTop, selectTop).css(cssLeft, selectLeft).attr(attrGcUIElement, "gcValidationSelect").appendTo(document.body).attr(attrSize, length > 2 ? length : 2).hide().bind("click", function()
                            {
                                self._commitSelectValue(select, row, col, validList);
                                if (isSafariOnIpad)
                                {
                                    $(sheet._validationButton).show()
                                }
                            }).bind("keydown", function(event)
                            {
                                if (event.keyCode === 13 && !event.ctrlKey && !event.shiftKey && !event.altKey)
                                {
                                    self._commitSelectValue(select, row, col, validList)
                                }
                                else if (event.keyCode === 27 && !event.ctrlKey && !event.shiftKey && !event.altKey)
                                {
                                    $(select).hide()
                                }
                                if (isSafariOnIpad)
                                {
                                    $(sheet._validationButton).show()
                                }
                            });
                        if (isSafariOnIpad)
                        {
                            $select.bind("blur", function(event)
                            {
                                self._commitSelectValue(select, row, col, validList);
                                $(sheet._validationButton).show()
                            })
                        }
                        sheet._validationSelect = select;
                        var button = document.createElement("input");
                        button.type = "image";
                        button.src = Sheets.DefaultDataValidator.getImageSrc();
                        button.alt = "v";
                        $(button).css(cssPosition, cssAbsolute).width(buttonSize).height(buttonSize).css(cssTop, rect.y + rect.height + offset.top - (buttonSize + 3)).css(cssLeft, rect.x + rect.width + offset.left - (isLastColumn ? buttonSize : 0)).css(cssZIndex, zIndex).css(cssBackgroundColor, cssWhite).css(cssBorder, "1px solid gray").attr(attrGcUIElement, "gcValidationButton").appendTo(document.body).click(function()
                        {
                            if (sheet.isEditing())
                            {
                                sheet.endEdit()
                            }
                            $(sheet._validationSelect).toggle().focus();
                            if (isSafariOnIpad)
                            {
                                $(sheet._validationButton).toggle()
                            }
                        });
                        sheet._validationButton = button
                    }
                };
                _SheetEventHandler.prototype.startScroll = function()
                {
                    var self = this;
                    if (!self.startHitInfo)
                    {
                        return
                    }
                    var hitType = self.startHitInfo.hitTestType;
                    if (hitType === 3 || hitType === 2)
                    {
                        self._getVScrollTimer().setAction(self.processVSScrolled)
                    }
                    if (hitType === 3 || hitType === 1)
                    {
                        self._getHScrollTimer().setAction(self.processHSScrolled)
                    }
                };
                _SheetEventHandler.prototype.processVSScrolled = function(increase)
                {
                    var self = this;
                    var adjusted = self.adjustScrollRowViewport();
                    if (!adjusted)
                    {
                        var hi = self.startHitInfo;
                        var sheet = self._sheet;
                        var rowViewportIndex = hi.scrollRowViewportIndex;
                        var topRow = sheet.getViewportTopRow(rowViewportIndex);
                        var bottomRow = sheet.getViewportBottomRow(rowViewportIndex);
                        if (increase)
                        {
                            if (bottomRow < sheet.getRowCount() - sheet._frozenTrailingRowCount - 1)
                            {
                                sheet._setTopRow(sheet._getNextVisualRow(topRow))
                            }
                            else
                            {
                                var rowLayoutModel = sheet._getRowLayout(rowViewportIndex);
                                if (rowLayoutModel && rowLayoutModel.length > 0)
                                {
                                    var layout = sheet._getSheetLayout();
                                    var lastRow = rowLayoutModel[rowLayoutModel.length - 1];
                                    if (lastRow.y + lastRow.height >= layout.viewportY + layout.viewportHeight)
                                    {
                                        sheet._setTopRow(sheet._getNextVisualRow(topRow))
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (topRow > sheet.frozenRowCount)
                            {
                                sheet._setTopRow(sheet._getPrevVisualRow(topRow))
                            }
                        }
                    }
                    if (self.isSelecting)
                    {
                        self.continueSelecting()
                    }
                    if (self.isDragDropping)
                    {
                        self.continueDragDropping()
                    }
                    if (self.isDraggingFill)
                    {
                        self.continueDragFill()
                    }
                    if (self.isFormulaRangeAppending)
                    {
                        self.continueFormulaRangeAppending()
                    }
                    if (self.isFormulaRangeMoving)
                    {
                        self.continueFormulaRangeMoving()
                    }
                    if (self.isFormulaRangeResizing)
                    {
                        self.continueFormulaRangeResizing()
                    }
                };
                _SheetEventHandler.prototype.processHSScrolled = function(increase)
                {
                    var self = this;
                    var adjusted = self.adjustScrollColViewport();
                    if (!adjusted)
                    {
                        var sheet = self._sheet;
                        var hi = self.startHitInfo;
                        var colViewportIndex = hi.scrollColViewportIndex;
                        var leftCol = sheet.getViewportLeftColumn(colViewportIndex);
                        var rightCol = sheet.getViewportRightColumn(colViewportIndex);
                        if (increase)
                        {
                            if (rightCol < sheet.getColumnCount() - sheet._frozenTrailingColCount - 1)
                            {
                                sheet._setLeftColumn(sheet._getNextVisualColumn(leftCol))
                            }
                            else
                            {
                                var colLayoutModel = sheet._getColumnLayout(colViewportIndex);
                                if (colLayoutModel && colLayoutModel.length > 0)
                                {
                                    var layout = sheet._getSheetLayout();
                                    var lastCol = colLayoutModel[colLayoutModel.length - 1];
                                    if (lastCol.x + lastCol.width >= layout.viewportX + layout.viewportWidth)
                                    {
                                        sheet._setLeftColumn(sheet._getNextVisualColumn(leftCol))
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (leftCol > sheet.frozenColCount)
                            {
                                sheet._setLeftColumn(sheet._getPrevVisualColumn(leftCol))
                            }
                        }
                    }
                    if (self.isSelecting)
                    {
                        self.continueSelecting()
                    }
                    if (self.isDragDropping)
                    {
                        self.continueDragDropping()
                    }
                    if (self.isDraggingFill)
                    {
                        self.continueDragFill()
                    }
                    if (self.isFormulaRangeAppending)
                    {
                        self.continueFormulaRangeAppending()
                    }
                    if (self.isFormulaRangeMoving)
                    {
                        self.continueFormulaRangeMoving()
                    }
                    if (self.isFormulaRangeResizing)
                    {
                        self.continueFormulaRangeResizing()
                    }
                };
                _SheetEventHandler.prototype.adjustScrollRowViewport = function()
                {
                    var sheet = this._sheet;
                    var layout = sheet._getSheetLayout();
                    var mousePosition = this.mousePosition;
                    var hi = this.startHitInfo;
                    var rowViewportIndex = hi.scrollRowViewportIndex;
                    if (rowViewportIndex === 0)
                    {
                        if (mousePosition.y > layout.viewportY)
                        {
                            sheet._setTopRow(sheet._getFirstPageTopRow());
                            hi.scrollRowViewportIndex = 1;
                            return true
                        }
                    }
                    else if (rowViewportIndex === 1)
                    {
                        var rowLayoutModel = sheet._getRowLayout(1);
                        if (rowLayoutModel && rowLayoutModel.length > 0)
                        {
                            var rowLayout = rowLayoutModel[0];
                            if (sheet.frozenRowCount > 0 && mousePosition.y < layout.viewportY && rowLayout.row <= sheet._getFirstPageTopRow())
                            {
                                hi.scrollRowViewportIndex = 0;
                                return true
                            }
                            rowLayout = rowLayoutModel[rowLayoutModel.length - 1];
                            if (sheet._frozenTrailingRowCount > 0 && mousePosition.y > layout.frozenTrailingY && rowLayout.row >= sheet._getLastVisualRow() && rowLayout.y + rowLayout.height <= layout.frozenTrailingY)
                            {
                                hi.scrollRowViewportIndex = 2;
                                return true
                            }
                        }
                    }
                    else if (rowViewportIndex === 2)
                    {
                        var rowLayoutModel = sheet._getRowLayout(1);
                        if (rowLayoutModel && rowLayoutModel.length > 0 && mousePosition.y < layout.frozenTrailingY)
                        {
                            var rowLayout = rowLayoutModel[rowLayoutModel.length - 1];
                            if (rowLayout.y + rowLayout.height > layout.frozenTrailingY)
                            {
                                var viewportHeight = layout.viewportHeight;
                                var newTopRow = sheet.getRowCount() - sheet._frozenTrailingRowCount - 1;
                                var height = 0;
                                for (var r = newTopRow; r >= sheet.frozenRowCount; r--)
                                {
                                    height += sheet._getZoomRowHeight(r);
                                    if (height > viewportHeight)
                                    {
                                        newTopRow = Math_min(r + 1, newTopRow);
                                        break
                                    }
                                }
                                sheet._setTopRow(sheet._getNextVisualRow(newTopRow - 1))
                            }
                            hi.scrollRowViewportIndex = 1;
                            return true
                        }
                    }
                    return false
                };
                _SheetEventHandler.prototype.adjustScrollColViewport = function()
                {
                    var sheet = this._sheet;
                    var layout = sheet._getSheetLayout();
                    var mousePosition = this.mousePosition;
                    var hi = this.startHitInfo;
                    var colViewportIndex = hi.scrollColViewportIndex;
                    if (colViewportIndex === 0)
                    {
                        if (mousePosition.x > layout.viewportX)
                        {
                            sheet._setLeftColumn(sheet._getFirstPageLeftColumn());
                            hi.scrollColViewportIndex = 1;
                            return true
                        }
                    }
                    else if (colViewportIndex === 1)
                    {
                        var colLayoutModel = sheet._getColumnLayout(1);
                        if (colLayoutModel && colLayoutModel.length > 0)
                        {
                            var colLayout = colLayoutModel[0];
                            if (sheet.frozenColCount > 0 && mousePosition.x < layout.viewportX && colLayout.col <= sheet._getFirstPageLeftColumn())
                            {
                                hi.scrollColViewportIndex = 0;
                                return true
                            }
                            colLayout = colLayoutModel[colLayoutModel.length - 1];
                            if (sheet._frozenTrailingColCount > 0 && mousePosition.x > layout.frozenTrailingX && colLayout.col >= sheet._getLastVisualColumn() && colLayout.x + colLayout.width <= layout.frozenTrailingX)
                            {
                                hi.scrollColViewportIndex = 2;
                                return true
                            }
                        }
                    }
                    else if (colViewportIndex === 2)
                    {
                        var colLayoutModel = sheet._getColumnLayout(1);
                        if (colLayoutModel && colLayoutModel.length > 0 && mousePosition.x < layout.frozenTrailingX)
                        {
                            var colLayout = colLayoutModel[colLayoutModel.length - 1];
                            if (colLayout.x + colLayout.width > layout.frozenTrailingX)
                            {
                                var viewportWidth = layout.viewportWidth;
                                var newLeftColumn = sheet.getColumnCount() - sheet._frozenTrailingColCount - 1;
                                var width = 0;
                                for (var c = newLeftColumn; c >= sheet.frozenColCount; c--)
                                {
                                    width += sheet._getZoomColumnWidth(c);
                                    if (width > viewportWidth)
                                    {
                                        newLeftColumn = Math_min(c + 1, newLeftColumn);
                                        break
                                    }
                                }
                                sheet._setLeftColumn(sheet._getNextVisualColumn(newLeftColumn - 1))
                            }
                            hi.scrollColViewportIndex = 1;
                            return true
                        }
                    }
                    return false
                };
                _SheetEventHandler.prototype.continueScroll = function()
                {
                    var self = this;
                    if (!self.isWorking && !self.isFloatingObjectWorking && !self.isCommentWorking)
                    {
                        return
                    }
                    var sheet = self._sheet;
                    var layout = sheet._getSheetLayout();
                    var hi = self.startHitInfo;
                    var rowViewportIndex = hi.scrollRowViewportIndex;
                    var colViewportIndex = hi.scrollColViewportIndex;
                    var mousePosition = self.mousePosition;
                    var viewportRect = keyword_null;
                    if (rowViewportIndex >= 0 && colViewportIndex >= 0)
                    {
                        viewportRect = layout.viewportRect(rowViewportIndex, colViewportIndex)
                    }
                    else if (rowViewportIndex >= 0)
                    {
                        viewportRect = layout.rowHeaderRect(rowViewportIndex)
                    }
                    else if (colViewportIndex >= 0)
                    {
                        viewportRect = layout.colHeaderRect(colViewportIndex)
                    }
                    if (viewportRect)
                    {
                        var distanceX = 0,
                            distanceY = 0;
                        if (mousePosition.x <= viewportRect.x)
                        {
                            distanceX = mousePosition.x - viewportRect.x
                        }
                        else if (mousePosition.x >= viewportRect.x + viewportRect.width)
                        {
                            distanceX = mousePosition.x - (viewportRect.x + viewportRect.width)
                        }
                        if (mousePosition.y <= viewportRect.y)
                        {
                            distanceY = mousePosition.y - viewportRect.y
                        }
                        else if (mousePosition.y >= viewportRect.y + viewportRect.height)
                        {
                            distanceY = mousePosition.y - (viewportRect.y + viewportRect.height)
                        }
                        self._getHScrollTimer().setInterval(self.getIntervalFromDistance(distanceX));
                        self._getVScrollTimer().setInterval(self.getIntervalFromDistance(distanceY))
                    }
                };
                _SheetEventHandler.prototype.stopScroll = function()
                {
                    this._getHScrollTimer().stop();
                    this._getVScrollTimer().stop()
                };
                _SheetEventHandler.prototype.startResizing = function(target)
                {
                    var self = this;
                    var sheet = self._sheet,
                        layout = sheet._getSheetLayout(),
                        resizeInfo = target.resizeInfo,
                        rowLayout,
                        rl,
                        colLayout,
                        cl;
                    if (resizeInfo.action === "sizeRow")
                    {
                        rowLayout = sheet._getAllRowLayout(resizeInfo.sheetArea);
                        resizeInfo.index = self._getPrevVisualRowBeforeFindRow(resizeInfo.index, resizeInfo.sheetArea);
                        rl = rowLayout.findRow(resizeInfo.index);
                        if (!rl)
                        {
                            rl = rowLayout.findRow(target.row)
                        }
                        resizeInfo.startY = rl.y
                    }
                    else
                    {
                        colLayout = sheet._getAllColumnLayout(resizeInfo.sheetArea);
                        resizeInfo.index = self._getPrevVisualColBeforeFindCol(resizeInfo.index, resizeInfo.sheetArea);
                        cl = colLayout.findCol(resizeInfo.index);
                        if (!cl)
                        {
                            cl = colLayout.findCol(target.col)
                        }
                        resizeInfo.startX = cl.x
                    }
                    var currentSpread = sheet.parent,
                        x = target.x,
                        y = target.y;
                    if (currentSpread)
                    {
                        var showResizeTip = currentSpread.showResizeTip();
                        if ((showResizeTip === 1 && resizeInfo.action === "sizeCol") || (showResizeTip === 2 && resizeInfo.action === "sizeRow") || showResizeTip === 3)
                        {
                            if (y - self.RESIZETOOLTIP_TOP < 0)
                            {
                                y = y + self.RESIZETOOLTIP_TOP / 2
                            }
                            else
                            {
                                y = y - self.RESIZETOOLTIP_TOP
                            }
                            self._showTooltip(self._getMouseDownResizeTooltipContent(), x, y)
                        }
                    }
                    self.isResizing = true;
                    self.isWorking = true
                };
                _SheetEventHandler.prototype.continueResizing = function()
                {
                    var self = this;
                    var sheet = self._sheet,
                        currentTarget = sheet._currentTarget,
                        resizeInfo = currentTarget.resizeInfo,
                        mousePosition = self.mousePosition,
                        x = mousePosition.x,
                        y = mousePosition.y,
                        layout = sheet._getSheetLayout(),
                        max,
                        rect;
                    if (!resizeInfo || !self.isWorking || !self.isResizing)
                    {
                        return
                    }
                    if (currentTarget.x === x && currentTarget.y === y)
                    {
                        return
                    }
                    if (resizeInfo.action === "sizeRow")
                    {
                        resizeInfo.movingY = y;
                        if (resizeInfo.movingY < resizeInfo.startY)
                        {
                            resizeInfo.movingY = resizeInfo.startY
                        }
                        max = layout.y + layout.height;
                        if (resizeInfo.movingY > max)
                        {
                            resizeInfo.movingY = max
                        }
                    }
                    else
                    {
                        resizeInfo.movingX = x;
                        if (resizeInfo.movingX < resizeInfo.startX)
                        {
                            resizeInfo.movingX = resizeInfo.startX
                        }
                        max = layout.x + layout.width;
                        if (resizeInfo.movingX > max)
                        {
                            resizeInfo.movingX = max
                        }
                    }
                    var render = sheet._render,
                        ctx = render._getCtx();
                    render.copyDoubleBuffer(layout.x, layout.y, layout.width, layout.height);
                    render.paintAdornment(ctx);
                    var currentSpread = sheet.parent;
                    if (currentSpread)
                    {
                        var showResizeTip = currentSpread.showResizeTip();
                        if ((showResizeTip === 1 && resizeInfo.action === "sizeCol") || (showResizeTip === 2 && resizeInfo.action === "sizeRow") || showResizeTip === 3)
                        {
                            self._refreshTooltip(self._getMouseMoveResizeTooltipContent(resizeInfo))
                        }
                    }
                };
                _SheetEventHandler.prototype.stopResizing = function()
                {
                    var self = this;
                    self.isResizing = false;
                    self.isWorking = false;
                    var sheet = self._sheet,
                        currentTarget = sheet._currentTarget,
                        resizeInfo = currentTarget.resizeInfo,
                        value,
                        i,
                        selectedRange,
                        action;
                    if (!resizeInfo)
                    {
                        return
                    }
                    self._removeTooltip();
                    if (resizeInfo.action === "sizeRow")
                    {
                        if (resizeInfo.movingY !== keyword_undefined && resizeInfo.movingY !== keyword_null)
                        {
                            value = Math_max(0, (resizeInfo.movingY - resizeInfo.startY) / sheet._zoomFactor);
                            var rowList = [];
                            if (sheet._isRowSelected(resizeInfo.index))
                            {
                                for (i = 0; i < sheet._selectionModel.length; i++)
                                {
                                    selectedRange = sheet._selectionModel[i];
                                    if (selectedRange.col === -1)
                                    {
                                        selectedRange = sheet._getActualRange(selectedRange);
                                        rowList.push({
                                            firstRow: selectedRange.row, lastRow: selectedRange.row + selectedRange.rowCount - 1
                                        })
                                    }
                                }
                            }
                            else
                            {
                                rowList.push({
                                    firstRow: resizeInfo.index, lastRow: resizeInfo.index
                                })
                            }
                            var isColHeader = resizeInfo.sheetArea === 1;
                            action = new Sheets.UndoRedo.RowResizeUndoAction(sheet, rowList, value, isColHeader);
                            sheet._doCommand(action)
                        }
                    }
                    else
                    {
                        if (resizeInfo.movingX !== keyword_undefined && resizeInfo.movingX !== keyword_null)
                        {
                            value = Math_max(0, (resizeInfo.movingX - resizeInfo.startX) / sheet._zoomFactor);
                            var columnList = [];
                            if (sheet._isColumnSelected(resizeInfo.index))
                            {
                                for (i = 0; i < sheet._selectionModel.length; i++)
                                {
                                    selectedRange = sheet._selectionModel[i];
                                    if (selectedRange.row === -1)
                                    {
                                        selectedRange = sheet._getActualRange(selectedRange);
                                        columnList.push({
                                            firstCol: selectedRange.col, lastCol: selectedRange.col + selectedRange.colCount - 1
                                        })
                                    }
                                }
                            }
                            else
                            {
                                columnList.push({
                                    firstCol: resizeInfo.index, lastCol: resizeInfo.index
                                })
                            }
                            var isRowHeader = resizeInfo.sheetArea === 2;
                            action = new Sheets.UndoRedo.ColumnResizeUndoAction(sheet, columnList, value, isRowHeader);
                            sheet._doCommand(action)
                        }
                    }
                };
                _SheetEventHandler.prototype._startSelectingCore = function(target, doNotSetFocus)
                {
                    var colIndex = 0,
                        rowIndex = 0,
                        rowCount = 0,
                        colCount = 0;
                    var self = this;
                    var sheet = self._sheet;
                    self._lastSelections = sheet._selectionModel.toArray();
                    if (!self.ctrl && !self.shift)
                    {
                        sheet._clearSelectionImp()
                    }
                    var firstRow,
                        args,
                        cellRange,
                        activeRowChanged;
                    if (target.hitTestType === 0)
                    {
                        if (!self.shift)
                        {
                            firstRow = sheet.frozenRowCount ? sheet._getFirstVisualRow() : sheet._scrollTopRow;
                            var leftCol = sheet.frozenColCount ? sheet._getFirstVisualColumn() : sheet._scrollLeftCol;
                            args = {
                                sheet: sheet, sheetName: sheet._name, row: sheet._activeRowIndex, col: sheet._activeColIndex, cancel: false
                            };
                            sheet.triggerLeaveCell(args);
                            if (args && args.cancel === true)
                            {
                                return
                            }
                            sheet._setActiveCellImp(firstRow, leftCol, 1, 1, doNotSetFocus);
                            sheet.triggerEnterCell({
                                sheet: sheet, sheetName: sheet._name, row: firstRow, col: leftCol
                            });
                            self._updateValidationUI(firstRow, leftCol)
                        }
                        if (!self.ctrl)
                        {
                            sheet._clearSelectionImp()
                        }
                        sheet._setSelectedRange(-1, -1, sheet.getRowCount(), sheet.getColumnCount(), true)
                    }
                    else if (target.hitTestType === 1)
                    {
                        if (!self.shift)
                        {
                            firstRow = sheet.frozenRowCount ? sheet._getFirstVisualRow() : sheet._scrollTopRow;
                            cellRange = sheet._getAvailableActiveCell(firstRow, target.col, false);
                            args = {
                                sheet: sheet, sheetName: sheet._name, row: sheet._activeRowIndex, col: sheet._activeColIndex, cancel: false
                            };
                            sheet.triggerLeaveCell(args);
                            if (args && args.cancel === true)
                            {
                                return
                            }
                            sheet._setActiveCellImp(cellRange.row, cellRange.col, 1, target.colViewportIndex, doNotSetFocus);
                            sheet.triggerEnterCell({
                                sheet: sheet, sheetName: sheet._name, row: cellRange.row, col: cellRange.col
                            });
                            self._updateValidationUI(cellRange.row, cellRange.col)
                        }
                        if (self.shift)
                        {
                            colIndex = Math_min(sheet._activeColIndex, target.col);
                            colCount = Math_abs(sheet._activeColIndex - target.col) + 1;
                            sheet._replaceActiveSelectedRange(-1, colIndex, sheet.getRowCount(), colCount, true)
                        }
                        else
                        {
                            sheet._setSelectedRange(-1, sheet._activeColIndex, sheet.getRowCount(), 1, true)
                        }
                    }
                    else if (target.hitTestType === 2)
                    {
                        if (!self.shift)
                        {
                            var firstCol = sheet.frozenColCount ? sheet._getFirstVisualColumn() : sheet._scrollLeftCol;
                            cellRange = sheet._getAvailableActiveCell(target.row, firstCol, true);
                            args = {
                                sheet: sheet, sheetName: sheet._name, row: sheet._activeRowIndex, col: sheet._activeColIndex, cancel: false
                            };
                            sheet.triggerLeaveCell(args);
                            if (args && args.cancel === true)
                            {
                                return
                            }
                            activeRowChanged = (sheet._activeRowIndex !== cellRange.row);
                            sheet._setActiveCellImp(cellRange.row, cellRange.col, target.rowViewportIndex, 1, doNotSetFocus);
                            if (activeRowChanged)
                            {
                                sheet.doDataItemChanged()
                            }
                            sheet.triggerEnterCell({
                                sheet: sheet, sheetName: sheet._name, row: cellRange.row, col: cellRange.col
                            });
                            self._updateValidationUI(cellRange.row, cellRange.col)
                        }
                        if (self.shift)
                        {
                            rowIndex = Math_min(sheet._activeRowIndex, target.row);
                            rowCount = Math_abs(sheet._activeRowIndex - target.row) + 1;
                            sheet._replaceActiveSelectedRange(rowIndex, -1, rowCount, sheet.getColumnCount(), true)
                        }
                        else
                        {
                            sheet._setSelectedRange(sheet._activeRowIndex, -1, 1, sheet.getColumnCount(), true)
                        }
                    }
                    else if (target.hitTestType === 3)
                    {
                        if (!isNaN(target.row) && !isNaN(target.col))
                        {
                            if (!self.shift)
                            {
                                if (sheet._activeRowIndex !== target.row || sheet._activeColIndex !== target.col)
                                {
                                    args = {
                                        sheet: sheet, sheetName: sheet._name, row: sheet._activeRowIndex, col: sheet._activeColIndex, cancel: false
                                    };
                                    sheet.triggerLeaveCell(args);
                                    if (args && args.cancel === true)
                                    {
                                        return
                                    }
                                    activeRowChanged = (sheet._activeRowIndex !== target.row);
                                    sheet._setActiveCellImp(target.row, target.col, target.rowViewportIndex, target.colViewportIndex, doNotSetFocus);
                                    if (activeRowChanged)
                                    {
                                        sheet.doDataItemChanged()
                                    }
                                    sheet.triggerEnterCell({
                                        sheet: sheet, sheetName: sheet._name, row: target.row, col: target.col
                                    });
                                    self._updateValidationUI(target.row, target.col)
                                }
                            }
                            if (self.shift)
                            {
                                sheet._extendSelectedRange(target.row, target.col, true)
                            }
                            else
                            {
                                var span = sheet._getSpanModel().find(target.row, target.col);
                                if (span)
                                {
                                    sheet._setSelectedRange(span.row, span.col, span.rowCount, span.colCount, true)
                                }
                                else
                                {
                                    sheet._setSelectedRange(target.row, target.col, 1, 1, true)
                                }
                            }
                        }
                        else
                        {
                            if (sheet.isEditing())
                            {
                                var rect = sheet.getCellRect(sheet._activeRowIndex, sheet._activeColIndex, sheet.activeRowViewportIndex, sheet.activeColViewportIndex);
                                sheet._render.update(rect.x, rect.y, rect.width, rect.height)
                            }
                        }
                    }
                };
                _SheetEventHandler.prototype._startSelectingScroll = function(target)
                {
                    if (!target)
                    {
                        return
                    }
                    if (target.hitTestType === 3 && (isNaN(target.row) || isNaN(target.col)))
                    {
                        return
                    }
                    var self = this;
                    self.isWorking = true;
                    self.isSelecting = true;
                    self.startHitInfo = {
                        scrollRowViewportIndex: target.rowViewportIndex, scrollColViewportIndex: target.colViewportIndex, hitTestType: target.hitTestType
                    };
                    self.startScroll()
                };
                _SheetEventHandler.prototype.startSelecting = function(target)
                {
                    this._startSelectingCore(target);
                    this._startSelectingScroll(target)
                };
                _SheetEventHandler.prototype.continueSelecting = function()
                {
                    var self = this;
                    if (!self.startHitInfo || !self.isWorking)
                    {
                        return
                    }
                    if (self._forceCancelSelectiong === true)
                    {
                        return
                    }
                    var hitTestType = self.startHitInfo.hitTestType;
                    if (hitTestType === 3)
                    {
                        self.continueCellSelecting()
                    }
                    else if (hitTestType === 2)
                    {
                        self.continueRowSelecting()
                    }
                    else if (hitTestType === 1)
                    {
                        self.continueColumnSelecting()
                    }
                };
                _SheetEventHandler.prototype.continueCellSelecting = function()
                {
                    var self = this;
                    var sheet = self._sheet;
                    var hitRow = self.getHitRowIndex();
                    var hitCol = self.getHitColumnIndex();
                    if (hitRow >= 0 && hitCol >= 0)
                    {
                        var oldSelections = sheet._selectionModel.toArray();
                        sheet._extendSelectedRange(hitRow, hitCol, true);
                        var newSelections = sheet._selectionModel.toArray();
                        if (self._notEqualSelecions(oldSelections, newSelections))
                        {
                            sheet.triggerSelectionChanging({
                                sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                            })
                        }
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype.continueRowSelecting = function()
                {
                    var self = this;
                    var sheet = self._sheet;
                    var hitRow = self.getHitRowIndex();
                    if (hitRow >= 0)
                    {
                        var r = Math_min(sheet._activeRowIndex, hitRow);
                        var rc = Math_max(sheet._activeRowIndex, hitRow) - r + 1;
                        var c = -1;
                        var cc = sheet.getColumnCount();
                        var selectionPolicy = sheet.selectionPolicy();
                        if (selectionPolicy === 0)
                        {
                            return
                        }
                        var selectionUnit = sheet.selectionUnit();
                        if (selectionUnit === 2)
                        {
                            r = -1;
                            rc = -1
                        }
                        var oldSelections = sheet._selectionModel.toArray();
                        sheet._replaceActiveSelectedRange(r, c, rc, cc, true);
                        var newSelections = sheet._selectionModel.toArray();
                        if (self._notEqualSelecions(oldSelections, newSelections))
                        {
                            sheet.triggerSelectionChanging({
                                sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                            })
                        }
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype.continueColumnSelecting = function()
                {
                    var self = this;
                    var sheet = self._sheet;
                    var hitCol = self.getHitColumnIndex();
                    if (hitCol >= 0)
                    {
                        var c = Math_min(sheet._activeColIndex, hitCol);
                        var cc = Math_max(sheet._activeColIndex, hitCol) - c + 1;
                        var r = -1;
                        var rc = sheet.getRowCount();
                        var selectionPolicy = sheet.selectionPolicy();
                        if (selectionPolicy === 0)
                        {
                            return
                        }
                        var selectionUnit = sheet.selectionUnit();
                        if (selectionUnit === 1)
                        {
                            c = -1;
                            cc = -1
                        }
                        var oldSelections = sheet._selectionModel.toArray();
                        sheet._replaceActiveSelectedRange(r, c, rc, cc, true);
                        var newSelections = sheet._selectionModel.toArray();
                        if (self._notEqualSelecions(oldSelections, newSelections))
                        {
                            sheet.triggerSelectionChanging({
                                sheet: sheet, sheetName: sheet._name, oldSelections: oldSelections, newSelections: newSelections
                            })
                        }
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype.stopSelecting = function()
                {
                    var self = this;
                    self.startHitInfo = keyword_null;
                    self.stopScroll();
                    self._forceCancelSelectiong = keyword_null;
                    self.isWorking = false;
                    self.isSelecting = false;
                    var sheet = self._sheet;
                    var needRaiseChangedEvent = !self._lastSelections;
                    if (!needRaiseChangedEvent)
                    {
                        var currentSelections = sheet._selectionModel.toArray();
                        needRaiseChangedEvent = self._notEqualSelecions(self._lastSelections, currentSelections)
                    }
                    if (needRaiseChangedEvent)
                    {
                        sheet.triggerSelectionChanged({
                            sheet: self._sheet, sheetName: self._sheet._name
                        })
                    }
                    self._lastSelections = sheet._selectionModel.toArray()
                };
                _SheetEventHandler.prototype.startDragDropping = function(target)
                {
                    var self = this;
                    if (self.isDragDropping)
                    {
                        return
                    }
                    var sheet = self._sheet;
                    var fromRange = keyword_null;
                    if (sheet._selectionModel.length === 1)
                    {
                        fromRange = sheet._selectionModel[0]
                    }
                    else if (sheet._selectionModel.length < 1)
                    {
                        var spanActiveCell = sheet._getSpanModel().find(sheet._activeRowIndex, sheet._activeColIndex);
                        if (spanActiveCell)
                        {
                            fromRange = spanActiveCell
                        }
                        else
                        {
                            fromRange = new Sheets.Range(sheet._activeRowIndex, sheet._activeColIndex, 1, 1)
                        }
                    }
                    if (fromRange)
                    {
                        self.isDragDropping = true;
                        self.isWorking = true;
                        self._dragDropFromRange = fromRange;
                        var rect = sheet._getRangeRect(target.rowViewportIndex, target.colViewportIndex, fromRange);
                        var dragRect = sheet._dragRect;
                        dragRect.x = rect.x;
                        dragRect.y = rect.y;
                        dragRect.width = rect.width - 1;
                        dragRect.height = rect.height - 1;
                        dragRect.row = fromRange.row;
                        dragRect.col = fromRange.col;
                        dragRect.rowCount = fromRange.rowCount;
                        dragRect.colCount = fromRange.colCount;
                        var rg = sheet._fixRange(fromRange);
                        var hitRow = target.row,
                            hitCol = target.col;
                        if (hitRow < rg.row)
                        {
                            hitRow = rg.row
                        }
                        if (hitRow >= rg.row + rg.rowCount)
                        {
                            hitRow = rg.row + rg.rowCount - 1
                        }
                        if (hitCol < rg.col)
                        {
                            hitCol = rg.col
                        }
                        if (hitCol >= rg.col + rg.colCount)
                        {
                            hitCol = rg.col + rg.colCount - 1
                        }
                        dragRect.hitRow = hitRow;
                        dragRect.hitCol = hitCol;
                        dragRect.rowOffset = hitRow - rg.row;
                        dragRect.colOffset = hitCol - rg.col;
                        self.startHitInfo = {
                            scrollRowViewportIndex: target.rowViewportIndex, scrollColViewportIndex: target.colViewportIndex, hitTestType: target.hitTestType
                        };
                        self.startScroll()
                    }
                };
                _SheetEventHandler.prototype.continueDragDropping = function()
                {
                    var self = this;
                    if (!self.startHitInfo || !self.isWorking)
                    {
                        return
                    }
                    if (!self.isDragDropping || !self._dragDropFromRange)
                    {
                        return
                    }
                    var mousePosition = self.mousePosition;
                    var sheet = self._sheet;
                    var dragRect = sheet._dragRect;
                    dragRect.hitTarget = {
                        x: mousePosition.x, y: mousePosition.y
                    };
                    var hitRow = self.getHitRowIndex();
                    var hitCol = self.getHitColumnIndex();
                    if (hitRow >= 0 && hitCol >= 0)
                    {
                        self.updateDragDropRect(hitRow, hitCol)
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype.updateDragDropRect = function(hitRow, hitCol)
                {
                    var self = this;
                    if (!self.isDragDropping || !self._dragDropFromRange)
                    {
                        return
                    }
                    var sheet = self._sheet;
                    var dragRect = sheet._dragRect;
                    var activeSelRange = sheet._getActiveSelectedRange();
                    if (activeSelRange.row === -1 && activeSelRange.col !== -1)
                    {
                        dragRect.row = -1;
                        dragRect.col = hitCol
                    }
                    else if (activeSelRange.row !== -1 && activeSelRange.col === -1)
                    {
                        dragRect.row = hitRow;
                        dragRect.col = -1
                    }
                    else
                    {
                        dragRect.row = dragRect.row < 0 ? -1 : Math_max(0, Math_min(sheet.getRowCount() - dragRect.rowCount, hitRow - dragRect.rowOffset));
                        dragRect.col = dragRect.col < 0 ? -1 : Math_max(0, Math_min(sheet.getColumnCount() - dragRect.colCount, hitCol - dragRect.colOffset))
                    }
                    dragRect.hitRow = hitRow;
                    dragRect.hitCol = hitCol;
                    var dragRange = sheet._fixRange(dragRect);
                    var oldDragRange = sheet._oldDragRange;
                    if (oldDragRange)
                    {
                        if (dragRange.row === oldDragRange.row && dragRange.col === oldDragRange.col && dragRange.rowCount === oldDragRange.rowCount && dragRange.colCount === oldDragRange.colCount && dragRange.row > sheet._getFirstVisualRow() && dragRange.col > sheet._getFirstVisualColumn() && dragRange.row + dragRange.rowCount - 1 < sheet._getLastVisualRow() && dragRange.col + dragRange.colCount - 1 < sheet._getLastVisualColumn())
                        {
                            return
                        }
                    }
                    sheet._actualDragRange = dragRange;
                    sheet._render.refreshDragDropIndicator();
                    sheet._oldDragRange = dragRange;
                    var currentSpread = sheet.parent;
                    if (currentSpread && currentSpread.showDragDropTip())
                    {
                        var left = dragRect.x + dragRect.width + self.DRAGDROPTOOLTIP_OFFSET;
                        var top = dragRect.y + dragRect.height + self.DRAGDROPTOOLTIP_OFFSET;
                        self._showTooltip(self._getDragDropRectString(dragRange), left, top)
                    }
                };
                _SheetEventHandler.prototype._getDragDropRectString = function(dragRange)
                {
                    if (dragRange && Sheets.util.hasCalc())
                    {
                        var sheet = this._sheet;
                        var activeSelRange = sheet._getActiveSelectedRange();
                        var activeRow = sheet.getActiveRowIndex();
                        var activeCol = sheet.getActiveColumnIndex();
                        var exp;
                        activeRow = activeRow < 0 ? 0 : activeRow;
                        activeCol = activeCol < 0 ? 0 : activeCol;
                        if (activeSelRange.rowCount === 1 && activeSelRange.colCount === 1)
                        {
                            exp = new Sheets.Calc.Expressions.CellExpression(dragRange.row - activeRow, dragRange.col - activeCol, true, true)
                        }
                        else
                        {
                            exp = new Sheets.Calc.Expressions.RangeExpression;
                            if (activeSelRange.row === -1 && activeSelRange.col >= 0)
                            {
                                exp.initBand(dragRange.col - activeCol, dragRange.col - activeCol + activeSelRange.colCount - 1, true, true, false)
                            }
                            else if (activeSelRange.col === -1 && activeSelRange.row >= 0)
                            {
                                exp.initBand(dragRange.row - activeRow, dragRange.row - activeRow + activeSelRange.rowCount - 1, true, true, true)
                            }
                            else if (activeSelRange.row >= 0 && activeSelRange.col >= 0)
                            {
                                exp.init(dragRange.row - activeRow, dragRange.col - activeCol, dragRange.row - activeRow + activeSelRange.rowCount - 1, dragRange.col - activeCol + activeSelRange.colCount - 1, true, true, true, true)
                            }
                        }
                        return sheet.getCalcService().unparse(sheet._getSheetSource(), exp, activeRow, activeCol)
                    }
                    else
                    {
                        return keyword_undefined
                    }
                };
                _SheetEventHandler.prototype.stopDragDrop = function()
                {
                    var self = this;
                    var isInvalid = false;
                    var invalidMessage = "";
                    var doCommand = false;
                    var sheet = self._sheet;
                    var rg = keyword_null;
                    self.startHitInfo = keyword_null;
                    self.stopScroll();
                    var _selectedRange = sheet._getActiveSelectedRange();
                    if (_selectedRange && (_selectedRange.rowCount > 0 || _selectedRange.colCount > 0))
                    {
                        rg = {
                            r: _selectedRange.row, c: _selectedRange.col, rc: _selectedRange.rowCount, cc: _selectedRange.colCount
                        }
                    }
                    else
                    {
                        rg = {
                            r: sheet._activeRowIndex, c: sheet._activeColIndex, rc: 1, cc: 1
                        }
                    }
                    if (self.isDragDropping === true && self.isWorking === true)
                    {
                        var fromRow = rg.r;
                        var fromColumn = rg.c;
                        var rowCount = rg.rc;
                        var columnCount = rg.cc;
                        var toRow = sheet._dragRect.row;
                        var toColumn = sheet._dragRect.col;
                        var action,
                            cancel,
                            dragMoveExtent;
                        if (self._isDragInsert && (fromRow === -1 || fromColumn === -1))
                        {
                            if (fromColumn >= 0 && fromRow < 0)
                            {
                                if ((self._isDragCopy && (toColumn <= fromColumn || toColumn >= fromColumn + columnCount)) || (!self._isDragCopy && (toColumn < fromColumn || toColumn > fromColumn + columnCount)))
                                {
                                    if (sheet._hasPartSpans(-1, fromColumn, -1, columnCount) || sheet._hasPartSpans(-1, toColumn, -1, 0))
                                    {
                                        isInvalid = true;
                                        invalidMessage = Sheets.SR.Exp_ChangeMergedCell
                                    }
                                    if (!isInvalid)
                                    {
                                        if (sheet._hasPartArrayFormulas(-1, fromColumn, -1, columnCount) || sheet._hasPartArrayFormulas(-1, toColumn, -1, 0))
                                        {
                                            isInvalid = true;
                                            invalidMessage = Sheets.SR.Exp_ChangePartOfArray
                                        }
                                    }
                                    if (!isInvalid && sheet.isProtected)
                                    {
                                        isInvalid = true;
                                        invalidMessage = Sheets.SR.Exp_ColumnReadOnly
                                    }
                                    if (!isInvalid && sheet._hasPartTable(-1, toColumn, -1, 1))
                                    {
                                        isInvalid = true;
                                        invalidMessage = Sheets.SR.Exp_DragDropShiftTableCell
                                    }
                                    if (!isInvalid && !self._isDragCopy && sheet._hasPartTable(-1, fromColumn, -1, columnCount))
                                    {
                                        isInvalid = true;
                                        invalidMessage = Sheets.SR.Exp_DragDropChangePartOfTable
                                    }
                                    if (!isInvalid)
                                    {
                                        dragMoveExtent = new Sheets.UndoRedo.DragDropExtent(-1, fromColumn, -1, toColumn, -1, columnCount);
                                        cancel = sheet._raiseDragDropBlock(dragMoveExtent.fromRow, dragMoveExtent.fromColumn, dragMoveExtent.toRow, dragMoveExtent.toColumn, dragMoveExtent.rowCount, dragMoveExtent.columnCount, self._isDragCopy, true, 1023);
                                        if (!cancel)
                                        {
                                            action = new Sheets.UndoRedo.DragDropUndoAction(sheet, dragMoveExtent, self._isDragCopy, true, 1023);
                                            sheet.doCommand(action);
                                            sheet._raiseDragDropBlockCompleted(dragMoveExtent.fromRow, dragMoveExtent.fromColumn, dragMoveExtent.toRow, dragMoveExtent.toColumn, dragMoveExtent.rowCount, dragMoveExtent.columnCount, self._isDragCopy, true, 1023);
                                            doCommand = true
                                        }
                                    }
                                }
                            }
                            else if (fromRow >= 0 && fromColumn < 0)
                            {
                                if ((self._isDragCopy && (toRow <= fromRow || toRow >= fromRow + rowCount)) || (!self._isDragCopy && (toRow < fromRow || toRow > fromRow + rowCount)))
                                {
                                    if (sheet._hasPartSpans(fromRow, -1, rowCount, -1) || sheet._hasPartSpans(toRow, -1, 0, -1))
                                    {
                                        isInvalid = true;
                                        invalidMessage = Sheets.SR.Exp_ChangeMergedCell
                                    }
                                    if (!isInvalid)
                                    {
                                        if (sheet._hasPartArrayFormulas(fromRow, -1, rowCount, -1) || sheet._hasPartArrayFormulas(toRow, -1, 0, -1))
                                        {
                                            isInvalid = true;
                                            invalidMessage = Sheets.SR.Exp_ChangePartOfArray
                                        }
                                    }
                                    if (!isInvalid && sheet.isProtected)
                                    {
                                        isInvalid = true;
                                        invalidMessage = Sheets.SR.Exp_RowReadOnly
                                    }
                                    if (!isInvalid && !self._isDragCopy && sheet._hasPartTable(fromRow, -1, rowCount, -1))
                                    {
                                        isInvalid = true;
                                        invalidMessage = Sheets.SR.Exp_DragDropChangePartOfTable
                                    }
                                    if (!isInvalid)
                                    {
                                        dragMoveExtent = new Sheets.UndoRedo.DragDropExtent(fromRow, -1, toRow, -1, rowCount, -1);
                                        cancel = sheet._raiseDragDropBlock(dragMoveExtent.fromRow, dragMoveExtent.fromColumn, dragMoveExtent.toRow, dragMoveExtent.toColumn, dragMoveExtent.rowCount, dragMoveExtent.columnCount, self._isDragCopy, true, 1023);
                                        if (!cancel)
                                        {
                                            action = new Sheets.UndoRedo.DragDropUndoAction(sheet, dragMoveExtent, self._isDragCopy, true, 1023);
                                            sheet.doCommand(action);
                                            sheet._raiseDragDropBlockCompleted(dragMoveExtent.fromRow, dragMoveExtent.fromColumn, dragMoveExtent.toRow, dragMoveExtent.toColumn, dragMoveExtent.rowCount, dragMoveExtent.columnCount, self._isDragCopy, true, 1023);
                                            doCommand = true
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (toRow !== fromRow || toColumn !== fromColumn)
                            {
                                if (sheet._hasPartSpans(fromRow, fromColumn, rowCount, columnCount) || sheet._hasPartSpans(toRow, toColumn, rowCount, columnCount))
                                {
                                    isInvalid = true;
                                    invalidMessage = Sheets.SR.Exp_ChangeMergedCell
                                }
                                if (!isInvalid)
                                {
                                    if (sheet._hasPartArrayFormulas(fromRow, fromColumn, rowCount, columnCount) || sheet._hasPartArrayFormulas(toRow, toColumn, rowCount, columnCount))
                                    {
                                        isInvalid = true;
                                        invalidMessage = Sheets.SR.Exp_ChangePartOfArray
                                    }
                                }
                                if (!isInvalid && sheet.isProtected)
                                {
                                    if ((!self._isDragCopy && sheet._isAnyCellInRangeLocked(new Sheets.Range(fromRow, fromColumn, rowCount, columnCount))) || sheet._isAnyCellInRangeLocked(new Sheets.Range(toRow, toColumn, rowCount, columnCount)))
                                    {
                                        isInvalid = true;
                                        invalidMessage = Sheets.SR.Exp_CellReadOnly
                                    }
                                }
                                if (!isInvalid)
                                {
                                    dragMoveExtent = new Sheets.UndoRedo.DragDropExtent(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount);
                                    cancel = sheet._raiseDragDropBlock(dragMoveExtent.fromRow, dragMoveExtent.fromColumn, dragMoveExtent.toRow, dragMoveExtent.toColumn, dragMoveExtent.rowCount, dragMoveExtent.columnCount, self._isDragCopy, false, 1023);
                                    if (!cancel)
                                    {
                                        action = new Sheets.UndoRedo.DragDropUndoAction(sheet, dragMoveExtent, self._isDragCopy, false, 1023);
                                        sheet.doCommand(action);
                                        sheet._raiseDragDropBlockCompleted(dragMoveExtent.fromRow, dragMoveExtent.fromColumn, dragMoveExtent.toRow, dragMoveExtent.toColumn, dragMoveExtent.rowCount, dragMoveExtent.columnCount, self._isDragCopy, false, 1023);
                                        doCommand = true
                                    }
                                }
                            }
                        }
                    }
                    self.isWorking = false;
                    self.isDragDropping = false;
                    self._dragDropFromRange = keyword_null;
                    self._isDragInsert = false;
                    self._isDragCopy = false;
                    self._removeTooltip();
                    if (doCommand === false)
                    {
                        sheet._dragRect = {};
                        sheet.repaint()
                    }
                    if (isInvalid)
                    {
                        sheet._raiseInvalidOperation(3, invalidMessage)
                    }
                };
                _SheetEventHandler.prototype.startFormulaRangeAppending = function(target)
                {
                    var self = this;
                    var sheet = self._sheet,
                        fbx = sheet._formulaTextBox;
                    if (!fbx)
                    {
                        return
                    }
                    var fbxHasStarted = fbx.isAppending();
                    if (!fbxHasStarted || !self._formulaRangeAppendingInfo)
                    {
                        self._formulaRangeAppendingInfo = {
                            anchorRow: -1, anchorCol: -1, leadingRow: -1, leadingCol: -1
                        }
                    }
                    var rowCount = sheet.getRowCount(),
                        colCount = sheet.getColumnCount();
                    var hitTestType = target.hitTestType,
                        hitRow = target.row,
                        hitCol = target.col,
                        shiftKey = self.shift,
                        ctrlKey = self.ctrl;
                    var rangeAppendingInfo = self._formulaRangeAppendingInfo,
                        oldAnchorRow = rangeAppendingInfo.anchorRow,
                        oldAnchorCol = rangeAppendingInfo.anchorCol,
                        anchorRow = -1,
                        anchorCol = -1,
                        range;
                    if (hitTestType === 0)
                    {
                        anchorRow = sheet.frozenRowCount ? sheet._getFirstVisualRow() : sheet._scrollTopRow;
                        anchorCol = sheet.frozenColCount ? sheet._getFirstVisualColumn() : sheet._scrollLeftCol;
                        range = new Sheets.Range(-1, -1, -1, -1);
                        if (ctrlKey)
                        {
                            fbx.appendRange(self.rangeToString(range), false, false)
                        }
                        else if (shiftKey)
                        {
                            fbx.appendRange(self.rangeToString(range), true, false)
                        }
                        else
                        {
                            fbx.appendRange(self.rangeToString(range), false, true)
                        }
                        self.isWorking = true
                    }
                    else if (hitTestType === 1)
                    {
                        anchorRow = sheet.frozenRowCount ? sheet._getFirstVisualRow() : sheet._scrollTopRow;
                        anchorCol = hitCol;
                        range = sheet._getExtendedRange(0, hitCol, rowCount - 1, hitCol);
                        range = new Sheets.Range(-1, range.col, -1, range.colCount);
                        if (ctrlKey)
                        {
                            fbx.appendRange(self.rangeToString(range), false, false)
                        }
                        else if (shiftKey)
                        {
                            if (oldAnchorCol >= 0)
                            {
                                range = sheet._getExtendedRange(0, hitCol, rowCount - 1, oldAnchorCol);
                                range = new Sheets.Range(-1, range.col, -1, range.colCount)
                            }
                            fbx.appendRange(self.rangeToString(range), true, false)
                        }
                        else
                        {
                            fbx.appendRange(self.rangeToString(range), false, true)
                        }
                        self.isWorking = true
                    }
                    else if (hitTestType === 2)
                    {
                        anchorRow = hitRow;
                        anchorCol = sheet.frozenColCount ? sheet._getFirstVisualColumn() : sheet._scrollLeftCol;
                        range = sheet._getExtendedRange(hitRow, 0, hitRow, colCount - 1);
                        range = new Sheets.Range(range.row, -1, range.rowCount, -1);
                        if (ctrlKey)
                        {
                            fbx.appendRange(self.rangeToString(range), false, false)
                        }
                        else if (shiftKey)
                        {
                            if (oldAnchorRow >= 0)
                            {
                                range = sheet._getExtendedRange(hitRow, 0, oldAnchorRow, colCount - 1);
                                range = new Sheets.Range(range.row, -1, range.rowCount, -1)
                            }
                            fbx.appendRange(self.rangeToString(range), true, false)
                        }
                        else
                        {
                            fbx.appendRange(self.rangeToString(range), false, true)
                        }
                        self.isWorking = true
                    }
                    else if (hitTestType === 3)
                    {
                        anchorRow = hitRow;
                        anchorCol = hitCol;
                        range = sheet._getExtendedRange(hitRow, hitCol, hitRow, hitCol);
                        range = new Sheets.Range(range.row, range.col, 1, 1);
                        if (ctrlKey)
                        {
                            fbx.appendRange(self.rangeToString(range), false, false)
                        }
                        else if (shiftKey)
                        {
                            if (oldAnchorRow >= 0 && oldAnchorCol >= 0)
                            {
                                range = sheet._getExtendedRange(hitRow, hitCol, oldAnchorRow, oldAnchorCol)
                            }
                            fbx.appendRange(self.rangeToString(range), true, false)
                        }
                        else
                        {
                            fbx.appendRange(self.rangeToString(range), false, true)
                        }
                        self.isWorking = true
                    }
                    self.isFormulaRangeAppending = self.isWorking;
                    if (!shiftKey || !fbxHasStarted)
                    {
                        rangeAppendingInfo.anchorRow = anchorRow;
                        rangeAppendingInfo.anchorCol = anchorCol;
                        rangeAppendingInfo.leadingRow = anchorRow;
                        rangeAppendingInfo.leadingCol = anchorCol
                    }
                    self.startHitInfo = {
                        scrollRowViewportIndex: target.rowViewportIndex, scrollColViewportIndex: target.colViewportIndex, hitTestType: target.hitTestType
                    };
                    self.startScroll()
                };
                _SheetEventHandler.prototype.continueFormulaRangeAppending = function()
                {
                    var self = this;
                    var hi = self.startHitInfo;
                    if (!hi || !self.isWorking)
                    {
                        return
                    }
                    var hitTestType = hi.hitTestType;
                    if (hitTestType === 3)
                    {
                        self.continueFormulaRangeCellAppending()
                    }
                    else if (hitTestType === 2)
                    {
                        self.continueFormulaRangeRowAppending()
                    }
                    else if (hitTestType === 1)
                    {
                        self.continueFormulaRangeColumnAppending()
                    }
                };
                _SheetEventHandler.prototype.continueFormulaRangeCellAppending = function()
                {
                    var self = this;
                    var rangeAppendingInfo = self._formulaRangeAppendingInfo,
                        anchorRow = rangeAppendingInfo.anchorRow,
                        anchorCol = rangeAppendingInfo.anchorCol,
                        hitRow = self.getHitRowIndex(),
                        hitCol = self.getHitColumnIndex();
                    if (anchorRow >= 0 && anchorCol >= 0 && hitRow >= 0 && hitCol >= 0)
                    {
                        var sheet = self._sheet;
                        var range = sheet._getExtendedRange(hitRow, hitCol, anchorRow, anchorCol);
                        var rangeString = self.rangeToString(range);
                        if (rangeString)
                        {
                            var fbx = sheet._formulaTextBox;
                            fbx.appendRange(rangeString, true, false)
                        }
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype.continueFormulaRangeRowAppending = function()
                {
                    var self = this;
                    var anchorRow = self._formulaRangeAppendingInfo.anchorRow,
                        hitRow = self.getHitRowIndex();
                    if (anchorRow >= 0 && hitRow >= 0)
                    {
                        var sheet = self._sheet;
                        var range = sheet._getExtendedRange(hitRow, 0, anchorRow, sheet.getColumnCount() - 1);
                        range = new Sheets.Range(range.row, -1, range.rowCount, -1);
                        var rangeString = self.rangeToString(range);
                        if (rangeString)
                        {
                            var fbx = sheet._formulaTextBox;
                            fbx.appendRange(rangeString, true, false)
                        }
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype.continueFormulaRangeColumnAppending = function()
                {
                    var self = this;
                    var anchorCol = self._formulaRangeAppendingInfo.anchorCol,
                        hitCol = self.getHitColumnIndex();
                    if (anchorCol >= 0 && hitCol >= 0)
                    {
                        var sheet = self._sheet;
                        var range = sheet._getExtendedRange(0, hitCol, sheet.getRowCount() - 1, anchorCol);
                        range = new Sheets.Range(-1, range.col, -1, range.colCount);
                        var rangeString = self.rangeToString(range);
                        if (rangeString)
                        {
                            var fbx = sheet._formulaTextBox;
                            fbx.appendRange(rangeString, true, false)
                        }
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype.stopFormulaRangeAppending = function()
                {
                    var self = this;
                    self.stopScroll();
                    self.startHitInfo = keyword_null;
                    self.isWorking = false;
                    self.isFormulaRangeAppending = false
                };
                _SheetEventHandler.prototype.startFormulaRangeMoving = function(target)
                {
                    var self = this;
                    var sheet = self._sheet,
                        fbx = sheet._formulaTextBox,
                        hi = target.formulaRangeHitInfo;
                    if (!hi || !hi.inBorder || !fbx)
                    {
                        return
                    }
                    if (fbx.isAppending())
                    {
                        fbx.stopAppending()
                    }
                    fbx.close();
                    var paramRange = hi.paramRange,
                        rangeString = (paramRange && paramRange.text);
                    if (!rangeString)
                    {
                        return
                    }
                    var range = self.stringToRange(rangeString);
                    if (!range)
                    {
                        return
                    }
                    var rg = sheet._fixRange(range),
                        hitRow = target.row,
                        hitCol = target.col;
                    if (hitRow < rg.row)
                    {
                        hitRow = rg.row
                    }
                    if (hitRow >= rg.row + rg.rowCount)
                    {
                        hitRow = rg.row + rg.rowCount - 1
                    }
                    if (hitCol < rg.col)
                    {
                        hitCol = rg.col
                    }
                    if (hitCol >= rg.col + rg.colCount)
                    {
                        hitCol = rg.col + rg.colCount - 1
                    }
                    var rowOffset = hitRow - rg.row;
                    var colOffset = hitCol - rg.col;
                    self.isWorking = true;
                    self.isFormulaRangeMoving = true;
                    self._formulaRangeMovingInfo = {
                        paramRange: paramRange, fromRange: range, rowOffset: rowOffset, colOffset: colOffset
                    };
                    self.startHitInfo = {
                        scrollRowViewportIndex: target.rowViewportIndex, scrollColViewportIndex: target.colViewportIndex, hitTestType: target.hitTestType
                    };
                    self.startScroll()
                };
                _SheetEventHandler.prototype.continueFormulaRangeMoving = function()
                {
                    var self = this;
                    if (!self.isWorking || !self.isFormulaRangeMoving)
                    {
                        return
                    }
                    var hitRow = self.getHitRowIndex();
                    var hitCol = self.getHitColumnIndex();
                    if (hitRow >= 0 && hitCol >= 0)
                    {
                        var movingInfo = self._formulaRangeMovingInfo,
                            range = movingInfo.fromRange,
                            rowOffset = movingInfo.rowOffset,
                            colOffset = movingInfo.colOffset,
                            oldToRow = movingInfo.toRow,
                            oldToCol = movingInfo.toCol;
                        var toRow = hitRow,
                            toCol = hitCol;
                        if (toRow !== oldToRow || toCol !== oldToCol)
                        {
                            movingInfo.toRow = toRow;
                            movingInfo.toCol = toCol;
                            var sheet = self._sheet,
                                sheetRowCount = sheet.getRowCount(),
                                sheetColCount = sheet.getColumnCount(),
                                fromRow = range.row,
                                fromCol = range.col,
                                fromRowCount = range.rowCount,
                                fromColCount = range.colCount;
                            var newRow = fromRow < 0 ? -1 : Math_max(0, Math_min(sheetRowCount - fromRowCount, hitRow - rowOffset));
                            var newCol = fromCol < 0 ? -1 : Math_max(0, Math_min(sheetColCount - fromColCount, hitCol - colOffset));
                            var rangeString = self.rangeToString(new Sheets.Range(newRow, newCol, fromRowCount, fromColCount));
                            if (rangeString)
                            {
                                var fbx = sheet._formulaTextBox;
                                fbx.repalceRange(movingInfo.paramRange.index, rangeString)
                            }
                        }
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype.stopFormulaRangeMoving = function()
                {
                    var self = this;
                    self.stopScroll();
                    self.isWorking = false;
                    self.isFormulaRangeMoving = false;
                    self._formulaRangeMovingInfo = keyword_null
                };
                _SheetEventHandler.prototype.startFormulaRangeResizing = function(target)
                {
                    var self = this;
                    var sheet = self._sheet,
                        fbx = sheet._formulaTextBox,
                        hi = target.formulaRangeHitInfo;
                    if (!hi || !fbx)
                    {
                        return
                    }
                    if (fbx.isAppending())
                    {
                        fbx.stopAppending()
                    }
                    var paramRange = hi.paramRange,
                        rangeString = (paramRange && paramRange.text);
                    if (!paramRange || !rangeString)
                    {
                        return
                    }
                    var range = self.stringToRange(rangeString);
                    if (!range)
                    {
                        return
                    }
                    var row = range.row,
                        endRow = range.row < 0 ? -1 : range.row + range.rowCount - 1,
                        col = range.col,
                        endCol = range.col < 0 ? -1 : range.col + range.colCount - 1;
                    var anchorRow,
                        anchorCol,
                        toRow,
                        toCol;
                    if (hi.inTopLeft)
                    {
                        anchorRow = endRow;
                        anchorCol = endCol;
                        toRow = row;
                        toCol = col
                    }
                    else if (hi.inTopRight)
                    {
                        anchorRow = endRow;
                        anchorCol = col;
                        toRow = row;
                        toCol = endCol
                    }
                    else if (hi.inBottomLeft)
                    {
                        anchorRow = row;
                        anchorCol = endCol;
                        toRow = endRow;
                        toCol = col
                    }
                    else if (hi.inBottomRight)
                    {
                        anchorRow = row;
                        anchorCol = col;
                        toRow = endRow;
                        toCol = endCol
                    }
                    else
                    {
                        return
                    }
                    self.isWorking = true;
                    self.isFormulaRangeResizing = true;
                    self._formulaRangeResizingInfo = {
                        paramRange: paramRange, anchorRow: anchorRow, anchorCol: anchorCol, toRow: toRow, toCol: toCol
                    };
                    self.startHitInfo = {
                        scrollRowViewportIndex: target.rowViewportIndex, scrollColViewportIndex: target.colViewportIndex, hitTestType: target.hitTestType
                    };
                    self.startScroll()
                };
                _SheetEventHandler.prototype.continueFormulaRangeResizing = function()
                {
                    var self = this;
                    if (!self.isWorking || !self.isFormulaRangeResizing)
                    {
                        return
                    }
                    var hitRow = self.getHitRowIndex();
                    var hitCol = self.getHitColumnIndex();
                    if (hitRow >= 0 && hitCol >= 0)
                    {
                        var resizingInfo = self._formulaRangeResizingInfo,
                            anchorRow = resizingInfo.anchorRow,
                            anchorCol = resizingInfo.anchorCol,
                            oldToRow = resizingInfo.toRow,
                            oldToCol = resizingInfo.toCol;
                        var toRow = hitRow,
                            toCol = hitCol;
                        if (toRow !== oldToRow || toCol !== oldToCol)
                        {
                            resizingInfo.toRow = toRow;
                            resizingInfo.toCol = toCol;
                            var sheet = self._sheet,
                                sheetRowCount = sheet.getRowCount(),
                                sheetColCount = sheet.getColumnCount();
                            var fromRow = anchorRow < 0 ? sheetRowCount - 1 : anchorRow,
                                fromCol = anchorCol < 0 ? sheetColCount - 1 : anchorCol;
                            var row = Math_min(fromRow, toRow),
                                col = Math_min(fromCol, toCol),
                                rowCount = Math_max(fromRow, toRow) - row + 1,
                                colCount = Math_max(fromCol, toCol) - col + 1;
                            if (row === 0 && rowCount === sheetRowCount)
                            {
                                row = -1;
                                rowCount = -1
                            }
                            if (col === 0 && colCount === sheetColCount)
                            {
                                col = -1;
                                colCount = -1
                            }
                            var rangeString = self.rangeToString(new Sheets.Range(row, col, rowCount, colCount));
                            if (rangeString)
                            {
                                var fbx = sheet._formulaTextBox;
                                fbx.repalceRange(resizingInfo.paramRange.index, rangeString)
                            }
                        }
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype.stopFormulaRangeResizing = function()
                {
                    var self = this;
                    self.stopScroll();
                    self.isWorking = false;
                    self.isFormulaRangeResizing = false;
                    self._formulaRangeResizingInfo = keyword_null
                };
                _SheetEventHandler.prototype.getFormulaRangeHitInfo = function(target, x, y)
                {
                    var sheet = this._sheet,
                        fbx = sheet._formulaTextBox,
                        paramRanges = (fbx && fbx.getRanges());
                    if (!paramRanges || paramRanges.length === 0)
                    {
                        return keyword_null
                    }
                    var rowViewportIndex = target.rowViewportIndex,
                        colViewportIndex = target.colViewportIndex;
                    if (this.inGrayArea(rowViewportIndex, colViewportIndex, x, y))
                    {
                        return keyword_null
                    }
                    var paramRange,
                        cr,
                        rect;
                    for (var i = paramRanges.length - 1; i >= 0; i--)
                    {
                        paramRange = paramRanges[i];
                        if (paramRange.allowDrag === false)
                        {
                            continue
                        }
                        var ftbInfo = Sheets.features.formulatextbox && Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                        if (ftbInfo && ftbInfo.text)
                        {
                            continue
                        }
                        cr = this.stringToRange(paramRange.text);
                        if (!cr)
                        {
                            continue
                        }
                        rect = sheet._getRangeRect(rowViewportIndex, colViewportIndex, cr);
                        var size = 5;
                        var x1 = rect.x - 2,
                            x2 = rect.x + rect.width + 1 - size,
                            y1 = rect.y - 2,
                            y2 = rect.y + rect.height + 1 - size;
                        if (x1 + size <= x && x < x2)
                        {
                            if ((y1 + 1 <= y && y <= y1 + 3) || (y2 + 1 <= y && y <= y2 + 3))
                            {
                                return {
                                        paramRange: paramRange, inBorder: true
                                    }
                            }
                        }
                        if (y1 + size <= y && y < y2)
                        {
                            if ((x1 + 1 <= x && x <= x1 + 3) || (x2 + 1 <= x && x <= x2 + 3))
                            {
                                return {
                                        paramRange: paramRange, inBorder: true
                                    }
                            }
                        }
                        if (x2 <= x && x < x2 + size && y2 <= y && y < y2 + size)
                        {
                            return {
                                    paramRange: paramRange, inBottomRight: true
                                }
                        }
                        if (x1 <= x && x < x1 + size && y2 <= y && y < y2 + size)
                        {
                            return {
                                    paramRange: paramRange, inBottomLeft: true
                                }
                        }
                        if (x2 <= x && x < x2 + size && y1 <= y && y < y1 + size)
                        {
                            return {
                                    paramRange: paramRange, inTopRight: true
                                }
                        }
                        if (x1 <= x && x < x1 + size && y1 <= y && y < y1 + size)
                        {
                            return {
                                    paramRange: paramRange, inTopLeft: true
                                }
                        }
                    }
                    return keyword_null
                };
                _SheetEventHandler.prototype.changeFormulaReference = function()
                {
                    var self = this,
                        sheet = self._sheet,
                        fbx = sheet._formulaTextBox;
                    if (!fbx)
                    {
                        return
                    }
                    var spreadNS = GcSpread.Sheets,
                        CalcNS = Sheets.Calc;
                    var baseRow = sheet._activeRowIndex,
                        baseCol = sheet._activeColIndex,
                        useR1C1 = (sheet.referenceStyle() === 1);
                    var context = new CalcNS.ParserContext(sheet._getSheetSource(), useR1C1, baseRow, baseCol);
                    var parser = new CalcNS.Parser;
                    var range,
                        expression;
                    if (fbx.isAppending())
                    {
                        var ranges = fbx.getAppendingRanges();
                        for (var i = 0; i < ranges.length; i++)
                        {
                            range = ranges[i];
                            try
                            {
                                expression = parser.parse(range.text, context)
                            }
                            catch(ex)
                            {
                                expression = keyword_null
                            }
                            if (!expression)
                            {
                                continue
                            }
                            if (expression.t === 2)
                            {
                                self.changeRangeExpressionReference(expression, baseRow, baseCol, true, true);
                                fbx.repalceRange(range.index, parser.unparse(expression, context))
                            }
                            else if (expression.t === 0)
                            {
                                self.changeCellExpressionReference(expression, baseRow, baseCol);
                                fbx.repalceRange(range.index, parser.unparse(expression, context))
                            }
                        }
                    }
                    else
                    {
                        range = fbx.getActiveRange();
                        if (!range)
                        {
                            return
                        }
                        try
                        {
                            expression = parser.parse(range.text, context)
                        }
                        catch(ex)
                        {
                            expression = keyword_null
                        }
                        if (!expression)
                        {
                            return
                        }
                        if (expression.t === 2)
                        {
                            var separatorPosition = range.textOffset + range.text.lastIndexOf(":");
                            var leftActive = (fbx.caret() <= separatorPosition);
                            if (leftActive)
                            {
                                self.changeRangeExpressionReference(expression, baseRow, baseCol, true, false);
                                var newRangeText = parser.unparse(expression, context);
                                fbx.repalceRange(range.index, newRangeText);
                                fbx.caret(range.textOffset + newRangeText.lastIndexOf(":"))
                            }
                            else
                            {
                                self.changeRangeExpressionReference(expression, baseRow, baseCol, false, true);
                                fbx.repalceRange(range.index, parser.unparse(expression, context))
                            }
                        }
                        else if (expression.t === 0)
                        {
                            self.changeCellExpressionReference(expression, baseRow, baseCol);
                            fbx.repalceRange(range.index, parser.unparse(expression, context))
                        }
                    }
                };
                _SheetEventHandler.prototype.changeRangeExpressionReference = function(expression, baseRow, baseCol, changeLeft, changeRight)
                {
                    var startRowRelative = expression.startRowRelative,
                        startColumnRelative = expression.startColumnRelative;
                    if (changeLeft)
                    {
                        if (startRowRelative && startColumnRelative)
                        {
                            expression.startRowRelative = false;
                            expression.startColumnRelative = false;
                            expression.startRow += baseRow;
                            expression.startColumn += baseCol
                        }
                        else if (startRowRelative)
                        {
                            expression.startColumnRelative = true;
                            expression.startColumn -= baseCol
                        }
                        else if (startColumnRelative)
                        {
                            expression.startRowRelative = true;
                            expression.startColumnRelative = false;
                            expression.startRow -= baseRow;
                            expression.startColumn += baseCol
                        }
                        else
                        {
                            expression.startColumnRelative = true;
                            expression.startColumn -= baseCol
                        }
                    }
                    var endRowRelative = expression.endRowRelative,
                        endColumnRelative = expression.endColumnRelative;
                    if (changeRight)
                    {
                        if (endRowRelative && endColumnRelative)
                        {
                            expression.endRowRelative = false;
                            expression.endColumnRelative = false;
                            expression.endRow += baseRow;
                            expression.endColumn += baseCol
                        }
                        else if (endRowRelative)
                        {
                            expression.endColumnRelative = true;
                            expression.endColumn -= baseCol
                        }
                        else if (endColumnRelative)
                        {
                            expression.endRowRelative = true;
                            expression.endColumnRelative = false;
                            expression.endRow -= baseRow;
                            expression.endColumn += baseCol
                        }
                        else
                        {
                            expression.endColumnRelative = true;
                            expression.endColumn -= baseCol
                        }
                    }
                };
                _SheetEventHandler.prototype.changeCellExpressionReference = function(expression, baseRow, baseCol)
                {
                    var rowRelative = expression.rowRelative,
                        columnRelative = expression.columnRelative;
                    if (rowRelative && columnRelative)
                    {
                        expression.rowRelative = false;
                        expression.columnRelative = false;
                        expression.row += baseRow;
                        expression.column += baseCol
                    }
                    else if (rowRelative)
                    {
                        expression.columnRelative = true;
                        expression.column -= baseCol
                    }
                    else if (columnRelative)
                    {
                        expression.rowRelative = true;
                        expression.columnRelative = false;
                        expression.row -= baseRow;
                        expression.column += baseCol
                    }
                    else
                    {
                        expression.columnRelative = true;
                        expression.column -= baseCol
                    }
                };
                _SheetEventHandler.prototype.rangeToString = function(range)
                {
                    if (!range)
                    {
                        return keyword_null
                    }
                    var spreadNS = GcSpread.Sheets,
                        CalcNS = Sheets.Calc;
                    var sheet = this._sheet,
                        baseRow = sheet._activeRowIndex,
                        baseCol = sheet._activeColIndex,
                        useR1C1 = (sheet.referenceStyle() === 1);
                    if (range.row < 0 && range.col < 0)
                    {
                        range = new spreadNS.Range(0, -1, sheet.getRowCount(), -1)
                    }
                    var table = sheet.findTable(range.row, range.col);
                    var ftbAcrossSheet = Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                    if (this.isStructReference(table, range))
                    {
                        if (Sheets.features.formulatextbox && ftbAcrossSheet && ftbAcrossSheet.text && ftbAcrossSheet.sheet !== sheet)
                        {
                            baseRow = baseCol = -1
                        }
                        return CalcNS.rangeToFormulaWithStructReference(sheet, range, baseRow, baseCol, 15, useR1C1, table)
                    }
                    else
                    {
                        var rangeToFormula = CalcNS.rangeToFormula(range, baseRow, baseCol, 15, useR1C1);
                        if (Sheets.features.formulatextbox && ftbAcrossSheet && ftbAcrossSheet.text)
                        {
                            var sheetName = sheet.getName();
                            if (/^\d+$/.test(sheetName) || Sheets.StringUtil.contains(sheetName, " "))
                            {
                                sheetName = "'" + sheetName + "'"
                            }
                            rangeToFormula = sheetName + "!" + rangeToFormula
                        }
                        return rangeToFormula
                    }
                };
                _SheetEventHandler.prototype.isStructReference = function(table, range)
                {
                    if (!table)
                    {
                        return false
                    }
                    var isRowSr = false,
                        isColSr = false;
                    if (range.rowCount === 1)
                    {
                        if (table.hasHeadersRow() && range.row === table.startRow())
                        {
                            return true
                        }
                        if (table.hasTotalsRow() && range.row === table.endRow())
                        {
                            return true
                        }
                    }
                    else
                    {
                        if (table.hasHeadersRow() && range.row === table.startRow())
                        {
                            if (range.rowCount === table.dataRange().rowCount + 1)
                            {
                                isRowSr = true
                            }
                            if (table.hasTotalsRow() && range.rowCount === table.dataRange().rowCount + 1 + 1)
                            {
                                isRowSr = true
                            }
                        }
                        if (range.row === table.dataRange().row)
                        {
                            if (range.rowCount === table.dataRange().rowCount)
                            {
                                isRowSr = true
                            }
                            if (table.hasTotalsRow() && range.rowCount === table.dataRange().rowCount + 1)
                            {
                                isRowSr = true
                            }
                        }
                    }
                    if (range.col + range.colCount <= table.startColumn() + table.dataRange().colCount)
                    {
                        isColSr = true
                    }
                    return isRowSr && isColSr
                };
                _SheetEventHandler.prototype.stringToRange = function(rangeText)
                {
                    if (!rangeText)
                    {
                        return keyword_null
                    }
                    var spreadNS = GcSpread.Sheets,
                        CalcNS = Sheets.Calc;
                    var sheet = this._sheet,
                        baseRow = sheet._activeRowIndex,
                        baseCol = sheet._activeColIndex;
                    try
                    {
                        return CalcNS.formulaToRange(sheet, rangeText, baseRow, baseCol)
                    }
                    catch(ex) {}
                    return keyword_null
                };
                _SheetEventHandler.prototype.startDragFill = function(target)
                {
                    var self = this;
                    if (self.isDraggingFill === true || self.isWorking === true)
                    {
                        return
                    }
                    self.updateDragFillStartRange();
                    if (!self._dragFillStartRange)
                    {
                        return
                    }
                    self.isWorking = true;
                    self.isDraggingFill = true;
                    self._isDragAroundIndicator = true;
                    self._dragStartRowViewport = target.rowViewportIndex;
                    self._dragStartColumnViewport = target.colViewportIndex;
                    self._dragToRowViewport = target.rowViewportIndex;
                    self._dragToColumnViewport = target.colViewportIndex;
                    self.updateDragStartRangeViewports();
                    self.startHitInfo = {
                        scrollRowViewportIndex: target.rowViewportIndex, scrollColViewportIndex: target.colViewportIndex, hitTestType: target.hitTestType
                    };
                    self.startScroll()
                };
                _SheetEventHandler.prototype.updateDragStartRangeViewports = function()
                {
                    var self = this;
                    var dragFillStartTopRow = self.dragFillStartTopRow();
                    if (dragFillStartTopRow >= 0 && dragFillStartTopRow < self._sheet.frozenRowCount)
                    {
                        self._dragFillStartTopRowViewport = 0
                    }
                    else if (dragFillStartTopRow >= self._sheet.frozenRowCount && dragFillStartTopRow <= self._sheet.getRowCount())
                    {
                        self._dragFillStartTopRowViewport = 1
                    }
                    if (self.isDragFillWholeColumns())
                    {
                        self._dragFillStartBottomRowViewport = 1
                    }
                    else
                    {
                        self._dragFillStartBottomRowViewport = self._dragStartRowViewport
                    }
                    var dragFillStartLeftColumn = self.dragFillStartLeftColumn();
                    if (dragFillStartLeftColumn >= 0 && dragFillStartLeftColumn < self._sheet.frozenColCount)
                    {
                        self._dragFillStartLeftColumnViewport = 0
                    }
                    else if (dragFillStartLeftColumn >= self._sheet.frozenColCount && dragFillStartLeftColumn <= self._sheet.getColumnCount())
                    {
                        self._dragFillStartLeftColumnViewport = 1
                    }
                    if (self.isDragFillWholeRows())
                    {
                        self._dragFillStartRightColumnViewport = 1
                    }
                    else
                    {
                        self._dragFillStartRightColumnViewport = self._dragStartColumnViewport
                    }
                };
                _SheetEventHandler.prototype.continueDragFill = function()
                {
                    var self = this;
                    if (!self.startHitInfo || !self.isDraggingFill)
                    {
                        return
                    }
                    if (!self.isWorking || !self._dragFillStartRange)
                    {
                        return
                    }
                    self._dragToRowViewport = self.getHitRowViewportIndex();
                    self._dragToColumnViewport = self.getHitColumnViewportIndex();
                    self._dragToRow = self.getHitRowIndex();
                    self._dragToColumn = self.getHitColumnIndex();
                    if (self._dragToRow >= 0 && self._dragToColumn >= 0)
                    {
                        self.updateCurrentFillSettings();
                        self.updateCurrentFillRange();
                        var currentSpread = self._sheet.parent;
                        var canDragFill = false;
                        var wholeFillRange = self.getDragFillFrameRange();
                        if (wholeFillRange)
                        {
                            canDragFill = self.validateFillRange(self._currentFillRange)
                        }
                        if (currentSpread && currentSpread.showDragFillTip() && canDragFill)
                        {
                            self._showDragFillTooltip()
                        }
                        self.refreshDragFill()
                    }
                    self.continueScroll()
                };
                _SheetEventHandler.prototype._getDragFillTooltipContent = function()
                {
                    if (!Sheets.features.fill)
                    {
                        return keyword_null
                    }
                    var self = this;
                    var sheet = self._sheet;
                    var startRange = self._dragFillStartRange;
                    var fillRange = self._currentFillRange;
                    var autoFillType = self.getDragAutoFillType();
                    var fillDirection = self.getCurrentFillDirection();
                    var dragFillFrameRange = self.getDragFillFrameRange();
                    var fillSeries;
                    if (autoFillType === 1)
                    {
                        if (fillDirection === 0 || fillDirection === 1)
                        {
                            fillSeries = 1
                        }
                        else
                        {
                            fillSeries = 0
                        }
                        var fill = new Sheets.FillImp(sheet);
                        var trendValue = keyword_null;
                        trendValue = fill.fillAuto(dragFillFrameRange, fillSeries, true);
                        var cellRange = self._getAvailableRange(fillDirection, fillRange, startRange);
                        var style = sheet.getActualStyle(cellRange.row, cellRange.col);
                        var ct = (style.cellType || sheet.getDefaultCellType());
                        var fmt = style.formatter ? style.formatter : style._autoFormatter;
                        if (trendValue instanceof Date && Sheets.features.formatter)
                        {
                            fmt = new Sheets.GeneralFormatter(Sheets.DefaultTokens.DateTimeFormatInfo().shortDatePattern + " hh:mm:ss AM/PM;@", 0, Sheets._CultureInfo._currentCulture.Name())
                        }
                        var hitInfo = self.startHitInfo,
                            hitType = 3;
                        if (hitInfo)
                        {
                            hitType = self.startHitInfo.hitTestType
                        }
                        var context = {
                                sheet: sheet, row: cellRange.row, col: cellRange.col, sheetArea: hitType
                            };
                        return ct.format(trendValue, fmt, context)
                    }
                    else if (autoFillType === 0)
                    {
                        var cellRange = self._getAvailableRange(fillDirection, fillRange, startRange);
                        var formula = sheet.getFormula(cellRange.row, cellRange.col);
                        if (formula)
                        {
                            return keyword_null
                        }
                        return sheet.getText(cellRange.row, cellRange.col)
                    }
                    else
                    {
                        return keyword_null
                    }
                };
                _SheetEventHandler.prototype._getAvailableRange = function(fillDirection, fillRange, startRange)
                {
                    var cellRange = new Sheets.Range(startRange.row, startRange.col, 1, 1);
                    if (fillDirection === 3)
                    {
                        var index = fillRange.rowCount % startRange.rowCount;
                        if (index === 0)
                        {
                            index = startRange.row + startRange.rowCount - 1
                        }
                        else
                        {
                            index = startRange.row + index - 1
                        }
                        cellRange.row = index;
                        cellRange.col = startRange.col
                    }
                    else if (fillDirection === 1)
                    {
                        var index = fillRange.colCount % startRange.colCount;
                        if (index === 0)
                        {
                            index = startRange.col + startRange.colCount - 1
                        }
                        else
                        {
                            index = startRange.col + index - 1
                        }
                        cellRange.row = startRange.row;
                        cellRange.col = index
                    }
                    else if (fillDirection === 0)
                    {
                        var index = fillRange.colCount % startRange.colCount;
                        if (index === 0)
                        {
                            index = startRange.col
                        }
                        else
                        {
                            index = startRange.col + startRange.colCount - index
                        }
                        cellRange.row = startRange.row;
                        cellRange.col = index
                    }
                    else if (fillDirection === 2)
                    {
                        var index = fillRange.rowCount % startRange.rowCount;
                        if (index === 0)
                        {
                            index = startRange.row
                        }
                        else
                        {
                            index = startRange.row + startRange.rowCount - index
                        }
                        cellRange.row = index;
                        cellRange.col = startRange.col
                    }
                    return cellRange
                };
                _SheetEventHandler.prototype._showDragFillTooltip = function()
                {
                    var self = this;
                    var autoFillType = self.getDragAutoFillType();
                    if (autoFillType === 4 || self.isDragFillWholeRows() || self.isDragFillWholeColumns())
                    {
                        self._removeTooltip();
                        return keyword_null
                    }
                    else
                    {
                        var left,
                            top,
                            info;
                        var sheet = self._sheet;
                        var fillDirection = self.getCurrentFillDirection();
                        var dragFillFrameRange = self.getDragFillFrameRange();
                        var rect = sheet._getRangeRect2(dragFillFrameRange);
                        info = self._getDragFillTooltipContent();
                        if (fillDirection === 3)
                        {
                            left = rect.x + rect.width + self.DRAGFILLTOOLTIP_OFFSET;
                            top = rect.y + rect.height + self.DRAGFILLTOOLTIP_OFFSET
                        }
                        else if (fillDirection === 1)
                        {
                            left = rect.x + rect.width + self.DRAGFILLTOOLTIP_OFFSET;
                            top = rect.y + rect.height + self.DRAGFILLTOOLTIP_OFFSET
                        }
                        else if (fillDirection === 0)
                        {
                            left = rect.x + self.DRAGFILLTOOLTIP_OFFSET;
                            top = rect.y + rect.height + self.DRAGFILLTOOLTIP_OFFSET
                        }
                        else if (fillDirection === 2)
                        {
                            left = rect.x + rect.width + self.DRAGFILLTOOLTIP_OFFSET;
                            top = rect.y + self.DRAGFILLTOOLTIP_OFFSET
                        }
                        self._showTooltip(info, left, top)
                    }
                };
                _SheetEventHandler.prototype.refreshDragFill = function()
                {
                    var self = this;
                    self.clearDragFill();
                    self.refreshSelectionBorder();
                    self.paintDragFill();
                    self._oldDragFillFrameRange = self.getDragFillFrameRange()
                };
                _SheetEventHandler.prototype.clearDragFill = function()
                {
                    var sheet = this._sheet;
                    if (this._oldDragFillFrameRange)
                    {
                        var oldDragFillRect = sheet._getRangeRect2(this._oldDragFillFrameRange);
                        oldDragFillRect.x -= 2;
                        oldDragFillRect.y -= 2;
                        oldDragFillRect.width += 4;
                        oldDragFillRect.height += 4;
                        sheet._render.copyDoubleBufferRect(oldDragFillRect)
                    }
                };
                _SheetEventHandler.prototype.refreshSelectionBorder = function(ctx)
                {
                    var sheet = this._sheet;
                    sheet._render.repaintSelection(this._dragFillStartRange, keyword_null, ctx)
                };
                _SheetEventHandler.prototype.paintDragFill = function()
                {
                    var sheet = this._sheet;
                    var render = sheet._render;
                    var dragFillFrameRange = this.getDragFillFrameRange();
                    if (!dragFillFrameRange)
                    {
                        return
                    }
                    var ctx = render._getCtx();
                    var dragFillRect = sheet._getRangeRect2(dragFillFrameRange);
                    ctx.save();
                    ctx.beginPath();
                    render.paintDragRectangle(ctx, dragFillRect);
                    ctx.restore()
                };
                _SheetEventHandler.prototype.updateCurrentFillRange = function()
                {
                    this._currentFillRange = this.getCurrentFillRange()
                };
                _SheetEventHandler.prototype.isDragFillWholeRows = function()
                {
                    return this._dragFillStartRange.col === -1 && this._dragFillStartRange.row !== -1
                };
                _SheetEventHandler.prototype.isDragFillWholeColumns = function()
                {
                    return this._dragFillStartRange.row === -1 && this._dragFillStartRange.col !== -1
                };
                _SheetEventHandler.prototype.isDragClear = function()
                {
                    return this._currentFillDirection === 4 || this._currentFillDirection === 5
                };
                _SheetEventHandler.prototype.getCurrentFillRange = function()
                {
                    var self = this;
                    var row = -1,
                        column = -1,
                        rowCount = -1,
                        columnCount = -1;
                    switch (self._currentFillDirection)
                    {
                        case 0:
                            if (self.isDragFillWholeColumns())
                            {
                                row = -1;
                                rowCount = -1
                            }
                            else
                            {
                                row = self.dragFillStartTopRow();
                                rowCount = self._dragFillStartRange.rowCount
                            }
                            column = self._dragToColumn;
                            columnCount = self.dragFillStartLeftColumn() - column;
                            break;
                        case 1:
                            if (self.isDragFillWholeColumns())
                            {
                                row = -1;
                                rowCount = -1
                            }
                            else
                            {
                                row = self.dragFillStartTopRow();
                                rowCount = self._dragFillStartRange.rowCount
                            }
                            column = self.dragFillStartRightColumn() + 1;
                            columnCount = self._dragToColumn - column + 1;
                            break;
                        case 2:
                            row = self._dragToRow;
                            rowCount = self.dragFillStartTopRow() - row;
                            if (self.isDragFillWholeRows())
                            {
                                column = -1;
                                columnCount = -1
                            }
                            else
                            {
                                column = self.dragFillStartLeftColumn();
                                columnCount = self._dragFillStartRange.colCount
                            }
                            break;
                        case 3:
                            row = self.dragFillStartBottomRow() + 1;
                            rowCount = self._dragToRow - row + 1;
                            if (self.isDragFillWholeRows())
                            {
                                column = -1;
                                columnCount = -1
                            }
                            else
                            {
                                column = self.dragFillStartLeftColumn();
                                columnCount = self._dragFillStartRange.colCount
                            }
                            break;
                        case 5:
                            row = self._dragToRow;
                            rowCount = self.dragFillStartBottomRow() - row + 1;
                            if (self.isDragFillWholeRows())
                            {
                                column = -1;
                                columnCount = -1
                            }
                            else
                            {
                                column = self.dragFillStartLeftColumn();
                                columnCount = self._dragFillStartRange.colCount
                            }
                            break;
                        case 4:
                            if (self.isDragFillWholeColumns())
                            {
                                row = -1;
                                rowCount = -1
                            }
                            else
                            {
                                row = self._dragFillStartRange.row;
                                rowCount = self._dragFillStartRange.rowCount
                            }
                            column = self._dragToColumn;
                            columnCount = self.dragFillStartRightColumn() - column + 1;
                            break;
                        default:
                            break
                    }
                    return new Sheets.Range(row, column, rowCount, columnCount)
                };
                _SheetEventHandler.prototype.dragFillStartBottomRowLayout = function()
                {
                    var dragStartBottomRow = this.dragFillStartBottomRow();
                    if (dragStartBottomRow !== -1)
                    {
                        return this._sheet._getRowLayout(this._dragFillStartBottomRowViewport).findRow(dragStartBottomRow)
                    }
                    return keyword_null
                };
                _SheetEventHandler.prototype.dragFillToViewportBottomRowLayout = function()
                {
                    return this._sheet._getRowLayout(this._dragToRowViewport).findRow(this.dragFillToViewportBottomRow())
                };
                _SheetEventHandler.prototype.dragFillToViewportBottomRow = function()
                {
                    return this._sheet.getViewportBottomRow(this._dragToRowViewport)
                };
                _SheetEventHandler.prototype.dragFillStartRightColumnLayout = function()
                {
                    var dragStartRightColumn = this.dragFillStartRightColumn();
                    if (dragStartRightColumn !== -1)
                    {
                        return this._sheet._getColumnLayout(this._dragFillStartRightColumnViewport).findCol(dragStartRightColumn)
                    }
                    return keyword_null
                };
                _SheetEventHandler.prototype.dragFillToViewportRightColumnLayout = function()
                {
                    return this._sheet._getColumnLayout(this._dragToColumnViewport).findCol(this.dragFillToViewportRightColumn())
                };
                _SheetEventHandler.prototype.dragFillToViewportRightColumn = function()
                {
                    return this._sheet.getViewportRightColumn(this._dragToColumnViewport)
                };
                _SheetEventHandler.prototype.updateCurrentFillSettings = function()
                {
                    var self = this;
                    var isWholeRows = self.isDragFillWholeRows(),
                        isWholeColumns = self.isDragFillWholeColumns();
                    var t = $(self._sheet._getCanvas()).offset();
                    var e = self.mousePosition.e,
                        x = self.mousePosition.x,
                        y = self.mousePosition.y;
                    var actualX = e.pageX - t.left,
                        actualY = e.pageY - t.top,
                        notClear = false;
                    var hOffset,
                        vOffset;
                    if (!isWholeRows && !isWholeColumns)
                    {
                        if (self._dragToRow >= self.dragFillStartTopRow() && self._dragToRow <= self.dragFillStartBottomRow())
                        {
                            if (self._dragToColumn >= self.dragFillStartLeftColumn() && self._dragToColumn <= self.dragFillStartRightColumn())
                            {
                                hOffset = Math_abs(self._dragToColumn - self.dragFillStartRightColumn());
                                vOffset = Math_abs(self._dragToRow - self.dragFillStartBottomRow());
                                if (vOffset > hOffset)
                                {
                                    self._currentFillDirection = 5
                                }
                                else if (vOffset < hOffset)
                                {
                                    self._currentFillDirection = 4
                                }
                                else
                                {
                                    var dragFillStartBottomRowLayout = self.dragFillStartBottomRowLayout();
                                    if (!dragFillStartBottomRowLayout)
                                    {
                                        dragFillStartBottomRowLayout = self.dragFillToViewportBottomRowLayout()
                                    }
                                    if (y > dragFillStartBottomRowLayout.y + dragFillStartBottomRowLayout.height)
                                    {
                                        self._currentFillDirection = 3
                                    }
                                    else
                                    {
                                        var dragFillStartRightColumnLayout = self.dragFillStartRightColumnLayout();
                                        if (!dragFillStartRightColumnLayout)
                                        {
                                            dragFillStartRightColumnLayout = self.dragFillToViewportRightColumnLayout()
                                        }
                                        var hDistance = dragFillStartRightColumnLayout.x + dragFillStartRightColumnLayout.width - x;
                                        var vDistance = dragFillStartBottomRowLayout.y + dragFillStartBottomRowLayout.height - y;
                                        if (actualX >= dragFillStartRightColumnLayout.x && actualX <= dragFillStartRightColumnLayout.x + dragFillStartRightColumnLayout.width && actualY >= dragFillStartBottomRowLayout.y && actualY <= dragFillStartBottomRowLayout.y + dragFillStartBottomRowLayout.height)
                                        {
                                            if (hDistance >= vDistance)
                                            {
                                                self._currentFillDirection = 4
                                            }
                                            else
                                            {
                                                self._currentFillDirection = 5
                                            }
                                        }
                                        else
                                        {
                                            notClear = true
                                        }
                                    }
                                }
                            }
                            else if (self._dragToColumn < self.dragFillStartLeftColumn())
                            {
                                self._currentFillDirection = 0
                            }
                            else if (self._dragToColumn > self.dragFillStartRightColumn())
                            {
                                self._currentFillDirection = 1
                            }
                        }
                        else if (self._dragToRow < self.dragFillStartTopRow())
                        {
                            if (self._dragToColumn >= self.dragFillStartLeftColumn() && self._dragToColumn <= self.dragFillStartRightColumn())
                            {
                                self._currentFillDirection = 2
                            }
                            else if (self._dragToColumn < self.dragFillStartLeftColumn())
                            {
                                hOffset = Math_abs(self._dragToColumn - self.dragFillStartLeftColumn());
                                vOffset = Math_abs(self._dragToRow - self.dragFillStartTopRow());
                                if (vOffset >= hOffset)
                                {
                                    self._currentFillDirection = 2
                                }
                                else
                                {
                                    self._currentFillDirection = 0
                                }
                            }
                            else if (self._dragToColumn > self.dragFillStartRightColumn())
                            {
                                hOffset = Math_abs(self._dragToColumn - self.dragFillStartRightColumn());
                                vOffset = Math_abs(self._dragToRow - self.dragFillStartTopRow());
                                if (vOffset >= hOffset)
                                {
                                    self._currentFillDirection = 2
                                }
                                else
                                {
                                    self._currentFillDirection = 1
                                }
                            }
                        }
                        else if (self._dragToRow > self.dragFillStartBottomRow())
                        {
                            if (self._dragToColumn >= self.dragFillStartLeftColumn() && self._dragToColumn <= self.dragFillStartRightColumn())
                            {
                                self._currentFillDirection = 3
                            }
                            else if (self._dragToColumn < self.dragFillStartLeftColumn())
                            {
                                hOffset = Math_abs(self._dragToColumn - self.dragFillStartLeftColumn());
                                vOffset = Math_abs(self._dragToRow - self.dragFillStartBottomRow());
                                if (vOffset >= hOffset)
                                {
                                    self._currentFillDirection = 3
                                }
                                else
                                {
                                    self._currentFillDirection = 0
                                }
                            }
                            else if (self._dragToColumn > self.dragFillStartRightColumn())
                            {
                                hOffset = Math_abs(self._dragToColumn - self.dragFillStartRightColumn());
                                vOffset = Math_abs(self._dragToRow - self.dragFillStartBottomRow());
                                if (vOffset >= hOffset)
                                {
                                    self._currentFillDirection = 3
                                }
                                else
                                {
                                    self._currentFillDirection = 1
                                }
                            }
                        }
                    }
                    else if (isWholeColumns)
                    {
                        if (self._dragToColumn >= self.dragFillStartLeftColumn() && self._dragToColumn <= self.dragFillStartRightColumn())
                        {
                            self._currentFillDirection = 4
                        }
                        else if (self._dragToColumn < self.dragFillStartLeftColumn())
                        {
                            self._currentFillDirection = 0
                        }
                        else if (self._dragToColumn > self.dragFillStartRightColumn())
                        {
                            self._currentFillDirection = 1
                        }
                    }
                    else if (isWholeRows)
                    {
                        if (self._dragToRow >= self.dragFillStartTopRow() && self._dragToRow <= self.dragFillStartBottomRow())
                        {
                            self._currentFillDirection = 5
                        }
                        else if (self._dragToRow < self.dragFillStartTopRow())
                        {
                            self._currentFillDirection = 2
                        }
                        else if (self._dragToRow > self.dragFillStartBottomRow())
                        {
                            self._currentFillDirection = 3
                        }
                    }
                    var rect = self._sheet._dragFillIndicatorRect;
                    if (rect)
                    {
                        var currentRow = self.dragFillStartBottomRow(),
                            currentColumn = self.dragFillStartRightColumn(),
                            nextRow = currentRow + 1,
                            nextColumn = currentColumn + 1;
                        var currentRowHieght = self._sheet.getRowHeight(currentRow, 3),
                            currentColumnWidth = self._sheet.getColumnWidth(currentColumn, 3),
                            nextRowHeight = self._sheet.getRowHeight(nextRow, 3),
                            nextColumnWidth = self._sheet.getColumnWidth(nextColumn, 3);
                        var minX = (rect.x + rect.width / 2) - Math_min(10, currentColumnWidth / 2),
                            maxX = (rect.x + rect.width / 2) + Math_min(10, nextColumnWidth / 2),
                            minY = (rect.y + rect.height / 2) - Math_min(10, currentRowHieght / 2),
                            maxY = (rect.y + rect.height / 2) + Math_min(10, nextRowHeight / 2);
                        var isAroundIndicator = false;
                        if (!isWholeRows && !isWholeColumns)
                        {
                            isAroundIndicator = (minX <= actualX && actualX <= maxX && minY <= actualY && actualY <= maxY)
                        }
                        else if (isWholeColumns)
                        {
                            isAroundIndicator = (minX <= actualX && actualX <= maxX)
                        }
                        else if (isWholeRows)
                        {
                            isAroundIndicator = (minY <= actualY && actualY <= maxY)
                        }
                        if (isAroundIndicator || notClear)
                        {
                            self._isDragAroundIndicator = true;
                            self._currentFillDirection = 4
                        }
                        else
                        {
                            self._isDragAroundIndicator = false
                        }
                    }
                };
                _SheetEventHandler.prototype.dragFillStartTopRow = function()
                {
                    if (!this._dragFillStartRange)
                    {
                        return -1
                    }
                    else if (this._dragFillStartRange.row === -1)
                    {
                        return 0
                    }
                    else
                    {
                        return this._dragFillStartRange.row
                    }
                };
                _SheetEventHandler.prototype.dragFillStartBottomRow = function()
                {
                    var self = this;
                    if (!self._dragFillStartRange)
                    {
                        return -1
                    }
                    else if (self._dragFillStartRange.row === -1)
                    {
                        return self._sheet.getRowCount() - 1
                    }
                    else
                    {
                        return self._dragFillStartRange.row + self._dragFillStartRange.rowCount - 1
                    }
                };
                _SheetEventHandler.prototype.dragFillStartLeftColumn = function()
                {
                    if (!this._dragFillStartRange)
                    {
                        return -1
                    }
                    else if (this._dragFillStartRange.col === -1)
                    {
                        return 0
                    }
                    else
                    {
                        return this._dragFillStartRange.col
                    }
                };
                _SheetEventHandler.prototype.dragFillStartRightColumn = function()
                {
                    var self = this;
                    if (!self._dragFillStartRange)
                    {
                        return -1
                    }
                    else if (self._dragFillStartRange.col === -1)
                    {
                        return self._sheet.getColumnCount() - 1
                    }
                    else
                    {
                        return self._dragFillStartRange.col + self._dragFillStartRange.colCount - 1
                    }
                };
                _SheetEventHandler.prototype.endDragFill = function()
                {
                    var self = this,
                        sheet = self._sheet;
                    self.startHitInfo = keyword_null;
                    self.stopScroll();
                    self._removeTooltip();
                    if (!self.isDraggingFill || !self.isWorking)
                    {
                        self.resetDragFill();
                        return
                    }
                    self.isDraggingFill = false;
                    self.isWorking = false;
                    var wholeFillRange = self.getDragFillFrameRange();
                    if (!wholeFillRange)
                    {
                        return
                    }
                    var canDragFill = self.validateFillRange(self._currentFillRange);
                    if (!canDragFill || self._isDragAroundIndicator)
                    {
                        self.resetDragFill();
                        self.refreshSelection(wholeFillRange)
                    }
                    else
                    {
                        var autoFillType = self.getDragAutoFillType();
                        var fillUndoAction = new Sheets.UndoRedo.FillUndoAction(sheet, autoFillType, false, self._currentFillRange);
                        sheet._doCommand(fillUndoAction);
                        var cancel = self._isCancelDragFill;
                        if (!cancel && self.isDragFill() && sheet.showDragFillSmartTag() && self._currentDragFillType !== 4)
                        {
                            self.showDragFillSmartTag(self._currentDragFillType)
                        }
                        else
                        {
                            self.refreshSelection(wholeFillRange)
                        }
                        self.resetDragFill()
                    }
                };
                _SheetEventHandler.prototype.showDragFillSmartTag = function(autoFillType)
                {
                    if (!Sheets.features.fill_ui)
                    {
                        return
                    }
                    var sheet = this._sheet;
                    var rect = sheet._dragFillIndicatorRect;
                    var fillInfo = {
                            x: rect.x + rect.width, y: rect.y + rect.height, fillType: autoFillType
                        };
                    sheet._smartTag = new Sheets._GcFillDialog(sheet, fillInfo);
                    sheet._smartTag.open()
                };
                _SheetEventHandler.prototype.updateDragFillStartRange = function()
                {
                    var sheet = this._sheet;
                    if (sheet._selectionModel.length === 1)
                    {
                        this._dragFillStartRange = sheet._selectionModel[0]
                    }
                    else if (sheet._activeRowIndex >= 0 && sheet._activeColIndex >= 0)
                    {
                        this._dragFillStartRange = new Sheets.Range(sheet._activeRowIndex, sheet._activeColIndex, 1, 1)
                    }
                };
                _SheetEventHandler.prototype.resetDragFill = function()
                {
                    this.isWorking = false;
                    this.isDraggingFill = false
                };
                _SheetEventHandler.prototype.refreshSelection = function(range)
                {
                    this._sheet._render.repaintSelection(range)
                };
                _SheetEventHandler.prototype.getDragAutoFillType = function()
                {
                    var self = this,
                        sheet = self._sheet,
                        defaultDragFillType = sheet.defaultDragFillType();
                    if (self.isDragClear())
                    {
                        return 4
                    }
                    if (defaultDragFillType !== 5)
                    {
                        return defaultDragFillType
                    }
                    var isDragSingleCell = (self._dragFillStartRange.rowCount === 1 && self._dragFillStartRange.colCount === 1) && !self.isDragFillWholeColumns() && !self.isDragFillWholeRows();
                    if (isDragSingleCell)
                    {
                        if (self.isControlPressed)
                        {
                            return 1
                        }
                        else
                        {
                            return 0
                        }
                    }
                    else
                    {
                        if (self.isControlPressed)
                        {
                            return 0
                        }
                        else
                        {
                            return 1
                        }
                    }
                };
                _SheetEventHandler.prototype.getDragFillFrameRange = function()
                {
                    var self = this;
                    if (!self._dragFillStartRange)
                    {
                        return keyword_null
                    }
                    if (self.isDragClear())
                    {
                        return self._dragFillStartRange
                    }
                    if (!self._currentFillRange)
                    {
                        return keyword_null
                    }
                    var row = 0,
                        rowCount = 0,
                        column = 0,
                        columnCount = 0;
                    if (self.isVerticalDragFill())
                    {
                        row = self._currentFillDirection === 2 ? self._currentFillRange.row : self._dragFillStartRange.row;
                        rowCount = self._dragFillStartRange.rowCount + self._currentFillRange.rowCount;
                        column = self._dragFillStartRange.col;
                        columnCount = self._dragFillStartRange.colCount
                    }
                    else
                    {
                        row = self._dragFillStartRange.row;
                        rowCount = self._dragFillStartRange.rowCount;
                        column = self._currentFillDirection === 0 ? self._currentFillRange.col : self._dragFillStartRange.col;
                        columnCount = self._dragFillStartRange.colCount + self._currentFillRange.colCount
                    }
                    return new Sheets.Range(row, column, rowCount, columnCount)
                };
                _SheetEventHandler.prototype.validateFillRange = function(fillRange)
                {
                    var sheet = this._sheet;
                    var canDragFill = true;
                    var invalidMessage = "";
                    if (sheet._hasSpans(fillRange.row, fillRange.col, fillRange.rowCount, fillRange.colCount))
                    {
                        canDragFill = false;
                        invalidMessage = Sheets.SR.Exp_FillRangeContainsMergedCell
                    }
                    if (canDragFill && sheet.isProtected)
                    {
                        if (sheet._isAnyCellInRangeLocked(fillRange))
                        {
                            canDragFill = false;
                            invalidMessage = Sheets.SR.Exp_FillCellsReadOnly
                        }
                    }
                    if (!canDragFill)
                    {
                        sheet._raiseInvalidOperation(2, invalidMessage)
                    }
                    return canDragFill
                };
                _SheetEventHandler.prototype.isDragFill = function()
                {
                    return this.isIncreaseFill() || this.isDecreaseFill()
                };
                _SheetEventHandler.prototype.isIncreaseFill = function()
                {
                    return this._currentFillDirection === 3 || this._currentFillDirection === 1
                };
                _SheetEventHandler.prototype.isDecreaseFill = function()
                {
                    return this._currentFillDirection === 0 || this._currentFillDirection === 2
                };
                _SheetEventHandler.prototype.isVerticalDragFill = function()
                {
                    return this._currentFillDirection === 2 || this._currentFillDirection === 3 || this._currentFillDirection === 5
                };
                _SheetEventHandler.prototype.isDragToRowInView = function()
                {
                    return this.isRowInViewport(this._dragToRowViewport, this._dragToRow)
                };
                _SheetEventHandler.prototype.isRowInViewport = function(rowViewport, row)
                {
                    var viewportTopRow = this._sheet.getViewportTopRow(rowViewport);
                    var viewportBottomRow = this._sheet.getViewportBottomRow(rowViewport);
                    if (row >= viewportTopRow && row <= viewportBottomRow)
                    {
                        return true
                    }
                    else
                    {
                        return false
                    }
                };
                _SheetEventHandler.prototype.getCurrentDragToRowLayout = function()
                {
                    return this._sheet._getRowLayout(this._dragToRowViewport).findRow(this._dragToRow)
                };
                _SheetEventHandler.prototype.isDragFillStartBottomRowInView = function()
                {
                    return this.isRowInViewport(this._dragFillStartBottomRowViewport, this.dragFillStartBottomRow())
                };
                _SheetEventHandler.prototype.dragFillStartViewportBottomRowLayout = function()
                {
                    return this._sheet._getRowLayout(this._dragStartRowViewport).findRow(this.dragFillStartViewportBottomRow())
                };
                _SheetEventHandler.prototype.dragFillStartViewportBottomRow = function()
                {
                    return this._sheet.getViewportBottomRow(this._dragStartRowViewport)
                };
                _SheetEventHandler.prototype.getValidVerDragToRowLayout = function()
                {
                    var self = this;
                    var rowLayout;
                    if (self.isIncreaseFill())
                    {
                        if (self.isDragToRowInView())
                        {
                            rowLayout = self.getCurrentDragToRowLayout()
                        }
                        else
                        {
                            rowLayout = self.dragFillToViewportBottomRowLayout()
                        }
                    }
                    else
                    {
                        if (self.isDragFillStartBottomRowInView)
                        {
                            rowLayout = self.dragFillStartBottomRowLayout()
                        }
                        else
                        {
                            rowLayout = self.dragFillStartViewportBottomRowLayout()
                        }
                    }
                    return rowLayout
                };
                _SheetEventHandler.prototype.isDragToColumnInView = function()
                {
                    return this.isColumnInViewport(this._dragToColumnViewport, this._dragToColumn)
                };
                _SheetEventHandler.prototype.isColumnInViewport = function(columnViewport, column)
                {
                    var viewportLeftColumn = this._sheet.getViewportLeftColumn(columnViewport);
                    var viewportRightColumn = this._sheet.getViewportRightColumn(columnViewport);
                    if (column >= viewportLeftColumn && column <= viewportRightColumn)
                    {
                        return true
                    }
                    else
                    {
                        return false
                    }
                };
                _SheetEventHandler.prototype.getCurrentDragToColumnLayout = function()
                {
                    return this._sheet._getColumnLayout(this._dragToColumnViewport).findCol(this._dragToColumn)
                };
                _SheetEventHandler.prototype.isDragFillStartRightColumnInView = function()
                {
                    return this.isColumnInViewport(this._dragFillStartRightColumnViewport, this.dragFillStartRightColumn())
                };
                _SheetEventHandler.prototype.dragFillStartViewportRightColumnLayout = function()
                {
                    return this._sheet._getColumnLayout(this._dragStartColumnViewport).findCol(this.dragFillStartViewportRightColumn())
                };
                _SheetEventHandler.prototype.dragFillStartViewportRightColumn = function()
                {
                    return this._sheet.getViewportRightColumn(this._dragStartColumnViewport)
                };
                _SheetEventHandler.prototype.getValidHorDragToColumnLayout = function()
                {
                    var self = this;
                    var columnLayout;
                    if (self.isIncreaseFill())
                    {
                        if (self.isDragToColumnInView())
                        {
                            columnLayout = self.getCurrentDragToColumnLayout()
                        }
                        else
                        {
                            columnLayout = self.dragFillToViewportRightColumnLayout()
                        }
                    }
                    else
                    {
                        if (self.isDragFillStartRightColumnInView())
                        {
                            columnLayout = self.dragFillStartRightColumnLayout()
                        }
                        else
                        {
                            columnLayout = self.dragFillStartViewportRightColumnLayout()
                        }
                    }
                    return columnLayout
                };
                _SheetEventHandler.prototype.dragFillToViewportTopRowLayout = function()
                {
                    return this._sheet._getRowLayout(this._dragToRowViewport).findRow(this.dragFillToViewportTopRow())
                };
                _SheetEventHandler.prototype.dragFillToViewportTopRow = function()
                {
                    return this._sheet.getViewportTopRow(this._dragToRowViewport)
                };
                _SheetEventHandler.prototype.dragFillToViewportLeftColumnLayout = function()
                {
                    return this._sheet._getColumnLayout(this._dragToColumnViewport).findCol(this.dragFillToViewportLeftColumn())
                };
                _SheetEventHandler.prototype.dragFillToViewportLeftColumn = function()
                {
                    return this._sheet.getViewportLeftColumn(this._dragToColumnViewport)
                };
                _SheetEventHandler.prototype.getCurrentFillDirection = function()
                {
                    switch (this._currentFillDirection)
                    {
                        case 0:
                            return 0;
                        case 1:
                            return 1;
                        case 2:
                            return 2;
                        case 3:
                            return 3;
                        case 4:
                            return 0;
                        case 5:
                            return 2;
                        default:
                            break
                    }
                    return 3
                };
                _SheetEventHandler.prototype.getHitRowViewportIndex = function()
                {
                    var sheet = this._sheet;
                    var rowViewportIndex = sheet._getRowViewportIndexNearY(this.mousePosition.y);
                    var scrollRowViewportIndex = this.startHitInfo.scrollRowViewportIndex;
                    var rowLayoutModel = sheet._getRowLayout(1);
                    if (rowViewportIndex === 0 && scrollRowViewportIndex > 0 && rowLayoutModel.length > 0 && rowLayoutModel[0].row > sheet._getFirstPageTopRow())
                    {
                        rowViewportIndex = 1
                    }
                    else if (rowViewportIndex === 2 && scrollRowViewportIndex < 2 && rowLayoutModel.length > 0 && rowLayoutModel[rowLayoutModel.length - 1].row < sheet._getLastVisualRow())
                    {
                        rowViewportIndex = 1
                    }
                    return rowViewportIndex
                };
                _SheetEventHandler.prototype.getHitColumnViewportIndex = function()
                {
                    var sheet = this._sheet;
                    var colViewportIndex = sheet._getColumnViewportIndexNearX(this.mousePosition.x);
                    var scrollColViewportIndex = this.startHitInfo.scrollColViewportIndex;
                    var colLayoutModel = sheet._getColumnLayout(1);
                    if (colViewportIndex === 0 && scrollColViewportIndex > 0 && colLayoutModel.length > 0 && colLayoutModel[0].col > sheet._getFirstPageLeftColumn())
                    {
                        colViewportIndex = 1
                    }
                    else if (colViewportIndex === 2 && scrollColViewportIndex < 2 && colLayoutModel.length > 0 && colLayoutModel[colLayoutModel.length - 1].col < sheet._getLastVisualColumn())
                    {
                        colViewportIndex = 1
                    }
                    return colViewportIndex
                };
                _SheetEventHandler.prototype.getHitRowIndex = function()
                {
                    var sheet = this._sheet;
                    var y = this.mousePosition.y;
                    var rowViewportIndex = this.getHitRowViewportIndex();
                    var rowLayout = sheet._getViewportRowLayoutNearY(rowViewportIndex, y);
                    if (rowLayout)
                    {
                        var layout = sheet._getSheetLayout();
                        var hitRow = rowLayout.row;
                        if (rowViewportIndex === 1 && y < layout.viewportY && hitRow > sheet._getFirstPageTopRow())
                        {
                            return (sheet._getNextVisualRow(hitRow - 1) || hitRow)
                        }
                        if (rowViewportIndex === 1 && y > layout.frozenTrailingY && hitRow > sheet._getLastFullyVisibleRow())
                        {
                            return (sheet._getPrevVisualRow(hitRow) || hitRow)
                        }
                        return hitRow
                    }
                    return -1
                };
                _SheetEventHandler.prototype.getHitColumnIndex = function()
                {
                    var sheet = this._sheet;
                    var x = this.mousePosition.x;
                    var colViewportIndex = this.getHitColumnViewportIndex();
                    var colLayout = sheet._getViewportColumnLayoutNearX(colViewportIndex, x);
                    if (colLayout)
                    {
                        var layout = sheet._getSheetLayout();
                        var hitCol = colLayout.col;
                        if (colViewportIndex === 1 && x < layout.viewportX && hitCol > sheet._getFirstPageLeftColumn())
                        {
                            return (sheet._getNextVisualColumn(hitCol - 1) || hitCol)
                        }
                        if (colViewportIndex === 1 && x > layout.frozenTrailingX && hitCol > sheet._getLastFullyVisibleColumn())
                        {
                            return (sheet._getPrevVisualColumn(hitCol) || hitCol)
                        }
                        return hitCol
                    }
                    return -1
                };
                _SheetEventHandler.prototype.getIntervalFromDistance = function(distance)
                {
                    var interval = 0;
                    if (!isNaN(distance) && distance !== 0)
                    {
                        var isNegative = (distance < 0);
                        distance = Math_abs(distance);
                        interval = Math_ceil(500 / distance);
                        interval = Math_max(20, interval * 10);
                        if (interval > 200)
                        {
                            interval = 200
                        }
                        if (isNegative)
                        {
                            interval = -interval
                        }
                    }
                    return interval
                };
                _SheetEventHandler.prototype.updateRange = function(row, col, rowCount, colCount)
                {
                    if (rowCount === 0 || colCount === 0)
                    {
                        return
                    }
                    var self = this;
                    var sheet = self._sheet;
                    var viewport = 3;
                    var frozRowLayoutModel = sheet._getRowLayout(0, viewport);
                    var frozColLayoutModel = sheet._getColumnLayout(0, viewport);
                    var rowLayoutModel = sheet._getRowLayout(1, viewport);
                    var colLayoutModel = sheet._getColumnLayout(1, viewport);
                    var maxCol = 0;
                    if (frozColLayoutModel && frozColLayoutModel.length > 0)
                    {
                        maxCol = frozColLayoutModel[frozColLayoutModel.length - 1].col
                    }
                    if (colLayoutModel && colLayoutModel.length > 0)
                    {
                        maxCol = colLayoutModel[colLayoutModel.length - 1].col
                    }
                    var y = self.getYForRow(row, col, rowCount, colCount, true, maxCol, frozRowLayoutModel, rowLayoutModel);
                    var y2 = self.getYForRow(row, col, rowCount, colCount, false, maxCol, frozRowLayoutModel, rowLayoutModel);
                    var maxRow = 0;
                    if (frozRowLayoutModel && frozRowLayoutModel.length > 0)
                    {
                        maxRow = frozRowLayoutModel[frozRowLayoutModel.length - 1].row
                    }
                    if (rowLayoutModel && rowLayoutModel.length > 0)
                    {
                        maxRow = rowLayoutModel[rowLayoutModel.length - 1].row
                    }
                    var x = self.getXForCol(row, col, rowCount, colCount, true, maxRow, frozColLayoutModel, colLayoutModel);
                    var x2 = self.getXForCol(row, col, rowCount, colCount, false, maxRow, frozColLayoutModel, colLayoutModel);
                    var layout = sheet._getSheetLayout(),
                        render = sheet._render;
                    if (x2 > x && y2 > y)
                    {
                        render.update(x - layout.headerX - 2, y - layout.headerY - 2, x2 - x + 2 * layout.headerX + 2, y2 - y + 2 * layout.headerY + 2)
                    }
                    if (y2 > y)
                    {
                        render.update(layout.headerX, y, layout.rowHeaderWidth, y2 - y)
                    }
                    if (x2 > x)
                    {
                        render.update(x, layout.headerY, x2 - x, layout.colHeaderHeight);
                        render.update(x, layout.footerY, x2 - x, layout.colHeaderHeight)
                    }
                };
                _SheetEventHandler.prototype.getYForRow = function(row, col, rowCount, colCount, bTop, maxCol, frozRowLayoutModel, rowLayoutModel)
                {
                    var sheet = this._sheet;
                    var trow = row;
                    if (!bTop)
                    {
                        trow = row + rowCount - 1
                    }
                    if (trow < sheet.frozenRowCount)
                    {
                        if (frozRowLayoutModel.length < 1)
                        {
                            return -1
                        }
                    }
                    else
                    {
                        if (rowLayoutModel.length < 1)
                        {
                            return -1
                        }
                        if (bTop)
                        {
                            if (trow < rowLayoutModel[0].row)
                            {
                                trow = rowLayoutModel[0].row
                            }
                        }
                        else
                        {
                            if (trow > rowLayoutModel[rowLayoutModel.length - 1].row)
                            {
                                trow = rowLayoutModel[rowLayoutModel.length - 1].row
                            }
                        }
                    }
                    var y = 0;
                    if (bTop)
                    {
                        y = 90000
                    }
                    for (var c = Math_max(sheet._scrollLeftCol, col); c < col + colCount && c <= maxCol; c++)
                    {
                        var rect = sheet.getCellRect(trow, c);
                        if (rect)
                        {
                            if (bTop)
                            {
                                if (rect.y < y)
                                {
                                    y = rect.y
                                }
                            }
                            else
                            {
                                if (y < rect.y + rect.height)
                                {
                                    y = rect.y + rect.height
                                }
                            }
                        }
                    }
                    return y
                };
                _SheetEventHandler.prototype.getXForCol = function(row, col, rowCount, colCount, bLeft, maxRow, frozColLayoutModel, colLayoutModel)
                {
                    var sheet = this._sheet;
                    var tcol = col;
                    if (!bLeft)
                    {
                        tcol = col + colCount - 1
                    }
                    if (tcol < sheet.frozenColCount)
                    {
                        if (frozColLayoutModel.length < 1)
                        {
                            return
                        }
                    }
                    else
                    {
                        if (colLayoutModel.length < 1)
                        {
                            return
                        }
                        if (bLeft)
                        {
                            if (tcol < colLayoutModel[0].col)
                            {
                                tcol = colLayoutModel[0].col
                            }
                        }
                        else
                        {
                            if (tcol > colLayoutModel[colLayoutModel.length - 1].col)
                            {
                                tcol = colLayoutModel[colLayoutModel.length - 1].col
                            }
                        }
                    }
                    var x = 0;
                    if (bLeft)
                    {
                        x = 90000
                    }
                    for (var r = Math_max(sheet._scrollTopRow, row); r < row + rowCount && r <= maxRow; r++)
                    {
                        var rect = sheet.getCellRect(r, tcol);
                        if (rect)
                        {
                            if (bLeft)
                            {
                                if (rect.x < x)
                                {
                                    x = rect.x
                                }
                            }
                            else
                            {
                                if (x < rect.x + rect.width)
                                {
                                    x = rect.x + rect.width
                                }
                            }
                        }
                    }
                    return x
                };
                _SheetEventHandler.prototype._getPrevVisualRowBeforeFindRow = function(row, sheetArea)
                {
                    var sheet = this._sheet;
                    var tempRow = row;
                    if (this._isCellHiddenByGroup(tempRow, 0, sheetArea))
                    {
                        tempRow = sheet._getPrevVisualRow(tempRow, sheetArea);
                        return (tempRow !== keyword_null) ? tempRow : row
                    }
                    else
                    {
                        return row
                    }
                };
                _SheetEventHandler.prototype._getPrevVisualColBeforeFindCol = function(col, sheetArea)
                {
                    var sheet = this._sheet;
                    var tempCol = col;
                    if (this._isCellHiddenByGroup(0, tempCol, sheetArea))
                    {
                        tempCol = sheet._getPrevVisualColumn(tempCol, sheetArea);
                        return (tempCol !== keyword_null) ? tempCol : col
                    }
                    else
                    {
                        return col
                    }
                };
                _SheetEventHandler.prototype._isCellHiddenByGroup = function(row, col, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var sheet = this._sheet;
                    var rowRangeGroup,
                        colRangeGroup;
                    if (sheetArea === 3)
                    {
                        rowRangeGroup = sheet.rowRangeGroup;
                        colRangeGroup = sheet.colRangeGroup
                    }
                    else if (sheetArea === 1)
                    {
                        colRangeGroup = sheet.colRangeGroup
                    }
                    else if (sheetArea === 2)
                    {
                        rowRangeGroup = sheet.rowRangeGroup
                    }
                    var rowHidden = (rowRangeGroup && !rowRangeGroup._isEmpty() && rowRangeGroup.isCollapsed(row));
                    var colHidden = (colRangeGroup && !colRangeGroup._isEmpty() && colRangeGroup.isCollapsed(col));
                    return (rowHidden || colHidden)
                };
                _SheetEventHandler.prototype._getResizeRowInfo = function(sheet, target, resizeArea, sheetArea, y)
                {
                    var op = keyword_null;
                    var rowLayout = sheet._getRowLayout(target.rowViewportIndex, sheetArea);
                    if (rowLayout && !isNaN(target.row) && !isNaN(target.col))
                    {
                        target.row = this._getPrevVisualRowBeforeFindRow(target.row, sheetArea);
                        var rl = rowLayout.findRow(target.row);
                        if (rl)
                        {
                            if (rl.y + rl.height - resizeArea <= y && y <= rl.y + rl.height + resizeArea)
                            {
                                op = {
                                    action: "sizeRow", index: target.row, sheetArea: sheetArea
                                };
                                var lastRow = rowLayout[rowLayout.length - 1].row;
                                if (lastRow >= 0)
                                {
                                    var lastVisibleRow = sheet._getLastVisualRow(sheetArea);
                                    if (op.index === lastVisibleRow && op.index !== lastRow)
                                    {
                                        if (rl.y + rl.height - resizeArea / 2 <= y)
                                        {
                                            op = {
                                                action: "sizeRow", index: lastRow, sheetArea: sheetArea
                                            }
                                        }
                                    }
                                }
                            }
                            else if (rl.y - resizeArea <= y && y <= rl.y + resizeArea)
                            {
                                if (Sheets.ArrayHelper.indexOf(rowLayout, rl) > 0)
                                {
                                    op = {
                                        action: "sizeRow", index: target.row - 1, sheetArea: sheetArea
                                    }
                                }
                            }
                        }
                        if (!op && target.rowViewportIndex === 1 && rowLayout.length > 0)
                        {
                            rl = rowLayout[0];
                            if (Math_max(0, rl.y - resizeArea) <= y && y <= rl.y + resizeArea)
                            {
                                var row = target.row - 1;
                                var preRowLayout = sheet._getRowLayout(target.rowViewportIndex - 1, sheetArea);
                                if (row >= 0 && preRowLayout && !preRowLayout.findRow(row))
                                {
                                    if (sheet.getRowHeight(row) === 0)
                                    {
                                        op = {
                                            action: "sizeRow", index: row, sheetArea: sheetArea
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (op && !sheet.getRowResizable(op.index, sheetArea))
                    {
                        op = keyword_null
                    }
                    return op
                };
                _SheetEventHandler.prototype._getResizeColInfo = function(sheet, target, resizeArea, sheetArea, x)
                {
                    var op = keyword_null;
                    var colLayout = sheet._getColumnLayout(target.colViewportIndex, sheetArea);
                    if (colLayout && !isNaN(target.col) && !isNaN(target.row))
                    {
                        target.col = this._getPrevVisualColBeforeFindCol(target.col, sheetArea);
                        var cl = colLayout.findCol(target.col);
                        if (cl)
                        {
                            if (cl.x + cl.width - resizeArea <= x && x <= cl.x + cl.width + resizeArea)
                            {
                                op = {
                                    action: "sizeCol", index: target.col, sheetArea: sheetArea
                                };
                                var lastCol = colLayout[colLayout.length - 1].col;
                                if (lastCol >= 0)
                                {
                                    var lastVisibleCol = sheet._getLastVisualColumn(sheetArea);
                                    if (op.index === lastVisibleCol && op.index !== lastCol)
                                    {
                                        if (cl.x + cl.width - resizeArea / 2 <= x)
                                        {
                                            op = {
                                                action: "sizeCol", index: lastCol, sheetArea: sheetArea
                                            }
                                        }
                                    }
                                }
                            }
                            else if (cl.x - resizeArea <= x && x <= cl.x + resizeArea)
                            {
                                if (Sheets.ArrayHelper.indexOf(colLayout, cl) > 0)
                                {
                                    op = {
                                        action: "sizeCol", index: target.col - 1, sheetArea: sheetArea
                                    }
                                }
                            }
                        }
                        if (!op && target.colViewportIndex === 1 && colLayout.length > 0)
                        {
                            cl = colLayout[0];
                            if (Math_max(0, cl.x - resizeArea) <= x && x <= cl.x + resizeArea)
                            {
                                var col = target.col - 1;
                                var preColLayout = sheet._getColumnLayout(target.colViewportIndex - 1, sheetArea);
                                if (col >= 0 && preColLayout && !preColLayout.findCol(col))
                                {
                                    if (sheet.getColumnWidth(col) === 0)
                                    {
                                        op = {
                                            action: "sizeCol", index: col, sheetArea: sheetArea
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (op && !sheet.getColumnResizable(op.index, sheetArea))
                    {
                        op = keyword_null
                    }
                    return op
                };
                _SheetEventHandler.prototype.getResizingRowCol = function(target, x, y, resizeArea)
                {
                    var self = this;
                    var sheet = self._sheet;
                    var op = keyword_null,
                        r,
                        c;
                    if (!sheet.parent || sheet.parent._allowUserResize)
                    {
                        var sheetLayout = sheet._getSheetLayout();
                        if (target.rowViewportIndex < 0 && target.colViewportIndex >= 0 && sheet.colHeaderVisible)
                        {
                            op = self._getResizeColInfo(sheet, target, resizeArea, 1, x);
                            if (!op)
                            {
                                op = self._getResizeRowInfo(sheet, target, resizeArea, 1, y)
                            }
                        }
                        else if (target.rowViewportIndex >= 0 && target.colViewportIndex < 0 && sheet.rowHeaderVisible)
                        {
                            op = self._getResizeRowInfo(sheet, target, resizeArea, 2, y);
                            if (!op)
                            {
                                op = self._getResizeColInfo(sheet, target, resizeArea, 2, x)
                            }
                        }
                        else if (target.rowViewportIndex < 0 && target.colViewportIndex < 0)
                        {
                            if ((sheet._getLastVisualRow(2) === keyword_null) && (Math_abs(y - sheetLayout.colHeaderHeight) <= resizeArea))
                            {
                                var rowLayout = sheet._getRowLayout(1);
                                if (rowLayout && rowLayout.length > 0)
                                {
                                    r = rowLayout[rowLayout.length - 1].row
                                }
                                if (r >= 0)
                                {
                                    op = {
                                        action: "sizeRow", index: r, sheetArea: 2
                                    }
                                }
                            }
                            else if ((sheet._getLastVisualColumn(1) === keyword_null) && (Math_abs(x - sheetLayout.rowHeaderWidth) <= resizeArea))
                            {
                                var colLayout = sheet._getColumnLayout(1);
                                if (colLayout && colLayout.length > 0)
                                {
                                    c = colLayout[colLayout.length - 1].col
                                }
                                if (c >= 0)
                                {
                                    op = {
                                        action: "sizeCol", index: c, sheetArea: 1
                                    }
                                }
                            }
                        }
                        else if (target.rowViewportIndex >= 0 && target.colViewportIndex >= 0)
                        {
                            if ((sheetLayout.colHeaderHeight === 0) && (y <= resizeArea) && sheet.colHeaderVisible)
                            {
                                r = sheet.getRowCount(1) - 1;
                                if (r >= 0)
                                {
                                    op = {
                                        action: "sizeRow", index: r, sheetArea: 1
                                    }
                                }
                            }
                            else if ((sheetLayout.rowHeaderWidth === 0) && (x <= resizeArea) && sheet.rowHeaderVisible)
                            {
                                c = sheet.getColumnCount(2) - 1;
                                if (c >= 0)
                                {
                                    op = {
                                        action: "sizeCol", index: c, sheetArea: 2
                                    }
                                }
                            }
                        }
                    }
                    return op
                };
                _SheetEventHandler.prototype.getDragInfo = function(target, x, y)
                {
                    var self = this;
                    var op = keyword_null;
                    var rowViewportIndex = target.rowViewportIndex,
                        colViewportIndex = target.colViewportIndex;
                    if (typeof(rowViewportIndex) === const_undefined || rowViewportIndex === keyword_null || typeof(colViewportIndex) === const_undefined || colViewportIndex === keyword_null)
                    {
                        return op
                    }
                    var sheet = self._sheet;
                    var activeSelRange = sheet._getActiveSelectedRange();
                    if (activeSelRange.row === -1 && activeSelRange.col === -1)
                    {
                        return op
                    }
                    if (rowViewportIndex >= 0 && colViewportIndex >= 0 && sheet._selectionModel.length === 1)
                    {
                        if (self.inGrayArea(rowViewportIndex, colViewportIndex, x, y))
                        {
                            return op
                        }
                        var r = sheet._getRangeRect(rowViewportIndex, colViewportIndex, activeSelRange);
                        if (r.x - 4 < x && x < r.x + 4 && r.y <= y && y < r.y + r.height)
                        {
                            op = {
                                action: "drag", side: "left"
                            }
                        }
                        if (!op)
                        {
                            var rect = self._sheet._dragFillIndicatorRect;
                            if (rect && rect.x <= x && x <= rect.x + rect.width && rect.y <= y && y <= rect.y + rect.height)
                            {
                                op = {
                                    action: "drag", side: "corner"
                                }
                            }
                        }
                        if (!op)
                        {
                            if (r.x + r.width - 4 < x && x < r.x + r.width + 4 && r.y <= y && y < r.y + r.height)
                            {
                                op = {
                                    action: "drag", side: "right"
                                }
                            }
                        }
                        if (!op)
                        {
                            if (r.y - 4 < y && y < r.y + 4 && r.x <= x && x < r.x + r.width)
                            {
                                op = {
                                    action: "drag", side: "top"
                                }
                            }
                        }
                        if (!op)
                        {
                            if (r.y + r.height - 4 < y && y < r.y + r.height + 4 && r.x <= x && x < r.x + r.width)
                            {
                                op = {
                                    action: "drag", side: "bottom"
                                }
                            }
                        }
                        if (op)
                        {
                            if (x < r.x || x > r.x + r.width || y < r.y || y > r.y + r.height)
                            {
                                op.outside = true
                            }
                        }
                    }
                    if (!self._sheet.canUserDragDrop())
                    {
                        if (op && op.side !== "corner")
                        {
                            op.side = keyword_null
                        }
                    }
                    if (!self._sheet.canUserDragFill())
                    {
                        if (op && op.side === "corner")
                        {
                            op.side = keyword_null
                        }
                    }
                    return op
                };
                _SheetEventHandler.prototype.inGrayArea = function(rowViewportIndex, colViewportIndex, x, y)
                {
                    var sheet = this._sheet,
                        layout = sheet._getSheetLayout(),
                        viewportRect = layout.viewportRect(1, 1);
                    if (colViewportIndex === 1)
                    {
                        var colLayoutModel = sheet._getColumnLayout(colViewportIndex);
                        if (colLayoutModel && colLayoutModel.length > 0)
                        {
                            var colLayout = colLayoutModel[colLayoutModel.length - 1];
                            if (colLayout.x + colLayout.width <= x && x < viewportRect.x + viewportRect.width)
                            {
                                return true
                            }
                        }
                        else if (viewportRect.contains(x, y))
                        {
                            return true
                        }
                    }
                    if (rowViewportIndex === 1)
                    {
                        var rowLayoutModel = sheet._getRowLayout(rowViewportIndex);
                        if (rowLayoutModel && rowLayoutModel.length > 0)
                        {
                            var rowLayout = rowLayoutModel[rowLayoutModel.length - 1];
                            if (rowLayout.y + rowLayout.height <= y && y < viewportRect.y + viewportRect.height)
                            {
                                return true
                            }
                        }
                        else if (viewportRect.contains(x, y))
                        {
                            return true
                        }
                    }
                    return false
                };
                _SheetEventHandler.prototype.doMouseMove = function(e)
                {
                    var t = this._getCanvasOffset();
                    this.doMouseMoveImp(e, e.pageX - t.left, e.pageY - t.top)
                };
                _SheetEventHandler.prototype.doMouseOut = function(e)
                {
                    var sheet = this._sheet;
                    var oldTarget = sheet._currentTarget;
                    if (oldTarget && oldTarget.cellTypeHitInfo)
                    {
                        var row = oldTarget.row,
                            col = oldTarget.col;
                        var celltype = sheet.getCellType(row, col, oldTarget.hitTestType);
                        celltype.processMouseLeave(oldTarget.cellTypeHitInfo)
                    }
                    if (this.isWorking)
                    {
                        return
                    }
                    var outTarget = {
                            x: -10000, y: -10000, rowViewportIndex: keyword_null, colViewportIndex: keyword_null, row: -1, col: -1, resizeInfo: keyword_null, hitTestType: keyword_null
                        };
                    sheet._setHoverCell(outTarget)
                };
                _SheetEventHandler.prototype._hoverShowComment = function(target)
                {
                    var sheet = this._sheet;
                    var row = -1,
                        col = -1;
                    if (target)
                    {
                        if (target.rowViewportIndex >= 0 && target.colViewportIndex >= 0)
                        {
                            row = target.row;
                            col = target.col
                        }
                    }
                    if (sheet.parent)
                    {
                        if (row < 0 || col < 0)
                        {
                            return
                        }
                        var comment = sheet.getComment(row, col);
                        if (sheet._commentManager)
                        {
                            sheet._commentManager.hoverShowComment(comment)
                        }
                    }
                };
                _SheetEventHandler.prototype.doMouseMoveImp = function(e, x, y)
                {
                    var self = this;
                    self.mousePosition = {
                        e: e, x: x, y: y
                    };
                    var sheet = self._sheet;
                    if (self.isMouseDown)
                    {
                        if (!Sheets.FocusHelper.isActiveElement(sheet))
                        {
                            Sheets.FocusHelper.setActiveElement(sheet)
                        }
                    }
                    if (self.isMouseDown && self.isWorking)
                    {
                        if (self.isResizing)
                        {
                            self.continueResizing()
                        }
                        else if (self.isDragDropping)
                        {
                            self.continueDragDropping()
                        }
                        else if (self.isDraggingFill)
                        {
                            self.continueDragFill()
                        }
                        else if (self.isFormulaRangeAppending)
                        {
                            self.continueFormulaRangeAppending()
                        }
                        else if (self.isFormulaRangeMoving)
                        {
                            self.continueFormulaRangeMoving()
                        }
                        else if (self.isFormulaRangeResizing)
                        {
                            self.continueFormulaRangeResizing()
                        }
                        else if (self.isSelecting)
                        {
                            self.continueSelecting()
                        }
                        return
                    }
                    var target = sheet.hitTest(x, y);
                    if (!target)
                    {
                        return
                    }
                    if (Sheets.features.comment)
                    {
                        self._hoverShowComment(target)
                    }
                    var canvas = sheet._getCanvas();
                    if (!canvas)
                    {
                        return
                    }
                    var oldTarget = sheet._currentTarget;
                    var targetChanged = ((!oldTarget) || (target.row !== oldTarget.row) || (target.col !== oldTarget.col) || (target.hitTestType !== oldTarget.hitTestType) || (target.resizeInfo && !oldTarget.resizeInfo) || (!target.resizeInfo && oldTarget.resizeInfo) || (target.resizeInfo && target.resizeInfo.action !== oldTarget.resizeInfo.action) || (target.dragInfo && !oldTarget.dragInfo) || (!target.dragInfo && oldTarget.dragInfo) || (target.dragInfo && target.dragInfo.action !== oldTarget.dragInfo.action));
                    if (oldTarget && targetChanged)
                    {
                        if (oldTarget.cellTypeHitInfo)
                        {
                            var row = oldTarget.row;
                            var col = oldTarget.col;
                            var celltype = sheet.getCellType(row, col, oldTarget.hitTestType);
                            celltype.processMouseLeave(oldTarget.cellTypeHitInfo)
                        }
                    }
                    var resizeInfo = target.resizeInfo,
                        dragInfo = target.dragInfo,
                        frInfo = target.formulaRangeHitInfo,
                        cellTypeInfo = target.cellTypeHitInfo,
                        render = sheet._render;
                    if (resizeInfo)
                    {
                        if (resizeInfo.action === "sizeCol")
                        {
                            canvas.style.cursor = "w-resize"
                        }
                        else if (resizeInfo.action === "sizeRow")
                        {
                            canvas.style.cursor = "n-resize"
                        }
                        else
                        {
                            canvas.style.cursor = "default"
                        }
                    }
                    else if (dragInfo && dragInfo.action === "drag")
                    {
                        if (dragInfo.side === "corner")
                        {
                            canvas.style.cursor = "crosshair"
                        }
                        else if (dragInfo.side)
                        {
                            canvas.style.cursor = "move"
                        }
                    }
                    else if (frInfo)
                    {
                        if (frInfo.inBorder)
                        {
                            canvas.style.cursor = "move"
                        }
                        else if (frInfo.inTopLeft)
                        {
                            canvas.style.cursor = "nw-resize"
                        }
                        else if (frInfo.inTopRight)
                        {
                            canvas.style.cursor = "ne-resize"
                        }
                        else if (frInfo.inBottomLeft)
                        {
                            canvas.style.cursor = "sw-resize"
                        }
                        else if (frInfo.inBottomRight)
                        {
                            canvas.style.cursor = "se-resize"
                        }
                        var oldFormulaRangeHoving = self.isFormulaRangeHoving,
                            oldFormulRangeHovingInfo = self._formulRangeHovingInfo,
                            oldParamRange = (oldFormulRangeHovingInfo && oldFormulRangeHovingInfo.paramRange);
                        var newParamRange = frInfo.paramRange;
                        self.isFormulaRangeHoving = true;
                        self._formulRangeHovingInfo = {paramRange: newParamRange};
                        if (!oldFormulaRangeHoving || newParamRange.index !== oldParamRange.index)
                        {
                            render.paintFormulaTextBox()
                        }
                    }
                    else
                    {
                        if (cellTypeInfo)
                        {
                            var rowIndex = target.row;
                            var colIndex = target.col;
                            var celltype = sheet.getCellType(rowIndex, colIndex, target.hitTestType);
                            cellTypeInfo.sheet = sheet;
                            if (targetChanged)
                            {
                                celltype.processMouseEnter(cellTypeInfo)
                            }
                            celltype.processMouseMove(cellTypeInfo)
                        }
                        if (targetChanged || !cellTypeInfo || !cellTypeInfo.isReservedLocation)
                        {
                            canvas.style.cursor = "default"
                        }
                        if (self.isFormulaRangeHoving)
                        {
                            self.isFormulaRangeHoving = false;
                            self._formulRangeHovingInfo = keyword_null;
                            render.paintFormulaTextBox()
                        }
                    }
                    sheet._setHoverCell(target)
                };
                _SheetEventHandler.prototype.doMouseUp = function(e)
                {
                    var self = this;
                    var sheet = self._sheet;
                    if (!sheet.inCanvas)
                    {
                        self.unhandleDocumentMouseMove()
                    }
                    var t = self._getCanvasOffset();
                    if (!sheet._isMouseDownInSheet)
                    {
                        return true
                    }
                    else
                    {
                        sheet._isMouseDownInSheet = false
                    }
                    self.doMouseUpImp(e, e.pageX - t.left, e.pageY - t.top);
                    return false
                };
                _SheetEventHandler.prototype.doMouseUpImp = function(e, x, y)
                {
                    var self = this;
                    var sheet = self._sheet;
                    var ae = Sheets.FocusHelper.getActiveElement();
                    self.isMouseDown = false;
                    if (ae && ae !== sheet && ae.endEdit)
                    {
                        ae.endEdit();
                        ae.repaint()
                    }
                    Sheets.FocusHelper.setActiveElement(sheet);
                    if (self.isResizing)
                    {
                        self.stopResizing()
                    }
                    else if (self.isDragDropping)
                    {
                        self.stopDragDrop()
                    }
                    else if (self.isDraggingFill)
                    {
                        self.endDragFill()
                    }
                    else if (self.isFormulaRangeAppending)
                    {
                        self.stopFormulaRangeAppending()
                    }
                    else if (self.isFormulaRangeMoving)
                    {
                        self.stopFormulaRangeMoving()
                    }
                    else if (self.isFormulaRangeResizing)
                    {
                        self.stopFormulaRangeResizing()
                    }
                    else if (sheet._currentTarget)
                    {
                        var currentTarget = sheet._currentTarget;
                        if (currentTarget.cellTypeHitInfo)
                        {
                            var r = currentTarget.row,
                                c = currentTarget.col,
                                ct = sheet.getCellType(r, c, currentTarget.hitTestType);
                            if (!currentTarget.cellTypeHitInfo.sheet)
                            {
                                currentTarget.cellTypeHitInfo.sheet = sheet
                            }
                            ct.processMouseUp(currentTarget.cellTypeHitInfo)
                        }
                        if (!currentTarget.cellTypeHitInfo || !currentTarget.cellTypeHitInfo.isReservedLocation)
                        {
                            sheet.triggerCellClick({
                                sheet: sheet, sheetName: sheet._name, sheetArea: currentTarget.hitTestType, row: currentTarget.row, col: currentTarget.col
                            })
                        }
                    }
                    self.stopSelecting();
                    self.setMetaKeyState(e)
                };
                _SheetEventHandler.prototype.startEdit = function(e)
                {
                    var sheet = this._sheet;
                    var canvas = sheet._getCanvas();
                    var t = this._getCanvasOffset();
                    if (!e.shiftKey && !e.ctrlKey)
                    {
                        sheet._doStartEdit(canvas, e.pageX - t.left, e.pageY - t.top)
                    }
                };
                _SheetEventHandler.prototype.doKeyDown = function(event)
                {
                    var self = this;
                    var sheet = self._sheet;
                    if (sheet)
                    {
                        var activeRowIndex = sheet.getActiveRowIndex(),
                            activeColumnIndex = sheet.getActiveColumnIndex(),
                            cellType = sheet.getCellType(activeRowIndex, activeColumnIndex),
                            context = {
                                isEditing: sheet.isEditing(), sheet: sheet, row: activeRowIndex, col: activeColumnIndex, sheetArea: 3
                            },
                            context1 = {
                                sheet: sheet, row: activeRowIndex, col: activeColumnIndex, sheetArea: 3
                            };
                        if (cellType && cellType.isReservedKey(event, context))
                        {
                            if (!sheet.isEditing())
                            {
                                cellType.processKeyDown(event, context1)
                            }
                            return
                        }
                        var fbx = sheet._formulaTextBox;
                        if (fbx && fbx.isReservedKey(event))
                        {
                            return
                        }
                        var attachedFBX = (sheet.parent && sheet.parent._attachedFormulaTextBox);
                        if (attachedFBX && attachedFBX.isReservedKey(event))
                        {
                            return
                        }
                    }
                    var navKey = (!sheet.isEditing() && !event.ctrlKey && !event.metaKey && (event.keyCode === 34 || event.keyCode === 33 || event.keyCode === 37 || event.keyCode === 39 || event.keyCode === 9 || event.keyCode === 13 || event.keyCode === 38 || event.keyCode === 40));
                    if (sheet._isTouchMode)
                    {
                        sheet._isTouchMode = false;
                        sheet._render.refreshTouchSelectionIndicator()
                    }
                    var keyMapProcessed = self._keyDownImp(event);
                    if (navKey && keyMapProcessed && Sheets.FocusHelper.isActiveElement(sheet))
                    {
                        if (self._keyPressed)
                        {
                            if (self._keyPressedCount < 25)
                            {
                                self._keyPressedCount++
                            }
                            Sheets.util.cancelDefault(event);
                            return
                        }
                        self._keyPressed = true;
                        self._keyPressedCount = 1;
                        self._repeatKeyDown(event, true)
                    }
                };
                _SheetEventHandler.prototype._getMouseDownResizeTooltipContent = function()
                {
                    var sheet = this._sheet;
                    var currentTarget = sheet._currentTarget;
                    var resizeInfo = currentTarget.resizeInfo;
                    if (resizeInfo.action === "sizeRow")
                    {
                        var rowLayout = sheet._getAllRowLayout(resizeInfo.sheetArea);
                        resizeInfo.index = this._getPrevVisualRowBeforeFindRow(resizeInfo.index, resizeInfo.sheetArea);
                        var rl = rowLayout.findRow(resizeInfo.index);
                        if (!rl)
                        {
                            rl = rowLayout.findRow(currentTarget.row)
                        }
                        return Sheets.SR.Tip_Height + rl.height.toFixed(0) + Sheets.SR.Tip_pixels
                    }
                    else
                    {
                        var colLayout = sheet._getAllColumnLayout(resizeInfo.sheetArea);
                        resizeInfo.index = this._getPrevVisualColBeforeFindCol(resizeInfo.index, resizeInfo.sheetArea);
                        var cl = colLayout.findCol(resizeInfo.index);
                        if (!cl)
                        {
                            cl = colLayout.findCol(currentTarget.col)
                        }
                        return Sheets.SR.Tip_Width + cl.width.toFixed(0) + Sheets.SR.Tip_pixels
                    }
                };
                _SheetEventHandler.prototype._getMouseMoveResizeTooltipContent = function(resizeInfo)
                {
                    if (resizeInfo.action === "sizeRow")
                    {
                        return Sheets.SR.Tip_Height + (resizeInfo.movingY - resizeInfo.startY).toFixed(0) + Sheets.SR.Tip_pixels
                    }
                    else
                    {
                        return Sheets.SR.Tip_Width + (resizeInfo.movingX - resizeInfo.startX).toFixed(0) + Sheets.SR.Tip_pixels
                    }
                };
                _SheetEventHandler.prototype._repeatKeyDown = function(event, doNotExecuteImmediately)
                {
                    var self = this;
                    if (!self._keyPressed)
                    {
                        return
                    }
                    if (!doNotExecuteImmediately)
                    {
                        self._keyDownImp(event)
                    }
                    if (self._keyPressed)
                    {
                        self._repeatKeyDownTimeoutID = window.setTimeout(function()
                        {
                            self._repeatKeyDown(event)
                        }, 500 / self._keyPressedCount)
                    }
                };
                _SheetEventHandler.prototype._startEditByKeyboard = function()
                {
                    var sheet = this._sheet;
                    var c = sheet._getCanvas();
                    if (c)
                    {
                        sheet._startEditByKeydown = true;
                        try
                        {
                            var isEditing = sheet.isEditing();
                            sheet._startEditImp(c, sheet._activeRowIndex, sheet._activeColIndex, keyword_null, keyword_null, true);
                            if (!isEditing && sheet.isEditing())
                            {
                                var ct = sheet.getCellType(sheet._activeRowIndex, sheet._activeColIndex);
                                if (ct._triggerButtonClicked && event.keyCode === 32 && !event.ctrlKey && !event.shiftKey && !event.altKey)
                                {
                                    ct._triggerButtonClicked(sheet, sheet._activeRowIndex, sheet._activeColIndex, 3)
                                }
                                if (ct._cancelDefaultKeydown)
                                {
                                    ct._cancelDefaultKeydown(event)
                                }
                            }
                        }
                        finally
                        {
                            sheet._startEditByKeydown = false
                        }
                    }
                };
                _SheetEventHandler.prototype._keyDownImp = function(event)
                {
                    var self = this;
                    var sheet = self._sheet;
                    self.setMetaKeyState(event);
                    if (!sheet.isEditing() && event.keyCode === 27 && !event.altKey && !event.ctrlKey && !event.shiftKey && sheet._validationInputMessage)
                    {
                        $(sheet._validationInputMessage).remove();
                        sheet._validationInputMessage = keyword_null
                    }
                    if (!sheet.isEditing() && (event.keyCode === 34 || event.keyCode === 33 || event.keyCode === 35 || event.keyCode === 36 || event.keyCode === 38 || event.keyCode === 40))
                    {
                        Sheets.util.cancelDefault(event)
                    }
                    if (!sheet.isEditing() && (event.keyCode === 37 || event.keyCode === 39))
                    {
                        Sheets.util.cancelDefault(event)
                    }
                    if (Sheets.features.floatingObject && sheet._processFloatingObjectsKeyMap(event))
                    {
                        return false
                    }
                    if (Sheets.features.comment && sheet._processCommentKeyMap(event))
                    {
                        return false
                    }
                    if (sheet._processKeyMap(event))
                    {
                        return true
                    }
                    var isIme = event.keyCode === 229 || event.keyCode === 0;
                    if (self.allowEnterEditing(event) && !isIme)
                    {
                        var fbx = sheet._formulaTextBox;
                        if (fbx && fbx.isAppending())
                        {
                            fbx.stopAppending()
                        }
                        var isEditing = sheet.isEditing();
                        if (!isEditing)
                        {
                            var hitElement = Sheets.Global.prototype.getUIElement(event.target);
                            var isAFBX = (hitElement && hitElement.getAttribute(attrGcUIElement) === "gcAttachedFormulaTextBox");
                            if (!isAFBX)
                            {
                                self._startEditByKeyboard()
                            }
                        }
                    }
                    return false
                };
                _SheetEventHandler.prototype.clearRepeatKeyDownTimeout = function()
                {
                    var self = this;
                    self._keyPressed = false;
                    if (self._repeatKeyDownTimeoutID > 0)
                    {
                        window.clearTimeout(self._repeatKeyDownTimeoutID);
                        self._repeatKeyDownTimeoutID = 0
                    }
                };
                _SheetEventHandler.prototype.doKeyUp = function(event)
                {
                    var self = this;
                    self.clearRepeatKeyDownTimeout();
                    var sheet = self._sheet;
                    if (sheet)
                    {
                        var activeRowIndex = sheet.getActiveRowIndex(),
                            activeColumnIndex = sheet.getActiveColumnIndex(),
                            cellType = sheet.getCellType(activeRowIndex, activeColumnIndex),
                            context = {
                                isEditing: sheet.isEditing(), sheet: sheet, row: activeRowIndex, col: activeColumnIndex, sheetArea: 3
                            },
                            context1 = {
                                sheet: sheet, row: activeRowIndex, col: activeColumnIndex, sheetArea: 3
                            };
                        if (cellType && cellType.isReservedKey(event, context))
                        {
                            if (!sheet.isEditing())
                            {
                                cellType.processKeyUp(event, context1)
                            }
                            return
                        }
                        var fbx = sheet._formulaTextBox;
                        if (fbx && fbx.isReservedKey(event))
                        {
                            return
                        }
                        var attachedFBX = (sheet.parent && sheet.parent._attachedFormulaTextBox);
                        if (attachedFBX && attachedFBX.isReservedKey(event))
                        {
                            return
                        }
                    }
                    self.setMetaKeyState(event)
                };
                _SheetEventHandler.prototype.doCompositionStart = function()
                {
                    this._startEditByKeyboard()
                };
                _SheetEventHandler.prototype.allowEnterEditing = function(e)
                {
                    if (e.ctrlKey || e.altKey || e.metaKey)
                    {
                        return false
                    }
                    if (e.keyCode >= 65 && e.keyCode <= 90)
                    {
                        return true
                    }
                    else if ((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105))
                    {
                        return true
                    }
                    else if (e.keyCode >= 186 && e.keyCode <= 192)
                    {
                        return true
                    }
                    else if (e.keyCode >= 220 && e.keyCode <= 222 || e.keyCode === 219)
                    {
                        return true
                    }
                    else if (e.keyCode >= 106 && e.keyCode <= 111)
                    {
                        return true
                    }
                    else if (e.keyCode === 32)
                    {
                        return true
                    }
                    else if (e.keyCode === 61)
                    {
                        return true
                    }
                    else if (e.keyCode === 173)
                    {
                        return true
                    }
                    else if (e.keyCode === 229 || e.keyCode === 0)
                    {
                        return true
                    }
                    else if (e.keyCode === 8)
                    {
                        return true
                    }
                    return false
                };
                _SheetEventHandler.prototype.setMetaKeyState = function(e)
                {
                    var self = this;
                    var sheet = self._sheet;
                    self.shift = e.shiftKey && !e.ctrlKey;
                    self.ctrl = e.ctrlKey && !e.shiftKey;
                    sheet._isNavigateInSelection = false;
                    if (e.keyCode === 9)
                    {
                        if (sheet._selectionModel.length > 1)
                        {
                            sheet._isNavigateInSelection = true
                        }
                        else
                        {
                            var range = sheet._getActiveSelectedRange();
                            if (range && sheet._selectionModel.length > 0)
                            {
                                sheet._isNavigateInSelection = !(sheet._activeRowIndex === range.row && sheet._activeColIndex === range.col && sheet._activeRowCount === range.rowCount && sheet._activeColCount === range.colCount)
                            }
                        }
                    }
                    if (self.isDragDropping === true)
                    {
                        var activeSelRange = sheet._getActiveSelectedRange();
                        var tempInsert = self._isDragInsert;
                        var tempCopy = self._isDragCopy;
                        if (activeSelRange.row === -1 || activeSelRange.col === -1)
                        {
                            self._isDragInsert = e.shiftKey
                        }
                        else
                        {
                            self._isDragInsert = false
                        }
                        self._isDragCopy = e.ctrlKey;
                        if (tempInsert !== self._isDragInsert || tempCopy !== self._isDragCopy)
                        {
                            sheet._render.refreshDragDropIndicator()
                        }
                    }
                    self.isShiftPressed = e.shiftKey;
                    self.isControlPressed = e.ctrlKey
                };
                _SheetEventHandler.prototype.resetMetaKeyState = function()
                {
                    var self = this;
                    self.shift = false;
                    self.ctrl = false;
                    self._sheet._isNavigateInSelection = false;
                    self.isDragDropping = false;
                    self._isDragInsert = false;
                    self._isDragCopy = false;
                    self.isShiftPressed = false;
                    self.isControlPressed = false
                };
                _SheetEventHandler.prototype.doMouseWheel = function(event, detail)
                {
                    var sheet = this._sheet;
                    if (event.ctrlKey)
                    {
                        if (!sheet.parent || sheet.parent._allowUserZoom)
                        {
                            var oldZoomFactor = sheet._zoomFactor;
                            var newZoomFactor = sheet._zoomFactor - 0.05 * detail;
                            var action = new Sheets.UndoRedo.ZoomUndoAction(sheet, newZoomFactor);
                            sheet._doCommand(action);
                            newZoomFactor = sheet._zoomFactor;
                            if (oldZoomFactor !== newZoomFactor)
                            {
                                sheet.triggerUserZooming({
                                    sheet: sheet, sheetName: sheet._name, oldZoomFactor: oldZoomFactor, newZoomFactor: newZoomFactor
                                })
                            }
                        }
                    }
                    else
                    {
                        var oldTopRow = sheet._scrollTopRow,
                            newTopRow = oldTopRow;
                        if (sheet.frozenRowCount > 0)
                        {
                            if (sheet._scrollTopRow === 0 && detail > 0)
                            {
                                newTopRow = sheet.frozenRowCount
                            }
                            else if (detail < 0 && sheet._scrollTopRow === sheet.frozenRowCount - detail)
                            {
                                newTopRow = 0
                            }
                        }
                        if (detail < 0)
                        {
                            var tmpRow = sheet._getScrollableRow(newTopRow + detail, true);
                            if (tmpRow != -1)
                            {
                                newTopRow = tmpRow
                            }
                            else
                            {
                                newTopRow = newTopRow + detail
                            }
                        }
                        else if (detail > 0)
                        {
                            var tmpRow = sheet._getScrollableRow(newTopRow + detail);
                            if (tmpRow != -1)
                            {
                                newTopRow = tmpRow
                            }
                            else
                            {
                                newTopRow = newTopRow + detail
                            }
                        }
                        if (newTopRow < sheet._getFirstPageTopRow())
                        {
                            newTopRow = sheet._getFirstPageTopRow()
                        }
                        else if (newTopRow > sheet._getLastVisualScrollRow())
                        {
                            newTopRow = sheet._getLastVisualScrollRow()
                        }
                        if (oldTopRow !== newTopRow)
                        {
                            this.vScrollTo(newTopRow);
                            sheet._syncVScrollbarPosition();
                            var sp = sheet.parent;
                            if (sp && !sp._scrollbarShowMax)
                            {
                                sheet._syncVScrollbarSize()
                            }
                            sheet.triggerTopRowChanged({
                                sheet: sheet, sheetName: sheet._name, oldTopRow: oldTopRow, newTopRow: newTopRow
                            })
                        }
                    }
                    if (Sheets.features.comment)
                    {
                        var canvasOffset = this._getCanvasOffset();
                        var target = sheet.hitTest(event.pageX - canvasOffset.left, event.pageY - canvasOffset.top);
                        this._hoverShowComment(target)
                    }
                };
                _SheetEventHandler.prototype.updateEditingEditor = function(eData)
                {
                    var sheet,
                        editor,
                        canvasOffset;
                    if (eData && eData.sheet)
                    {
                        sheet = eData.sheet;
                        editor = eData.editor;
                        canvasOffset = eData.canvasOffset
                    }
                    else
                    {
                        sheet = this._sheet;
                        editor = sheet._editor
                    }
                    if (!sheet.isEditing())
                    {
                        return
                    }
                    var activeRow = sheet._activeRowIndex,
                        activeCol = sheet._activeColIndex,
                        ct = sheet.getCellType(activeRow, activeCol),
                        sheetLayout = sheet._getSheetLayout(),
                        cellStyle = sheet.getActualStyle(activeRow, activeCol),
                        cellRect = sheet.getCellRect(activeRow, activeCol);
                    if (cellRect && cellRect.width > 0 && cellRect.height > 0 && cellRect.x >= sheetLayout.frozenX && cellRect.y >= sheetLayout.frozenY && cellRect.x + cellRect.width <= sheetLayout.frozenTrailingX + sheetLayout.frozenTrailingWidth && cellRect.y + cellRect.height <= sheetLayout.frozenTrailingY + sheetLayout.frozenTrailingHeight)
                    {
                        var context = {
                                sheet: sheet, row: activeRow, col: activeCol, sheetArea: 3, canvasOffset: canvasOffset
                            };
                        ct.updateEditor(editor, cellStyle, cellRect, context)
                    }
                    else
                    {
                        $(editor).css({
                            top: -10000, left: -10000
                        })
                    }
                    var fbx = sheet._formulaTextBox;
                    if (fbx)
                    {
                        fbx.position()
                    }
                };
                _SheetEventHandler.prototype.doVScroll = function(topRow)
                {
                    var self = this;
                    var sheet = self._sheet;
                    self.scrolling = true;
                    self.newTop = topRow;
                    self.newLeft = sheet._scrollLeftCol;
                    if (!self.scrollTimer)
                    {
                        self.scrollTimer = window.setInterval(function()
                        {
                            self._scrollView()
                        }, self.waittime)
                    }
                };
                _SheetEventHandler.prototype.doHScroll = function(leftColumn)
                {
                    var self = this;
                    var sheet = self._sheet;
                    self.scrolling = true;
                    self.newLeft = leftColumn;
                    self.newTop = sheet._scrollTopRow;
                    if (!self.scrollTimer)
                    {
                        self.scrollTimer = window.setInterval(function()
                        {
                            self._scrollView()
                        }, self.waittime)
                    }
                };
                _SheetEventHandler.prototype._scrollView = function()
                {
                    var self = this;
                    if (!self.scrolling)
                    {
                        if (self.scrollTimer)
                        {
                            window.clearInterval(self.scrollTimer);
                            self.scrollTimer = keyword_null;
                            var bLoadData = (self.newTop !== self._sheet._scrollTopRow);
                            if (bLoadData)
                            {
                                var topRow = self._sheet.getViewportTopRow(1);
                                var bottomRow = self._sheet.getViewportBottomRow(1);
                                var start = Math_max(0, topRow - 60);
                                if (start < self._sheet.getRowCount())
                                {
                                    self._loadData(start, 2 * bottomRow - topRow)
                                }
                            }
                        }
                        return
                    }
                    self.scrolling = false;
                    self._updateView()
                };
                _SheetEventHandler.prototype._showScrollTooltip = function(isVScroll, e)
                {
                    var self = this;
                    var top;
                    var left;
                    if (isVScroll)
                    {
                        top = e.pageY;
                        left = e.pageX - self.VSCROLLTOOLTIP_LEFT
                    }
                    else
                    {
                        top = e.pageY - self.HSCROLLTOOLTIP_TOP;
                        left = e.pageX - self.HSCROLLTOOLTIP_LEFT
                    }
                    self._showTooltip(self._getScrollTooltipContent(isVScroll), left, top, true)
                };
                _SheetEventHandler.prototype._getScrollTooltipContent = function(isVScroll)
                {
                    var sheet = this._sheet;
                    var info;
                    if (isVScroll)
                    {
                        info = Sheets.SR.Tip_Row + (sheet._scrollTopRow + 1)
                    }
                    else
                    {
                        if (sheet.colHeaderAutoText === 1)
                        {
                            info = Sheets.SR.Tip_Column + (sheet._scrollLeftCol + 1)
                        }
                        else
                        {
                            info = Sheets.SR.Tip_Column + sheet._indexToLetters(sheet._scrollLeftCol + 1)
                        }
                    }
                    return info
                };
                _SheetEventHandler.prototype._loadData = function(startIndex, endIndex)
                {
                    var self = this;
                    if (!self._sheet.parent || !self._sheet.parent._host)
                    {
                        return
                    }
                    if (self._sheet.dataContext && self._sheet.dataContext.read)
                    {
                        self._dataContextLoadDelegate = function(event, context)
                        {
                            return self._dataContextLoaded(event, context)
                        };
                        self.lastLoadedRowIndex = startIndex
                    }
                };
                _SheetEventHandler.prototype._dataContextLoaded = function(result, context)
                {
                    var tmp = result.data;
                    if (tmp && tmp.length > 0)
                    {
                        var sheet = this._sheet;
                        var ds = sheet.getDataSource();
                        if (ds && this.lastLoadedRowIndex === result.start)
                        {
                            for (var i = 0; i < tmp.length; i++)
                            {
                                ds[result.start + i] = tmp[i]
                            }
                        }
                        sheet.recalcAll();
                        sheet.repaint()
                    }
                };
                _SheetEventHandler.prototype.getElementById = function(parent, id)
                {
                    if (!parent)
                    {
                        return keyword_null
                    }
                    var t = parent.firstChild;
                    while (t)
                    {
                        if (t.id === id || t.name === id)
                        {
                            return t
                        }
                        var t1 = this.getElementById(t, id);
                        if (t1)
                        {
                            return t1
                        }
                        t = t.nextSibling
                    }
                    return keyword_null
                };
                _SheetEventHandler.prototype._updateView = function()
                {
                    var self = this;
                    var sheet = self._sheet;
                    if (self.painting)
                    {
                        return
                    }
                    self.painting = true;
                    var currentSpread = sheet.parent,
                        showScrollTip = 0;
                    if (currentSpread)
                    {
                        showScrollTip = currentSpread.showScrollTip()
                    }
                    if (self.newTop !== sheet._scrollTopRow)
                    {
                        self.vScrollTo(self.newTop);
                        if (showScrollTip === 2 || showScrollTip === 3)
                        {
                            self._refreshTooltip(self._getScrollTooltipContent(true))
                        }
                    }
                    else if (self.newLeft !== sheet._scrollLeftCol)
                    {
                        self.hScrollTo(self.newLeft);
                        if (showScrollTip === 1 || showScrollTip === 3)
                        {
                            self._refreshTooltip(self._getScrollTooltipContent(false))
                        }
                    }
                    self.painting = false
                };
                _SheetEventHandler.prototype.vScrollTo = function(newTopRow)
                {
                    var sheet = this._sheet,
                        oldTopRow = sheet._scrollTopRow;
                    if (newTopRow === oldTopRow)
                    {
                        return
                    }
                    sheet._scrollTopRow = newTopRow;
                    if (sheet._paintSuspended || sheet._layoutSuspended > 0)
                    {
                        return
                    }
                    if (Sheets.features.comment)
                    {
                        var commentManager = sheet._commentManager;
                        commentManager.updateCommentsLayoutWhenSheetScroll()
                    }
                    var painted = false;
                    if (Sheets.util._useDoubleBuffer())
                    {
                        var bounds = sheet._bounds,
                            layout = sheet._getSheetLayout(),
                            viewportY = layout.viewportY,
                            viewportHeight = layout.viewportHeight,
                            x,
                            y,
                            width,
                            height;
                        var render = sheet._render,
                            ctx = render._getCtx();
                        if (newTopRow > oldTopRow)
                        {
                            var rl1,
                                rl2;
                            var rowLayouts = sheet._getRowLayout(1);
                            if (rowLayouts && rowLayouts.length > 0)
                            {
                                rl1 = rowLayouts.findRow(newTopRow)
                            }
                            if (rl1)
                            {
                                var i = rowLayouts.length - 1;
                                rl2 = rowLayouts[i];
                                while (rl2.y + rl2.height > viewportY + viewportHeight)
                                {
                                    i = i - 1;
                                    rl2 = rowLayouts[i]
                                }
                                if (rl2.row > newTopRow)
                                {
                                    painted = true;
                                    var adj = 2;
                                    x = (bounds ? bounds.x : layout.x);
                                    y = rl1.y;
                                    width = layout.width;
                                    height = rl2.y + rl2.height - rl1.y - adj;
                                    render.copyScreen(x, y, width, height, x, viewportY);
                                    sheet.invalidateLayout();
                                    render.paintBody(ctx, new Sheets.Rect(x, viewportY + height, width, viewportHeight - height));
                                    render.paintAdornment(ctx, new Sheets.Rect(x, viewportY, width, viewportHeight))
                                }
                            }
                        }
                        else
                        {
                            var h = 0;
                            for (var i = newTopRow; i < oldTopRow && h < viewportHeight; i++)
                            {
                                h += sheet._getZoomRowHeight(i)
                            }
                            if (h < viewportHeight)
                            {
                                painted = true;
                                var adj = 2;
                                x = (bounds ? bounds.x : layout.x);
                                y = viewportY;
                                width = layout.width;
                                height = viewportHeight - h;
                                if (sheet.getFrozenTrailingRowCount() > 0)
                                {
                                    height -= 1
                                }
                                render.copyScreen(x, y, width, height, x, y + h);
                                sheet.invalidateLayout();
                                render.paintBody(ctx, new Sheets.Rect(x, y, width, h + adj));
                                render.paintAdornment(ctx, new Sheets.Rect(x, viewportY, width, viewportHeight))
                            }
                        }
                    }
                    if (!painted)
                    {
                        sheet.invalidateLayout();
                        sheet.repaint()
                    }
                    this.updateEditingEditor()
                };
                _SheetEventHandler.prototype.hScrollTo = function(newLeftCol)
                {
                    var sheet = this._sheet,
                        oldLeftCol = sheet._scrollLeftCol;
                    if (newLeftCol === oldLeftCol)
                    {
                        return
                    }
                    sheet._scrollLeftCol = newLeftCol;
                    if (sheet._paintSuspended || sheet._layoutSuspended > 0)
                    {
                        return
                    }
                    if (Sheets.features.comment)
                    {
                        var commentManager = sheet._commentManager;
                        commentManager.updateCommentsLayoutWhenSheetScroll()
                    }
                    var painted = false;
                    if (Sheets.util._useDoubleBuffer())
                    {
                        var bounds = sheet._bounds,
                            layout = sheet._getSheetLayout(),
                            viewportX = layout.viewportX,
                            viewportWidth = layout.viewportWidth,
                            x,
                            y,
                            width,
                            height;
                        var render = sheet._render,
                            ctx = render._getCtx();
                        if (newLeftCol > oldLeftCol)
                        {
                            var cl1,
                                cl2;
                            var colLayouts = sheet._getColumnLayout(1);
                            if (colLayouts && colLayouts.length > 0)
                            {
                                cl1 = colLayouts.findCol(newLeftCol)
                            }
                            if (cl1)
                            {
                                var j = colLayouts.length - 1;
                                cl2 = colLayouts[j];
                                while (cl2.x + cl2.width > viewportX + viewportWidth)
                                {
                                    j = j - 1;
                                    cl2 = colLayouts[j]
                                }
                                if (cl2.col > newLeftCol)
                                {
                                    painted = true;
                                    var adj = 2;
                                    x = cl1.x;
                                    y = (bounds ? bounds.y : layout.y);
                                    width = cl2.x + cl2.width - cl1.x - adj;
                                    height = layout.height;
                                    render.copyScreen(x, y, width, height, viewportX, y);
                                    sheet.invalidateLayout();
                                    render.paintBody(ctx, new Sheets.Rect(viewportX + width, y, viewportWidth - width, height));
                                    render.paintAdornment(ctx, new Sheets.Rect(viewportX, y, viewportWidth, height))
                                }
                            }
                        }
                        else
                        {
                            var w = 0;
                            for (var j = newLeftCol; j < oldLeftCol && w < viewportWidth; j++)
                            {
                                w += sheet._getZoomColumnWidth(j)
                            }
                            if (w < viewportWidth)
                            {
                                painted = true;
                                var adj = 2;
                                x = viewportX;
                                y = (bounds ? bounds.y : layout.y);
                                width = viewportWidth - w;
                                height = layout.height;
                                if (sheet.getFrozenTrailingColumnCount() > 0)
                                {
                                    width -= 1
                                }
                                render.copyScreen(x, y, width, height, x + w, y);
                                sheet.invalidateLayout();
                                render.paintBody(ctx, new Sheets.Rect(x, y, w + adj, height));
                                render.paintAdornment(ctx, new Sheets.Rect(viewportX, y, viewportWidth, height))
                            }
                        }
                    }
                    if (!painted)
                    {
                        sheet.invalidateLayout();
                        sheet.repaint()
                    }
                    this.updateEditingEditor()
                };
                _SheetEventHandler.prototype._notEqualSelecions = function(oldSelections, newSelections)
                {
                    var notEqual = true;
                    if (oldSelections.length === newSelections.length)
                    {
                        for (var i = 0; i < oldSelections.length; i++)
                        {
                            var oldItem = oldSelections[i];
                            var newItem = newSelections[i];
                            if (oldItem.row !== newItem.row || oldItem.col !== newItem.col || oldItem.rowCount !== newItem.rowCount || oldItem.colCount !== newItem.colCount)
                            {
                                notEqual = true;
                                break
                            }
                            else
                            {
                                notEqual = false
                            }
                        }
                    }
                    return notEqual
                };
                _SheetEventHandler.prototype._createFocusHolder = function(cellType, row, col, changeFocusHolder)
                {
                    var self = this,
                        sheet = self._sheet,
                        context = {
                            sheet: sheet, row: row, col: col, sheetArea: 3
                        };
                    var host = sheet._getHost();
                    var isImeAware = cellType.isImeAware(context);
                    var focusHolder;
                    if (changeFocusHolder)
                    {
                        self._destroyFocusHolder()
                    }
                    if (isImeAware && !self._cellTypeFocusHolder)
                    {
                        focusHolder = cellType.createEditorElement(context);
                        if (!self._focusHolderOldCss)
                        {
                            self._focusHolderOldCss = {
                                overflow: cssVisible, border: cssNone
                            }
                        }
                        self._focusHolderOldCss.overflow = focusHolder.style.overflow;
                        self._focusHolderOldCss.border = focusHolder.style.border;
                        $(focusHolder).css(cssPosition, cssAbsolute).css(cssOverflow, cssHidden).css(cssWidth, "0px").css(cssHeight, "0px").css(cssBorder, cssNone);
                        var sheet = self._sheet;
                        sheet._setEditorValue(cellType, focusHolder, row, col, sheet.getActualStyle(row, col));
                        var value = cellType.getEditorValue(focusHolder, context);
                        if ($.browser.safari)
                        {
                            if (value === "" || value === keyword_null || typeof(value) === const_undefined)
                            {
                                cellType.setEditorValue(focusHolder, " ", context)
                            }
                        }
                        if (host)
                        {
                            host.insertBefore(focusHolder, keyword_null)
                        }
                        self._cellTypeFocusHolder = focusHolder
                    }
                    if (!self._originalFocusHolder)
                    {
                        focusHolder = document.createElement("div");
                        $(focusHolder).css(cssPosition, cssAbsolute).css(cssOverflow, cssHidden).css(cssWidth, "0px").css(cssHeight, "0px");
                        self._originalFocusHolder = focusHolder;
                        var focusElem = document.createElement("textarea");
                        $(focusElem).attr(attrGcUIElement, "gcSheetFocusInput").attr(attrTabIndex, -1).css(cssPosition, cssAbsolute).css(cssOverflow, cssHidden).css(cssBorder, cssNone).css(cssResize, cssNone);
                        focusElem.value = " ";
                        focusHolder.insertBefore(focusElem, keyword_null);
                        self._focusElem = focusElem;
                        var readonlyFocusElem = document.createElement("div");
                        $(readonlyFocusElem).css(cssPosition, cssAbsolute).css(cssOverflow, cssHidden).attr(attrGcUIElement, "gcSheetFocusInput").attr(attrTabIndex, -1);
                        focusHolder.insertBefore(readonlyFocusElem, keyword_null);
                        self._readonlyFocusElem = readonlyFocusElem;
                        if (host)
                        {
                            host.insertBefore(focusHolder, keyword_null)
                        }
                    }
                    if (self._cellTypeFocusHolder)
                    {
                        self._setVisibleLocation(sheet, self._cellTypeFocusHolder)
                    }
                    self._setVisibleLocation(sheet, self._originalFocusHolder);
                    self._setVisibleLocation(sheet, self._readonlyFocusElem);
                    if (isImeAware)
                    {
                        return self._cellTypeFocusHolder
                    }
                    else
                    {
                        return self._focusElem
                    }
                };
                _SheetEventHandler.prototype._resetFocusHolder = function()
                {
                    var self = this;
                    if (self._cellTypeFocusHolder && self._focusHolderOldCss)
                    {
                        $(self._cellTypeFocusHolder).css(cssOverflow, self._focusHolderOldCss.overflow).css(cssBorder, self._focusHolderOldCss.border)
                    }
                };
                _SheetEventHandler.prototype._destroyFocusHolder = function()
                {
                    var self = this;
                    if (self._cellTypeFocusHolder)
                    {
                        if (self._cellTypeFocusHolder.parentElement)
                        {
                            self._cellTypeFocusHolder.parentElement.removeChild(self._cellTypeFocusHolder)
                        }
                        self._cellTypeFocusHolder = keyword_null
                    }
                };
                _SheetEventHandler.prototype.setFocus = function()
                {
                    if (!Sheets.FocusHelper.isActiveElement(this._sheet))
                    {
                        this._setFocusCore(true, true)
                    }
                };
                _SheetEventHandler.prototype.setFocusToReadonlyFocusElem = function()
                {
                    var readonlyFocusElem = this._readonlyFocusElem;
                    if (readonlyFocusElem)
                    {
                        readonlyFocusElem.focus()
                    }
                };
                _SheetEventHandler.prototype.changeFocusHolder = function()
                {
                    this._setFocusCore(true, true)
                };
                _SheetEventHandler.prototype._clearTouchSetFocusTimeout = function()
                {
                    if (this._touchSetFocusTimeout)
                    {
                        clearTimeout(this._touchSetFocusTimeout);
                        this._touchSetFocusTimeout = keyword_null
                    }
                };
                _SheetEventHandler.prototype._setFocusCore = function(delay, changeFocusHolder)
                {
                    if (Sheets.util._isSilverlightCanvas() && !Sheets.util._isStandardCanvas())
                    {
                        return
                    }
                    if (arguments.length === 0)
                    {
                        delay = true
                    }
                    var self = this;
                    self._focusReleased = false;
                    self._clearTouchSetFocusTimeout();
                    var sheet = self._sheet;
                    var activeRow,
                        activeCol;
                    activeRow = sheet.getActiveRowIndex();
                    activeCol = sheet.getActiveColumnIndex();
                    var ct = sheet.getCellType(activeRow, activeCol);
                    self._createFocusHolder(ct, activeRow, activeCol, changeFocusHolder);
                    var context = {
                            sheet: sheet, row: activeRow, col: activeCol, sheetArea: 3
                        };
                    var focusElement;
                    if (ct.isImeAware(context))
                    {
                        focusElement = self._cellTypeFocusHolder
                    }
                    else
                    {
                        focusElement = self._focusElem
                    }
                    if (changeFocusHolder && !$.browser.msie)
                    {
                        ct.setImeMode(focusElement, sheet.getActualStyle(activeRow, activeCol).imeMode, context)
                    }
                    document.body.focus();
                    var setFocusAndIme = function()
                        {
                            var setFocusToEditor = function()
                                {
                                    try
                                    {
                                        if (ct.isImeAware(context))
                                        {
                                            ct.focus(focusElement, context);
                                            ct.selectAll(focusElement, context)
                                        }
                                        else
                                        {
                                            focusElement.focus();
                                            focusElement.select()
                                        }
                                    }
                                    catch(ex) {}
                                };
                            setFocusToEditor();
                            if (changeFocusHolder && $.browser.msie)
                            {
                                ct.setImeMode(focusElement, sheet.getActualStyle(activeRow, activeCol).imeMode, context);
                                setFocusToEditor()
                            }
                        };
                    if (sheet._isTouchMode && (delay || !ct.isImeAware(context)))
                    {
                        var device = Sheets.util.device();
                        if (!sheet.isEditing() && ($.browser.metroMode || device.ipad || device.iphone || device.android))
                        {
                            if (changeFocusHolder)
                            {
                                ct.setImeMode(self._cellTypeFocusHolder, sheet.getActualStyle(activeRow, activeCol).imeMode, context)
                            }
                        }
                        else
                        {
                            self._touchSetFocusTimeout = setTimeout(function()
                            {
                                self._clearTouchSetFocusTimeout();
                                if (sheet.isEditing())
                                {
                                    return
                                }
                                if (sheet._enhanceIme !== false)
                                {
                                    setFocusAndIme()
                                }
                            }, 200)
                        }
                    }
                    else
                    {
                        if (sheet._enhanceIme !== false)
                        {
                            setFocusAndIme()
                        }
                    }
                    if (!Sheets.FocusHelper.isActiveElement(sheet))
                    {
                        Sheets.FocusHelper.setActiveElement(sheet)
                    }
                    self._updateValidationUI(sheet._activeRowIndex, sheet._activeColIndex)
                };
                _SheetEventHandler.prototype._setVisibleLocation = function(sheet, element)
                {
                    var top,
                        left,
                        activeRow = sheet.getActiveRowIndex(),
                        activeCol = sheet.getActiveColumnIndex(),
                        activeRowViewport = sheet.activeRowViewportIndex,
                        activeColViewport = sheet.activeColViewportIndex;
                    ;
                    var activeCellRect = sheet.getCellRect(activeRow, activeCol, activeRowViewport, activeColViewport);
                    var top,
                        left;
                    var self = this;
                    if (self._isInvalidRect(activeCellRect))
                    {
                        top = parseInt($(self._cellTypeFocusHolder).css(cssTop), 10);
                        left = parseInt($(self._cellTypeFocusHolder).css(cssLeft), 10)
                    }
                    else
                    {
                        var canvasOffset = self._getCanvasPosition();
                        top = activeCellRect.y + canvasOffset.top - 2;
                        left = activeCellRect.x + canvasOffset.left - 2
                    }
                    var minTop = window.pageYOffset;
                    var maxTop = window.innerHeight + minTop - parseInt($(self._cellTypeFocusHolder).css(cssHeight), 10);
                    var minLeft = window.pageXOffset;
                    var maxLeft = window.innerWidth + minLeft - parseInt($(self._cellTypeFocusHolder).css(cssWidth), 10);
                    if (isNaN(top) || top < minTop || top > maxTop)
                    {
                        top = minTop
                    }
                    if (isNaN(left) || left < minLeft || left > maxLeft)
                    {
                        left = minLeft
                    }
                    $(element).css(cssTop, top);
                    $(element).css(cssLeft, left)
                };
                _SheetEventHandler.prototype.releaseFocus = function(target)
                {
                    var self = this;
                    self._clearTouchSetFocusTimeout();
                    if (self._sheet.isEditing() || (self._focusReleased && document.activeElement === self._readonlyFocusElem))
                    {
                        return
                    }
                    var sheet = self._sheet;
                    var activeRow,
                        activeCol,
                        activeRowViewport,
                        activeColViewport;
                    if (target)
                    {
                        activeRow = target.row;
                        activeCol = target.col;
                        activeRowViewport = target.rowViewportIndex;
                        activeColViewport = target.colViewportIndex
                    }
                    else
                    {
                        activeRow = sheet._activeRowIndex;
                        activeCol = sheet._activeColIndex;
                        activeRowViewport = sheet.activeRowViewportIndex;
                        activeColViewport = sheet.activeColViewportIndex
                    }
                    var ct = sheet.getCellType(activeRow, activeCol);
                    self._createFocusHolder(ct, activeRow, activeCol, false);
                    self._readonlyFocusElem.focus();
                    self._focusReleased = true
                };
                _SheetEventHandler.prototype.resumeFocus = function(delay)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        delay = true
                    }
                    if (self._focusReleased)
                    {
                        self._focusReleased = false;
                        self._setFocusCore(delay)
                    }
                };
                _SheetEventHandler.prototype._switchFocusForClipboard = function(value)
                {
                    var self = this;
                    if (self._focusElem)
                    {
                        self._focusElem.value = value;
                        self._focusElem.focus();
                        self._focusElem.select();
                        self._clipboardFloatingObjectData = keyword_null
                    }
                };
                _SheetEventHandler.prototype._switchBackFocusAfterClipboard = function()
                {
                    this._setFocusCore(true, false)
                };
                _SheetEventHandler.prototype._setClipboardFloatingObjectData = function(value)
                {
                    this._clipboardFloatingObjectData = value
                };
                _SheetEventHandler.prototype._getClipboardFloatingObjectData = function()
                {
                    return this._clipboardFloatingObjectData
                };
                _SheetEventHandler.prototype._getClipboardData = function()
                {
                    var data = this._focusElem ? this._focusElem.value : "";
                    return this._formatClipboardData(data)
                };
                _SheetEventHandler.prototype._formatClipboardData = function(data)
                {
                    var sbr = "";
                    if (data)
                    {
                        var cellDelimiter = "\"";
                        var dl = cellDelimiter.length;
                        var inCell = false;
                        for (var i = 0; i < data.length; i++)
                        {
                            var tempChar = data[i];
                            if (!inCell && tempChar === "\n")
                            {
                                tempChar = "\r\n"
                            }
                            sbr += tempChar;
                            if (sbr.length >= dl && cellDelimiter === sbr.substr(sbr.length - dl, dl))
                            {
                                inCell = !inCell
                            }
                        }
                    }
                    return sbr
                };
                _SheetEventHandler.prototype._disposeFocusHolders = function()
                {
                    var self = this;
                    self._clearTouchSetFocusTimeout();
                    var focusHolder = self._cellTypeFocusHolder;
                    if (focusHolder)
                    {
                        $(focusHolder).remove();
                        self._cellTypeFocusHolder = keyword_undefined
                    }
                    focusHolder = self._originalFocusHolder;
                    if (focusHolder)
                    {
                        $(focusHolder).remove();
                        self._focusElem = keyword_undefined;
                        self._originalFocusHolder = keyword_null;
                        self._readonlyFocusElem = keyword_null
                    }
                };
                _SheetEventHandler.prototype.bind = function(type, data, fn)
                {
                    $(this._getElem()).bind(type, data, fn)
                };
                _SheetEventHandler.prototype.unbind = function(type, fn)
                {
                    $(this._getElem()).unbind(type, fn)
                };
                _SheetEventHandler.prototype.trigger = function(type, data)
                {
                    if (this._eventSuspended === 0)
                    {
                        $(this._getElem()).trigger(type, data)
                    }
                };
                _SheetEventHandler.prototype._showTooltip = function(info, left, top, isAbsoluteDistanse)
                {
                    var sheet = this._sheet;
                    var currentSpread = sheet.parent;
                    if (currentSpread && !currentSpread._tooltip)
                    {
                        var tooltip = document.createElement("div");
                        $(tooltip).addClass("spread-toolTip ui-state-default ui-widget-content btn-default");
                        $(tooltip).css(cssPosition, cssAbsolute).css(cssPadding, "0px 3px 0px 3px").css(cssFont, "normal normal normal 10pt Arial").css(cssBoxShadow, "1px 2px 5px rgba(0,0,0,0.4)").css(cssBorderRadius, "3px").width(cssAuto).height(cssAuto).appendTo(document.body);
                        currentSpread._tooltip = tooltip
                    }
                    this._refreshTooltip(info, left, top, isAbsoluteDistanse)
                };
                _SheetEventHandler.prototype._refreshTooltip = function(info, left, top, isAbsoluteDistanse)
                {
                    var sheet = this._sheet;
                    var currentSpread = sheet.parent;
                    if (currentSpread)
                    {
                        var tooltip = $(currentSpread._tooltip);
                        if (tooltip)
                        {
                            if (info === keyword_undefined || info === keyword_null || info === "")
                            {
                                tooltip.hide()
                            }
                            else
                            {
                                tooltip.html(info);
                                tooltip.show()
                            }
                            var offset = this._getCanvasOffset();
                            if (isAbsoluteDistanse)
                            {
                                top -= offset.top;
                                left -= offset.left
                            }
                            var bounds = sheet._bounds;
                            if (top + tooltip.outerHeight() > bounds.y + bounds.height)
                            {
                                top = bounds.y + bounds.height - tooltip.outerHeight()
                            }
                            if (left + tooltip.outerWidth() > bounds.x + bounds.width)
                            {
                                left = bounds.x + bounds.width - tooltip.outerWidth()
                            }
                            if (top !== keyword_null && top !== keyword_undefined)
                            {
                                tooltip.css(cssTop, top + offset.top)
                            }
                            if (left !== keyword_null && left !== keyword_undefined)
                            {
                                tooltip.css(cssLeft, left + offset.left)
                            }
                        }
                    }
                };
                _SheetEventHandler.prototype._removeTooltip = function()
                {
                    var sheet = this._sheet;
                    var currentSpread = sheet.parent;
                    if (currentSpread && currentSpread._tooltip)
                    {
                        $(currentSpread._tooltip).remove();
                        currentSpread._tooltip = keyword_null
                    }
                };
                return _SheetEventHandler
            })();
        Sheets._SheetEventHandler = _SheetEventHandler;
        var _MousePosition = (function()
            {
                function _MousePosition()
                {
                    var self = this;
                    self.top = false;
                    self.bottom = false;
                    self.left = false;
                    self.right = false;
                    self.distanceX = 0;
                    self.distanceY = 0;
                    self.nearMouseX = 0;
                    self.nearMouseY = 0
                }
                return _MousePosition
            })()
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var __extends = this.__extends || function(d, b)
    {
        for (var p in b)
            if (b.hasOwnProperty(p))
                d[p] = b[p];
        function __()
        {
            this.constructor = d
        }
        __.prototype = b.prototype;
        d.prototype = new __
    };
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.sheet_border", ["core.common"]);
        var keyword_undefined = undefined;
        var keyword_null = null,
            Math_sqrt = Math.sqrt,
            Math_pow = Math.pow,
            Math_min = Math.min;
        var ComposedLineSide = {
                first: 1, second: 2
            };
        var Line = (function()
            {
                function Line(){}
                Line.prototype.adjust = function(opt)
                {
                    var self = this;
                    if (opt.orientation === 0)
                    {
                        if (opt.offsetEnd)
                        {
                            self._x2 += opt.offsetEnd
                        }
                        if (opt.offsetStart)
                        {
                            self._x1 += opt.offsetStart
                        }
                    }
                    else
                    {
                        if (opt.offsetEnd)
                        {
                            self._y2 += opt.offsetEnd
                        }
                        if (opt.offsetStart)
                        {
                            self._y1 += opt.offsetStart
                        }
                    }
                };
                Line.prototype.paint = function(ctx)
                {
                    var color = (this._color || "#9eb6ce"),
                        lineWidth = this._lineWidth,
                        ctxLineWidth = ctx.lineWidth,
                        ctxStrokeStyle = ctx.strokeStyle;
                    if (ctxLineWidth !== lineWidth || ctxStrokeStyle !== color)
                    {
                        ctx.closePath();
                        ctx.stroke();
                        ctx.beginPath();
                        if (ctxLineWidth !== lineWidth)
                        {
                            ctx.lineWidth = lineWidth
                        }
                        if (ctxStrokeStyle !== color)
                        {
                            ctx.strokeStyle = color
                        }
                    }
                    this.paintLine(ctx)
                };
                Line.prototype.paintLine = function(ctx)
                {
                    var self = this;
                    ctx.moveTo(self._x1, self._y1);
                    ctx.lineTo(self._x2, self._y2)
                };
                Line.Create = function(x1, y1, x2, y2, color, lineStyle)
                {
                    if (lineStyle === keyword_undefined || lineStyle === keyword_null)
                    {
                        lineStyle = 1
                    }
                    switch (lineStyle)
                    {
                        case 1:
                            return new SolidLine(x1, y1, x2, y2, color, 1);
                        case 2:
                            return new SolidLine(x1, y1, x2, y2, color, 2);
                        case 5:
                            return new SolidLine(x1, y1, x2, y2, color, 3);
                        case 3:
                            return new DashedLine(x1, y1, x2, y2, color, 1, [3, 1]);
                        case 9:
                            return new DashedLine(x1, y1, x2, y2, color, 1, [8, 2, 2, 2]);
                        case 4:
                            return new DashedLine(x1, y1, x2, y2, color, 1, [2, 2]);
                        case 11:
                            return new DashedLine(x1, y1, x2, y2, color, 1, [9, 3, 3, 3, 3, 3]);
                        case 13:
                            return new SlantedLine(x1, y1, x2, y2, color, x1 !== x2, [11, 1, 5, 1], [10, 2, 4, 2]);
                        case 10:
                            return new DashedLine(x1, y1, x2, y2, color, 2, [9, 3, 3, 3]);
                        case 12:
                            return new DashedLine(x1, y1, x2, y2, color, 2, [9, 3, 3, 3, 3, 3]);
                        case 8:
                            return new DashedLine(x1, y1, x2, y2, color, 2, [9, 3]);
                        case 7:
                            return new DashedLine(x1, y1, x2, y2, color, 1, [1]);
                        case 6:
                            return new DoubleLine(x1, y1, x2, y2, color, x1 !== x2)
                    }
                    return keyword_null
                };
                return Line
            })();
        Sheets.Line = Line;
        var SolidLine = (function(_super)
            {
                __extends(SolidLine, _super);
                function SolidLine(x1, y1, x2, y2, color, width)
                {
                    _super.call(this);
                    var isSnapToPixel = width % 2;
                    if (!isSnapToPixel)
                    {
                        if (x1 !== x2)
                        {
                            y1 -= 0.5;
                            y2 -= 0.5
                        }
                        else
                        {
                            x1 -= 0.5;
                            x2 -= 0.5
                        }
                    }
                    var self = this;
                    self._x1 = x1;
                    self._y1 = y1;
                    self._x2 = x2;
                    self._y2 = y2;
                    self._color = color;
                    self._lineWidth = width
                }
                return SolidLine
            })(Line);
        Sheets.SolidLine = SolidLine;
        var DashedLine = (function(_super)
            {
                __extends(DashedLine, _super);
                function DashedLine(x1, y1, x2, y2, color, width, pattern)
                {
                    _super.call(this);
                    var isSnapToPixel = width % 2;
                    if (!isSnapToPixel)
                    {
                        if (x1 !== x2)
                        {
                            y1 -= 0.5;
                            y2 -= 0.5
                        }
                        else
                        {
                            x1 -= 0.5;
                            x2 -= 0.5
                        }
                    }
                    var self = this;
                    self._x1 = x1;
                    self._y1 = y1;
                    self._x2 = x2;
                    self._y2 = y2;
                    self._color = color;
                    self._lineWidth = width;
                    self._pattern = pattern
                }
                DashedLine.prototype.paintLine = function(ctx)
                {
                    var self = this;
                    DashedLine.render(ctx, self._x1, self._y1, self._x2, self._y2, self._pattern)
                };
                DashedLine.render = function(ctx, x0, y0, x1, y1, pattern)
                {
                    var length = Math_sqrt(Math_pow(x1 - x0, 2) + Math_pow(y1 - y0, 2));
                    var vector = {
                            x: (x1 - x0) / length, y: (y1 - y0) / length
                        };
                    var dist = 0,
                        i = 0;
                    pattern = pattern && pattern.length ? pattern : [4, 4];
                    while (dist < length)
                    {
                        var dashLength = Math_min(pattern[i++ % pattern.length], length - dist);
                        var draw = (i % 2);
                        dist += dashLength;
                        if (draw)
                        {
                            ctx.moveTo(x0, y0)
                        }
                        x0 += dashLength * vector.x;
                        y0 += dashLength * vector.y;
                        if (draw)
                        {
                            ctx.lineTo(x0, y0)
                        }
                    }
                };
                return DashedLine
            })(Line);
        Sheets.DashedLine = DashedLine;
        var SlantedLine = (function(_super)
            {
                __extends(SlantedLine, _super);
                function SlantedLine(x1, y1, x2, y2, color, horizental, pattern1, pattern2)
                {
                    _super.call(this);
                    if (horizental)
                    {
                        x1 -= 1;
                        x2 -= 1
                    }
                    else
                    {
                        y1 -= 1;
                        y2 -= 1
                    }
                    var self = this;
                    self._x1 = x1;
                    self._y1 = y1;
                    self._x2 = x2;
                    self._y2 = y2;
                    self._color = color;
                    self._horizental = horizental;
                    self._lineWidth = 1;
                    self._pattern1 = pattern1;
                    self._pattern2 = pattern2
                }
                SlantedLine.prototype.paintLine = function(ctx)
                {
                    var self = this;
                    var xOff = self._horizental ? 0 : 1;
                    var yOff = self._horizental ? 1 : 0;
                    DashedLine.render(ctx, self._x1 - xOff, self._y1 - yOff, self._x2 - xOff, self._y2 - yOff, self._pattern1);
                    DashedLine.render(ctx, self._x1, self._y1, self._x2, self._y2, self._pattern2)
                };
                return SlantedLine
            })(Line);
        Sheets.SlantedLine = SlantedLine;
        var DoubleLine = (function(_super)
            {
                __extends(DoubleLine, _super);
                function DoubleLine(x1, y1, x2, y2, color, horizental)
                {
                    _super.call(this);
                    var xOff = horizental ? 0 : 1;
                    var yOff = horizental ? 1 : 0;
                    var self = this;
                    self._line1 = new SolidLine(x1 - xOff, y1 - yOff, x2 - xOff, y2 - yOff, color, 1);
                    self._line2 = new SolidLine(x1 + xOff, y1 + yOff, x2 + xOff, y2 + yOff, color, 1);
                    self._color = color;
                    self._horizental = horizental;
                    self._lineWidth = 1
                }
                DoubleLine.prototype.paintLine = function(ctx)
                {
                    this._line1.paintLine(ctx);
                    this._line2.paintLine(ctx)
                };
                DoubleLine.prototype.adjust = function(opt)
                {
                    var self = this;
                    if (!opt.lineSide)
                    {
                        self._line1.adjust(opt);
                        self._line2.adjust(opt)
                    }
                    else if (opt.lineSide === ComposedLineSide.first)
                    {
                        self._line1.adjust(opt)
                    }
                    else if (opt.lineSide === ComposedLineSide.second)
                    {
                        self._line2.adjust(opt)
                    }
                };
                return DoubleLine
            })(Line);
        Sheets.DoubleLine = DoubleLine;
        (function(_LineType)
        {
            _LineType[_LineType["previous"] = -1] = "previous";
            _LineType[_LineType["next"] = 1] = "next"
        })(Sheets._LineType || (Sheets._LineType = {}));
        var _LineType = Sheets._LineType;
        (function(_LineOrientation)
        {
            _LineOrientation[_LineOrientation["horizontal"] = 0] = "horizontal";
            _LineOrientation[_LineOrientation["vertical"] = 1] = "vertical"
        })(Sheets._LineOrientation || (Sheets._LineOrientation = {}));
        var _LineOrientation = Sheets._LineOrientation;
        var BorderLayoutEngine = (function()
            {
                function BorderLayoutEngine(){}
                BorderLayoutEngine.compareColor = function(color1, color2)
                {
                    return 0
                };
                BorderLayoutEngine.compareLineStyle = function(line1, line2)
                {
                    if (!line1)
                    {
                        if (!line2)
                        {
                            return 0
                        }
                        return -1
                    }
                    else if (!line2)
                    {
                        return 1
                    }
                    var weightCache = BorderLayoutEngine._styleWeightCache;
                    return weightCache[line1.style] - weightCache[line2.style]
                };
                BorderLayoutEngine.getDrawingThickness = function(lineItem)
                {
                    if (lineItem)
                    {
                        if (lineItem.isGridLine)
                        {
                            return 1
                        }
                        if (lineItem.style)
                        {
                            return Sheets.LineBorder.prototype.width(lineItem.style)
                        }
                    }
                    return 0
                };
                BorderLayoutEngine.isDoubleLine = function(line)
                {
                    return (line && line.style === 6)
                };
                BorderLayoutEngine.isSlantedLine = function(line)
                {
                    return (line && line.style === 13)
                };
                BorderLayoutEngine.getMaxLine = function(line1, line2)
                {
                    if (!line1)
                    {
                        return line2
                    }
                    else if (!line2)
                    {
                        return line1
                    }
                    return BorderLayoutEngine.compareLineStyle(line1.style, line2.style) >= 0 ? line1 : line2
                };
                BorderLayoutEngine.adjustLine = function(lineItem, opt)
                {
                    if (lineItem && lineItem.line)
                    {
                        lineItem.line.adjust(opt)
                    }
                };
                BorderLayoutEngine.compareLine = function(lineItem1, lineItem2)
                {
                    if (lineItem1 === lineItem2)
                    {
                        return 0
                    }
                    if (!lineItem1)
                    {
                        return -1
                    }
                    if (!lineItem2)
                    {
                        return 1
                    }
                    if (lineItem1.isGridLine)
                    {
                        return lineItem2.isGridLine ? 0 : -1
                    }
                    else if (lineItem2.isGridLine)
                    {
                        return 1
                    }
                    return BorderLayoutEngine.compareLineStyle(lineItem1.style, lineItem2.style)
                };
                BorderLayoutEngine.isDoubleLineItem = function(lineItem)
                {
                    return lineItem && lineItem.style && lineItem.style.style === 6
                };
                BorderLayoutEngine.isAllowExtend = function(current, line, break1, break2)
                {
                    if (current.style && current.style.style === 6)
                    {
                        return true
                    }
                    var doubleCnt = 0;
                    doubleCnt += (line && line.style && line.style.style === 6) ? 1 : 0;
                    doubleCnt += (break1 && break1.style && break1.style.style === 6) ? 1 : 0;
                    doubleCnt += (break2 && break2.style && break2.style.style === 6) ? 1 : 0;
                    return doubleCnt < 2
                };
                BorderLayoutEngine.layout4CrossRoad = function(current, line, break1, break2, lineType, vertical)
                {
                    var opt = {
                            orientation: (vertical ? 1 : 0), offsetStart: 0, offsetEnd: 0
                        };
                    var diff1 = this.compareLine(current, break1),
                        diff2 = this.compareLine(current, break2);
                    if (diff1 >= 0 && diff2 >= 0)
                    {
                        if (diff1 === 0 && diff2 === 0)
                        {
                            if (lineType !== -1)
                            {
                                if (lineType === 1)
                                {
                                    opt.offsetEnd -= lineType
                                }
                            }
                        }
                        else
                        {
                            if (lineType === -1)
                            {
                                opt.offsetStart -= lineType
                            }
                            else if (lineType === 1)
                            {
                                opt.offsetEnd -= 2 * lineType
                            }
                        }
                    }
                    else if (diff2 >= 0)
                    {
                        opt.lineSide = ComposedLineSide.second;
                        opt.offsetStart += lineType
                    }
                    else if (diff1 >= 0)
                    {
                        opt.lineSide = ComposedLineSide.first;
                        opt.offsetStart += lineType
                    }
                    this.adjustLine(current, opt)
                };
                BorderLayoutEngine.layout4TurnRoad = function(current, prevLine, nextLine, break1, break2, type, lineType, vertical, swap)
                {
                    var optFirst = {
                            orientation: (vertical ? 1 : 0), lineSide: (swap ? ComposedLineSide.second : ComposedLineSide.first), offsetStart: 0, offsetEnd: 0
                        };
                    var optSecond = {
                            orientation: (vertical ? 1 : 0), lineSide: (swap ? ComposedLineSide.first : ComposedLineSide.second), offsetStart: 0, offsetEnd: 0
                        };
                    var breakLine = (type === 1 ? break1 : break2);
                    var neighborLine = (lineType === 1 ? nextLine : prevLine);
                    var hasNeighborDoubleLine = this.isDoubleLineItem(neighborLine);
                    if (!hasNeighborDoubleLine)
                    {
                        if (this.compareLine(current, breakLine) >= 0)
                        {
                            if (lineType === -1)
                            {
                                optSecond.offsetStart -= 2 * lineType
                            }
                            else if (lineType === 1)
                            {
                                optSecond.offsetEnd -= 2 * lineType
                            }
                        }
                        else
                        {
                            if (lineType === -1)
                            {
                                optFirst.offsetStart += 2 * lineType
                            }
                            else if (lineType === 1)
                            {
                                optFirst.offsetEnd += 2 * lineType
                            }
                        }
                    }
                    else
                    {
                        var diff = this.compareLine(current, breakLine);
                        if (diff === 0)
                        {
                            var diff1 = this.compareLine(current, neighborLine);
                            if (diff1 === 0)
                            {
                                if (lineType === 1)
                                {
                                    optSecond.offsetEnd -= lineType
                                }
                            }
                            else if (diff1 > 0)
                            {
                                if (lineType === -1)
                                {
                                    optSecond.offsetStart -= 2 * lineType
                                }
                                else if (lineType === 1)
                                {
                                    optSecond.offsetEnd -= 2 * lineType
                                }
                            }
                        }
                        else if (diff > 0)
                        {
                            var diff2 = this.compareLine(current, neighborLine);
                            if (diff2 === 0)
                            {
                                if (lineType === 1)
                                {
                                    optSecond.offsetEnd -= lineType
                                }
                            }
                            else if (diff2 > 0)
                            {
                                if (lineType === -1)
                                {
                                    optSecond.offsetStart -= 2 * lineType
                                }
                                else if (lineType === 1)
                                {
                                    optSecond.offsetEnd -= 2 * lineType
                                }
                            }
                        }
                        else
                        {
                            var diff3 = this.compareLine(current, neighborLine);
                            if (diff3 === 0)
                            {
                                if (lineType === -1)
                                {
                                    optFirst.offsetStart += 2 * lineType
                                }
                                else if (lineType === 1)
                                {
                                    optFirst.offsetEnd += 2 * lineType
                                }
                            }
                            else if (diff3 > 0)
                            {
                                if (lineType === -1)
                                {
                                    optFirst.offsetStart -= 3 * lineType
                                }
                                else if (lineType === 1)
                                {
                                    optFirst.offsetEnd -= 3 * lineType
                                }
                            }
                        }
                    }
                    var otherType = (type === 1 ? 2 : 1);
                    var otherBreakLine = (otherType === 1 ? break1 : break2);
                    var needMakeupCorner = false;
                    var thickness = 0;
                    if (!needMakeupCorner && this.isDoubleLineItem(otherBreakLine) && this.compareLine(otherBreakLine, current) > 0)
                    {
                        needMakeupCorner = true;
                        var drawThickness = BorderLayoutEngine.getDrawingThickness(otherBreakLine);
                        if (this.compareLine(otherBreakLine, breakLine) > 0)
                        {
                            if (drawThickness > 0)
                            {
                                if (lineType === 1 && this.isDoubleLineItem(nextLine))
                                {
                                    thickness = drawThickness >= 2 ? 2 : 1
                                }
                                else if (lineType === -1 && this.isDoubleLineItem(prevLine))
                                {
                                    thickness = drawThickness >= 3 ? 2 : 1
                                }
                                else
                                {
                                    thickness = drawThickness === 3 ? 3 : 2
                                }
                            }
                        }
                        else
                        {
                            thickness = drawThickness === 3 ? 3 : 2
                        }
                    }
                    if (!needMakeupCorner && (!this.isDoubleLineItem(neighborLine)) && ((neighborLine && !neighborLine.isGridLine) || (otherBreakLine && !otherBreakLine.isGridLine)))
                    {
                        needMakeupCorner = true;
                        if (lineType === -1)
                        {
                            thickness = 2
                        }
                        else
                        {
                            thickness = 1
                        }
                    }
                    if (needMakeupCorner)
                    {
                        if (lineType === -1)
                        {
                            optFirst.offsetStart += lineType * thickness;
                            optSecond.offsetStart += lineType * thickness
                        }
                        else if (lineType === 1)
                        {
                            optFirst.offsetEnd += lineType * thickness;
                            optSecond.offsetEnd += lineType * thickness
                        }
                    }
                    if (optFirst.offsetStart || optFirst.offsetEnd)
                    {
                        this.adjustLine(current, optFirst)
                    }
                    if (optSecond.offsetStart || optSecond.offsetEnd)
                    {
                        this.adjustLine(current, optSecond)
                    }
                };
                BorderLayoutEngine.layout4TRoad = function(current, line, break1, break2, lineType, vertical)
                {
                    if (this.compareLine(current, break1) >= 0 && this.compareLine(current, break2) >= 0)
                    {
                        var opt = {
                                orientation: (vertical ? 1 : 0), offsetStart: 0, offsetEnd: 0
                            };
                        if (lineType === -1)
                        {
                            opt.offsetStart -= 2 * lineType;
                            if (this.isDoubleLineItem(current) && this.compareLine(line, current) > 0)
                            {
                                opt.offsetStart -= 1
                            }
                        }
                        else if (lineType === 1)
                        {
                            opt.offsetEnd -= 2 * lineType;
                            if (this.isDoubleLineItem(current) && this.compareLine(line, current) > 0)
                            {
                                opt.offsetEnd += 1
                            }
                        }
                        this.adjustLine(current, opt)
                    }
                };
                BorderLayoutEngine.layout4Connected = function(current, line, break1, break2, lineType, vertical)
                {
                    if (this.isDoubleLineItem(current))
                    {
                        var breakLine = this.getMaxLine(break1, break2);
                        if (breakLine && !breakLine.isGridLine)
                        {
                            var drawThickness = BorderLayoutEngine.getDrawingThickness(breakLine);
                            if (drawThickness > 0)
                            {
                                var opt = {
                                        orientation: (vertical ? 1 : 0), offsetStart: 0, offsetEnd: 0
                                    };
                                if (lineType === -1)
                                {
                                    opt.offsetStart += drawThickness * lineType
                                }
                                else
                                {
                                    opt.offsetEnd += drawThickness * lineType
                                }
                                if (opt.offsetStart || opt.offsetEnd)
                                {
                                    this.adjustLine(current, opt)
                                }
                            }
                        }
                    }
                };
                BorderLayoutEngine.calcLayoutHorizontal = function(current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                {
                    var drawThickness;
                    var diff;
                    var self = BorderLayoutEngine;
                    if (prevLine || prevBreak1 || prevBreak2)
                    {
                        var prevBreak = self.getMaxLine(prevBreak1, prevBreak2);
                        if (!self.isAllowExtend(current, prevLine, prevBreak1, prevBreak2))
                        {
                            self.adjustLine(current, {
                                orientation: 0, offsetStart: 1
                            })
                        }
                        else if ((diff = self.compareLine(prevBreak, current)) > 0)
                        {
                            drawThickness = self.getDrawingThickness(prevBreak);
                            if (!(self.isDoubleLineItem(current) && (self.isDoubleLineItem(prevBreak1) || self.isDoubleLineItem(prevBreak2) || self.isDoubleLineItem(prevLine))))
                            {
                                if (drawThickness === 3)
                                {
                                    self.adjustLine(current, {
                                        orientation: 0, offsetStart: 1
                                    })
                                }
                            }
                        }
                        else if (prevBreak && diff < 0)
                        {
                            if ((diff = self.compareLine(current, prevLine)) > 0)
                            {
                                drawThickness = self.getDrawingThickness(prevBreak);
                                if (drawThickness === 3 || drawThickness === 2)
                                {
                                    self.adjustLine(current, {
                                        orientation: 0, offsetStart: -2
                                    })
                                }
                                else if (drawThickness === 1)
                                {
                                    self.adjustLine(current, {
                                        orientation: 0, offsetStart: -1
                                    })
                                }
                            }
                            else if (diff !== 0)
                            {
                                if (self.compareLine(prevLine, prevBreak) > 0)
                                {
                                    drawThickness = self.getDrawingThickness(prevBreak);
                                    if (drawThickness === 3)
                                    {
                                        self.adjustLine(current, {
                                            orientation: 0, offsetStart: 1
                                        })
                                    }
                                }
                            }
                        }
                        else if (diff === 0)
                        {
                            if (!prevLine || self.compareLine(current, prevLine) > 0)
                            {
                                drawThickness = self.getDrawingThickness(prevBreak);
                                if (drawThickness === 3 || drawThickness === 2)
                                {
                                    self.adjustLine(current, {
                                        orientation: 0, offsetStart: -2
                                    })
                                }
                                else if (drawThickness === 1)
                                {
                                    self.adjustLine(current, {
                                        orientation: 0, offsetStart: -1
                                    })
                                }
                            }
                        }
                    }
                    if (nextLine || nextBreak1 || nextBreak2)
                    {
                        var nextBreak = self.getMaxLine(nextBreak1, nextBreak2);
                        if (!self.isAllowExtend(current, nextLine, nextBreak1, nextBreak2))
                        {
                            self.adjustLine(current, {
                                orientation: 0, offsetEnd: -2
                            })
                        }
                        else if ((diff = self.compareLine(nextBreak, current)) > 0)
                        {
                            drawThickness = self.getDrawingThickness(nextBreak);
                            if (!(self.isDoubleLineItem(current) && (self.isDoubleLineItem(nextBreak1) || self.isDoubleLineItem(nextBreak2) || self.isDoubleLineItem(nextLine))))
                            {
                                if (drawThickness === 3)
                                {
                                    self.adjustLine(current, {
                                        orientation: 0, offsetEnd: -2
                                    })
                                }
                                else if (drawThickness === 2 || drawThickness === 1)
                                {
                                    self.adjustLine(current, {
                                        orientation: 0, offsetEnd: -1
                                    })
                                }
                            }
                        }
                        else if (diff < 0)
                        {
                            if ((diff = self.compareLine(current, nextLine)) > 0)
                            {
                                drawThickness = self.getDrawingThickness(nextBreak);
                                if (drawThickness === 3)
                                {
                                    self.adjustLine(current, {
                                        orientation: 0, offsetEnd: 1
                                    })
                                }
                            }
                            else if (diff !== 0)
                            {
                                self.adjustLine(current, {
                                    orientation: 0, offsetEnd: -1
                                })
                            }
                        }
                        else if (diff === 0)
                        {
                            if ((diff = self.compareLine(current, nextLine)) > 0)
                            {
                                drawThickness = self.getDrawingThickness(nextBreak);
                                if (drawThickness === 3)
                                {
                                    self.adjustLine(current, {
                                        orientation: 0, offsetEnd: 1
                                    })
                                }
                            }
                            else if (diff !== 0)
                            {
                                self.adjustLine(current, {
                                    orientation: 0, offsetEnd: -1
                                })
                            }
                        }
                    }
                };
                BorderLayoutEngine.calcLayoutVertical = function(current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                {
                    var drawThickness;
                    var diff;
                    var self = BorderLayoutEngine;
                    if (prevLine || prevBreak1 || prevBreak2)
                    {
                        var prevBreak = self.getMaxLine(prevBreak1, prevBreak2);
                        if (!self.isAllowExtend(current, prevLine, prevBreak1, prevBreak2))
                        {
                            self.adjustLine(current, {
                                orientation: 1, offsetStart: 1
                            })
                        }
                        else if ((diff = self.compareLine(prevBreak, current)) > 0)
                        {
                            drawThickness = self.getDrawingThickness(prevBreak);
                            if (!(self.isDoubleLineItem(current) && (self.isDoubleLineItem(prevBreak1) || self.isDoubleLineItem(prevBreak2) || self.isDoubleLineItem(prevLine))))
                            {
                                if (drawThickness === 3)
                                {
                                    self.adjustLine(current, {
                                        orientation: 1, offsetStart: 1
                                    })
                                }
                            }
                        }
                        else if (diff < 0)
                        {
                            if ((diff = self.compareLine(current, prevLine)) > 0)
                            {
                                drawThickness = self.getDrawingThickness(prevBreak);
                                if (drawThickness === 3 || drawThickness === 2)
                                {
                                    self.adjustLine(current, {
                                        orientation: 1, offsetStart: -2
                                    })
                                }
                                else if (drawThickness === 1)
                                {
                                    self.adjustLine(current, {
                                        orientation: 1, offsetStart: -1
                                    })
                                }
                            }
                            else if (diff !== 0)
                            {
                                if (self.compareLine(prevLine, prevBreak) > 0)
                                {
                                    drawThickness = self.getDrawingThickness(prevBreak);
                                    if (drawThickness === 3)
                                    {
                                        self.adjustLine(current, {
                                            orientation: 1, offsetStart: 1
                                        })
                                    }
                                }
                            }
                        }
                        else if (diff === 0)
                        {
                            if (self.compareLine(current, prevLine) > 0)
                            {
                                drawThickness = self.getDrawingThickness(prevBreak);
                                if (drawThickness === 3 || drawThickness === 2)
                                {
                                    self.adjustLine(current, {
                                        orientation: 1, offsetStart: -2
                                    })
                                }
                                else if (drawThickness === 1)
                                {
                                    self.adjustLine(current, {
                                        orientation: 1, offsetStart: -1
                                    })
                                }
                            }
                        }
                    }
                    if (nextLine || nextBreak1 || nextBreak2)
                    {
                        var nextBreak = self.getMaxLine(nextBreak1, nextBreak2);
                        if (!self.isAllowExtend(current, nextLine, nextBreak1, nextBreak2))
                        {
                            self.adjustLine(current, {
                                orientation: 1, offsetEnd: -2
                            })
                        }
                        else if ((diff = self.compareLine(current, nextBreak)) < 0)
                        {
                            drawThickness = self.getDrawingThickness(nextBreak);
                            if (!(self.isDoubleLineItem(current) && (self.isDoubleLineItem(nextBreak1) || self.isDoubleLineItem(nextBreak2) || self.isDoubleLineItem(nextLine))))
                            {
                                if (drawThickness === 3 || drawThickness === 2)
                                {
                                    self.adjustLine(current, {
                                        orientation: 1, offsetEnd: -2
                                    })
                                }
                                else if (drawThickness === 1)
                                {
                                    self.adjustLine(current, {
                                        orientation: 1, offsetEnd: -1
                                    })
                                }
                            }
                        }
                        else if (nextBreak !== keyword_null && diff > 0)
                        {
                            if ((diff = self.compareLine(current, nextLine)) > 0)
                            {
                                drawThickness = self.getDrawingThickness(nextBreak);
                                if (drawThickness === 3)
                                {
                                    self.adjustLine(current, {
                                        orientation: 1, offsetEnd: 1
                                    })
                                }
                            }
                            else if (diff !== 0)
                            {
                                self.adjustLine(current, {
                                    orientation: 1, offsetEnd: -1
                                })
                            }
                        }
                        else if (diff === 0)
                        {
                            if ((diff = self.compareLine(current, nextLine)) > 0)
                            {
                                drawThickness = self.getDrawingThickness(nextBreak);
                                if (drawThickness === 3)
                                {
                                    self.adjustLine(current, {
                                        orientation: 1, offsetEnd: 1
                                    })
                                }
                            }
                            else if (diff !== 0)
                            {
                                self.adjustLine(current, {
                                    orientation: 1, offsetEnd: -1
                                })
                            }
                        }
                    }
                };
                BorderLayoutEngine.calcDoubleLayout = function(current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2, vertical)
                {
                    var self = BorderLayoutEngine;
                    if (vertical)
                    {
                        this.calcLayoutVertical(current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                    }
                    else
                    {
                        this.calcLayoutHorizontal(current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                    }
                    var break1DoubleLine = self.isDoubleLineItem(prevBreak1),
                        break2DoubleLine = self.isDoubleLineItem(prevBreak2),
                        prevDoubleLine = self.isDoubleLineItem(prevLine);
                    if (break1DoubleLine && break2DoubleLine && prevDoubleLine)
                    {
                        self.layout4CrossRoad(current, prevLine, prevBreak1, prevBreak2, -1, vertical)
                    }
                    else if (break1DoubleLine && !break2DoubleLine)
                    {
                        self.layout4TurnRoad(current, prevLine, nextLine, prevBreak1, prevBreak2, 1, -1, vertical, true)
                    }
                    else if (!break1DoubleLine && break2DoubleLine)
                    {
                        self.layout4TurnRoad(current, prevLine, nextLine, prevBreak1, prevBreak2, 2, -1, vertical, false)
                    }
                    else if (break1DoubleLine && break2DoubleLine && !prevDoubleLine)
                    {
                        self.layout4TRoad(current, prevLine, prevBreak1, prevBreak2, -1, vertical)
                    }
                    else if (prevDoubleLine)
                    {
                        self.layout4Connected(current, prevLine, prevBreak1, prevBreak2, -1, vertical)
                    }
                    break1DoubleLine = self.isDoubleLineItem(nextBreak1);
                    break2DoubleLine = self.isDoubleLineItem(nextBreak2);
                    var nextDoubleLine = self.isDoubleLineItem(nextLine);
                    if (break1DoubleLine && break2DoubleLine && nextDoubleLine)
                    {
                        self.layout4CrossRoad(current, nextLine, nextBreak1, nextBreak2, 1, vertical)
                    }
                    else if (break1DoubleLine && !break2DoubleLine)
                    {
                        self.layout4TurnRoad(current, prevLine, nextLine, nextBreak1, nextBreak2, 1, 1, vertical, true)
                    }
                    else if (!break1DoubleLine && break2DoubleLine)
                    {
                        self.layout4TurnRoad(current, prevLine, nextLine, nextBreak1, nextBreak2, 2, 1, vertical, false)
                    }
                    else if (break1DoubleLine && break2DoubleLine && !nextDoubleLine)
                    {
                        self.layout4TRoad(current, nextLine, nextBreak1, nextBreak2, 1, vertical)
                    }
                    else if (nextDoubleLine)
                    {
                        self.layout4Connected(current, nextLine, nextBreak1, nextBreak2, 1, vertical)
                    }
                };
                BorderLayoutEngine._styleWeightCache = [0, 101, 199, 100, 100, 300, 90, 100, 198, 100, 198, 100, 198, 198];
                return BorderLayoutEngine
            })();
        var DefaultLineLayout = {
                layoutHorizontal: function(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                {
                    BorderLayoutEngine.calcLayoutHorizontal(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                }, layoutVertical: function(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                    {
                        BorderLayoutEngine.calcLayoutVertical(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                    }
            };
        var DoubleLineLayout = {
                layoutHorizontal: function(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                {
                    BorderLayoutEngine.calcDoubleLayout(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2, false)
                }, layoutVertical: function(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2)
                    {
                        BorderLayoutEngine.calcDoubleLayout(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2, true)
                    }
            };
        var SlantedLineLayout = {
                layoutHorizontal: function(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2){}, layoutVertical: function(line, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2){}
            };
        var _FastBorders = (function()
            {
                function _FastBorders(row, column, rowCount, colCount, clipRect)
                {
                    this._row = row;
                    this._column = column;
                    this._horPoints = [];
                    this._verPoints = [];
                    this._lines = {}
                }
                _FastBorders.prototype._addLine = function(style, row, col, rowCount, colCount)
                {
                    if (rowCount !== 0 && colCount !== 0)
                    {
                        throw'invalid argument.';
                    }
                    var lines = this._lines[style];
                    if (!lines)
                    {
                        lines = this._lines[style] = {
                            hori: [], vert: []
                        }
                    }
                    if (rowCount === 0)
                    {
                        var index = row;
                        var start = col;
                        var end = col + colCount;
                        var ls = lines.hori
                    }
                    else
                    {
                        index = col;
                        start = row;
                        end = row + rowCount;
                        ls = lines.vert
                    }
                    var line = ls[index];
                    if (line)
                    {
                        for (var i = line.length - 1; i >= 0; i--)
                        {
                            var item = line[i];
                            if (start > item.e)
                            {
                                line.splice(i + 1, 0, {
                                    s: start, e: end
                                });
                                return
                            }
                            else if (end < item.s)
                            {
                                if (i === 0)
                                {
                                    line.unshift({
                                        s: start, e: end
                                    });
                                    return
                                }
                                continue
                            }
                            else if (start >= item.s)
                            {
                                line.splice(i, 1, {
                                    s: item.s, e: Math.max(item.e, end)
                                });
                                return
                            }
                            else
                            {
                                for (var j = i - 1; j >= 0; j++)
                                {
                                    if (line[j].e < start)
                                    {
                                        line.splice(j + 1, i - j, {
                                            s: start, e: Math.max(item.e, end)
                                        });
                                        return
                                    }
                                    else if (line[j].s > start)
                                    {
                                        if (j === 0)
                                        {
                                            line.splice(0, i, {
                                                s: start, e: Math.max(item.e, end)
                                            });
                                            return
                                        }
                                        continue
                                    }
                                    else
                                    {
                                        line.splice(j, i - j + 1, {
                                            s: line[j].s, e: Math.max(item.e, end)
                                        });
                                        return
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        line = ls[index] = [{
                                s: start, e: end
                            }]
                    }
                };
                _FastBorders.prototype._getStyle = function(borderLine)
                {
                    if (borderLine.style === 0)
                    {
                        return null
                    }
                    return _FastBorders._lineStyleCache[borderLine.style] + borderLine.color
                };
                _FastBorders.prototype.addCellLines = function(row, col, x, y, width, height, style, spanCellLayout)
                {
                    if (!style)
                    {
                        return
                    }
                    var self = this,
                        rowCount = 1,
                        colCount = 1,
                        horPoints = self._horPoints,
                        verPoints = self._verPoints;
                    if (spanCellLayout)
                    {
                        if (row !== spanCellLayout.row || col !== spanCellLayout.col)
                        {
                            return
                        }
                        row = spanCellLayout.row;
                        col = spanCellLayout.col;
                        rowCount = spanCellLayout.rowCount;
                        colCount = spanCellLayout.colCount;
                        horPoints[row] = spanCellLayout.y;
                        horPoints[row + rowCount] = spanCellLayout.y + spanCellLayout.height;
                        verPoints[col] = spanCellLayout.x;
                        verPoints[col + colCount] = spanCellLayout.x + spanCellLayout.width
                    }
                    else
                    {
                        horPoints[row] = y;
                        horPoints[row + 1] = y + height;
                        verPoints[col] = x;
                        verPoints[col + 1] = x + width
                    }
                    var borderLeft = style.borderLeft;
                    if (borderLeft && borderLeft.style)
                    {
                        self._addLine(self._getStyle(borderLeft), row, col, rowCount, 0)
                    }
                    var borderRight = style.borderRight;
                    if (borderRight && borderRight.style)
                    {
                        self._addLine(self._getStyle(borderRight), row, col + colCount, rowCount, 0)
                    }
                    var borderTop = style.borderTop;
                    if (borderTop && borderTop.style)
                    {
                        self._addLine(self._getStyle(borderTop), row, col, 0, colCount)
                    }
                    var borderBottom = style.borderBottom;
                    if (borderBottom && borderBottom.style)
                    {
                        self._addLine(self._getStyle(borderBottom), row + rowCount, col, 0, colCount)
                    }
                };
                _FastBorders.prototype.addCellOverlfowLayout = function(row, cellOverflowLayout)
                {
                    for (var i = cellOverflowLayout.startColumn; i <= cellOverflowLayout.endColumn; i++)
                    {
                        this._removeAllVertLine(row, i)
                    }
                };
                _FastBorders.prototype._removeAllVertLine = function(row, col)
                {
                    for (var style in this._lines)
                    {
                        this._removeLine(this._lines[style].vert, col, row, 1)
                    }
                };
                _FastBorders.prototype._removeLine = function(from, row, start, count)
                {
                    var end = start + count;
                    var ls = from[row];
                    if (ls)
                    {
                        for (var i = ls.length - 1; i >= 0; i--)
                        {
                            var l = ls[i];
                            if (l.e > start && l.s < end)
                            {
                                var r = [];
                                if (l.s < start)
                                {
                                    r.push({
                                        s: l.s, e: start
                                    })
                                }
                                if (l.e >= end)
                                {
                                    r.push({
                                        s: end, e: l.e
                                    })
                                }
                                var args = [i, 1].concat(r);
                                Array.prototype.splice.apply(ls, args)
                            }
                        }
                    }
                };
                _FastBorders.prototype.paint = function(context, clipRect)
                {
                    var styles = Object.getOwnPropertyNames(this._lines);
                    styles = styles.sort();
                    for (var i = 0; i < styles.length; i++)
                    {
                        var lines = this._lines[styles[i]];
                        var style = styles[i].split('-');
                        var width = parseInt(style[0]);
                        context.beginPath();
                        context.strokeStyle = style[1];
                        context.lineWidth = width;
                        for (var i = 0; i < lines.hori.length; i++)
                        {
                            var l = lines.hori[i];
                            if (l)
                            {
                                var y = this._horPoints[i];
                                if (typeof y !== 'number')
                                {
                                    continue
                                }
                                for (var j = 0; j < l.length; j++)
                                {
                                    var item = l[j];
                                    context.moveTo(this._verPoints[item.s], y - 0.5);
                                    context.lineTo(this._verPoints[item.e], y - 0.5)
                                }
                            }
                        }
                        for (i = 0; i < lines.vert.length; i++)
                        {
                            l = lines.vert[i];
                            if (l)
                            {
                                var x = this._verPoints[i];
                                if (typeof x !== 'number')
                                {
                                    continue
                                }
                                for (j = 0; j < l.length; j++)
                                {
                                    var item = l[j];
                                    context.moveTo(x - 0.5, this._horPoints[item.s]);
                                    context.lineTo(x - 0.5, this._horPoints[item.e])
                                }
                            }
                        }
                        context.stroke()
                    }
                };
                _FastBorders._lineStyleCache = ['', '1-', '2-', '1-', '1-', '3-', '3-', '1-', '2-', '1-', '2-', '1-', '2-', '2-'];
                return _FastBorders
            })();
        Sheets._FastBorders = _FastBorders;
        var _GcBorders = (function()
            {
                function _GcBorders(sheet, rowViewportIndex, colViewportIndex, sheetArea)
                {
                    this._isInitialized = false;
                    this._isMerged = false;
                    var self = this;
                    self._sheet = sheet;
                    self._sheetArea = sheetArea;
                    self._rowViewportIndex = rowViewportIndex;
                    self._colViewportIndex = colViewportIndex
                }
                _GcBorders.prototype._initialize = function()
                {
                    var self = this;
                    self._spanCells = [];
                    self._rowIndecies = [];
                    self._colIndecies = [];
                    self._overflowedCells = [];
                    self._adjustingRanges = [];
                    self._hGridLine = {};
                    self._vGridLine = {};
                    self._hBorders = {};
                    self._vBorders = {};
                    var sheet = self._sheet,
                        sheetArea = self._sheetArea,
                        colViewportIndex = self._colViewportIndex,
                        rowViewportIndex = self._rowViewportIndex;
                    var rowLayoutModel = sheet._getRowLayout(rowViewportIndex, sheetArea),
                        colLayoutModel = sheet._getColumnLayout(colViewportIndex, sheetArea);
                    if (rowLayoutModel && rowLayoutModel.length > 0 && colLayoutModel && colLayoutModel.length > 0)
                    {
                        var rowIndecies = self._rowIndecies,
                            rowLayoutCount = rowLayoutModel.length,
                            rowLyout;
                        for (var i = 0; i < rowLayoutCount; i++)
                        {
                            rowLyout = rowLayoutModel[i];
                            if (rowLyout.height > 0)
                            {
                                rowIndecies.push(rowLyout.row)
                            }
                        }
                        rowIndecies.push(rowIndecies.length - 1) + 1;
                        var colIndecies = self._colIndecies,
                            colLayoutCount = colLayoutModel.length,
                            colLayout;
                        for (var j = 0; j < colLayoutCount; j++)
                        {
                            colLayout = colLayoutModel[j];
                            if (colLayout.width > 0)
                            {
                                colIndecies.push(colLayout.col)
                            }
                        }
                        colIndecies.push(colIndecies.length - 1) + 1
                    }
                    self._isInitialized = true
                };
                _GcBorders.prototype.addCellOverlfowLayout = function(row, cellOverflowLayout)
                {
                    if (cellOverflowLayout)
                    {
                        var overflowedCell = {
                                row: row, startCol: cellOverflowLayout.startColumn, endCol: cellOverflowLayout.endColumn
                            };
                        this._overflowedCells.push(overflowedCell)
                    }
                };
                _GcBorders.prototype.addCellLines = function(row, col, x, y, width, height, style, spanCellLayout)
                {
                    var self = this;
                    if (!self._isInitialized)
                    {
                        self._initialize()
                    }
                    if (spanCellLayout)
                    {
                        self._spanCells.push(spanCellLayout)
                    }
                    else
                    {
                        var borderLeft,
                            borderTop,
                            borderRight,
                            borderBottom;
                        var backColor;
                        if (style)
                        {
                            borderLeft = style.borderLeft;
                            borderTop = style.borderTop;
                            borderRight = style.borderRight;
                            borderBottom = style.borderBottom;
                            backColor = style.backColor
                        }
                        if (backColor && (!borderLeft && !borderRight && !borderTop && !borderBottom))
                        {
                            self._adjustingRanges.push({
                                r: row, c: col, rc: 1, cc: 1
                            })
                        }
                        self._addCellLineImp(row, col, x, y, width, height, borderLeft, borderTop, borderRight, borderBottom, backColor)
                    }
                };
                _GcBorders.prototype._addCellLineImp = function(row, col, x, y, width, height, borderLeft, borderTop, borderRight, borderBottom, backColor, noHGridLine, noVGridLine)
                {
                    var self = this;
                    var addTopLineSucceeded = false,
                        addLeftLineSucceeded = false,
                        addBottomLineSucceeded = false,
                        addRightLineSucceeded = false;
                    if (borderTop)
                    {
                        addTopLineSucceeded = self._addCellLineSide(row, col, x, y - 0.5, x + width, y - 0.5, borderTop, self._hBorders)
                    }
                    if (borderLeft)
                    {
                        addLeftLineSucceeded = self._addCellLineSide(row, col, x - 0.5, y, x - 0.5, y + height, borderLeft, self._vBorders)
                    }
                    if (borderBottom)
                    {
                        addBottomLineSucceeded = self._addCellLineSide(row + 1, col, x, y + height - 0.5, x + width, y + height - 0.5, borderBottom, self._hBorders)
                    }
                    if (borderRight)
                    {
                        addRightLineSucceeded = self._addCellLineSide(row, col + 1, x + width - 0.5, y, x + width - 0.5, y + height, borderRight, self._vBorders)
                    }
                    var sheet = self._sheet;
                    if (!backColor || sheet._cachePool.getZoomRowHeight(row) === 0 || sheet._cachePool.getZoomColWidth(col) === 0)
                    {
                        var needRenderHGridLine = !addBottomLineSucceeded && !noHGridLine,
                            needRenderVGridLine = !addRightLineSucceeded && !noVGridLine;
                        if (needRenderHGridLine || needRenderVGridLine)
                        {
                            self._addGridLine(row, col, x, y, width, height, needRenderHGridLine, needRenderVGridLine)
                        }
                    }
                    if (addTopLineSucceeded || backColor !== keyword_undefined)
                    {
                        self._removeLineItem(row - 1, col, self._hGridLine)
                    }
                    if (addLeftLineSucceeded || backColor !== keyword_undefined)
                    {
                        self._removeLineItem(row, col - 1, self._vGridLine)
                    }
                    if (backColor && (!borderLeft && !borderRight && !borderTop && !borderBottom))
                    {
                        self._adjustLineItem(row - 1, col - 1, self._vGridLine, false);
                        self._adjustLineItem(row - 1, col - 1, self._hGridLine, true)
                    }
                };
                _GcBorders.prototype._addCellLineSide = function(row, col, x, y, width, height, lineStyle, store)
                {
                    if (lineStyle)
                    {
                        var borderLine = this._queryLineItem(row, col, store, true);
                        if (borderLine)
                        {
                            if (borderLine.style.style !== 6)
                            {
                                if (lineStyle.style === 6 || BorderLayoutEngine.compareLineStyle(lineStyle, borderLine.style) > 0)
                                {
                                    borderLine.line = Line.Create(x, y, width, height, lineStyle.color, lineStyle.style);
                                    borderLine.style = lineStyle
                                }
                            }
                        }
                        else
                        {
                            borderLine = this._queryLineItem(row, col, store);
                            borderLine.line = Line.Create(x, y, width, height, lineStyle.color, lineStyle.style);
                            borderLine.style = lineStyle
                        }
                        return borderLine.line !== keyword_null
                    }
                    return false
                };
                _GcBorders.prototype._addGridLine = function(row, col, x, y, width, height, hLine, vLine)
                {
                    var self = this;
                    var ns = GcSpread.Sheets,
                        atViewport = (self._sheetArea === 3);
                    var gridLine = self._sheet.gridline,
                        Line = ns.Line;
                    if (!atViewport || gridLine)
                    {
                        var gridLineColor = (!atViewport ? "#9eb6ce" : gridLine.color);
                        if (hLine && (gridLine.showHorizontalGridline || !atViewport))
                        {
                            var hGridLineItem = self._queryLineItem(row, col, self._hGridLine);
                            hGridLineItem.isGridLine = true;
                            hGridLineItem.line = Line.Create(x, y + height - 0.5, x + width, y + height - 0.5, gridLineColor)
                        }
                        if (vLine && (gridLine.showVerticalGridline || !atViewport))
                        {
                            var vGridLineItem = self._queryLineItem(row, col, self._vGridLine);
                            vGridLineItem.isGridLine = true;
                            vGridLineItem.line = Line.Create(x + width - 0.5, y, x + width - 0.5, y + height, gridLineColor)
                        }
                    }
                };
                _GcBorders.prototype._adjustLineItem = function(r, c, store, h)
                {
                    var query = this._queryLineItem(r, c, store, true);
                    if (query)
                    {
                        var lineItem = query;
                        if (lineItem && lineItem.line)
                        {
                            lineItem.line.adjust({
                                orientation: (h ? 0 : 1), offsetEnd: -1
                            })
                        }
                    }
                };
                _GcBorders.prototype._removeLineItem = function(r, c, store)
                {
                    if (r >= 0 && c >= 0)
                    {
                        var firstDim = store[r];
                        if (firstDim)
                        {
                            var secondDim = firstDim[c];
                            if (secondDim)
                            {
                                delete firstDim[c]
                            }
                        }
                    }
                };
                _GcBorders.prototype._queryLineItem = function(r, c, store, noCreate)
                {
                    if (r === -1 || c === -1)
                    {
                        return null
                    }
                    var firstDim = store[r];
                    if (!firstDim)
                    {
                        if (noCreate)
                        {
                            return null
                        }
                        store[r] = firstDim = {}
                    }
                    var secondDim = firstDim[c];
                    if (!secondDim)
                    {
                        if (noCreate)
                        {
                            return null
                        }
                        firstDim[c] = secondDim = {}
                    }
                    return secondDim
                };
                _GcBorders.prototype._processOverflowCells = function()
                {
                    var self = this;
                    var overflowedCells = self._overflowedCells,
                        overflowedCellsCount = overflowedCells.length,
                        vBorders = self._vBorders,
                        vGridLine = self._vGridLine;
                    for (var i = 0; i < overflowedCellsCount; i++)
                    {
                        var overflowCell = overflowedCells[i],
                            r = overflowCell.row,
                            sc = overflowCell.startCol,
                            ec = overflowCell.endCol,
                            query;
                        for (var c = sc; c < ec; c++)
                        {
                            query = self._queryLineItem(r, c + 1, vBorders, true);
                            if (query)
                            {
                                self._removeLineItem(r, c + 1, vBorders)
                            }
                            else
                            {
                                query = self._queryLineItem(r, c, vGridLine, true);
                                if (query)
                                {
                                    self._removeLineItem(r, c, vGridLine)
                                }
                            }
                        }
                    }
                };
                _GcBorders.prototype._processSpans = function()
                {
                    var spanCells = this._spanCells,
                        spanCellsCount = spanCells.length,
                        spanLayout;
                    if (spanCellsCount > 0)
                    {
                        for (var i = 0; i < spanCellsCount; i++)
                        {
                            spanLayout = spanCells[i];
                            this._processSpanCell(spanLayout)
                        }
                    }
                };
                _GcBorders.prototype._processSpanCell = function(spanCellLayout)
                {
                    var self = this;
                    var row = spanCellLayout.row,
                        col = spanCellLayout.col;
                    var x = spanCellLayout.x,
                        y = spanCellLayout.y;
                    var borderLeft,
                        borderTop,
                        borderRight,
                        borderBottom;
                    var spanCellStyle = self._sheet.getActualStyle(row, col, self._sheetArea);
                    var backColor = spanCellStyle ? spanCellStyle.backColor : keyword_null;
                    var i,
                        r,
                        c,
                        rowHeight,
                        colWidth,
                        firstCol,
                        firstRow,
                        lastCol,
                        lastRow,
                        cellStyle;
                    var ix = x,
                        iy = y;
                    if (spanCellLayout.rowCount === 1)
                    {
                        r = row;
                        rowHeight = self._sheet._getZoomRowHeight(r, self._sheetArea);
                        for (i = 0; i < spanCellLayout.colCount; i++)
                        {
                            firstCol = (i === 0);
                            lastCol = (i === spanCellLayout.colCount - 1);
                            c = col + i;
                            colWidth = self._sheet._getZoomColumnWidth(c, self._sheetArea);
                            cellStyle = self._sheet.getActualStyle(r, c, self._sheetArea);
                            if (cellStyle)
                            {
                                borderLeft = cellStyle.borderLeft;
                                borderTop = cellStyle.borderTop;
                                borderRight = cellStyle.borderRight;
                                borderBottom = cellStyle.borderBottom
                            }
                            else
                            {
                                borderLeft = borderTop = borderRight = borderBottom = keyword_null
                            }
                            if (firstCol)
                            {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, borderTop, keyword_null, borderBottom, backColor, false, true)
                            }
                            else if (lastCol)
                            {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, borderTop, borderRight, borderBottom, backColor)
                            }
                            else
                            {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, borderTop, keyword_null, borderBottom, backColor, false, true)
                            }
                            ix += colWidth
                        }
                    }
                    else if (spanCellLayout.colCount === 1)
                    {
                        c = col;
                        colWidth = self._sheet._getZoomColumnWidth(c, self._sheetArea);
                        for (i = 0; i < spanCellLayout.rowCount; i++)
                        {
                            firstRow = (i === 0);
                            lastRow = (i === spanCellLayout.rowCount - 1);
                            r = row + i;
                            rowHeight = self._sheet._getZoomRowHeight(r, self._sheetArea);
                            cellStyle = self._sheet.getActualStyle(r, c, self._sheetArea);
                            if (cellStyle)
                            {
                                borderLeft = cellStyle.borderLeft;
                                borderTop = cellStyle.borderTop;
                                borderRight = cellStyle.borderRight;
                                borderBottom = cellStyle.borderBottom
                            }
                            else
                            {
                                borderLeft = borderTop = borderRight = borderBottom = keyword_null
                            }
                            if (firstRow)
                            {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, borderTop, borderRight, keyword_null, backColor, true, false)
                            }
                            else if (lastRow)
                            {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, keyword_null, borderRight, borderBottom, backColor)
                            }
                            else
                            {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, keyword_null, borderRight, keyword_null, backColor, true, false)
                            }
                            iy += rowHeight
                        }
                    }
                    else
                    {
                        for (i = 0; i < spanCellLayout.rowCount; i++)
                        {
                            r = row + i;
                            firstRow = (i === 0);
                            lastRow = (i === spanCellLayout.rowCount - 1);
                            rowHeight = self._sheet._getZoomRowHeight(r, self._sheetArea);
                            for (var j = 0; j < spanCellLayout.colCount; j++)
                            {
                                c = col + j;
                                firstCol = (j === 0);
                                lastCol = (j === spanCellLayout.colCount - 1);
                                colWidth = self._sheet._getZoomColumnWidth(c, self._sheetArea);
                                cellStyle = self._sheet.getActualStyle(r, c, self._sheetArea);
                                if (cellStyle)
                                {
                                    borderLeft = cellStyle.borderLeft;
                                    borderTop = cellStyle.borderTop;
                                    borderRight = cellStyle.borderRight;
                                    borderBottom = cellStyle.borderBottom
                                }
                                else
                                {
                                    borderLeft = borderTop = borderRight = borderBottom = keyword_null
                                }
                                if (firstRow)
                                {
                                    if (firstCol)
                                    {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, borderTop, keyword_null, keyword_null, backColor, true, true)
                                    }
                                    else if (lastCol)
                                    {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, borderTop, borderRight, keyword_null, backColor, true, false)
                                    }
                                    else
                                    {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, borderTop, keyword_null, keyword_null, backColor, true, true)
                                    }
                                }
                                else if (lastRow)
                                {
                                    if (firstCol)
                                    {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, keyword_null, keyword_null, borderBottom, backColor, false, true)
                                    }
                                    else if (lastCol)
                                    {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, keyword_null, borderRight, borderBottom, backColor)
                                    }
                                    else
                                    {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, keyword_null, keyword_null, borderBottom, backColor, false, true)
                                    }
                                }
                                else
                                {
                                    if (firstCol)
                                    {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, keyword_null, keyword_null, keyword_null, backColor, true, true)
                                    }
                                    else if (lastCol)
                                    {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, keyword_null, borderRight, keyword_null, backColor, true, false)
                                    }
                                }
                                ix += colWidth
                            }
                            ix = x;
                            iy += rowHeight
                        }
                    }
                    if (backColor && (!borderLeft && !borderRight && !borderTop && !borderBottom))
                    {
                        self._adjustingRanges.push({
                            r: row, c: col, rc: spanCellLayout.rowCount, cc: spanCellLayout.colCount
                        })
                    }
                };
                _GcBorders.prototype._adjust = function()
                {
                    var self = this;
                    var hasVBorders = false,
                        hasHBorders = false;
                    for (var v in self._vBorders)
                    {
                        hasVBorders = true;
                        break
                    }
                    for (var h in self._hBorders)
                    {
                        hasHBorders = true;
                        break
                    }
                    if (hasVBorders || hasHBorders)
                    {
                        self._adjustBorders()
                    }
                    if (self._adjustingRanges.length > 0)
                    {
                        self._adjustGridlines()
                    }
                };
                _GcBorders.prototype._adjustGridlines = function()
                {
                    var self = this;
                    var adjustingRanges = self._adjustingRanges,
                        adjustingRangesCount = adjustingRanges.length;
                    for (var i = 0; i < adjustingRangesCount; i++)
                    {
                        var range = adjustingRanges[i];
                        var r = range.r,
                            c = range.c;
                        var ar1 = r,
                            ar2 = r - 1;
                        var ac1 = c - 1,
                            ac2 = c;
                        if (range.rc > 1)
                        {
                            ar1 += range.rc - 1
                        }
                        if (range.cc > 1)
                        {
                            ac2 += range.cc - 1
                        }
                        var skipLeftBottom = false,
                            skipRightTop = false;
                        for (var j = 0; j < adjustingRangesCount; j++)
                        {
                            var next = adjustingRanges[j];
                            if (next.c === ac2 + 1 && next.r === r)
                            {
                                skipRightTop = true
                            }
                            if (next.r === ar1 + 1 && next.c === c)
                            {
                                skipLeftBottom = true
                            }
                            if (skipLeftBottom && skipRightTop)
                            {
                                break
                            }
                            if (next.r > r + 1 && next.c > c + 1)
                            {
                                break
                            }
                        }
                        if (!skipLeftBottom)
                        {
                            self._adjustLineItem(ar1, ac1, self._hGridLine, true)
                        }
                        if (!skipRightTop)
                        {
                            self._adjustLineItem(ar2, ac2, self._vGridLine, false)
                        }
                    }
                };
                _GcBorders.prototype._adjustBorders = function()
                {
                    var self = this;
                    var rowIndecies = self._rowIndecies,
                        colIndecies = self._colIndecies,
                        rowIndexCount = rowIndecies.length,
                        colIndexCount = colIndecies.length,
                        r,
                        c,
                        row,
                        col,
                        cacheV = [],
                        cacheH = [];
                    var upV,
                        leftH,
                        currentH,
                        currentV,
                        downV,
                        downLeftH,
                        downH,
                        rightH,
                        upRightV,
                        rightV,
                        borderLineCountV,
                        borderLineCountH;
                    for (r = 0; r < rowIndexCount; r++)
                    {
                        if (r === 0)
                        {
                            cacheV[r] = [];
                            cacheH[r] = []
                        }
                        if (r !== rowIndexCount - 1)
                        {
                            cacheV[r + 1] = [];
                            cacheH[r + 1] = []
                        }
                        row = rowIndecies[r];
                        for (c = 0; c < colIndexCount; c++)
                        {
                            col = colIndecies[c];
                            borderLineCountV = 0;
                            borderLineCountH = 0;
                            var lineV = self._queryLineItem(row, col, self._vBorders, true);
                            if (!lineV)
                            {
                                lineV = self._queryLineItem(row, col - 1, self._vGridLine, true)
                            }
                            else
                            {
                                borderLineCountV++
                            }
                            var lineH = self._queryLineItem(row, col, self._hBorders, true);
                            if (!lineH)
                            {
                                lineH = self._queryLineItem(row - 1, col, self._hGridLine, true)
                            }
                            else
                            {
                                borderLineCountH++
                            }
                            if (!lineV && !lineH)
                            {
                                return
                            }
                            upV = r === 0 ? keyword_null : cacheV[r - 1][c];
                            if (upV && upV.line && !upV.isGridLine)
                            {
                                borderLineCountV++;
                                borderLineCountH++
                            }
                            leftH = c === 0 ? keyword_null : cacheH[r][c - 1];
                            if (leftH && leftH.line && !leftH.isGridLine)
                            {
                                borderLineCountV++;
                                borderLineCountH++
                            }
                            if (lineV)
                            {
                                if (r === 0 && c === 0)
                                {
                                    currentH = self._getLineItemImp(row, col, false);
                                    cacheH[r][c] = currentH
                                }
                                else
                                {
                                    currentH = cacheH[r][c]
                                }
                                if (currentH && currentH.line && !currentH.isGridLine)
                                {
                                    borderLineCountV++
                                }
                                if (r !== rowIndexCount - 1)
                                {
                                    downV = self._getLineItemImp(rowIndecies[r + 1], col, true);
                                    cacheV[r + 1][c] = downV;
                                    if (downV && downV.line && !downV.isGridLine)
                                    {
                                        borderLineCountV++
                                    }
                                }
                                if (c !== 0 && r !== rowIndexCount - 1)
                                {
                                    downLeftH = cacheH[r + 1][c - 1];
                                    if (downLeftH && downLeftH.line && !downLeftH.isGridLine)
                                    {
                                        borderLineCountV++
                                    }
                                }
                                if (r !== rowIndexCount - 1)
                                {
                                    downH = self._getLineItemImp(rowIndecies[r + 1], col, false);
                                    cacheH[r + 1][c] = downH;
                                    if (downH && downH.line && !downH.isGridLine)
                                    {
                                        borderLineCountV++
                                    }
                                }
                                if (borderLineCountV > 0)
                                {
                                    if (BorderLayoutEngine.isDoubleLine(lineV.style))
                                    {
                                        DoubleLineLayout.layoutVertical(lineV, upV, leftH, currentH, downV, downLeftH, downV)
                                    }
                                    else if (BorderLayoutEngine.isSlantedLine(lineV.style))
                                    {
                                        SlantedLineLayout.layoutVertical(lineV, upV, leftH, currentH, downV, downLeftH, downV)
                                    }
                                    else
                                    {
                                        DefaultLineLayout.layoutVertical(lineV, upV, leftH, currentH, downV, downLeftH, downV)
                                    }
                                }
                            }
                            if (lineH)
                            {
                                if (r === 0 && c === 0)
                                {
                                    currentV = self._getLineItemImp(row, col, true);
                                    cacheV[r][c] = currentV
                                }
                                else
                                {
                                    currentV = cacheV[r][c]
                                }
                                if (currentV && currentV.line && !currentV.isGridLine)
                                {
                                    borderLineCountH++
                                }
                                if (c !== colIndexCount - 1)
                                {
                                    rightH = self._getLineItemImp(row, colIndecies[c + 1], false);
                                    cacheH[r][c + 1] = rightH;
                                    if (rightH && rightH.line && !rightH.isGridLine)
                                    {
                                        borderLineCountH++
                                    }
                                }
                                if (r !== 0 && c != colIndexCount - 1)
                                {
                                    upRightV = cacheV[r - 1][c + 1];
                                    if (upRightV && upRightV.line && !upRightV.isGridLine)
                                    {
                                        borderLineCountH++
                                    }
                                }
                                if (c != colIndexCount - 1)
                                {
                                    rightV = self._getLineItemImp(row, colIndecies[c + 1], true);
                                    cacheV[r][c + 1] = rightV;
                                    if (rightV && rightV.line && !rightV.isGridLine)
                                    {
                                        borderLineCountH++
                                    }
                                }
                                if (borderLineCountH > 0)
                                {
                                    if (BorderLayoutEngine.isDoubleLine(lineH.style))
                                    {
                                        DoubleLineLayout.layoutHorizontal(lineH, leftH, upV, currentV, rightH, upRightV, rightV)
                                    }
                                    else if (BorderLayoutEngine.isSlantedLine(lineH.style))
                                    {
                                        SlantedLineLayout.layoutHorizontal(lineH, leftH, upV, currentV, rightH, upRightV, rightV)
                                    }
                                    else
                                    {
                                        DefaultLineLayout.layoutHorizontal(lineH, leftH, upV, currentV, rightH, upRightV, rightV)
                                    }
                                }
                            }
                        }
                    }
                };
                _GcBorders.prototype._prevCol = function(c)
                {
                    if (c < 0)
                    {
                        return -1
                    }
                    return this._colIndecies[c - 1]
                };
                _GcBorders.prototype._nextCol = function(c)
                {
                    return this._colIndecies[c + 1]
                };
                _GcBorders.prototype._prevRow = function(r)
                {
                    if (r < 0)
                    {
                        return -1
                    }
                    return this._rowIndecies[r - 1]
                };
                _GcBorders.prototype._nextRow = function(r)
                {
                    return this._rowIndecies[r + 1]
                };
                _GcBorders.prototype._getLineItemImp = function(r, c, vertical)
                {
                    if (r === keyword_undefined || r < 0 || c === keyword_undefined || c < 0)
                    {
                        return keyword_null
                    }
                    var self = this;
                    var store = vertical ? self._vBorders : self._hBorders,
                        query = self._queryLineItem(r, c, store, true);
                    if (query)
                    {
                        return query
                    }
                    store = vertical ? self._vGridLine : self._hGridLine;
                    if (vertical)
                    {
                        if (--c < 0)
                        {
                            return keyword_null
                        }
                    }
                    else
                    {
                        if (--r < 0)
                        {
                            return keyword_null
                        }
                    }
                    query = self._queryLineItem(r, c, store, true);
                    if (query)
                    {
                        return query
                    }
                    return keyword_null
                };
                _GcBorders.prototype.paint = function(context, clipRect)
                {
                    var self = this;
                    if (!self._isInitialized)
                    {
                        return
                    }
                    if (!self._isMerged)
                    {
                        self._processSpans();
                        self._processOverflowCells();
                        self._adjust();
                        self._isMerged = true
                    }
                    context.save();
                    context.beginPath();
                    self._paint(context, clipRect);
                    context.closePath();
                    context.stroke();
                    context.restore()
                };
                _GcBorders.prototype._paint = function(context, clipRect)
                {
                    this._paintGridLine(context);
                    this._paintBorderLines(context)
                };
                _GcBorders.prototype._paintGridLine = function(context)
                {
                    var self = this;
                    self._paintLines(context, self._hGridLine);
                    self._paintLines(context, self._vGridLine)
                };
                _GcBorders.prototype._paintBorderLines = function(context)
                {
                    var self = this;
                    self._paintLines(context, self._hBorders);
                    self._paintLines(context, self._vBorders)
                };
                _GcBorders.prototype._paintLines = function(context, store)
                {
                    if (!store)
                    {
                        return
                    }
                    var firstDim,
                        secondDim,
                        line;
                    for (var i in store)
                    {
                        firstDim = store[i];
                        if (firstDim)
                        {
                            for (var j in firstDim)
                            {
                                secondDim = firstDim[j];
                                line = (secondDim && secondDim.line);
                                if (line)
                                {
                                    line.paint(context)
                                }
                            }
                        }
                    }
                };
                return _GcBorders
            })();
        Sheets._GcBorders = _GcBorders
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.sheet_render", ["core.common", "core.sheet_border", "core.sheet_action", "core.sheet_model", "core.imageLoader"]);
        var keyword_null = null,
            Math_min = Math.min,
            Math_max = Math.max,
            Math_abs = Math.abs,
            Math_PI = Math.PI,
            const_undefined = "undefined";
        var document = window.document;
        var _SheetRender = (function()
            {
                function _SheetRender(sheet)
                {
                    this.ctx = keyword_null;
                    this.buffer = keyword_null;
                    this.bufferCtx = keyword_null;
                    this._rowGroups = keyword_null;
                    this._columnGroups = keyword_null;
                    this._floatingObjectRenderManager = keyword_null;
                    this._existTouchDragFillIndicator = false;
                    this._showTouchSelectionIndicator = true;
                    this._init(sheet)
                }
                _SheetRender.prototype._init = function(sheet)
                {
                    this._sheet = sheet
                };
                _SheetRender.prototype._getCtx = function()
                {
                    var self = this;
                    self.ctx = keyword_null;
                    var sheet = self._sheet;
                    var c = sheet._getCanvas();
                    if (c)
                    {
                        if (!c.getContext && Sheets.util._isSilverlightCanvas())
                        {
                            if (!c.getContext)
                            {
                                return
                            }
                        }
                        if (c.getContext)
                        {
                            self.ctx = c.getContext('2d')
                        }
                    }
                    if (self.ctx)
                    {
                        self.ctx.name = "userContext"
                    }
                    return self.ctx
                };
                _SheetRender.prototype._getBufferCtx = function()
                {
                    var self = this;
                    var sheet = self._sheet;
                    var rect = sheet._bounds;
                    var width = sheet._canvas.width;
                    var height = sheet._canvas.height;
                    var buffer = self.buffer;
                    if (!buffer || buffer.width !== width || buffer.height !== height)
                    {
                        if (buffer)
                        {
                            Sheets.DPIHelper.disposeCanvasForSheet(sheet, buffer)
                        }
                        self.buffer = buffer = document.createElement("canvas");
                        if (buffer.getContext)
                        {
                            self.bufferCtx = buffer.getContext('2d');
                            Sheets.DPIHelper.adjustDevicePixel(self.buffer, null, self._sheet, self.bufferCtx);
                            Sheets.DPIHelper.setSize(buffer, rect.width, rect.height)
                        }
                        else
                        {
                            buffer.width = rect.width;
                            buffer.height = rect.height;
                            if (Sheets.util._isSilverlightCanvas())
                            {
                                if (!buffer.getContext)
                                {
                                    return
                                }
                                else
                                {
                                    self.bufferCtx = buffer.getContext('2d')
                                }
                            }
                        }
                    }
                    if (self.bufferCtx)
                    {
                        self.bufferCtx.beginPath();
                        self.bufferCtx.font = self._getZoomFont(self._getDefaultFont());
                        self.bufferCtx.name = "bufferContext"
                    }
                    return self.bufferCtx
                };
                _SheetRender.prototype._getDefaultFont = function(sheetArea)
                {
                    if (sheetArea === 3 || typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        return "10pt Arial"
                    }
                    else
                    {
                        return "11pt " + this._sheet.currentTheme().bodyFont()
                    }
                };
                _SheetRender.prototype._getDefaultBackground = function()
                {
                    return "white"
                };
                _SheetRender.prototype._getSpreadBackColor = function()
                {
                    var sheet = this._sheet;
                    var currentSpread = sheet.parent;
                    var bkColorString = currentSpread ? currentSpread._backColor : this._getDefaultBackground();
                    var bkColor = Sheets._ThemeContext.getColor(sheet, bkColorString);
                    var bkImg = currentSpread ? currentSpread._backgroundImage : keyword_null;
                    if (bkImg && bkImg !== "")
                    {
                        bkColor = "transparent"
                    }
                    return bkColor
                };
                _SheetRender.prototype._getGrayAreaBackColor = function(isDrawImage)
                {
                    var sheet = this._sheet;
                    var currentSpread = sheet.parent;
                    var bkColorString = currentSpread ? currentSpread._grayAreaBackColor : "gray";
                    var bkColor = this._getThemeContentBackgroundColor(Sheets._ThemeContext.getColor(sheet, bkColorString));
                    if (!isDrawImage)
                    {
                        return bkColor
                    }
                    var bkImg = currentSpread ? currentSpread._backgroundImage : keyword_null;
                    if (bkImg && bkImg !== "")
                    {
                        bkColor = "transparent"
                    }
                    return bkColor
                };
                _SheetRender.prototype._getZoomFont = function(font)
                {
                    var sheet = this._sheet,
                        zoomFactor = sheet._zoomFactor;
                    if (zoomFactor === 1)
                    {
                        return font
                    }
                    return Sheets.StyleHelper._scaleFont(font, zoomFactor).font
                };
                _SheetRender.prototype.copyDoubleBuffer = function(srcX, srcY, srcW, srcH, clipRect)
                {
                    if (srcW <= 0 || srcH <= 0)
                    {
                        return
                    }
                    var buffer = this.buffer,
                        ctx = this._getCtx();
                    if (!buffer || !ctx)
                    {
                        return
                    }
                    if (!clipRect)
                    {
                        clipRect = this._sheet._bounds
                    }
                    var ratioX = Sheets.DPIHelper.getScaleX(buffer),
                        ratioY = Sheets.DPIHelper.getScaleY(buffer),
                        targX,
                        targY,
                        targW,
                        targH;
                    if (ratioX !== 1)
                    {
                        srcX *= ratioX;
                        srcY *= ratioY;
                        srcW *= ratioX;
                        srcH *= ratioY;
                        clipRect = new Sheets.Rect(clipRect.x * ratioX, clipRect.y * ratioY, clipRect.width * ratioX, clipRect.height * ratioY)
                    }
                    var intersectRect = clipRect.getIntersect(srcX, srcY, srcW, srcH);
                    if (!intersectRect)
                    {
                        return
                    }
                    intersectRect.round();
                    srcX = intersectRect.x;
                    srcY = intersectRect.y;
                    srcW = intersectRect.width;
                    srcH = intersectRect.height;
                    var maxWidth = buffer.width;
                    if (maxWidth && (srcX + srcW > maxWidth))
                    {
                        srcX = maxWidth - srcW;
                        if (srcX < 0)
                        {
                            srcW += srcX;
                            srcX = 0
                        }
                    }
                    var maxHeight = buffer.height;
                    if (maxHeight && (srcY + srcH > maxHeight))
                    {
                        srcY = maxHeight - srcH;
                        if (srcY < 0)
                        {
                            srcH += srcY;
                            srcY = 0
                        }
                    }
                    if ($.browser.qtMode)
                    {
                        if (srcX > 0)
                        {
                            srcW--
                        }
                        if (srcY > 0)
                        {
                            srcH--
                        }
                    }
                    if (ratioX === 1)
                    {
                        targX = srcX;
                        targY = srcY;
                        targW = srcW;
                        targH = srcH
                    }
                    else
                    {
                        targX = srcX / ratioX;
                        targY = srcY / ratioY;
                        targW = srcW / ratioX;
                        targH = srcH / ratioY
                    }
                    ctx.scale(1 / ratioX, 1 / ratioY);
                    ctx.clearRect(srcX, srcY, srcW, srcH);
                    ctx.drawImage(buffer, srcX, srcY, srcW, srcH, srcX, srcY, srcW, srcH);
                    ctx.scale(ratioX, ratioY)
                };
                _SheetRender.prototype.copyDoubleBufferRect = function(rect, clipRect)
                {
                    if (rect)
                    {
                        this.copyDoubleBuffer(rect.x, rect.y, rect.width, rect.height, clipRect)
                    }
                };
                _SheetRender.prototype.copyScreen = function(srcX, srcY, srcW, srcH, destX, destY)
                {
                    try
                    {
                        var self = this;
                        var sheet = self._sheet,
                            ctx = self._getCtx(),
                            canvas = sheet._getCanvas(),
                            bufferCtx = self._getBufferCtx(),
                            buffer = self.buffer,
                            destW = srcW,
                            destH = srcH,
                            destXE = destX,
                            destYE = destY,
                            destWE = destW,
                            destHE = destH;
                        var ratioX = Sheets.DPIHelper.getScaleX(canvas),
                            ratioY = Sheets.DPIHelper.getScaleY(canvas);
                        srcX = Math.floor(srcX * ratioX);
                        srcY = Math.floor(srcY * ratioY);
                        srcW = Math.ceil(srcW * ratioX);
                        srcH = Math.ceil(srcH * ratioY);
                        destXE = Math.floor(destXE * ratioX);
                        destYE = Math.floor(destYE * ratioY);
                        destWE = Math.ceil(destWE * ratioX);
                        destHE = Math.ceil(destHE * ratioY);
                        var maxWidth = buffer.width;
                        var maxHeight = buffer.height;
                        if (maxWidth && (srcX + srcW > maxWidth))
                        {
                            srcX = maxWidth - srcW;
                            if (srcX < 0)
                            {
                                srcW += srcX;
                                srcX = 0
                            }
                        }
                        if (maxHeight && (srcY + srcH > maxHeight))
                        {
                            srcY = maxHeight - srcH;
                            if (srcY < 0)
                            {
                                srcH += srcY;
                                srcY = 0
                            }
                        }
                        if (maxWidth && (destXE + destWE > maxWidth))
                        {
                            destXE = maxWidth - destWE;
                            if (destXE < 0)
                            {
                                destWE += destXE;
                                destXE = 0
                            }
                        }
                        if (maxHeight && (destYE + destHE > maxHeight))
                        {
                            destYE = maxHeight - destHE;
                            if (destYE < 0)
                            {
                                destHE += destYE;
                                destYE = 0
                            }
                        }
                        ctx.scale(1 / ratioX, 1 / ratioY);
                        bufferCtx.scale(1 / ratioX, 1 / ratioY);
                        ctx.clearRect(destXE, destYE, destWE, destHE);
                        ctx.drawImage(buffer, srcX, srcY, srcW, srcH, destXE, destYE, destWE, destHE);
                        bufferCtx.clearRect(destXE, destYE, destWE, destHE);
                        bufferCtx.drawImage(canvas, destXE, destYE, destWE, destHE, destXE, destYE, destWE, destHE);
                        ctx.scale(ratioX, ratioY);
                        bufferCtx.scale(ratioX, ratioY)
                    }
                    catch(e) {}
                };
                _SheetRender.prototype.repaintSelection = function(range, clipRect, ctx, onlyPaintAdorner)
                {
                    var self = this;
                    if (!ctx)
                    {
                        ctx = self._getCtx()
                    }
                    var ret = false,
                        sheet = self._sheet,
                        newRange = new Sheets.Range(-1, -1, -1, -1),
                        isNavigateInSelection = sheet._isNavigateInSelection;
                    if (range)
                    {
                        if (sheet._allowCellOverflow)
                        {
                            newRange = new Sheets.Range(range.row, 0, range.rowCount, sheet.getColumnCount())
                        }
                        else
                        {
                            newRange = new Sheets.Range(range.row, range.col, range.rowCount, range.colCount)
                        }
                        if (!isNavigateInSelection)
                        {
                            if (newRange.col >= 0)
                            {
                                var startCol = newRange.col,
                                    endCol = newRange.col + newRange.colCount - 1,
                                    rCount = sheet.getRowCount(1);
                                var spanModel = sheet._getSpanModel(1);
                                for (var r = 0; r < rCount; r++)
                                {
                                    var cr = spanModel.find(r, newRange.col);
                                    if (cr)
                                    {
                                        startCol = Math_min(cr.col, startCol)
                                    }
                                    var cr = spanModel.find(r, newRange.col + newRange.colCount - 1);
                                    if (cr)
                                    {
                                        endCol = Math_max(cr.col + cr.colCount - 1, endCol)
                                    }
                                }
                                newRange.col = startCol;
                                newRange.colCount = endCol - startCol + 1
                            }
                            if (newRange.row >= 0)
                            {
                                var startRow = newRange.row,
                                    endRow = newRange.row + newRange.rowCount - 1,
                                    cCount = sheet.getColumnCount(2);
                                var spanModel = sheet._getSpanModel(2);
                                for (var c = 0; c < cCount; c++)
                                {
                                    var cr = spanModel.find(newRange.row, c);
                                    if (cr)
                                    {
                                        startRow = Math_min(cr.row, startRow)
                                    }
                                    var cr = spanModel.find(newRange.row + newRange.rowCount - 1, c);
                                    if (cr)
                                    {
                                        endRow = Math_max(cr.row + cr.rowCount - 1, endRow)
                                    }
                                }
                                newRange.row = startRow;
                                newRange.rowCount = endRow - startRow + 1
                            }
                        }
                    }
                    var rect = sheet._getRangeRect2(newRange);
                    if (rect.width >= 0 && rect.height >= 0)
                    {
                        rect.x -= 9;
                        rect.y -= 9;
                        rect.width += 18;
                        rect.height += 30;
                        if (clipRect)
                        {
                            rect = rect.getIntersectRect(clipRect);
                            if (!rect)
                            {
                                return
                            }
                        }
                        self.paint(ctx, rect);
                        var layout = sheet._getSheetLayout();
                        if (rect.height > 0 && !isNavigateInSelection)
                        {
                            sheet._dirty = true;
                            self.paint(ctx, new Sheets.Rect(layout.x, Math_max(layout.frozenY, rect.y), layout.rowHeaderWidth, rect.height), onlyPaintAdorner)
                        }
                        if (rect.width > 0 && !isNavigateInSelection)
                        {
                            sheet._dirty = true;
                            self.paint(ctx, new Sheets.Rect(Math_max(layout.frozenX, rect.x), layout.y, rect.width, layout.colHeaderHeight), onlyPaintAdorner)
                        }
                        if (newRange.row === -1 && newRange.col === -1 && !isNavigateInSelection)
                        {
                            sheet._dirty = true;
                            self.paint(ctx, layout.headerCornerRect(), onlyPaintAdorner)
                        }
                        ret = true
                    }
                    return ret
                };
                _SheetRender.prototype.update = function(x, y, width, height, ignoreDirtyFlag)
                {
                    var sheet = this._sheet;
                    if (sheet._layoutSuspended > 0)
                    {
                        return
                    }
                    var ctx = this._getCtx();
                    if (ctx)
                    {
                        if (!ignoreDirtyFlag)
                        {
                            sheet._dirty = true
                        }
                        this.paint(ctx, new Sheets.Rect(x, y, width, height))
                    }
                };
                _SheetRender.prototype.repaint = function(clipRect)
                {
                    var sheet = this._sheet;
                    if (sheet._layoutSuspended > 0)
                    {
                        return
                    }
                    var ctx = this._getCtx();
                    if (ctx)
                    {
                        sheet._dirty = true;
                        this.paint(ctx, clipRect)
                    }
                };
                _SheetRender.prototype.paint = function(ctx, clipRect, onlyPaintAdorner)
                {
                    var sheet = this._sheet,
                        self = this;
                    if (!ctx || sheet._layoutSuspended > 0)
                    {
                        return
                    }
                    if (!onlyPaintAdorner)
                    {
                        this.paintBody(ctx, clipRect)
                    }
                    this.paintAdornment(ctx, clipRect)
                };
                _SheetRender.prototype.paintBody = function(ctx, clipRect, clipRect2)
                {
                    var self = this;
                    var sheet = self._sheet;
                    if (!ctx || sheet._layoutSuspended > 0)
                    {
                        return
                    }
                    var useDoubleBuffer = Sheets.util._useDoubleBuffer();
                    var bufferCtx = useDoubleBuffer ? self._getBufferCtx() : null;
                    var paintContext = bufferCtx ? bufferCtx : ctx;
                    var rect = sheet._bounds;
                    if (!clipRect)
                    {
                        clipRect = rect
                    }
                    if (clipRect)
                    {
                        clipRect.round()
                    }
                    if (clipRect2)
                    {
                        clipRect2.round()
                    }
                    if (sheet._dirty)
                    {
                        sheet._dirty = false;
                        if (bufferCtx)
                        {
                            bufferCtx.clearRect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                            if (clipRect2)
                            {
                                bufferCtx.clearRect(clipRect2.x, clipRect2.y, clipRect2.width, clipRect2.height)
                            }
                            bufferCtx.translate(-rect.x, -rect.y)
                        }
                        self.paintSheet(paintContext, clipRect);
                        if (clipRect2)
                        {
                            self.paintSheet(paintContext, clipRect2)
                        }
                        if (bufferCtx)
                        {
                            bufferCtx.translate(rect.x, rect.y)
                        }
                    }
                    if (bufferCtx)
                    {
                        self.copyDoubleBufferRect(clipRect);
                        if (clipRect2)
                        {
                            self.copyDoubleBufferRect(clipRect2)
                        }
                    }
                };
                _SheetRender.prototype.paintAdornment = function(ctx, clipRect)
                {
                    var self = this,
                        sheet = self._sheet,
                        isTouchMode = sheet._isTouchMode;
                    if (!ctx || sheet._paintSuspended || sheet._layoutSuspended > 0)
                    {
                        return
                    }
                    if (clipRect)
                    {
                        clipRect.round()
                    }
                    var layout = sheet._getSheetLayout(),
                        rect,
                        actualClipRect,
                        r,
                        c;
                    if (!sheet._hoverCell)
                    {
                        if (isTouchMode)
                        {
                            rect = layout.headerCornerRect();
                            self.copyDoubleBufferRect(rect);
                            for (r = 0; r <= 2; r++)
                            {
                                rect = layout.rowHeaderRect(r);
                                if (!rect || rect.width === 0 || rect.height === 0)
                                {
                                    continue
                                }
                                self.copyDoubleBufferRect(rect)
                            }
                            for (c = 0; c <= 2; c++)
                            {
                                rect = layout.colHeaderRect(c);
                                if (!rect || rect.width === 0 || rect.height === 0)
                                {
                                    continue
                                }
                                self.copyDoubleBufferRect(rect)
                            }
                        }
                        for (r = 0; r <= 2; r++)
                        {
                            for (c = 0; c <= 2; c++)
                            {
                                rect = layout.viewportRect(r, c);
                                if (!rect || rect.width === 0 || rect.height === 0)
                                {
                                    continue
                                }
                                actualClipRect = clipRect;
                                if (isTouchMode && (r !== 1 || c !== 1))
                                {
                                    self.copyDoubleBufferRect(rect);
                                    actualClipRect = rect
                                }
                                if (!actualClipRect || rect.intersectRect(actualClipRect))
                                {
                                    self.paintSelection(ctx, r, c, actualClipRect)
                                }
                            }
                        }
                        self.paintResizeLine(ctx);
                        var fbx = sheet._formulaTextBox;
                        if (fbx)
                        {
                            for (r = 0; r <= 2; r++)
                            {
                                for (c = 0; c <= 2; c++)
                                {
                                    rect = layout.viewportRect(r, c);
                                    if (!rect || rect.width === 0 || rect.height === 0)
                                    {
                                        continue
                                    }
                                    self.paintFormulaTextBoxRange(ctx, r, c, clipRect)
                                }
                            }
                        }
                    }
                    if (isTouchMode)
                    {
                        self.paintTouchResizeIndicator(ctx);
                        if (self._existTouchDragFillIndicator)
                        {
                            self.paintTouchDragFillIndicator(ctx)
                        }
                        else
                        {
                            self.paintTouchSelectionIndicator(ctx)
                        }
                    }
                    this.pri(ctx, clipRect, layout)
                };
                _SheetRender.prototype.pri = function(ctx, clipRect, layout){};
                _SheetRender.prototype.paintTouchResizeIndicator = function(ctx)
                {
                    var sheet = this._sheet,
                        rowCount = sheet.getRowCount(),
                        colCount = sheet.getColumnCount();
                    var layout = sheet._getSheetLayout();
                    var image,
                        imageSize = 16;
                    var headerCellRect,
                        resizeIndicatorRect,
                        headerRect;
                    var selections = sheet.getSelections();
                    if (sheet._isTouchMode && selections.length > 0)
                    {
                        var selection = selections[selections.length - 1];
                        var row = selection.row,
                            lastRow = selection.row + selection.rowCount - 1,
                            col = selection.col,
                            lastCol = selection.col + selection.colCount - 1;
                        if (!sheet.parent || sheet.parent._allowUserResize)
                        {
                            if (row !== -1 && col === -1 && sheet.getRowResizable(lastRow))
                            {
                                var rowViewportIndex;
                                if (lastRow < sheet.frozenRowCount)
                                {
                                    rowViewportIndex = 0
                                }
                                else if (lastRow < rowCount - sheet._frozenTrailingRowCount)
                                {
                                    rowViewportIndex = 1
                                }
                                else if (lastRow < rowCount)
                                {
                                    rowViewportIndex = 2
                                }
                                image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABaSURBVDhPY/z//z8DLsDIyAiWBKphBAtgAUxQGgPANIMAMhsdYDUAmwZchtDOC8SCgTcA5DfcgUAEoNwFo7GAPQxwJVtsYYHVBdgU4gpInF5A1oBLMwMDAwMApuAtD6Z7YxQAAAAASUVORK5CYII=";
                                headerCellRect = sheet.getCellRect(lastRow, sheet.getColumnCount(2) - 1, rowViewportIndex, -1);
                                headerRect = layout.rowHeaderRect(rowViewportIndex);
                                if (headerRect.y <= headerCellRect.y && headerCellRect.y + headerCellRect.height <= headerRect.y + headerRect.height)
                                {
                                    resizeIndicatorRect = new Sheets.Rect(layout.frozenX - imageSize, headerCellRect.y + headerCellRect.height - imageSize / 2, imageSize, imageSize)
                                }
                            }
                            else if (row === -1 && col !== -1 && sheet.getColumnResizable(lastCol))
                            {
                                var colViewportIndex;
                                if (lastCol < sheet.frozenColCount)
                                {
                                    colViewportIndex = 0
                                }
                                else if (lastCol < colCount - sheet._frozenTrailingColCount)
                                {
                                    colViewportIndex = 1
                                }
                                else if (lastCol < colCount)
                                {
                                    colViewportIndex = 2
                                }
                                image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAAJcEhZcwAADsIAAA7CARUoSoAAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjEwMPRyoQAAAE1JREFUOE/ljtEKACAIA/v/nzZ9mFhsJPRocLEuGS4zk/iJyyP/D6gE0wrYoCqoLoUafPl8fEBln3ulSscfErk65TMjMFRBhUowosDWBoHpba8+C7w0AAAAAElFTkSuQmCC";
                                headerCellRect = sheet.getCellRect(sheet.getRowCount(1) - 1, lastCol, -1, colViewportIndex);
                                headerRect = layout.colHeaderRect(colViewportIndex);
                                if (headerRect.x <= headerCellRect.x && headerCellRect.x + headerCellRect.width <= headerRect.x + headerRect.width)
                                {
                                    resizeIndicatorRect = new Sheets.Rect(headerCellRect.x + headerCellRect.width - imageSize / 2, layout.frozenY - imageSize, imageSize, imageSize)
                                }
                            }
                            if (image && resizeIndicatorRect)
                            {
                                var imageLoader = sheet._getImageLoader();
                                if (imageLoader.getState(image))
                                {
                                    ctx.drawImage(imageLoader.getImage(image), resizeIndicatorRect.x, resizeIndicatorRect.y, resizeIndicatorRect.width, resizeIndicatorRect.height)
                                }
                                else
                                {
                                    imageLoader.addImage(image)
                                }
                            }
                        }
                    }
                };
                _SheetRender.prototype._getFloatingObjectRender = function(rowViewportIndex, columnViewportIndex)
                {
                    var self = this;
                    if (Sheets.features.floatingObject)
                    {
                        if (!self._floatingObjectRenderManager)
                        {
                            self._floatingObjectRenderManager = []
                        }
                        var rowFloatingObjectRenderManager = self._floatingObjectRenderManager[rowViewportIndex];
                        if (!rowFloatingObjectRenderManager)
                        {
                            self._floatingObjectRenderManager[rowViewportIndex] = []
                        }
                        var result = self._floatingObjectRenderManager[rowViewportIndex][columnViewportIndex];
                        if (!result)
                        {
                            self._floatingObjectRenderManager[rowViewportIndex][columnViewportIndex] = new Sheets._FloatingObjectRenderManager(self._sheet)
                        }
                        result = self._floatingObjectRenderManager[rowViewportIndex][columnViewportIndex];
                        return result
                    }
                    return keyword_null
                };
                _SheetRender.prototype._getFloatingObjectRenderCount = function()
                {
                    var self = this,
                        fORenderManager = self._floatingObjectRenderManager,
                        count = 0;
                    if (!fORenderManager || fORenderManager.length === 0)
                    {
                        return 0
                    }
                    for (var r = 0; r <= 2; r++)
                    {
                        var rowFORenderManager = fORenderManager[r];
                        if (rowFORenderManager && rowFORenderManager.length > 0)
                        {
                            for (var c = 0; c <= 2; c++)
                            {
                                var colFORenderManager = rowFORenderManager[c];
                                if (colFORenderManager)
                                {
                                    count += colFORenderManager.getFloatingObjectRenderCount()
                                }
                            }
                        }
                    }
                    return count
                };
                _SheetRender.prototype._paintFloatingObject = function(clipRect, zoomFactor)
                {
                    var sheet = this._sheet;
                    if (!sheet._hoverCell && Sheets.features.floatingObject && sheet._floatingObjectArray && (sheet._floatingObjectArray.length > 0 || this._getFloatingObjectRenderCount() > 0))
                    {
                        var layout = sheet._getSheetLayout(),
                            rect;
                        if (zoomFactor === keyword_null || typeof(zoomFactor) === const_undefined)
                        {
                            zoomFactor = sheet._zoomFactor
                        }
                        for (var r = 0; r <= 2; r++)
                        {
                            for (var c = 0; c <= 2; c++)
                            {
                                rect = layout.viewportRect(r, c);
                                if (!rect || rect.width === 0 || rect.height === 0)
                                {
                                    continue
                                }
                                if (!clipRect || rect.intersectRect(clipRect))
                                {
                                    var floatingObjectRender = this._getFloatingObjectRender(r, c);
                                    if (floatingObjectRender && !sheet._eventHandler.isFloatingObjectWorking)
                                    {
                                        floatingObjectRender._render(r, c, zoomFactor)
                                    }
                                }
                            }
                        }
                    }
                };
                _SheetRender.prototype.paintSheet = function(ctx, clipRect)
                {
                    var self = this;
                    var sheet = self._sheet;
                    if (!ctx || sheet._layoutSuspended > 0)
                    {
                        return
                    }
                    Sheets._CacheMgr.startCache(sheet, 0, 0, sheet.getRowCount() - 1, sheet.getColumnCount() - 1);
                    var rect = sheet._bounds;
                    ctx.save();
                    if (!clipRect)
                    {
                        ctx.rect(rect.x, rect.y, rect.width, rect.height)
                    }
                    else
                    {
                        ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height)
                    }
                    ctx.clip();
                    ctx.beginPath();
                    ctx.fillStyle = self._getSpreadBackColor();
                    ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
                    var layout = sheet._getSheetLayout();
                    if (Sheets.features.group)
                    {
                        self.paintGroup(ctx, clipRect)
                    }
                    if (Sheets.features.floatingObject)
                    {
                        self._paintFloatingObject(clipRect)
                    }
                    var r,
                        c;
                    for (c = 0; c <= 2; c++)
                    {
                        var colHeaderRect = layout.colHeaderRect(c);
                        if (colHeaderRect)
                        {
                            if (!clipRect)
                            {
                                self.paintColHeader(ctx, c, colHeaderRect)
                            }
                            else
                            {
                                var intersectRect = colHeaderRect.getIntersectRect(clipRect);
                                if (intersectRect)
                                {
                                    self.paintColHeader(ctx, c, intersectRect)
                                }
                            }
                        }
                    }
                    for (r = 0; r <= 2; r++)
                    {
                        var rowHeaderRect = layout.rowHeaderRect(r);
                        if (rowHeaderRect)
                        {
                            if (!clipRect)
                            {
                                self.paintRowHeader(ctx, r, rowHeaderRect)
                            }
                            else
                            {
                                var intersectRect = rowHeaderRect.getIntersectRect(clipRect);
                                if (intersectRect)
                                {
                                    self.paintRowHeader(ctx, r, intersectRect)
                                }
                            }
                        }
                        for (c = 0; c <= 2; c++)
                        {
                            var viewportRect = layout.viewportRect(r, c);
                            if (viewportRect)
                            {
                                if (!clipRect)
                                {
                                    self.paintViewport(ctx, r, c, viewportRect)
                                }
                                else
                                {
                                    var intersectRect = viewportRect.getIntersectRect(clipRect);
                                    if (intersectRect)
                                    {
                                        self.paintViewport(ctx, r, c, intersectRect)
                                    }
                                }
                            }
                        }
                    }
                    if (Sheets.features.comment && sheet._commentManager.hasComment())
                    {
                        self._paintComment(clipRect)
                    }
                    var headerCornerRect = layout.headerCornerRect();
                    if (headerCornerRect)
                    {
                        if (!clipRect)
                        {
                            self.paintColHeaderCorner(ctx, headerCornerRect)
                        }
                        else
                        {
                            var intersectRect = headerCornerRect.getIntersectRect(clipRect);
                            if (intersectRect)
                            {
                                self.paintColHeaderCorner(ctx, intersectRect)
                            }
                        }
                    }
                    var rowLayoutModel = sheet._getRowLayout(1);
                    if (rowLayoutModel.length > 0)
                    {
                        var rowLayout = rowLayoutModel[rowLayoutModel.length - 1];
                        if (rowLayout.y + rowLayout.height < layout.frozenTrailingY)
                        {
                            ctx.fillStyle = self._getGrayAreaBackColor(false);
                            ctx.fillRect(layout.headerX, rowLayout.y + rowLayout.height, layout.width, layout.frozenTrailingY - (rowLayout.y + rowLayout.height))
                        }
                    }
                    else if (rowLayoutModel.length === 0)
                    {
                        ctx.fillStyle = self._getGrayAreaBackColor(false);
                        ctx.fillRect(layout.headerX, layout.viewportY, layout.width, layout.frozenTrailingY - layout.viewportY)
                    }
                    var colLayoutModel = sheet._getColumnLayout(1);
                    if (colLayoutModel.length > 0)
                    {
                        var colLayout = colLayoutModel[colLayoutModel.length - 1];
                        if (colLayout.x + colLayout.width < layout.frozenTrailingX)
                        {
                            ctx.fillStyle = self._getGrayAreaBackColor(false);
                            ctx.fillRect(colLayout.x + colLayout.width, layout.headerY, layout.frozenTrailingX - (colLayout.x + colLayout.width), layout.height)
                        }
                    }
                    else if (colLayoutModel.length === 0)
                    {
                        ctx.fillStyle = self._getGrayAreaBackColor(false);
                        ctx.fillRect(layout.viewportX, layout.headerY, layout.frozenTrailingX - layout.viewportX, layout.height)
                    }
                    self.paintFrozenLine(ctx);
                    if (sheet.borderWidth > 0)
                    {
                        ctx.strokeStyle = sheet.borderColor;
                        ctx.lineWidth = sheet.borderWidth;
                        ctx.strokeRect(rect.x + ctx.lineWidth / 2, rect.y + ctx.lineWidth / 2, Math_max(0, rect.width - ctx.lineWidth), Math_max(0, rect.height - ctx.lineWidth))
                    }
                    Sheets._CacheMgr.clearCache();
                    ctx.beginPath();
                    ctx.restore()
                };
                _SheetRender.prototype._getThemeContentBackgroundColor = function(defaultColor)
                {
                    var sheet = this._sheet;
                    if (!defaultColor)
                    {
                        var t = Sheets.Global.prototype.getDummyContent();
                        var themeStyle = t.currentStyle;
                        if (document.defaultView && document.defaultView.getComputedStyle)
                        {
                            themeStyle = document.defaultView.getComputedStyle(t, '')
                        }
                        if (themeStyle && themeStyle.backgroundColor && themeStyle.backgroundColor !== "")
                        {
                            defaultColor = themeStyle.backgroundColor
                        }
                    }
                    return defaultColor
                };
                _SheetRender.prototype.refreshDragDropIndicator = function()
                {
                    var self = this;
                    var sheet = self._sheet;
                    var target = sheet._currentTarget;
                    if (!target || !target.dragInfo)
                    {
                        return
                    }
                    var ctx = self._getCtx();
                    var layout = sheet._getSheetLayout();
                    var dragRange = sheet._actualDragRange;
                    var dragRect = sheet._dragRect;
                    var rect = sheet._getRangeRect2(dragRange);
                    var frozenTrailingColCount = sheet._frozenTrailingColCount,
                        frozenTrailingRowCount = sheet._frozenTrailingRowCount;
                    var endCol = sheet.getColumnCount() - frozenTrailingColCount,
                        endRow = sheet.getRowCount() - frozenTrailingRowCount;
                    var vpRect = layout.viewportRect(1, 1);
                    if (frozenTrailingColCount > 0 && dragRange.col + dragRange.colCount <= endCol && rect.x + rect.width > vpRect.x + vpRect.width && rect.intersectRect(vpRect))
                    {
                        rect = rect.getIntersectRect(vpRect)
                    }
                    if (frozenTrailingRowCount > 0 && dragRange.row + dragRange.rowCount <= endRow && rect.y + rect.height > vpRect.y + vpRect.height && rect.intersectRect(vpRect))
                    {
                        rect = rect.getIntersectRect(vpRect)
                    }
                    var viewportRect = new Sheets.Rect(layout.frozenX, layout.frozenY, layout.frozenTrailingX + layout.frozenTrailingWidth, layout.frozenTrailingY + layout.frozenTrailingHeight);
                    if (rect.width > 0 && rect.height > 0)
                    {
                        dragRect.x = rect.x;
                        dragRect.y = rect.y;
                        dragRect.width = rect.width - 1;
                        dragRect.height = rect.height - 1;
                        self.paintDragDropIndicator(ctx, viewportRect)
                    }
                    else if (rect.width === 0 || rect.height === 0)
                    {
                        dragRect.x = rect.x;
                        dragRect.y = rect.y;
                        dragRect.width = rect.width;
                        dragRect.height = rect.height;
                        self.paintDragDropIndicator(ctx, viewportRect)
                    }
                    var isDragInsert = sheet._eventHandler._isDragInsert;
                    if (isDragInsert === true)
                    {
                        sheet._dragOldRect = sheet._insertDragRect
                    }
                    else
                    {
                        sheet._dragOldRect = new Sheets.Rect(dragRect.x, dragRect.y, dragRect.width, dragRect.height)
                    }
                };
                _SheetRender.prototype.paintDragDropIndicator = function(ctx, viewportClipRect)
                {
                    var self = this;
                    var sheet = self._sheet;
                    var dragRect = sheet._dragRect;
                    var isDragInsert = sheet._eventHandler._isDragInsert;
                    var hi = dragRect.hitTarget;
                    var oldRect,
                        clipRect;
                    if (!sheet || !dragRect || !hi)
                    {
                        return
                    }
                    ctx.save();
                    if (isDragInsert === true && (dragRect.row === -1 || dragRect.col === -1))
                    {
                        if (dragRect.row === -1 && dragRect.col !== -1)
                        {
                            var cl = sheet._getColumnLayout(0).findCol(dragRect.hitCol);
                            if (!cl)
                            {
                                cl = sheet._getColumnLayout(1).findCol(dragRect.hitCol)
                            }
                            if (!cl)
                            {
                                cl = sheet._getColumnLayout(2).findCol(dragRect.hitCol)
                            }
                            if (cl)
                            {
                                var x = cl.x;
                                var width = cl.width;
                                dragRect.col = dragRect.hitCol;
                                if (hi.x > (x + width / 2) && (dragRect.col < sheet._getLastFullyVisibleColumn() || dragRect.col === sheet._getLastVisualColumn()))
                                {
                                    x = cl.x + cl.width;
                                    dragRect.col++
                                }
                                oldRect = sheet._dragOldRect;
                                if (!oldRect || oldRect.width !== 0)
                                {
                                    oldRect = sheet._dragRect
                                }
                                if (oldRect)
                                {
                                    clipRect = new Sheets.Rect(oldRect.x - 2, oldRect.y - 2, oldRect.width + 4, oldRect.height + 4);
                                    self.copyDoubleBufferRect(clipRect, viewportClipRect);
                                    self.repaintSelection(sheet._getActiveSelectedRange(), viewportClipRect)
                                }
                                sheet._insertDragRect = new Sheets.Rect(x, dragRect.y, 0, dragRect.height);
                                ctx.rect(viewportClipRect.x, viewportClipRect.y, viewportClipRect.width, viewportClipRect.height);
                                ctx.clip();
                                ctx.beginPath();
                                self.paintDragLine(ctx, x, dragRect.y, x, dragRect.y + dragRect.height)
                            }
                        }
                        else if (dragRect.row !== -1 && dragRect.col === -1)
                        {
                            var rl = sheet._getRowLayout(0).findRow(dragRect.hitRow);
                            if (!rl)
                            {
                                rl = sheet._getRowLayout(1).findRow(dragRect.hitRow)
                            }
                            if (!rl)
                            {
                                rl = sheet._getRowLayout(2).findRow(dragRect.hitRow)
                            }
                            if (rl)
                            {
                                var y = rl.y;
                                var height = rl.height;
                                dragRect.row = dragRect.hitRow;
                                if (hi.y > (y + height / 2) && (dragRect.row < sheet._getLastFullyVisibleRow() || dragRect.row === sheet._getLastVisualRow()))
                                {
                                    y = rl.y + rl.height;
                                    dragRect.row++
                                }
                                oldRect = sheet._dragOldRect;
                                if (!oldRect || oldRect.height !== 0)
                                {
                                    oldRect = sheet._dragRect
                                }
                                if (oldRect)
                                {
                                    clipRect = new Sheets.Rect(oldRect.x - 2, oldRect.y - 2, oldRect.width + 4, oldRect.height + 4);
                                    self.copyDoubleBufferRect(clipRect, viewportClipRect);
                                    self.repaintSelection(sheet._getActiveSelectedRange(), viewportClipRect)
                                }
                                sheet._insertDragRect = new Sheets.Rect(dragRect.x, y, dragRect.width, 0);
                                ctx.rect(viewportClipRect.x, viewportClipRect.y, viewportClipRect.width, viewportClipRect.height);
                                ctx.clip();
                                ctx.beginPath();
                                self.paintDragLine(ctx, dragRect.x, y, dragRect.x + dragRect.width, y)
                            }
                        }
                    }
                    else
                    {
                        {
                            oldRect = sheet._dragOldRect;
                            if (oldRect)
                            {
                                clipRect = new Sheets.Rect(oldRect.x - 2, oldRect.y - 2, oldRect.width + 4, oldRect.height + 4);
                                self.copyDoubleBufferRect(clipRect, viewportClipRect);
                                self.repaintSelection(sheet._getActiveSelectedRange(), viewportClipRect)
                            }
                            ctx.rect(viewportClipRect.x, viewportClipRect.y, viewportClipRect.width, viewportClipRect.height);
                            ctx.clip();
                            ctx.beginPath();
                            self.paintDragRectangle(ctx, dragRect)
                        }
                    }
                    ctx.beginPath();
                    ctx.restore()
                };
                _SheetRender.prototype.paintDragRectangle = function(ctx, rect)
                {
                    var self = this;
                    self.paintDragLine(ctx, rect.x, rect.y, rect.x + rect.width, rect.y);
                    self.paintDragLine(ctx, rect.x, rect.y + rect.height, rect.x + rect.width, rect.y + rect.height);
                    self.paintDragLine(ctx, rect.x, rect.y, rect.x, rect.y + rect.height);
                    self.paintDragLine(ctx, rect.x + rect.width, rect.y, rect.x + rect.width, rect.y + rect.height);
                    self.pri(ctx, keyword_null, keyword_null)
                };
                _SheetRender.prototype.paintDragLine = function(ctx, fromX, fromY, toX, toY)
                {
                    ctx.save();
                    var line1,
                        line2,
                        line3;
                    if (fromX === toX)
                    {
                        ctx.rect(fromX - 2, fromY, 7, Math_abs(toY - fromY));
                        ctx.clip();
                        ctx.beginPath();
                        if (fromY < toY)
                        {
                            fromY -= 3;
                            toY += 3
                        }
                        else
                        {
                            fromY += 3;
                            toY -= 3
                        }
                        line1 = Sheets.Line.Create(fromX - 1, fromY - 1, toX - 1, toY + 1, "black", 7);
                        line2 = Sheets.Line.Create(fromX, fromY, toX, toY, "black", 7);
                        line3 = Sheets.Line.Create(fromX + 1, fromY - 1, toX + 1, toY + 1, "black", 7)
                    }
                    else if (fromY === toY)
                    {
                        ctx.rect(fromX, fromY - 2, Math_abs(toX - fromX), 7);
                        ctx.clip();
                        ctx.beginPath();
                        if (fromX < toX)
                        {
                            fromX -= 3;
                            toX += 3
                        }
                        else
                        {
                            fromX += 3;
                            toX -= 3
                        }
                        line1 = Sheets.Line.Create(fromX - 1, fromY - 1, toX + 1, toY - 1, "black", 7);
                        line2 = Sheets.Line.Create(fromX, fromY, toX, toY, "black", 7);
                        line3 = Sheets.Line.Create(fromX - 1, fromY + 1, toX + 1, toY + 1, "black", 7)
                    }
                    line1.paintLine(ctx);
                    line2.paintLine(ctx);
                    line3.paintLine(ctx);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.restore()
                };
                _SheetRender.prototype.paintResizeLine = function(ctx)
                {
                    var x,
                        y,
                        movingX,
                        movingY,
                        endX,
                        endY;
                    var sheet = this._sheet;
                    if (!sheet._eventHandler.isResizing)
                    {
                        return
                    }
                    var currentTarget = sheet._currentTarget;
                    if (!currentTarget)
                    {
                        return
                    }
                    var resizeInfo = currentTarget.resizeInfo;
                    if (resizeInfo)
                    {
                        var sheetLayout = sheet._getSheetLayout(),
                            lineColor = "#000000";
                        ctx.save();
                        if (ctx.strokeStyle !== lineColor)
                        {
                            ctx.strokeStyle = lineColor
                        }
                        if (ctx.lineWidth !== 1)
                        {
                            ctx.lineWidth = 1
                        }
                        ctx.beginPath();
                        if (resizeInfo.action === "sizeRow")
                        {
                            y = Math_max(0, resizeInfo.startY - 0.5);
                            movingY = resizeInfo.movingY - 0.5;
                            endX = sheetLayout.x + sheetLayout.width;
                            for (x = sheetLayout.x; x < endX; x += 2)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x + 1, y);
                                ctx.moveTo(x, movingY);
                                ctx.lineTo(x + 1, movingY)
                            }
                        }
                        else
                        {
                            x = Math_max(0, resizeInfo.startX - 0.5);
                            movingX = resizeInfo.movingX - 0.5;
                            endY = sheetLayout.y + sheetLayout.height;
                            for (y = sheetLayout.y; y < endY; y += 2)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y + 1);
                                ctx.moveTo(movingX, y);
                                ctx.lineTo(movingX, y + 1)
                            }
                        }
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.restore()
                    }
                };
                _SheetRender.prototype.paintColHeaderCorner = function(ctx, clipRect)
                {
                    var sheet = this._sheet;
                    ctx.beginPath();
                    var rect = sheet._getSheetLayout().headerCornerRect();
                    var style = sheet.getActualStyle(-1, -1, 0);
                    this.paintCells(ctx, [{
                            data: keyword_null, row: -1, col: -1, x: rect.x, y: rect.y, width: rect.width, height: rect.height, style: style
                        }], 0);
                    var border = new Sheets._GcBorders(sheet, 0, 0, 0);
                    border.addCellLines(0, 0, rect.x, rect.y, rect.width, rect.height);
                    border.paint(ctx, clipRect)
                };
                _SheetRender.prototype.paintFrozenLine = function(ctx)
                {
                    var sheet = this._sheet;
                    if (sheet.frozenRowCount || sheet.frozenColCount || sheet._frozenTrailingRowCount || sheet._frozenTrailingColCount)
                    {
                        var sheetLayout = sheet._getSheetLayout();
                        ctx.save();
                        ctx.strokeStyle = Sheets._ThemeContext.getColor(sheet, sheet._frozenlineColor);
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        if (sheet.frozenColCount)
                        {
                            ctx.moveTo(sheetLayout.viewportX - 0.5, sheetLayout.y);
                            ctx.lineTo(sheetLayout.viewportX - 0.5, sheetLayout.y + sheetLayout.height)
                        }
                        if (sheet.frozenRowCount)
                        {
                            ctx.moveTo(sheetLayout.x, sheetLayout.viewportY - 0.5);
                            ctx.lineTo(sheetLayout.x + sheetLayout.width, sheetLayout.viewportY - 0.5)
                        }
                        if (sheet._frozenTrailingColCount)
                        {
                            ctx.moveTo(sheetLayout.frozenTrailingX - 0.5, sheetLayout.y);
                            ctx.lineTo(sheetLayout.frozenTrailingX - 0.5, sheetLayout.y + sheetLayout.height)
                        }
                        if (sheet._frozenTrailingRowCount)
                        {
                            ctx.moveTo(sheetLayout.x, sheetLayout.frozenTrailingY - 0.5);
                            ctx.lineTo(sheetLayout.x + sheetLayout.width, sheetLayout.frozenTrailingY - 0.5)
                        }
                        ctx.stroke();
                        ctx.restore()
                    }
                };
                _SheetRender.prototype.paintColHeader = function(ctx, c, clipRect)
                {
                    this.paintViewportImp(ctx, -1, c, 1, clipRect)
                };
                _SheetRender.prototype.paintRowHeader = function(ctx, r, clipRect)
                {
                    this.paintViewportImp(ctx, r, -1, 2, clipRect)
                };
                _SheetRender.prototype.paintViewport = function(ctx, rowViewportIndex, colViewportIndex, clipRect)
                {
                    this.paintViewportImp(ctx, rowViewportIndex, colViewportIndex, 3, clipRect);
                    var cutCopyIndicatorManager = this._sheet._cutCopyIndicatorManager;
                    if (cutCopyIndicatorManager)
                    {
                        cutCopyIndicatorManager.paintCutCopyIndicator(ctx, clipRect, rowViewportIndex, colViewportIndex)
                    }
                };
                _SheetRender.prototype.getTouchDragFillIndicatorRect = function()
                {
                    var sheet = this._sheet;
                    var rect = keyword_null;
                    var selections = sheet.getSelections();
                    var length = selections.length;
                    if (sheet._isTouchMode && length > 0)
                    {
                        var sel = selections[length - 1];
                        var selectRect = sheet._getRangeRect2(sel);
                        var dragFillIndicatorWidth = 17;
                        var dragFillIndicatorHeight = 20;
                        rect = new Sheets.Rect(selectRect.x + selectRect.width - dragFillIndicatorWidth, selectRect.y + selectRect.height, dragFillIndicatorWidth, dragFillIndicatorHeight)
                    }
                    return rect
                };
                _SheetRender.prototype.getCurrentViewportRange = function(row, col)
                {
                    var sheet = this._sheet,
                        rowCount = sheet.getRowCount(),
                        colCount = sheet.getColumnCount();
                    var rowViewportIndex = 1;
                    if (0 <= row && row < sheet.frozenRowCount)
                    {
                        rowViewportIndex = 0
                    }
                    else if (rowCount > row && row >= rowCount - sheet._frozenTrailingRowCount)
                    {
                        rowViewportIndex = 2
                    }
                    var colViewportIndex = 1;
                    if (0 <= col && col < sheet.frozenColCount)
                    {
                        colViewportIndex = 0
                    }
                    else if (colCount > col && col >= colCount - sheet._frozenTrailingColCount)
                    {
                        colViewportIndex = 2
                    }
                    var viewportRowLayoutModel = sheet._getViewportRowLayout(rowViewportIndex),
                        viewportColumnLayoutModel = sheet._getViewportColumnLayout(colViewportIndex),
                        topRow = 0,
                        bottomRow = 0,
                        leftCol = 0,
                        rightCol = 0;
                    if (viewportRowLayoutModel.length > 0)
                    {
                        topRow = viewportRowLayoutModel[0].row;
                        bottomRow = viewportRowLayoutModel[viewportRowLayoutModel.length - 1].row
                    }
                    if (viewportColumnLayoutModel.length > 0)
                    {
                        leftCol = viewportColumnLayoutModel[0].col;
                        rightCol = viewportColumnLayoutModel[viewportColumnLayoutModel.length - 1].col
                    }
                    return new Sheets.Range(topRow, leftCol, bottomRow - topRow + 1, rightCol - leftCol + 1)
                };
                _SheetRender.prototype.isContainedByCurrentViewport = function(row, col)
                {
                    var sheet = this._sheet,
                        rowCount = sheet.getRowCount(),
                        colCount = sheet.getColumnCount();
                    var rowViewportIndex = 1;
                    if (0 <= row && row < sheet.frozenRowCount)
                    {
                        rowViewportIndex = 0
                    }
                    else if (rowCount > row && row >= rowCount - sheet._frozenTrailingRowCount)
                    {
                        rowViewportIndex = 2
                    }
                    var colViewportIndex = 1;
                    if (0 <= col && col < sheet.frozenColCount)
                    {
                        colViewportIndex = 0
                    }
                    else if (colCount > col && col >= colCount - sheet._frozenTrailingColCount)
                    {
                        colViewportIndex = 2
                    }
                    var sheetLayout = sheet._getSheetLayout();
                    var viewportRect = sheetLayout.viewportRect(rowViewportIndex, colViewportIndex);
                    var colContained = false;
                    var viewportColumnLayoutModel = sheet._getViewportColumnLayout(colViewportIndex);
                    var columnLayout = col === -1 ? viewportColumnLayoutModel[0] : viewportColumnLayoutModel.findCol(col);
                    if (columnLayout)
                    {
                        colContained = viewportRect.x <= columnLayout.x && columnLayout.x + columnLayout.width <= viewportRect.x + viewportRect.width
                    }
                    var rowContained = false;
                    var viewportRowLayoutModel = sheet._getViewportRowLayout(rowViewportIndex);
                    var rowLayout = row === -1 ? viewportRowLayoutModel[0] : viewportRowLayoutModel.findRow(row);
                    if (rowLayout)
                    {
                        rowContained = viewportRect.y <= rowLayout.y && rowLayout.y + rowLayout.height <= viewportRect.y + viewportRect.height
                    }
                    return colContained && rowContained
                };
                _SheetRender.prototype.getSelectionIndicatorRects = function()
                {
                    var self = this;
                    var sheet = self._sheet;
                    var selections = sheet.getSelections();
                    var rects = [];
                    if (sheet._isTouchMode && selections.length > 0)
                    {
                        var selection = selections[selections.length - 1];
                        var selectRect = sheet._getRangeRect2(selection);
                        var radius = 8;
                        var sheetLayout = sheet._getSheetLayout(),
                            selectionFirstRow = selection.row,
                            selectionLastRow = selection.row + selection.rowCount - 1,
                            selectionFirstCol = selection.col,
                            selectionLastCol = selection.col + selection.colCount - 1,
                            topLeftViewportRange = self.getCurrentViewportRange(selectionFirstRow, selectionFirstCol),
                            bottomRightViewportRange = self.getCurrentViewportRange(selectionLastRow, selectionLastCol),
                            topRow = topLeftViewportRange.row,
                            bottomRow = bottomRightViewportRange.row + bottomRightViewportRange.rowCount - 1,
                            leftCol = topLeftViewportRange.col,
                            rightCol = bottomRightViewportRange.col + bottomRightViewportRange.colCount - 1,
                            frozenRect,
                            viewportRect,
                            equalBottomRow = selectionLastRow === bottomRow && self.isContainedByCurrentViewport(bottomRow, -1),
                            equalRightCol = selectionLastCol === rightCol && self.isContainedByCurrentViewport(-1, rightCol);
                        if (selection.row !== -1 && selection.col !== -1)
                        {
                            if (leftCol <= selectionFirstCol && selectionFirstCol <= rightCol && topRow <= selectionFirstRow && selectionFirstRow <= bottomRow)
                            {
                                rects[0] = new Sheets.Rect(selectRect.x - radius, selectRect.y - radius, radius * 2, radius * 2)
                            }
                            if (((leftCol <= selectionLastCol && selectionLastCol < rightCol) || equalRightCol) && ((topRow <= selectionLastRow && selectionLastRow < bottomRow) || equalBottomRow))
                            {
                                rects[1] = new Sheets.Rect(selectRect.x + selectRect.width - radius, selectRect.y + selectRect.height - radius, radius * 2, radius * 2)
                            }
                        }
                        else if (selection.row !== -1)
                        {
                            frozenRect = sheetLayout.viewportRect(1, 0);
                            viewportRect = sheetLayout.viewportRect(1, 1);
                            var startX = frozenRect.x + (frozenRect.width + viewportRect.width) / 2 - radius;
                            var viewportLastColumn = sheet.getColumnCount() - 1 - sheet.getFrozenTrailingColumnCount();
                            var viewportColumnLayoutModel = sheet._getViewportColumnLayout(1);
                            var columnLayout = viewportColumnLayoutModel.findCol(viewportLastColumn);
                            if (columnLayout)
                            {
                                var frozenColumnLayoutModel = sheet._getViewportColumnLayout(0);
                                var leftColLayout = frozenColumnLayoutModel[0] || viewportColumnLayoutModel[0];
                                if (leftColLayout)
                                {
                                    startX = leftColLayout.x + (columnLayout.x + columnLayout.width - leftColLayout.x) / 2 - radius
                                }
                            }
                            if (topRow <= selectionFirstRow && selectionFirstRow <= bottomRow)
                            {
                                rects[0] = new Sheets.Rect(startX, selectRect.y - radius, radius * 2, radius * 2)
                            }
                            if ((topRow <= selectionLastRow && selectionLastRow < bottomRow) || equalBottomRow)
                            {
                                rects[1] = new Sheets.Rect(startX, selectRect.y + selectRect.height - radius, radius * 2, radius * 2)
                            }
                        }
                        else if (selection.col !== -1)
                        {
                            frozenRect = sheetLayout.viewportRect(0, 1);
                            viewportRect = sheetLayout.viewportRect(1, 1);
                            var startY = frozenRect.y + (frozenRect.height + viewportRect.height) / 2 - radius;
                            var viewportLastRow = sheet.getRowCount() - 1 - sheet.getFrozenTrailingRowCount();
                            var viewportRowLayoutModel = sheet._getViewportRowLayout(1);
                            var rowLayout = viewportRowLayoutModel.findRow(viewportLastRow);
                            if (rowLayout)
                            {
                                var frozenRowLayoutModel = sheet._getViewportRowLayout(0);
                                var topRowLayout = frozenRowLayoutModel[0] || viewportRowLayoutModel[0];
                                if (topRowLayout)
                                {
                                    startY = topRowLayout.y + (rowLayout.y + rowLayout.height - topRowLayout.y) / 2 - radius
                                }
                            }
                            if (leftCol <= selectionFirstCol && selectionFirstCol <= rightCol)
                            {
                                rects[0] = new Sheets.Rect(selectRect.x - radius, startY, radius * 2, radius * 2)
                            }
                            if ((leftCol <= selectionLastCol && selectionLastCol < rightCol) || equalRightCol)
                            {
                                rects[1] = new Sheets.Rect(selectRect.x + selectRect.width - radius, startY, radius * 2, radius * 2)
                            }
                        }
                        var rec;
                        for (var i = rects.length - 1; i >= 0; i--)
                        {
                            rec = rects[i];
                            if (!rec || rec.x < 0 || rec.y < 0)
                            {
                                rects.splice(i, 1)
                            }
                        }
                    }
                    return rects
                };
                _SheetRender.prototype.paintTouchSelectionIndicator = function(ctx)
                {
                    var sheet = this._sheet;
                    if (Sheets.FocusHelper.isActiveElement(sheet) || (sheet.parent && !sheet.parent.hideSelection()))
                    {
                        if (sheet.isEditing() || !this._showTouchSelectionIndicator)
                        {
                            return
                        }
                        var selectionIndicatorRects = this.getSelectionIndicatorRects(),
                            len = selectionIndicatorRects.length,
                            rect;
                        if (len > 0)
                        {
                            ctx.save();
                            ctx.fillStyle = "white";
                            ctx.strokeStyle = "black";
                            for (var i = 0; i < len; i++)
                            {
                                rect = selectionIndicatorRects[i];
                                ctx.beginPath();
                                ctx.arc(rect.x + rect.width / 2, rect.y + rect.height / 2, rect.width / 2, 0, Math_PI * 2, false);
                                ctx.fill();
                                ctx.stroke()
                            }
                            ctx.restore()
                        }
                    }
                };
                _SheetRender.prototype.refreshTouchSelectionIndicator = function()
                {
                    var sheet = this._sheet;
                    var selections = sheet.getSelections();
                    if (!sheet._paintSuspended && selections.length > 0)
                    {
                        this.repaintSelection(selections[selections.length - 1], undefined, undefined, true)
                    }
                };
                _SheetRender.prototype.paintTouchDragFillIndicator = function(ctx)
                {
                    var sheet = this._sheet;
                    var dragFillIndicatorWidth = 17;
                    var dragFillIndicatorHeight = 20;
                    var dragFillIndicatorRect = this.getTouchDragFillIndicatorRect();
                    if (dragFillIndicatorRect)
                    {
                        var imgSrc = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAATCAIAAAD5x3GmAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwwAADsMBx2 + oZAAAAGhJREFUOE / djkEOwCAIBHk6P98u1lKo1diEU + dggOyAAkC + YPl / Onx3WDmiytm4aulQoKba + 4uiO77YhHDH5SqnRa0If / Nhq0fnjPob2h5oVXJI0rJA3h1ya1kgU4f4nQfVzozk7APgAIEqATZbalz1AAAAAElFTkSuQmCC";
                        var imageLoader = sheet._getImageLoader();
                        if (imageLoader.getState(imgSrc))
                        {
                            ctx.drawImage(imageLoader.getImage(imgSrc), dragFillIndicatorRect.x, dragFillIndicatorRect.y, dragFillIndicatorWidth, dragFillIndicatorHeight)
                        }
                        else
                        {
                            imageLoader.addImage(imgSrc)
                        }
                    }
                };
                _SheetRender.prototype.paintSelection = function(ctx, rowViewportIndex, colViewportIndex, clipRect)
                {
                    var self = this,
                        sheet = self._sheet;
                    if (Sheets.FocusHelper.isActiveElement(sheet) || (sheet.parent && !sheet.parent.hideSelection()))
                    {
                        var eventHandler = sheet._eventHandler,
                            selections = sheet._selectionModel,
                            selectionCount = selections.length;
                        clipRect = self._getClipRect(rowViewportIndex, colViewportIndex, clipRect);
                        if (!clipRect)
                        {
                            return
                        }
                        var selectionRects = self._getPaintingRects(rowViewportIndex, colViewportIndex, selections, clipRect),
                            selectionRectCount = selectionRects.length,
                            selectionRect;
                        if (selectionRectCount <= 0)
                        {
                            return
                        }
                        var needClip = false,
                            clipped = false;
                        for (var i = 0; i < selectionRectCount; i++)
                        {
                            selectionRect = selectionRects[i];
                            if (!clipRect.containsRect(selectionRect))
                            {
                                needClip = true;
                                break
                            }
                        }
                        ctx.save();
                        if (needClip)
                        {
                            ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                            ctx.clip();
                            clipped = true
                        }
                        ctx.beginPath();
                        if (selectionRectCount > 0)
                        {
                            var selectionBackColor = Sheets._ThemeContext.getColor(sheet, sheet.selectionBackColor());
                            if (ctx.fillStyle !== selectionBackColor)
                            {
                                ctx.fillStyle = selectionBackColor
                            }
                            for (var i = 0; i < selectionRects.length; i++)
                            {
                                selectionRect = selectionRects[i];
                                ctx.fillRect(selectionRect.x, selectionRect.y, selectionRect.width, selectionRect.height)
                            }
                        }
                        var rect = sheet.getCellRect(sheet._activeRowIndex, sheet._activeColIndex, rowViewportIndex, colViewportIndex);
                        if (rect && rect.intersectRect(clipRect))
                        {
                            self.copyDoubleBuffer(rect.x + 1, rect.y + 1, rect.width - 2, rect.height - 2);
                            if (selectionCount > 1)
                            {
                                ctx.strokeStyle = "black";
                                ctx.lineWidth = 1;
                                ctx.strokeRect(rect.x + 1.5, rect.y + 1.5, rect.width - 4, rect.height - 4)
                            }
                        }
                        if (selectionCount === 1)
                        {
                            if (eventHandler.isDraggingFill && eventHandler.isDragClear() && !eventHandler._isDragAroundIndicator)
                            {
                                var fillRange = eventHandler.getCurrentFillRange();
                                var fillRect = sheet._getRangeRect(rowViewportIndex, colViewportIndex, fillRange);
                                if (fillRect && fillRect.width > 0 && fillRect.height > 0)
                                {
                                    ctx.fillStyle = "rgba(110,110,110, 0.5)";
                                    ctx.fillRect(fillRect.x, fillRect.y, fillRect.width, fillRect.height)
                                }
                            }
                            if (selectionRect && selectionRect.width >= 0 && selectionRect.height >= 0)
                            {
                                self.paintSelectionBorder(ctx, rowViewportIndex, colViewportIndex, selectionRect, clipRect)
                            }
                        }
                        ctx.beginPath();
                        ctx.restore()
                    }
                };
                _SheetRender.prototype.paintSelectionBorder = function(ctx, rowViewportIndex, colViewportIndex, selectRect, clipRect)
                {
                    var sheet = this._sheet,
                        eventHandler = sheet._eventHandler;
                    if (selectRect.width >= 0 && selectRect.height >= 0 && (!clipRect || selectRect.intersect(clipRect.x - 1, clipRect.y - 1, clipRect.width + 2, clipRect.height + 2)))
                    {
                        ctx.save();
                        if (clipRect && !clipRect.containsRect(selectRect))
                        {
                            ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                            ctx.clip()
                        }
                        ctx.beginPath();
                        ctx.strokeStyle = Sheets._ThemeContext.getColor(sheet, sheet.selectionBorderColor());
                        ctx.lineWidth = 2;
                        if (selectRect.width > 0 && selectRect.height > 0)
                        {
                            if (eventHandler.isDraggingFill)
                            {
                                switch (eventHandler._currentFillDirection)
                                {
                                    case 2:
                                        ctx.moveTo(selectRect.x + 0.5, selectRect.y - 0.5);
                                        ctx.lineTo(selectRect.x + selectRect.width - 1, selectRect.y - 0.5);
                                        break;
                                    case 3:
                                        ctx.moveTo(selectRect.x + 0.5, selectRect.y + selectRect.height - 0.5);
                                        ctx.lineTo(selectRect.x + selectRect.width - 1, selectRect.y + selectRect.height - 0.5);
                                        break;
                                    case 0:
                                        ctx.moveTo(selectRect.x - 0.5, selectRect.y + 0.5);
                                        ctx.lineTo(selectRect.x - 0.5, selectRect.y + selectRect.height - 1);
                                        break;
                                    case 1:
                                        ctx.moveTo(selectRect.x + selectRect.width - 0.5, selectRect.y + 0.5);
                                        ctx.lineTo(selectRect.x + selectRect.width - 0.5, selectRect.y + selectRect.height - 1);
                                        break;
                                    case 5:
                                    case 4:
                                        break;
                                    default:
                                        break
                                }
                            }
                            else
                            {
                                ctx.rect(selectRect.x - 0.5, selectRect.y - 0.5, selectRect.width, selectRect.height)
                            }
                            ctx.stroke();
                            if (sheet.canUserDragFill())
                            {
                                this.paintDragFillIndicator(ctx, rowViewportIndex, colViewportIndex, selectRect, clipRect)
                            }
                        }
                        else if (selectRect.width === 0 || selectRect.height === 0)
                        {
                            ctx.strokeRect(selectRect.x - 1, selectRect.y - 1, selectRect.width + 1, selectRect.height + 1)
                        }
                        ctx.beginPath();
                        ctx.restore()
                    }
                };
                _SheetRender.prototype._getClipRect = function(rowViewportIndex, colViewportIndex, clipRect)
                {
                    var sheet = this._sheet,
                        layout = sheet._getSheetLayout(),
                        paintRect = layout.viewportRect(rowViewportIndex, colViewportIndex);
                    if (colViewportIndex === 1)
                    {
                        var colLayouts = sheet._getColumnLayout(colViewportIndex),
                            lastColLayout = (colLayouts.length > 0 ? colLayouts[colLayouts.length - 1] : keyword_null);
                        if (lastColLayout)
                        {
                            paintRect.width = Math_min(paintRect.width, lastColLayout.x + lastColLayout.width - layout.viewportX)
                        }
                    }
                    if (rowViewportIndex === 1)
                    {
                        var rowLayouts = sheet._getRowLayout(rowViewportIndex),
                            lastRowLayout = (rowLayouts.length > 0 ? rowLayouts[rowLayouts.length - 1] : keyword_null);
                        if (lastRowLayout)
                        {
                            paintRect.height = Math_min(paintRect.height, lastRowLayout.y + lastRowLayout.height - layout.viewportY)
                        }
                    }
                    if (clipRect)
                    {
                        clipRect = clipRect.getIntersect(paintRect.x, paintRect.y, paintRect.width, paintRect.height)
                    }
                    else
                    {
                        clipRect = paintRect
                    }
                    return clipRect
                };
                _SheetRender.prototype._getPaintingRects = function(rowViewportIndex, colViewportIndex, ranges, clipRect)
                {
                    var sheet = this._sheet,
                        spans = sheet._getSpanModel(),
                        span,
                        count = ranges.length,
                        cr,
                        rects = [],
                        rect;
                    for (var i = 0; i < count; i++)
                    {
                        cr = ranges[i];
                        if (cr)
                        {
                            span = spans.find(cr.row, cr.col);
                            if (span && span.containsRange(cr))
                            {
                                cr = span
                            }
                            rect = sheet._getRangeRect(rowViewportIndex, colViewportIndex, cr);
                            if (rect && rect.x <= clipRect.x + clipRect.width && rect.y <= clipRect.y + clipRect.height && clipRect.x <= rect.x + rect.width && clipRect.y <= rect.y + rect.height)
                            {
                                rects.push(rect)
                            }
                        }
                    }
                    return rects
                };
                _SheetRender.prototype.paintFormulaTextBox = function()
                {
                    var self = this;
                    var sheet = self._sheet;
                    if (sheet._paintSuspended || sheet._layoutSuspended > 0)
                    {
                        return
                    }
                    var layout = sheet._getSheetLayout(),
                        ctx = self._getCtx();
                    self.copyDoubleBuffer(layout.x, layout.y, layout.width, layout.height);
                    self.paintAdornment(ctx)
                };
                _SheetRender.prototype.paintFormulaTextBoxRange = function(ctx, rowViewportIndex, colViewportIndex, viewRect)
                {
                    var self = this;
                    var sheet = self._sheet,
                        eventHandler = sheet._eventHandler,
                        fbx = sheet._formulaTextBox,
                        paramRanges = (fbx && fbx.getRanges()),
                        rangeCount = (paramRanges && paramRanges.length),
                        sheetName = sheet.getName();
                    if (rangeCount <= 0)
                    {
                        return
                    }
                    var clipRect = self._getClipRect(rowViewportIndex, colViewportIndex, viewRect);
                    if (!clipRect)
                    {
                        return
                    }
                    ctx.save();
                    ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                    ctx.clip();
                    ctx.beginPath();
                    var paintRects = [];
                    var isHoving = eventHandler.isFormulaRangeHoving,
                        hovingInfo = eventHandler._formulRangeHovingInfo,
                        isMoving = eventHandler.isFormulaRangeMoving,
                        movingInfo = eventHandler._formulaRangeMovingInfo,
                        isResizing = eventHandler.isFormulaRangeResizing,
                        resizingInfo = eventHandler._formulaRangeResizingInfo;
                    var paramRange,
                        rangeString,
                        ranges,
                        rects,
                        color;
                    for (var i = 0; i < rangeCount; i++)
                    {
                        paramRange = paramRanges[i];
                        rangeString = paramRange.text;
                        if (paramRange.ranges && paramRange.ranges.length > 0)
                        {
                            ranges = paramRange.ranges
                        }
                        else
                        {
                            ranges = [eventHandler.stringToRange(rangeString)]
                        }
                        if (!ranges)
                        {
                            continue
                        }
                        var ftbAcrossSheet = Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                        if (Sheets.features.formulatextbox && ftbAcrossSheet && ftbAcrossSheet.sheet)
                        {
                            if (Sheets.StringUtil.contains(rangeString, "!"))
                            {
                                var sheetNameInFormula = Sheets.StringUtil.leftBefore(rangeString, "!");
                                if (sheet.getName() !== sheetNameInFormula && "'" + sheet.getName() + "'" !== sheetNameInFormula)
                                {
                                    continue
                                }
                            }
                            else
                            {
                                if (!sheet.getCustomName(Sheets.StringUtil.leftBefore(rangeString, "[")) && !sheet.findTableByName(Sheets.StringUtil.leftBefore(rangeString, "[")))
                                {
                                    continue
                                }
                            }
                        }
                        rects = self._getPaintingRects(rowViewportIndex, colViewportIndex, ranges, clipRect);
                        for (var j = 0; j < rects.length; j++)
                        {
                            var rect = rects[j];
                            if (rect && rect.width > 0 && rect.height > 0)
                            {
                                color = fbx.getRangeColor(i);
                                if (fbx.isAppendingRange(paramRange))
                                {
                                    if (isHoving && hovingInfo.paramRange.index === i)
                                    {
                                        ctx.beginPath();
                                        ctx.lineWidth = 2;
                                        ctx.strokeStyle = color;
                                        ctx.rect(rect.x + 1, rect.y + 1, rect.width - 3, rect.height - 3);
                                        ctx.stroke()
                                    }
                                    self.paintDashRect(ctx, rect, color)
                                }
                                else if ((isHoving && hovingInfo.paramRange.index === i) || (isMoving && movingInfo.paramRange.index === i) || (isResizing && resizingInfo.paramRange.index === i))
                                {
                                    ctx.beginPath();
                                    ctx.lineWidth = 2;
                                    ctx.strokeStyle = color;
                                    ctx.rect(rect.x + 1, rect.y + 1, rect.width - 3, rect.height - 3);
                                    ctx.stroke()
                                }
                                else
                                {
                                    ctx.beginPath();
                                    ctx.lineWidth = 2;
                                    ctx.strokeStyle = color;
                                    ctx.rect(rect.x, rect.y, rect.width - 1, rect.height - 1);
                                    ctx.stroke()
                                }
                                if (fbx.isActiveRange(paramRange))
                                {
                                    var a = 0.1,
                                        r = 0,
                                        g = 0,
                                        b = 0;
                                    var val = Sheets.util.parseColorString(color);
                                    if (val.length === 3)
                                    {
                                        r = val[0];
                                        g = val[1];
                                        b = val[2]
                                    }
                                    else if (val.length === 4)
                                    {
                                        r = val[1];
                                        g = val[2];
                                        b = val[3]
                                    }
                                    ctx.beginPath();
                                    ctx.fillStyle = "rgba(" + r + "," + g + "," + b + "," + a + ")";
                                    ctx.fillRect(rect.x + 1, rect.y + 1, rect.width - 3, rect.height - 3)
                                }
                                paintRects.push({
                                    rect: rect, color: color, allowDrag: paramRange.allowDrag
                                })
                            }
                        }
                    }
                    if (paintRects.length > 0)
                    {
                        var paintRectCount = paintRects.length;
                        for (var i = 0; i < paintRectCount; i++)
                        {
                            rect = paintRects[i].rect;
                            color = paintRects[i].color;
                            var size = 5;
                            var x1 = rect.x - 2,
                                x2 = rect.x + rect.width + 1 - size,
                                y1 = rect.y - 2,
                                y2 = rect.y + rect.height + 1 - size;
                            if (paintRects[i].allowDrag === false)
                            {
                                continue
                            }
                            var ftbAcrossSheet = Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                            if (Sheets.features.formulatextbox && ftbAcrossSheet && ftbAcrossSheet.text)
                            {
                                continue
                            }
                            ctx.beginPath();
                            ctx.fillStyle = color;
                            ctx.fillRect(x1, y1, size, size);
                            ctx.fillRect(x2, y1, size, size);
                            ctx.fillRect(x1, y2, size, size);
                            ctx.fillRect(x2, y2, size, size)
                        }
                    }
                    ctx.beginPath();
                    ctx.restore()
                };
                _SheetRender.prototype.paintDashRect = function(ctx, rect, color)
                {
                    ctx.save();
                    var dashLines = [6, 6];
                    if (ctx.setLineDash && !$.browser.qtMode)
                    {
                        ctx.beginPath();
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = color;
                        ctx.setLineDash(dashLines);
                        ctx.rect(rect.x, rect.y, rect.width - 1, rect.height - 1);
                        ctx.stroke()
                    }
                    else
                    {
                        ctx.beginPath();
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = color;
                        var dash1 = dashLines[0],
                            dash2 = dashLines[1],
                            x,
                            y,
                            remainderWidth,
                            remainderHeight;
                        x = rect.x,
                        y = rect.y,
                        remainderWidth = rect.width;
                        while (remainderWidth > 0)
                        {
                            if (remainderWidth >= dash1 + dash2)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x + dash1, y);
                                x = x + dash1 + dash2;
                                remainderWidth = remainderWidth - dash1 - dash2
                            }
                            else if (remainderWidth >= dash1)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x + dash1, y);
                                remainderWidth = remainderWidth - dash1 - dash2;
                                break
                            }
                            else if (remainderWidth > 0)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x + remainderWidth, y);
                                remainderWidth = remainderWidth - dash1 - dash2;
                                break
                            }
                        }
                        x = rect.x + rect.width - 1,
                        y = rect.y + 1,
                        remainderHeight = rect.height - 1;
                        if (remainderWidth < 0)
                        {
                            remainderWidth = Math_abs(remainderWidth);
                            if (remainderWidth > dash2)
                            {
                                ctx.moveTo(x, y - 2);
                                ctx.lineTo(x, y + (remainderWidth - dash2))
                            }
                            y += remainderWidth;
                            remainderHeight -= remainderWidth
                        }
                        while (remainderHeight > 0)
                        {
                            if (remainderHeight >= dash1 + dash2)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y + dash1);
                                y = y + dash1 + dash2;
                                remainderHeight = remainderHeight - dash1 - dash2
                            }
                            else if (remainderHeight >= dash1)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y + dash1);
                                remainderHeight = remainderHeight - dash1 - dash2
                            }
                            else if (remainderHeight > 0)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y + remainderHeight);
                                remainderHeight = remainderHeight - dash1 - dash2
                            }
                        }
                        x = rect.x + rect.width - 2,
                        y = rect.y + rect.height - 1,
                        remainderWidth = rect.width - 1;
                        if (remainderHeight < 0)
                        {
                            remainderHeight = Math_abs(remainderHeight);
                            if (remainderHeight > dash2)
                            {
                                ctx.moveTo(x + 2, y);
                                ctx.lineTo(x - (remainderHeight - dash2), y)
                            }
                            x -= remainderHeight;
                            remainderWidth -= remainderHeight
                        }
                        while (remainderWidth > 0)
                        {
                            if (remainderWidth >= dash1 + dash2)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x - dash1, y);
                                x = x - dash1 - dash2;
                                remainderWidth = remainderWidth - dash1 - dash2
                            }
                            else if (remainderWidth >= dash1)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x - dash1, y);
                                remainderWidth = remainderWidth - dash1 - dash2;
                                break
                            }
                            else if (remainderWidth > 0)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x - remainderWidth, y);
                                remainderWidth = remainderWidth - dash1 - dash2;
                                break
                            }
                        }
                        x = rect.x,
                        y = rect.y + rect.height - 2,
                        remainderHeight = rect.height - 1;
                        if (remainderWidth < 0)
                        {
                            remainderWidth = Math_abs(remainderWidth);
                            if (remainderWidth > dash2)
                            {
                                ctx.moveTo(x, y + 2);
                                ctx.lineTo(x, y - (remainderWidth - dash2))
                            }
                            y -= remainderWidth;
                            remainderHeight -= remainderWidth
                        }
                        while (remainderHeight > 0)
                        {
                            if (remainderHeight >= dash1 + dash2)
                            {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y - dash1);
                                y = y - dash1 - dash2;
                                remainderHeight = remainderHeight - dash1 - dash2
                            }
                            else if (remainderHeight >= dash1)
                            {
                                ctx.moveTo(x, y);
                                if (y - dash1 === rect.y)
                                {
                                    ctx.lineTo(x, y - dash1 - 1)
                                }
                                else
                                {
                                    ctx.lineTo(x, y - dash1)
                                }
                                remainderHeight = remainderHeight - dash1 - dash2
                            }
                            else if (remainderHeight > 0)
                            {
                                if (y > rect.y)
                                {
                                    ctx.moveTo(x, y);
                                    ctx.lineTo(x, y - remainderHeight)
                                }
                                remainderHeight = remainderHeight - dash1 - dash2
                            }
                        }
                        ctx.stroke()
                    }
                    ctx.beginPath();
                    ctx.restore()
                };
                _SheetRender.prototype.getDragFillIndicatorRect = function(selectRect)
                {
                    var sheet = this._sheet;
                    var range = sheet._getActiveSelectedRange();
                    var layout = sheet._getSheetLayout();
                    var rect = new Sheets.Rect(-4, -4, 4, 4);
                    if (range.col === -1)
                    {
                        rect.x = layout.frozenX;
                        rect.y = selectRect.y + selectRect.height - 0.5 - 2
                    }
                    else if (range.row === -1)
                    {
                        rect.x = selectRect.x + selectRect.width - 0.5 - 2;
                        rect.y = layout.frozenY
                    }
                    else
                    {
                        rect.x = selectRect.x + selectRect.width - 0.5 - 2;
                        rect.y = selectRect.y + selectRect.height - 0.5 - 2
                    }
                    return rect
                };
                _SheetRender.prototype.paintDragFillIndicator = function(ctx, rowViewportIndex, colViewportIndex, selectRect, clipRect)
                {
                    var sheet = this._sheet;
                    var layout = sheet._getSheetLayout();
                    var indicatorRect = this.getDragFillIndicatorRect(selectRect);
                    var viewportRect = layout.viewportRect(rowViewportIndex, colViewportIndex);
                    if (!clipRect || indicatorRect.intersectRect(clipRect))
                    {
                        if (indicatorRect.intersectRect(viewportRect))
                        {
                            var copyRect = new Sheets.Rect(indicatorRect.x - 1.5, indicatorRect.y - 1.5, indicatorRect.width + 2, indicatorRect.height + 2);
                            copyRect.x = Math_max(copyRect.x, viewportRect.x);
                            copyRect.y = Math_max(copyRect.y, viewportRect.y);
                            this.copyDoubleBufferRect(copyRect);
                            ctx.save();
                            if (clipRect && !clipRect.containsRect(indicatorRect))
                            {
                                ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                                ctx.clip()
                            }
                            ctx.beginPath();
                            ctx.fillStyle = Sheets._ThemeContext.getColor(sheet, sheet.selectionBorderColor());
                            ctx.fillRect(indicatorRect.x, indicatorRect.y, indicatorRect.width, indicatorRect.height);
                            sheet._dragFillIndicatorRect = new Sheets.Rect(indicatorRect.x, indicatorRect.y, 4, 4);
                            ctx.beginPath();
                            ctx.restore()
                        }
                    }
                };
                _SheetRender.prototype._paintCommentFloatLayoutPanel = function(sheetArea)
                {
                    var self = this;
                    if (sheetArea === 3)
                    {
                        var commentRender = self._sheet._commentRender;
                        if (commentRender)
                        {
                            commentRender.renderCommentFloatPanel(self._sheet)
                        }
                    }
                };
                _SheetRender.prototype._paintCommentCellAdorner = function(ctx, sheetArea, cell)
                {
                    var self = this,
                        commentRender = self._sheet._commentRender;
                    if (commentRender)
                    {
                        commentRender.renderCommentCellAdorner(ctx, sheetArea, cell)
                    }
                };
                _SheetRender.prototype._paintComment = function(clipRect)
                {
                    var self = this,
                        sheet = self._sheet,
                        commentRender = sheet._commentRender;
                    if (!sheet._hoverCell)
                    {
                        var layout = self._sheet._getSheetLayout(),
                            rect;
                        for (var r = 0; r <= 2; r++)
                        {
                            for (var c = 0; c <= 2; c++)
                            {
                                rect = layout.viewportRect(r, c);
                                if (!rect || rect.width === 0 || rect.height === 0)
                                {
                                    continue
                                }
                                if (!clipRect || rect.intersectRect(clipRect))
                                {
                                    var commentManager = sheet._commentManager;
                                    if (commentRender && commentManager)
                                    {
                                        commentRender.renderComment(commentManager)
                                    }
                                }
                            }
                        }
                    }
                };
                _SheetRender.prototype.paintViewportImp = function(ctx, rowViewportIndex, colViewportIndex, sheetArea, clipRect)
                {
                    var self = this;
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var sheet = self._sheet,
                        rowLayouts = sheet._getRowLayout(rowViewportIndex, sheetArea),
                        colLayouts = sheet._getColumnLayout(colViewportIndex, sheetArea),
                        rowLayoutCount = rowLayouts.length,
                        colLayoutCount = colLayouts.length;
                    if (rowLayoutCount < 0 || colLayoutCount < 0)
                    {
                        return
                    }
                    var spanLayouts = sheet._getCellLayout(rowViewportIndex, colViewportIndex, sheetArea),
                        hasSpanLayout = (spanLayouts.length > 0),
                        rowLayout = keyword_null,
                        colLayout = keyword_null,
                        cellLayout = keyword_null,
                        cachePool = sheet._cachePool,
                        row,
                        col,
                        x = 0,
                        y = 0,
                        width = 0,
                        height = 0,
                        data,
                        style,
                        border = cachePool.isCaching() && sheet.parent && !sheet.parent.touchScrollOnRails() ? new Sheets._FastBorders(rowLayouts[0].row, colLayouts[0].col, rowLayoutCount, colLayoutCount, clipRect) : new Sheets._GcBorders(sheet, rowViewportIndex, colViewportIndex, sheetArea),
                        tmpAddSpans = [],
                        paintingCells = [],
                        allowCellOverflow = (sheetArea === 3 && sheet._allowCellOverflow),
                        paintingFilterButtons = keyword_null,
                        filterButtonModel = sheet._getFilterButtonModel(),
                        validationUIModel = [],
                        highlightInvalid = (sheetArea === 3 && sheet.parent && sheet.parent.highlightInvalidData());
                    if (Sheets.features.comment && sheet._commentManager.hasComment())
                    {
                        self._paintCommentFloatLayoutPanel(sheetArea)
                    }
                    ctx.save();
                    if (clipRect)
                    {
                        ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                        ctx.clip()
                    }
                    ctx.beginPath();
                    for (var i = 0; i < rowLayoutCount; i++)
                    {
                        rowLayout = rowLayouts[i];
                        for (var j = 0; j < colLayoutCount; j++)
                        {
                            colLayout = colLayouts[j];
                            cellLayout = (hasSpanLayout && spanLayouts.findCell(rowLayout.row, colLayout.col));
                            if (cellLayout)
                            {
                                row = cellLayout.row;
                                col = cellLayout.col;
                                x = cellLayout.x;
                                y = cellLayout.y;
                                width = cellLayout.width;
                                height = cellLayout.height
                            }
                            else
                            {
                                row = rowLayout.row;
                                col = colLayout.col;
                                x = colLayout.x;
                                y = rowLayout.y;
                                width = colLayout.width;
                                height = rowLayout.height
                            }
                            if (clipRect && (x + width <= clipRect.x || x >= clipRect.x + clipRect.width || y + height <= clipRect.y || y >= clipRect.y + clipRect.height))
                            {
                                continue
                            }
                            if (width === 0 || height === 0)
                            {
                                continue
                            }
                            if (!cellLayout || !Sheets.ArrayHelper.contains(tmpAddSpans, cellLayout))
                            {
                                data = cachePool.getValue(row, col, sheetArea);
                                style = cachePool.getActualStyle(row, col, sheetArea);
                                var conditionalForeColor = {value: undefined};
                                var text;
                                if (style)
                                {
                                    text = Sheets._CacheMgr.getFormattedTextByStyle(sheet, style, data, conditionalForeColor)
                                }
                                if (filterButtonModel && width > 0 && height > 0)
                                {
                                    var btnInfo = filterButtonModel.find(row, col, sheetArea);
                                    if (btnInfo)
                                    {
                                        if (!paintingFilterButtons)
                                        {
                                            paintingFilterButtons = new Sheets._FilterButtonInfoModel
                                        }
                                        paintingFilterButtons.push(new Sheets._FilterButtonInfo(btnInfo.rowFilter, btnInfo.row, btnInfo.col, btnInfo.sheetArea, x, y, width, height))
                                    }
                                }
                                if (highlightInvalid && !sheet.isValid(row, col, data))
                                {
                                    validationUIModel.push({
                                        x: x, y: y, width: width, height: height
                                    })
                                }
                                border.addCellLines(row, col, x, y, width, height, style, cellLayout);
                                paintingCells.push({
                                    data: data, row: row, col: col, x: x, y: y, width: width, height: height, style: style
                                });
                                if (cellLayout)
                                {
                                    tmpAddSpans.push(cellLayout)
                                }
                            }
                        }
                    }
                    if (paintingCells.length > 0)
                    {
                        if (allowCellOverflow)
                        {
                            var layoutBuilder = cachePool.getCellOverflowBuilder(rowViewportIndex, colViewportIndex, function()
                                {
                                    return new _CellOverflowLayoutBuilder(sheet, rowViewportIndex, colViewportIndex)
                                });
                            self.buildCellOverflowValueLayout(layoutBuilder, paintingCells, border)
                        }
                        self.paintCells(ctx, paintingCells, sheetArea)
                    }
                    if (paintingFilterButtons && paintingFilterButtons.length > 0)
                    {
                        self._paintFilterButtons(ctx, paintingFilterButtons)
                    }
                    border.paint(ctx, clipRect);
                    if (validationUIModel.length > 0)
                    {
                        self._paintValidationUI(ctx, validationUIModel)
                    }
                    ctx.restore()
                };
                _SheetRender.prototype._getFilterButtonRect = function(cellRect)
                {
                    var sheet = this._sheet,
                        zoomFactor = sheet._zoomFactor;
                    var filterButtonZoom = zoomFactor > 1 ? 1 : zoomFactor,
                        width = parseInt((Math_min(20, sheet.defaults.rowHeight) * filterButtonZoom).toString(), 10);
                    if (sheet.parent && sheet.parent.useTouchLayout())
                    {
                        width = parseInt((sheet.defaults.rowHeight * zoomFactor).toString(), 10)
                    }
                    var height = width,
                        x = cellRect.x + cellRect.width - width,
                        y = cellRect.y + cellRect.height - height;
                    return {
                            x: x, y: y, width: width, height: height
                        }
                };
                _SheetRender.prototype._paintFilterButtons = function(ctx, filterHeaderModel)
                {
                    var sheet = this._sheet;
                    ctx.save();
                    ctx.beginPath();
                    ctx.lineWidth = 1;
                    ctx.fillStyle = "#FFFFFF";
                    ctx.strokeStyle = "#CCCCCC";
                    var ctx2 = this._getCtx();
                    for (var i = 0; i < filterHeaderModel.length; i++)
                    {
                        var filterBtnInfo = filterHeaderModel[i];
                        var filterButtonRect = this._getFilterButtonRect(new Sheets.Rect(filterBtnInfo.x, filterBtnInfo.y, filterBtnInfo.width, filterBtnInfo.height));
                        var width = filterButtonRect.width;
                        var height = filterButtonRect.height;
                        var x = filterButtonRect.x;
                        var y = filterButtonRect.y;
                        ctx.save();
                        ctx.rect(filterBtnInfo.x, filterBtnInfo.y, filterBtnInfo.width, filterBtnInfo.height);
                        ctx.clip();
                        ctx.beginPath();
                        ctx.fillRect(x + 1, y + 1, width - 3, height - 3);
                        ctx.strokeRect(x + 1 - 0.5, y + 2 - 0.5, width - 3, height - 4);
                        var filterButtonState = filterBtnInfo.getState();
                        var imgSrc = Sheets._GcFilterDialog.getImageSrc(filterButtonState);
                        var imageLoader = sheet._getImageLoader();
                        try
                        {
                            if (imageLoader.getState(imgSrc))
                            {
                                ctx.drawImage(imageLoader.getImage(imgSrc), x, y + 1, width - 3, height - 3)
                            }
                            else
                            {
                                imageLoader.addImage(imgSrc)
                            }
                        }
                        catch(ex) {}
                        ctx.beginPath();
                        ctx.restore()
                    }
                    ctx.restore()
                };
                _SheetRender.prototype._paintValidationUI = function(ctx, validationUIModel)
                {
                    if (validationUIModel)
                    {
                        var length = validationUIModel.length;
                        for (var i = 0; i < length; i++)
                        {
                            var circle = validationUIModel[i];
                            var x = circle.x - 4,
                                y = circle.y - 4,
                                w = circle.width + 8,
                                h = circle.height + 8;
                            var kappa = 0.5522848,
                                ox = (w / 2) * kappa,
                                oy = (h / 2) * kappa,
                                xe = x + w,
                                ye = y + h,
                                xm = x + w / 2,
                                ym = y + h / 2;
                            ctx.save();
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = "red";
                            ctx.beginPath();
                            ctx.moveTo(x, ym);
                            ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
                            ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
                            ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
                            ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
                            ctx.closePath();
                            ctx.stroke();
                            ctx.restore()
                        }
                    }
                };
                _SheetRender.prototype.paintCells = function(ctx, cells, sheetArea)
                {
                    var self = this;
                    var sheet = self._sheet,
                        isViewportArea = (sheetArea === 3),
                        scaleFont = Sheets.StyleHelper._scaleFont,
                        zoomFactor = sheet._zoomFactor,
                        defaultFontInfo = scaleFont(self._getDefaultFont(sheetArea), zoomFactor),
                        defaultStyle = sheet.getDefaultStyle(sheetArea),
                        defaultCellType = sheet.getDefaultCellType(sheetArea),
                        conditionalFormats = sheet._conditionalFormats,
                        sheetBackColor = sheet.parent && sheet.parent.backColor() || "#FFFFFF";
                    sheetBackColor = sheetBackColor === "white" ? "#FFFFFF" : sheetBackColor;
                    var imageLoader = sheet._getImageLoader();
                    ctx.save();
                    ctx.beginPath();
                    ctx.fillStyle = ((defaultStyle && defaultStyle.foreColor) || "#000000");
                    ctx.font = defaultFontInfo.font;
                    if (isViewportArea)
                    {
                        ctx.textAlign = "right"
                    }
                    else
                    {
                        ctx.textAlign = "center"
                    }
                    var count = cells.length,
                        cell,
                        cellType,
                        data,
                        row,
                        col,
                        x,
                        y,
                        width,
                        height,
                        style,
                        cellOverflowLayout,
                        visualState,
                        fontInfo,
                        lineHeight,
                        sparkline,
                        supportSparkline = Sheets.features.sparkline,
                        m = sheet._getModel(sheetArea),
                        overflowCells = [],
                        overflowCell,
                        options = {
                            sheet: sheet, row: -1, col: -1, fontInfo: keyword_null, lineHeight: -1, imageLoader: imageLoader, conditionalFormats: conditionalFormats, sheetArea: sheetArea, parentBackColor: sheetBackColor
                        };
                    for (var i = 0; i < count; i++)
                    {
                        cell = cells[i];
                        data = cell.data;
                        row = cell.row;
                        col = cell.col;
                        x = cell.x;
                        y = cell.y;
                        width = cell.width;
                        height = cell.height;
                        style = cell.style;
                        cellOverflowLayout = cell.cellOverflowLayout;
                        if (style.font)
                        {
                            fontInfo = scaleFont(style.font, zoomFactor)
                        }
                        else
                        {
                            fontInfo = defaultFontInfo
                        }
                        var shrinkToFit = (!style.wordWrap && style.shrinkToFit);
                        if (shrinkToFit)
                        {
                            var text = sheet.getText(row, col, sheetArea);
                            if (style.watermark && !text)
                            {
                                text = style.watermark
                            }
                            if (text)
                            {
                                var minFont = {value: false};
                                for (var j = 0; j < 3 && minFont.value === false; j++)
                                {
                                    var w = sheet._getStringWidthByCanvas(text, fontInfo.font);
                                    var space = Math_max(0, width - 4);
                                    if (style.hAlign !== 1 && style.textIndent)
                                    {
                                        space = Math_max(0, space - style.textIndent * 8)
                                    }
                                    if (space < w)
                                    {
                                        fontInfo = scaleFont(fontInfo.font, space / w, minFont, true)
                                    }
                                    else
                                    {
                                        break
                                    }
                                }
                            }
                        }
                        style.font = fontInfo.font;
                        if (width > 0 && height > 0)
                        {
                            cellType = (style.cellType || defaultCellType);
                            x--;
                            y--;
                            width++;
                            height++;
                            if (isViewportArea)
                            {
                                sparkline = (supportSparkline && m.getSparkline(row, col));
                                options.sparkline = sparkline
                            }
                            else
                            {
                                visualState = self.getVisualState(row, col, sheetArea);
                                options.visualState = visualState
                            }
                            lineHeight = sheet._getFontHeight(fontInfo.font, shrinkToFit);
                            options.lineHeight = lineHeight;
                            options.row = row;
                            options.col = col;
                            options.fontInfo = fontInfo;
                            options.cellOverflowLayout = cellOverflowLayout;
                            cellType.paint(ctx, data, x, y, width, height, style, options);
                            if (cellOverflowLayout && !options.showBarIconOnly)
                            {
                                overflowCells.push({
                                    cellType: cellType, data: data, x: x, y: y, width: width, height: height, style: style, options: {
                                            sheet: sheet, row: row, col: col, fontInfo: fontInfo, lineHeight: lineHeight, cellOverflowLayout: cellOverflowLayout, parentBackColor: sheetBackColor
                                        }
                                })
                            }
                        }
                        if (Sheets.features.comment && sheet._commentManager.hasComment())
                        {
                            self._paintCommentCellAdorner(ctx, sheetArea, cell)
                        }
                    }
                    count = overflowCells.length;
                    if (count > 0)
                    {
                        var isEditing = sheet.isEditing(),
                            activeRow = sheet._activeRowIndex,
                            activeCol = sheet._activeColIndex,
                            hasSparklineEx = Sheets.features.sparklineEx;
                        for (var i = 0; i < count; i++)
                        {
                            overflowCell = overflowCells[i];
                            cellType = overflowCell.cellType;
                            data = overflowCell.data;
                            x = overflowCell.x;
                            y = overflowCell.y;
                            width = overflowCell.width;
                            height = overflowCell.height;
                            style = overflowCell.style;
                            options = overflowCell.options;
                            if (isEditing && options.row === activeRow && options.col === activeCol)
                            {
                                continue
                            }
                            if (hasSparklineEx && data instanceof Sheets.SparklineExValue)
                            {
                                continue
                            }
                            if (cellType.paintValue)
                            {
                                cellType.paintValue(ctx, data, x, y, width, height, style, options)
                            }
                        }
                    }
                    ctx.restore()
                };
                _SheetRender.prototype.getVisualState = function(row, col, sheetArea)
                {
                    var sheet = this._sheet;
                    var visualState = 0;
                    if (Sheets.FocusHelper.isActiveElement(sheet) || (sheet.parent && !sheet.parent.hideSelection()))
                    {
                        if (sheetArea === 3 || typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                        {
                            if (!sheet.isEditing() && sheet._isActiveCell(row, col))
                            {
                                visualState = 3
                            }
                            else if (sheet._isSelected(row, col, sheetArea))
                            {
                                visualState = 2
                            }
                        }
                        else
                        {
                            if (sheet._isSelected(row, col, sheetArea))
                            {
                                visualState = 1;
                                if (sheet._isAllSelected(row, col, sheetArea))
                                {
                                    visualState = 2
                                }
                            }
                            if (sheet._isHover(row, col, sheetArea))
                            {
                                visualState = 4
                            }
                        }
                    }
                    return visualState
                };
                _SheetRender.prototype.paintLine = function(ctx, line, x1, y1, x2, y2)
                {
                    ctx.lineWidth = line.width();
                    ctx.strokeStyle = line.color;
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2)
                };
                _SheetRender.prototype.paintGroup = function(ctx, clipRect)
                {
                    var sheet = this._sheet,
                        groupLayout = sheet._getGroupLayout();
                    if (groupLayout.width === 0 && groupLayout.height === 0)
                    {
                        return
                    }
                    ctx.save();
                    ctx.beginPath();
                    var layout = sheet._getSheetLayout();
                    if (groupLayout.width > 0)
                    {
                        if (!clipRect || clipRect.intersect(groupLayout.x, groupLayout.y, groupLayout.width, layout.height))
                        {
                            var rowMaxLevel = groupLayout.rowMaxLevel;
                            var rowGroupHeader = new Sheets._RangeGroupHeaderPresenter(sheet, true, rowMaxLevel);
                            rowGroupHeader.paintGroupHeader(ctx);
                            var groups = sheet._cachePool.getRowGroups(function()
                                {
                                    var rowGroups = [new Sheets._RangeGroupPresenter(sheet, true, 0, rowMaxLevel), new Sheets._RangeGroupPresenter(sheet, true, 1, rowMaxLevel), new Sheets._RangeGroupPresenter(sheet, true, 2, rowMaxLevel)];
                                    for (var i = 0; i <= 2; i++)
                                    {
                                        rowGroups[i].createGroupInfo()
                                    }
                                    return rowGroups
                                });
                            for (var i = 0; i <= 2; i++)
                            {
                                groups[i].paintGroups(ctx)
                            }
                        }
                    }
                    if (groupLayout.height > 0)
                    {
                        if (!clipRect || clipRect.intersect(groupLayout.x, groupLayout.y, layout.width, groupLayout.height))
                        {
                            var colMaxLevel = groupLayout.colMaxLevel;
                            var colGroupHeader = new Sheets._RangeGroupHeaderPresenter(sheet, false, colMaxLevel);
                            colGroupHeader.paintGroupHeader(ctx);
                            var groups = sheet._cachePool.getColGroups(function()
                                {
                                    var colGroups = [new Sheets._RangeGroupPresenter(sheet, false, 0, colMaxLevel), new Sheets._RangeGroupPresenter(sheet, false, 1, colMaxLevel), new Sheets._RangeGroupPresenter(sheet, false, 2, colMaxLevel)];
                                    for (var i = 0; i <= 2; i++)
                                    {
                                        colGroups[i].createGroupInfo()
                                    }
                                    return colGroups
                                });
                            for (var i = 0; i <= 2; i++)
                            {
                                groups[i].paintGroups(ctx)
                            }
                        }
                    }
                    ctx.beginPath();
                    ctx.restore()
                };
                _SheetRender.prototype.groupHitTest = function(x, y)
                {
                    if (!Sheets.features.group)
                    {
                        return keyword_null
                    }
                    var sheet = this._sheet,
                        groupLayout = sheet._getGroupLayout();
                    if (groupLayout.width === 0 && groupLayout.height === 0)
                    {
                        return keyword_null
                    }
                    var layout = sheet._getSheetLayout(),
                        gRect = new Sheets.Rect(groupLayout.x, groupLayout.y, groupLayout.width, layout.height);
                    if (!gRect.contains(x, y))
                    {
                        gRect = new Sheets.Rect(groupLayout.x, groupLayout.y, layout.width, groupLayout.height);
                        if (!gRect.contains(x, y))
                        {
                            return keyword_null
                        }
                    }
                    var t = {
                            what: "empty", info: keyword_null
                        },
                        i,
                        k;
                    if (groupLayout.width > 0)
                    {
                        var rowMaxLevel = groupLayout.rowMaxLevel;
                        var rowGroupHeader = new Sheets._RangeGroupHeaderPresenter(sheet, true, rowMaxLevel);
                        k = rowGroupHeader.getGroupButton(x, y);
                        if (k)
                        {
                            t = {
                                what: "rgh", info: k
                            }
                        }
                        if (t.what === "empty")
                        {
                            var rowGroups = [new Sheets._RangeGroupPresenter(sheet, true, 0, rowMaxLevel), new Sheets._RangeGroupPresenter(sheet, true, 1, rowMaxLevel), new Sheets._RangeGroupPresenter(sheet, true, 2, rowMaxLevel)];
                            for (i = 0; i <= 2; i++)
                            {
                                rowGroups[i].createGroupInfo();
                                k = rowGroups[i].getRowGroupButton(x, y);
                                if (k)
                                {
                                    t = {
                                        what: "rg", info: k
                                    };
                                    break
                                }
                            }
                        }
                    }
                    if (groupLayout.height > 0)
                    {
                        var colMaxLevel = groupLayout.colMaxLevel;
                        if (t.what === "empty")
                        {
                            var colGroupHeader = new Sheets._RangeGroupHeaderPresenter(sheet, false, colMaxLevel);
                            k = colGroupHeader.getGroupButton(x, y);
                            if (k)
                            {
                                t = {
                                    what: "cgh", info: k
                                }
                            }
                        }
                        if (t.what === "empty")
                        {
                            var colGroups = [new Sheets._RangeGroupPresenter(sheet, false, 0, colMaxLevel), new Sheets._RangeGroupPresenter(sheet, false, 1, colMaxLevel), new Sheets._RangeGroupPresenter(sheet, false, 2, colMaxLevel)];
                            for (i = 0; i <= 2; i++)
                            {
                                colGroups[i].createGroupInfo();
                                k = colGroups[i].getColGroupButton(x, y);
                                if (k)
                                {
                                    t = {
                                        what: "cg", info: k
                                    };
                                    break
                                }
                            }
                        }
                    }
                    return t
                };
                _SheetRender.prototype.buildCellOverflowValueLayout = function(layoutBuilder, paintingCells, border)
                {
                    var sheet = this._sheet,
                        cachePool = sheet._cachePool,
                        count = paintingCells.length,
                        cell,
                        data,
                        style,
                        row,
                        col,
                        x,
                        y,
                        width,
                        height,
                        backgroundWidth,
                        textX,
                        newX,
                        newCell,
                        overflowLayoutModel,
                        headingOverflowLayout,
                        trailingOverflowLayout,
                        overflowLayout;
                    for (var i = 0; i < count; i++)
                    {
                        cell = paintingCells[i];
                        row = cell.row;
                        col = cell.col;
                        x = cell.x;
                        y = cell.y;
                        height = cell.height;
                        overflowLayoutModel = layoutBuilder.getCellOverflowLayoutModel(row);
                        headingOverflowLayout = overflowLayoutModel.headingOverflowlayout;
                        trailingOverflowLayout = overflowLayoutModel.trailingOverflowLayout;
                        overflowLayout = overflowLayoutModel.find(col);
                        if (overflowLayout && overflowLayout.column === col)
                        {
                            width = cell.width;
                            backgroundWidth = overflowLayout.backgroundWidth;
                            if (overflowLayout.backgroundLeftWidth < 0)
                            {
                                textX = x
                            }
                            else if (overflowLayout.backgroundRightWidth < 0)
                            {
                                textX = x + width - backgroundWidth
                            }
                            else
                            {
                                textX = x + width / 2 - overflowLayout.backgroundLeftWidth
                            }
                            cell.cellOverflowLayout = overflowLayout;
                            overflowLayout.layout = {
                                x: textX, y: y, width: backgroundWidth, height: height
                            };
                            border.addCellOverlfowLayout(row, overflowLayout)
                        }
                        else if (headingOverflowLayout && headingOverflowLayout.endColumn === col)
                        {
                            col = headingOverflowLayout.column;
                            style = cachePool.getActualStyle(row, col);
                            data = sheet.getValue(row, col);
                            width = headingOverflowLayout.columnWidth;
                            backgroundWidth = headingOverflowLayout.backgroundWidth;
                            textX = x + cell.width - backgroundWidth;
                            newCell = {
                                data: data, row: row, col: col, x: textX, y: cell.y, width: width, height: height, style: style, cellOverflowLayout: headingOverflowLayout
                            };
                            paintingCells.push(newCell);
                            headingOverflowLayout.layout = {
                                x: textX, y: y, width: backgroundWidth, height: height
                            };
                            border.addCellOverlfowLayout(row, headingOverflowLayout)
                        }
                        else if (trailingOverflowLayout && trailingOverflowLayout.startColumn === col)
                        {
                            col = trailingOverflowLayout.column;
                            style = cachePool.getActualStyle(row, col);
                            data = sheet.getValue(row, col);
                            width = trailingOverflowLayout.columnWidth;
                            backgroundWidth = trailingOverflowLayout.backgroundWidth;
                            textX = x;
                            newX = x + backgroundWidth - width;
                            newCell = {
                                data: data, row: row, col: col, x: newX, y: y, width: width, height: height, style: style, cellOverflowLayout: trailingOverflowLayout
                            };
                            paintingCells.push(newCell);
                            trailingOverflowLayout.layout = {
                                x: textX, y: y, width: backgroundWidth, height: height
                            };
                            border.addCellOverlfowLayout(row, trailingOverflowLayout)
                        }
                    }
                };
                return _SheetRender
            })();
        Sheets._SheetRender = _SheetRender;
        var _CellOverflowLayoutBuilder = (function()
            {
                function _CellOverflowLayoutBuilder(sheet, rowViewportIndex, colViewportIndex)
                {
                    this.TEXT_WIDTH_OFFSET = 2;
                    var self = this;
                    self._sheet = sheet;
                    self._rowViewportIndex = rowViewportIndex;
                    self._colViewportIndex = colViewportIndex;
                    self._colLayoutModel = sheet._getColumnLayout(colViewportIndex);
                    self._cellLayoutModel = sheet._getCellLayout(rowViewportIndex, colViewportIndex),
                    self.maxCellOverflowDistance = sheet.maxCellOverflowDistance;
                    self.scaleFont = Sheets.StyleHelper._scaleFont;
                    self.zoomFactor = sheet._zoomFactor;
                    self.defaultFont = self.scaleFont(sheet._render._getDefaultFont(), self.zoomFactor).font;
                    self.defaultCellType = sheet.getDefaultCellType();
                    self.cachedCellOverflowModels = {}
                }
                _CellOverflowLayoutBuilder.prototype.getCellOverflowLayoutModel = function(row)
                {
                    var self = this;
                    var cache = self.cachedCellOverflowModels[row];
                    if (cache)
                    {
                        return cache
                    }
                    var sheet = self._sheet,
                        cachePool = sheet._cachePool,
                        colLayoutModel = self._colLayoutModel,
                        count = colLayoutModel.length,
                        vpLeft = colLayoutModel[0].col,
                        vpRight = colLayoutModel[count - 1].col,
                        colLayout,
                        col,
                        style,
                        data,
                        width,
                        hAlign,
                        text;
                    var cellOverflowLayoutModel = new Sheets._CellOverflowLayoutModel,
                        cellOverflowLayout;
                    cellOverflowLayoutModel.headingOverflowlayout = self._buildHeadingCellOverflowLayout(row);
                    for (var i = 0; i < count; i++)
                    {
                        colLayout = colLayoutModel[i];
                        if (colLayout.width <= 0)
                        {
                            continue
                        }
                        col = colLayout.col;
                        data = cachePool.getValue(row, col);
                        style = cachePool.getActualStyle(row, col);
                        if (data === keyword_null || typeof(data) === const_undefined)
                        {
                            if (!style.watermark)
                            {
                                continue
                            }
                        }
                        if (style.shrinkToFit || style.wordWrap)
                        {
                            continue
                        }
                        width = cachePool.getZoomColWidth(col);
                        text = Sheets._CacheMgr.getFormattedTextByStyle(sheet, style, data);
                        hAlign = style.hAlign;
                        if (hAlign === 3)
                        {
                            hAlign = Sheets.util.getHAlignByValueType(hAlign, data, style.formatter)
                        }
                        if (hAlign === 0)
                        {
                            cellOverflowLayout = self._buildCellOverflowLayoutModelForLeft({
                                data: data, style: style, width: width, text: text
                            }, row, col, vpRight);
                            if (cellOverflowLayout)
                            {
                                cellOverflowLayoutModel.push(cellOverflowLayout)
                            }
                        }
                        else if (hAlign === 2)
                        {
                            cellOverflowLayout = self._buildCellOverflowLayoutModelForRight({
                                data: data, style: style, width: width, text: text
                            }, row, col, vpLeft);
                            if (cellOverflowLayout)
                            {
                                cellOverflowLayoutModel.push(cellOverflowLayout)
                            }
                        }
                        else if (hAlign === 1)
                        {
                            cellOverflowLayout = self._buildCellOverflowLayoutModelForCenter({
                                data: data, style: style, width: width, text: text
                            }, row, col, vpLeft, vpRight);
                            if (cellOverflowLayout)
                            {
                                cellOverflowLayoutModel.push(cellOverflowLayout)
                            }
                        }
                    }
                    cellOverflowLayoutModel.trailingOverflowLayout = self._buildTrailingCellOverflowLayout(row);
                    self.cachedCellOverflowModels[row] = cellOverflowLayoutModel;
                    return cellOverflowLayoutModel
                };
                _CellOverflowLayoutBuilder.prototype._buildCellOverflowLayoutModelForLeft = function(cellContext, row, col, deadCol)
                {
                    var self = this;
                    var sheet = self._sheet,
                        cachePool = sheet._cachePool,
                        cellLayoutModel = self._cellLayoutModel,
                        colWidth = cellContext.width,
                        backgroundWidth = cellContext.width,
                        data = cellContext.data,
                        style = cellContext.style,
                        nextCol,
                        text = cellContext.text,
                        textWidth,
                        nextStyle;
                    if (cellLayoutModel.findCell(row, col) !== keyword_null)
                    {
                        return keyword_null
                    }
                    var cellType = (style.cellType || self.defaultCellType);
                    if (!cellType.allowOverflow)
                    {
                        return keyword_null
                    }
                    if (!text && !style.watermark)
                    {
                        return keyword_null
                    }
                    if (!text && style.watermark)
                    {
                        text = style.watermark
                    }
                    var font = style.font,
                        textIndent = style.textIndent;
                    if (font)
                    {
                        font = self.scaleFont(font, self.zoomFactor).font
                    }
                    else
                    {
                        font = self.defaultFont
                    }
                    textWidth = Sheets._WordWrapHelper._measureText(text, font) + (textIndent ? textIndent * 8 : 0) + self.TEXT_WIDTH_OFFSET;
                    if (textWidth <= backgroundWidth)
                    {
                        return keyword_null
                    }
                    var startCol = col,
                        endCol = col;
                    for (nextCol = col + 1; nextCol <= deadCol; nextCol++)
                    {
                        if (cellLayoutModel.findCell(row, nextCol) !== keyword_null)
                        {
                            break
                        }
                        data = cachePool.getValue(row, nextCol);
                        if (data !== keyword_null && typeof(data) !== const_undefined)
                        {
                            break
                        }
                        nextStyle = cachePool.getActualStyle(row, nextCol);
                        if (nextStyle.watermark)
                        {
                            break
                        }
                        endCol = nextCol;
                        backgroundWidth += cachePool.getZoomColWidth(nextCol);
                        if (textWidth <= backgroundWidth)
                        {
                            break
                        }
                    }
                    if (endCol == col)
                    {
                        return keyword_null
                    }
                    return new Sheets._CellOverflowLayout(col, startCol, endCol, textWidth, colWidth, backgroundWidth, -1, backgroundWidth)
                };
                _CellOverflowLayoutBuilder.prototype._buildCellOverflowLayoutModelForRight = function(cellContext, row, col, deadColIndex)
                {
                    var self = this;
                    var sheet = self._sheet,
                        cachePool = sheet._cachePool,
                        cellLayoutModel = self._cellLayoutModel,
                        colWidth = cellContext.width,
                        backgroundWidth = cellContext.width,
                        data = cellContext.data,
                        style = cellContext.style,
                        width,
                        nextCol,
                        text = cellContext.text,
                        textWidth,
                        nextStyle;
                    if (cellLayoutModel.findCell(row, col) !== keyword_null)
                    {
                        return keyword_null
                    }
                    var cellType = (style.cellType || self.defaultCellType);
                    if (!cellType.allowOverflow)
                    {
                        return keyword_null
                    }
                    if (!text && !style.watermark)
                    {
                        return keyword_null
                    }
                    if (!text && style.watermark)
                    {
                        text = style.watermark
                    }
                    var font = style.font,
                        textIndent = style.textIndent;
                    if (font)
                    {
                        font = self.scaleFont(font, self.zoomFactor).font
                    }
                    else
                    {
                        font = self.defaultFont
                    }
                    textWidth = Sheets._WordWrapHelper._measureText(text, font) + (textIndent ? textIndent * 8 : 0) + self.TEXT_WIDTH_OFFSET;
                    if (textWidth <= backgroundWidth)
                    {
                        return keyword_null
                    }
                    var startCol = col,
                        endCol = col;
                    for (nextCol = col - 1; nextCol >= deadColIndex; nextCol--)
                    {
                        if (cellLayoutModel.findCell(row, nextCol) !== keyword_null)
                        {
                            break
                        }
                        data = cachePool.getValue(row, nextCol);
                        if (data !== keyword_null && typeof(data) !== const_undefined)
                        {
                            break
                        }
                        nextStyle = cachePool.getActualStyle(row, nextCol);
                        if (nextStyle.watermark)
                        {
                            break
                        }
                        startCol = nextCol;
                        backgroundWidth += cachePool.getZoomColWidth(nextCol);
                        if (textWidth <= backgroundWidth)
                        {
                            break
                        }
                    }
                    if (startCol == col)
                    {
                        return keyword_null
                    }
                    return new Sheets._CellOverflowLayout(col, startCol, endCol, textWidth, colWidth, backgroundWidth, backgroundWidth, -1)
                };
                _CellOverflowLayoutBuilder.prototype._buildCellOverflowLayoutModelForCenter = function(cellContext, row, col, leftDeadCol, rightDeadCol)
                {
                    var self = this;
                    var sheet = self._sheet,
                        cachePool = sheet._cachePool,
                        cellLayoutModel = self._cellLayoutModel,
                        colWidth = cellContext.width,
                        backgroundWidth = cellContext.width,
                        data = cellContext.data,
                        style = cellContext.style,
                        nextCol,
                        text = cellContext.text,
                        textWidth,
                        nextStyle;
                    if (cellLayoutModel.findCell(row, col) !== keyword_null)
                    {
                        return keyword_null
                    }
                    var cellType = (style.cellType || self.defaultCellType);
                    if (!cellType.allowOverflow)
                    {
                        return keyword_null
                    }
                    if (!text && !style.watermark)
                    {
                        return keyword_null
                    }
                    if (!text && style.watermark)
                    {
                        text = style.watermark
                    }
                    var font = style.font,
                        textIndent = style.textIndent;
                    if (font)
                    {
                        font = self.scaleFont(font, self.zoomFactor).font
                    }
                    else
                    {
                        font = self.defaultFont
                    }
                    textWidth = Sheets._WordWrapHelper._measureText(text, font) + (textIndent ? textIndent * 8 : 0) + self.TEXT_WIDTH_OFFSET;
                    if (textWidth <= backgroundWidth)
                    {
                        return keyword_null
                    }
                    var startCol = col,
                        leftBackgroundWidth = backgroundWidth / 2;
                    for (nextCol = col - 1; nextCol >= leftDeadCol; nextCol--)
                    {
                        if (cellLayoutModel.findCell(row, nextCol) !== keyword_null)
                        {
                            break
                        }
                        data = cachePool.getValue(row, nextCol);
                        if (data !== keyword_null && typeof(data) !== const_undefined)
                        {
                            break
                        }
                        nextStyle = cachePool.getActualStyle(row, nextCol);
                        if (nextStyle.watermark)
                        {
                            break
                        }
                        startCol = nextCol;
                        leftBackgroundWidth += cachePool.getZoomColWidth(nextCol);
                        if (textWidth / 2 <= leftBackgroundWidth)
                        {
                            break
                        }
                    }
                    var endCol = col,
                        rightBackgroundWidth = backgroundWidth / 2;
                    for (nextCol = col + 1; nextCol <= rightDeadCol; nextCol++)
                    {
                        if (cellLayoutModel.findCell(row, nextCol) !== keyword_null)
                        {
                            break
                        }
                        data = cachePool.getValue(row, nextCol);
                        if (data !== keyword_null && typeof(data) !== const_undefined)
                        {
                            break
                        }
                        endCol = nextCol;
                        rightBackgroundWidth += cachePool.getZoomColWidth(nextCol);
                        if (textWidth / 2 <= rightBackgroundWidth)
                        {
                            break
                        }
                    }
                    if (startCol === endCol)
                    {
                        return keyword_null
                    }
                    return new Sheets._CellOverflowLayout(col, startCol, endCol, textWidth, colWidth, leftBackgroundWidth + rightBackgroundWidth, leftBackgroundWidth, rightBackgroundWidth)
                };
                _CellOverflowLayoutBuilder.prototype._buildHeadingCellOverflowLayout = function(row)
                {
                    var self = this;
                    var sheet = self._sheet,
                        cachePool = sheet._cachePool,
                        colLayoutModel = self._colLayoutModel,
                        vpLeft = colLayoutModel[0].col,
                        vpRight = colLayoutModel[colLayoutModel.length - 1].col,
                        spanModel = sheet._getSpanModel(),
                        style,
                        data,
                        width,
                        hAlign,
                        maxFindCount = self.maxCellOverflowDistance,
                        col = vpLeft,
                        nextCol,
                        ret;
                    for (var i = 1; i < maxFindCount; i++)
                    {
                        nextCol = col - i;
                        if (nextCol < 0)
                        {
                            return keyword_null
                        }
                        if (spanModel.find(row, nextCol))
                        {
                            return keyword_null
                        }
                        data = cachePool.getValue(row, nextCol);
                        width = cachePool.getZoomColWidth(nextCol);
                        if (width > 0 && data !== keyword_null && typeof(data) !== const_undefined)
                        {
                            style = cachePool.getActualStyle(row, nextCol);
                            hAlign = style.hAlign;
                            if (hAlign === 3)
                            {
                                hAlign = Sheets.util.getHAlignByValueType(hAlign, data)
                            }
                            var text;
                            if ((hAlign === 0 || hAlign === 1) && style)
                            {
                                text = Sheets._CacheMgr.getFormattedTextByStyle(sheet, style, data)
                            }
                            if (hAlign === 0)
                            {
                                ret = self._buildCellOverflowLayoutModelForLeft({
                                    data: data, style: style, width: width, text: text
                                }, row, nextCol, vpRight);
                                if (ret && ret.endColumn >= vpLeft)
                                {
                                    return ret
                                }
                            }
                            else if (1)
                            {
                                ret = self._buildCellOverflowLayoutModelForCenter({
                                    data: data, style: style, width: width, text: text
                                }, row, nextCol, vpLeft, vpRight);
                                if (ret && ret.endColumn >= vpLeft)
                                {
                                    return ret
                                }
                            }
                            return keyword_null
                        }
                    }
                };
                _CellOverflowLayoutBuilder.prototype._buildTrailingCellOverflowLayout = function(row)
                {
                    var self = this;
                    var sheet = self._sheet,
                        cachePool = sheet._cachePool,
                        colLayoutModel = self._colLayoutModel,
                        vpLeft = colLayoutModel[0].col,
                        vpRight = colLayoutModel[colLayoutModel.length - 1].col,
                        spanModel = sheet._getSpanModel(),
                        style,
                        data,
                        width,
                        hAlign,
                        maxFindCount = self.maxCellOverflowDistance,
                        colCount = sheet.getColumnCount(),
                        col = vpRight,
                        nextCol,
                        ret;
                    for (var i = 1; i < maxFindCount; i++)
                    {
                        nextCol = col + i;
                        if (nextCol >= colCount)
                        {
                            return keyword_null
                        }
                        if (spanModel.find(row, nextCol))
                        {
                            return keyword_null
                        }
                        data = cachePool.getValue(row, nextCol);
                        width = cachePool.getZoomColWidth(nextCol);
                        if (width > 0 && data !== keyword_null && typeof(data) !== const_undefined)
                        {
                            style = cachePool.getActualStyle(row, nextCol);
                            hAlign = style.hAlign;
                            if (hAlign === 3)
                            {
                                hAlign = Sheets.util.getHAlignByValueType(hAlign, data)
                            }
                            var text;
                            if ((hAlign === 2 || hAlign === 1) && style)
                            {
                                text = Sheets._CacheMgr.getFormattedTextByStyle(sheet, style, data)
                            }
                            if (hAlign === 2)
                            {
                                ret = self._buildCellOverflowLayoutModelForRight({
                                    data: data, style: style, width: width, text: text
                                }, row, nextCol, vpLeft);
                                if (ret && ret.startColumn <= vpRight)
                                {
                                    return ret
                                }
                            }
                            else if (1)
                            {
                                ret = self._buildCellOverflowLayoutModelForCenter({
                                    data: data, style: style, width: width, text: text
                                }, row, nextCol, vpLeft, vpRight);
                                if (ret && ret.startColumn <= vpRight)
                                {
                                    return ret
                                }
                            }
                            return keyword_null
                        }
                    }
                };
                return _CellOverflowLayoutBuilder
            })();
        Sheets._CellOverflowLayoutBuilder = _CellOverflowLayoutBuilder;
        var CutCopyIndicatorManager = (function()
            {
                function CutCopyIndicatorManager(sheet)
                {
                    this._needPaintIndicator = false;
                    this._eventNS = '.cutCopyIndicator';
                    this._ch = keyword_null;
                    this._sheet = sheet;
                    this._bindEvents()
                }
                CutCopyIndicatorManager.prototype.needPaintIndicator = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._needPaintIndicator
                    }
                    if (typeof value === 'boolean')
                    {
                        if (self._needPaintIndicator === value && value === false)
                        {
                            return self
                        }
                        self._needPaintIndicator = value;
                        var sheet = self._sheet;
                        if (sheet)
                        {
                            sheet.invalidate()
                        }
                    }
                    return self
                };
                CutCopyIndicatorManager.prototype.getClipboardHelper = function()
                {
                    var self = this;
                    var sheet = self._sheet;
                    if (sheet && !self._ch)
                    {
                        self._ch = sheet._getClipboardHelper()
                    }
                    return self._ch
                };
                CutCopyIndicatorManager.prototype._bindEvents = function()
                {
                    var self = this,
                        sheet = self._sheet,
                        cacheNeedPaintIndicator = false;
                    if (!sheet)
                    {
                        return
                    }
                    sheet._bind(Sheets.Events.ClipboardChanged + self._eventNS, function(event, args)
                    {
                        self.needPaintIndicator(true)
                    });
                    sheet._bind(Sheets.Events.ValueChanged + self._eventNS, function(event, args)
                    {
                        self.needPaintIndicator(false)
                    });
                    sheet._eventHandler.bind(Sheets.Events.CellChanged + self._eventNS, function(event, args)
                    {
                        self.needPaintIndicator(false)
                    });
                    sheet._bind(Sheets.Events.ColumnChanged + self._eventNS, function(event, data)
                    {
                        if (data.propertyName !== 'resizable' && data.propertyName !== 'width' && data.propertyName !== 'isVisible')
                        {
                            self.needPaintIndicator(false)
                        }
                    });
                    sheet._bind(Sheets.Events.RowChanged + self._eventNS, function(event, data)
                    {
                        if (data.propertyName !== 'resizable' && data.propertyName !== 'height' && data.propertyName !== 'isVisible')
                        {
                            self.needPaintIndicator(false)
                        }
                    });
                    sheet._bind(Sheets.Events.RangeChanged + self._eventNS, function(event, args)
                    {
                        self.needPaintIndicator(false)
                    });
                    sheet._bind(Sheets.Events.ClipboardPasting + self._eventNS, function(event, args)
                    {
                        cacheNeedPaintIndicator = self.needPaintIndicator()
                    });
                    sheet._bind(Sheets.Events.ClipboardPasted + self._eventNS, function(event, args)
                    {
                        var cellRange = args.cellRange,
                            sheet = args.sheet,
                            ch = self.getClipboardHelper();
                        if (cellRange && ch && ch.range && ch.fromSheet && sheet)
                        {
                            if (ch.range.intersect(cellRange.row, cellRange.col, cellRange.rowCount, cellRange.colCount) || !sheet._isPastedInternal(ch.fromSheet, ch.range, sheet, sheet._eventHandler._getClipboardData()))
                            {
                                self.needPaintIndicator(false)
                            }
                            else
                            {
                                self.needPaintIndicator(cacheNeedPaintIndicator)
                            }
                        }
                    })
                };
                CutCopyIndicatorManager.prototype.paintCutCopyIndicator = function(ctx, clipRect, rowViewportIndex, colViewportIndex)
                {
                    if (!this._needPaintIndicator)
                    {
                        return
                    }
                    var sheet = this._sheet,
                        render = sheet._render,
                        ch = this.getClipboardHelper(),
                        tempSpread = sheet.parent;
                    var visible = (tempSpread && tempSpread.cutCopyIndicatorVisible) ? tempSpread.cutCopyIndicatorVisible() : true;
                    if (visible && ch && ch.fromSheet === sheet && ch.range)
                    {
                        var layout = sheet._getSheetLayout(),
                            viewportRect = layout.viewportRect(rowViewportIndex, colViewportIndex),
                            indicatorRect = render._getPaintingRects(rowViewportIndex, colViewportIndex, [ch.range], clipRect)[0];
                        if (indicatorRect && viewportRect)
                        {
                            ctx.save();
                            ctx.rect(viewportRect.x, viewportRect.y, viewportRect.width, viewportRect.height);
                            ctx.clip();
                            if (indicatorRect)
                            {
                                var indicatorBorderColor = (tempSpread && tempSpread.cutCopyIndicatorBorderColor) ? tempSpread.cutCopyIndicatorBorderColor() : 'blue';
                                var color = Sheets._ThemeContext.getColor(sheet, indicatorBorderColor);
                                render.paintDashRect(ctx, indicatorRect, color)
                            }
                            ctx.beginPath();
                            ctx.restore()
                        }
                    }
                };
                CutCopyIndicatorManager.prototype.addRows = function()
                {
                    if (this._needPaintIndicator)
                    {
                        this.needPaintIndicator(false)
                    }
                };
                CutCopyIndicatorManager.prototype.deleteRows = function()
                {
                    if (this._needPaintIndicator)
                    {
                        this.needPaintIndicator(false)
                    }
                };
                CutCopyIndicatorManager.prototype.addColumns = function()
                {
                    if (this._needPaintIndicator)
                    {
                        this.needPaintIndicator(false)
                    }
                };
                CutCopyIndicatorManager.prototype.deleteColumns = function()
                {
                    if (this._needPaintIndicator)
                    {
                        this.needPaintIndicator(false)
                    }
                };
                CutCopyIndicatorManager.prototype.cancelIndicator = function()
                {
                    if (this._needPaintIndicator)
                    {
                        this.needPaintIndicator(false)
                    }
                };
                CutCopyIndicatorManager.prototype._dispose = function()
                {
                    this._sheet._eventHandler.unbind(Sheets.Events.CellChanged + this._eventNS)
                };
                return CutCopyIndicatorManager
            })();
        Sheets.CutCopyIndicatorManager = CutCopyIndicatorManager
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.sheet_ui", ["core.common"]);
        var keyword_undefined = undefined;
        var prop_backColor = 'backColor',
            prop_foreColor = 'foreColor',
            prop_hAlign = 'hAlign',
            prop_vAlign = 'vAlign',
            prop_themeFont = 'themeFont',
            prop_font = 'font',
            prop_formatter = 'formatter',
            prop_borderLeft = 'borderLeft',
            prop_borderTop = 'borderTop',
            prop_borderRight = 'borderRight',
            prop_borderBottom = 'borderBottom',
            prop_locked = 'locked',
            prop_textIndent = 'textIndent',
            prop_wordWrap = 'wordWrap',
            prop_shrinkToFit = 'shrinkToFit',
            prop_backgroundImage = 'backgroundImage',
            prop_backgroundImageLayout = 'backgroundImageLayout',
            prop_validator = "validator",
            prop_cellType = "cellType",
            prop_bindingPath = "bindingPath",
            prop_tabStop = "tabStop",
            prop_textDecoration = "textDecoration",
            prop_imeMode = "imeMode",
            prop_watermark = "watermark";
        var Cell = (function()
            {
                function Cell(sheet, row, col, sheetArea)
                {
                    var self = this;
                    self.sheet = sheet;
                    self.row = row;
                    self.row2 = row;
                    self.col = col;
                    self.col2 = col;
                    if (sheetArea === keyword_undefined || sheetArea === null)
                    {
                        sheetArea = 3
                    }
                    self.sheetArea = sheetArea
                }
                Cell.prototype.value = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getValue(self.row, self.col, self.sheetArea)
                    }
                    else
                    {
                        for (var r = self.row; r <= self.row2; r++)
                        {
                            for (var c = self.col; c <= self.col2; c++)
                            {
                                if (self._isValidIndex(r, c))
                                {
                                    self.sheet.setValue(r, c, value, self.sheetArea)
                                }
                            }
                        }
                        return self
                    }
                };
                Cell.prototype.text = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getText(self.row, self.col, self.sheetArea)
                    }
                    else
                    {
                        for (var r = self.row; r <= self.row2; r++)
                        {
                            for (var c = self.col; c <= self.col2; c++)
                            {
                                if (self._isValidIndex(r, c))
                                {
                                    self.sheet.setText(r, c, value, self.sheetArea)
                                }
                            }
                        }
                        return self
                    }
                };
                Cell.prototype.formula = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getFormula(self.row, self.col, self.sheetArea)
                    }
                    else
                    {
                        for (var r = self.row; r <= self.row2; r++)
                        {
                            for (var c = self.col; c <= self.col2; c++)
                            {
                                if (self._isValidIndex(r, c))
                                {
                                    self.sheet.setFormula(r, c, value, self.sheetArea)
                                }
                            }
                        }
                        return self
                    }
                };
                Cell.prototype.bindingPath = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getBindingPath(self.row, self.col, self.sheetArea)
                    }
                    else
                    {
                        for (var r = self.row; r <= self.row2; r++)
                        {
                            for (var c = self.col; c <= self.col2; c++)
                            {
                                if (self._isValidIndex(r, c))
                                {
                                    self.sheet.setBindingPath(r, c, value, self.sheetArea)
                                }
                            }
                        }
                        return self
                    }
                };
                Cell.prototype.comment = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getComment(self.row, self.col)
                    }
                    else
                    {
                        for (var r = self.row; r <= self.row2; r++)
                        {
                            for (var c = self.col; c <= self.col2; c++)
                            {
                                if (self._isValidIndex(r, c))
                                {
                                    self.sheet.setComment(r, c, value)
                                }
                            }
                        }
                        return self
                    }
                };
                Cell.prototype.tag = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getTag(self.row, self.col, self.sheetArea)
                    }
                    else
                    {
                        for (var r = self.row; r <= self.row2; r++)
                        {
                            for (var c = self.col; c <= self.col2; c++)
                            {
                                if (self._isValidIndex(r, c))
                                {
                                    self.sheet.setTag(r, c, value, self.sheetArea)
                                }
                            }
                        }
                        return self
                    }
                };
                Cell.prototype.dataValidator = function(value)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_validator) : this._setStyleProperty(prop_validator, value)
                };
                Cell.prototype.cellType = function(value)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_cellType) : this._setStyleProperty(prop_cellType, value)
                };
                Cell.prototype.backgroundImage = function(value)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_backgroundImage) : this._setStyleProperty(prop_backgroundImage, value)
                };
                Cell.prototype.backgroundImageLayout = function(layout)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_backgroundImageLayout) : this._setStyleProperty(prop_backgroundImageLayout, layout)
                };
                Cell.prototype.backColor = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_backColor) : this._setStyleProperty(prop_backColor, value)
                };
                Cell.prototype.foreColor = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_foreColor) : this._setStyleProperty(prop_foreColor, value)
                };
                Cell.prototype.hAlign = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_hAlign) : this._setStyleProperty(prop_hAlign, value)
                };
                Cell.prototype.vAlign = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_vAlign) : this._setStyleProperty(prop_vAlign, value)
                };
                Cell.prototype.themeFont = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_themeFont) : this._setStyleProperty(prop_themeFont, value)
                };
                Cell.prototype.font = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_font) : this._setStyleProperty(prop_font, value)
                };
                Cell.prototype.formatter = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_formatter) : this._setStyleProperty(prop_formatter, value)
                };
                Cell.prototype.borderLeft = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderLeft) : this._setStyleProperty(prop_borderLeft, value)
                };
                Cell.prototype.borderTop = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderTop) : this._setStyleProperty(prop_borderTop, value)
                };
                Cell.prototype.borderRight = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderRight) : this._setStyleProperty(prop_borderRight, value)
                };
                Cell.prototype.borderBottom = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderBottom) : this._setStyleProperty(prop_borderBottom, value)
                };
                Cell.prototype.locked = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_locked) : this._setStyleProperty(prop_locked, value)
                };
                Cell.prototype.textIndent = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_textIndent) : this._setStyleProperty(prop_textIndent, value)
                };
                Cell.prototype.wordWrap = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_wordWrap) : this._setStyleProperty(prop_wordWrap, value)
                };
                Cell.prototype.shrinkToFit = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_shrinkToFit) : this._setStyleProperty(prop_shrinkToFit, value)
                };
                Cell.prototype.tabStop = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_tabStop) : this._setStyleProperty(prop_tabStop, value)
                };
                Cell.prototype.textDecoration = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_textDecoration) : this._setStyleProperty(prop_textDecoration, value)
                };
                Cell.prototype.watermark = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_watermark) : this._setStyleProperty(prop_watermark, value)
                };
                Cell.prototype.imeMode = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_imeMode) : this._setStyleProperty(prop_imeMode, value)
                };
                Cell.prototype.clearStyleProperty = function(propertyName)
                {
                    var self = this;
                    for (var r = self.row; r <= self.row2; r++)
                    {
                        for (var c = self.col; c <= self.col2; c++)
                        {
                            if (self._isValidIndex(r, c))
                            {
                                var style = self.sheet.getStyleImp(r, c, self.sheetArea);
                                if (style)
                                {
                                    style.clear(propertyName)
                                }
                            }
                        }
                    }
                };
                Cell.prototype._getStyleProperty = function(propertyName)
                {
                    var self = this;
                    return self.sheet.getStyleProperty(self.row, self.col, propertyName, self.sheetArea)
                };
                Cell.prototype._setStyleProperty = function(propertyName, value)
                {
                    var self = this;
                    for (var r = self.row; r <= self.row2; r++)
                    {
                        for (var c = self.col; c <= self.col2; c++)
                        {
                            if (self._isValidIndex(r, c))
                            {
                                var style = self.sheet.getStyleImp(r, c, self.sheetArea);
                                if (!style)
                                {
                                    style = new Sheets.Style
                                }
                                style[propertyName] = value;
                                self.sheet.setStyle(r, c, style, self.sheetArea)
                            }
                        }
                    }
                    return self
                };
                Cell.prototype._isValidIndex = function(row, col)
                {
                    var self = this,
                        sheet = self.sheet,
                        sheetArea = self.sheetArea;
                    if (sheet)
                    {
                        var rowCount = sheet.getRowCount(sheetArea);
                        var colCount = sheet.getColumnCount(sheetArea);
                        if ((((0 <= row) && (row < rowCount)) && (0 <= col)) && (col < colCount))
                        {
                            return true
                        }
                    }
                    return false
                };
                return Cell
            })();
        Sheets.Cell = Cell;
        var Row = (function()
            {
                function Row(sheet, index, sheetArea)
                {
                    var self = this;
                    self.sheet = sheet;
                    self.index = index;
                    self.index2 = index;
                    if (sheetArea === keyword_undefined || sheetArea === null)
                    {
                        sheetArea = 3
                    }
                    self.sheetArea = sheetArea
                }
                Row.prototype.height = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getRowHeight(self.index, self.sheetArea)
                    }
                    else
                    {
                        for (var r = self.index; r <= self.index2; r++)
                        {
                            if (self._isValidIndex(r))
                            {
                                self.sheet.setRowHeight(r, value, self.sheetArea)
                            }
                        }
                        return self
                    }
                };
                Row.prototype.visible = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getRowVisible(self.index, self.sheetArea)
                    }
                    else
                    {
                        for (var r = self.index; r <= self.index2; r++)
                        {
                            if (self._isValidIndex(r))
                            {
                                self.sheet.setRowVisible(r, value, self.sheetArea)
                            }
                        }
                        return self
                    }
                };
                Row.prototype.resizable = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getRowResizable(self.index, self.sheetArea)
                    }
                    else
                    {
                        for (var r = self.index; r <= self.index2; r++)
                        {
                            if (self._isValidIndex(r))
                            {
                                self.sheet.setRowResizable(r, value, self.sheetArea)
                            }
                        }
                        return self
                    }
                };
                Row.prototype.dataValidator = function(value)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_validator) : this._setStyleProperty(prop_validator, value)
                };
                Row.prototype.cellType = function(value)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_cellType) : this._setStyleProperty(prop_cellType, value)
                };
                Row.prototype.backgroundImage = function(value)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_backgroundImage) : this._setStyleProperty(prop_backgroundImage, value)
                };
                Row.prototype.backgroundImageLayout = function(layout)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_backgroundImageLayout) : this._setStyleProperty(prop_backgroundImageLayout, layout)
                };
                Row.prototype.backColor = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_backColor) : this._setStyleProperty(prop_backColor, value)
                };
                Row.prototype.foreColor = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_foreColor) : this._setStyleProperty(prop_foreColor, value)
                };
                Row.prototype.hAlign = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_hAlign) : this._setStyleProperty(prop_hAlign, value)
                };
                Row.prototype.vAlign = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_vAlign) : this._setStyleProperty(prop_vAlign, value)
                };
                Row.prototype.themeFont = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_themeFont) : this._setStyleProperty(prop_themeFont, value)
                };
                Row.prototype.font = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_font) : this._setStyleProperty(prop_font, value)
                };
                Row.prototype.formatter = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_formatter) : this._setStyleProperty(prop_formatter, value)
                };
                Row.prototype.borderLeft = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderLeft) : this._setStyleProperty(prop_borderLeft, value)
                };
                Row.prototype.borderTop = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderTop) : this._setStyleProperty(prop_borderTop, value)
                };
                Row.prototype.borderRight = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderRight) : this._setStyleProperty(prop_borderRight, value)
                };
                Row.prototype.borderBottom = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderBottom) : this._setStyleProperty(prop_borderBottom, value)
                };
                Row.prototype.locked = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_locked) : this._setStyleProperty(prop_locked, value)
                };
                Row.prototype.textIndent = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_textIndent) : this._setStyleProperty(prop_textIndent, value)
                };
                Row.prototype.wordWrap = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_wordWrap) : this._setStyleProperty(prop_wordWrap, value)
                };
                Row.prototype.shrinkToFit = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_shrinkToFit) : this._setStyleProperty(prop_shrinkToFit, value)
                };
                Row.prototype.tabStop = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_tabStop) : this._setStyleProperty(prop_tabStop, value)
                };
                Row.prototype.textDecoration = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_textDecoration) : this._setStyleProperty(prop_textDecoration, value)
                };
                Row.prototype.imeMode = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_imeMode) : this._setStyleProperty(prop_imeMode, value)
                };
                Row.prototype.watermark = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_watermark) : this._setStyleProperty(prop_watermark, value)
                };
                Row.prototype.clearStyleProperty = function(propertyName)
                {
                    var self = this,
                        sheet = self.sheet;
                    for (var r = self.index; r <= self.index2; r++)
                    {
                        if (self._isValidIndex(r))
                        {
                            var style = sheet.getStyleImp(r, -1, self.sheetArea);
                            if (style)
                            {
                                style.clear(propertyName);
                                sheet.triggerRowChanged({
                                    sheet: sheet, sheetName: sheet._name, row: r, sheetArea: self.sheetArea, propertyName: propertyName
                                })
                            }
                        }
                    }
                };
                Row.prototype.tag = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getTag(self.index, -1, self.sheetArea)
                    }
                    else
                    {
                        for (var r = self.index; r <= self.index2; r++)
                        {
                            if (self._isValidIndex(r))
                            {
                                self.sheet.setTag(r, -1, value, self.sheetArea)
                            }
                        }
                        return self
                    }
                };
                Row.prototype._getStyleProperty = function(propertyName)
                {
                    var style = this.sheet.getStyleImp(this.index, -1, this.sheetArea);
                    return style ? style[propertyName] : keyword_undefined
                };
                Row.prototype._setStyleProperty = function(propertyName, value)
                {
                    var self = this;
                    for (var r = self.index; r <= self.index2; r++)
                    {
                        if (self._isValidIndex(r))
                        {
                            var style = self.sheet.getStyleImp(r, -1, self.sheetArea);
                            if (!style)
                            {
                                style = new Sheets.Style
                            }
                            style[propertyName] = value;
                            self.sheet.setStyle(r, -1, style, self.sheetArea)
                        }
                    }
                    return self
                };
                Row.prototype._isValidIndex = function(row)
                {
                    if (this.sheet)
                    {
                        var rowCount = this.sheet.getRowCount(this.sheetArea);
                        if ((0 <= row) && (row < rowCount))
                        {
                            return true
                        }
                    }
                    return false
                };
                return Row
            })();
        Sheets.Row = Row;
        var Column = (function()
            {
                function Column(sheet, index, sheetArea)
                {
                    var self = this;
                    self.sheet = sheet;
                    self.index = index;
                    self.index2 = index;
                    if (sheetArea === keyword_undefined || sheetArea === null)
                    {
                        sheetArea = 3
                    }
                    self.sheetArea = sheetArea
                }
                Column.prototype.width = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getColumnWidth(self.index, self.sheetArea)
                    }
                    else
                    {
                        for (var c = self.index; c <= self.index2; c++)
                        {
                            if (self._isValidIndex(c))
                            {
                                self.sheet.setColumnWidth(c, value, self.sheetArea)
                            }
                        }
                        return self
                    }
                };
                Column.prototype.visible = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getColumnVisible(self.index, self.sheetArea)
                    }
                    else
                    {
                        for (var c = self.index; c <= self.index2; c++)
                        {
                            if (self._isValidIndex(c))
                            {
                                self.sheet.setColumnVisible(c, value, self.sheetArea)
                            }
                        }
                        return self
                    }
                };
                Column.prototype.resizable = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getColumnResizable(self.index, self.sheetArea)
                    }
                    else
                    {
                        for (var c = self.index; c <= self.index2; c++)
                        {
                            if (self._isValidIndex(c))
                            {
                                self.sheet.setColumnResizable(c, value, self.sheetArea)
                            }
                        }
                        return self
                    }
                };
                Column.prototype.dataValidator = function(value)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_validator) : this._setStyleProperty(prop_validator, value)
                };
                Column.prototype.cellType = function(value)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_cellType) : this._setStyleProperty(prop_cellType, value)
                };
                Column.prototype.backgroundImage = function(value)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_backgroundImage) : this._setStyleProperty(prop_backgroundImage, value)
                };
                Column.prototype.backgroundImageLayout = function(layout)
                {
                    return arguments.length == 0 ? this._getStyleProperty(prop_backgroundImageLayout) : this._setStyleProperty(prop_backgroundImageLayout, layout)
                };
                Column.prototype.backColor = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_backColor) : this._setStyleProperty(prop_backColor, value)
                };
                Column.prototype.foreColor = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_foreColor) : this._setStyleProperty(prop_foreColor, value)
                };
                Column.prototype.hAlign = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_hAlign) : this._setStyleProperty(prop_hAlign, value)
                };
                Column.prototype.vAlign = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_vAlign) : this._setStyleProperty(prop_vAlign, value)
                };
                Column.prototype.themeFont = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_themeFont) : this._setStyleProperty(prop_themeFont, value)
                };
                Column.prototype.font = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_font) : this._setStyleProperty(prop_font, value)
                };
                Column.prototype.formatter = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_formatter) : this._setStyleProperty(prop_formatter, value)
                };
                Column.prototype.borderLeft = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderLeft) : this._setStyleProperty(prop_borderLeft, value)
                };
                Column.prototype.borderTop = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderTop) : this._setStyleProperty(prop_borderTop, value)
                };
                Column.prototype.borderRight = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderRight) : this._setStyleProperty(prop_borderRight, value)
                };
                Column.prototype.borderBottom = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_borderBottom) : this._setStyleProperty(prop_borderBottom, value)
                };
                Column.prototype.locked = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_locked) : this._setStyleProperty(prop_locked, value)
                };
                Column.prototype.textIndent = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_textIndent) : this._setStyleProperty(prop_textIndent, value)
                };
                Column.prototype.wordWrap = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_wordWrap) : this._setStyleProperty(prop_wordWrap, value)
                };
                Column.prototype.shrinkToFit = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_shrinkToFit) : this._setStyleProperty(prop_shrinkToFit, value)
                };
                Column.prototype.tabStop = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_tabStop) : this._setStyleProperty(prop_tabStop, value)
                };
                Column.prototype.textDecoration = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_textDecoration) : this._setStyleProperty(prop_textDecoration, value)
                };
                Column.prototype.imeMode = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_imeMode) : this._setStyleProperty(prop_imeMode, value)
                };
                Column.prototype.watermark = function(value)
                {
                    return arguments.length === 0 ? this._getStyleProperty(prop_watermark) : this._setStyleProperty(prop_watermark, value)
                };
                Column.prototype.clearStyleProperty = function(propertyName)
                {
                    var self = this,
                        sheet = self.sheet;
                    for (var c = self.index; c <= self.index2; c++)
                    {
                        if (self._isValidIndex(c))
                        {
                            var style = sheet.getStyleImp(-1, c, self.sheetArea);
                            if (style)
                            {
                                style.clear(propertyName);
                                sheet.triggerColumnChanged({
                                    sheet: sheet, sheetName: sheet._name, col: c, sheetArea: self.sheetArea, propertyName: propertyName
                                })
                            }
                        }
                    }
                };
                Column.prototype.tag = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self.sheet.getTag(-1, self.index, self.sheetArea)
                    }
                    else
                    {
                        for (var c = self.index; c <= self.index2; c++)
                        {
                            if (self._isValidIndex(c))
                            {
                                self.sheet.setTag(-1, c, value, self.sheetArea)
                            }
                        }
                        return self
                    }
                };
                Column.prototype._getStyleProperty = function(propertyName)
                {
                    var style = this.sheet.getStyleImp(-1, this.index, this.sheetArea);
                    return style ? style[propertyName] : keyword_undefined
                };
                Column.prototype._setStyleProperty = function(propertyName, value)
                {
                    var self = this;
                    for (var c = self.index; c <= self.index2; c++)
                    {
                        if (self._isValidIndex(c))
                        {
                            var style = self.sheet.getStyleImp(-1, c, self.sheetArea);
                            if (!style)
                            {
                                style = new Sheets.Style
                            }
                            style[propertyName] = value;
                            self.sheet.setStyle(-1, c, style, self.sheetArea)
                        }
                    }
                    return self
                };
                Column.prototype._isValidIndex = function(col)
                {
                    if (this.sheet)
                    {
                        var colCount = this.sheet.getColumnCount(this.sheetArea);
                        if ((0 <= col) && (col < colCount))
                        {
                            return true
                        }
                    }
                    return false
                };
                return Column
            })();
        Sheets.Column = Column
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.sheet", ["core.common", "core.stringResource", "core.sheet_event", "core.sheet_render", "core.basecelltype", "core.sheet_ui", "core.sheet_model", "core.sheet_action", "core.sheet_border"]);
        var keyword_null = null,
            keyword_undefined = undefined,
            Math_min = Math.min,
            Math_max = Math.max,
            Math_floor = Math.floor,
            const_undefined = "undefined",
            const_function = "function",
            const_number = "number",
            const_string = "string",
            const_boolean = "boolean";
        var document = window.document;
        var ko = window.ko;
        var Sheet = (function()
            {
                function Sheet(name, delayInit)
                {
                    this._styleComposeCache = [{}, {}, {}, {}];
                    this._isDisposingValidationUI = false;
                    var self = this;
                    self._name = "";
                    self._id = Sheet.sheetId++;
                    self._visible = true;
                    self.defaults = keyword_null;
                    self.gridline = keyword_null;
                    self.borderColor = "black";
                    self.borderWidth = 0;
                    self._zoomFactor = 1;
                    self.frozenRowCount = 0;
                    self.frozenColCount = 0;
                    self.rowHeaderVisible = true;
                    self.colHeaderVisible = true;
                    self.rowHeaderAutoText = 1;
                    self.colHeaderAutoText = 2;
                    self.rowHeaderAutoTextIndex = -1;
                    self.colHeaderAutoTextIndex = -1;
                    self.rowRangeGroup = keyword_null;
                    self.colRangeGroup = keyword_null;
                    self._activeRowIndex = 0;
                    self._activeColIndex = 0;
                    self.activeRowViewportIndex = 0;
                    self.activeColViewportIndex = 0;
                    self._allowCellOverflow = false;
                    self.maxCellOverflowDistance = 100;
                    self.showEditingLocator = true;
                    self.keyMap = keyword_null;
                    self.isProtected = false;
                    self._allowUndo = true;
                    self._paintSuspended = false;
                    self._layoutSuspended = 0;
                    self.checkingChanges = false;
                    self.autoGenerateColumns = true;
                    self._allowEditorReservedLocations = true;
                    self._sheetTabColor = keyword_null;
                    self._frozenlineColor = "black";
                    self._frozenTrailingRowCount = 0;
                    self._frozenTrailingColCount = 0;
                    self._rowLayoutCache = keyword_null;
                    self._colLayoutCache = keyword_null;
                    self._dragRect = keyword_null;
                    self._scrollTopRow = 0;
                    self._scrollLeftCol = 0;
                    self._activeRowDirty = false;
                    self.floatingObjectKeyMap = keyword_null;
                    self._commentKeyMap = keyword_null;
                    self._cachePool = new Sheets._CachePool(this);
                    self._composedDefaultStyle = {};
                    self._defaultRowCount = 200;
                    self._defaultColCount = 20;
                    self._defaultRowHeaderColumnCount = 1;
                    self._defaultColHeaderRowCount = 1;
                    self._defaultRowHeight = 20;
                    self._defaultColWidth = 62;
                    self._defaultRowHeaderColWidth = 40;
                    self._defaultColHeaderRowHeight = 20;
                    self._defaultGridLineColor = "#d0d7e5";
                    self._defaultShowVerticalGridline = true;
                    self._defaultShowHorizontalGridline = true;
                    self.fontHeightCache = keyword_null;
                    self._enableFormulaTextbox = true;
                    self._tag = null;
                    if (!delayInit)
                    {
                        self._init(name)
                    }
                }
                Sheet.prototype._addFloatingOjectInternal = function(item)
                {
                    var self = this,
                        floatingObjectArray = self._floatingObjectArray;
                    if (!floatingObjectArray || !Sheets.features.floatingObject)
                    {
                        return
                    }
                    try
                    {
                        var oldState = self.isPaintSuspended();
                        self.isPaintSuspended(true);
                        floatingObjectArray.add(item)
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype._findFloatingObjectInternal = function(name)
                {
                    var floatingObjectArray = this._floatingObjectArray;
                    if (Sheets.features.floatingObject && floatingObjectArray && floatingObjectArray.length > 0)
                    {
                        return floatingObjectArray.find(name)
                    }
                    return keyword_null
                };
                Sheet.prototype._removeFloatingObjectInternal = function(name)
                {
                    var floatingObjectArray = this._floatingObjectArray;
                    if (Sheets.features.floatingObject && floatingObjectArray && floatingObjectArray.length)
                    {
                        var item = floatingObjectArray.find(name);
                        if (item)
                        {
                            floatingObjectArray.remove(item)
                        }
                    }
                };
                Sheet.prototype._saveAndClearSheetSelections = function()
                {
                    var self = this;
                    var selection = self._selectionModel;
                    if (selection && selection.length > 0)
                    {
                        var selectionModelCache = new Sheets._SelectionModel;
                        self._selectionModelCache = selectionModelCache;
                        selectionModelCache.selectionPolicy = selection.selectionPolicy;
                        selectionModelCache.selectionUnit = selection.selectionUnit;
                        selectionModelCache.activeSelectedRangeIndex = selection.activeSelectedRangeIndex;
                        for (var index = 0, len = selection.length; index < len; index++)
                        {
                            selectionModelCache.push(selection[index])
                        }
                        self._clearSelectionImp();
                        for (var index = 0, len = selectionModelCache.length; index < len; index++)
                        {
                            self._render.repaintSelection(selectionModelCache[index])
                        }
                    }
                };
                Sheet.prototype._loadAndSetSheetSelections = function()
                {
                    var selection = this._selectionModelCache;
                    if (selection)
                    {
                        var selectionModel = new Sheets._SelectionModel;
                        this._selectionModel = selectionModel;
                        selectionModel.selectionPolicy = selection.selectionPolicy;
                        selectionModel.selectionUnit = selection.selectionUnit;
                        selectionModel.activeSelectedRangeIndex = selection.activeSelectedRangeIndex;
                        for (var index = 0, len = selection.length; index < len; index++)
                        {
                            selectionModel.push(selection[index])
                        }
                    }
                };
                Sheet.prototype.unSelectAllFloatingObjects = function()
                {
                    var floatingObjectArray = this._floatingObjectArray;
                    if (Sheets.features.floatingObject && floatingObjectArray && floatingObjectArray.length > 0)
                    {
                        for (var i = 0; i < floatingObjectArray.length; i++)
                        {
                            floatingObjectArray[i].isSelected(false)
                        }
                    }
                };
                Sheet.prototype.refreshObjectsAboveSheet = function()
                {
                    var self = this,
                        floatingObjectArray = self._floatingObjectArray;
                    if (Sheets.features.floatingObject && floatingObjectArray)
                    {
                        floatingObjectArray.isNeedToUpdateLayout = true
                    }
                };
                Sheet.prototype.unSelectAllComments = function()
                {
                    var self = this;
                    if (self._commentManager)
                    {
                        self._commentManager.deactivateComment()
                    }
                };
                Sheet.prototype.addFloatingObject = function(item)
                {
                    if (!this._floatingObjectArray || !Sheets.features.floatingObject || !(item instanceof Sheets.CustomFloatingObject))
                    {
                        return
                    }
                    this._addFloatingOjectInternal(item)
                };
                Sheet.prototype.findFloatingObject = function(name)
                {
                    if (!Sheets.features.floatingObject)
                    {
                        return keyword_null
                    }
                    var floatingObject = this._findFloatingObjectInternal(name);
                    if (floatingObject instanceof Sheets.CustomFloatingObject)
                    {
                        return floatingObject
                    }
                    return keyword_null
                };
                Sheet.prototype.removeFloatingObject = function(name)
                {
                    if (!Sheets.features.floatingObject)
                    {
                        return
                    }
                    var floatingObject = this._findFloatingObjectInternal(name);
                    if (floatingObject instanceof Sheets.CustomFloatingObject)
                    {
                        this._floatingObjectArray.remove(floatingObject)
                    }
                };
                Sheet.prototype.getFloatingObjects = function()
                {
                    var floatingObjects = [];
                    if (!Sheets.features.floatingObject)
                    {
                        return floatingObjects
                    }
                    var floatingObjectArray = this._floatingObjectArray;
                    for (var index = 0, len = floatingObjectArray.length; index < len; index++)
                    {
                        var floatingObject = floatingObjectArray[index];
                        if (floatingObject instanceof Sheets.CustomFloatingObject)
                        {
                            floatingObjects.push(floatingObject)
                        }
                    }
                    return floatingObjects
                };
                Sheet.prototype.addPicture = function(name, src, startRow, startColumn, endRow, endColumn, startRowOffset, startColumnOffset, endRowOffset, endColumnOffset)
                {
                    var self = this,
                        floatingObjectArray = self._floatingObjectArray;
                    if (!floatingObjectArray || !Sheets.features.floatingObject)
                    {
                        return keyword_null
                    }
                    try
                    {
                        var oldState = self.isPaintSuspended();
                        self.isPaintSuspended(true);
                        var picture = new Sheets.Picture(name);
                        picture.owner(self);
                        picture.src(src);
                        picture.startRow(startRow);
                        picture.startColumn(startColumn);
                        picture.endRow(endRow);
                        picture.endColumn(endColumn);
                        if (typeof endRow === const_undefined || typeof endColumn === const_undefined)
                        {
                            picture._isTakeOriginalSize = true
                        }
                        if (typeof startRowOffset === 'number')
                        {
                            picture.startRowOffset(startRowOffset)
                        }
                        if (typeof startColumnOffset === 'number')
                        {
                            picture.startColumnOffset(startColumnOffset)
                        }
                        if (typeof endRowOffset === 'number')
                        {
                            picture.endRowOffset(endRowOffset)
                        }
                        if (typeof endColumnOffset === 'number')
                        {
                            picture.endColumnOffset(endColumnOffset)
                        }
                        floatingObjectArray.add(picture);
                        return picture
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.findPicture = function(name)
                {
                    if (!Sheets.features.floatingObject)
                    {
                        return keyword_null
                    }
                    var floatingObject = this._findFloatingObjectInternal(name);
                    if (floatingObject instanceof Sheets.Picture)
                    {
                        return floatingObject
                    }
                    return keyword_null
                };
                Sheet.prototype.removePicture = function(name)
                {
                    if (!Sheets.features.floatingObject)
                    {
                        return
                    }
                    var floatingObject = this._findFloatingObjectInternal(name);
                    if (floatingObject instanceof Sheets.Picture)
                    {
                        this._floatingObjectArray.remove(floatingObject)
                    }
                };
                Sheet.prototype.getPictures = function()
                {
                    var floatingObjects = [];
                    if (!Sheets.features.floatingObject)
                    {
                        return floatingObjects
                    }
                    var floatingObjectArray = this._floatingObjectArray;
                    for (var index = 0, len = floatingObjectArray.length; index < len; index++)
                    {
                        var floatingObject = floatingObjectArray[index];
                        if (floatingObject instanceof Sheets.Picture)
                        {
                            floatingObjects.push(floatingObject)
                        }
                    }
                    return floatingObjects
                };
                Sheet.prototype.setFloatingObjectZIndex = function(name, zIndex)
                {
                    if (isNaN(zIndex) || !Sheets.features.floatingObject)
                    {
                        return
                    }
                    var render = this._render,
                        floatingObjectRenderManager = render && render._floatingObjectRenderManager;
                    if (floatingObjectRenderManager)
                    {
                        var i,
                            j,
                            rowCount,
                            colCount;
                        for (i = 0, rowCount = floatingObjectRenderManager.length; i < rowCount; i++)
                        {
                            var rowRenderManagers = floatingObjectRenderManager[i];
                            if (rowRenderManagers)
                            {
                                for (j = 0, colCount = rowRenderManagers.length; j < colCount; j++)
                                {
                                    var renderManager = rowRenderManagers[j];
                                    if (renderManager)
                                    {
                                        renderManager.setFloatingObjectZIndex(name, zIndex)
                                    }
                                }
                            }
                        }
                    }
                };
                Sheet.prototype.getFloatingObjectZIndex = function(name)
                {
                    var render = this._render,
                        floatingObjectRenderManager = render && render._floatingObjectRenderManager;
                    if (Sheets.features.floatingObject && floatingObjectRenderManager)
                    {
                        var i,
                            j,
                            rowCount,
                            colCount;
                        for (i = 0, rowCount = floatingObjectRenderManager.length; i < rowCount; i++)
                        {
                            var rowRenderManagers = floatingObjectRenderManager[i];
                            if (rowRenderManagers)
                            {
                                for (j = 0, colCount = rowRenderManagers.length; j < colCount; j++)
                                {
                                    var renderManager = rowRenderManagers[j];
                                    if (renderManager)
                                    {
                                        return renderManager.getFloatingObjectZIndex(name)
                                    }
                                }
                            }
                        }
                    }
                    return -1
                };
                Sheet.prototype.getDataSource = function()
                {
                    var bindingManager = this._bindingManager;
                    if (bindingManager)
                    {
                        return bindingManager.getSource()
                    }
                    return keyword_null
                };
                Sheet.prototype.getBindingPath = function(row, col)
                {
                    var m = this._sheetModelManager.getDataModel(3);
                    if (m)
                    {
                        return m.getBindingPath(row, col)
                    }
                    return keyword_null
                };
                Sheet.prototype.setBindingPath = function(row, col, path)
                {
                    var self = this;
                    return self._bindToAutoRefresh(function(row, col, path)
                        {
                            var m = self._getModel(3);
                            if (m)
                            {
                                m.setBindingPath(row, col, path)
                            }
                            return self
                        })(row, col, path)
                };
                Sheet.prototype.setDataSource = function(data, reset)
                {
                    var self = this,
                        bm = self._bindingManager;
                    if (!bm || bm.getSource() === data)
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(data, reset)
                    {
                        if (reset)
                        {
                            self.resetImp()
                        }
                        bm = self._bindingManager;
                        if (!data)
                        {
                            if (Sheets._BindingManager.isCellBindingSource(bm.getSource()))
                            {
                                var tableManager = self._tableManager;
                                if (tableManager)
                                {
                                    tableManager.resetTablesBindingManager()
                                }
                            }
                            self._bindingManager = new Sheets._BindingManager(self);
                            if (self.getCalcService() && !self.getCalcService().IsSuspended())
                            {
                                self.recalcAll()
                            }
                        }
                        else
                        {
                            bm.bind(data);
                            if (Sheets._BindingManager.isCellBindingSource(data))
                            {
                                var tableManager = self._tableManager;
                                if (tableManager)
                                {
                                    tableManager.resetTablesBindingManager();
                                    var tables = tableManager.getTables();
                                    self.suspendCalcService();
                                    for (var i = 0, count = tables.length; i < count; i++)
                                    {
                                        var table = tables[i];
                                        if (table)
                                        {
                                            table._applyBindingPath()
                                        }
                                    }
                                    self.resumeCalcService()
                                }
                                self.clearPendingChanges();
                                return
                            }
                            self._setRowCountInternal(bm.getRowCount());
                            if (self.autoGenerateColumns)
                            {
                                self.setColumnCount(bm.getColumnCount());
                                var colInfos = self._sheetModelManager.getColInfos();
                                var fields = bm.getFields();
                                if (fields)
                                {
                                    for (var j = 0, fieldCount = fields.length; j < fieldCount; j++)
                                    {
                                        colInfos._setItem(j, {name: fields[j]})
                                    }
                                }
                            }
                            if (self.getCalcService() && !self.getCalcService().IsSuspended())
                            {
                                self.recalcAll()
                            }
                        }
                        self.clearPendingChanges()
                    })(data, reset)
                };
                Sheet.prototype.bindColumn = function(index, column)
                {
                    var self = this;
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        if (typeof column === const_string)
                        {
                            column = {name: column}
                        }
                        this._sheetModelManager.getColInfos()._setItem(index, column);
                        if (column && column.formatter)
                        {
                            self.setFormatter(-1, index, column.formatter)
                        }
                        if (column && column.cellType)
                        {
                            self.setCellType(-1, index, column.cellType)
                        }
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.bindColumns = function(columns)
                {
                    var self = this;
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        if (columns)
                        {
                            var colInfos = self._sheetModelManager.getColInfos();
                            if (!isNaN(columns.length))
                            {
                                self.setColumnCount(columns.length)
                            }
                            for (var i = 0; i < columns.length; i++)
                            {
                                var colInfo = columns[i];
                                if (typeof colInfo === const_string)
                                {
                                    colInfo = {name: colInfo}
                                }
                                colInfos._setItem(i, colInfo);
                                if (colInfo && colInfo.formatter)
                                {
                                    self.setFormatter(-1, i, colInfo.formatter)
                                }
                                if (colInfo && colInfo.cellType)
                                {
                                    self.setCellType(-1, i, colInfo.cellType)
                                }
                            }
                        }
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.getDataContext = function()
                {
                    return this.dataContext
                };
                Sheet.prototype.setDataContext = function(dataContext)
                {
                    this.dataContext = dataContext;
                    this.load()
                };
                Sheet.prototype.getDataItem = function(row)
                {
                    var self = this,
                        bm = self._bindingManager,
                        colInfos = self._sheetModelManager.getColInfos();
                    if (!bm || bm.getRowCount() === 0)
                    {
                        return keyword_null
                    }
                    var cc = self.getColumnCount();
                    var t = {};
                    var rowItem = bm.getDataItem(row);
                    if (rowItem)
                    {
                        for (var x in rowItem)
                        {
                            if (rowItem.hasOwnProperty(x) && typeof(x) !== const_function)
                            {
                                t[x] = rowItem[x]
                            }
                        }
                    }
                    for (var i = 0; i < cc; i++)
                    {
                        var ci = colInfos._getItem(i);
                        if (ci && ci.name && ci.name.length > 0)
                        {
                            t[ci.name] = self.getValue(row, i)
                        }
                    }
                    return t
                };
                Sheet.prototype.getDirtyRows = function()
                {
                    var self = this;
                    var rows = [];
                    var dirtyNodes = self._sheetModelManager.dataModel().dirtyNodes;
                    if (dirtyNodes)
                    {
                        var bm = self._bindingManager,
                            ds = self.getDataSource();
                        for (var t in dirtyNodes)
                        {
                            var dnt = dirtyNodes[t];
                            if (dirtyNodes.hasOwnProperty(t) && dnt && dnt.rs === "e")
                            {
                                rows.push({
                                    row: t, item: self.getDataItem(t), originalItem: dnt.originalItem
                                })
                            }
                        }
                    }
                    return rows
                };
                Sheet.prototype.getInsertRows = function()
                {
                    var rows = [];
                    var dirtyNodes = this._sheetModelManager.dataModel().dirtyNodes;
                    if (dirtyNodes)
                    {
                        for (var t in dirtyNodes)
                        {
                            if (dirtyNodes.hasOwnProperty(t) && dirtyNodes[t] && dirtyNodes[t].rs === "n")
                            {
                                rows.push({
                                    row: t, item: this.getDataItem(t)
                                })
                            }
                        }
                    }
                    return rows
                };
                Sheet.prototype.getDirtyCells = function(row, col, rowCount, colCount)
                {
                    var self = this;
                    if (row === keyword_undefined || row === keyword_null)
                    {
                        row = -1
                    }
                    if (col === keyword_undefined || col === keyword_null)
                    {
                        col = -1
                    }
                    if (rowCount === keyword_undefined || rowCount <= 0)
                    {
                        rowCount = 1
                    }
                    if (colCount === keyword_undefined || colCount <= 0)
                    {
                        colCount = 1
                    }
                    var cells = [];
                    var dirtyNodes = self._sheetModelManager.dataModel().dirtyNodes;
                    if (!$.isEmptyObject(dirtyNodes))
                    {
                        var dnr;
                        if (row >= 0 && col >= 0)
                        {
                            for (var r = row; r < row + rowCount; r++)
                            {
                                if (dirtyNodes[r] && dirtyNodes[r].rs === "e")
                                {
                                    dnr = dirtyNodes[r];
                                    for (var c = col; c < col + colCount; c++)
                                    {
                                        if (dnr[c])
                                        {
                                            cells.push(self._getDirtyValue(r, c, dnr[c].oldValue))
                                        }
                                    }
                                }
                            }
                        }
                        else if (row >= 0 && col < 0)
                        {
                            for (var r = row; r < row + rowCount; r++)
                            {
                                if (dirtyNodes[r] && dirtyNodes[r].rs === "e")
                                {
                                    dnr = dirtyNodes[r];
                                    for (var columnIndex in dnr)
                                    {
                                        var columnIndexNum = parseInt(columnIndex);
                                        if (!isNaN(columnIndexNum) && dnr.hasOwnProperty(columnIndex) && dnr[columnIndex])
                                        {
                                            cells.push(self._getDirtyValue(r, columnIndexNum, dnr[columnIndex].oldValue))
                                        }
                                    }
                                }
                            }
                        }
                        else if (row < 0 && col >= 0)
                        {
                            for (var c = col; c < col + colCount; c++)
                            {
                                for (var rowIndex in dirtyNodes)
                                {
                                    if (dirtyNodes[rowIndex] && dirtyNodes[rowIndex].rs === "e")
                                    {
                                        dnr = dirtyNodes[rowIndex];
                                        if (dnr[c])
                                        {
                                            cells.push(self._getDirtyValue(parseInt(rowIndex), c, dnr[c].oldValue))
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            for (var rIndex in dirtyNodes)
                            {
                                if (dirtyNodes[rIndex] && dirtyNodes[rIndex].rs === "e")
                                {
                                    dnr = dirtyNodes[rIndex];
                                    for (var cIndex in dnr)
                                    {
                                        var cIndexNum = parseInt(cIndex);
                                        var rIndexNum = parseInt(rIndex);
                                        if (!isNaN(cIndexNum) && dnr.hasOwnProperty(cIndex) && dnr[cIndex])
                                        {
                                            cells.push(self._getDirtyValue(rIndexNum, cIndexNum, dnr[cIndex].oldValue))
                                        }
                                    }
                                }
                            }
                        }
                    }
                    return cells
                };
                Sheet.prototype._getDirtyValue = function(row, col, oldValue)
                {
                    return {
                            row: row, col: col, newValue: this.getValue(row, col), oldValue: oldValue
                        }
                };
                Sheet.prototype.getDeleteRows = function()
                {
                    var rows = [];
                    if (this.deletedRows)
                    {
                        $.each(this.deletedRows, function(i, v)
                        {
                            if (typeof(v) !== const_function)
                            {
                                if (v)
                                {
                                    rows.push({
                                        row: v.row, originalItem: v.data
                                    })
                                }
                            }
                        })
                    }
                    return rows
                };
                Sheet.prototype.hasPendingChanges = function()
                {
                    var self = this;
                    if (this.deletedRows && this.deletedRows.length > 0)
                    {
                        return true
                    }
                    var dirtyNodes = this._sheetModelManager.dataModel().dirtyNodes;
                    if (!$.isEmptyObject(dirtyNodes))
                    {
                        return true
                    }
                    return false
                };
                Sheet.prototype.clearPendingChanges = function()
                {
                    var dirtyNodes = this._sheetModelManager.dataModel().dirtyNodes;
                    for (var r in dirtyNodes)
                    {
                        var row = dirtyNodes[r];
                        if (row && row.rs)
                        {
                            delete row.rs
                        }
                    }
                    this._sheetModelManager.dataModel().dirtyNodes = {};
                    this.deletedRows = [];
                    this._sheetModelManager.getColInfos().clearDirty();
                    this._sheetModelManager.getRowInfos().clearDirty()
                };
                Sheet.prototype.load = function()
                {
                    var self = this,
                        dataContext = self.dataContext;
                    if (!dataContext || !dataContext.read)
                    {
                        return
                    }
                    self._dataReceivedDelegate = function(event)
                    {
                        return self._onDataReceived(event)
                    };
                    $.getJSON(dataContext.read, self._dataReceivedDelegate)
                };
                Sheet.prototype.updateRecord = function()
                {
                    var self = this,
                        dataContext = self.dataContext;
                    if (!self.autoUpdate || !dataContext || !dataContext.update || dataContext.update === "")
                    {
                        return
                    }
                    var bm = self._bindingManager,
                        ds = self.getDataSource();
                    if (!ds || bm.getRowCount() === 0)
                    {
                        return
                    }
                    self._dataUpdatedDelegate = function(event)
                    {
                        return self._onDataUpdated(event)
                    };
                    var n = self._activeRowIndex;
                    if (n >= 0)
                    {
                        var item = self.getDataItem(n);
                        var url = self.dataContext.update;
                        var dataTable = self._sheetModelManager.dataModel().dataTable;
                        if (dataTable && dataTable[n] && dataTable[n].rs === "n")
                        {
                            url = self.dataContext.create
                        }
                        $.ajax({
                            url: url, type: ajax_Type, data: JSON.stringify(item), dataType: ajax_DataType, contentType: ajax_MIME, success: self._dataUpdatedDelegate
                        })
                    }
                };
                Sheet.prototype._onDataUpdated = function(event){};
                Sheet.prototype._onDataReceived = function(event)
                {
                    if (!event)
                    {
                        return
                    }
                    var data = event.data;
                    if (!data)
                    {
                        return
                    }
                    var self = this;
                    self.setDataSource(data);
                    if (!isNaN(event.total))
                    {
                        self.setRowCount(event.total)
                    }
                    if (window.localStorage)
                    {
                        var cc = self.getColumnCount();
                        for (var i = 0; i < cc; i++)
                        {
                            if (window.localStorage["col," + i])
                            {
                                self.setColumnWidth(i, parseInt(window.localStorage["col," + i], 10))
                            }
                        }
                    }
                    if (self.parent)
                    {
                        self.parent._doResize()
                    }
                    self.invalidateLayout();
                    self.repaint()
                };
                Sheet.prototype._getProperties = function(t)
                {
                    var r = [];
                    if (t)
                    {
                        for (var n in t)
                        {
                            if (typeof(t[n]) !== const_function)
                            {
                                r.push(n)
                            }
                            else
                            {
                                if (typeof(ko) !== const_undefined && ko.isObservable(t[n]))
                                {
                                    r.push(n)
                                }
                            }
                        }
                    }
                    return r
                };
                Sheet.prototype.referenceStyle = function(value)
                {
                    var rs = Sheets.ReferenceStyle,
                        calcService = this.getCalcService();
                    if (arguments.length === 0)
                    {
                        return (calcService && calcService.useR1C1) ? 1 : 0
                    }
                    if (calcService)
                    {
                        calcService.useR1C1 = (value === 1)
                    }
                    return this
                };
                Sheet.prototype.recalcAll = function()
                {
                    var calcService = this.getCalcService();
                    if (calcService)
                    {
                        calcService.recalculateAll(true)
                    }
                };
                Sheet.prototype.recalcRange = function(row, col, rowCount, colCount)
                {
                    var calcService = this.getCalcService();
                    if (calcService)
                    {
                        calcService.recalcRange(this._getSheetSource(), row, col, rowCount, colCount)
                    }
                };
                Sheet.prototype.recalcRows = function(rows)
                {
                    var calcService = this.getCalcService();
                    if (calcService && !calcService.ignoreDirty())
                    {
                        for (var i = 0; i < rows.length; i++)
                        {
                            calcService.recalculate(this._vpSheetSource, rows[i], -1)
                        }
                    }
                };
                Sheet.prototype._recalcCell = function(model, row, col)
                {
                    var calcService = this.getCalcService();
                    if (calcService && !calcService.ignoreDirty())
                    {
                        calcService.recalculate(this._vpSheetSource, row, col)
                    }
                };
                Sheet.prototype.getCalcService = function()
                {
                    if (!this.calcService && Sheets.util.hasCalc())
                    {
                        this.calcService = new Sheets.Calc.CalcService;
                        this._getSheetSource().service = this.calcService;
                        this.calcService.initParserContext(this._getSheetSource())
                    }
                    return this.calcService
                };
                Sheet.prototype._getCalcContexts = function()
                {
                    var self = this;
                    var t = [];
                    var vpModel = self._getModel();
                    t.push({
                        name: self._name, target: self, refModel: vpModel
                    });
                    return t
                };
                Sheet.prototype.suspendCalcService = function(ignoreDirty)
                {
                    if (this.getCalcService())
                    {
                        this.getCalcService().suspend(ignoreDirty)
                    }
                };
                Sheet.prototype.resumeCalcService = function(recalcAll)
                {
                    if (this.getCalcService())
                    {
                        this.getCalcService().resume(recalcAll)
                    }
                };
                Sheet.prototype._getSheetSource = function(sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null || sheetArea === 3)
                    {
                        return this._vpSheetSource
                    }
                    return keyword_null
                };
                Sheet.prototype.getCustomFunction = function(name)
                {
                    if (this._functions && name && name !== '')
                    {
                        return this._functions[name.toUpperCase()]
                    }
                    return keyword_null
                };
                Sheet.prototype.addCustomFunction = function(fn)
                {
                    this._addCustomFunctionCore(fn);
                    this.recalcAll()
                };
                Sheet.prototype._addCustomFunctionCore = function(fn)
                {
                    if (!Sheets.util.hasCalc())
                    {
                        return
                    }
                    if (!fn || !(fn instanceof Sheets.Calc.Functions.Function))
                    {
                        throw new Error(Sheets.SR.Exp_InvalidCustomFunction);
                    }
                    var self = this;
                    var fnName = fn.name.toUpperCase();
                    if (!self._functions)
                    {
                        self._functions = {}
                    }
                    self._functions[fnName] = fn
                };
                Sheet.prototype.removeCustomFunction = function(name)
                {
                    var self = this;
                    if (self._functions && name && name !== '')
                    {
                        name = name.toUpperCase();
                        if (self._functions.hasOwnProperty(name))
                        {
                            delete self._functions[name];
                            self.recalcAll()
                        }
                    }
                };
                Sheet.prototype.clearCustomFunctions = function()
                {
                    if (this._functions)
                    {
                        delete this._functions;
                        this.recalcAll()
                    }
                };
                Sheet.prototype._findCustomFunction = function(name)
                {
                    if (!name || name === '')
                    {
                        return keyword_null
                    }
                    var self = this,
                        parent = self.parent;
                    var fn = self.getCustomFunction(name);
                    if (!fn && parent && parent.getCustomFunction)
                    {
                        fn = parent.getCustomFunction(name)
                    }
                    return fn
                };
                Sheet.prototype.addCustomFunctionDescription = function(fnd)
                {
                    if (!fnd || !fnd.name || this.getCustomFunctionDescription(fnd.name))
                    {
                        return
                    }
                    var fnds = this._functionDescriptions;
                    if (!fnds)
                    {
                        fnds = this._functionDescriptions = []
                    }
                    fnds.push(fnd)
                };
                Sheet.prototype.getCustomFunctionDescription = function(name)
                {
                    var fnds = this._functionDescriptions;
                    if (fnds && name)
                    {
                        name = name.toUpperCase();
                        var count = fnds.length,
                            fnd;
                        for (var i = 0; i < count; i++)
                        {
                            fnd = fnds[i];
                            if (fnd.name && fnd.name.toUpperCase() === name)
                            {
                                return fnd
                            }
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype.removeCustomFunctionDescription = function(name)
                {
                    var fnds = this._functionDescriptions;
                    if (!fnds || !name)
                    {
                        return
                    }
                    name = name.toUpperCase();
                    var count = fnds.length,
                        fnd;
                    for (var i = 0; i < count; i++)
                    {
                        fnd = fnds[i];
                        if (fnd.name && fnd.name.toUpperCase() === name)
                        {
                            fnds.splice(i, 1);
                            break
                        }
                    }
                };
                Sheet.prototype.clearCustomFunctionDescriptions = function()
                {
                    if (this._functionDescriptions)
                    {
                        this._functionDescriptions = keyword_null
                    }
                };
                Sheet.prototype.getCustomName = function(name)
                {
                    var names = this._names;
                    return names ? names[name.toUpperCase()] : keyword_null
                };
                Sheet.prototype.getCustomNames = function()
                {
                    var result = [],
                        names = this._names;
                    if (names)
                    {
                        $.each(names, function(p, v)
                        {
                            result.push(v)
                        })
                    }
                    return result
                };
                Sheet.prototype.addCustomName = function(name, formula, baseRow, baseCol)
                {
                    this._addCustomNameCore(name, formula, baseRow, baseCol, false)
                };
                Sheet.prototype._addCustomNameCore = function(name, formula, baseRow, baseCol, ignoreError)
                {
                    if (!name || name === '' || !formula || formula === '')
                    {
                        throw new Error(Sheets.SR.Exp_InvalidCustomName);
                    }
                    var self = this;
                    if (!self._names)
                    {
                        self._names = {}
                    }
                    var calcService = self.getCalcService();
                    var sheetSource = self._getSheetSource();
                    var calcModel = self._getCalcModel();
                    if (calcService && sheetSource)
                    {
                        var expr;
                        if (ignoreError)
                        {
                            try
                            {
                                expr = calcService.parse(keyword_null, formula, baseRow, baseCol, false, true)
                            }
                            catch(ex) {}
                        }
                        else
                        {
                            expr = calcService.parse(keyword_null, formula, baseRow, baseCol)
                        }
                        var upperName = name.toUpperCase();
                        self._names[upperName] = new Sheets.NameInfo(name, expr, baseRow, baseCol);
                        var nameCalc = calcModel._getNameCalc(upperName, true);
                        if (nameCalc)
                        {
                            nameCalc.updateListening(true, true);
                            nameCalc.addToDirty()
                        }
                        self.recalcAll()
                    }
                };
                Sheet.prototype.removeCustomName = function(name)
                {
                    var self = this;
                    if (self._names && name && name !== '')
                    {
                        var upperName = name.toUpperCase();
                        if (self._names[upperName])
                        {
                            delete self._names[upperName];
                            var calcModel = self._getCalcModel();
                            if (calcModel)
                            {
                                var nameCalc = calcModel._getNameCalc(upperName);
                                if (nameCalc)
                                {
                                    nameCalc.updateListening(true, false);
                                    nameCalc.addToDirty()
                                }
                            }
                            self.recalcAll()
                        }
                    }
                };
                Sheet.prototype.clearCustomNames = function()
                {
                    var self = this;
                    if (self._names)
                    {
                        var names = self._names;
                        delete self._names;
                        var calcModel = self._getCalcModel();
                        if (calcModel)
                        {
                            var len = names.length;
                            for (var i = 0; i < len; i++)
                            {
                                var nameCalc = calcModel._getNameCalc(names[i]);
                                if (nameCalc)
                                {
                                    nameCalc.updateListening(true, false);
                                    nameCalc.addToDirty()
                                }
                            }
                        }
                        self.recalcAll()
                    }
                };
                Sheet.prototype._findCustomName = function(name)
                {
                    if (!name || name === '')
                    {
                        return keyword_null
                    }
                    var self = this,
                        parent = self.parent;
                    var cn = self.getCustomName(name);
                    if (!cn && parent && parent.getCustomName)
                    {
                        cn = parent.getCustomName(name)
                    }
                    return cn
                };
                Sheet.prototype.setFormula = function(row, col, value)
                {
                    this._setFormulaCore(row, col, value, false)
                };
                Sheet.prototype._setFormulaCore = function(row, col, value, ignoreError, sheetArea)
                {
                    var self = this;
                    if (sheetArea === 1 || sheetArea === 2)
                    {
                        return
                    }
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var E = Sheets.Events;
                    if (row < 0 || row >= self.getRowCount() || col < 0 || col >= self.getColumnCount())
                    {
                        self._raiseInvalidOperation(0, Sheets.SR.Exp_IndexOutOfRange);
                        return
                    }
                    var tableManager = self._tableManager;
                    if (sheetArea === 3 && row >= 0 && col >= 0 && tableManager)
                    {
                        var table = tableManager.find(row, col);
                        if (table)
                        {
                            if (table.showHeader() && row === table.headerIndex() && value)
                            {
                                return
                            }
                            if (table.showFooter() && row === table.footerIndex())
                            {
                                table._setFooterFormula(col, value)
                            }
                        }
                    }
                    var calcModel = self._getCalcModel(),
                        conditionalFormats = self._conditionalFormats;
                    if (calcModel)
                    {
                        calcModel.setFormula(row, col, value, ignoreError);
                        if (conditionalFormats)
                        {
                            conditionalFormats._clearCache()
                        }
                        if (self._eventHandler._eventSuspended < 1)
                        {
                            self.triggerCellChanged({
                                sheet: self, sheetName: self._name, row: row, col: col, sheetArea: sheetArea, propertyName: "formula"
                            })
                        }
                    }
                    if (!self._paintSuspended)
                    {
                        self.invalidateLayout();
                        self.repaint()
                    }
                };
                Sheet.prototype.setArrayFormula = function(row, col, rowCount, colCount, value)
                {
                    this._setArrayFormulaCore(row, col, rowCount, colCount, value, false)
                };
                Sheet.prototype._setArrayFormulaCore = function(row, col, rowCount, colCount, value, ignoreError, sheetArea)
                {
                    var self = this;
                    self._bindToAutoRefresh(function(row, col, rowCount, colCount, value, sheetArea)
                    {
                        if (sheetArea === 1 || sheetArea === 2)
                        {
                            return
                        }
                        if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                        {
                            sheetArea = 3
                        }
                        var E = Sheets.Events;
                        if (row < 0 || row + rowCount > self.getRowCount() || col < 0 || col + colCount > self.getColumnCount())
                        {
                            self._raiseInvalidOperation(0, Sheets.SR.Exp_IndexOutOfRange);
                            return
                        }
                        if (self._hasSpans(row, col, rowCount, colCount))
                        {
                            self._raiseInvalidOperation(0, Sheets.SR.Exp_ArrayFromulaSpan);
                            return
                        }
                        var tableManager = self._tableManager;
                        if (sheetArea === 3 && row >= 0 && col >= 0 && tableManager)
                        {
                            var table = tableManager.find(row, col);
                            if (table)
                            {
                                if (rowCount > 1 || colCount > 1)
                                {
                                    self._raiseInvalidOperation(0, Sheets.SR.Exp_ArrayFormulaTable);
                                    return
                                }
                                if (table.showHeader() && row === table.headerIndex() && value)
                                {
                                    return
                                }
                                if (table.showFooter() && row === table.footerIndex())
                                {
                                    table._setFooterFormula(col, value)
                                }
                            }
                        }
                        var calcModel = self._getCalcModel(),
                            conditionalFormats = self._conditionalFormats;
                        if (calcModel)
                        {
                            calcModel.setArrayFormula(row, col, rowCount, colCount, value, ignoreError);
                            if (conditionalFormats)
                            {
                                conditionalFormats._clearCache()
                            }
                            if (self._eventHandler._eventSuspended < 1)
                            {
                                var changedCells = [];
                                for (var r = row; r < row + rowCount; r++)
                                {
                                    for (var c = col; c < col + colCount; c++)
                                    {
                                        changedCells.push(new Sheets.CellPosition(r, c))
                                    }
                                }
                                self.triggerRangeChanged({
                                    sheet: self, sheetName: self._name, row: row, column: col, rowCount: rowCount, columnCount: colCount, sheetArea: sheetArea, changedCells: changedCells, action: 5
                                })
                            }
                        }
                    })(row, col, rowCount, colCount, value, sheetArea)
                };
                Sheet.prototype.getFormula = function(row, col)
                {
                    var calcModel = this._getCalcModel();
                    if (calcModel)
                    {
                        return calcModel.getFormula(row, col)
                    }
                    return keyword_null
                };
                Sheet.prototype.getFormulaInformation = function(row, col)
                {
                    var info = new Sheets.FormulaInformation;
                    var calcModule = this._getCalcModel(3);
                    if (calcModule)
                    {
                        var expr = calcModule.getExpr(row, col);
                        if (expr)
                        {
                            var arrayInfo = calcModule.getArray(row, col);
                            info.hasFormula = true;
                            if (arrayInfo)
                            {
                                info.baseRange = new Sheets.Range(arrayInfo.row, arrayInfo.col, arrayInfo.rowCount, arrayInfo.colCount)
                            }
                            info.isArrayFormula = !!arrayInfo
                        }
                    }
                    var calcModel = this._getCalcModel();
                    if (calcModel)
                    {
                        info.formula = calcModel.getFormula(row, col);
                        info.hasFormula = !!info.formula
                    }
                    return info
                };
                Sheet.prototype.hasFormula = function(row, col)
                {
                    var calcModel = this._getCalcModel();
                    if (calcModel)
                    {
                        return calcModel.hasFormula(row, col)
                    }
                    return false
                };
                Sheet.prototype._findFormulas = function(row, column, rowCount, columnCount){};
                Sheet.prototype._rebuildCalcNodes = function()
                {
                    var calcModel = this._getCalcModel();
                    if (!calcModel)
                    {
                        return
                    }
                    var row = 0;
                    var rowCount = calcModel.rC();
                    var colCount = calcModel.cC();
                    while (row < rowCount)
                    {
                        var col = 0;
                        while (col < colCount)
                        {
                            var cellCalc = calcModel._getCellCalc(row, col);
                            if (cellCalc)
                            {
                                cellCalc.stopListening();
                                cellCalc.startListening()
                            }
                            col++
                        }
                        row++
                    }
                };
                Sheet.prototype._setValueToDataTable = function(dataTable, row, col, value)
                {
                    var rowNode = dataTable[row];
                    if (!rowNode)
                    {
                        rowNode = dataTable[row] = {}
                    }
                    var node = rowNode[col];
                    if (!node)
                    {
                        node = rowNode[col] = {}
                    }
                    node.value = value
                };
                Sheet.prototype._serializeSheetDataSource = function(dataTable)
                {
                    var sheet = this;
                    if (!sheet.getDataSource())
                    {
                        return keyword_undefined
                    }
                    var rowCount = sheet.getRowCount(),
                        colCount = sheet.getColumnCount();
                    var bindingManager = sheet._bindingManager;
                    for (var r = 0; r < rowCount; r++)
                    {
                        for (var c = 0; c < colCount; c++)
                        {
                            var boundValue = bindingManager.getValue(r, c).value;
                            if (boundValue !== keyword_null && boundValue !== keyword_undefined)
                            {
                                sheet._setValueToDataTable(dataTable, r, c, boundValue)
                            }
                        }
                    }
                };
                Sheet.prototype._serializeColumnHeaderNames = function(colHeaderDataTable)
                {
                    var sheet = this;
                    if (!sheet.getDataSource())
                    {
                        return keyword_undefined
                    }
                    var colHeaderRowCount = sheet.getRowCount(1),
                        colHeaderColCount = sheet.getColumnCount(1);
                    var colInfos = sheet._sheetModelManager.getColInfos()._getItems();
                    var colHeaderAutoTextIndex = sheet.colHeaderAutoTextIndex;
                    for (var r = 0; r < colHeaderRowCount; r++)
                    {
                        if ((colHeaderAutoTextIndex >= 0 && r === colHeaderAutoTextIndex) || (colHeaderAutoTextIndex === -1 && r === (colHeaderRowCount - 1)))
                        {
                            for (var c = 0; c < colHeaderColCount; c++)
                            {
                                var colInfo = colInfos[c];
                                if (colInfo)
                                {
                                    var displayNameOrName = colInfo.displayName || colInfo.name;
                                    if (displayNameOrName)
                                    {
                                        sheet._setValueToDataTable(colHeaderDataTable, r, c, displayNameOrName)
                                    }
                                }
                            }
                        }
                    }
                };
                Sheet.prototype._serializeTablesDataSource = function(dataTable)
                {
                    var sheet = this;
                    var tables = sheet.getTables();
                    for (var i = 0, length = tables.length; i < length; i++)
                    {
                        var table = tables[i],
                            tableDataSource = table.getSource(),
                            tableDataRange = table.dataRange(),
                            tableDataRangeStartRow = tableDataRange.row,
                            tableDataRangeStartCol = tableDataRange.col,
                            tableDataRangeEndRow = tableDataRangeStartRow + tableDataRange.rowCount - 1,
                            tableDataRangeEndCol = tableDataRangeStartCol + tableDataRange.colCount - 1;
                        if (tableDataSource)
                        {
                            for (var r = tableDataRangeStartRow; r <= tableDataRangeEndRow; r++)
                            {
                                for (var c = tableDataRangeStartCol; c <= tableDataRangeEndCol; c++)
                                {
                                    var boundValue = table._getValue(r, c).value;
                                    if (boundValue !== keyword_null && boundValue !== keyword_undefined)
                                    {
                                        sheet._setValueToDataTable(dataTable, r, c, boundValue)
                                    }
                                }
                            }
                        }
                    }
                };
                Sheet.prototype.toJSON = function(serializationOption)
                {
                    var sheet = this,
                        modelManager = sheet._sheetModelManager,
                        sparklineGroupManager = sheet._sparklineGroupManager,
                        commentManager = sheet._commentManager,
                        cfs = sheet._conditionalFormats,
                        tableManager = sheet._tableManager,
                        floatingObjectArray = sheet._floatingObjectArray,
                        rowRangeGroup = sheet.rowRangeGroup,
                        colRangeGroup = sheet.colRangeGroup,
                        rowFilter = sheet._rowFilter;
                    var dataDic = {
                            defaults: sheet.defaults, columns: sheet._toArray(modelManager.getColInfos()._getItems(), sheet.getColumnCount()), rows: sheet._toArray(modelManager.getRowInfos()._getItems(), sheet.getRowCount()), autoGenerateColumns: sheet.autoGenerateColumns, frozenRowCount: sheet.frozenRowCount, frozenColCount: sheet.frozenColCount, frozenTrailingRowCount: sheet._frozenTrailingRowCount, frozenTrailingColCount: sheet._frozenTrailingColCount, rowCount: sheet.getRowCount(), columnCount: sheet.getColumnCount(), sparklineGroups: (sparklineGroupManager ? sparklineGroupManager.toJSON() : keyword_null), comments: (commentManager ? commentManager.toJSON() : keyword_null), spans: sheet._getSpanModel().toJSON(), selectionBackColor: sheet._selectionBackColor, selectionBorderColor: sheet._selectionBorderColor, activeRow: sheet._activeRowIndex, activeCol: sheet._activeColIndex, gridline: sheet.gridline, allowCellOverflow: sheet._allowCellOverflow, referenceStyle: sheet.referenceStyle(), zoomFactor: sheet._zoomFactor, theme: sheet.currentTheme(), showRowRangeGroup: sheet._showRowRangeGroup, showColumnRangeGroup: sheet._showColumnRangeGroup, conditionalFormats: (cfs ? cfs.toJSON() : keyword_null), sheetTabColor: sheet._sheetTabColor, frozenlineColor: sheet._frozenlineColor, rowHeaderAutoText: sheet.rowHeaderAutoText, colHeaderAutoText: sheet.colHeaderAutoText, rowHeaderAutoTextIndex: sheet.rowHeaderAutoTextIndex, colHeaderAutoTextIndex: sheet.colHeaderAutoTextIndex, rowHeaderVisible: sheet.rowHeaderVisible, colHeaderVisible: sheet.colHeaderVisible, rowHeaderColCount: sheet.getColumnCount(2), colHeaderRowCount: sheet.getRowCount(1), rowHeaderSpan: sheet._getSpanModel(2).toJSON(), colHeaderSpan: sheet._getSpanModel(1).toJSON(), rowHeaderColInfos: sheet._toArray(modelManager.getColInfos(2)._getItems(), sheet.getColumnCount(2)), colHeaderRowInfos: sheet._toArray(modelManager.getRowInfos(1)._getItems(), sheet.getRowCount(1)), clipBoardOptions: sheet._clipBoardOptions, isProtected: sheet.isProtected, borderColor: sheet.borderColor, borderWidth: sheet.borderWidth, allowUndo: sheet._allowUndo, allowEditorReservedLocations: sheet._allowEditorReservedLocations, tables: (tableManager ? tableManager.toJSON() : keyword_null), floatingObjects: (floatingObjectArray ? floatingObjectArray.toJSON() : keyword_null), visible: sheet._visible, rowHeaderData: sheet._getModel(2).toJSON(2), colHeaderData: sheet._getModel(1).toJSON(1), data: sheet._getModel().toJSON(), rowRangeGroup: rowRangeGroup ? rowRangeGroup.toJSON() : keyword_undefined, colRangeGroup: colRangeGroup ? colRangeGroup.toJSON() : keyword_undefined, tag: sheet._tag, customFunctions: sheet._functions
                        };
                    if (serializationOption && serializationOption.includeBindingSource)
                    {
                        var dataTable = dataDic.data.dataTable || {};
                        sheet._serializeSheetDataSource(dataTable);
                        sheet._serializeTablesDataSource(dataTable);
                        dataDic.data.dataTable = dataTable;
                        var colHeaderDataTable = dataDic.colHeaderData.dataTable || {};
                        sheet._serializeColumnHeaderNames(colHeaderDataTable);
                        dataDic.colHeaderData.dataTable = colHeaderDataTable
                    }
                    var sdata = {
                            name: sheet._name, selections: sheet._selectionModel.toJSON(), rowFilter: rowFilter ? rowFilter.toJSON() : keyword_undefined
                        };
                    for (var item in dataDic)
                    {
                        var value = dataDic[item];
                        if (!sheet._isDefaultValue(item, value))
                        {
                            sdata[item] = value
                        }
                    }
                    var namedStyles = [],
                        sheetNamedStyles = sheet._namedStyles;
                    if (sheetNamedStyles)
                    {
                        for (var item in sheetNamedStyles)
                        {
                            var style = sheetNamedStyles[item];
                            if (style)
                            {
                                namedStyles.push(style.toJSON())
                            }
                        }
                    }
                    if (namedStyles.length > 0)
                    {
                        sdata["namedStyles"] = namedStyles
                    }
                    var names = [],
                        sheetNames = sheet._names;
                    if (sheetNames && sheet.getCalcService())
                    {
                        for (var n in sheetNames)
                        {
                            if (sheet._names.hasOwnProperty(n))
                            {
                                var ni = sheetNames[n];
                                var name = ni.getName(),
                                    row = ni.getRow(),
                                    col = ni.getColumn(),
                                    expr = ni.getExpression();
                                var f = sheet.getCalcService().unparseWithoutCulture(sheet._getSheetSource(), expr, row, col, true);
                                names.push({
                                    name: name, formula: f, row: row, col: col
                                })
                            }
                        }
                    }
                    if (names.length > 0)
                    {
                        sdata["names"] = names
                    }
                    return sdata
                };
                Sheet.prototype._isDefaultTheme = function(value)
                {
                    if (!value)
                    {
                        return false
                    }
                    if (value._name === "Office")
                    {
                        var themeColor = JSON.stringify(value._themeColor);
                        var defaultThemeColor = JSON.stringify(Sheets.ThemeColors.Office);
                        if (value._bodyFont === "Calibri" && value._headingFont === "Cambria" && themeColor === defaultThemeColor)
                        {
                            return true
                        }
                    }
                    return false
                };
                Sheet.prototype._isDefaultValue = function(propertyName, value)
                {
                    var sheet = this;
                    switch (propertyName)
                    {
                        case"defaults":
                            return value.rowHeight === sheet._defaultRowHeight && value.colWidth === sheet._defaultColWidth && value.rowHeaderColWidth === sheet._defaultRowHeaderColWidth && value.colHeaderRowHeight === sheet._defaultColHeaderRowHeight;
                        case"columns":
                            return !value || value.length === 0;
                        case"rows":
                            return !value || value.length === 0;
                        case"autoGenerateColumns":
                            return value === true;
                        case"sparklineGroups":
                            return value === keyword_null;
                        case"comments":
                            return value === keyword_null;
                        case"frozenRowCount":
                            return value === 0;
                        case"frozenColCount":
                            return value === 0;
                        case"frozenTrailingRowCount":
                            return value === 0;
                        case"frozenTrailingColCount":
                            return value === 0;
                        case"selectionBackColor":
                            return value === "rgba(180,180,200,0.2)";
                        case"selectionBorderColor":
                            return value === "black";
                        case"activeRow":
                            return value === 0;
                        case"activeCol":
                            return value === 0;
                        case"gridline":
                            return value.color === sheet._defaultGridLineColor && value.showHorizontalGridline === sheet._defaultShowHorizontalGridline && value.showVerticalGridline === sheet._defaultShowVerticalGridline;
                        case"allowCellOverflow":
                            return value === false;
                        case"referenceStyle":
                            return value === 0;
                        case"zoomFactor":
                            return value === 1.0;
                        case"theme":
                            return sheet._isDefaultTheme(value);
                        case"showRowRangeGroup":
                            return value === true;
                        case"showColumnRangeGroup":
                            return value === true;
                        case"conditionalFormats":
                            return value === keyword_null;
                        case"sheetTabColor":
                            return value === keyword_null;
                        case"frozenlineColor":
                            return value === "black";
                        case"rowHeaderAutoText":
                            return value === 1;
                        case"colHeaderAutoText":
                            return value === 2;
                        case"rowHeaderAutoTextIndex":
                            return value === -1;
                        case"colHeaderAutoTextIndex":
                            return value === -1;
                        case"rowHeaderVisible":
                            return value === true;
                        case"colHeaderVisible":
                            return value === true;
                        case"rowHeaderColCount":
                            return value === 1;
                        case"colHeaderRowCount":
                            return value === 1;
                        case"rowHeaderColInfos":
                            return !value || value.length === 0;
                        case"colHeaderRowInfos":
                            return !value || value.length === 0;
                        case"clipBoardOptions":
                            return value === 0;
                        case"isProtected":
                            return value === false;
                        case"borderColor":
                            return value === "black";
                        case"borderWidth":
                            return value === 0;
                        case"allowUndo":
                            return value === true;
                        case"allowEditorReservedLocations":
                            return value === true;
                        case"tables":
                            return value === keyword_null;
                        case"floatingObjects":
                            return value === keyword_null;
                        case"visible":
                            return value === true;
                        case"data":
                            return $.isEmptyObject(value);
                        case"rowHeaderData":
                            return $.isEmptyObject(value);
                        case"colHeaderData":
                            return $.isEmptyObject(value);
                        case"tag":
                            return value === keyword_null;
                        default:
                            return false
                    }
                };
                Sheet.prototype.fromJSON = function(sheetSettings, setFormulaDirectly, isNoneSchema)
                {
                    if (!sheetSettings)
                    {
                        return
                    }
                    if (typeof setFormulaDirectly === const_undefined)
                    {
                        setFormulaDirectly = true
                    }
                    var sheet = this,
                        modelManager = sheet._sheetModelManager;
                    var oldState = sheet.isPaintSuspended();
                    sheet.isPaintSuspended(true);
                    var oldCulture = GcSpread.Sheets.Culture();
                    GcSpread.Sheets.switchCulture("");
                    var rowCount = sheetSettings.rowCount;
                    var columnCount = sheetSettings.columnCount;
                    try
                    {
                        sheet._name = sheetSettings.name;
                        sheet._names = {};
                        if (sheetSettings.defaults)
                        {
                            sheet.defaults = sheetSettings.defaults
                        }
                        if (typeof rowCount === const_undefined)
                        {
                            rowCount = sheet._defaultRowCount
                        }
                        sheet.setRowCount(rowCount);
                        if (typeof columnCount === const_undefined)
                        {
                            columnCount = sheet._defaultColCount
                        }
                        sheet.setColumnCount(columnCount);
                        if (typeof sheetSettings.activeRow !== const_undefined)
                        {
                            sheet._activeRowIndex = sheetSettings.activeRow
                        }
                        if (typeof sheetSettings.activeCol !== const_undefined)
                        {
                            sheet._activeColIndex = sheetSettings.activeCol
                        }
                        if (typeof sheetSettings.frozenRowCount !== const_undefined)
                        {
                            sheet.setFrozenRowCount(sheetSettings.frozenRowCount)
                        }
                        if (typeof sheetSettings.frozenColCount !== const_undefined)
                        {
                            sheet.setFrozenColumnCount(sheetSettings.frozenColCount)
                        }
                        if (typeof sheetSettings.frozenTrailingRowCount !== const_undefined)
                        {
                            sheet.setFrozenTrailingRowCount(sheetSettings.frozenTrailingRowCount)
                        }
                        if (typeof sheetSettings.frozenTrailingColCount !== const_undefined)
                        {
                            sheet.setFrozenTrailingColumnCount(sheetSettings.frozenTrailingColCount)
                        }
                        if (typeof sheetSettings.gridline !== const_undefined)
                        {
                            sheet.gridline = sheetSettings.gridline
                        }
                        if (typeof sheetSettings.allowCellOverflow !== const_undefined)
                        {
                            sheet._allowCellOverflow = sheetSettings.allowCellOverflow
                        }
                        if (typeof sheetSettings.autoGenerateColumns !== const_undefined)
                        {
                            sheet.autoGenerateColumns = sheetSettings.autoGenerateColumns
                        }
                        var tagObj = sheetSettings.tag;
                        if (typeof tagObj !== const_undefined)
                        {
                            var tagTypeName = tagObj.typeName;
                            if (typeof tagTypeName === const_string)
                            {
                                var tagClass = Sheets.getTypeFromString(tagTypeName);
                                if (tagClass)
                                {
                                    tagObj = new tagClass;
                                    if (tagObj.fromJSON)
                                    {
                                        tagObj.fromJSON(sheetSettings.tag)
                                    }
                                }
                            }
                            sheet.tag(tagObj)
                        }
                        if (isNoneSchema)
                        {
                            if (sheetSettings.dataSource)
                            {
                                var bm = sheet._bindingManager;
                                if (bm)
                                {
                                    bm.bind(sheetSettings.dataSource)
                                }
                            }
                            if (sheetSettings.dataBinding)
                            {
                                var bm = sheet._bindingManager;
                                if (bm)
                                {
                                    bm.fromJSON(sheetSettings.dataBinding, isNoneSchema)
                                }
                            }
                        }
                        if (sheetSettings.rows)
                        {
                            modelManager.getRowInfos()._setItems(sheetSettings.rows);
                            modelManager.getRowInfos().length = rowCount
                        }
                        if (sheetSettings.columns)
                        {
                            modelManager.getColInfos()._setItems(sheetSettings.columns);
                            modelManager.getColInfos().length = columnCount
                        }
                        if (sheetSettings.colStyles)
                        {
                            for (var t in sheetSettings.colStyles)
                            {
                                if (!isNaN(t))
                                {
                                    var c = parseInt(t, 10);
                                    sheet.setStyle(-1, c, sheetSettings.colStyles[t], 3)
                                }
                            }
                        }
                        if (sheetSettings.rowStyles)
                        {
                            for (var t in sheetSettings.rowStyles)
                            {
                                if (!isNaN(t))
                                {
                                    var r = parseInt(t, 10);
                                    sheet.setStyle(r, -1, sheetSettings.rowStyles[t], 3)
                                }
                            }
                        }
                        if (typeof(sheetSettings.rowHeaderAutoText) !== const_undefined)
                        {
                            sheet.rowHeaderAutoText = sheetSettings.rowHeaderAutoText
                        }
                        if (typeof(sheetSettings.colHeaderAutoText) !== const_undefined)
                        {
                            sheet.colHeaderAutoText = sheetSettings.colHeaderAutoText
                        }
                        if (typeof(sheetSettings.rowHeaderAutoTextIndex) !== const_undefined)
                        {
                            sheet.rowHeaderAutoTextIndex = sheetSettings.rowHeaderAutoTextIndex
                        }
                        if (typeof(sheetSettings.colHeaderAutoTextIndex) !== const_undefined)
                        {
                            sheet.colHeaderAutoTextIndex = sheetSettings.colHeaderAutoTextIndex
                        }
                        if (typeof(sheetSettings.rowHeaderVisible) !== const_undefined)
                        {
                            sheet.rowHeaderVisible = sheetSettings.rowHeaderVisible
                        }
                        if (typeof(sheetSettings.colHeaderVisible) !== const_undefined)
                        {
                            sheet.colHeaderVisible = sheetSettings.colHeaderVisible
                        }
                        var rowHeaderColCount = sheetSettings.rowHeaderColCount;
                        var colHeaderRowCount = sheetSettings.colHeaderRowCount;
                        if (typeof(sheetSettings.rowHeaderColCount) === const_undefined)
                        {
                            rowHeaderColCount = this._defaultRowHeaderColumnCount
                        }
                        if (typeof(sheetSettings.colHeaderRowCount) === const_undefined)
                        {
                            colHeaderRowCount = this._defaultColHeaderRowCount
                        }
                        sheet.setColumnCount(rowHeaderColCount, 2);
                        sheet.setRowCount(colHeaderRowCount, 1);
                        if (sheetSettings.rowHeaderData)
                        {
                            modelManager.rowHeaderModel().fromJSON(sheetSettings.rowHeaderData, isNoneSchema)
                        }
                        if (sheetSettings.colHeaderData)
                        {
                            modelManager.colHeaderModel().fromJSON(sheetSettings.colHeaderData, isNoneSchema)
                        }
                        if (sheetSettings.rowHeaderSpan)
                        {
                            sheet._getSpanModel(2).fromJSON(sheetSettings.rowHeaderSpan, isNoneSchema)
                        }
                        if (sheetSettings.colHeaderSpan)
                        {
                            sheet._getSpanModel(1).fromJSON(sheetSettings.colHeaderSpan, isNoneSchema)
                        }
                        if (sheetSettings.rowHeaderColInfos)
                        {
                            modelManager.getColInfos(2)._setItems(sheetSettings.rowHeaderColInfos)
                        }
                        if (sheetSettings.colHeaderRowInfos)
                        {
                            modelManager.getRowInfos(1)._setItems(sheetSettings.colHeaderRowInfos)
                        }
                        if (typeof sheetSettings._zoomFactor !== const_undefined || typeof sheetSettings.zoomFactor !== const_undefined)
                        {
                            sheet._zoomFactor = typeof sheetSettings.zoomFactor === const_undefined ? sheetSettings._zoomFactor : sheetSettings.zoomFactor
                        }
                        if (sheetSettings.spans)
                        {
                            sheet._getSpanModel().fromJSON(sheetSettings.spans, isNoneSchema)
                        }
                        if (sheetSettings.selections)
                        {
                            sheet._clearSelectionImp();
                            sheet._selectionModel.fromJSON(sheetSettings.selections, isNoneSchema)
                        }
                        if (typeof(sheetSettings.referenceStyle) !== const_undefined)
                        {
                            sheet.referenceStyle(sheetSettings.referenceStyle)
                        }
                        var customFunctions = sheetSettings.customFunctions;
                        if (customFunctions)
                        {
                            for (var func in customFunctions)
                            {
                                var funcJsonData = customFunctions[func];
                                var customFunctionClass = Sheets.getTypeFromString(funcJsonData.typeName);
                                if (customFunctionClass)
                                {
                                    var customFunc = new customFunctionClass;
                                    customFunc.fromJSON(funcJsonData, isNoneSchema);
                                    sheet._addCustomFunctionCore(customFunc)
                                }
                            }
                        }
                        if (setFormulaDirectly && sheetSettings.names)
                        {
                            for (var n = 0; n < sheetSettings.names.length; n++)
                            {
                                var ni = sheetSettings.names[n];
                                sheet._addCustomNameCore(ni.name, ni.formula, ni.row, ni.col, true)
                            }
                            sheet._rebuildCalcNodes()
                        }
                        if (sheetSettings.data)
                        {
                            modelManager.dataModel().fromJSON(sheetSettings.data, isNoneSchema);
                            var data = sheetSettings.data.dataTable;
                            if (setFormulaDirectly && data)
                            {
                                for (var j in data)
                                {
                                    if (typeof(j) !== const_function)
                                    {
                                        for (var k in data[j])
                                        {
                                            if (typeof(k) !== const_function)
                                            {
                                                var node = data[j][k];
                                                var formula = node.formula;
                                                if (formula)
                                                {
                                                    if (node.arrayInfo)
                                                    {
                                                        sheet._setArrayFormulaCore(parseInt(j, 10), parseInt(k, 10), parseInt(node.arrayInfo.rowCount, 10), parseInt(node.arrayInfo.colCount, 10), formula, true)
                                                    }
                                                    else
                                                    {
                                                        sheet._setFormulaCore(parseInt(j, 10), parseInt(k, 10), formula, true)
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        var sparklineGroups = isNoneSchema ? (sheetSettings.sparklineGroupManager ? sheetSettings.sparklineGroupManager.groups : keyword_null) : sheetSettings.sparklineGroups;
                        if (setFormulaDirectly && sparklineGroups)
                        {
                            var spm = sheet._sparklineGroupManager;
                            if (spm)
                            {
                                spm.fromJSON(sparklineGroups, isNoneSchema);
                                var groups = spm.groups();
                                var model = modelManager.getDataModel(),
                                    sparklines,
                                    sparkline;
                                for (var i = 0; i < groups.length; i++)
                                {
                                    sparklines = groups[i]._innerList;
                                    for (var j1 = 0; j1 < sparklines.length; j1++)
                                    {
                                        sparkline = sparklines[j1];
                                        model.setSparkline(sparkline.row, sparkline.column, sparkline)
                                    }
                                }
                            }
                        }
                        var comments = isNoneSchema ? sheetSettings.commentManager : sheetSettings.comments;
                        if (comments)
                        {
                            sheet._commentManager.fromJSON(comments, isNoneSchema)
                        }
                        if (sheetSettings.theme)
                        {
                            var st = sheetSettings.theme;
                            if (typeof st === "string" || typeof st === const_undefined)
                            {
                                sheet.currentTheme(st)
                            }
                            else
                            {
                                var tc = st.themeColor ? st.themeColor : st._themeColor;
                                var tcName = tc.name ? tc.name : tc._name;
                                var themeColor = new Sheets.ThemeColor(tcName);
                                themeColor.fromJSON(tc, isNoneSchema);
                                var theme = new Sheets.SpreadTheme(st.name ? st.name : st._name, themeColor, st.headingFont ? st.headingFont : st._headingFont, st.bodyFont ? st.bodyFont : st._bodyFont);
                                sheet.currentTheme(theme)
                            }
                        }
                        if (typeof(sheetSettings.showRowRangeGroup) !== const_undefined)
                        {
                            sheet._showRowRangeGroup = sheetSettings.showRowRangeGroup
                        }
                        if (typeof(sheetSettings.showColumnRangeGroup) !== const_undefined)
                        {
                            sheet._showColumnRangeGroup = sheetSettings.showColumnRangeGroup
                        }
                        if (sheetSettings.rowRangeGroup)
                        {
                            if (sheet.rowRangeGroup)
                            {
                                sheet.rowRangeGroup.fromJSON(sheetSettings.rowRangeGroup, isNoneSchema)
                            }
                        }
                        if (sheetSettings.colRangeGroup)
                        {
                            if (sheet.colRangeGroup)
                            {
                                sheet.colRangeGroup.fromJSON(sheetSettings.colRangeGroup, isNoneSchema)
                            }
                        }
                        var rowFilterData = sheetSettings.rowFilter;
                        if (rowFilterData && Sheets.features.filter)
                        {
                            var drf;
                            var rowFilterTypeName = rowFilterData.typeName;
                            if (!rowFilterTypeName)
                            {
                                drf = new Sheets.HideRowFilter
                            }
                            else
                            {
                                var rowFilterClass = Sheets.getTypeFromString(rowFilterTypeName);
                                if (rowFilterClass)
                                {
                                    drf = new rowFilterClass
                                }
                            }
                            if (drf)
                            {
                                sheet._rowFilter = drf;
                                drf.sheet = sheet;
                                drf.fromJSON(rowFilterData, isNoneSchema);
                                drf.reFilter()
                            }
                        }
                        if (sheetSettings.conditionalFormats && Sheets.features.conditionalFormat)
                        {
                            sheet.getConditionalFormats().fromJSON(sheetSettings.conditionalFormats, isNoneSchema)
                        }
                        if (sheetSettings.sheetTabColor)
                        {
                            sheet.sheetTabColor(sheetSettings.sheetTabColor)
                        }
                        if (sheetSettings.frozenlineColor)
                        {
                            sheet.frozenlineColor(sheetSettings.frozenlineColor)
                        }
                        if (typeof(sheetSettings.clipBoardOptions) !== const_undefined)
                        {
                            sheet._clipBoardOptions = sheetSettings.clipBoardOptions
                        }
                        if (typeof(sheetSettings.isProtected) !== const_undefined)
                        {
                            sheet.isProtected = sheetSettings.isProtected
                        }
                        if (sheetSettings.borderColor)
                        {
                            sheet.borderColor = sheetSettings.borderColor
                        }
                        if (typeof(sheetSettings.borderWidth) !== const_undefined)
                        {
                            sheet.borderWidth = sheetSettings.borderWidth
                        }
                        if (typeof(sheetSettings.allowUndo) !== const_undefined)
                        {
                            sheet.allowUndo(sheetSettings.allowUndo)
                        }
                        if (typeof(sheetSettings.allowEditorReservedLocations) !== const_undefined)
                        {
                            sheet.allowEditorReservedLocations(sheetSettings.allowEditorReservedLocations)
                        }
                        sheet._namedStyles = {};
                        if (sheetSettings.namedStyles)
                        {
                            for (var i = 0; i < sheetSettings.namedStyles.length; i++)
                            {
                                var item = sheetSettings.namedStyles[i];
                                var style = new Sheets.Style;
                                style.fromJSON(item, isNoneSchema);
                                if (typeof(item.validator) !== const_undefined)
                                {
                                    var dv;
                                    if (Sheets.features.dataValidator)
                                    {
                                        dv = new GcSpread.Sheets.DefaultDataValidator;
                                        dv.fromJSON(item.validator, isNoneSchema)
                                    }
                                    style.validator = dv
                                }
                                sheet._addNamedStyleImp(style, false)
                            }
                        }
                        if (sheetSettings.selectionBackColor)
                        {
                            sheet.selectionBackColor(sheetSettings.selectionBackColor)
                        }
                        if (sheetSettings.selectionBorderColor)
                        {
                            sheet.selectionBorderColor(sheetSettings.selectionBorderColor)
                        }
                        var tables = isNoneSchema ? (sheetSettings.tableManager ? sheetSettings.tableManager.tables : keyword_null) : sheetSettings.tables;
                        if (typeof(tables) !== const_undefined)
                        {
                            if (sheet._tableManager)
                            {
                                sheet._tableManager.fromJSON(tables, isNoneSchema)
                            }
                        }
                        var floatingObjects = isNoneSchema ? (sheetSettings.floatingObjectArray ? sheetSettings.floatingObjectArray.floatingObjects : keyword_null) : sheetSettings.floatingObjects;
                        if (typeof(floatingObjects) !== const_undefined)
                        {
                            if (sheet._floatingObjectArray)
                            {
                                sheet._floatingObjectArray.fromJSON(floatingObjects, isNoneSchema)
                            }
                        }
                        if (typeof(sheetSettings.visible) !== const_undefined)
                        {
                            sheet._visible = sheetSettings.visible
                        }
                        this.clearPendingChanges()
                    }
                    finally
                    {
                        GcSpread.Sheets.switchCulture(oldCulture);
                        sheet.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.formulaFromJSON = function(sheetSettings, isNoneSchema)
                {
                    if (!sheetSettings)
                    {
                        return
                    }
                    var sheet = this;
                    var sheetSettingsNames = sheetSettings.names;
                    if (sheetSettingsNames)
                    {
                        for (var n = 0; n < sheetSettingsNames.length; n++)
                        {
                            var ni = sheetSettingsNames[n];
                            sheet._addCustomNameCore(ni.name, ni.formula, ni.row, ni.col, true)
                        }
                    }
                    var sheetSettingsData = sheetSettings.data;
                    if (sheetSettingsData)
                    {
                        var data = sheetSettingsData.dataTable;
                        if (data)
                        {
                            for (var j in data)
                            {
                                if (typeof(j) !== const_function)
                                {
                                    for (var k in data[j])
                                    {
                                        if (typeof(k) !== const_function)
                                        {
                                            var node = data[j][k];
                                            var formula = node.formula;
                                            if (formula)
                                            {
                                                if (node.arrayInfo)
                                                {
                                                    sheet._setArrayFormulaCore(parseInt(j, 10), parseInt(k, 10), parseInt(node.arrayInfo.rowCount, 10), parseInt(node.arrayInfo.colCount, 10), formula, true)
                                                }
                                                else
                                                {
                                                    sheet._setFormulaCore(parseInt(j, 10), parseInt(k, 10), formula, true)
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    var sparklineGroups = isNoneSchema ? (sheetSettings.sparklineGroupManager ? sheetSettings.sparklineGroupManager.groups : keyword_null) : sheetSettings.sparklineGroups;
                    if (sparklineGroups)
                    {
                        var spm = sheet._sparklineGroupManager;
                        if (spm)
                        {
                            spm.fromJSON(sparklineGroups, isNoneSchema);
                            var groups = spm.groups();
                            var model = sheet._sheetModelManager.getDataModel(),
                                sparklines,
                                sparkline;
                            for (var i = 0; i < groups.length; i++)
                            {
                                sparklines = groups[i]._innerList;
                                for (var j1 = 0; j1 < sparklines.length; j1++)
                                {
                                    sparkline = sparklines[j1];
                                    model.setSparkline(sparkline.row, sparkline.column, sparkline)
                                }
                            }
                        }
                    }
                };
                Sheet.prototype._toArray = function(arrayObj, length)
                {
                    if (!arrayObj)
                    {
                        return keyword_null
                    }
                    var array = [];
                    for (var i = 0; i < length; i++)
                    {
                        if (arrayObj[i] !== keyword_undefined)
                        {
                            array[i] = arrayObj[i]
                        }
                    }
                    return array
                };
                Sheet.prototype.isPaintSuspended = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._paintSuspended
                    }
                    else
                    {
                        if (self._paintSuspended !== value)
                        {
                            self._paintSuspended = value;
                            if (!value && self._layoutSuspended <= 0 && (!self.parent || self.parent.getActiveSheet && self.parent.getActiveSheet() === self))
                            {
                                self.invalidateLayout();
                                self.repaint()
                            }
                        }
                        return self
                    }
                };
                Sheet.prototype.getName = function()
                {
                    return this._name
                };
                Sheet.prototype.setName = function(name)
                {
                    var self = this,
                        parent = self.parent;
                    if (!self._isValidSheetName(name))
                    {
                        throw Sheets.SR.Exp_NotSupport;
                    }
                    this.setNameCore(name);
                    if (parent && parent._doTabHSResize)
                    {
                        parent._doTabHSResize()
                    }
                };
                Sheet.prototype.setNameCore = function(name)
                {
                    var validators = staticMembers.getDataValidatorsBeforeSetSheetName(this);
                    this._name = name;
                    staticMembers.adjustModelFormulasAfterSetSheetName(this);
                    staticMembers.adjustValidatorsAfterSetSheetName(this, validators)
                };
                Sheet.prototype.visible = function(value)
                {
                    var self = this;
                    if (arguments.length == 0)
                    {
                        return self._visible
                    }
                    self._visible = value;
                    var parent = self.parent;
                    if (!parent)
                    {
                        return
                    }
                    var sheets = parent.sheets;
                    var sheetCount = sheets.length;
                    var index = Sheets.util.inArray(self, sheets);
                    var activeSheetIndex = parent.getActiveSheetIndex();
                    if (value)
                    {
                        if (activeSheetIndex < 0)
                        {
                            parent._setActiveSheetIndexImp(index, 1)
                        }
                        else
                        {
                            parent._doTabHSResize()
                        }
                    }
                    else
                    {
                        if (index === activeSheetIndex)
                        {
                            var n = index + 1;
                            while (n < sheetCount && !sheets[n]._visible)
                            {
                                n++
                            }
                            if (n >= sheetCount)
                            {
                                n = index - 1;
                                while (n >= 0 && !sheets[n]._visible)
                                {
                                    n--
                                }
                            }
                            if (n < 0)
                            {
                                self._dispose(false);
                                parent._activeSheetIndex = n;
                                parent._doResize()
                            }
                            else
                            {
                                if (n < parent._tab._firstTab)
                                {
                                    parent._tab._firstTab = n
                                }
                                parent._setActiveSheetIndexImp(n, 1)
                            }
                        }
                        else
                        {
                            parent._doTabHSResize()
                        }
                    }
                    return self
                };
                Sheet.prototype.allowCellOverflow = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._allowCellOverflow
                    }
                    return self._bindToAutoRefresh(function(value)
                        {
                            self._allowCellOverflow = value;
                            return self
                        })(value)
                };
                Sheet.prototype.allowUndo = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._allowUndo
                    }
                    self._allowUndo = value;
                    var undoManager = self.undoManager();
                    if (undoManager)
                    {
                        undoManager._allowUndo = value
                    }
                    return self
                };
                Sheet.prototype.allowEditorReservedLocations = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._allowEditorReservedLocations
                    }
                    this._allowEditorReservedLocations = value;
                    return this
                };
                Sheet.prototype.sheetTabColor = function(value)
                {
                    var self = this,
                        parent = self.parent;
                    if (arguments.length === 0)
                    {
                        return self._sheetTabColor
                    }
                    self._sheetTabColor = value;
                    if (parent && parent._doTabHSResize)
                    {
                        parent._doTabHSResize()
                    }
                    return self
                };
                Sheet.prototype.frozenlineColor = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._frozenlineColor
                    }
                    return self._bindToAutoRefresh(function(value)
                        {
                            if (value)
                            {
                                self._frozenlineColor = value
                            }
                            return self
                        })(value)
                };
                Sheet.prototype.enableFormulaTextbox = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._enableFormulaTextbox
                    }
                    self._enableFormulaTextbox = value;
                    return self
                };
                Sheet.prototype.addRows = function(row, count)
                {
                    if (count <= 0)
                    {
                        return
                    }
                    var self = this;
                    var ds = self.getDataSource();
                    if (ds && Sheets._BindingManager.isDataViewSource(ds))
                    {
                        if (!ds.canAdd || !ds.canAdd())
                        {
                            return
                        }
                        row = self.getRowCount()
                    }
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        if (row < 0 || row > self.getRowCount())
                        {
                            row = self.getRowCount()
                        }
                        var calcModel = self._getCalcModel();
                        if (calcModel)
                        {
                            if (!self._checkArrayFormula(row, 0, 0, self.getColumnCount()))
                            {
                                return
                            }
                            calcModel.getCalcService().getOperatorAdjustor().onBeforeAddRemoveRows(calcModel, row)
                        }
                        var rowInfos = this._sheetModelManager.getRowInfos();
                        rowInfos.addItems(row, count);
                        var m = this._sheetModelManager.getDataModel();
                        m.addRows(row, count);
                        var cutCopyIndicator = self._cutCopyIndicatorManager;
                        if (cutCopyIndicator)
                        {
                            cutCopyIndicator.addRows()
                        }
                        var bm = self._bindingManager;
                        if (bm)
                        {
                            bm.addItems(row, count)
                        }
                        staticMembers.adjustCustomNameOnInsertRemove(self, row, count, true, true);
                        var calc = self._getCalcModel();
                        if (calc)
                        {
                            calc.addRows(row, count)
                        }
                        var rm = self._getModel(2);
                        rm.addRows(row, count);
                        var sm = self._getSpanModel(2);
                        sm.addRows(row, count);
                        sm = self._getSpanModel();
                        sm.addRows(row, count);
                        var rowFilter = self._rowFilter;
                        if (rowFilter)
                        {
                            rowFilter._addRows(row, count)
                        }
                        var rowRangeGroup = self.rowRangeGroup;
                        if (rowRangeGroup)
                        {
                            rowRangeGroup._add(row, count)
                        }
                        var sparklineGroupManager = self._sparklineGroupManager;
                        if (sparklineGroupManager)
                        {
                            sparklineGroupManager._addRows(row, count)
                        }
                        var conditionalFormats = self._conditionalFormats;
                        if (conditionalFormats)
                        {
                            conditionalFormats._addRows(row, count)
                        }
                        var tableManager = self._tableManager;
                        if (tableManager)
                        {
                            tableManager.addRows(row, count)
                        }
                        if (calcModel)
                        {
                            calcModel.getCalcService().getOperatorAdjustor().onAfterAddRemoveRows(calcModel, row, count, true)
                        }
                        var floatingObjectArray = self._floatingObjectArray;
                        if (floatingObjectArray && floatingObjectArray.length > 0)
                        {
                            floatingObjectArray.addRows(row, count)
                        }
                        var commentManager = self._commentManager;
                        if (commentManager)
                        {
                            commentManager.addRows(row, count)
                        }
                        self._needSyncVScrollbarSize = true;
                        self.triggerRowChanged({
                            sheet: self, sheetName: self._name, row: row, count: count, sheetArea: 3, propertyName: "addRows"
                        })
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype._onDataDeleted = function(event){};
                Sheet.prototype.deleteRows = function(row, count)
                {
                    var self = this;
                    if (0 > row || row >= self.getRowCount() || count <= 0)
                    {
                        return
                    }
                    var ds = self.getDataSource();
                    if (ds && Sheets._BindingManager.isDataViewSource(ds))
                    {
                        if (!ds.canRemove || !ds.canRemove())
                        {
                            return
                        }
                    }
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        var calcModel = self._getCalcModel();
                        if (calcModel)
                        {
                            if (!self._checkArrayFormula(row, 0, count, self.getColumnCount()))
                            {
                                return
                            }
                            calcModel.getCalcService().getOperatorAdjustor().onBeforeAddRemoveRows(calcModel, row)
                        }
                        var m = self._getModel();
                        if (self.autoUpdate && self.dataContext && self.dataContext.remove)
                        {
                            if (ds && ds.length > 0)
                            {
                                self._dataDeleteDelegate = function(event)
                                {
                                    return self._onDataDeleted(event)
                                };
                                var n = row;
                                if (n >= 0)
                                {
                                    var item = self.getDataItem(n);
                                    $.ajax({
                                        url: self.dataContext.remove, type: ajax_Type, data: JSON.stringify(item), dataType: ajax_DataType, contentType: ajax_MIME, success: self._dataDeleteDelegate
                                    })
                                }
                            }
                        }
                        if (!self.deletedRows)
                        {
                            self.deletedRows = []
                        }
                        var bm = self._bindingManager;
                        if (bm)
                        {
                            var dataLength = bm.getRowCount();
                            for (var i = 0; i < count && row + i < m.getRowCount(); i++)
                            {
                                var d = null;
                                if (row + i < dataLength)
                                {
                                    d = bm.getDataItem(row + i)
                                }
                                var k = keyword_null;
                                if (m.dataTable && m.dataTable[row + i])
                                {
                                    k = m.dataTable[row + i].key
                                }
                                self.deletedRows.push({
                                    row: row + i, data: d, key: k
                                })
                            }
                        }
                        var rowInfos = this._sheetModelManager.getRowInfos();
                        rowInfos.deleteItems(row, count);
                        m.deleteRows(row, count);
                        if (bm)
                        {
                            bm.removeItems(row, count)
                        }
                        var cutCopyIndicator = self._cutCopyIndicatorManager;
                        if (cutCopyIndicator)
                        {
                            cutCopyIndicator.deleteRows()
                        }
                        staticMembers.adjustCustomNameOnInsertRemove(self, row, count, false, true);
                        var calc = self._getCalcModel();
                        if (calc)
                        {
                            calc.deleteRows(row, count)
                        }
                        var rm = self._getModel(2);
                        rm.deleteRows(row, count);
                        var sm = self._getSpanModel(2);
                        sm.removeRows(row, count);
                        sm = self._getSpanModel();
                        sm.removeRows(row, count);
                        var rowFilter = self._rowFilter;
                        if (rowFilter)
                        {
                            rowFilter._removeRows(row, count)
                        }
                        var rowRangeGroup = self.rowRangeGroup;
                        if (rowRangeGroup)
                        {
                            rowRangeGroup._remove(row, count)
                        }
                        var sparklineGroupManager = self._sparklineGroupManager;
                        if (sparklineGroupManager)
                        {
                            sparklineGroupManager._removeRows(row, count)
                        }
                        var conditionalFormats = self._conditionalFormats;
                        if (conditionalFormats)
                        {
                            conditionalFormats._removeRows(row, count)
                        }
                        var tableManager = self._tableManager;
                        if (tableManager)
                        {
                            tableManager.removeRows(row, count)
                        }
                        var top = self._scrollTopRow;
                        if (top >= 0)
                        {
                            var newTop = -1;
                            for (var t = top; t >= self.frozenRowCount; t--)
                            {
                                if (self.getRowVisible(t) && self._getZoomRowHeight(t) > 0)
                                {
                                    newTop = t;
                                    break
                                }
                            }
                            if (newTop === -1)
                            {
                                newTop = 0
                            }
                            if (top !== newTop)
                            {
                                self._scrollTopRow = newTop;
                                self._syncVScrollbarPosition();
                                self.triggerTopRowChanged({
                                    sheet: self, sheetName: self._name, oldTopRow: top, newTopRow: newTop
                                })
                            }
                        }
                        if (calcModel)
                        {
                            calcModel.getCalcService().getOperatorAdjustor().onAfterAddRemoveRows(calcModel, row, count, false)
                        }
                        var floatingObjectArray = self._floatingObjectArray;
                        if (floatingObjectArray && floatingObjectArray.length > 0)
                        {
                            floatingObjectArray.removeRows(row, count)
                        }
                        var commentManager = self._commentManager;
                        if (commentManager)
                        {
                            commentManager.removeRows(row, count)
                        }
                        self._needSyncVScrollbarSize = true;
                        self.triggerRowChanged({
                            sheet: self, sheetName: self._name, row: row, count: count, sheetArea: 3, propertyName: "deleteRows"
                        })
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.addColumns = function(col, count)
                {
                    if (count <= 0)
                    {
                        return
                    }
                    var self = this;
                    self._bindToAutoRefresh(function(col, count)
                    {
                        if (col < 0 || col > self.getColumnCount())
                        {
                            col = self.getColumnCount()
                        }
                        if (self.parent && self.parent.gcSpreadsheet)
                        {
                            return
                        }
                        var calcModel = self._getCalcModel();
                        if (calcModel)
                        {
                            if (!self._checkArrayFormula(0, col, self.getRowCount(), 0))
                            {
                                return
                            }
                            calcModel.getCalcService().getOperatorAdjustor().onBeforeAddRemoveColumns(calcModel, col)
                        }
                        var colInfos = self._sheetModelManager.getColInfos();
                        colInfos.addItems(col, count);
                        var m = self._getModel();
                        m.addColumns(col, count);
                        var cutCopyIndicator = self._cutCopyIndicatorManager;
                        if (cutCopyIndicator)
                        {
                            cutCopyIndicator.addColumns()
                        }
                        staticMembers.adjustCustomNameOnInsertRemove(self, col, count, true, false);
                        var calc = self._getCalcModel();
                        if (calc)
                        {
                            calc.addColumns(col, count)
                        }
                        var cm = self._getModel(1);
                        cm.addColumns(col, count);
                        var sm = self._getSpanModel(1);
                        sm.addColumns(col, count);
                        sm = self._getSpanModel();
                        sm.addColumns(col, count);
                        var rowFilter = self._rowFilter;
                        if (rowFilter)
                        {
                            rowFilter._addColumns(col, count)
                        }
                        var colRangeGroup = self.colRangeGroup;
                        if (colRangeGroup)
                        {
                            colRangeGroup._add(col, count)
                        }
                        var sparklineGroupManager = self._sparklineGroupManager;
                        if (sparklineGroupManager)
                        {
                            sparklineGroupManager._addColumns(col, count)
                        }
                        var conditionalFormats = self._conditionalFormats;
                        if (conditionalFormats)
                        {
                            conditionalFormats._addColumns(col, count)
                        }
                        var tableManager = self._tableManager;
                        if (tableManager)
                        {
                            tableManager.addColumns(col, count)
                        }
                        if (calcModel)
                        {
                            calcModel.getCalcService().getOperatorAdjustor().onAfterAddRemoveColumns(calcModel, col, count, true)
                        }
                        var floatingObjectArray = self._floatingObjectArray;
                        if (floatingObjectArray && floatingObjectArray.length > 0)
                        {
                            floatingObjectArray.addColumns(col, count)
                        }
                        var commentManager = self._commentManager;
                        if (commentManager)
                        {
                            commentManager.addColumns(col, count)
                        }
                        self._needSyncHScrollbarSize = true;
                        self.triggerColumnChanged({
                            sheet: self, sheetName: self._name, col: col, count: count, sheetArea: 3, propertyName: "addColumns"
                        })
                    })(col, count)
                };
                Sheet.prototype.deleteColumns = function(col, count)
                {
                    var self = this;
                    if (0 > col || col >= self.getColumnCount() || count <= 0)
                    {
                        return
                    }
                    if (self.parent && self.parent.gcSpreadsheet)
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(col, count)
                    {
                        var calcModel = self._getCalcModel();
                        if (calcModel)
                        {
                            if (!self._checkArrayFormula(0, col, self.getRowCount(), count))
                            {
                                return
                            }
                            calcModel.getCalcService().getOperatorAdjustor().onBeforeAddRemoveColumns(calcModel, col)
                        }
                        var colInfos = self._sheetModelManager.getColInfos();
                        colInfos.deleteItems(col, count);
                        var m = self._getModel();
                        m.deleteColumns(col, count);
                        var cutCopyIndicator = self._cutCopyIndicatorManager;
                        if (cutCopyIndicator)
                        {
                            cutCopyIndicator.deleteColumns()
                        }
                        staticMembers.adjustCustomNameOnInsertRemove(self, col, count, false, false);
                        var calc = self._getCalcModel();
                        if (calc)
                        {
                            calc.deleteColumns(col, count)
                        }
                        var cm = self._getModel(1);
                        cm.deleteColumns(col, count);
                        var sm = self._getSpanModel(1);
                        sm.removeColumns(col, count);
                        sm = self._getSpanModel(3);
                        sm.removeColumns(col, count);
                        var rowFilter = self._rowFilter;
                        if (rowFilter)
                        {
                            rowFilter._removeColumns(col, count)
                        }
                        var colRangeGroup = self.colRangeGroup;
                        if (colRangeGroup)
                        {
                            colRangeGroup._remove(col, count)
                        }
                        var sparklineGroupManager = self._sparklineGroupManager;
                        if (sparklineGroupManager)
                        {
                            sparklineGroupManager._removeColumns(col, count)
                        }
                        var conditionalFormats = self._conditionalFormats;
                        if (conditionalFormats)
                        {
                            conditionalFormats._removeColumns(col, count)
                        }
                        var tableManager = self._tableManager;
                        if (tableManager)
                        {
                            tableManager.removeColumns(col, count)
                        }
                        var left = self._scrollLeftCol;
                        if (left >= 0)
                        {
                            var newLeft = -1;
                            for (var t = left; t >= self.frozenColCount; t--)
                            {
                                if (self.getColumnVisible(t) && self._getZoomColumnWidth(t) > 0)
                                {
                                    newLeft = t;
                                    break
                                }
                            }
                            if (newLeft === -1)
                            {
                                newLeft = 0
                            }
                            if (left !== newLeft)
                            {
                                self.triggerLeftColumnChanged({
                                    sheet: self, sheetName: self._name, oldLeftCol: left, newLeftCol: newLeft
                                });
                                self._scrollLeftCol = newLeft;
                                self._syncHScollbarPosition()
                            }
                        }
                        if (calcModel)
                        {
                            calcModel.getCalcService().getOperatorAdjustor().onAfterAddRemoveColumns(calcModel, col, count, false)
                        }
                        var floatingObjectArray = self._floatingObjectArray;
                        if (floatingObjectArray && floatingObjectArray.length > 0)
                        {
                            floatingObjectArray.removeColumns(col, count)
                        }
                        var commentManager = self._commentManager;
                        if (commentManager)
                        {
                            commentManager.removeColumns(col, count)
                        }
                        self._needSyncHScrollbarSize = true;
                        self.triggerColumnChanged({
                            sheet: self, sheetName: self._name, col: col, count: count, sheetArea: 3, propertyName: "deleteColumns"
                        })
                    })(col, count)
                };
                Sheet.prototype.setFrozenCount = function(rowCount, colCount)
                {
                    if (typeof(rowCount) === const_undefined || rowCount === keyword_null || rowCount < 0 || isNaN(rowCount))
                    {
                        rowCount = 0
                    }
                    if (typeof(colCount) === const_undefined || colCount === keyword_null || colCount < 0 || isNaN(colCount))
                    {
                        colCount = 0
                    }
                    var self = this;
                    if (self.frozenRowCount === rowCount && self.frozenColCount === colCount)
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(rowCount, colCount)
                    {
                        var invalid = false;
                        if (self.frozenRowCount !== rowCount)
                        {
                            self._scrollTopRow += rowCount - self.frozenRowCount;
                            self.frozenRowCount = rowCount;
                            invalid = true
                        }
                        if (self.frozenColCount !== colCount)
                        {
                            self._scrollLeftCol += colCount - self.frozenColCount;
                            self.frozenColCount = colCount;
                            invalid = true
                        }
                        if (invalid)
                        {
                            self._needSyncVScrollbarSize = true;
                            self._needSyncHScrollbarSize = true
                        }
                    })(rowCount, colCount)
                };
                Sheet.prototype.setFrozenColumnCount = function(colCount)
                {
                    if (typeof(colCount) === const_undefined || colCount === keyword_null || colCount < 0 || isNaN(colCount))
                    {
                        colCount = 0
                    }
                    var self = this;
                    if (self.frozenColCount === colCount)
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(colCount)
                    {
                        self._scrollLeftCol += colCount - self.frozenColCount;
                        self.frozenColCount = colCount;
                        self._needSyncHScrollbarSize = true
                    })(colCount)
                };
                Sheet.prototype.setFrozenRowCount = function(rowCount)
                {
                    if (typeof(rowCount) === const_undefined || rowCount === keyword_null || rowCount < 0 || isNaN(rowCount))
                    {
                        rowCount = 0
                    }
                    var self = this;
                    if (self.frozenRowCount === rowCount)
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(rowCount)
                    {
                        self._scrollTopRow += rowCount - self.frozenRowCount;
                        self.frozenRowCount = rowCount;
                        self._needSyncVScrollbarSize = true
                    })(rowCount)
                };
                Sheet.prototype.setFrozenTrailingRowCount = function(rowCount)
                {
                    if (typeof(rowCount) === const_undefined || rowCount === keyword_null || rowCount < 0 || isNaN(rowCount))
                    {
                        rowCount = 0
                    }
                    var self = this;
                    if (self._frozenTrailingRowCount === rowCount)
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(rowCount)
                    {
                        self._frozenTrailingRowCount = rowCount;
                        self._needSyncVScrollbarSize = true
                    })(rowCount)
                };
                Sheet.prototype.setFrozenTrailingColumnCount = function(colCount)
                {
                    if (colCount === keyword_undefined || colCount === keyword_null || colCount < 0 || isNaN(colCount))
                    {
                        colCount = 0
                    }
                    var self = this;
                    if (self._frozenTrailingColCount === colCount)
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(colCount)
                    {
                        self._frozenTrailingColCount = colCount;
                        self._needSyncHScrollbarSize = true
                    })(colCount)
                };
                Sheet.prototype.getRowCount = function(sheetArea)
                {
                    var m = this._sheetModelManager.getDataModel(sheetArea);
                    return ((m && m.getRowCount()) || 0)
                };
                Sheet.prototype.getColumnCount = function(sheetArea)
                {
                    var m = this._sheetModelManager.getDataModel(sheetArea);
                    return ((m && m.getColumnCount()) || 0)
                };
                Sheet.prototype.setRowCount = function(rowCount, sheetArea)
                {
                    if (this.getDataSource())
                    {
                        return
                    }
                    this._setRowCountInternal(rowCount, sheetArea)
                };
                Sheet.prototype._setRowCountInternal = function(rowCount, sheetArea)
                {
                    rowCount = parseInt(rowCount, 10);
                    if (isNaN(rowCount))
                    {
                        return
                    }
                    var self = this;
                    if (rowCount < 0 || rowCount === self.getRowCount(sheetArea))
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(rowCount, sheetArea)
                    {
                        if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                        {
                            sheetArea = 3
                        }
                        var modelMgr = self._sheetModelManager;
                        if (sheetArea === 3 || sheetArea === 2)
                        {
                            if (modelMgr.dataModel().getRowCount() > rowCount)
                            {
                                self.deleteRows(rowCount, modelMgr.dataModel().getRowCount() - rowCount)
                            }
                            modelMgr.dataModel().setRowCount(rowCount);
                            modelMgr.rowHeaderModel().setRowCount(rowCount);
                            if (self.frozenRowCount > rowCount)
                            {
                                self.setFrozenRowCount(rowCount)
                            }
                            if (self.rowRangeGroup)
                            {
                                self.rowRangeGroup._setCount(rowCount)
                            }
                        }
                        else if (sheetArea === 1)
                        {
                            var cm = modelMgr.colHeaderModel();
                            if (cm.getRowCount() > rowCount)
                            {
                                var colHeaderRowInfos = modelMgr.getRowInfos(sheetArea);
                                colHeaderRowInfos.deleteItems(rowCount, cm.getRowCount() - rowCount)
                            }
                            cm.setRowCount(rowCount)
                        }
                        self._needSyncVScrollbarSize = true;
                        if (self._activeRowIndex >= rowCount && (sheetArea === 3 || sheetArea === 2))
                        {
                            self._clearSelectionImp();
                            self._setActiveCellImp(0, 0, self.activeRowViewportIndex, self.activeColViewportIndex)
                        }
                        self.clearPendingChanges()
                    })(rowCount, sheetArea)
                };
                Sheet.prototype.setColumnCount = function(colCount, sheetArea)
                {
                    colCount = parseInt(colCount, 10);
                    if (isNaN(colCount))
                    {
                        return
                    }
                    var self = this;
                    if (colCount < 0 || colCount === self.getColumnCount(sheetArea))
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(colCount, sheetArea)
                    {
                        if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                        {
                            sheetArea = 3
                        }
                        var modelMgr = self._sheetModelManager;
                        if (sheetArea === 3 || sheetArea === 1)
                        {
                            if (modelMgr.dataModel().getColumnCount() > colCount)
                            {
                                self.deleteColumns(colCount, modelMgr.dataModel().getColumnCount() - colCount)
                            }
                            modelMgr.dataModel().setColumnCount(colCount);
                            modelMgr.colHeaderModel().setColumnCount(colCount);
                            if (self.frozenColCount > colCount)
                            {
                                self.setFrozenColumnCount(colCount)
                            }
                            if (self.colRangeGroup)
                            {
                                self.colRangeGroup._setCount(colCount)
                            }
                        }
                        else if (sheetArea === 2)
                        {
                            var rm = modelMgr.rowHeaderModel();
                            if (rm.getColumnCount() > colCount)
                            {
                                var rowHeaderColInfos = modelMgr.getColInfos(sheetArea);
                                rowHeaderColInfos.deleteItems(colCount, rm.getColumnCount() - colCount)
                            }
                            rm.setColumnCount(colCount)
                        }
                        self._needSyncHScrollbarSize = true;
                        if (self._activeColIndex >= colCount && (sheetArea === 3 || sheetArea === 1))
                        {
                            self._clearSelectionImp();
                            self._setActiveCellImp(0, 0, self.activeRowViewportIndex, self.activeColViewportIndex)
                        }
                        self.clearPendingChanges()
                    })(colCount, sheetArea)
                };
                Sheet.prototype.getText = function(row, col, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this,
                        v = self.getValue(row, col, sheetArea);
                    if (v === keyword_null || typeof(v) === const_undefined)
                    {
                        return ""
                    }
                    else
                    {
                        var ct = self.getCellType(row, col, sheetArea),
                            fmt = self.getStyleProperty(row, col, "formatter", sheetArea);
                        if (!fmt)
                        {
                            fmt = self.getStyleProperty(row, col, "_autoFormatter", sheetArea)
                        }
                        var context = {
                                sheet: self, row: row, col: col, sheetArea: sheetArea
                            };
                        v = ct.format(v, fmt, context);
                        return v
                    }
                };
                Sheet.prototype.setText = function(row, col, value, sheetArea)
                {
                    var self = this;
                    self._bindToAutoRefresh(function(row, col, value, sheetArea)
                    {
                        if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                        {
                            sheetArea = 3
                        }
                        var isNumber = Sheets.util.isStringNumber(value);
                        if (Sheets.features.formatter && isNumber)
                        {
                            var valueWithoutCulture = Sheets._NumberHelper.replaceCultureSymbolToNormal(value);
                            var aValRef = {};
                            (new Sheets.GeneralFormatter).GetPreferredDisplayFormatter(valueWithoutCulture, aValRef);
                            if (typeof aValRef.value === "number")
                            {
                                value = aValRef.value
                            }
                        }
                        var t = value;
                        var ct = self.getCellType(row, col, sheetArea);
                        var formatStr = self.getCell(row, col, sheetArea).formatter();
                        if (ct && formatStr)
                        {
                            var context = {
                                    sheet: self, row: row, col: col, sheetArea: sheetArea
                                };
                            t = ct.parse(value, formatStr, context)
                        }
                        self._setValueInternal(row, col, t, sheetArea)
                    })(row, col, value, sheetArea)
                };
                Sheet.prototype.getValue = function(row, col, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    var m = self._getModel(sheetArea);
                    if (!m)
                    {
                        return keyword_null
                    }
                    var t = self._getValueImp(m, row, col, sheetArea);
                    var index;
                    if (sheetArea === 1)
                    {
                        if (t === keyword_undefined || t === keyword_null)
                        {
                            var ds = self.getDataSource();
                            if (ds)
                            {
                                var ko = window.ko;
                                if (Sheets._BindingManager.isDataViewSource(ds) || (ds.length > 0) || (ko && ko.isObservable(ds)))
                                {
                                    var ci = self._sheetModelManager.getColInfos()._getItem(col),
                                        colHeaderAutoTextIndex = self.colHeaderAutoTextIndex;
                                    if (ci && ((colHeaderAutoTextIndex >= 0 && row === colHeaderAutoTextIndex) || (colHeaderAutoTextIndex === -1 && row === (m.getRowCount() - 1))))
                                    {
                                        t = ci.displayName || ci.name
                                    }
                                }
                            }
                            if (t === keyword_undefined || t === keyword_null)
                            {
                                index = self.colHeaderAutoTextIndex;
                                if (index < 0 || index >= m.getRowCount())
                                {
                                    index = m.getRowCount() - 1
                                }
                                if (row === index)
                                {
                                    var colHeaderAutoText = self.colHeaderAutoText;
                                    if (colHeaderAutoText === 2)
                                    {
                                        t = self._indexToLetters(col + 1)
                                    }
                                    else if (colHeaderAutoText === 1)
                                    {
                                        t = col + 1
                                    }
                                }
                            }
                        }
                    }
                    else if (sheetArea === 2)
                    {
                        if (t === keyword_undefined || t === keyword_null)
                        {
                            index = this.rowHeaderAutoTextIndex;
                            if (index < 0 || index >= m.getColumnCount())
                            {
                                index = m.getColumnCount() - 1
                            }
                            if (col === index)
                            {
                                var rowHeaderAutoText = self.rowHeaderAutoText;
                                if (rowHeaderAutoText === 2)
                                {
                                    t = self._indexToLetters(row + 1)
                                }
                                else if (rowHeaderAutoText === 1)
                                {
                                    t = row + 1
                                }
                            }
                        }
                    }
                    return t
                };
                Sheet.prototype._getCurrentValue = function(row, col)
                {
                    var sheet = this;
                    if (sheet._isValidatingCell && sheet._validatingRow === row && sheet._validatingColumn === col)
                    {
                        return sheet._validatingValue
                    }
                    else
                    {
                        return sheet.getValue(row, col)
                    }
                };
                Sheet.prototype._getValuesForCalc = function(result, row, col, rowCount, colCount, toOneDimension)
                {
                    var self = this;
                    var m = self._getModel();
                    if (!m)
                    {
                        return
                    }
                    var maxR = self.getRowCount();
                    var maxC = self.getColumnCount();
                    var r,
                        c,
                        colValues,
                        t,
                        needConsideValidating = self._isValidatingCell;
                    for (var i = 0; i < rowCount; i++)
                    {
                        if (!toOneDimension)
                        {
                            colValues = [];
                            result.push(colValues)
                        }
                        for (var j = 0; j < colCount; j++)
                        {
                            if (needConsideValidating && self._validatingRow === i + row && self._validatingColumn === j + col)
                            {
                                t = self._validatingValue;
                                needConsideValidating = false
                            }
                            else
                            {
                                t = self._getValueImp(m, row, col, 3)
                            }
                            if (toOneDimension)
                            {
                                result.push(t)
                            }
                            else
                            {
                                colValues.push(t)
                            }
                        }
                    }
                };
                Sheet.prototype.setValue = function(row, col, value, sheetArea, ignoreRecalc)
                {
                    this._setValueInternal(row, col, value, sheetArea, ignoreRecalc);
                    this.invalidate()
                };
                Sheet.prototype._setValueInternal = function(row, col, value, sheetArea, ignoreRecalc)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    var m = self._getModel(sheetArea);
                    if (!m)
                    {
                        return
                    }
                    var rowCount = m.getRowCount(),
                        colCount = m.getColumnCount();
                    if (row < 0 || row >= rowCount || col < 0 || col >= colCount)
                    {
                        return
                    }
                    var isViewport = (sheetArea === 3);
                    value = staticMembers.tryConvertDateToOADate(value);
                    var oldValue = self._getValueImp(m, row, col, sheetArea);
                    var valueSet = false;
                    var tm = self._tableManager;
                    if (isViewport && tm && tm._tableList.length > 0)
                    {
                        var table = tm.find(row, col);
                        if (table)
                        {
                            if (table.showHeader() && row === table.headerIndex())
                            {
                                if (table._hasColumnName(value))
                                {
                                    return
                                }
                                table._setHeaderName(col, value)
                            }
                            else if (table.showFooter() && row === table.footerIndex())
                            {
                                table._setFooterValue(col, value)
                            }
                            else
                            {
                                valueSet = table._setValue(row, col, value)
                            }
                        }
                    }
                    if (isViewport)
                    {
                        var bm = self._bindingManager;
                        if (!valueSet && bm && bm._dataSource)
                        {
                            var bdValue = bm.getValue(row, col);
                            if (bdValue.hasBinding && value !== bdValue.value)
                            {
                                var oldItem = $.extend({}, self.getDataItem(row));
                                m._updateDirty(row, col, {
                                    originalItem: oldItem, oldValue: oldValue
                                });
                                bm.setValue(row, col, value)
                            }
                            valueSet = bdValue.hasBinding
                        }
                        if (!valueSet || self.checkingChanges)
                        {
                            m.setValue(row, col, value);
                            self._activeRowDirty = true
                        }
                    }
                    else
                    {
                        m.setValue(row, col, value)
                    }
                    if (isViewport && !ignoreRecalc)
                    {
                        self._recalcCell(m, row, col)
                    }
                    var conditionalFormats = self._conditionalFormats;
                    if (conditionalFormats)
                    {
                        conditionalFormats._clearCache()
                    }
                    var isEventsSuspended = (self._eventHandler._eventSuspended > 0);
                    if (!isEventsSuspended && oldValue !== value)
                    {
                        self.triggerCellChanged({
                            sheet: self, sheetName: self._name, row: row, col: col, sheetArea: sheetArea, propertyName: _value, _oldValue: oldValue
                        })
                    }
                };
                Sheet.prototype.sortRange = function(row, column, rowCount, columnCount, byRows, sortInfo)
                {
                    var self = this,
                        formulaAdjustor = Sheets.util.hasCalc() && Sheets.Calc.CalcOperatorAdjustor;
                    return self._bindToAutoRefresh(function(row, column, rowCount, columnCount, byRows, sortInfo)
                        {
                            if (!self._checkArrayFormula(row, 0, rowCount, self.getColumnCount(), false))
                            {
                                return
                            }
                            var oldState = self.isPaintSuspended();
                            self.isPaintSuspended(true);
                            self.suspendEvent();
                            self.suspendCalcService();
                            try
                            {
                                var spans = self.getSpans(new Sheets.Range(row, column, rowCount, columnCount));
                                if (spans && spans.length > 0)
                                {
                                    return false
                                }
                                var rowcnt = self.getRowCount();
                                var colcnt = self.getColumnCount();
                                var ncol,
                                    nrow,
                                    modelrow,
                                    modelcol,
                                    modelrow2,
                                    modelcol2;
                                var array,
                                    data1,
                                    data2,
                                    comment1,
                                    comment2,
                                    indexMapping = [];
                                if (row === -1)
                                {
                                    row = 0
                                }
                                if (rowCount === -1)
                                {
                                    rowCount = rowcnt
                                }
                                if (column === -1)
                                {
                                    column = 0
                                }
                                if (columnCount === -1)
                                {
                                    columnCount = colcnt
                                }
                                if (row < 0 || row >= rowcnt || column < 0 || column >= colcnt || rowCount < 0 || row + rowCount > rowcnt || columnCount < 0 || column + columnCount > colcnt || !sortInfo)
                                {
                                    return false
                                }
                                var changedCells = [];
                                array = self._quickSort(row, column, rowCount, columnCount, byRows, sortInfo);
                                if (array)
                                {
                                    var model = self._getModel(),
                                        calcModel = self._getCalcModel(),
                                        source = self._getSheetSource(),
                                        viewIndex,
                                        expr,
                                        cellCalc;
                                    if (byRows)
                                    {
                                        for (nrow = row; nrow < row + rowCount; nrow++)
                                        {
                                            viewIndex = self._getSwapIndex(array, row, nrow);
                                            indexMapping[viewIndex] = nrow;
                                            if (nrow === viewIndex)
                                            {
                                                continue
                                            }
                                            modelrow = nrow;
                                            modelrow2 = viewIndex;
                                            for (ncol = column; ncol < column + columnCount; ncol++)
                                            {
                                                modelcol = ncol;
                                                data1 = self.getValue(modelrow, modelcol);
                                                data2 = self.getValue(modelrow2, modelcol);
                                                comment1 = self.getComment(modelrow, modelcol);
                                                comment2 = self.getComment(modelrow2, modelcol);
                                                if (calcModel && source)
                                                {
                                                    var cell1Calc = calcModel._getCellCalc(modelrow, modelcol, false);
                                                    if (cell1Calc && cell1Calc.hasListeners())
                                                    {
                                                        cell1Calc.addListenersToAdjust()
                                                    }
                                                    var cell2Calc = calcModel._getCellCalc(modelrow2, modelcol, false);
                                                    if (cell2Calc && cell2Calc.hasListeners())
                                                    {
                                                        cell2Calc.addListenersToAdjust()
                                                    }
                                                    calcModel._swapNode(modelrow, modelcol, modelrow2, modelcol);
                                                    expr = formulaAdjustor._copyExpression(calcModel._getExpr(modelrow, modelcol), modelrow, modelcol, 0, 0);
                                                    calcModel._setExpr(modelrow, modelcol, expr);
                                                    cellCalc = calcModel._getCellCalc(modelrow, modelcol, !!expr);
                                                    if (cellCalc)
                                                    {
                                                        cellCalc.startListening()
                                                    }
                                                    expr = formulaAdjustor._copyExpression(calcModel._getExpr(modelrow2, modelcol), modelrow2, modelcol, 0, 0);
                                                    calcModel._setExpr(modelrow2, modelcol, expr);
                                                    cellCalc = calcModel._getCellCalc(modelrow2, modelcol, !!expr);
                                                    if (cellCalc)
                                                    {
                                                        cellCalc.startListening()
                                                    }
                                                    calcModel.getCalcService().getOperatorAdjustor().adjustFormulasOnMoveSwap(source, modelrow, modelcol, source, modelrow2, modelcol, 1, 1, false)
                                                }
                                                model.swapNode(modelrow, modelcol, modelrow2, modelcol);
                                                self.setComment(modelrow, modelcol, comment2);
                                                self.setComment(modelrow2, modelcol, comment1);
                                                self.setValue(modelrow, modelcol, data2);
                                                self.setValue(modelrow2, modelcol, data1);
                                                changedCells.push(new Sheets.CellPosition(modelrow, modelcol));
                                                changedCells.push(new Sheets.CellPosition(modelrow2, modelcol))
                                            }
                                        }
                                    }
                                    else
                                    {
                                        for (ncol = column; ncol < column + columnCount; ncol++)
                                        {
                                            viewIndex = self._getSwapIndex(array, column, ncol);
                                            if (ncol === viewIndex)
                                            {
                                                continue
                                            }
                                            modelcol = ncol;
                                            modelcol2 = viewIndex;
                                            for (nrow = row; nrow < row + rowCount; nrow++)
                                            {
                                                modelrow = nrow;
                                                data1 = self.getValue(modelrow, modelcol);
                                                data2 = self.getValue(modelrow, modelcol2);
                                                comment1 = self.getComment(modelrow, modelcol);
                                                comment2 = self.getComment(modelrow, modelcol2);
                                                if (calcModel && source)
                                                {
                                                    var cell1Calc = calcModel._getCellCalc(modelrow, modelcol, false);
                                                    if (cell1Calc && cell1Calc.hasListeners())
                                                    {
                                                        cell1Calc.addListenersToAdjust()
                                                    }
                                                    var cell2Calc = calcModel._getCellCalc(modelrow, modelcol2, false);
                                                    if (cell2Calc && cell2Calc.hasListeners())
                                                    {
                                                        cell2Calc.addListenersToAdjust()
                                                    }
                                                    calcModel._swapNode(modelrow, modelcol, modelrow, modelcol2);
                                                    expr = formulaAdjustor._copyExpression(calcModel._getExpr(modelrow, modelcol), modelrow, modelcol, 0, 0);
                                                    calcModel._setExpr(modelrow, modelcol, expr);
                                                    cellCalc = calcModel._getCellCalc(modelrow, modelcol, !!expr);
                                                    if (cellCalc)
                                                    {
                                                        cellCalc.startListening()
                                                    }
                                                    expr = formulaAdjustor._copyExpression(calcModel._getExpr(modelrow, modelcol2), modelrow, modelcol2, 0, 0);
                                                    calcModel._setExpr(modelrow, modelcol2, expr);
                                                    cellCalc = calcModel._getCellCalc(modelrow, modelcol2, !!expr);
                                                    if (cellCalc)
                                                    {
                                                        cellCalc.startListening()
                                                    }
                                                    source.service.getOperatorAdjustor().adjustFormulasOnMoveSwap(source, modelrow, modelcol, source, modelrow, modelcol2, 1, 1, false)
                                                }
                                                model.swapNode(modelrow, modelcol, modelrow, modelcol2);
                                                self.setComment(modelrow, modelcol, comment2);
                                                self.setComment(modelrow, modelcol2, comment1);
                                                self.setValue(modelrow, modelcol, data2);
                                                self.setValue(modelrow, modelcol2, data1);
                                                changedCells.push(new Sheets.CellPosition(modelrow, modelcol));
                                                changedCells.push(new Sheets.CellPosition(modelrow, modelcol2))
                                            }
                                        }
                                    }
                                    return true
                                }
                                return false
                            }
                            finally
                            {
                                self.resumeCalcService();
                                self.resumeEvent();
                                self.isPaintSuspended(oldState);
                                self._raiseRangeDataChanged(row, column, rowCount, columnCount, changedCells, 4)
                            }
                        })(row, column, rowCount, columnCount, byRows, sortInfo)
                };
                Sheet.prototype.clearStyleCache = function()
                {
                    this._styleComposeCache = [{}, {}, {}, {}]
                };
                Sheet.prototype.getActualStyle = function(row, column, sheetArea, sheetStyleOnly, notClone)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this,
                        info,
                        composedStyle,
                        cellStyle,
                        rowStyle,
                        colStyle,
                        cache = self._styleComposeCache,
                        cellCache,
                        rowCache,
                        colCache,
                        sheetAreaCache,
                        table,
                        cellStyleKey,
                        rowStyleKey,
                        colStyleKey;
                    var m = this._sheetModelManager.getDataModel(sheetArea);
                    if (!m)
                    {
                        return new Sheets.Style
                    }
                    cellStyle = m.getStyle(row, column);
                    rowStyle = m.getStyle(row, -1);
                    colStyle = m.getStyle(-1, column);
                    cellStyle = cellStyle ? cellStyle : keyword_null;
                    rowStyle = rowStyle ? rowStyle : keyword_null;
                    colStyle = colStyle ? colStyle : keyword_null;
                    cellStyleKey = cellStyle ? (cellStyle.charAt ? cellStyle : "__spreadJSDefault" + cellStyle._id) : "__undefined";
                    rowStyleKey = rowStyle ? (rowStyle.charAt ? rowStyle : "__spreadJSDefault" + rowStyle._id) : "__undefined";
                    colStyleKey = colStyle ? (colStyle.charAt ? colStyle : "__spreadJSDefault" + colStyle._id) : "__undefined";
                    sheetAreaCache = cache[sheetArea];
                    cellCache = sheetAreaCache[cellStyleKey];
                    var tableManager = self._tableManager;
                    if (tableManager && tableManager.getCount() > 0 && sheetArea === 3)
                    {
                        table = tableManager.find(row, column)
                    }
                    if (!table)
                    {
                        if (!cellCache)
                        {
                            cellCache = sheetAreaCache[cellStyleKey] = {}
                        }
                        rowCache = cellCache[rowStyleKey];
                        if (!rowCache)
                        {
                            rowCache = cellCache[rowStyleKey] = {}
                        }
                        else
                        {
                            colCache = rowCache[colStyleKey]
                        }
                    }
                    if (!colCache)
                    {
                        composedStyle = self.getCompositeStyle(row, column, sheetArea, cellStyle, rowStyle, colStyle, table)
                    }
                    if (sheetArea === 3 && !sheetStyleOnly)
                    {
                        if (!colCache)
                        {
                            var f = composedStyle.formatter;
                            if (f && f.HasFormatedColor && f.HasFormatedColor())
                            {
                                var clr = {value: keyword_null};
                                f.Format(self.getValue(row, column), clr);
                                if (clr.value)
                                {
                                    info = new Sheets.Style;
                                    info.foreColor = clr.value
                                }
                            }
                        }
                        var conditionalFormats = self._conditionalFormats;
                        if (conditionalFormats && conditionalFormats.count() > 0)
                        {
                            var rules = conditionalFormats.getRules(row, column),
                                rulesLength = rules.length,
                                rule,
                                expected = keyword_null;
                            if (rulesLength > 0)
                            {
                                rules.sort(function(a, b)
                                {
                                    return a.priority() - b.priority()
                                });
                                for (var n = 0; n < rulesLength; n++)
                                {
                                    rule = rules[n];
                                    if (!rule)
                                    {
                                        continue
                                    }
                                    if (rule.isScaleRule())
                                    {
                                        if (rule instanceof Sheets.TwoScaleRule || rule instanceof Sheets.ThreeScaleRule)
                                        {
                                            expected = rule.evaluate(self, row, column, self.getValue(row, column, sheetArea));
                                            if (expected)
                                            {
                                                if (!info)
                                                {
                                                    info = new Sheets.Style
                                                }
                                                info.backColor = expected
                                            }
                                        }
                                    }
                                    else
                                    {
                                        expected = rule.evaluate(self, row, column, self.getValue(row, column, sheetArea));
                                        if (expected)
                                        {
                                            if (!info)
                                            {
                                                info = new Sheets.Style
                                            }
                                            info.compose(expected)
                                        }
                                    }
                                    if (rule.stopIfTrue() && expected)
                                    {
                                        break
                                    }
                                }
                            }
                        }
                    }
                    if (info)
                    {
                        info.compose(colCache ? colCache : composedStyle);
                        composedStyle = info
                    }
                    else if (colCache)
                    {
                        return notClone ? colCache : colCache.clone()
                    }
                    if (typeof(composedStyle.locked) === const_undefined || composedStyle.locked === keyword_null)
                    {
                        composedStyle.locked = true
                    }
                    composedStyle = composedStyle._normalize(self._currentTheme);
                    if (!info && !table)
                    {
                        rowCache[colStyleKey] = composedStyle.clone()
                    }
                    return composedStyle
                };
                Sheet.prototype.getStyleProperty = function(row, col, property, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this,
                        s,
                        parentName,
                        temp,
                        m = self._getModel(sheetArea);
                    if (!m)
                    {
                        return keyword_undefined
                    }
                    var result,
                        hasResult = false;
                    if (sheetArea === 3)
                    {
                        if (property === 'foreColor')
                        {
                            var f = self.getStyleProperty(row, col, "formatter", sheetArea);
                            if (f && f.HasFormatedColor && f.HasFormatedColor())
                            {
                                var clr = {value: keyword_null};
                                f.Format(self.getValue(row, col), clr);
                                if (clr.value)
                                {
                                    result = clr.value;
                                    hasResult = true
                                }
                            }
                        }
                        var conditionalFormats = self._conditionalFormats;
                        if (conditionalFormats && conditionalFormats.count() > 0)
                        {
                            var rules = conditionalFormats.getRules(row, col),
                                rulesLength = rules.length,
                                rule,
                                expected = keyword_null;
                            if (rulesLength > 0)
                            {
                                rules.sort(function(a, b)
                                {
                                    return a.priority() - b.priority()
                                });
                                for (var n = 0; n < rulesLength; n++)
                                {
                                    rule = rules[n];
                                    if (!rule)
                                    {
                                        continue
                                    }
                                    if (rule.isScaleRule())
                                    {
                                        if (property === 'backColor')
                                        {
                                            if (rule instanceof Sheets.TwoScaleRule || rule instanceof Sheets.ThreeScaleRule)
                                            {
                                                expected = rule.evaluate(self, row, col, self.getValue(row, col, sheetArea));
                                                if (expected)
                                                {
                                                    result = expected;
                                                    hasResult = true;
                                                    break
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        expected = rule.evaluate(self, row, col, self.getValue(row, col, sheetArea));
                                        if (expected && expected[property] !== keyword_undefined)
                                        {
                                            result = expected[property];
                                            hasResult = true;
                                            break
                                        }
                                    }
                                    if (rule.stopIfTrue() && expected)
                                    {
                                        break
                                    }
                                }
                            }
                        }
                    }
                    var level = 0;
                    while (!hasResult && level <= 4)
                    {
                        if (level === 0)
                        {
                            s = m.getStyle(row, col)
                        }
                        else if (level === 1)
                        {
                            var tableManager = self._tableManager;
                            if (tableManager && tableManager.getCount() > 0 && sheetArea === 3)
                            {
                                var table = tableManager.find(row, col);
                                if (table)
                                {
                                    s = new Sheets.Style;
                                    table._compose(row, col, s)
                                }
                            }
                        }
                        else if (level === 2)
                        {
                            s = m.getStyle(row, -1)
                        }
                        else if (level === 3)
                        {
                            s = m.getStyle(-1, col)
                        }
                        else
                        {
                            s = self.getDefaultStyle()
                        }
                        level++;
                        if (!s)
                        {
                            continue
                        }
                        if (s.charAt && (typeof s === 'string'))
                        {
                            s = self._name2Style(s)
                        }
                        if (s[property] !== keyword_undefined)
                        {
                            result = s[property];
                            hasResult = true;
                            break
                        }
                        parentName = s.parentName;
                        while (parentName)
                        {
                            temp = self._name2Style(parentName);
                            if (!temp)
                            {
                                break
                            }
                            if (temp[property] !== keyword_undefined)
                            {
                                result = temp[property];
                                hasResult = true;
                                break
                            }
                            parentName = temp.parentName
                        }
                    }
                    if (property === "locked")
                    {
                        return (result === keyword_undefined || result === keyword_null) ? true : result
                    }
                    else if (hasResult)
                    {
                        if (property === "foreColor" || property === "backColor" || property === "font" || property === "borderLeft" || property === "borderTop" || property === "borderRight" || property === "borderBottom")
                        {
                            s = new Sheets.Style;
                            s[property] = result;
                            if (property === "font")
                            {
                                var themeFont = self.getStyleProperty(row, col, "themeFont", sheetArea);
                                s.themeFont = themeFont
                            }
                            s._normalize(self._currentTheme);
                            result = s[property]
                        }
                        return result
                    }
                    return keyword_undefined
                };
                Sheet.prototype.getStyle = function(row, col, sheetArea)
                {
                    return this.getStyleImp(row, col, sheetArea, true)
                };
                Sheet.prototype.getStyleImp = function(row, col, sheetArea, clearCache)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var m = this._sheetModelManager.getDataModel(sheetArea);
                    if (m)
                    {
                        var result = m.getStyle(row, col);
                        if (result instanceof Sheets.Style)
                        {
                            this.clearStyleCache();
                            return result
                        }
                        else if (typeof(result) === 'string')
                        {
                            var namedStyle = this._name2Style(result);
                            if (namedStyle !== keyword_null)
                            {
                                var tmp = new Sheets.Style;
                                tmp.compose(namedStyle);
                                this.clearStyleCache();
                                return tmp
                            }
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype.addNamedStyle = function(style)
                {
                    this._addNamedStyleImp(style, true)
                };
                Sheet.prototype._addNamedStyleImp = function(style, refresh)
                {
                    if (style !== keyword_null && style !== keyword_undefined)
                    {
                        if (style.name === keyword_null || style.name === keyword_undefined || style.name === '')
                        {
                            throw new Error(Sheets.SR.Exp_EmptyNamedStyle);
                        }
                        if (refresh)
                        {
                            var self = this;
                            this._bindToAutoRefresh(function(style)
                            {
                                var name = style.name.toUpperCase();
                                self._namedStyles[name] = style
                            })(style)
                        }
                        else
                        {
                            var name = style.name.toUpperCase();
                            this._namedStyles[name] = style
                        }
                    }
                };
                Sheet.prototype.getNamedStyle = function(name)
                {
                    return this.getNamedStyleImp(name, true)
                };
                Sheet.prototype.getNamedStyleImp = function(name, clearCache)
                {
                    var namedStyles = this._namedStyles;
                    if (namedStyles && name)
                    {
                        name = name.toUpperCase();
                        var result = (namedStyles[name] || keyword_null);
                        if (result && clearCache)
                        {
                            this.clearStyleCache()
                        }
                        return result
                    }
                    return keyword_null
                };
                Sheet.prototype.getNamedStyles = function()
                {
                    var namedStylesClone = [],
                        namedStyles = this._namedStyles;
                    if (namedStyles)
                    {
                        $.each(namedStyles, function(index, item)
                        {
                            namedStylesClone.push(item)
                        })
                    }
                    this.clearStyleCache();
                    return namedStylesClone
                };
                Sheet.prototype.removeNamedStyle = function(name)
                {
                    var self = this;
                    if (self._namedStyles && name !== keyword_undefined && name != keyword_null && name !== '')
                    {
                        name = name.toUpperCase();
                        if (self._namedStyles.hasOwnProperty(name))
                        {
                            delete self._namedStyles[name];
                            self.invalidate()
                        }
                    }
                };
                Sheet.prototype.setStyle = function(row, col, value, sheetArea)
                {
                    this.setStyleObject(row, col, value, sheetArea);
                    this.clearStyleCache();
                    this.invalidate()
                };
                Sheet.prototype.getStyleName = function(row, col, sheetArea)
                {
                    var style = this.getStyleObject(row, col, sheetArea);
                    if (style instanceof Sheets.Style)
                    {
                        return style.name
                    }
                    else
                    {
                        return style
                    }
                };
                Sheet.prototype.setStyleName = function(row, col, value, sheetArea)
                {
                    if (typeof value === 'string')
                    {
                        this.setStyleObject(row, col, value, sheetArea);
                        this.invalidate()
                    }
                };
                Sheet.prototype.getStyleObject = function(row, col, sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var result = keyword_null;
                    var m = this._getModel(sheetArea);
                    if (m)
                    {
                        result = m.getStyle(row, col);
                        if (result !== keyword_undefined && result !== keyword_null)
                            return result
                    }
                    return keyword_null
                };
                Sheet.prototype.setStyleObject = function(row, col, value, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    var m = self._getModel(sheetArea);
                    if (m)
                    {
                        var rowCount = m.getRowCount(),
                            colCount = m.getColumnCount();
                        if (row < -1 || row >= rowCount || col < -1 || col >= colCount)
                        {
                            return
                        }
                        m.setStyle(row, col, value);
                        Sheets._DataValidatorCache.setStyle(value, self, row, col);
                        if (value && value.formatter && Sheets.features.formatter)
                        {
                            var formatter = value.formatter;
                            if (formatter && typeof(formatter.Init) === const_function)
                            {
                                formatter.Init()
                            }
                        }
                        var pn = "[styleinfo]";
                        if (row !== -1 && col !== -1)
                        {
                            self.triggerCellChanged({
                                sheet: self, sheetName: self._name, row: row, col: col, sheetArea: sheetArea, propertyName: pn
                            })
                        }
                        else if (row !== -1 && col === -1)
                        {
                            self.triggerRowChanged({
                                sheet: self, sheetName: self._name, row: row, sheetArea: sheetArea, propertyName: pn
                            })
                        }
                        else if (row === -1 && col !== -1)
                        {
                            self.triggerColumnChanged({
                                sheet: self, sheetName: self._name, col: col, sheetArea: sheetArea, propertyName: pn
                            })
                        }
                    }
                };
                Sheet.prototype.getDefaultStyle = function(sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var composedDefaultStyle = this._composedDefaultStyle,
                        cachedStyle = composedDefaultStyle[sheetArea];
                    if (cachedStyle)
                    {
                        return cachedStyle
                    }
                    var m = this._sheetModelManager.getDataModel(sheetArea);
                    if (m)
                    {
                        var sheetDefStyle = m.getStyle(-1, -1);
                        if (typeof(sheetDefStyle) === 'string')
                        {
                            sheetDefStyle = this._name2Style(sheetDefStyle)
                        }
                        if (!sheetDefStyle)
                        {
                            sheetDefStyle = new Sheets.Style;
                            m.setStyle(-1, -1, sheetDefStyle)
                        }
                        var isHeader = (sheetArea === 1 || sheetArea === 2);
                        if (typeof(sheetDefStyle.hAlign) === const_undefined)
                        {
                            sheetDefStyle.hAlign = isHeader ? 1 : 3
                        }
                        if (typeof(sheetDefStyle.vAlign) === const_undefined)
                        {
                            sheetDefStyle.vAlign = isHeader ? 1 : 0
                        }
                        if (typeof(sheetDefStyle.imeMode) === const_undefined)
                        {
                            sheetDefStyle.imeMode = 1
                        }
                        composedDefaultStyle[sheetArea] = sheetDefStyle;
                        return sheetDefStyle
                    }
                    return keyword_null
                };
                Sheet.prototype.setDefaultStyle = function(style, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var m = this._sheetModelManager.getDataModel(sheetArea);
                    if (m)
                    {
                        m.setStyle(-1, -1, style);
                        Sheets._DataValidatorCache.setStyle(style, this, -1, -1)
                    }
                    this._composedDefaultStyle[sheetArea] = keyword_null;
                    this.clearStyleCache()
                };
                Sheet.prototype._name2Style = function(name)
                {
                    var style = this.getNamedStyleImp(name, false);
                    if (style)
                    {
                        return style
                    }
                    var parent = this.parent;
                    if (parent && parent.getNamedStyleImp)
                    {
                        return parent.getNamedStyleImp(name, false)
                    }
                    return keyword_null
                };
                Sheet.prototype.getCompositeStyle = function(row, column, sheetArea, cellStyle, rowStyle, colStyle, table)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this,
                        destInfo = new Sheets.Style,
                        temp,
                        parentName,
                        changed = false,
                        m = self._sheetModelManager.getDataModel(sheetArea);
                    if (m)
                    {
                        var rowCount = m.getRowCount(),
                            colCount = m.getColumnCount(),
                            s;
                        if (0 <= row && row < rowCount && 0 <= column && column < colCount)
                        {
                            s = cellStyle !== undefined ? cellStyle : m.getStyle(row, column);
                            if (s && s.charAt)
                            {
                                s = self._name2Style(s)
                            }
                            if (s)
                            {
                                destInfo.compose(s, true);
                                changed = true;
                                parentName = s.parentName;
                                while (parentName)
                                {
                                    temp = self._name2Style(parentName);
                                    if (!temp)
                                    {
                                        break
                                    }
                                    destInfo.compose(temp);
                                    parentName = temp.parentName
                                }
                            }
                        }
                        if (table === undefined)
                        {
                            var tableManager = self._tableManager;
                            if (tableManager && tableManager.getCount() > 0 && sheetArea === 3)
                            {
                                table = tableManager.find(row, column)
                            }
                        }
                        if (table)
                        {
                            table._compose(row, column, destInfo);
                            changed = true
                        }
                        if (0 <= row && row < rowCount)
                        {
                            s = rowStyle !== undefined ? rowStyle : m.getStyle(row, -1);
                            if (s && s.charAt)
                            {
                                s = self._name2Style(s)
                            }
                            if (s)
                            {
                                destInfo.compose(s, !changed);
                                changed = true;
                                parentName = s.parentName;
                                while (parentName)
                                {
                                    temp = self._name2Style(parentName);
                                    if (!temp)
                                    {
                                        break
                                    }
                                    destInfo.compose(temp);
                                    parentName = temp.parentName
                                }
                            }
                        }
                        if (0 <= column && column < colCount)
                        {
                            s = colStyle !== undefined ? colStyle : m.getStyle(-1, column);
                            if (s && s.charAt)
                            {
                                s = self._name2Style(s)
                            }
                            if (s)
                            {
                                destInfo.compose(s, !changed);
                                changed = true;
                                parentName = s.parentName;
                                while (parentName)
                                {
                                    temp = self._name2Style(parentName);
                                    if (!temp)
                                    {
                                        break
                                    }
                                    destInfo.compose(temp);
                                    parentName = temp.parentName
                                }
                            }
                        }
                    }
                    var sheetInfo = self.getDefaultStyle(sheetArea);
                    if (sheetInfo && sheetInfo.charAt)
                    {
                        sheetInfo = self._name2Style(sheetInfo)
                    }
                    if (sheetInfo)
                    {
                        destInfo.compose(sheetInfo, !changed);
                        parentName = sheetInfo.parentName;
                        while (parentName)
                        {
                            temp = self._name2Style(parentName);
                            if (!temp)
                            {
                                break
                            }
                            destInfo.compose(temp);
                            parentName = temp.parentName
                        }
                    }
                    return destInfo
                };
                Sheet.prototype.getCellType = function(row, col, sheetArea)
                {
                    return this.getStyleProperty(row, col, "cellType", sheetArea) || this.getDefaultCellType(sheetArea)
                };
                Sheet.prototype.getDefaultCellType = function(sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var defaultCellType = this._defaultCellType;
                    if (!defaultCellType)
                    {
                        defaultCellType = this._defaultCellType = new Sheets.TextCellType
                    }
                    if (sheetArea === 3)
                    {
                        return defaultCellType
                    }
                    else if (sheetArea === 1)
                    {
                        return new Sheets.ColumnHeaderCellType
                    }
                    else if (sheetArea === 2)
                    {
                        return new Sheets.RowHeaderCellType
                    }
                    else if (sheetArea === 0)
                    {
                        return new Sheets.CornerCellType
                    }
                    else
                    {
                        return defaultCellType
                    }
                };
                Sheet.prototype.setCellType = function(row, col, value, sheetArea)
                {
                    var style = this.getStyleImp(row, col, sheetArea);
                    if (!style)
                    {
                        style = new Sheets.Style
                    }
                    style.cellType = value;
                    this.setStyle(row, col, style, sheetArea)
                };
                Sheet.prototype.getFormatter = function(row, col, sheetArea)
                {
                    return this.getStyleProperty(row, col, "formatter", sheetArea)
                };
                Sheet.prototype.setFormatter = function(row, col, value, sheetArea)
                {
                    var style = this.getStyleImp(row, col, sheetArea);
                    if (!style)
                    {
                        style = new Sheets.Style
                    }
                    style.formatter = value;
                    this.setStyle(row, col, style, sheetArea)
                };
                Sheet.prototype.getDataValidator = function(row, col, sheetArea)
                {
                    return this.getStyleProperty(row, col, "validator", sheetArea)
                };
                Sheet.prototype.setDataValidator = function(row, col, value, sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    var style = self.getStyleImp(row, col, sheetArea);
                    if (!style)
                    {
                        style = new Sheets.Style
                    }
                    style.validator = value;
                    self.suspendEvent();
                    self.setStyle(row, col, style, sheetArea);
                    self.resumeEvent();
                    if (Sheets.features.conditionalFormat && value && (value.condition instanceof Sheets.FormulaCondition))
                    {
                        var formulaCondition = value.condition;
                        if ((formulaCondition._baseRow === keyword_undefined || formulaCondition._baseRow === keyword_null))
                        {
                            formulaCondition._baseRow = row !== -1 ? row : 0
                        }
                        if ((formulaCondition._baseCol === keyword_undefined || formulaCondition._baseCol === keyword_null))
                        {
                            formulaCondition._baseCol = col !== -1 ? col : 0
                        }
                    }
                    var E = Sheets.Events,
                        pn = "validator";
                    self.triggerCellChanged({
                        sheet: self, sheetName: self._name, row: row, col: col, sheetArea: sheetArea, propertyName: pn
                    });
                    if (row !== -1 && col === -1)
                    {
                        self.triggerRowChanged({
                            sheet: self, sheetName: self._name, row: row, sheetArea: sheetArea, propertyName: pn
                        })
                    }
                    else if (row === -1 && col !== -1)
                    {
                        self.triggerColumnChanged({
                            sheet: self, sheetName: self._name, col: col, sheetArea: sheetArea, propertyName: pn
                        })
                    }
                };
                Sheet.prototype.isValid = function(row, column, value)
                {
                    try
                    {
                        var self = this;
                        self._validatingRow = row;
                        self._validatingColumn = column;
                        self._validatingValue = value;
                        self._isValidatingCell = true;
                        var dv = self.getDataValidator(row, column);
                        if (dv)
                        {
                            return dv.isValid(self, row, column, value)
                        }
                    }
                    finally
                    {
                        self._validatingRow = -1;
                        self._validatingColumn = -1;
                        self._validatingValue = keyword_null;
                        self._isValidatingCell = false
                    }
                    return true
                };
                Sheet.prototype.addSelection = function(row, column, rowCount, columnCount)
                {
                    var self = this;
                    self._bindToAutoRefresh(function(row, column, rowCount, columnCount)
                    {
                        var r = row;
                        var c = column;
                        var rc = rowCount;
                        var cc = columnCount;
                        if (r !== -1 && c !== -1)
                        {
                            var spans = self._getSpanModel().getSpans();
                            if (spans && spans.length > 0)
                            {
                                var newSelection = self._cellRangeInflate(spans, new Sheets.Range(row, column, rowCount, columnCount));
                                r = newSelection.row;
                                c = newSelection.col;
                                rc = newSelection.rowCount;
                                cc = newSelection.colCount
                            }
                        }
                        self._selectionModel.add(r, c, rc, cc)
                    })(row, column, rowCount, columnCount)
                };
                Sheet.prototype.setSelection = function(row, column, rowCount, columnCount)
                {
                    this._setSelectionImp(row, column, rowCount, columnCount, 2)
                };
                Sheet.prototype._setSelectionImp = function(row, column, rowCount, columnCount, focusPolicy)
                {
                    var self = this;
                    var sheetRowCount = self.getRowCount();
                    var sheetColCount = self.getColumnCount();
                    if (row >= sheetRowCount)
                    {
                        row = sheetRowCount - 1
                    }
                    var activeRow = row;
                    if (activeRow < 0)
                    {
                        activeRow = 0
                    }
                    var activeCol = column;
                    if (column >= sheetColCount)
                    {
                        column = sheetColCount - 1
                    }
                    if (activeCol < 0)
                    {
                        activeCol = 0
                    }
                    self._clearSelectionImp();
                    var setFocus = true;
                    switch (focusPolicy)
                    {
                        case 1:
                            setFocus = true;
                            break;
                        case 0:
                            setFocus = false;
                            break;
                        case 2:
                            setFocus = Sheets.FocusHelper.isActiveElement(self);
                            break
                    }
                    var rowViewportIndex = 1;
                    if (activeRow < self.frozenRowCount)
                    {
                        rowViewportIndex = 0
                    }
                    else if (activeRow >= sheetRowCount - self._frozenTrailingRowCount)
                    {
                        rowViewportIndex = 2
                    }
                    var colViewportIndex = 1;
                    if (activeCol < self.frozenColCount)
                    {
                        colViewportIndex = 0
                    }
                    else if (activeCol >= sheetColCount - self._frozenTrailingColCount)
                    {
                        colViewportIndex = 2
                    }
                    self._setActiveCellImp(activeRow, activeCol, rowViewportIndex, colViewportIndex, !setFocus);
                    self.addSelection(row, column, rowCount, columnCount)
                };
                Sheet.prototype.getSelections = function()
                {
                    return this._selectionModel.toArray()
                };
                Sheet.prototype._addSpanImp = function(row, col, rowCount, colCount, sheetArea)
                {
                    var self = this;
                    self._bindToAutoRefresh(function(row, col, rowCount, colCount, sheetArea)
                    {
                        if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                        {
                            sheetArea = 3
                        }
                        var sm = self._getSpanModel(sheetArea);
                        sm.clear(row, col, rowCount, colCount);
                        var r = new Sheets.Range(row, col, rowCount, colCount);
                        var newRange = self._getActualRange(r, sheetArea);
                        sm.addSpan(newRange);
                        if (sheetArea === 3)
                        {
                            var selections = self.getSelections();
                            for (var i = 0; i < selections.length; i++)
                            {
                                if (selections[i].intersect(row, col, rowCount, colCount))
                                {
                                    selections[i] = selections[i].union(r)
                                }
                            }
                            self._selectionModel.fromArray(selections)
                        }
                    })(row, col, rowCount, colCount, sheetArea)
                };
                Sheet.prototype.addSpan = function(row, col, rowCount, colCount, sheetArea)
                {
                    var self = this;
                    if (rowCount === 1 && colCount === 1)
                    {
                        return
                    }
                    if (sheetArea === 0)
                    {
                        return
                    }
                    var canSpan = true;
                    if (sheetArea === 3 || sheetArea === undefined)
                    {
                        canSpan = self._checkArrayFormula(row, col, rowCount, colCount, false)
                    }
                    if (canSpan)
                    {
                        var sm = self._getSpanModel(sheetArea);
                        if (sm.hasPartSpans(row, col, rowCount, colCount))
                        {
                            throw new Error(Sheets.SR.Exp_InvalidRange);
                        }
                        self._addSpanImp(row, col, rowCount, colCount, sheetArea);
                        self._updateCommentsInSpanChangedArea(true, row, col, rowCount, colCount)
                    }
                };
                Sheet.prototype.removeSpan = function(row, col, sheetArea)
                {
                    var self = this;
                    this._bindToAutoRefresh(function(row, col, sheetArea)
                    {
                        if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                        {
                            sheetArea = 3
                        }
                        var sm = self._getSpanModel(sheetArea);
                        for (var i = 0; i < sm.length; i++)
                        {
                            var rg = sm[i];
                            if (rg.row === row && rg.col === col)
                            {
                                sm.removeSpan(i, 1);
                                return
                            }
                        }
                    })(row, col, sheetArea);
                    self._updateCommentsInSpanChangedArea(false, row, col)
                };
                Sheet.prototype._updateCommentsInSpanChangedArea = function(isAddSpan, row, col, rowCount, colCount)
                {
                    var self = this;
                    if (isAddSpan && self._commentManager)
                    {
                        var comments = self._commentManager.getCommentList();
                        for (var i = 0; i < comments.length; i++)
                        {
                            var comment = comments[i];
                            var rowIndex = comment._rowIndex,
                                colIndex = comment._colIndex;
                            if (rowIndex === row && colIndex === col)
                            {
                                continue
                            }
                            if (rowIndex >= row && rowIndex < row + rowCount && colIndex >= col && colIndex < col + colCount)
                            {
                                self.setComment(rowIndex, colIndex, keyword_null)
                            }
                        }
                    }
                    var comment = self.getComment(row, col);
                    if (comment)
                    {
                        var view = self._commentManager.getCommentView(comment);
                        if (view)
                        {
                            view.updateLayoutWhenCellSpanChanged()
                        }
                    }
                };
                Sheet.prototype.repaint = function(clipRect)
                {
                    if (!this._paintSuspended)
                    {
                        this._render.repaint(clipRect)
                    }
                };
                Sheet.prototype.startEdit = function(selectAll, defaultText)
                {
                    var self = this;
                    self._startEditImp(self._getCanvas(), self._activeRowIndex, self._activeColIndex, keyword_null, keyword_null, selectAll, defaultText)
                };
                Sheet.prototype.editorStatus = function()
                {
                    return (this._editorStatus) ? this._editorStatus : 0
                };
                Sheet.prototype.isEditing = function()
                {
                    return this._editorStatus === 1 || this._editorStatus === 2
                };
                Sheet.prototype.doKeyDown = function(event)
                {
                    this._eventHandler.doKeyDown(event)
                };
                Sheet.prototype.doKeyUp = function(event)
                {
                    this._eventHandler.doKeyUp(event)
                };
                Sheet.prototype.doCompositionStart = function()
                {
                    this._eventHandler.doCompositionStart()
                };
                Sheet.prototype.removeKeyMap = function(keyCode, ctrl, shift, alt, meta)
                {
                    var keyMap = this.keyMap;
                    if (!keyMap)
                    {
                        return
                    }
                    meta = (typeof(meta) === 'function' ? false : meta);
                    for (var i = 0; i < keyMap.length; i++)
                    {
                        var ka = keyMap[i];
                        if (ka && ka.key === keyCode && ka.ctrl === ctrl && ka.shift === shift && ka.alt === alt && ka.meta === meta)
                        {
                            keyMap.splice(i, 1);
                            break
                        }
                    }
                };
                Sheet.prototype.removeFloatingObjectKeyMap = function(keyCode, ctrl, shift, alt, meta, action)
                {
                    var foKeyMap = this.floatingObjectKeyMap;
                    if (!foKeyMap)
                    {
                        return
                    }
                    var mapMeta = action && meta || false,
                        mapAction = action || meta,
                        meta = mapMeta,
                        action = mapAction;
                    for (var i = 0; i < foKeyMap.length; i++)
                    {
                        var ka = foKeyMap[i];
                        if (ka && ka.key === keyCode && ka.ctrl === ctrl && ka.shift === shift && ka.alt === alt && ka.meta === meta)
                        {
                            foKeyMap.splice(i, 1);
                            break
                        }
                    }
                };
                Sheet.prototype.removeCommentKeyMap = function(keyCode, ctrl, shift, alt, meta, action)
                {
                    var self = this;
                    if (!self._commentKeyMap)
                    {
                        return
                    }
                    var mapMeta = action && meta || false,
                        mapAction = action || meta,
                        meta = mapMeta,
                        action = mapAction;
                    for (var i = 0; i < self._commentKeyMap.length; i++)
                    {
                        var ka = self._commentKeyMap[i];
                        if (ka && ka.key === keyCode && ka.ctrl === ctrl && ka.shift === shift && ka.alt === alt && ka.meta === meta)
                        {
                            self._commentKeyMap.splice(i, 1);
                            break
                        }
                    }
                };
                Sheet.prototype.addKeyMap = function(keyCode, ctrl, shift, alt, meta, action)
                {
                    var self = this;
                    if (!self.keyMap)
                    {
                        self.keyMap = []
                    }
                    var mapMeta = action && meta || false,
                        mapAction = action || meta,
                        meta = mapMeta,
                        action = mapAction;
                    var ka = self._getKeyAction(keyCode, ctrl, shift, alt, meta);
                    if (ka)
                    {
                        ka.action = action
                    }
                    else
                    {
                        self.keyMap.push(new Sheets.KeyMap(keyCode, ctrl, shift, alt, meta, action))
                    }
                };
                Sheet.prototype.addFloatingObjectKeyMap = function(keyCode, ctrl, shift, alt, meta, action)
                {
                    var self = this;
                    if (!self.floatingObjectKeyMap)
                    {
                        self.floatingObjectKeyMap = []
                    }
                    var mapMeta = action && meta || false,
                        mapAction = action || meta,
                        meta = mapMeta,
                        action = mapAction;
                    var ka = self._getFloatingObjectKeyAction(keyCode, ctrl, shift, alt, meta);
                    if (ka)
                    {
                        ka.action = action
                    }
                    else
                    {
                        self.floatingObjectKeyMap.push(new Sheets.KeyMap(keyCode, ctrl, shift, alt, meta, action))
                    }
                };
                Sheet.prototype.addCommentKeyMap = function(keyCode, ctrl, shift, alt, meta, action)
                {
                    var self = this;
                    if (!self._commentKeyMap)
                    {
                        self._commentKeyMap = []
                    }
                    var mapMeta = action && meta || false,
                        mapAction = action || meta,
                        meta = mapMeta,
                        action = mapAction;
                    var ka = self._getCommentKeyAction(keyCode, ctrl, shift, alt, meta);
                    if (ka)
                    {
                        ka.action = action
                    }
                    else
                    {
                        self._commentKeyMap.push(new Sheets.KeyMap(keyCode, ctrl, shift, alt, meta, action))
                    }
                };
                Sheet.prototype._moveFormulaTextBoxCell = function(direction, wrap, beginRow, beginCol)
                {
                    var self = this;
                    var fbx = self._formulaTextBox;
                    if (!fbx || !fbx.canAppendRange() || (self.parent && !self.parent.canUserEditFormula()) || !self._enableFormulaTextbox)
                    {
                        return
                    }
                    var appendingInfo = self._getKeyboardAppendingInfo();
                    var anchorRow = appendingInfo.anchorRow,
                        anchorCol = appendingInfo.anchorCol,
                        leadingRow = appendingInfo.leadingRow,
                        leadingCol = appendingInfo.leadingCol;
                    if (typeof(beginRow) === const_undefined || beginRow === keyword_null)
                    {
                        beginRow = anchorRow
                    }
                    if (typeof(beginCol) === const_undefined || beginCol === keyword_null)
                    {
                        beginCol = anchorCol
                    }
                    var eventHandler = self._eventHandler;
                    var newAnchorRow,
                        newAnchorCol,
                        newLeadingRow,
                        newLeadingCol;
                    var nextCell;
                    switch (direction)
                    {
                        case 3:
                        case 4:
                            if (direction === 3)
                            {
                                nextCell = self._getMoveLeftCell(beginRow, beginCol, wrap, leadingRow)
                            }
                            else
                            {
                                nextCell = self._getMoveRightCell(beginRow, beginCol, wrap, leadingRow)
                            }
                            if (!nextCell)
                            {
                                return
                            }
                            newAnchorRow = nextCell.row;
                            newAnchorCol = nextCell.col;
                            newLeadingRow = nextCell.leadingCellRow;
                            if (!self._canMoveCurrentTo(newAnchorRow, newAnchorCol))
                            {
                                return
                            }
                            appendingInfo.anchorRow = newAnchorRow;
                            appendingInfo.anchorCol = newAnchorCol;
                            appendingInfo.leadingRow = newLeadingRow;
                            appendingInfo.leadingCol = newAnchorCol;
                            var rangeString = eventHandler.rangeToString(new Sheets.Range(newAnchorRow, newAnchorCol, 1, 1));
                            if (rangeString)
                            {
                                fbx.appendRange(rangeString, false, true)
                            }
                            break;
                        case 1:
                        case 2:
                            if (direction === 1)
                            {
                                nextCell = self._getMoveUpCell(beginRow, beginCol, wrap, leadingCol)
                            }
                            else
                            {
                                nextCell = self._getMoveDownCell(beginRow, beginCol, wrap, leadingCol)
                            }
                            if (!nextCell)
                            {
                                return
                            }
                            newAnchorRow = nextCell.row;
                            newAnchorCol = nextCell.col;
                            newLeadingCol = nextCell.leadingCellCol;
                            if (!self._canMoveCurrentTo(newAnchorRow, newAnchorCol))
                            {
                                return
                            }
                            appendingInfo.anchorRow = newAnchorRow;
                            appendingInfo.anchorCol = newAnchorCol;
                            appendingInfo.leadingRow = newAnchorRow;
                            appendingInfo.leadingCol = newLeadingCol;
                            var rangeString = eventHandler.rangeToString(new Sheets.Range(newAnchorRow, newAnchorCol, 1, 1));
                            if (rangeString)
                            {
                                fbx.appendRange(rangeString, false, true)
                            }
                            break;
                        default:
                            break
                    }
                    if (newAnchorRow >= 0 && newAnchorCol >= 0)
                    {
                        self._scrollByMoveCell(newAnchorRow, newAnchorCol)
                    }
                };
                Sheet.prototype._changeFormulaTextBoxActiveRange = function(key, isCtrl)
                {
                    var self = this;
                    var fbx = self._formulaTextBox;
                    if (!fbx || !fbx.canAppendRange() || (self.parent && !self.parent.canUserEditFormula()) || !self._enableFormulaTextbox)
                    {
                        return
                    }
                    var eventHandler = self._eventHandler,
                        appendingInfo = self._getKeyboardAppendingInfo(),
                        anchorRow = appendingInfo.anchorRow,
                        anchorCol = appendingInfo.anchorCol;
                    var range;
                    if (fbx.isAppending())
                    {
                        var activeParamRange = fbx.getActiveRange();
                        range = eventHandler.stringToRange(activeParamRange.text)
                    }
                    else
                    {
                        range = new Sheets.Range(anchorRow, anchorCol, 1, 1)
                    }
                    if (range)
                    {
                        var newRange = self._getKeyboardSelectedRange(range, key, isCtrl, anchorRow, anchorCol);
                        var rangeString = eventHandler.rangeToString(newRange);
                        if (rangeString)
                        {
                            fbx.appendRange(rangeString, true, false)
                        }
                    }
                };
                Sheet.prototype._getKeyboardAppendingInfo = function()
                {
                    var appendingInfo;
                    var self = this;
                    var fbx = self._formulaTextBox,
                        eventHandler = self._eventHandler;
                    if (fbx.isAppending())
                    {
                        appendingInfo = eventHandler._formulaRangeAppendingInfo
                    }
                    else
                    {
                        appendingInfo = eventHandler._formulaRangeAppendingInfo = {
                            anchorRow: self._activeRowIndex, anchorCol: self._activeColIndex, leadingRow: self._leadingCellRow, leadingCol: self._leadingCellCol
                        }
                    }
                    return appendingInfo
                };
                Sheet.prototype.moveActiveCell = function(dir, wrap, beginRow, beginCol)
                {
                    var self = this;
                    var args = {
                            sheet: self, sheetName: self._name, row: self._activeRowIndex, col: self._activeColIndex, cancel: false
                        };
                    self.triggerLeaveCell(args);
                    if (args && args.cancel === true)
                    {
                        return
                    }
                    if (!self.endEdit())
                    {
                        return
                    }
                    if (self._activeRowDirty)
                    {
                        self.updateRecord();
                        self._activeRowDirty = false
                    }
                    var prevRowIndex = self._activeRowIndex;
                    var prevcolIndex = self._activeColIndex;
                    if (beginRow === keyword_undefined || beginRow === keyword_null)
                    {
                        beginRow = self._activeRowIndex
                    }
                    if (beginCol === keyword_undefined || beginCol === keyword_null)
                    {
                        beginCol = self._activeColIndex
                    }
                    var Dir = Sheets.Direction;
                    if (dir === 3)
                    {
                        self._moveActiveCellLeft(beginRow, beginCol, wrap)
                    }
                    else if (dir === 4)
                    {
                        self._moveActiveCellRight(beginRow, beginCol, wrap)
                    }
                    else if (dir === 1)
                    {
                        self._moveActiveCellUp(beginRow, beginCol, wrap)
                    }
                    else if (dir === 2)
                    {
                        self._moveActiveCellDown(beginRow, beginCol, wrap)
                    }
                    self.moveActiveCellEnd(dir, prevRowIndex, prevcolIndex)
                };
                Sheet.prototype._moveActiveCellInSelection = function(dir)
                {
                    var self = this;
                    var args = {
                            sheet: self, sheetName: self._name, row: self._activeRowIndex, col: self._activeColIndex, cancel: false
                        };
                    self.triggerLeaveCell(args);
                    if (args && args.cancel === true)
                    {
                        return
                    }
                    self.endEdit();
                    if (self._activeRowDirty)
                    {
                        self.updateRecord();
                        self._activeRowDirty = false
                    }
                    var prevRowIndex = self._activeRowIndex;
                    var prevcolIndex = self._activeColIndex;
                    if (dir === 3)
                    {
                        self._moveActiveCellLeftInSelection(self._activeRowIndex, self._activeColIndex)
                    }
                    else if (dir === 4)
                    {
                        self._moveActiveCellRightInSelection(self._activeRowIndex, self._activeColIndex)
                    }
                    self.moveActiveCellEnd(dir, prevRowIndex, prevcolIndex)
                };
                Sheet.prototype.doDataItemChanged = function()
                {
                    var bm = this._bindingManager;
                    if (bm)
                    {
                        bm.doDataItemChanged()
                    }
                };
                Sheet.prototype.moveActiveCellEnd = function(dir, prevRowIndex, prevcolIndex)
                {
                    var self = this,
                        handler = self._eventHandler;
                    ;
                    var oldSelections = self._selectionModel.toArray(),
                        needRepaint = false;
                    if (!self._isNavigateInSelection)
                    {
                        var activeSelectedRange = self._fixRange(self._getActiveSelectedRange());
                        if (self._selectionModel.length > 1 || activeSelectedRange.rowCount > 1 || activeSelectedRange.colCount > 1)
                        {
                            needRepaint = true
                        }
                        self._clearSelectionImp()
                    }
                    var activeRowIndex = self._activeRowIndex,
                        activeColIndex = self._activeColIndex,
                        span = self._getSpanModel().find(activeRowIndex, activeColIndex);
                    if (span)
                    {
                        self._activeRowCount = span.rowCount;
                        self._activeColCount = span.colCount
                    }
                    else
                    {
                        self._activeRowCount = 1;
                        self._activeColCount = 1
                    }
                    if (!self._isNavigateInSelection)
                    {
                        var activeRange = self._getExtendedRange(activeRowIndex, activeColIndex);
                        var selectionPolicy = self.selectionPolicy(),
                            selectionUnit = self.selectionUnit();
                        if (selectionPolicy === 0)
                        {
                            self._selectionModel.clear()
                        }
                        else if (selectionPolicy === 1)
                        {
                            self._selectionModel.clear()
                        }
                        if (selectionUnit === 1)
                        {
                            activeRange.col = -1;
                            activeRange.colCount = -1
                        }
                        else if (selectionUnit === 2)
                        {
                            activeRange.row = -1;
                            activeRange.rowCount = -1
                        }
                        self._replaceActiveSelectedRange(activeRange.row, activeRange.col, activeRange.rowCount, activeRange.colCount, false);
                        var newSelections = self._selectionModel.toArray();
                        if (handler._notEqualSelecions(oldSelections, newSelections))
                        {
                            var E = Sheets.Events;
                            self.triggerSelectionChanging({
                                sheet: self, sheetName: self._name, oldSelections: oldSelections, newSelections: newSelections
                            });
                            self.triggerSelectionChanged({
                                sheet: self, sheetName: self._name
                            })
                        }
                    }
                    var savedTopRow = self._scrollTopRow;
                    self._scrollByMoveCell(activeRowIndex, activeColIndex);
                    if (prevRowIndex != activeRowIndex)
                    {
                        self.doDataItemChanged()
                    }
                    var render = self._render;
                    if (needRepaint)
                    {
                        var layout = self._getSheetLayout(),
                            x = layout.headerX,
                            y = layout.headerY,
                            width = layout.width - x,
                            height = layout.height - y;
                        render.copyDoubleBuffer(x, y, width, height);
                        render.repaint(new Sheets.Rect(x, y, width, layout.colHeaderHeight));
                        render.repaint(new Sheets.Rect(x, y, layout.rowHeaderWidth, height));
                        render.paintAdornment(render._getCtx())
                    }
                    else
                    {
                        var rs,
                            cs,
                            prevSpan = self._getSpanModel().find(prevRowIndex, prevcolIndex);
                        if (prevSpan)
                        {
                            rs = prevSpan.rowCount;
                            cs = prevSpan.colCount
                        }
                        else
                        {
                            rs = 1;
                            cs = 1
                        }
                        render.repaintSelection(new Sheets.Range(activeRowIndex, activeColIndex, self._activeRowCount, self._activeColCount).union(new Sheets.Range(prevRowIndex, prevcolIndex, rs, cs)))
                    }
                    var bLoadData = (savedTopRow !== self._scrollTopRow);
                    if (bLoadData)
                    {
                        var vpRowLayouts = self._getViewportRowLayout(1),
                            vpRowCount = (vpRowLayouts && vpRowLayouts.length);
                        if (vpRowCount > 0)
                        {
                            var topRow = vpRowLayouts[0].row;
                            var bottomRow = vpRowLayouts[vpRowCount - 1].row;
                            var start = Math_max(0, topRow - 60);
                            if (start < self.getRowCount())
                            {
                                handler._loadData(start, 2 * bottomRow - topRow)
                            }
                        }
                    }
                    self.triggerEnterCell({
                        sheet: self, sheetName: self._name, row: activeRowIndex, col: activeColIndex
                    });
                    handler._updateValidationUI(activeRowIndex, activeColIndex)
                };
                Sheet.prototype._scrollByMoveCell = function(cellRowIndex, cellColIndex)
                {
                    var self = this;
                    var firstCol = self.frozenColCount ? self._getNextVisualColumn(self.frozenColCount - 1) : self._getFirstVisualColumn();
                    var firstRow1 = self.frozenRowCount ? self._getNextVisualRow(self.frozenRowCount - 1) : self._getFirstVisualRow();
                    if (cellColIndex < self._scrollLeftCol && cellColIndex >= firstCol)
                    {
                        self._setLeftColumn(self._getPrevVisualColumn(cellColIndex + 1))
                    }
                    if (cellColIndex > self._getLastFullyVisibleColumn() && cellColIndex <= self._getLastVisualColumn())
                    {
                        var w = 0;
                        var c = cellColIndex;
                        var sheetLayout1 = self._getSheetLayout();
                        var tempSpan = self._getSpanModel().find(cellRowIndex, c);
                        if (tempSpan)
                        {
                            c = tempSpan.col + tempSpan.colCount - 1
                        }
                        while (c > self._scrollLeftCol)
                        {
                            w += self._getZoomColumnWidth(c);
                            if (w > sheetLayout1.viewportWidth)
                            {
                                break
                            }
                            c--
                        }
                        var newLeftCol = self._getNextVisualColumn(c);
                        self._setLeftColumn(newLeftCol)
                    }
                    if (cellRowIndex < self._scrollTopRow && cellRowIndex >= firstRow1)
                    {
                        self._setTopRow(self._getPrevVisualRow(cellRowIndex + 1))
                    }
                    if (cellRowIndex > self._getLastFullyVisibleRow() && cellRowIndex <= self._getLastVisualRow())
                    {
                        var h = 0;
                        var r = cellRowIndex;
                        var tempSpan1 = self._getSpanModel().find(r, cellColIndex);
                        if (tempSpan1)
                        {
                            r = tempSpan1.row + tempSpan1.rowCount - 1
                        }
                        var sheetLayout = self._getSheetLayout();
                        while (r > self._scrollTopRow)
                        {
                            h += self._getZoomRowHeight(r);
                            if (h > sheetLayout.viewportHeight)
                            {
                                break
                            }
                            r--
                        }
                        var newTopRow = self._getNextVisualRow(r);
                        self._setTopRow(newTopRow)
                    }
                    if (cellRowIndex === self._getLastVisualRow())
                    {
                        self._setTopRow(self._getLastPageTopRow())
                    }
                    if (cellColIndex === self._getLastVisualColumn())
                    {
                        self._setLeftColumn(self._getLastPageLeftColumn())
                    }
                };
                Sheet.prototype.commitArrayFormula = function()
                {
                    this._endEditImp(false, 1)
                };
                Sheet.prototype._endEditImp = function(ignoreValueChange, endEditType)
                {
                    var self = this,
                        eventHandler = self._eventHandler;
                    if (!self.isEditing())
                        return true;
                    var editor = self._editor;
                    var action;
                    var ct = self.getCellType(self._activeRowIndex, self._activeColIndex);
                    var context = {
                            sheet: self, row: self._activeRowIndex, col: self._activeColIndex, sheetArea: 3
                        };
                    if (!ct.isImeAware(context) && eventHandler)
                    {
                        eventHandler.changeFocusHolder()
                    }
                    if (editor && editor.parentNode)
                    {
                        var v = ct.getEditorValue(editor, context);
                        var args = {
                                sheet: self, sheetName: self._name, row: self._activeRowIndex, col: self._activeColIndex, editor: editor, editingText: v, cancel: false
                            };
                        self.triggerEditEnd(args);
                        if (args && args.cancel === true)
                        {
                            return
                        }
                        self.triggerEditEnding(args);
                        if (args && args.cancel === true)
                        {
                            return
                        }
                        self._detachFormulaTextBox();
                        var attachedFbx = this.parent && this.parent._attachedFormulaTextBox;
                        if (document.activeElement === (attachedFbx && attachedFbx._host))
                        {
                            eventHandler.changeFocusHolder()
                        }
                        if (self._activeRowIndex >= 0 && self._activeColIndex >= 0)
                        {
                            var oldValue = editor._oldValue;
                            if (ct.isEditingValueChanged(oldValue, v, context) || endEditType === 1)
                            {
                                if (ignoreValueChange)
                                {
                                    ct.setEditorValue(editor, oldValue, context);
                                    ct.selectAll(editor, context)
                                }
                                else
                                {
                                    var autoFormat = (ct.hasOwnProperty("_autoFormatValue") ? ct._autoFormatValue : true);
                                    var cellEditInfo = {
                                            row: self._activeRowIndex, col: self._activeColIndex, newValue: v, autoFormat: autoFormat
                                        };
                                    if (endEditType === 1)
                                    {
                                        var selections = [self._getActiveSelectedRange()];
                                        cellEditInfo.ranges = selections;
                                        cellEditInfo.endEditType = endEditType
                                    }
                                    action = new Sheets.UndoRedo.CellEditUndoAction(self, cellEditInfo);
                                    self._doCommand(action);
                                    var needRetry = (action.applyResult === 2);
                                    if (needRetry === true)
                                    {
                                        ct.focus(editor, context);
                                        self._attachFormulaTextBox(ct.getEditingElement());
                                        return false
                                    }
                                }
                            }
                        }
                        self._dirty = true;
                        ct.deactivateEditor(editor, context);
                        if (!ct.isImeAware(context))
                        {
                            var host = self._getHost();
                            var element = editor;
                            while (element)
                            {
                                if (element.parentNode === host)
                                {
                                    host.removeChild(element)
                                }
                                else
                                {
                                    element = element.parentNode
                                }
                            }
                        }
                        else
                        {
                            $(editor).css("width", "0");
                            $(editor).css("height", "0");
                            $(editor).css("overflow", "hidden")
                        }
                    }
                    self._editingTimeValue = false;
                    self.triggerEditEnded({
                        sheet: self, sheetName: self._name, row: self._activeRowIndex, col: self._activeColIndex, editingText: v
                    });
                    if (self._editorStatus !== 0)
                    {
                        var oldStatus = self._editorStatus;
                        self._editorStatus = 0;
                        self.triggerEditorStatusChanged({
                            sheet: self, sheetName: self._name, oldStatus: oldStatus, newStatus: 0
                        })
                    }
                    self._editor = keyword_null;
                    if (action && (action.applyResult === 1))
                    {
                        return false
                    }
                    return true
                };
                Sheet.prototype.endEdit = function(ignoreValueChange)
                {
                    return this._endEditImp(ignoreValueChange)
                };
                Sheet.prototype.hitTest = function(x, y, forMove)
                {
                    var self = this;
                    self._getSheetLayout();
                    var target = {
                            x: x, y: y, rowViewportIndex: keyword_null, colViewportIndex: keyword_null, row: -1, col: -1, resizeInfo: keyword_null, hitTestType: keyword_null, groupHitInfo: keyword_null, filterButtonHitInfo: keyword_null, dragInfo: keyword_null, cellTypeHitInfo: keyword_null, floatingObjectHitInfo: keyword_null, formulaRangeHitInfo: keyword_null, commentHitInfo: keyword_null
                        };
                    var hitInfo = self._render.groupHitTest(x, y),
                        rowViewportIndex,
                        colViewportIndex;
                    if (hitInfo)
                    {
                        target.groupHitInfo = hitInfo
                    }
                    else
                    {
                        rowViewportIndex = self._getRowViewportIndexFromY(y);
                        colViewportIndex = self._getColumnViewportIndexFromX(x);
                        target.rowViewportIndex = rowViewportIndex;
                        target.colViewportIndex = colViewportIndex;
                        target.row = self._getRowIndexFromY(y, rowViewportIndex);
                        target.col = self._getColumnIndexFromX(x, colViewportIndex);
                        if (rowViewportIndex >= 0 && rowViewportIndex <= 2 && colViewportIndex >= 0)
                        {
                            var cellLayout = self._getCellLayoutByCell(rowViewportIndex, colViewportIndex, keyword_undefined, target.row, target.col);
                            if (cellLayout)
                            {
                                if (forMove !== true)
                                {
                                    target.row = cellLayout.row;
                                    target.col = cellLayout.col
                                }
                            }
                        }
                        target.hitTestType = self._getSheetArea(rowViewportIndex, colViewportIndex);
                        var eventHandler = self._eventHandler,
                            resizeInfo,
                            floatObjectInfo,
                            dragInfo,
                            filterButtonHitInfo,
                            formulaRangeInfo,
                            commentHitInfo;
                        if (resizeInfo = eventHandler.getResizingRowCol(target, x, y, 5))
                        {
                            target.resizeInfo = resizeInfo
                        }
                        else if (formulaRangeInfo = eventHandler.getFormulaRangeHitInfo(target, x, y))
                        {
                            target.formulaRangeHitInfo = formulaRangeInfo
                        }
                        else if (commentHitInfo = this._getCommentHitInfo(x, y))
                        {
                            target.commentHitInfo = commentHitInfo
                        }
                        else if (floatObjectInfo = this._getFloatingObjectHitInfo(x, y))
                        {
                            target.floatingObjectHitInfo = floatObjectInfo
                        }
                        else if (dragInfo = eventHandler.getDragInfo(target, x, y))
                        {
                            target.dragInfo = dragInfo
                        }
                        else if (filterButtonHitInfo = self._getFilterButtonHitInfo(target, x, y))
                        {
                            target.filterButtonHitInfo = filterButtonHitInfo
                        }
                        else
                        {
                            target.cellTypeHitInfo = self._getCellTypeHitInfo(target, x, y)
                        }
                    }
                    return target
                };
                Sheet.prototype.getCellRect = function(row, col, rowViewportIndex, colViewportIndex)
                {
                    var sheetArea = 3;
                    if (rowViewportIndex === -1)
                    {
                        sheetArea = 1
                    }
                    else if (colViewportIndex === -1)
                    {
                        sheetArea = 2
                    }
                    var self = this;
                    var sheetLayout = self._getSheetLayout();
                    if (rowViewportIndex === -1 && colViewportIndex === -1)
                    {
                        return new Sheets.Rect(sheetLayout.headerX, sheetLayout.headerY, sheetLayout.rowHeaderWidth, sheetLayout.colHeaderHeight)
                    }
                    var bounds = self._bounds,
                        rowCount = self.getRowCount(),
                        colCount = self.getColumnCount();
                    if (typeof(rowViewportIndex) === const_undefined || rowViewportIndex === keyword_null)
                    {
                        if (row < self.frozenRowCount)
                        {
                            rowViewportIndex = 0
                        }
                        else if (row < rowCount - self._frozenTrailingRowCount)
                        {
                            rowViewportIndex = 1
                        }
                        else if (row < rowCount)
                        {
                            rowViewportIndex = 2
                        }
                    }
                    if (typeof(colViewportIndex) === const_undefined || colViewportIndex === keyword_null)
                    {
                        if (col < self.frozenColCount)
                        {
                            colViewportIndex = 0
                        }
                        else if (col < colCount - self._frozenTrailingColCount)
                        {
                            colViewportIndex = 1
                        }
                        else if (col < colCount)
                        {
                            colViewportIndex = 2
                        }
                    }
                    var rowLayout = self._getRowLayout(rowViewportIndex, sheetArea).findRow(row);
                    var colLayout = self._getColumnLayout(colViewportIndex, sheetArea).findCol(col);
                    var cellLayout = self._getCellLayout(rowViewportIndex, colViewportIndex, sheetArea).findCell(row, col);
                    if (cellLayout)
                    {
                        return new Sheets.Rect(cellLayout.x - bounds.x, cellLayout.y - bounds.y, cellLayout.width, cellLayout.height)
                    }
                    if (rowLayout && colLayout)
                    {
                        return new Sheets.Rect(colLayout.x - bounds.x, rowLayout.y - bounds.y, colLayout.width, rowLayout.height)
                    }
                    else
                    {
                        return new Sheets.Rect
                    }
                };
                Sheet.prototype._setActiveCellCore = function(row, col, doNotSetFocus)
                {
                    var self = this,
                        eventHandler = self._eventHandler;
                    var activeCellChanged = false;
                    if (row !== keyword_null && row !== keyword_undefined)
                    {
                        self._activeRowIndex = row;
                        activeCellChanged = true
                    }
                    if (col !== keyword_null && col !== keyword_undefined)
                    {
                        self._activeColIndex = col;
                        activeCellChanged = true
                    }
                    if (!doNotSetFocus && eventHandler && activeCellChanged)
                    {
                        eventHandler.changeFocusHolder()
                    }
                };
                Sheet.prototype._setActiveCellImp = function(row, col, rowViewportIndex, colViewportIndex, doNotSetFocus)
                {
                    var self = this,
                        activeRowIndex = self._activeRowIndex,
                        activeColIndex = self._activeColIndex;
                    if (activeRowIndex !== row)
                    {
                        if (self._activeRowDirty)
                        {
                            self.updateRecord();
                            self._activeRowDirty = false
                        }
                    }
                    var span = self._getSpanModel().find(row, col);
                    if (span)
                    {
                        self._activeRowCount = span.rowCount;
                        self._activeColCount = span.colCount
                    }
                    else
                    {
                        self._activeRowCount = 1;
                        self._activeColCount = 1
                    }
                    if (!self._paintSuspended)
                    {
                        var activeSpan = self._getSpanModel().find(activeRowIndex, activeColIndex),
                            activeRowCount = 1,
                            activeColCount = 1;
                        if (activeSpan)
                        {
                            activeRowCount = activeSpan.rowCount;
                            activeColCount = activeSpan.colCount
                        }
                        self._render.repaintSelection(new Sheets.Range(activeRowIndex, activeColIndex, activeRowCount, activeColCount))
                    }
                    self.activeRowViewportIndex = rowViewportIndex;
                    self.activeColViewportIndex = colViewportIndex;
                    self._setActiveCellCore(row, col, doNotSetFocus);
                    self._leadingCellRow = row;
                    self._leadingCellCol = col
                };
                Sheet.prototype.setActiveCell = function(row, col, rowViewportIndex, colViewportIndex)
                {
                    this._setActiveCellAndSelection(row, col, rowViewportIndex, colViewportIndex, 2)
                };
                Sheet.prototype._setActiveCellAndSelection = function(row, col, rowViewportIndex, colViewportIndex, focusPolicy)
                {
                    var self = this;
                    self._bindToAutoRefresh(function(row, col, rowViewportIndex, colViewportIndex, focusPolicy)
                    {
                        var rowCount = self.getRowCount();
                        var colCount = self.getColumnCount();
                        if (row < 0)
                        {
                            row = 0
                        }
                        else if (row >= rowCount)
                        {
                            row = rowCount - 1
                        }
                        if (col < 0)
                        {
                            col = 0
                        }
                        else if (col >= colCount)
                        {
                            col = colCount - 1
                        }
                        self._clearSelectionImp();
                        var setFocus = true;
                        switch (focusPolicy)
                        {
                            case 1:
                                setFocus = true;
                                break;
                            case 0:
                                setFocus = false;
                                break;
                            case 2:
                                setFocus = Sheets.FocusHelper.isActiveElement(self);
                                break
                        }
                        self._setActiveCellImp(row, col, rowViewportIndex, colViewportIndex, !setFocus);
                        var span = self._getSpanModel().find(row, col);
                        if (span)
                        {
                            self._setSelectedRange(span.row, span.col, span.rowCount, span.colCount)
                        }
                        else
                        {
                            self._setSelectedRange(row, col, 1, 1)
                        }
                    })(row, col, rowViewportIndex, colViewportIndex, focusPolicy)
                };
                Sheet.prototype.getActiveRowIndex = function()
                {
                    return this._activeRowIndex
                };
                Sheet.prototype.getActiveColumnIndex = function()
                {
                    return this._activeColIndex
                };
                Sheet.prototype.selectionPolicy = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._selectionModel.selectionPolicy
                    }
                    this._selectionModel.selectionPolicy = value;
                    return this
                };
                Sheet.prototype.selectionUnit = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._selectionModel.selectionUnit
                    }
                    this._selectionModel.selectionUnit = value;
                    return this
                };
                Sheet.prototype.getRowResizable = function(row, sheetArea)
                {
                    return this._sheetModelManager.getRowInfos(sheetArea).getResizeable(row)
                };
                Sheet.prototype.setRowResizable = function(row, value, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    self._sheetModelManager.getRowInfos(sheetArea).setResizeable(row, value);
                    self.triggerRowChanged({
                        sheet: self, sheetName: self._name, row: row, sheetArea: sheetArea, propertyName: "resizable"
                    })
                };
                Sheet.prototype.getColumnResizable = function(col, sheetArea)
                {
                    return this._sheetModelManager.getColInfos(sheetArea).getResizeable(col)
                };
                Sheet.prototype.setColumnResizable = function(col, value, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    self._sheetModelManager.getColInfos(sheetArea).setResizeable(col, value);
                    self.triggerColumnChanged({
                        sheet: self, sheetName: self._name, col: col, sheetArea: sheetArea, propertyName: "resizable"
                    })
                };
                Sheet.prototype.getRowHeight = function(row, sheetArea)
                {
                    var self = this;
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    if (sheetArea === 3 || sheetArea === 2)
                    {
                        var m = this._sheetModelManager.getDataModel(sheetArea),
                            rowCount = ((m && m.getRowCount()) || 0);
                        if (row < 0 || row >= rowCount)
                        {
                            return 0
                        }
                        if (self.filterRowsVisibleInfo && !self.filterRowsVisibleInfo.getRowVisible(row))
                        {
                            return 0
                        }
                        var rowRangeGroup = self.rowRangeGroup;
                        if (rowRangeGroup && !rowRangeGroup._isEmpty())
                        {
                            if (rowRangeGroup.isCollapsed(row))
                            {
                                return 0
                            }
                        }
                    }
                    var dh = self.defaults.rowHeight;
                    if (sheetArea === 1)
                    {
                        dh = self.defaults.colHeaderRowHeight
                    }
                    var h = self._sheetModelManager.getRowInfos(sheetArea).getSize(row);
                    return (h || h === 0) ? h : dh
                };
                Sheet.prototype._getActualRowHeight = function(row, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var dh = this.defaults.rowHeight;
                    if (sheetArea === 1)
                    {
                        dh = this.defaults.colHeaderRowHeight
                    }
                    var h = this._sheetModelManager.getRowInfos(sheetArea).getActualSize(row);
                    return (h || h === 0) ? h : dh
                };
                Sheet.prototype.setRowHeight = function(row, value, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    self._sheetModelManager.getRowInfos(sheetArea).setSize(row, value);
                    self.triggerRowChanged({
                        sheet: self, sheetName: self._name, row: row, sheetArea: sheetArea, propertyName: _cssHeight
                    });
                    self._needSyncVScrollbarSize = true;
                    self.invalidate()
                };
                Sheet.prototype.getRowVisible = function(row, sheetArea)
                {
                    var self = this;
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    if (self.isRowFilterOut(row, sheetArea))
                    {
                        return false
                    }
                    if (sheetArea === 3 || sheetArea === 2)
                    {
                        var rowRangeGroup = self.rowRangeGroup;
                        if (rowRangeGroup && !rowRangeGroup._isEmpty())
                        {
                            if (0 <= row && row < self.getRowCount(sheetArea) && rowRangeGroup.isCollapsed(row))
                            {
                                return false
                            }
                        }
                    }
                    return this._sheetModelManager.getRowInfos(sheetArea).getVisible(row)
                };
                Sheet.prototype.isRowFilterOut = function(row, sheetArea)
                {
                    var self = this;
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    if (sheetArea === 3 || sheetArea === 2)
                    {
                        if (self.filterRowsVisibleInfo && !self.filterRowsVisibleInfo.getRowVisible(row))
                        {
                            return true
                        }
                    }
                    return false
                };
                Sheet.prototype.hasRowFilterOut = function()
                {
                    return this.filterRowsVisibleInfo && this.filterRowsVisibleInfo.hasFilterOut()
                };
                Sheet.prototype.setRowVisible = function(row, value, sheetArea)
                {
                    var self = this;
                    self._bindToAutoRefresh(function(row, value, sheetArea)
                    {
                        if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                        {
                            sheetArea = 3
                        }
                        self._sheetModelManager.getRowInfos(sheetArea).setVisible(row, value);
                        self.triggerRowChanged({
                            sheet: self, sheetName: self._name, row: row, sheetArea: sheetArea, propertyName: "isVisible"
                        });
                        self._needSyncVScrollbarSize = true
                    })(row, value, sheetArea)
                };
                Sheet.prototype.getColumnWidth = function(col, sheetArea)
                {
                    var self = this;
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var dw = self.defaults.colWidth;
                    if (sheetArea === 2)
                    {
                        dw = self.defaults.rowHeaderColWidth
                    }
                    if (sheetArea === 3 || sheetArea === 1)
                    {
                        var m = this._sheetModelManager.getDataModel(sheetArea),
                            colCount = ((m && m.getColumnCount()) || 0);
                        if (col < 0 || col >= colCount)
                        {
                            return 0
                        }
                        var colRangeGroup = self.colRangeGroup;
                        if (colRangeGroup && !colRangeGroup._isEmpty())
                        {
                            if (colRangeGroup.isCollapsed(col))
                            {
                                return 0
                            }
                        }
                    }
                    var w = this._sheetModelManager.getColInfos(sheetArea).getSize(col);
                    return (w || w === 0) ? w : dw
                };
                Sheet.prototype._getActualColumnWidth = function(col, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var dw = this.defaults.colWidth;
                    if (sheetArea === 2)
                    {
                        dw = this.defaults.rowHeaderColWidth
                    }
                    var w = this._sheetModelManager.getColInfos(sheetArea).getActualSize(col);
                    return (w || w === 0) ? w : dw
                };
                Sheet.prototype.setColumnWidth = function(col, value, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    this._sheetModelManager.getColInfos(sheetArea).setSize(col, value);
                    self.triggerColumnChanged({
                        sheet: self, sheetName: self._name, col: col, sheetArea: sheetArea, propertyName: _cssWidth
                    });
                    self._needSyncHScrollbarSize = true;
                    self.invalidate()
                };
                Sheet.prototype.getColumnVisible = function(col, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    if (sheetArea === 3 || sheetArea === 1)
                    {
                        var colRangeGroup = this.colRangeGroup;
                        if (colRangeGroup && !colRangeGroup._isEmpty())
                        {
                            if (0 <= col && col < this.getColumnCount(sheetArea) && colRangeGroup.isCollapsed(col))
                            {
                                return false
                            }
                        }
                    }
                    return this._sheetModelManager.getColInfos(sheetArea).getVisible(col)
                };
                Sheet.prototype.setColumnVisible = function(col, value, sheetArea)
                {
                    var self = this;
                    self._bindToAutoRefresh(function(col, value, sheetArea)
                    {
                        if (sheetArea === undefined || sheetArea === null)
                        {
                            sheetArea = 3
                        }
                        self._sheetModelManager.getColInfos(sheetArea).setVisible(col, value);
                        self.triggerColumnChanged({
                            sheet: self, sheetName: self._name, col: col, sheetArea: sheetArea, propertyName: "isVisible"
                        });
                        self._needSyncHScrollbarSize = true
                    })(col, value, sheetArea)
                };
                Sheet.prototype.zoom = function(factor)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._zoomFactor
                    }
                    else
                    {
                        factor = parseFloat(factor);
                        if (isNaN(factor) || !isFinite(factor))
                        {
                            return self
                        }
                        if (factor > 4)
                        {
                            factor = 4
                        }
                        else if (factor < 0.25)
                        {
                            factor = 0.25
                        }
                        self._bindToAutoRefresh(function(factor)
                        {
                            if (self.showEditingLocator)
                            {
                                self._showEditingLocator()
                            }
                            self._zoomFactor = factor;
                            self._needSyncHScrollbarSize = true;
                            self._needSyncVScrollbarSize = true
                        })(factor);
                        return self
                    }
                };
                Sheet.prototype.invalidateLayout = function()
                {
                    var self = this,
                        eventHandler = self._eventHandler;
                    self._layoutModel = keyword_null;
                    self._cachedGroupLayout = keyword_null;
                    self._rowLayoutCache = {
                        colHeader: keyword_null, viewport: keyword_null, colFooter: keyword_null
                    };
                    self._colLayoutCache = {
                        rowHeader: keyword_null, viewport: keyword_null
                    };
                    self._filterButtonsModel = keyword_null;
                    if (eventHandler && Sheets.FocusHelper.isActiveElement(self))
                    {
                        eventHandler._updateValidationUI(self._activeRowIndex, self._activeColIndex)
                    }
                    if (self._needSyncHScrollbarSize)
                    {
                        self._syncHScrollbarSize();
                        self._needSyncHScrollbarSize = false
                    }
                    if (self._needSyncVScrollbarSize)
                    {
                        self._syncVScrollbarSize();
                        self._needSyncVScrollbarSize = false
                    }
                    self._dirty = true
                };
                Sheet.prototype.invalidate = function()
                {
                    var self = this;
                    if (!self._paintSuspended && self._layoutSuspended <= 0)
                    {
                        self.invalidateLayout();
                        self.repaint()
                    }
                };
                Sheet.prototype.getViewportHeight = function(rowViewportIndex)
                {
                    var layout = this._getSheetLayout();
                    if (rowViewportIndex === 0)
                    {
                        return layout.frozenHeight
                    }
                    else if (rowViewportIndex === 1)
                    {
                        return layout.viewportHeight
                    }
                    else if (rowViewportIndex === 2)
                    {
                        return layout.frozenTrailingHeight
                    }
                    else
                    {
                        return 0
                    }
                };
                Sheet.prototype.getViewportWidth = function(columnViewportIndex)
                {
                    var layout = this._getSheetLayout();
                    if (columnViewportIndex === 0)
                    {
                        return layout.frozenWidth
                    }
                    else if (columnViewportIndex === 1)
                    {
                        return layout.viewportWidth
                    }
                    else if (columnViewportIndex === 2)
                    {
                        return layout.frozenTrailingWidth
                    }
                    else
                    {
                        return 0
                    }
                };
                Sheet.prototype.getViewportTopRow = function(rowViewportIndex)
                {
                    var self = this;
                    if (rowViewportIndex === 0)
                    {
                        return 0
                    }
                    else if (rowViewportIndex === 1)
                    {
                        return Math_max(self.frozenRowCount, self._scrollTopRow)
                    }
                    else if (rowViewportIndex === 2)
                    {
                        return Math_max(self.frozenRowCount, self.getRowCount() - self._frozenTrailingRowCount)
                    }
                    else
                    {
                        return -1
                    }
                };
                Sheet.prototype.getViewportBottomRow = function(rowViewportIndex)
                {
                    var self = this;
                    if (rowViewportIndex === 2)
                    {
                        return self.getRowCount() - 1
                    }
                    var topRow = self.getViewportTopRow(rowViewportIndex);
                    var viewportHeight = self.getViewportHeight(rowViewportIndex);
                    var rowHeightTotal = 0;
                    var rowCount = 0;
                    var rc = self.getRowCount() - self._frozenTrailingRowCount;
                    if (rowViewportIndex === 0)
                    {
                        rc = Math_min(self.frozenRowCount, rc)
                    }
                    for (var index = topRow; (index < rc) && (rowHeightTotal < viewportHeight); index++, rowCount++)
                    {
                        rowHeightTotal += self._getZoomRowHeight(index)
                    }
                    return topRow + rowCount - 1
                };
                Sheet.prototype.getViewportLeftColumn = function(columnViewportIndex)
                {
                    var self = this;
                    if (columnViewportIndex === 0)
                    {
                        return 0
                    }
                    else if (columnViewportIndex === 1)
                    {
                        return Math_max(self.frozenColCount, self._scrollLeftCol)
                    }
                    else if (columnViewportIndex === 2)
                    {
                        return Math_max(self.frozenColCount, self.getColumnCount() - self._frozenTrailingColCount)
                    }
                    else
                    {
                        return -1
                    }
                };
                Sheet.prototype.getViewportRightColumn = function(columnViewportIndex)
                {
                    var self = this;
                    if (columnViewportIndex === 2)
                    {
                        return self.getColumnCount() - 1
                    }
                    var leftColumn = self.getViewportLeftColumn(columnViewportIndex);
                    var viewportWidth = self.getViewportWidth(columnViewportIndex);
                    var columnCount = 0;
                    var columnWidthTotal = 0;
                    var cc = self.getColumnCount() - self._frozenTrailingColCount;
                    if (columnViewportIndex === 0)
                    {
                        cc = Math_min(self.frozenColCount, cc)
                    }
                    for (var index = leftColumn; (index < cc) && (columnWidthTotal < viewportWidth); index++, columnCount++)
                    {
                        columnWidthTotal += self._getZoomColumnWidth(index)
                    }
                    return leftColumn + columnCount - 1
                };
                Sheet.prototype.clearSelection = function()
                {
                    var self = this;
                    this._bindToAutoRefresh(function()
                    {
                        self._clearSelectionImp();
                        self._setActiveCellImp(0, 0);
                        self.unSelectAllComments()
                    })()
                };
                Sheet.prototype._clearSelectionImp = function()
                {
                    this._selectionModel.clear()
                };
                Sheet.prototype._validationError = function(row, column, value)
                {
                    var self = this;
                    var dv = self.getDataValidator(row, column);
                    var args = {
                            sheet: self, sheetName: self._name, row: row, col: column, validator: dv, validationResult: 0
                        };
                    self.triggerValidationError(args);
                    return args.validationResult
                };
                Sheet.prototype.getSpans = function(range, sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var sm = this._getSpanModel(sheetArea);
                    if (sm)
                    {
                        return sm.getSpans(range)
                    }
                    return []
                };
                Sheet.prototype.getSpan = function(row, col, sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var sm = this._getSpanModel(sheetArea);
                    return sm.find(row, col)
                };
                Sheet.prototype.getCell = function(row, col, sheetArea)
                {
                    return new Sheets.Cell(this, row, col, sheetArea)
                };
                Sheet.prototype.getCells = function(row, col, row2, col2, sheetArea)
                {
                    var cell = this.getCell(row, col, sheetArea);
                    cell.row2 = row2;
                    cell.col2 = col2;
                    return cell
                };
                Sheet.prototype.getRow = function(index, sheetArea)
                {
                    return new Sheets.Row(this, index, sheetArea)
                };
                Sheet.prototype.getRows = function(index, index2, sheetArea)
                {
                    var row = this.getRow(index, sheetArea);
                    row.index2 = index2;
                    return row
                };
                Sheet.prototype.getColumn = function(index, sheetArea)
                {
                    return new Sheets.Column(this, index, sheetArea)
                };
                Sheet.prototype.getColumns = function(index, index2, sheetArea)
                {
                    var col = this.getColumn(index, sheetArea);
                    col.index2 = index2;
                    return col
                };
                Sheet.prototype.setBorder = function(cellRange, border, option, sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        var actualRange = self._getActualRange(cellRange, sheetArea);
                        var row = actualRange.row;
                        var col = actualRange.col;
                        var rowCount = actualRange.rowCount;
                        var colCount = actualRange.colCount;
                        var r,
                            c;
                        if (option.left || option.all || option.outline)
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                self.getCell(row + r, col, sheetArea).borderLeft(border)
                            }
                        }
                        if (option.top || option.all || option.outline)
                        {
                            for (c = 0; c < colCount; c++)
                            {
                                self.getCell(row, col + c, sheetArea).borderTop(border)
                            }
                        }
                        if (option.right || option.all || option.outline)
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                self.getCell(row + r, col + colCount - 1, sheetArea).borderRight(border)
                            }
                        }
                        if (option.bottom || option.all || option.outline)
                        {
                            for (c = 0; c < colCount; c++)
                            {
                                self.getCell(row + rowCount - 1, col + c, sheetArea).borderBottom(border)
                            }
                        }
                        if (option.innerHorizontal || option.all || option.inside)
                        {
                            for (r = 0; r < rowCount - 1; r++)
                            {
                                for (c = 0; c < colCount; c++)
                                {
                                    self.getCell(row + r, col + c, sheetArea).borderBottom(border);
                                    self.getCell(row + r + 1, col + c, sheetArea).borderTop(border)
                                }
                            }
                        }
                        if (option.innerVertical || option.all || option.inside)
                        {
                            for (c = 0; c < colCount - 1; c++)
                            {
                                for (r = 0; r < rowCount; r++)
                                {
                                    self.getCell(row + r, col + c, sheetArea).borderRight(border);
                                    self.getCell(row + r, col + c + 1, sheetArea).borderLeft(border)
                                }
                            }
                        }
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.search = function(searchCondition)
                {
                    if (!searchCondition || !Sheets.features.search)
                    {
                        return keyword_null
                    }
                    var self = this,
                        sheetArea = searchCondition.sheetArea,
                        searchString = searchCondition.searchString,
                        searchTarget = searchCondition.searchTarget,
                        searchFlags = searchCondition.searchFlags,
                        rowCount = self.getRowCount(sheetArea),
                        colCount = self.getColumnCount(sheetArea);
                    if (!searchString || searchTarget === 0 || (rowCount <= 0 && colCount <= 0))
                    {
                        return new Sheets.SearchResult
                    }
                    if (searchCondition.rowStart === -1)
                    {
                        searchCondition.rowStart = 0
                    }
                    if (searchCondition.columnStart === -1)
                    {
                        searchCondition.columnStart = 0
                    }
                    if (searchCondition.findBeginRow === -1)
                    {
                        searchCondition.findBeginRow = searchCondition.rowStart
                    }
                    if (searchCondition.findBeginColumn === -1)
                    {
                        searchCondition.findBeginColumn = searchCondition.columnStart
                    }
                    if (searchCondition.rowEnd === -1)
                    {
                        searchCondition.rowEnd = rowCount - 1
                    }
                    if (searchCondition.columnEnd === -1)
                    {
                        searchCondition.columnEnd = colCount - 1
                    }
                    var searchResult = new Sheets.SearchResult;
                    var enumerator = new Sheets.CellsEnumerator(self, searchCondition);
                    if ((searchFlags & 8) > 0)
                    {
                        enumerator.isBlockRange = true
                    }
                    while (enumerator.moveNext())
                    {
                        var rowIndex = enumerator.currentRow;
                        var columnIndex = enumerator.currentColumn;
                        var cell = enumerator.current();
                        if (!cell)
                        {
                            continue
                        }
                        if ((searchTarget & 1) > 0)
                        {
                            var cellText = cell.text();
                            if (self._trySearch(cellText, searchString, searchFlags) && cellText !== "")
                            {
                                searchResult.searchFoundFlag |= 1;
                                searchResult.foundString = cellText
                            }
                        }
                        if ((searchTarget & 8) > 0)
                        {
                            var cellFormula = cell.formula();
                            if (typeof(cellFormula) === const_string)
                            {
                                cellFormula = cellFormula.toString()
                            }
                            else
                            {
                                cellFormula = keyword_null
                            }
                            if (self._trySearch(cellFormula, searchString, searchFlags) && cellFormula !== "")
                            {
                                searchResult.searchFoundFlag |= 8;
                                searchResult.foundString = cellFormula
                            }
                        }
                        if ((searchTarget & 4) > 0)
                        {
                            var cellTag = cell.tag();
                            if (typeof(cellTag) === const_string)
                            {
                                if (self._trySearch(cellTag, searchString, searchFlags) && cellTag !== "")
                                {
                                    searchResult.searchFoundFlag |= 4;
                                    searchResult.foundString = cellTag
                                }
                            }
                        }
                        if (searchResult.searchFoundFlag !== 0)
                        {
                            searchResult.foundRowIndex = rowIndex;
                            searchResult.foundColumnIndex = columnIndex;
                            return searchResult
                        }
                    }
                    return new Sheets.SearchResult
                };
                Sheet.prototype.showCell = function(row, col, verticalPosition, horizontalPosition)
                {
                    var self = this,
                        rowCount = self.getRowCount(),
                        colcount = self.getColumnCount(),
                        zoomFactor = self._zoomFactor;
                    if (row < 0 || row >= rowCount)
                    {
                        return
                    }
                    if (col < 0 || col >= colcount)
                    {
                        return
                    }
                    var frozenRowCount = isNaN(self.frozenRowCount) ? 0 : self.frozenRowCount;
                    var frozenColCount = isNaN(self.frozenColCount) ? 0 : self.frozenColCount;
                    var frozenTrailingRowCount = isNaN(self._frozenTrailingRowCount) ? 0 : self._frozenTrailingRowCount;
                    var frozenTrailingColCount = isNaN(self._frozenTrailingColCount) ? 0 : self._frozenTrailingColCount;
                    var topRow = self._scrollTopRow;
                    var leftColumn = self._scrollLeftCol;
                    var columnViewportIndex = 1;
                    var rowViewportIndex = 1;
                    if (row < frozenRowCount)
                    {
                        topRow = 0;
                        rowViewportIndex = 0
                    }
                    else if (row >= rowCount - frozenTrailingRowCount)
                    {
                        topRow = rowCount - frozenTrailingRowCount;
                        rowViewportIndex = 2
                    }
                    if (col < frozenColCount)
                    {
                        leftColumn = 0;
                        columnViewportIndex = 0
                    }
                    else if (col >= colcount - frozenTrailingColCount)
                    {
                        leftColumn = colcount - frozenTrailingColCount;
                        columnViewportIndex = 2
                    }
                    if (columnViewportIndex === 1)
                    {
                        var dWidth;
                        if (horizontalPosition !== 0)
                        {
                            if (horizontalPosition === 1)
                            {
                                dWidth = Math_floor((self.getViewportWidth(columnViewportIndex) - Math_floor(self.getColumnWidth(col) * zoomFactor)) / 2);
                                for (; 0 < col; col--)
                                {
                                    dWidth -= Math_floor(self.getColumnWidth(col - 1) * zoomFactor);
                                    if (dWidth < 0)
                                    {
                                        break
                                    }
                                }
                            }
                            else if (horizontalPosition === 2)
                            {
                                dWidth = self.getViewportWidth(columnViewportIndex) - Math_floor(self.getColumnWidth(col) * zoomFactor);
                                for (; 0 < col; col--)
                                {
                                    dWidth -= Math_floor(self.getColumnWidth(col - 1) * zoomFactor);
                                    if (dWidth < 0)
                                    {
                                        break
                                    }
                                }
                            }
                            else if (horizontalPosition === 3)
                            {
                                if (col >= leftColumn)
                                {
                                    dWidth = self.getViewportWidth(columnViewportIndex) - Math_floor(self.getColumnWidth(col) * zoomFactor);
                                    for (; leftColumn < col; col--)
                                    {
                                        dWidth -= Math_floor(self.getColumnWidth(col - 1) * zoomFactor);
                                        if (dWidth < 0)
                                        {
                                            break
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (rowViewportIndex === 1)
                    {
                        var height;
                        if (verticalPosition !== 0)
                        {
                            if (verticalPosition === 1)
                            {
                                height = Math_floor((self.getViewportHeight(rowViewportIndex) - Math_floor(self.getRowHeight(row) * zoomFactor)) / 2);
                                for (; 0 < row; row--)
                                {
                                    height -= Math_floor(self.getRowHeight(row - 1) * zoomFactor);
                                    if (height < 0)
                                    {
                                        break
                                    }
                                }
                            }
                            else if (verticalPosition === 2)
                            {
                                height = self.getViewportHeight(rowViewportIndex) - Math_floor(self.getRowHeight(row) * zoomFactor);
                                for (; 0 < row; row--)
                                {
                                    height -= Math_floor(self.getRowHeight(row - 1) * zoomFactor);
                                    if (height < 0)
                                    {
                                        break
                                    }
                                }
                            }
                            else if (verticalPosition === 3)
                            {
                                if (!(row < topRow || topRow === -1))
                                {
                                    height = self.getViewportHeight(rowViewportIndex) - Math_floor(self.getRowHeight(row) * zoomFactor);
                                    for (; topRow < row; row--)
                                    {
                                        height -= Math_floor(self.getRowHeight(row - 1) * zoomFactor);
                                        if (height < 0)
                                        {
                                            break
                                        }
                                    }
                                }
                            }
                        }
                    }
                    var needRepaint = false;
                    if (rowViewportIndex === 1 && row !== topRow)
                    {
                        if (row > self._getLastVisualScrollRow())
                        {
                            row = self._getLastVisualScrollRow()
                        }
                        self._scrollTopRow = row;
                        self._syncVScrollbarPosition();
                        needRepaint = true
                    }
                    if (columnViewportIndex === 1 && col !== leftColumn)
                    {
                        if (col > self._getLastVisualScrollColumn())
                        {
                            col = self._getLastVisualScrollColumn()
                        }
                        self._scrollLeftCol = col;
                        self._syncHScollbarPosition();
                        needRepaint = true
                    }
                    if (needRepaint)
                    {
                        var sp = self.parent;
                        if (sp && !sp._scrollbarShowMax)
                        {
                            self._needSyncHScrollbarSize = true;
                            self._needSyncVScrollbarSize = true
                        }
                        self.invalidateLayout();
                        self.repaint()
                    }
                };
                Sheet.prototype.showColumn = function(col, horizontalPosition)
                {
                    this.showCell(this._scrollTopRow, col, 0, horizontalPosition)
                };
                Sheet.prototype.showRow = function(row, verticalPosition)
                {
                    this.showCell(row, this._scrollLeftCol, verticalPosition, 0)
                };
                Sheet.prototype.bind = function(type, data, fn)
                {
                    this._eventHandler.bind(type + _gcSheet, data, fn)
                };
                Sheet.prototype.unbind = function(type, fn)
                {
                    this._eventHandler.unbind(type + _gcSheet, fn)
                };
                Sheet.prototype.unbindAll = function()
                {
                    this._eventHandler.unbind(_gcSheet)
                };
                Sheet.prototype._bind = function(type, data, fn)
                {
                    if (type.indexOf('.') >= 0)
                    {
                        this._eventHandler.bind(type, data, fn)
                    }
                    else
                    {
                        this._eventHandler.bind(type + _gcSheetInternal, data, fn)
                    }
                };
                Sheet.prototype._unbind = function(type, fn)
                {
                    if (type.indexOf('.') >= 0)
                    {
                        this._eventHandler.unbind(type, fn)
                    }
                    else
                    {
                        this._eventHandler.unbind(type + _gcSheetInternal, fn)
                    }
                };
                Sheet.prototype._unbindAll = function()
                {
                    this._eventHandler.unbind(_gcSheetInternal)
                };
                Sheet.prototype.suspendEvent = function()
                {
                    this._eventHandler._eventSuspended++
                };
                Sheet.prototype.resumeEvent = function()
                {
                    var eventHandler = this._eventHandler;
                    eventHandler._eventSuspended--;
                    if (eventHandler._eventSuspended < 0)
                    {
                        eventHandler._eventSuspended = 0
                    }
                };
                Sheet.prototype.currentTheme = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        if (!self._currentTheme)
                        {
                            self._currentTheme = Sheets.SpreadThemes.Office
                        }
                        return self._currentTheme
                    }
                    if (typeof value === const_string)
                    {
                        if (Sheets.SpreadThemes.hasOwnProperty(value))
                        {
                            value = Sheets.SpreadThemes[value]
                        }
                        else
                        {
                            value = new Sheets.SpreadTheme(value)
                        }
                    }
                    self._bindToAutoRefresh(function(value)
                    {
                        self._currentTheme = value;
                        self.clearStyleCache()
                    })(value);
                    return self
                };
                Sheet.prototype._createSheetModelManager = function(name)
                {
                    return new Sheets.SheetModelManager(this, name)
                };
                Sheet.prototype.reset = function()
                {
                    var self = this;
                    self._bindToAutoRefresh(function()
                    {
                        self.resetImp()
                    })()
                };
                Sheet.prototype.resetImp = function()
                {
                    var self = this;
                    self.defaults = {
                        rowHeight: self._defaultRowHeight, colWidth: self._defaultColWidth, rowHeaderColWidth: self._defaultRowHeaderColWidth, colHeaderRowHeight: self._defaultColHeaderRowHeight
                    };
                    self.gridline = {
                        color: self._defaultGridLineColor, showVerticalGridline: self._defaultShowVerticalGridline, showHorizontalGridline: self._defaultShowHorizontalGridline
                    };
                    self._rowLayoutCache = {
                        colHeader: keyword_null, viewport: keyword_null, colFooter: keyword_null
                    };
                    self._colLayoutCache = {
                        rowHeader: keyword_null, viewport: keyword_null
                    };
                    self._dragRect = {};
                    self._render = new Sheets._SheetRender(self);
                    var eventHandlerElem = keyword_null;
                    if (self._eventHandler)
                    {
                        eventHandlerElem = self._eventHandler._elem
                    }
                    self._eventHandler = self._createEventHandler();
                    self._eventHandler._elem = eventHandlerElem;
                    var parent = self.parent;
                    if (parent)
                    {
                        var activeSheet = parent.getActiveSheet();
                        if (activeSheet)
                        {
                            if (self.getName() === activeSheet.getName())
                            {
                                self._setHost(parent._vp)
                            }
                        }
                    }
                    self._composedDefaultStyle = {};
                    this._sheetModelManager = this._createSheetModelManager(this._name);
                    self._selectionModel = new Sheets._SelectionModel;
                    self._selectionBackColor = "rgba(180,180,200,0.2)";
                    self._selectionBorderColor = "black";
                    self._currentTheme = Sheets.SpreadThemes.Office;
                    self._allowDragDrop = true;
                    self._allowDragFill = true;
                    self._defaultDragFillType = 5;
                    self._showDragFillSmartTag = true;
                    if (Sheets.util.hasCalc())
                    {
                        self._vpSheetSource = new Sheets.Calc.SheetSource(self)
                    }
                    if (Sheets.features.group)
                    {
                        self.rowRangeGroup = new Sheets.RangeGroup(self.getRowCount());
                        self.colRangeGroup = new Sheets.RangeGroup(self.getColumnCount())
                    }
                    self._showRowRangeGroup = true;
                    self._showColumnRangeGroup = true;
                    self.dataContext = keyword_null;
                    self.autoGenerateColumns = true;
                    self.autoUpdate = true;
                    self._rowFilter = keyword_null;
                    if (Sheets.features.filter)
                    {
                        self.filterRowsVisibleInfo = new Sheets.FilterRowsVisibleInfo
                    }
                    self._initDefaultKeyMap();
                    if (Sheets.features.floatingObject)
                    {
                        self._initDefaultFloatingObjectKeyMap()
                    }
                    if (Sheets.features.comment)
                    {
                        self._initDefaultCommentKeyMap()
                    }
                    self._scrollTopRow = 0;
                    self._scrollLeftCol = 0;
                    self.frozenRowCount = 0;
                    self.frozenColCount = 0;
                    self._frozenTrailingRowCount = 0;
                    self._frozenTrailingColCount = 0;
                    if (Sheets.features.binding)
                    {
                        self._bindingManager = new Sheets._BindingManager(self)
                    }
                    if (Sheets.features.sparkline)
                    {
                        self._sparklineGroupManager = new Sheets.WorksheetSparklineGroupManager(self, self)
                    }
                    if (Sheets.features.table)
                    {
                        self._tableManager = new Sheets._SheetTableManager(self)
                    }
                    if (Sheets.features.floatingObject)
                    {
                        self._floatingObjectArray = new Sheets._FloatingObjectArray(self)
                    }
                    self._namedStyles = {};
                    self._needSyncHScrollbarSize = true;
                    self._needSyncVScrollbarSize = true;
                    self._cutCopyIndicatorManager = new Sheets.CutCopyIndicatorManager(self);
                    self.invalidateLayout();
                    self._clipBoardOptions = 0;
                    self._containerDiv = keyword_null;
                    if (Sheets.features.comment)
                    {
                        self._commentManager = new Sheets.CommentManager(self)
                    }
                };
                Sheet.prototype.initCalc = function(service)
                {
                    var self = this,
                        oldService = self.calcService;
                    if ((!oldService || service) && Sheets.util.hasCalc())
                    {
                        self.calcService = service ? service : new Sheets.Calc.CalcService;
                        self._getSheetSource().service = self.calcService;
                        self.calcService.initParserContext(self._getSheetSource());
                        if (oldService && service)
                        {
                            service.setSourceModel(self._getSheetSource(), oldService.getSourceModel(self._vpSheetSource))
                        }
                        else
                        {
                            self._vpCalcSheetModel = self.calcService.getSourceModel(self._vpSheetSource)
                        }
                    }
                };
                Sheet.prototype.onAttached = function(parent)
                {
                    if (parent instanceof GcSpread.Sheets["Spread"])
                    {
                        var spread = parent;
                        var self = this;
                        var oldIsPaintSuspended = spread.isPaintSuspended();
                        if (self._paintSuspended !== oldIsPaintSuspended)
                        {
                            self._paintSuspended = oldIsPaintSuspended
                        }
                        self.enableFormulaTextbox(spread.enableFormulaTextbox());
                        self.initCalc(spread.calcService)
                    }
                    else
                    {
                        self.initCalc()
                    }
                    self.parent = parent
                };
                Sheet.prototype.onDettached = function(){};
                Sheet.prototype._createEventHandler = function()
                {
                    return new Sheets._SheetEventHandler(this)
                };
                Sheet.prototype.undoManager = function()
                {
                    var self = this,
                        parent = self.parent;
                    if (!self._undoManager)
                    {
                        self._undoManager = (parent && parent._undoManager) ? parent._undoManager : new Sheets._UndoManager(self, -1, self.allowUndo())
                    }
                    return self._undoManager
                };
                Sheet.prototype.clipBoardOptions = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._clipBoardOptions
                    }
                    else
                    {
                        this._clipBoardOptions = value;
                        return this
                    }
                };
                Sheet.prototype.doCommand = function(action)
                {
                    this._doCommand(action)
                };
                Sheet.prototype.copyTo = function(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, option)
                {
                    this.copyToCore(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, option)
                };
                Sheet.prototype.copyToCore = function(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, option, ignoreFilteredOutRow)
                {
                    var self = this;
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    self.suspendEvent();
                    staticMembers.copyTo(self, fromRow, fromColumn, self, toRow, toColumn, rowCount, columnCount, option, ignoreFilteredOutRow);
                    self.resumeEvent();
                    self.isPaintSuspended(oldState)
                };
                Sheet.prototype.moveTo = function(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, option)
                {
                    var self = this;
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    self.suspendEvent();
                    staticMembers.moveTo(self, fromRow, fromColumn, self, toRow, toColumn, rowCount, columnCount, option);
                    self.resumeEvent();
                    self.isPaintSuspended(oldState)
                };
                Sheet.prototype.setCsv = function(row, column, text, rowDelimiter, columnDelimiter, flags)
                {
                    var self = this;
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    self.suspendEvent();
                    staticMembers.setRangeText(self, row, column, text, rowDelimiter, columnDelimiter, "\"", flags);
                    self.resumeEvent();
                    self.isPaintSuspended(oldState)
                };
                Sheet.prototype.getCsv = function(row, column, rowCount, columnCount, rowDelimiter, columnDelimiter)
                {
                    return staticMembers.getRangeText(this, row, rowCount, column, columnCount, rowDelimiter, columnDelimiter, "\"", true, 0)
                };
                Sheet.prototype.canUserDragDrop = function(value)
                {
                    var self = this,
                        parent = self.parent;
                    if (arguments.length === 0)
                    {
                        if (parent && parent.canUserDragDrop)
                        {
                            self._allowDragDrop = parent.canUserDragDrop()
                        }
                        return self._allowDragDrop
                    }
                    else
                    {
                        if (parent && parent.canUserDragDrop)
                        {
                            parent.canUserDragDrop(value)
                        }
                        else
                        {
                            self._allowDragDrop = value
                        }
                        return self
                    }
                };
                Sheet.prototype.canUserDragFill = function(value)
                {
                    var self = this,
                        parent = self.parent;
                    if (arguments.length === 0)
                    {
                        if (!Sheets.features.fill)
                        {
                            return false
                        }
                        if (parent && parent.canUserDragFill)
                        {
                            self._allowDragFill = parent.canUserDragFill()
                        }
                        return self._allowDragFill
                    }
                    else
                    {
                        var oldValue = self.canUserDragFill();
                        if (oldValue !== value)
                        {
                            if (parent && parent.canUserDragFill)
                            {
                                parent.canUserDragFill(value)
                            }
                            else
                            {
                                self._allowDragFill = value
                            }
                            if (self.getSelections().length === 1 && !self._paintSuspended)
                            {
                                self._render.repaintSelection(self.getSelections()[0])
                            }
                        }
                        return self
                    }
                };
                Sheet.prototype.showDragFillSmartTag = function(value)
                {
                    var self = this,
                        parent = self.parent;
                    if (arguments.length === 0)
                    {
                        if (parent && parent.showDragFillSmartTag)
                        {
                            self._showDragFillSmartTag = parent.showDragFillSmartTag()
                        }
                        return self._showDragFillSmartTag
                    }
                    else
                    {
                        var oldValue = self.showDragFillSmartTag();
                        if (typeof value === "boolean" && oldValue !== value)
                        {
                            if (parent && parent.showDragFillSmartTag)
                            {
                                parent.showDragFillSmartTag(value)
                            }
                            else
                            {
                                self._showDragFillSmartTag = value
                            }
                        }
                        return self
                    }
                };
                Sheet.prototype.defaultDragFillType = function(value)
                {
                    var self = this,
                        parent = self.parent;
                    if (arguments.length === 0)
                    {
                        if (parent && parent.defaultDragFillType)
                        {
                            self._defaultDragFillType = parent.defaultDragFillType()
                        }
                        return self._defaultDragFillType
                    }
                    else
                    {
                        var oldValue = self.defaultDragFillType();
                        if (Sheets.AutoFillType[value] !== keyword_undefined && value !== 4 && value !== oldValue)
                        {
                            if (parent && parent.defaultDragFillType)
                            {
                                parent.defaultDragFillType(value)
                            }
                            else
                            {
                                self._defaultDragFillType = value
                            }
                        }
                        return self
                    }
                };
                Sheet.prototype.isColumnBound = function(column)
                {
                    var self = this;
                    if (column < 0 || column >= self.getColumnCount())
                    {
                        return false
                    }
                    var ds = self.getDataSource();
                    if (ds)
                    {
                        var ci = this._sheetModelManager.getColInfos()._getItem(column);
                        return !!(ci && ci.name)
                    }
                    return false
                };
                Sheet.prototype.getDataColumnName = function(column)
                {
                    var self = this;
                    if (column < 0 || column >= self.getColumnCount())
                    {
                        return keyword_null
                    }
                    var ds = self.getDataSource();
                    if (ds)
                    {
                        var ci = this._sheetModelManager.getColInfos()._getItem(column);
                        return (ci && (ci.displayName || ci.name))
                    }
                    return keyword_null
                };
                Sheet.prototype.getSparkline = function(row, col)
                {
                    if (!this._sparklineGroupManager)
                    {
                        return keyword_null
                    }
                    var sheetArea = 3;
                    var m = this._sheetModelManager.getDataModel(sheetArea);
                    return m.getSparkline(row, col)
                };
                Sheet.prototype.setSparkline = function(row, col, dataRange, dataOrientation, sparklineType, sparklineSetting, dateAxisRange, dateAxisOrientation)
                {
                    var self = this,
                        sparklineGroupManager = self._sparklineGroupManager;
                    if (!sparklineGroupManager)
                    {
                        return keyword_null
                    }
                    return self._bindToAutoRefresh(function(row, col, dataRange, dataOrientation, sparklineType, sparklineSetting, dateAxisRange, dateAxisOrientation)
                        {
                            var data = dataRange;
                            var sparkline = new Sheets.Sparkline(row, col, data, dataOrientation, sparklineType, sparklineSetting);
                            if (dateAxisRange && dateAxisOrientation !== keyword_undefined && dateAxisOrientation !== keyword_null)
                            {
                                sparkline.dateAxisData(dateAxisRange);
                                sparkline.dateAxisOrientation(dateAxisOrientation);
                                sparkline.group().displayDateAxis = true
                            }
                            self.removeSparkline(row, col);
                            var m = self._getModel();
                            m.setSparkline(row, col, sparkline);
                            sparklineGroupManager.add(sparkline.group());
                            self._raiseCellChanged("sparkline", row, col, 3);
                            return sparkline
                        })(row, col, dataRange, dataOrientation, sparklineType, sparklineSetting, dateAxisRange, dateAxisOrientation)
                };
                Sheet.prototype.removeSparkline = function(row, col)
                {
                    var self = this,
                        sparklineGroupManager = self._sparklineGroupManager;
                    if (!sparklineGroupManager)
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(row, col)
                    {
                        var sheetArea = 3;
                        var m = self._getModel(sheetArea);
                        var old = m.getSparkline(row, col);
                        if (old)
                        {
                            var g = old.group();
                            g.remove(old);
                            if (g.count() <= 0)
                            {
                                sparklineGroupManager.remove(g)
                            }
                        }
                        m.setSparkline(row, col, keyword_null)
                    })(row, col)
                };
                Sheet.prototype.groupSparkline = function(sparklines)
                {
                    var sparklineGroupManager = this._sparklineGroupManager;
                    if (!sparklineGroupManager)
                    {
                        return keyword_null
                    }
                    var self = this;
                    return this._bindToAutoRefresh(function(sparklines)
                        {
                            var first = keyword_null;
                            for (var i = 0; i < sparklines.length; i++)
                            {
                                var si = sparklines[i];
                                if (!si)
                                {
                                    continue
                                }
                                if (!first)
                                {
                                    first = si.group();
                                    continue
                                }
                                var sg = si.group();
                                sg.remove(si);
                                first.add(si);
                                if (sg.count() <= 0)
                                {
                                    sparklineGroupManager.remove(sg)
                                }
                            }
                            return first
                        })(sparklines)
                };
                Sheet.prototype.ungroupSparkline = function(group)
                {
                    var self = this,
                        sparklineGroupManager = self._sparklineGroupManager;
                    if (!sparklineGroupManager)
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(group)
                    {
                        if (!group)
                        {
                            return
                        }
                        var sparklines = [];
                        sparklines = sparklines.concat(group._innerList);
                        for (var i = 0; i < sparklines.length; i++)
                        {
                            var sparkline = sparklines[i];
                            if (sparkline)
                            {
                                group.remove(sparkline);
                                var newGroup = group.clone();
                                newGroup.add(sparkline);
                                sparklineGroupManager.add(newGroup)
                            }
                        }
                        sparklineGroupManager.remove(group)
                    })(group)
                };
                Sheet.prototype.fillAuto = function(startRange, wholeRange, series)
                {
                    if (!Sheets.features.fill)
                    {
                        return
                    }
                    if (!wholeRange)
                    {
                        throw new Error(Sheets.SR.Exp_RangeIsNull);
                    }
                    var self = this;
                    if (!self._checkFillRange(startRange, wholeRange, series))
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(startRange, wholeRange, series)
                    {
                        if (startRange)
                        {
                            self._eventHandler._dragFillStartRange = startRange
                        }
                        var fill = new Sheets.FillImp(self);
                        fill.fillAuto(wholeRange, series)
                    })(startRange, wholeRange, series)
                };
                Sheet.prototype.fillAutobyDirection = function(startRange, wholeRange, direction)
                {
                    if (!Sheets.features.fill)
                    {
                        return
                    }
                    if (!wholeRange)
                    {
                        throw new Error(Sheets.SR.Exp_RangeIsNull);
                    }
                    var self = this;
                    if (!self._checkFillRange(startRange, wholeRange, keyword_null, direction))
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(startRange, wholeRange, direction)
                    {
                        if (startRange)
                        {
                            self._eventHandler._dragFillStartRange = startRange
                        }
                        var fill = new Sheets.FillImp(self);
                        fill.fillAutobyDirection(wholeRange, direction)
                    })(startRange, wholeRange, direction)
                };
                Sheet.prototype.fillLinear = function(startRange, wholeRange, series, step, stop)
                {
                    if (!Sheets.features.fill)
                    {
                        return
                    }
                    if (!wholeRange)
                    {
                        throw new Error(Sheets.SR.Exp_RangeIsNull);
                    }
                    var self = this;
                    if (!self._checkFillRange(startRange, wholeRange, series))
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(startRange, wholeRange, series, step, stop)
                    {
                        if (startRange)
                        {
                            self._eventHandler._dragFillStartRange = startRange
                        }
                        var fill = new Sheets.FillImp(self);
                        fill.fillLinear(wholeRange, series, step, stop)
                    })(startRange, wholeRange, series, step, stop)
                };
                Sheet.prototype.fillGrowth = function(startRange, wholeRange, series, step, stop)
                {
                    if (!Sheets.features.fill)
                    {
                        return
                    }
                    if (!wholeRange)
                    {
                        throw new Error(Sheets.SR.Exp_RangeIsNull);
                    }
                    var self = this;
                    if (!self._checkFillRange(startRange, wholeRange, series))
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(startRange, wholeRange, series, step, stop)
                    {
                        if (startRange)
                        {
                            self._eventHandler._dragFillStartRange = startRange
                        }
                        var fill = new Sheets.FillImp(self);
                        fill.fillGrowth(wholeRange, series, step, stop)
                    })(startRange, wholeRange, series, step, stop)
                };
                Sheet.prototype.fillDate = function(startRange, wholeRange, series, unit, step, stop)
                {
                    if (!Sheets.features.fill)
                    {
                        return
                    }
                    if (!wholeRange)
                    {
                        throw new Error(Sheets.SR.Exp_RangeIsNull);
                    }
                    var self = this;
                    if (!self._checkFillRange(startRange, wholeRange, series))
                    {
                        return
                    }
                    self._bindToAutoRefresh(function(startRange, wholeRange, series, unit, step, stop)
                    {
                        if (startRange)
                        {
                            self._eventHandler._dragFillStartRange = startRange
                        }
                        var fill = new Sheets.FillImp(self);
                        var oaStop = keyword_null;
                        if (stop !== keyword_undefined && stop !== keyword_null)
                        {
                            oaStop = new Sheets._DateTimeHelper(stop).toOADate()
                        }
                        fill.fillDate(wholeRange, series, unit, step, oaStop)
                    })(startRange, wholeRange, series, unit, step, stop)
                };
                Sheet.prototype._checkFillRange = function(startRange, wholeRange, series, direction)
                {
                    if (!startRange || !wholeRange)
                    {
                        return false
                    }
                    if (!wholeRange.containsRange(startRange))
                    {
                        return false
                    }
                    if (series !== keyword_undefined && series !== keyword_null)
                    {
                        if (series === 1)
                        {
                            if (startRange.row === wholeRange.row && startRange.rowCount === wholeRange.rowCount)
                            {
                                return true
                            }
                        }
                        else if (series === 0)
                        {
                            if (startRange.col === wholeRange.col && startRange.colCount === wholeRange.colCount)
                            {
                                return true
                            }
                        }
                    }
                    if (direction !== keyword_undefined && direction !== keyword_null)
                    {
                        if (direction === 2 || direction === 3)
                        {
                            if (startRange.col === wholeRange.col && startRange.colCount === wholeRange.colCount)
                            {
                                return true
                            }
                        }
                        else if (direction === 0 || direction === 1)
                        {
                            if (startRange.row === wholeRange.row && startRange.rowCount === wholeRange.rowCount)
                            {
                                return true
                            }
                        }
                    }
                    return false
                };
                Sheet.prototype.clear = function(row, column, rowCount, columnCount, area, type)
                {
                    this.clearCore(row, column, rowCount, columnCount, area, type)
                };
                Sheet.prototype._checkArrayFormula = function(row, column, rowCount, columnCount, onlyCheckIntersected)
                {
                    onlyCheckIntersected = onlyCheckIntersected === undefined ? true : false;
                    if (onlyCheckIntersected && this._hasPartArrayFormulas(row, column, rowCount, columnCount) || !onlyCheckIntersected && this._hasArrayFormula(row, column, rowCount, columnCount))
                    {
                        this._raiseInvalidOperation(4, Sheets.SR.Exp_ChangePartOfArray);
                        return false
                    }
                    return true
                };
                Sheet.prototype.clearCore = function(row, column, rowCount, columnCount, area, type, ignoreFilteredOutRow)
                {
                    var self = this;
                    self._bindToAutoRefresh(function(row, column, rowCount, columnCount, area, type)
                    {
                        self.suspendCalcService();
                        try
                        {
                            var r,
                                c,
                                i,
                                j;
                            var viewport = 3;
                            if (area === keyword_undefined || area === keyword_null || area === viewport)
                            {
                                if (!self._checkArrayFormula(row, column, rowCount, columnCount))
                                {
                                    return false
                                }
                                if ((type & 1) === 1)
                                {
                                    if (self.getDataSource() || self.dataContext)
                                    {
                                        self.suspendEvent();
                                        for (r = row; r < row + rowCount; r++)
                                        {
                                            if (ignoreFilteredOutRow && self.isRowFilterOut(r))
                                            {
                                                continue
                                            }
                                            for (c = column; c < column + columnCount; c++)
                                            {
                                                self.setValue(r, c, keyword_null, area)
                                            }
                                        }
                                        self.resumeEvent()
                                    }
                                    if (self._conditionalFormats)
                                    {
                                        self._conditionalFormats._clearCache()
                                    }
                                    if (self._rowFilter && self._rowFilter.range)
                                    {
                                        self._rowFilter._clear(row, column, rowCount, columnCount)
                                    }
                                }
                                if ((type & 16) === 16)
                                {
                                    if (self._sparklineGroupManager)
                                    {
                                        self._sparklineGroupManager.clear(row, column, rowCount, columnCount)
                                    }
                                }
                                if (self._tableManager)
                                {
                                    self._tableManager.clear(row, column, rowCount, columnCount, type)
                                }
                                if ((type & 4) === 4)
                                {
                                    if (self._commentManager)
                                    {
                                        self._commentManager.clear(row, column, rowCount, columnCount)
                                    }
                                }
                            }
                            var block = self._getModel(area);
                            var calcBlock = self._getCalcModel(area);
                            if (block)
                            {
                                r = row === -1 ? 0 : row;
                                var rc = row === -1 ? block.getRowCount() : rowCount;
                                c = column === -1 ? 0 : column;
                                var cc = column === -1 ? block.getColumnCount() : columnCount;
                                var hiddenRowList = [];
                                for (var rowIndex = r; rowIndex < rc; rowIndex++)
                                {
                                    if (ignoreFilteredOutRow && self.isRowFilterOut(rowIndex))
                                    {
                                        hiddenRowList.push(rowIndex)
                                    }
                                }
                                block.clear(r, c, rc, cc, type, hiddenRowList);
                                if (calcBlock)
                                {
                                    if ((type & 1) !== 0)
                                    {
                                        self._getCalcModel().unlinkCellExpression(r, c, rc, cc);
                                        calcBlock.clear(r, c, rc, cc)
                                    }
                                }
                                if ((type & 8) === 8)
                                {
                                    if (!(row >= 0 && column >= 0))
                                    {
                                        if (column >= 0)
                                        {
                                            for (j = 0; j < cc; j++)
                                            {
                                                self.setTag(-1, c + j, keyword_null, area)
                                            }
                                        }
                                        else if (row >= 0)
                                        {
                                            for (i = 0; i < rc; i++)
                                            {
                                                if (ignoreFilteredOutRow && self.isRowFilterOut(r + i))
                                                {
                                                    continue
                                                }
                                                self.setTag(r + i, -1, keyword_null, area)
                                            }
                                        }
                                        else
                                        {
                                            self.setTag(-1, -1, keyword_null, area)
                                        }
                                    }
                                }
                                if ((type & 2) === 2)
                                {
                                    if (!(row >= 0 && column >= 0))
                                    {
                                        if (column >= 0)
                                        {
                                            for (j = 0; j < cc; j++)
                                            {
                                                self.setStyle(-1, c + j, keyword_null, area)
                                            }
                                        }
                                        else if (row >= 0)
                                        {
                                            for (i = 0; i < rc; i++)
                                            {
                                                if (ignoreFilteredOutRow && self.isRowFilterOut(r + i))
                                                {
                                                    continue
                                                }
                                                self.setStyle(r + i, -1, keyword_null, area)
                                            }
                                        }
                                        else
                                        {
                                            self.setStyle(-1, -1, keyword_null, area)
                                        }
                                    }
                                }
                                if ((type & 32) === 32)
                                {
                                    if (!(row >= 0 && column >= 0))
                                    {
                                        if (column >= 0)
                                        {
                                            for (j = 0; j < cc; j++)
                                            {
                                                self.setColumnVisible(c + j, true, area);
                                                self.setColumnResizable(c + j, true, area);
                                                self.setColumnWidth(c + j, (area === 2) ? self.defaults.rowHeaderColWidth : self.defaults.colWidth, area)
                                            }
                                        }
                                        else if (row >= 0)
                                        {
                                            for (i = 0; i < rc; i++)
                                            {
                                                if (ignoreFilteredOutRow && self.isRowFilterOut(r + i))
                                                {
                                                    continue
                                                }
                                                self.setRowVisible(r + i, true, area);
                                                self.setRowResizable(r + i, true, area);
                                                self.setRowHeight(r + i, (area === 1) ? self.defaults.colHeaderRowHeight : self.defaults.rowHeight, area)
                                            }
                                        }
                                        else
                                        {
                                            for (j = 0; j < cc; j++)
                                            {
                                                self.setColumnVisible(c + j, true, area);
                                                self.setColumnResizable(c + j, true, area);
                                                self.setColumnWidth(c + j, (area === 2) ? self.defaults.rowHeaderColWidth : self.defaults.colWidth, area)
                                            }
                                            for (i = 0; i < rc; i++)
                                            {
                                                if (ignoreFilteredOutRow && self.isRowFilterOut(r + i))
                                                {
                                                    continue
                                                }
                                                self.setRowVisible(r + i, true, area);
                                                self.setRowResizable(r + i, true, area);
                                                self.setRowHeight(r + i, (area === 1) ? self.defaults.colHeaderRowHeight : self.defaults.rowHeight, area)
                                            }
                                        }
                                    }
                                }
                                for (i = 0; i < rc; i++)
                                {
                                    for (j = 0; j < cc; j++)
                                    {
                                        r = row + i;
                                        c = column + j;
                                        if ((type & 1) === 1)
                                        {
                                            self._raiseCellChanged(_value, r, c, area)
                                        }
                                        if ((type & 8) === 8)
                                        {
                                            self._raiseCellChanged(_tag, r, c, area)
                                        }
                                        if ((type & 2) === 2)
                                        {
                                            self._raiseCellChanged("style", r, c, area)
                                        }
                                        if ((type & 16) === 16)
                                        {
                                            self._raiseCellChanged("sparkline", r, c, area)
                                        }
                                        if ((type & 4) === 4)
                                        {
                                            self._raiseCellChanged("comment", r, c, area)
                                        }
                                        if ((type & 32) === 32)
                                        {
                                            self._raiseCellChanged("axis", r, c, area)
                                        }
                                        if ((type & 64) === 64)
                                        {
                                            self._raiseCellChanged("bindingPath", r, c, area)
                                        }
                                    }
                                }
                            }
                            if (area === keyword_undefined || area === keyword_null || area === viewport)
                            {
                                if ((type & 1) === 1)
                                {
                                    var calcModel = self._getCalcModel();
                                    if (calcModel)
                                    {
                                        calcModel._addCellsToDirty(row, column, rowCount, columnCount)
                                    }
                                }
                            }
                        }
                        finally
                        {
                            self.resumeCalcService()
                        }
                    })(row, column, rowCount, columnCount, area, type)
                };
                Sheet.prototype.getConditionalFormats = function()
                {
                    var self = this;
                    if (!self._conditionalFormats && Sheets.features.conditionalFormat)
                    {
                        self._conditionalFormats = new Sheets.ConditionalFormats(self)
                    }
                    return self._conditionalFormats
                };
                Sheet.prototype.rowFilter = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._rowFilter
                    }
                    else
                    {
                        return self._bindToAutoRefresh(function(value)
                            {
                                if (self._rowFilter)
                                {
                                    self._rowFilter.reset()
                                }
                                self._rowFilter = value;
                                if (self._rowFilter)
                                {
                                    self._rowFilter.sheet = self
                                }
                                else
                                {
                                    self.refreshObjectsAboveSheet();
                                    if (self.filterRowsVisibleInfo)
                                    {
                                        self.filterRowsVisibleInfo.reset()
                                    }
                                }
                                return self
                            })(value)
                    }
                };
                Sheet.prototype.autoFitColumn = function(column)
                {
                    if (column < 0 || column >= this.getColumnCount())
                    {
                        return
                    }
                    var action = new Sheets.UndoRedo.ColumnAutoFitUndoAction(this, [{col: column}], false);
                    action.execute(this)
                };
                Sheet.prototype.autoFitRow = function(row)
                {
                    if (row < 0 || row >= this.getRowCount())
                    {
                        return
                    }
                    var action = new Sheets.UndoRedo.RowAutoFitUndoAction(this, [{row: row}], false);
                    action.execute(this)
                };
                Sheet.prototype.setGridlineOptions = function(options)
                {
                    var self = this;
                    self._bindToAutoRefresh(function(options)
                    {
                        if (options)
                        {
                            if (!self.gridline)
                            {
                                self.gridline = {}
                            }
                            var gridline = self.gridline;
                            if (options.color)
                            {
                                gridline.color = options.color
                            }
                            if (options.showVerticalGridline !== keyword_null && options.showVerticalGridline !== keyword_undefined)
                            {
                                gridline.showVerticalGridline = options.showVerticalGridline
                            }
                            if (options.showHorizontalGridline !== keyword_null && options.showHorizontalGridline !== keyword_undefined)
                            {
                                gridline.showHorizontalGridline = options.showHorizontalGridline
                            }
                        }
                    })(options)
                };
                Sheet.prototype.getGridlineOptions = function()
                {
                    var self = this;
                    if (!self.gridline)
                    {
                        self.gridline = {}
                    }
                    var gridline = self.gridline;
                    var options = {};
                    options.color = gridline.color;
                    options.showVerticalGridline = gridline.showVerticalGridline;
                    options.showHorizontalGridline = gridline.showHorizontalGridline;
                    return options
                };
                Sheet.prototype.getFrozenRowCount = function()
                {
                    return this.frozenRowCount
                };
                Sheet.prototype.getFrozenColumnCount = function()
                {
                    return this.frozenColCount
                };
                Sheet.prototype.getFrozenTrailingRowCount = function()
                {
                    return this._frozenTrailingRowCount
                };
                Sheet.prototype.getFrozenTrailingColumnCount = function()
                {
                    return this._frozenTrailingColCount
                };
                Sheet.prototype.setRowHeaderVisible = function(visible)
                {
                    var self = this;
                    this._bindToAutoRefresh(function(options)
                    {
                        self.rowHeaderVisible = visible
                    })(visible)
                };
                Sheet.prototype.getRowHeaderVisible = function()
                {
                    return this.rowHeaderVisible
                };
                Sheet.prototype.setColumnHeaderVisible = function(visible)
                {
                    var self = this;
                    this._bindToAutoRefresh(function(options)
                    {
                        self.colHeaderVisible = visible
                    })(visible)
                };
                Sheet.prototype.getColumnHeaderVisible = function()
                {
                    return this.colHeaderVisible
                };
                Sheet.prototype.setRowHeaderAutoText = function(autoText)
                {
                    var self = this;
                    this._bindToAutoRefresh(function(autoText)
                    {
                        self.rowHeaderAutoText = autoText
                    })(autoText)
                };
                Sheet.prototype.getRowHeaderAutoText = function()
                {
                    return this.rowHeaderAutoText
                };
                Sheet.prototype.setColumnHeaderAutoText = function(autoText)
                {
                    var self = this;
                    this._bindToAutoRefresh(function(autoText)
                    {
                        self.colHeaderAutoText = autoText
                    })(autoText)
                };
                Sheet.prototype.getColumnHeaderAutoText = function()
                {
                    return this.colHeaderAutoText
                };
                Sheet.prototype.setRowHeaderAutoTextIndex = function(autoTextIndex)
                {
                    var self = this;
                    this._bindToAutoRefresh(function(autoTextIndex)
                    {
                        self.rowHeaderAutoTextIndex = autoTextIndex
                    })(autoTextIndex)
                };
                Sheet.prototype.getRowHeaderAutoTextIndex = function()
                {
                    return this.rowHeaderAutoTextIndex
                };
                Sheet.prototype.setColumnHeaderAutoTextIndex = function(autoTextIndex)
                {
                    var self = this;
                    this._bindToAutoRefresh(function(autoTextIndex)
                    {
                        self.colHeaderAutoTextIndex = autoTextIndex
                    })(autoTextIndex)
                };
                Sheet.prototype.getColumnHeaderAutoTextIndex = function()
                {
                    return this.colHeaderAutoTextIndex
                };
                Sheet.prototype.setIsProtected = function(isProtected)
                {
                    var self = this;
                    this._bindToAutoRefresh(function(autoTextIndex)
                    {
                        self.isProtected = isProtected;
                        self.undoManager().clear()
                    })(isProtected)
                };
                Sheet.prototype.getIsProtected = function()
                {
                    return this.isProtected
                };
                Sheet.prototype.setArray = function(row, column, array, setFormula)
                {
                    var self = this;
                    var rowCount = self.getRowCount(),
                        columnCount = self.getColumnCount();
                    if (array && 0 <= row && row < rowCount && 0 <= column && column < columnCount)
                    {
                        self.suspendCalcService();
                        var oldState = self.isPaintSuspended();
                        self.isPaintSuspended(true);
                        try
                        {
                            $.each(array, function(i, v)
                            {
                                if (!(v instanceof Array))
                                {
                                    var r = row + i,
                                        c = column;
                                    if (r < rowCount && c < columnCount)
                                    {
                                        if (setFormula)
                                        {
                                            self.setFormula(r, c, v)
                                        }
                                        else
                                        {
                                            self.setValue(r, c, v, 3, true)
                                        }
                                    }
                                }
                                else
                                {
                                    $.each(v, function(j, vv)
                                    {
                                        var r = row + i,
                                            c = column + j;
                                        if (r < rowCount && c < columnCount)
                                        {
                                            if (setFormula)
                                            {
                                                self.setFormula(r, c, vv)
                                            }
                                            else
                                            {
                                                self.setValue(r, c, vv, 3, true)
                                            }
                                        }
                                    })
                                }
                            })
                        }
                        finally
                        {
                            self.resumeCalcService();
                            self.isPaintSuspended(oldState)
                        }
                    }
                };
                Sheet.prototype.getArray = function(row, column, rowCount, columnCount, getFormula)
                {
                    var self = this;
                    var array = [];
                    var rc = self.getRowCount(),
                        cc = self.getColumnCount();
                    if (0 <= row && row < rc && 0 <= column && column < cc)
                    {
                        if (row + rowCount > rc)
                        {
                            rowCount = rc - row
                        }
                        if (column + columnCount > cc)
                        {
                            columnCount = cc - column
                        }
                        for (var i = 0; i < rowCount; i++)
                        {
                            array[i] = [];
                            for (var j = 0; j < columnCount; j++)
                            {
                                if (getFormula)
                                {
                                    array[i][j] = self.getFormula(row + i, column + j)
                                }
                                else
                                {
                                    array[i][j] = self.getValue(row + i, column + j)
                                }
                            }
                        }
                    }
                    return array
                };
                Sheet.prototype.showRowRangeGroup = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        if (!Sheets.features.group)
                        {
                            return false
                        }
                        return self._showRowRangeGroup
                    }
                    if (self._showRowRangeGroup !== value)
                    {
                        self._bindToAutoRefresh(function(value)
                        {
                            self._showRowRangeGroup = value
                        })(value)
                    }
                    return self
                };
                Sheet.prototype.showColumnRangeGroup = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        if (!Sheets.features.group)
                        {
                            return false
                        }
                        return self._showColumnRangeGroup
                    }
                    if (self._showColumnRangeGroup !== value)
                    {
                        self._bindToAutoRefresh(function(value)
                        {
                            self._showColumnRangeGroup = value
                        })(value)
                    }
                    return self
                };
                Sheet.prototype.addTable = function(name, row, column, rowCount, columnCount, style)
                {
                    var self = this;
                    var tm = self._tableManager;
                    if (!tm)
                    {
                        return keyword_null
                    }
                    self._checkCanAddTable(name, row, column, rowCount, columnCount, true);
                    if (style === keyword_undefined)
                    {
                        style = Sheets.TableStyles.medium2()
                    }
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        return tm.add(self._createTable(name, row, column, rowCount, columnCount, style))
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.addTableByDataSource = function(name, row, column, dataSource, style)
                {
                    var self = this;
                    var tm = self._tableManager;
                    if (!tm || !Sheets.features.binding)
                    {
                        return keyword_null
                    }
                    if (!dataSource)
                    {
                        throw new Error(Sheets.SR.Exp_TableDataSourceNullError);
                    }
                    self._checkCanAddTable(name, row, column, 1, 1, true);
                    var bs = new Sheets._BindingManager;
                    bs.bind(dataSource);
                    var rowCount = bs.getRowCount();
                    var columnCount = bs.getColumnCount();
                    rowCount = rowCount + 1;
                    if (row + rowCount > self.getRowCount())
                    {
                        self.setRowCount(row + rowCount)
                    }
                    if (column + columnCount > self.getColumnCount())
                    {
                        self.setColumnCount(column + columnCount)
                    }
                    self._checkCanAddTable(name, row, column, rowCount, columnCount, true);
                    if (style === keyword_undefined)
                    {
                        style = Sheets.TableStyles.medium2()
                    }
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        var table = tm.add(self._createTable(name, row, column, rowCount, columnCount, style));
                        table._bind(bs);
                        self.clearPendingChanges();
                        return table
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype._createTable = function(name, row, column, rowCount, columnCount, style)
                {
                    return new Sheets.SheetTable(name, row, column, rowCount, columnCount, style)
                };
                Sheet.prototype.findTable = function(row, column)
                {
                    var tm = this._tableManager;
                    if (tm)
                    {
                        return tm.find(row, column)
                    }
                    return keyword_null
                };
                Sheet.prototype.findTableByName = function(name)
                {
                    var tm = this._tableManager,
                        table = keyword_null;
                    if (tm)
                    {
                        table = tm.findByName(name)
                    }
                    if (!table)
                    {
                        var sheets = this.parent && this.parent.sheets;
                        if (sheets)
                        {
                            for (var i = 0; i < sheets.length; i++)
                            {
                                tm = sheets[i]._tableManager;
                                if (tm)
                                {
                                    table = tm.findByName(name);
                                    if (table)
                                    {
                                        break
                                    }
                                }
                            }
                        }
                    }
                    return table
                };
                Sheet.prototype.removeTable = function(table)
                {
                    var self = this;
                    var tm = self._tableManager;
                    if (!table || !tm)
                    {
                        return self
                    }
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        tm.remove(table);
                        return self
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.removeTableByName = function(name)
                {
                    var table = this.findTableByName(name);
                    if (table)
                    {
                        this.removeTable(table)
                    }
                    return this
                };
                Sheet.prototype.moveTable = function(table, row, column)
                {
                    var self = this;
                    var tm = self._tableManager;
                    if (!tm || !table || row < 0 || column < 0)
                    {
                        return self
                    }
                    var cr = table.range(),
                        rowCount = cr.rowCount,
                        columnCount = cr.colCount;
                    var tables = tm.findByRange(row, column, rowCount, columnCount);
                    if (tables)
                    {
                        if (tables.length > 1)
                        {
                            return self
                        }
                        else if (tables.length === 1 && tables[0] !== table)
                        {
                            return self
                        }
                    }
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        table._moveTo(row, column);
                        return self
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.moveTableByName = function(name, row, column)
                {
                    var table = this.findTableByName(name);
                    if (table)
                    {
                        this.moveTable(table, row, column)
                    }
                    return this
                };
                Sheet.prototype.resizeTable = function(table, rowCount, columnCount)
                {
                    var self = this;
                    var tm = self._tableManager;
                    if (!tm || !table || rowCount < 0 || columnCount < 0)
                    {
                        return self
                    }
                    var cr = table.range(),
                        row = cr.row,
                        column = cr.col;
                    var tables = tm.findByRange(row, column, rowCount, columnCount);
                    if (tables && tables.length > 1)
                    {
                        return self
                    }
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    try
                    {
                        table._resize(rowCount, columnCount);
                        return self
                    }
                    finally
                    {
                        self.isPaintSuspended(oldState)
                    }
                };
                Sheet.prototype.resizeTableByName = function(name, rowCount, columnCount)
                {
                    var table = this.findTableByName(name);
                    if (table)
                    {
                        this.resizeTable(table, rowCount, columnCount)
                    }
                    return this
                };
                Sheet.prototype.getTables = function()
                {
                    var tm = this._tableManager;
                    if (tm)
                    {
                        return tm.getTables()
                    }
                };
                Sheet.prototype.clearTables = function()
                {
                    var self = this,
                        tm = self._tableManager;
                    if (tm)
                    {
                        var oldState = self.isPaintSuspended();
                        self.isPaintSuspended(true);
                        try
                        {
                            tm.clearTables()
                        }
                        finally
                        {
                            self.isPaintSuspended(oldState)
                        }
                    }
                    return self
                };
                Sheet.prototype.selectionBackColor = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._selectionBackColor
                    }
                    return self._bindToAutoRefresh(function(value)
                        {
                            if (value)
                            {
                                self._selectionBackColor = value
                            }
                            return self
                        })(value)
                };
                Sheet.prototype.selectionBorderColor = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._selectionBorderColor
                    }
                    return self._bindToAutoRefresh(function(value)
                        {
                            if (value)
                            {
                                self._selectionBorderColor = value
                            }
                            return self
                        })(value)
                };
                Sheet.prototype._addTableInternal = function(table)
                {
                    var tm = this._tableManager;
                    if (!tm)
                    {
                        return
                    }
                    var cr = table.range();
                    if (!this._checkCanAddTable(table.name(), cr.row, cr.col, cr.rowCount, cr.colCount))
                    {
                        return
                    }
                    tm.add(table)
                };
                Sheet.prototype._checkCanAddTable = function(name, row, col, rowCount, colCount, throwException)
                {
                    var self = this;
                    if (!name)
                    {
                        if (throwException)
                        {
                            throw new Error(Sheets.SR.Exp_TableEmptyNameError);
                        }
                        return false
                    }
                    if (row < 0 || rowCount < 1 || row + rowCount > self.getRowCount())
                    {
                        if (throwException)
                        {
                            throw new Error(Sheets.SR.Exp_TableInvalidRow);
                        }
                        return false
                    }
                    if (col < 0 || colCount < 1 || col + colCount > self.getColumnCount())
                    {
                        if (throwException)
                        {
                            throw new Error(Sheets.SR.Exp_TableInvalidColumn);
                        }
                        return false
                    }
                    if (self._hasTable(row, col, rowCount, colCount))
                    {
                        if (throwException)
                        {
                            throw new Error(Sheets.SR.Exp_TableIntersectError);
                        }
                        return false
                    }
                    if ((self.parent && self.parent._findTable(name)) || (!self.parent && self.findTableByName(name)))
                    {
                        if (throwException)
                        {
                            throw new Error(Sheets.SR.Exp_TableHasSameNameError);
                        }
                        return false
                    }
                    var arrarFormulas = self._getsArrayFormulas(row, col, rowCount, colCount);
                    if (arrarFormulas && arrarFormulas.ranges && arrarFormulas.ranges.length > 0)
                    {
                        for (var i = 0; i < arrarFormulas.ranges.length; i++)
                        {
                            var baseRange = arrarFormulas.ranges[i];
                            if (baseRange.rowCount > 1 || baseRange.colCount > 1)
                            {
                                if (throwException)
                                {
                                    throw new Error(Sheets.SR.Exp_ArrayFormulaTable);
                                }
                                return false
                            }
                        }
                    }
                    return true
                };
                Sheet.prototype.setComment = function(row, col, value)
                {
                    if (!Sheets.features.comment)
                    {
                        return
                    }
                    var self = this,
                        commentManager = this._commentManager;
                    var span = self.getSpan(row, col);
                    if (span && (span.row !== row || span.col !== col) && value)
                    {
                        return
                    }
                    var oldComment = self.getComment(row, col);
                    if (oldComment)
                    {
                        if (commentManager && commentManager.containsComment(oldComment))
                        {
                            commentManager.removeComment(oldComment)
                        }
                    }
                    var model = self._getModel(3);
                    model.setComment(row, col, value);
                    commentManager.addComment(row, col, value);
                    self._raiseCellChanged("comment", row, col, 3)
                };
                Sheet.prototype.getComment = function(row, col)
                {
                    if (!Sheets.features.comment)
                    {
                        return keyword_null
                    }
                    var model = this._getModel(3);
                    return model.getComment(row, col)
                };
                Sheet.prototype.getComments = function()
                {
                    if (!Sheets.features.comment)
                    {
                        return
                    }
                    return this._commentManager.getCommentList()
                };
                Sheet.prototype.setTag = function(row, col, tag, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this;
                    var m = self._getModel(sheetArea);
                    if (m)
                    {
                        var rowCount = m.getRowCount(),
                            colCount = m.getColumnCount();
                        if (row < -1 || row >= rowCount || col < -1 || col >= colCount)
                        {
                            return
                        }
                        tag = staticMembers.tryConvertDateToOADate(tag);
                        var oldTag,
                            isEventsSuspended = (self._eventHandler._eventSuspended > 0);
                        if (!isEventsSuspended)
                        {
                            oldTag = m.getTag(row, col)
                        }
                        m.setTag(row, col, tag);
                        if (!isEventsSuspended && oldTag !== tag)
                        {
                            if (row !== -1 && col !== -1)
                            {
                                self.triggerCellChanged({
                                    sheet: self, sheetName: self._name, row: row, col: col, sheetArea: sheetArea, propertyName: _tag, oldTag: oldTag
                                })
                            }
                            else if (row !== -1 && col === -1)
                            {
                                self.triggerRowChanged({
                                    sheet: self, sheetName: self._name, row: row, sheetArea: sheetArea, propertyName: _tag, oldTag: oldTag
                                })
                            }
                            else if (row === -1 && col !== -1)
                            {
                                self.triggerColumnChanged({
                                    sheet: self, sheetName: self._name, col: col, sheetArea: sheetArea, propertyName: _tag, oldTag: oldTag
                                })
                            }
                        }
                    }
                };
                Sheet.prototype.getTag = function(row, col, sheetArea)
                {
                    var self = this;
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var m = self._getModel(sheetArea);
                    if (m)
                    {
                        var tag = m.getTag(row, col);
                        return staticMembers.tryConvertOADateToDate(tag)
                    }
                    return keyword_null
                };
                Sheet.prototype.tag = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return staticMembers.tryConvertOADateToDate(self._tag)
                    }
                    else
                    {
                        self._tag = staticMembers.tryConvertDateToOADate(value);
                        return self
                    }
                };
                Sheet.prototype.getParent = function()
                {
                    return this.parent
                };
                Sheet.prototype._bindToAutoRefresh = function(fn, context)
                {
                    if (!context)
                    {
                        context = this
                    }
                    return function()
                        {
                            var t = fn.apply(context, arguments);
                            if (!context._paintSuspended)
                            {
                                if (typeof(context.invalidateLayout) === const_function)
                                {
                                    context.invalidateLayout()
                                }
                                if (typeof(context.repaint) === const_function)
                                {
                                    context.repaint()
                                }
                            }
                            return t
                        }
                };
                Sheet.prototype._isValidSheetName = function(sheetName)
                {
                    if (!sheetName || sheetName === "")
                    {
                        return false
                    }
                    var self = this,
                        parent = self.parent;
                    if (!parent)
                    {
                        return true
                    }
                    var length = parent.sheets.length;
                    for (var i = 0; i < length; i++)
                    {
                        var sheet = parent.sheets[i];
                        if (sheet !== self)
                        {
                            if (sheetName === sheet._name)
                            {
                                return false
                            }
                        }
                    }
                    return true
                };
                Sheet.prototype._init = function(name)
                {
                    this._name = name;
                    this._bounds = new Sheets.Rect(0, 0, 0, 0);
                    this.resetImp()
                };
                Sheet.prototype.applyOptions = function(options)
                {
                    if (!options)
                    {
                        return
                    }
                    var self = this,
                        defaults = self.defaults,
                        gridline = self.gridline;
                    if (typeof(options.name) === const_string && options.name.length > 0)
                    {
                        self._name = options.name
                    }
                    if (options.data)
                    {
                        self.setDataSource(options.data)
                    }
                    if (typeof(options.defaultRowHeight) === const_number)
                    {
                        defaults.rowHeight = options.defaultRowHeight
                    }
                    if (typeof(options.defaultColWidth) === const_number)
                    {
                        defaults.colWidth = options.defaultColWidth
                    }
                    if (typeof(options.defaultRowHeaderColWidth) === const_number)
                    {
                        defaults.rowHeaderColWidth = options.defaultRowHeaderColWidth
                    }
                    if (typeof(options.defaultColHeaderRowHeight) === const_number)
                    {
                        defaults.colHeaderRowHeight = options.defaultColHeaderRowHeight
                    }
                    if (typeof(options.rowCount) === const_number)
                    {
                        self.setRowCount(options.rowCount)
                    }
                    if (typeof(options.colCount) === const_number)
                    {
                        self.setColumnCount(options.colCount)
                    }
                    if (typeof(options.frozenRowCount) === const_number)
                    {
                        self.frozenRowCount = options.frozenRowCount
                    }
                    if (typeof(options.frozenColCount) === const_number)
                    {
                        self.frozenColCount = options.frozenColCount
                    }
                    if (typeof(options.frozenTrailingRowCount) === const_number)
                    {
                        self._frozenTrailingRowCount = options.frozenTrailingRowCount
                    }
                    if (typeof(options.frozenTrailingColCount) === const_number)
                    {
                        self._frozenTrailingColCount = options.frozenTrailingColCount
                    }
                    if (options.gridlineColor)
                    {
                        gridline.color = options.gridlineColor
                    }
                    if (typeof(options.showVerticalGridline) === const_boolean)
                    {
                        gridline.showVerticalGridline = options.showVerticalGridline
                    }
                    if (typeof(options.showHorizontalGridline) === const_boolean)
                    {
                        gridline.showHorizontalGridline = options.showHorizontalGridline
                    }
                    if (options.borderColor)
                    {
                        self.borderColor = options.borderColor
                    }
                    if (typeof(options.borderWidth) === const_number)
                    {
                        self.borderWidth = options.borderWidth
                    }
                    if (typeof(options._zoomFactor) === const_number)
                    {
                        self._zoomFactor = options._zoomFactor
                    }
                    if (typeof(options.rowHeaderVisible) === const_boolean)
                    {
                        self.rowHeaderVisible = options.rowHeaderVisible
                    }
                    if (typeof(options.colHeaderVisible) === const_boolean)
                    {
                        self.colHeaderVisible = options.colHeaderVisible
                    }
                    if (typeof(options.autoUpdate) === const_boolean)
                    {
                        self.autoUpdate = options.autoUpdate
                    }
                    if (typeof(options.autoGenerateColumns) === const_boolean)
                    {
                        self.autoGenerateColumns = options.autoGenerateColumns
                    }
                    if (options.rowHeaderAutoText)
                    {
                        self.rowHeaderAutoText = options.rowHeaderAutoText
                    }
                    if (options.colHeaderAutoText)
                    {
                        self.colHeaderAutoText = options.colHeaderAutoText
                    }
                    var activeRowIndex,
                        activeColIndex;
                    if (typeof(options._activeRowIndex) === const_number)
                    {
                        activeRowIndex = options._activeRowIndex
                    }
                    if (typeof(options._activeColIndex) === const_number)
                    {
                        activeColIndex = options._activeColIndex
                    }
                    self._setActiveCellCore(activeRowIndex, activeColIndex);
                    if (typeof(options._allowCellOverflow) === const_boolean)
                    {
                        self._allowCellOverflow = options._allowCellOverflow
                    }
                    if (typeof(options.isProtected) === const_boolean)
                    {
                        self.isProtected = options.isProtected
                    }
                    if (typeof(options.allowUndo) === const_boolean)
                    {
                        self.allowUndo(options.allowUndo)
                    }
                    var columns = options.columns;
                    if (columns && columns.length > 0)
                    {
                        self.autoGenerateColumns = false;
                        self.bindColumns(columns)
                    }
                    var dataContext = options.dataContext;
                    if (dataContext)
                    {
                        var dc = new DataContext(dataContext.read, dataContext.create, dataContext.update, dataContext.remove);
                        self.setDataContext(dc)
                    }
                };
                Sheet.prototype._initDefaultFloatingObjectKeyMap = function()
                {
                    var platform = navigator.platform,
                        isMac = (platform && platform.indexOf("Mac") > -1),
                        ctrl,
                        meta;
                    if (isMac)
                    {
                        ctrl = false;
                        meta = true
                    }
                    else
                    {
                        ctrl = true;
                        meta = false
                    }
                    var self = this;
                    self.addFloatingObjectKeyMap(27, false, false, false, false, Sheets.SpreadActions.unSelectAllFloatingObjects);
                    self.addFloatingObjectKeyMap(46, false, false, false, false, Sheets.SpreadActions.deleteFloatingObject);
                    self.addFloatingObjectKeyMap(9, false, false, false, false, Sheets.SpreadActions.navigationNextFloatingObject);
                    self.addFloatingObjectKeyMap(9, false, true, false, false, Sheets.SpreadActions.navigationPreviousFloatingObject);
                    self.addFloatingObjectKeyMap(88, ctrl, false, false, meta, Sheets.SpreadActions.clipboardCutFloatingObject);
                    self.addFloatingObjectKeyMap(67, ctrl, false, false, meta, Sheets.SpreadActions.clipboardCopyFloatingObject);
                    self.addFloatingObjectKeyMap(86, ctrl, false, false, meta, Sheets.SpreadActions.clipboardPasteFloatingObject);
                    self.addFloatingObjectKeyMap(65, ctrl, false, false, meta, Sheets.SpreadActions.selectAllFloatingObjects);
                    self.addFloatingObjectKeyMap(38, false, false, false, false, Sheets.SpreadActions.moveFloatingObjectUp);
                    self.addFloatingObjectKeyMap(40, false, false, false, false, Sheets.SpreadActions.moveFloatingObjectDown);
                    self.addFloatingObjectKeyMap(37, false, false, false, false, Sheets.SpreadActions.moveFloatingObjectLeft);
                    self.addFloatingObjectKeyMap(39, false, false, false, false, Sheets.SpreadActions.moveFloatingObjectRight)
                };
                Sheet.prototype._initDefaultCommentKeyMap = function()
                {
                    var platform = navigator.platform,
                        isMac = (platform && platform.indexOf("Mac") > -1),
                        ctrl,
                        meta;
                    if (isMac)
                    {
                        ctrl = false;
                        meta = true
                    }
                    else
                    {
                        ctrl = true;
                        meta = false
                    }
                    var self = this;
                    self.addCommentKeyMap(46, false, false, false, false, Sheets.SpreadActions.deleteComment);
                    self.addCommentKeyMap(27, false, false, false, false, Sheets.SpreadActions.deactivateComment);
                    self.addCommentKeyMap(38, false, false, false, false, Sheets.SpreadActions.moveCommentUp);
                    self.addCommentKeyMap(40, false, false, false, false, Sheets.SpreadActions.moveCommentDown);
                    self.addCommentKeyMap(37, false, false, false, false, Sheets.SpreadActions.moveCommentLeft);
                    self.addCommentKeyMap(39, false, false, false, false, Sheets.SpreadActions.moveCommentRight)
                };
                Sheet.prototype._initDefaultKeyMap = function()
                {
                    var platform = navigator.platform,
                        isMac = (platform && platform.indexOf("Mac") > -1),
                        ctrl,
                        meta;
                    if (isMac)
                    {
                        ctrl = false;
                        meta = true
                    }
                    else
                    {
                        ctrl = true;
                        meta = false
                    }
                    var self = this;
                    self.addKeyMap(37, false, false, false, false, Sheets.SpreadActions.navigationLeft);
                    self.addKeyMap(39, false, false, false, false, Sheets.SpreadActions.navigationRight);
                    self.addKeyMap(38, false, false, false, false, Sheets.SpreadActions.navigationUp);
                    self.addKeyMap(40, false, false, false, false, Sheets.SpreadActions.navigationDown);
                    self.addKeyMap(37, ctrl, false, false, meta, Sheets.SpreadActions.navigationHome2);
                    self.addKeyMap(39, ctrl, false, false, meta, Sheets.SpreadActions.navigationEnd2);
                    self.addKeyMap(38, ctrl, false, false, meta, Sheets.SpreadActions.navigationTop);
                    self.addKeyMap(40, ctrl, false, false, meta, Sheets.SpreadActions.navigationBottom);
                    self.addKeyMap(36, false, false, false, false, Sheets.SpreadActions.navigationHome);
                    self.addKeyMap(36, true, false, false, false, Sheets.SpreadActions.navigationFirst);
                    self.addKeyMap(35, false, false, false, false, Sheets.SpreadActions.navigationEnd);
                    self.addKeyMap(35, true, false, false, false, Sheets.SpreadActions.navigationLast);
                    self.addKeyMap(9, false, false, false, false, Sheets.SpreadActions.moveToNextCell);
                    self.addKeyMap(9, false, true, false, false, Sheets.SpreadActions.moveToPreviousCell);
                    self.addKeyMap(33, false, false, false, false, Sheets.SpreadActions.navigationPageUp);
                    self.addKeyMap(34, false, false, false, false, Sheets.SpreadActions.navigationPageDown);
                    self.addKeyMap(33, ctrl, false, false, meta, Sheets.SpreadActions.navigationPreviousSheet);
                    self.addKeyMap(34, ctrl, false, false, meta, Sheets.SpreadActions.navigationNextSheet);
                    self.addKeyMap(46, false, false, false, false, Sheets.SpreadActions.clear);
                    self.addKeyMap(8, false, false, false, false, Sheets.SpreadActions.clearAndEditing);
                    self.addKeyMap(13, false, false, false, false, Sheets.SpreadActions.commitInputNavigationDown);
                    self.addKeyMap(13, false, true, false, false, Sheets.SpreadActions.commitInputNavigationUp);
                    self.addKeyMap(27, false, false, false, false, Sheets.SpreadActions.cancelInput);
                    self.addKeyMap(13, true, true, false, false, Sheets.SpreadActions.commitArrayFormula);
                    self.addKeyMap(37, false, true, false, false, Sheets.SpreadActions.selectionLeft);
                    self.addKeyMap(39, false, true, false, false, Sheets.SpreadActions.selectionRight);
                    self.addKeyMap(38, false, true, false, false, Sheets.SpreadActions.selectionUp);
                    self.addKeyMap(40, false, true, false, false, Sheets.SpreadActions.selectionDown);
                    self.addKeyMap(36, false, true, false, false, Sheets.SpreadActions.selectionHome);
                    self.addKeyMap(35, false, true, false, false, Sheets.SpreadActions.selectionEnd);
                    self.addKeyMap(33, false, true, false, false, Sheets.SpreadActions.selectionPageUp);
                    self.addKeyMap(34, false, true, false, false, Sheets.SpreadActions.selectionPageDown);
                    self.addKeyMap(37, ctrl, true, false, meta, Sheets.SpreadActions.selectionHome);
                    self.addKeyMap(39, ctrl, true, false, meta, Sheets.SpreadActions.selectionEnd);
                    self.addKeyMap(38, ctrl, true, false, meta, Sheets.SpreadActions.selectionTop);
                    self.addKeyMap(40, ctrl, true, false, meta, Sheets.SpreadActions.selectionBottom);
                    self.addKeyMap(36, true, true, false, false, Sheets.SpreadActions.selectionFirst);
                    self.addKeyMap(35, true, true, false, false, Sheets.SpreadActions.selectionLast);
                    self.addKeyMap(67, ctrl, false, false, meta, Sheets.SpreadActions.copy);
                    self.addKeyMap(88, ctrl, false, false, meta, Sheets.SpreadActions.cut);
                    self.addKeyMap(86, ctrl, false, false, meta, Sheets.SpreadActions.paste);
                    self.addKeyMap(90, ctrl, false, false, meta, Sheets.SpreadActions.undo);
                    self.addKeyMap(89, ctrl, false, false, meta, Sheets.SpreadActions.redo)
                };
                Sheet.prototype._setHost = function(host)
                {
                    var isStandardCanvas = Sheets.util._isStandardCanvas();
                    var isSilverlightCanvas = Sheets.util._isSilverlightCanvas();
                    if (!isStandardCanvas && isSilverlightCanvas)
                        return;
                    var self = this,
                        eventHandler = self._eventHandler;
                    var canvas = document.createElement("canvas");
                    Sheets.DPIHelper.adjustDevicePixel(canvas, null, self);
                    canvas.setAttribute("id", host.getAttribute("id") + "_vp");
                    $(canvas).html("You need a browser which full supports HTML5 Canvas to run SpreadJS");
                    host.appendChild(canvas);
                    canvas.gcObject = true;
                    var oldCanvas = self._canvas;
                    if (oldCanvas)
                    {
                        $(oldCanvas).unbind(_mouseDown_gcSheet).unbind(_mouseMove_gcSheet).unbind(_mouseUp_gcSheet).unbind(_mouseOut_gcSheet).unbind(_dblclick_gcSheet).unbind(_mouseWheel_gcSheet);
                        self._unbindTouchEvents();
                        if (oldCanvas.parentNode)
                        {
                            oldCanvas.parentNode.removeChild(oldCanvas)
                        }
                    }
                    self._canvas = canvas;
                    if (Sheets.features.comment)
                    {
                        if (self.parent)
                        {
                            self._commentRender = self.parent._commentRender
                        }
                        else
                        {
                            self._commentRender = new Sheets.CommentRender(self._getContainerDiv())
                        }
                    }
                    canvas.setAttribute('renderMethod', 'auto');
                    var device = Sheets.util.device();
                    var needIgnoreMouseEvent = device.ipad || device.iphone;
                    self._mouseDownDelegate = function(event)
                    {
                        if (needIgnoreMouseEvent)
                        {
                            return
                        }
                        var touchManager = self._touchManager;
                        if (touchManager && touchManager.preProcessMouseDown(event))
                        {
                            Sheets.util.cancelDefault(event);
                            return
                        }
                        return eventHandler.doMouseDown(event)
                    };
                    self._mouseMoveDelegate = function(event)
                    {
                        if (needIgnoreMouseEvent)
                        {
                            return
                        }
                        var touchManager = self._touchManager;
                        if (touchManager && touchManager.preProcessMouseMove(event))
                        {
                            Sheets.util.cancelDefault(event);
                            return
                        }
                        if (eventHandler._isMouseCapture)
                        {
                            return
                        }
                        eventHandler.doMouseMove(event)
                    };
                    self._mouseUpDelegate = function(event)
                    {
                        if (needIgnoreMouseEvent)
                        {
                            return
                        }
                        var touchManager = self._touchManager;
                        if (touchManager && touchManager.preProcessMouseUp(event))
                        {
                            Sheets.util.cancelDefault(event);
                            return
                        }
                        if (!self._continueMouseUpBubble)
                        {
                            if (eventHandler._isMouseCapture)
                            {
                                return
                            }
                            return eventHandler.doMouseUp(event)
                        }
                    };
                    self._mouseOutDelegate = function(event)
                    {
                        if (needIgnoreMouseEvent)
                        {
                            return
                        }
                        return eventHandler.doMouseOut(event)
                    };
                    self._dblClickDelegate = function(event)
                    {
                        if (needIgnoreMouseEvent)
                        {
                            return
                        }
                        var sheet = self,
                            i,
                            selectedRange,
                            action;
                        if (sheet._isTouchMode)
                        {
                            return
                        }
                        var currentTarget = sheet._currentTarget;
                        if (currentTarget)
                        {
                            sheet.triggerCellDoubleClick({
                                sheet: sheet, sheetName: sheet._name, sheetArea: currentTarget.hitTestType, row: currentTarget.row, col: currentTarget.col
                            });
                            var resizeInfo = currentTarget.resizeInfo;
                            if (resizeInfo)
                            {
                                if (resizeInfo.action === "sizeRow")
                                {
                                    var rowList = [];
                                    if (sheet._isRowSelected(resizeInfo.index))
                                    {
                                        for (i = 0; i < sheet._selectionModel.length; i++)
                                        {
                                            selectedRange = sheet._selectionModel[i];
                                            if (selectedRange.col === -1)
                                            {
                                                selectedRange = sheet._getActualRange(selectedRange);
                                                for (var r = 0; r < selectedRange.rowCount; r++)
                                                {
                                                    rowList.push({row: selectedRange.row + r})
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        rowList.push({row: resizeInfo.index})
                                    }
                                    action = new Sheets.UndoRedo.RowAutoFitUndoAction(sheet, rowList, resizeInfo.sheetArea === 1);
                                    sheet._doCommand(action)
                                }
                                else
                                {
                                    var columnList = [];
                                    if (sheet._isColumnSelected(resizeInfo.index))
                                    {
                                        for (i = 0; i < sheet._selectionModel.length; i++)
                                        {
                                            selectedRange = sheet._selectionModel[i];
                                            if (selectedRange.row === -1)
                                            {
                                                selectedRange = sheet._getActualRange(selectedRange);
                                                for (var c = 0; c < selectedRange.colCount; c++)
                                                {
                                                    columnList.push({col: selectedRange.col + c})
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        columnList.push({col: resizeInfo.index})
                                    }
                                    action = new Sheets.UndoRedo.ColumnAutoFitUndoAction(sheet, columnList, resizeInfo.sheetArea === 2);
                                    sheet._doCommand(action)
                                }
                                return
                            }
                        }
                        return eventHandler.startEdit(event)
                    };
                    self._mouseWheelDelegate = function(e)
                    {
                        if (needIgnoreMouseEvent)
                        {
                            return
                        }
                        e = e ? e : window.event;
                        var wheelData = e.detail ? e.detail : e.wheelDelta / -40;
                        eventHandler.doMouseWheel(e, parseInt(wheelData, 10));
                        Sheets.util.cancelDefault(e);
                        return false
                    };
                    $(canvas).bind(_mouseDown_gcSheet, self._mouseDownDelegate).bind(_mouseMove_gcSheet, self._mouseMoveDelegate).bind(_mouseUp_gcSheet, self._mouseUpDelegate).bind(_mouseOut_gcSheet, self._mouseOutDelegate).bind(_dblclick_gcSheet, self._dblClickDelegate).bind(_mouseWheel_gcSheet, self._mouseWheelDelegate);
                    self._bindTouchEvents();
                    self._initializeActiveCell();
                    eventHandler.doResize();
                    if (self.parent)
                    {
                        self.parent._paintSpreadBackgroundImage()
                    }
                };
                Sheet.prototype._unbindTouchEvents = function()
                {
                    if (this._touchManager)
                    {
                        this._touchManager.detach()
                    }
                };
                Sheet.prototype._bindTouchEvents = function()
                {
                    if (!Sheets.features.touch)
                    {
                        return
                    }
                    var self = this,
                        tempSpread = self.parent,
                        provider = (tempSpread && tempSpread._touchEventProvider) ? tempSpread._touchEventProvider : new Sheets.TouchEventProvider;
                    var touchManager = new Sheets.TouchManager(self._canvas, self, provider);
                    touchManager.attach();
                    self._touchManager = touchManager
                };
                Sheet.prototype._disposeValidationUI = function()
                {
                    var self = this;
                    if (self._isDisposingValidationUI)
                    {
                        return false
                    }
                    self._isDisposingValidationUI = true;
                    var validationInputMessage = self._validationInputMessage;
                    if (validationInputMessage)
                    {
                        var p = validationInputMessage.parentNode;
                        if (p)
                        {
                            p.removeChild(validationInputMessage)
                        }
                        self._validationInputMessage = keyword_null
                    }
                    var validationButton = self._validationButton;
                    if (validationButton)
                    {
                        var p = validationButton.parentNode;
                        if (p)
                        {
                            p.removeChild(validationButton)
                        }
                        self._validationButton = keyword_null
                    }
                    var validationSelect = self._validationSelect;
                    if (validationSelect)
                    {
                        var p = validationSelect.parentNode;
                        if (p)
                        {
                            p.removeChild(validationSelect)
                        }
                        self._validationSelect = keyword_null
                    }
                    self._isDisposingValidationUI = false;
                    return true
                };
                Sheet.prototype._disposeFloatingObjectUI = function()
                {
                    var render = this._render,
                        floatingObjectRenderManager = render && render._floatingObjectRenderManager;
                    if (floatingObjectRenderManager)
                    {
                        var i,
                            j,
                            rowCount,
                            colCount;
                        for (i = 0, rowCount = floatingObjectRenderManager.length; i < rowCount; i++)
                        {
                            var rowRenderManagers = floatingObjectRenderManager[i];
                            if (rowRenderManagers)
                            {
                                for (j = 0, colCount = rowRenderManagers.length; j < colCount; j++)
                                {
                                    var renderManager = rowRenderManagers[j];
                                    if (renderManager)
                                    {
                                        renderManager._dispose()
                                    }
                                }
                                rowRenderManagers.length = 0
                            }
                        }
                        floatingObjectRenderManager.length = 0;
                        floatingObjectRenderManager = keyword_null
                    }
                };
                Sheet.prototype._disposeComment = function()
                {
                    var self = this,
                        commentManager = self._commentManager;
                    if (commentManager)
                    {
                        commentManager.hideAllComments()
                    }
                };
                Sheet.prototype._dispose = function(clearCache)
                {
                    var self = this;
                    Sheets.DPIHelper.disposeSheet(self);
                    if (self.isEditing())
                    {
                        self.endEdit()
                    }
                    var canvas = self._canvas;
                    if (canvas)
                    {
                        $(canvas).unbind(_mouseDown_gcSheet).unbind(_mouseMove_gcSheet).unbind(_mouseUp_gcSheet).unbind(_mouseOut_gcSheet).unbind(_dblclick_gcSheet).unbind(_mouseWheel_gcSheet);
                        if (canvas.parentNode)
                        {
                            canvas.parentNode.removeChild(canvas)
                        }
                        self._canvas = keyword_null
                    }
                    $(window).unbind(_resize_gcSheet);
                    Sheets.StyleHelper._disposeMeasureSpan();
                    var eventHandler = self._eventHandler;
                    if (eventHandler)
                    {
                        eventHandler._dispose();
                        eventHandler._disposeFocusHolders()
                    }
                    var filterDialiog = self._filterDialiog;
                    if (filterDialiog)
                    {
                        filterDialiog.close()
                    }
                    var smartTag = self._smartTag;
                    if (smartTag)
                    {
                        smartTag.close()
                    }
                    var editor = self._editor;
                    if (editor)
                    {
                        $(editor).remove()
                    }
                    var cutCopyIndicatorManager = self._cutCopyIndicatorManager;
                    if (cutCopyIndicatorManager)
                    {
                        cutCopyIndicatorManager._dispose()
                    }
                    self._disposeValidationUI();
                    self._disposeFloatingObjectUI();
                    self._disposeComment();
                    self._disposeStringWidthPre();
                    self._disposeStringWidthSpan();
                    if (clearCache !== false)
                    {
                        self.clearCache()
                    }
                };
                Sheet.prototype._disposeStringWidthSpan = function()
                {
                    var span = this._editingSpan;
                    if (span)
                    {
                        $(span).remove();
                        this._editingSpan = keyword_undefined
                    }
                };
                Sheet.prototype._disposeStringWidthPre = function()
                {
                    var pre = this._editingPre;
                    if (pre)
                    {
                        $(pre).remove();
                        this._editingPre = keyword_undefined
                    }
                };
                Sheet.prototype.clearCache = function()
                {
                    var self = this;
                    var cfs = self._conditionalFormats;
                    if (cfs)
                    {
                        cfs.clearCellRuleCache()
                    }
                };
                Sheet.prototype._getModel = function(sheetArea)
                {
                    return this._sheetModelManager.getDataModel(sheetArea)
                };
                Sheet.prototype._getCalcModel = function(sheetArea)
                {
                    if (!this._vpCalcSheetModel && Sheets.util.hasCalc())
                    {
                        this._vpCalcSheetModel = this.getCalcService().getSourceModel(this._vpSheetSource)
                    }
                    return this._vpCalcSheetModel
                };
                Sheet.prototype._getValueImp = function(m, row, col, sheetArea)
                {
                    var self = this;
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var isViewport = (sheetArea === 3);
                    var t = keyword_null,
                        isValueSetted = false;
                    var isTableHeader = false,
                        tm = self._tableManager;
                    if (isViewport && tm && tm._tableList.length > 0)
                    {
                        var table = tm.find(row, col);
                        if (table)
                        {
                            if (table.showHeader() && row === table.headerIndex())
                            {
                                isTableHeader = true;
                                t = table._getHeaderName(col);
                                if (t !== keyword_null && typeof(t) !== const_undefined)
                                {
                                    t = Sheets.util.toString(t)
                                }
                                isValueSetted = true
                            }
                            else if (table.hasBinding())
                            {
                                t = table._getValue(row, col);
                                if (t.hasBinding)
                                {
                                    isValueSetted = true;
                                    t = t.value
                                }
                                else
                                {
                                    t = keyword_null
                                }
                            }
                        }
                    }
                    if (!isValueSetted)
                    {
                        var bm = self._bindingManager,
                            ds = (bm && bm._dataSource);
                        if (ds && isViewport)
                        {
                            var bdValue = bm.getValue(row, col);
                            if (bdValue.hasBinding)
                            {
                                t = bdValue.value
                            }
                            else
                            {
                                t = m.getValue(row, col)
                            }
                        }
                        else
                        {
                            t = m.getValue(row, col)
                        }
                    }
                    t = staticMembers.tryConvertOADateToDate(t);
                    return t
                };
                Sheet.prototype._getSwapIndex = function(array, start, index)
                {
                    var t = array[index - start];
                    while (t.index < index)
                    {
                        t = array[t.index - start]
                    }
                    return t.index
                };
                Sheet.prototype._quickSortImp = function(arr)
                {
                    if (arr.length <= 1)
                    {
                        return arr
                    }
                    var pivotIndex = Math_floor(arr.length / 2);
                    var pivot = arr[pivotIndex];
                    var left = [];
                    var right = [];
                    var equal = [];
                    for (var i = 0; i < arr.length; i++)
                    {
                        var compareResult = this._sortCompare(arr[i], pivot);
                        if (compareResult < 0)
                        {
                            left.push(arr[i])
                        }
                        else if (compareResult > 0)
                        {
                            right.push(arr[i])
                        }
                        else
                        {
                            equal.push(arr[i])
                        }
                    }
                    return this._quickSortImp(left).concat(equal, this._quickSortImp(right))
                };
                Sheet.prototype._quickSort = function(row, column, rowCount, columnCount, byRows, sortInfo)
                {
                    var count = (byRows ? rowCount : columnCount);
                    var array = [];
                    var temp;
                    if (byRows)
                    {
                        for (temp = 0; temp < count; temp++)
                        {
                            array[temp] = {
                                sheet: this, index: row + temp, byRows: byRows, sortInfo: sortInfo
                            }
                        }
                    }
                    else
                    {
                        for (temp = 0; temp < count; temp++)
                        {
                            array[temp] = {
                                sheet: this, index: column + temp, byRows: byRows, sortInfo: sortInfo
                            }
                        }
                    }
                    if (byRows)
                    {
                        var filterOutRows = [];
                        for (var i = array.length - 1; i >= 0; i--)
                        {
                            var item = array[i];
                            if (this.isRowFilterOut(item.index))
                            {
                                array.splice(i, 1);
                                filterOutRows.push({
                                    index: i, value: item
                                })
                            }
                        }
                    }
                    array = this._quickSortImp(array);
                    if (byRows)
                    {
                        for (var i = filterOutRows.length - 1; i >= 0; i--)
                        {
                            var rowItem = filterOutRows[i];
                            array.splice(rowItem.index, 0, rowItem.value)
                        }
                    }
                    return array
                };
                Sheet.prototype._isEquals = function(v1, v2)
                {
                    if (v1 instanceof Date && v2 instanceof Date)
                    {
                        return new Sheets._DateTimeHelper(v1).toOADate() === new Sheets._DateTimeHelper(v2).toOADate()
                    }
                    else
                    {
                        return v1 === v2
                    }
                };
                Sheet.prototype._isGreaterThan = function(v1, v2)
                {
                    if (typeof v1 === "boolean")
                    {
                        v1 = (v1 ? 1 : 0)
                    }
                    else if (v1 instanceof Date)
                    {
                        v1 = new Sheets._DateTimeHelper(v1).toOADate()
                    }
                    if (typeof v2 === "boolean")
                    {
                        v2 = (v2 ? 1 : 0)
                    }
                    else if (v2 instanceof Date)
                    {
                        v2 = new Sheets._DateTimeHelper(v2).toOADate()
                    }
                    if (typeof v1 !== typeof v2 && (typeof v1 === "number" || typeof v2 === "number"))
                    {
                        return (typeof v2 === "number")
                    }
                    return v1 > v2
                };
                Sheet.prototype._sortCompare = function(x, y)
                {
                    if (x.sortInfo && x.sortInfo.length > 0)
                    {
                        var self = this;
                        var ret = 0,
                            value1,
                            value2,
                            value1IsNullOrEmptyOrNaN,
                            value2IsNullOrEmptyOrNaN;
                        for (var i = 0; i < x.sortInfo.length; i++)
                        {
                            if (x.sortInfo[i])
                            {
                                var ascending = x.sortInfo[i].ascending;
                                var index = x.sortInfo[i].index;
                                if (0 <= index)
                                {
                                    if (x.byRows)
                                    {
                                        value1 = x.sheet.getValue(x.index, index);
                                        value2 = y.sheet.getValue(y.index, index);
                                        value1IsNullOrEmptyOrNaN = value1 === keyword_undefined || value1 === keyword_null || value1 === "" || (typeof(value1) === "number" && isNaN(value1));
                                        value2IsNullOrEmptyOrNaN = value2 === keyword_undefined || value2 === keyword_null || value2 === "" || (typeof(value2) === "number" && isNaN(value2));
                                        if (value1IsNullOrEmptyOrNaN || value2IsNullOrEmptyOrNaN)
                                        {
                                            if (value1IsNullOrEmptyOrNaN && value2IsNullOrEmptyOrNaN)
                                            {
                                                ret = 0
                                            }
                                            else if (value1IsNullOrEmptyOrNaN && !value2IsNullOrEmptyOrNaN)
                                            {
                                                ret = 1
                                            }
                                            else if (!value1IsNullOrEmptyOrNaN && value2IsNullOrEmptyOrNaN)
                                            {
                                                ret = -1
                                            }
                                        }
                                        else
                                        {
                                            if (self._isEquals(value1, value2))
                                            {
                                                ret = 0
                                            }
                                            else if (self._isGreaterThan(value1, value2))
                                            {
                                                ret = (ascending ? 1 : -1)
                                            }
                                            else
                                            {
                                                ret = (ascending ? -1 : 1)
                                            }
                                        }
                                    }
                                    else
                                    {
                                        value1 = x.sheet.getValue(index, x.index);
                                        value2 = y.sheet.getValue(index, y.index);
                                        value1IsNullOrEmptyOrNaN = value1 === keyword_undefined || value1 === keyword_null || value1 === "" || (typeof(value1) === "number" && isNaN(value1));
                                        value2IsNullOrEmptyOrNaN = value2 === keyword_undefined || value2 === keyword_null || value2 === "" || (typeof(value2) === "number" && isNaN(value2));
                                        if (value1IsNullOrEmptyOrNaN || value2IsNullOrEmptyOrNaN)
                                        {
                                            if (value1IsNullOrEmptyOrNaN && value2IsNullOrEmptyOrNaN)
                                            {
                                                ret = 0
                                            }
                                            else if (value1IsNullOrEmptyOrNaN && !value2IsNullOrEmptyOrNaN)
                                            {
                                                ret = 1
                                            }
                                            else if (!value1IsNullOrEmptyOrNaN && value2IsNullOrEmptyOrNaN)
                                            {
                                                ret = -1
                                            }
                                        }
                                        else
                                        {
                                            if (self._isEquals(value1, value2))
                                            {
                                                ret = 0
                                            }
                                            else if (self._isGreaterThan(value1, value2))
                                            {
                                                ret = (ascending ? 1 : -1)
                                            }
                                            else
                                            {
                                                ret = (ascending ? -1 : 1)
                                            }
                                        }
                                    }
                                }
                            }
                            if (ret !== 0)
                            {
                                break
                            }
                        }
                        return ret
                    }
                    return 0
                };
                Sheet.prototype._getActualRange = function(range, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var actualRange = new Sheets.Range(-1, -1, -1, -1);
                    if (range === keyword_null || typeof(range) === const_undefined)
                    {
                        return actualRange
                    }
                    actualRange.col = range.col;
                    actualRange.row = range.row;
                    actualRange.colCount = range.colCount;
                    actualRange.rowCount = range.rowCount;
                    if (actualRange.col === -1)
                    {
                        actualRange.col = 0;
                        actualRange.colCount = this.getColumnCount(sheetArea)
                    }
                    if (actualRange.row === -1)
                    {
                        actualRange.row = 0;
                        actualRange.rowCount = this.getRowCount(sheetArea)
                    }
                    return actualRange
                };
                Sheet.prototype._getRangeRect = function(rowViewportIndex, colViewportIndex, range)
                {
                    var rect = new Sheets.Rect(-1, -1, -1, -1),
                        self = this,
                        layout = self._getSheetLayout();
                    if (layout.width === 0 || layout.height === 0)
                    {
                        return rect
                    }
                    var colLayouts = self._getViewportColumnLayout(colViewportIndex),
                        rowLayouts = self._getViewportRowLayout(rowViewportIndex);
                    if (!colLayouts || colLayouts.length === 0 || !rowLayouts || rowLayouts.length === 0)
                    {
                        return rect
                    }
                    var actualRange = self._getActualRange(range),
                        cachePool = self._cachePool,
                        getColsWidth = function(c1, c2)
                        {
                            var width = 0;
                            for (var c = c1; c <= c2; c++)
                            {
                                width += cachePool.getZoomColWidth(c)
                            }
                            return width
                        },
                        getRowsHeight = function(r1, r2)
                        {
                            var height = 0;
                            for (var r = r1; r <= r2; r++)
                            {
                                height += cachePool.getZoomRowHeight(r)
                            }
                            return height
                        };
                    var row1 = actualRange.row,
                        row2 = actualRange.row + actualRange.rowCount - 1,
                        col1 = actualRange.col,
                        col2 = actualRange.col + actualRange.colCount - 1,
                        firstRow = self.frozenRowCount,
                        lastRow = self.getRowCount() - self._frozenTrailingRowCount - 1,
                        firstCol = self.frozenColCount,
                        lastCol = self.getColumnCount() - self._frozenTrailingColCount - 1,
                        vLeftCol = colLayouts[0].col,
                        vRightCol = colLayouts[colLayouts.length - 1].col,
                        vTopRow = rowLayouts[0].row,
                        vBottomRow = rowLayouts[rowLayouts.length - 1].row;
                    var getPrevVisualCol = function(col, endCol)
                        {
                            while (col > endCol)
                            {
                                col--;
                                if (self.getColumnVisible(col))
                                {
                                    return col
                                }
                            }
                            return col
                        };
                    var getNextVisualCol = function(col, endCol)
                        {
                            while (col < endCol)
                            {
                                col++;
                                if (self.getColumnVisible(col))
                                {
                                    return col
                                }
                            }
                            return col
                        };
                    var getPrevVisualRow = function(row, endRow)
                        {
                            while (row > endRow)
                            {
                                row--;
                                if (self.getRowVisible(row))
                                {
                                    return row
                                }
                            }
                            return row
                        };
                    var getNextVisualRow = function(row, endRow)
                        {
                            while (row < endRow)
                            {
                                row++;
                                if (self.getRowVisible(row))
                                {
                                    return row
                                }
                            }
                            return row
                        };
                    if (col1 < vLeftCol)
                    {
                        col1 = getPrevVisualCol(vLeftCol, col1)
                    }
                    if (col2 > vRightCol)
                    {
                        col2 = getNextVisualCol(vRightCol, col2)
                    }
                    if (row1 < vTopRow)
                    {
                        row1 = getPrevVisualRow(vTopRow, row1)
                    }
                    if (row2 > vBottomRow)
                    {
                        row2 = getNextVisualRow(vBottomRow, row2)
                    }
                    if (col2 < col1 || row2 < row1)
                    {
                        return rect
                    }
                    if (colViewportIndex === 0)
                    {
                        if (col1 < firstCol)
                        {
                            rect.x = layout.frozenX + getColsWidth(0, col1 - 1);
                            rect.width = getColsWidth(col1, col2)
                        }
                    }
                    else if (colViewportIndex === 1)
                    {
                        if (col1 <= lastCol && col2 >= firstCol)
                        {
                            if (col1 < vLeftCol)
                            {
                                rect.x = colLayouts[0].x - getColsWidth(col1, vLeftCol - 1)
                            }
                            else
                            {
                                rect.x = colLayouts[0].x + getColsWidth(vLeftCol, col1 - 1)
                            }
                            rect.width = getColsWidth(col1, col2)
                        }
                    }
                    else if (colViewportIndex === 2)
                    {
                        if (col2 > lastCol)
                        {
                            if (col1 < vLeftCol)
                            {
                                rect.x = layout.frozenTrailingX - getColsWidth(col1, vLeftCol - 1)
                            }
                            else
                            {
                                rect.x = layout.frozenTrailingX + getColsWidth(vLeftCol, col1 - 1)
                            }
                            rect.width = getColsWidth(col1, col2)
                        }
                    }
                    if (rowViewportIndex === 0)
                    {
                        if (row1 < firstRow)
                        {
                            rect.y = layout.frozenY + getRowsHeight(0, row1 - 1);
                            rect.height = getRowsHeight(row1, row2)
                        }
                    }
                    else if (rowViewportIndex === 1)
                    {
                        if (row1 <= lastRow && row2 >= firstRow)
                        {
                            if (row1 < vTopRow)
                            {
                                rect.y = rowLayouts[0].y - getRowsHeight(row1, vTopRow - 1)
                            }
                            else
                            {
                                rect.y = rowLayouts[0].y + getRowsHeight(vTopRow, row1 - 1)
                            }
                            rect.height = getRowsHeight(row1, row2)
                        }
                    }
                    else if (rowViewportIndex === 2)
                    {
                        if (row2 > lastRow)
                        {
                            if (row1 < vTopRow)
                            {
                                rect.y = layout.frozenTrailingY - getRowsHeight(row1, vTopRow - 1)
                            }
                            else
                            {
                                rect.y = layout.frozenTrailingY + getRowsHeight(vTopRow, row1 - 1)
                            }
                            rect.height = getRowsHeight(row1, row2)
                        }
                    }
                    return rect
                };
                Sheet.prototype._getRangeRect2 = function(range)
                {
                    var self = this;
                    var rect = new Sheets.Rect(-1, -1, -1, -1),
                        layout = self._getSheetLayout();
                    if (layout.width === 0 || layout.height === 0)
                    {
                        return rect
                    }
                    var actualRange = self._getActualRange(range);
                    var frozenColCount = (isNaN(self.frozenColCount) ? 0 : self.frozenColCount),
                        frozenRowCount = (isNaN(self.frozenRowCount) ? 0 : self.frozenRowCount),
                        frozenTrailingColCount = (isNaN(self._frozenTrailingColCount) ? 0 : self._frozenTrailingColCount),
                        frozenTrailingRowCount = (isNaN(self._frozenTrailingRowCount) ? 0 : self._frozenTrailingRowCount);
                    var cachePool = self._cachePool,
                        getColsWidth = function(col1, col2)
                        {
                            var width = 0;
                            for (var c = col1; c <= col2; c++)
                            {
                                width += cachePool.getZoomColWidth(c)
                            }
                            return width
                        },
                        getRowsHeight = function(row1, row2)
                        {
                            var height = 0;
                            for (var r = row1; r <= row2; r++)
                            {
                                height += cachePool.getZoomRowHeight(r)
                            }
                            return height
                        };
                    var row1 = actualRange.row,
                        row2 = actualRange.row + actualRange.rowCount - 1,
                        col1 = actualRange.col,
                        col2 = actualRange.col + actualRange.colCount - 1,
                        rowCount = self.getRowCount(),
                        colCount = self.getColumnCount(),
                        colLayout,
                        rowLayout;
                    if (col1 < frozenColCount)
                    {
                        rect.x = layout.frozenX + getColsWidth(0, col1 - 1);
                        rect.width = getColsWidth(col1, Math_min(col2, frozenColCount - 1));
                        if (frozenColCount <= col2 && col2 < colCount - frozenTrailingColCount)
                        {
                            colLayout = self._getViewportColumnLayout(1);
                            if (colLayout && colLayout.length > 0)
                            {
                                rect.width += getColsWidth(colLayout[0].col, Math_min(col2, colLayout[colLayout.length - 1].col))
                            }
                        }
                        else if (col2 >= colCount - frozenTrailingColCount)
                        {
                            colLayout = self._getViewportColumnLayout(2);
                            if (colLayout && colLayout.length > 0)
                            {
                                rect.width = colLayout[0].x - rect.x;
                                rect.width += getColsWidth(colCount - frozenTrailingColCount, Math_min(col2, colCount - 1))
                            }
                        }
                    }
                    else if (col1 < colCount - frozenTrailingColCount)
                    {
                        colLayout = self._getViewportColumnLayout(1);
                        if (!colLayout || colLayout.length === 0 || col1 > colLayout[colLayout.length - 1].col || col2 < colLayout[0].col)
                        {
                            return rect
                        }
                        rect.x = layout.viewportX + getColsWidth(colLayout[0].col, col1 - 1);
                        if (frozenColCount <= col2 && col2 < colCount - frozenTrailingColCount)
                        {
                            rect.width = getColsWidth(Math_max(col1, colLayout[0].col), Math_min(col2, colLayout[colLayout.length - 1].col))
                        }
                        else if (col2 >= colCount - frozenTrailingColCount)
                        {
                            colLayout = self._getViewportColumnLayout(2);
                            if (colLayout && colLayout.length > 0)
                            {
                                rect.width = colLayout[0].x - rect.x;
                                rect.width += getColsWidth(colCount - frozenTrailingColCount, Math_min(col2, colCount - 1))
                            }
                        }
                    }
                    else if (col1 < colCount)
                    {
                        colLayout = self._getViewportColumnLayout(2);
                        if (colLayout && colLayout.length > 0)
                        {
                            rect.x = layout.frozenTrailingX + getColsWidth(colLayout[0].col, col1 - 1);
                            rect.width = getColsWidth(col1, Math_min(col2, colCount - 1))
                        }
                    }
                    if (row1 < frozenRowCount)
                    {
                        rect.y = layout.frozenY + getRowsHeight(0, row1 - 1);
                        rect.height = getRowsHeight(row1, Math_min(row2, frozenRowCount - 1));
                        if (frozenRowCount <= row2 && row2 < rowCount - frozenTrailingRowCount)
                        {
                            rowLayout = self._getViewportRowLayout(1);
                            if (rowLayout && rowLayout.length > 0)
                            {
                                rect.height += getRowsHeight(rowLayout[0].row, Math_min(row2, rowLayout[rowLayout.length - 1].row))
                            }
                        }
                        else if (row2 >= rowCount - frozenTrailingRowCount)
                        {
                            rowLayout = self._getViewportRowLayout(2);
                            if (rowLayout && rowLayout.length > 0)
                            {
                                rect.height = rowLayout[0].y - rect.y;
                                rect.height += getRowsHeight(rowCount - frozenTrailingRowCount, Math_min(row2, rowCount - 1))
                            }
                        }
                    }
                    else if (row1 < rowCount - frozenTrailingRowCount)
                    {
                        rowLayout = self._getViewportRowLayout(1);
                        if (!rowLayout || rowLayout.length === 0 || row1 > rowLayout[rowLayout.length - 1].row || row2 < rowLayout[0].row)
                        {
                            return rect
                        }
                        rect.y = layout.viewportY + getRowsHeight(rowLayout[0].row, row1 - 1);
                        if (frozenRowCount <= row2 && row2 < rowCount - frozenTrailingRowCount)
                        {
                            rect.height = getRowsHeight(Math_max(row1, rowLayout[0].row), Math_min(row2, rowLayout[rowLayout.length - 1].row))
                        }
                        else if (row2 >= rowCount - frozenTrailingRowCount)
                        {
                            rowLayout = self._getViewportRowLayout(2);
                            if (rowLayout && rowLayout.length > 0)
                            {
                                rect.height = rowLayout[0].y - rect.y;
                                rect.height += getRowsHeight(rowCount - frozenTrailingRowCount, Math_min(row2, rowCount - 1))
                            }
                        }
                    }
                    else if (row1 < rowCount)
                    {
                        rowLayout = self._getViewportRowLayout(2);
                        if (rowLayout && rowLayout.length > 0)
                        {
                            rect.y = layout.frozenTrailingY + getRowsHeight(rowLayout[0].row, row1 - 1);
                            rect.height += getRowsHeight(row1, Math_min(row2, rowCount - 1))
                        }
                    }
                    return rect
                };
                Sheet.prototype._getCanvas = function()
                {
                    var c = this._canvas;
                    if (!c && this.parent)
                    {
                        c = this.parent.canvas
                    }
                    if (c && !c.getContext && c.firstChild)
                    {
                        c.getContext = c.firstChild.getContext
                    }
                    return c
                };
                Sheet.prototype._getStringWidth = function(value, font)
                {
                    return this._getStringWidthByCanvas(value, font) + 1
                };
                Sheet.prototype._getStringWidthByCanvas = function(value, font)
                {
                    var currentFont = "",
                        render = this._render;
                    if (font)
                    {
                        currentFont = font
                    }
                    else
                    {
                        currentFont = render._getZoomFont(render._getDefaultFont())
                    }
                    return Sheets._WordWrapHelper._measureText(value, currentFont)
                };
                Sheet.prototype._getFontHeight = function(font, ignoreCache)
                {
                    var self = this;
                    var cache = self.fontHeightCache;
                    if (!ignoreCache)
                    {
                        if (cache)
                        {
                            var h = cache[font];
                            if (h)
                            {
                                return h
                            }
                        }
                        else
                        {
                            cache = self.fontHeightCache = {}
                        }
                    }
                    var htmlSpan = self._getEditingSpan();
                    if (font)
                    {
                        htmlSpan.style.font = font
                    }
                    else
                    {
                        htmlSpan.style.font = self._render._getDefaultFont()
                    }
                    htmlSpan.innerHTML = "H";
                    var fontHeight = htmlSpan.offsetHeight;
                    if (!ignoreCache)
                    {
                        cache[font] = fontHeight
                    }
                    return fontHeight
                };
                Sheet.prototype._getEditingSpan = function()
                {
                    if (!this._editingSpan)
                    {
                        var span = document.createElement("span"),
                            spanStyle = span.style;
                        spanStyle.visibility = _cssHidden;
                        spanStyle.top = "-10000px";
                        spanStyle.left = "-10000px";
                        spanStyle.position = "absolute";
                        span.className = "gcStringWidthSpanStyle";
                        span.setAttribute("gcUIElement", "gcStringWidthSpan");
                        document.body.insertBefore(span, keyword_null);
                        this._editingSpan = span
                    }
                    return this._editingSpan
                };
                Sheet.prototype._getColumnViewportIndexFromX = function(x)
                {
                    var layout = this._getSheetLayout();
                    var colViewportIndex = keyword_null;
                    if (layout.headerX < x && x < layout.headerX + layout.rowHeaderWidth)
                    {
                        colViewportIndex = -1
                    }
                    else if (layout.frozenX < x && x < layout.frozenX + layout.frozenWidth)
                    {
                        colViewportIndex = 0
                    }
                    else if (layout.viewportX < x && x < layout.viewportX + layout.viewportWidth)
                    {
                        colViewportIndex = 1
                    }
                    else if (layout.frozenTrailingX < x && x < layout.frozenTrailingX + layout.frozenTrailingWidth)
                    {
                        colViewportIndex = 2
                    }
                    return colViewportIndex
                };
                Sheet.prototype._getRowViewportIndexFromY = function(y)
                {
                    var layout = this._getSheetLayout();
                    var rowViewportIndex = keyword_null;
                    if (layout.headerY < y && y < layout.headerY + layout.colHeaderHeight)
                    {
                        rowViewportIndex = -1
                    }
                    else if (layout.frozenY < y && y < layout.frozenY + layout.frozenHeight)
                    {
                        rowViewportIndex = 0
                    }
                    else if (layout.viewportY < y && y < layout.viewportY + layout.viewportHeight)
                    {
                        rowViewportIndex = 1
                    }
                    else if (layout.frozenTrailingY < y && y < layout.frozenTrailingY + layout.frozenTrailingHeight)
                    {
                        rowViewportIndex = 2
                    }
                    return rowViewportIndex
                };
                Sheet.prototype._getRowIndexFromY = function(y, rowViewportIndex)
                {
                    var rowLayouts = keyword_null;
                    if (rowViewportIndex === -1)
                    {
                        rowLayouts = this._getColumnHeaderRowLayout()
                    }
                    else
                    {
                        rowLayouts = this._getViewportRowLayout(rowViewportIndex)
                    }
                    if (rowLayouts)
                    {
                        var rowLayout = rowLayouts.findY(y);
                        if (rowLayout)
                        {
                            return rowLayout.row
                        }
                    }
                };
                Sheet.prototype._getColumnIndexFromX = function(x, colViewportIndex)
                {
                    var colLayouts = keyword_null;
                    if (colViewportIndex === -1)
                    {
                        colLayouts = this._getRowHeaderColumnLayout()
                    }
                    else
                    {
                        colLayouts = this._getViewportColumnLayout(colViewportIndex)
                    }
                    if (colLayouts)
                    {
                        var colLayout = colLayouts.findX(x);
                        if (colLayout)
                        {
                            return colLayout.col
                        }
                    }
                };
                Sheet.prototype._isActiveCell = function(r, c)
                {
                    var self = this;
                    return (self._activeRowIndex <= r && r < self._activeRowIndex + self._activeRowCount && self._activeColIndex <= c && c < self._activeColIndex + self._activeColCount)
                };
                Sheet.prototype._isColumnSelected = function(c)
                {
                    for (var i = 0; i < this._selectionModel.length; i++)
                    {
                        var selectedRange = this._selectionModel[i];
                        var col = (selectedRange.col === -1) ? 0 : selectedRange.col;
                        if (selectedRange.row === -1 && c >= col && c < col + selectedRange.colCount)
                        {
                            return true
                        }
                    }
                    return false
                };
                Sheet.prototype._isRowSelected = function(r)
                {
                    for (var i = 0; i < this._selectionModel.length; i++)
                    {
                        var selectedRange = this._selectionModel[i];
                        var row = (selectedRange.row === -1) ? 0 : selectedRange.row;
                        if (selectedRange.col === -1 && r >= row && r < row + selectedRange.rowCount)
                        {
                            return true
                        }
                    }
                    return false
                };
                Sheet.prototype._isSelected = function(r, c, sheetArea)
                {
                    var selected = false;
                    var selectionModel = this._selectionModel;
                    for (var i = 0, count = selectionModel.length; i < count; i++)
                    {
                        var cr = selectionModel[i];
                        var selectedRange = this._getActualRange(cr);
                        if (sheetArea === 3 || typeof(sheetArea) === const_undefined || sheetArea === keyword_null)
                        {
                            selected = (selectedRange.row <= r && r < selectedRange.row + selectedRange.rowCount && selectedRange.col <= c && c < selectedRange.col + selectedRange.colCount)
                        }
                        else if (sheetArea === 2)
                        {
                            selected = (selectedRange.row <= r && r < selectedRange.row + selectedRange.rowCount)
                        }
                        else if (sheetArea === 1)
                        {
                            selected = (selectedRange.col <= c && c < selectedRange.col + selectedRange.colCount)
                        }
                        else if (sheetArea === 0)
                        {
                            selected = (cr.row === -1 && cr.col === -1)
                        }
                        if (selected)
                        {
                            return selected
                        }
                    }
                    return selected
                };
                Sheet.prototype._isAllSelected = function(r, c, sheetArea)
                {
                    var self = this;
                    var selected = false;
                    var sheetRowCount = self.getRowCount();
                    var sheetColCount = self.getColumnCount();
                    for (var i = 0; i < self._selectionModel.length; i++)
                    {
                        var selectedRange = self._selectionModel[i];
                        if (sheetArea !== keyword_undefined && sheetArea !== keyword_null && sheetArea !== 3)
                        {
                            if (sheetArea === 2)
                            {
                                var row = (selectedRange.row === -1) ? 0 : selectedRange.row;
                                selected = (selectedRange.col === -1 && r >= row && r < row + selectedRange.rowCount)
                            }
                            else if (sheetArea === 1)
                            {
                                var col = (selectedRange.col === -1) ? 0 : selectedRange.col;
                                selected = (selectedRange.row === -1 && c >= col && c < col + selectedRange.colCount)
                            }
                            else if (sheetArea === 0)
                            {
                                selected = (selectedRange.row === -1 && selectedRange.col === -1 && selectedRange.rowCount === sheetRowCount && selectedRange.colCount === sheetColCount)
                            }
                        }
                        if (selected)
                        {
                            return selected
                        }
                    }
                    return selected
                };
                Sheet.prototype._isHover = function(r, c, sheetArea)
                {
                    var ishover = false;
                    var target = this._currentTarget;
                    if (target && !target.resizeInfo && typeof(sheetArea) !== const_undefined && sheetArea !== keyword_null)
                    {
                        if (sheetArea === 1)
                        {
                            var inSpans = false,
                                span = this._getSpanModel(1).find(target.row, target.col);
                            if (span)
                            {
                                inSpans = span.contains(r, c, 1, 1)
                            }
                            var hovered = (r === target.row && c === target.col) || (inSpans);
                            return (target.hitTestType === sheetArea && hovered)
                        }
                        else if (sheetArea === 2)
                        {
                            var inSpans = false,
                                span = this._getSpanModel(2).find(target.row, target.col);
                            if (span)
                            {
                                inSpans = span.contains(r, c, 1, 1)
                            }
                            var hovered = (r === target.row && c === target.col) || (inSpans);
                            return (target.hitTestType === sheetArea && hovered)
                        }
                        else if (sheetArea === 3)
                        {
                            return (target.hitTestType === sheetArea && r === target.row && c === target.col)
                        }
                        else if (sheetArea === 0)
                        {
                            return (target.hitTestType === sheetArea)
                        }
                    }
                    return ishover
                };
                Sheet.prototype._indexToLetters = function(index)
                {
                    var t = "A";
                    var aCode = t.charCodeAt(0);
                    var sb = "";
                    for (; index > 0; index = (index - 1) / 26)
                    {
                        var n = parseInt(((index - 1) % 26), 10);
                        if (index === 1 || (n >= 0 && index > 1))
                        {
                            sb = String.fromCharCode(aCode + n) + sb
                        }
                    }
                    return sb
                };
                Sheet.prototype._doStartEdit = function(canvas, x, y)
                {
                    var self = this;
                    var target = self.hitTest(x, y);
                    if (!target)
                    {
                        return
                    }
                    var row = target.row,
                        col = target.col;
                    if (row >= 0 && col >= 0 && target.rowViewportIndex >= 0 && target.colViewportIndex >= 0 && !target.resizeInfo && !target.dragInfo && row === self._activeRowIndex && col === self._activeColIndex)
                    {
                        var isEditing = self.isEditing();
                        self._startEditImp(canvas, row, col);
                        if (!isEditing && self.isEditing())
                        {
                            var sheetArea = target.hitTestType;
                            var ct = self.getCellType(row, col);
                            if (ct._triggerButtonClicked)
                            {
                                var rowViewportIndex = sheetArea === 1 ? -1 : keyword_undefined,
                                    colViewportIndex = sheetArea === 2 ? -1 : keyword_undefined;
                                var cellRect = self.getCellRect(row, col, rowViewportIndex, colViewportIndex);
                                var cellStyle = self.getActualStyle(row, col, sheetArea);
                                var context = {
                                        sheet: self, row: row, col: col, sheetArea: sheetArea
                                    };
                                var info = ct.getHitInfo(x, y, cellStyle, cellRect, context);
                                if (info && info.isReservedLocation)
                                {
                                    ct._triggerButtonClicked(self, row, col, 3)
                                }
                            }
                        }
                    }
                };
                Sheet.prototype._getSheetArea = function(rowViewportIndex, colViewportIndex)
                {
                    if (rowViewportIndex >= 0 && rowViewportIndex <= 2 && colViewportIndex >= 0)
                    {
                        return 3
                    }
                    else if (rowViewportIndex >= 0 && rowViewportIndex <= 2 && colViewportIndex < 0)
                    {
                        return 2
                    }
                    else if (rowViewportIndex < 0 && colViewportIndex >= 0)
                    {
                        return 1
                    }
                    else if (rowViewportIndex < 0 && colViewportIndex < 0)
                    {
                        return 0
                    }
                    return keyword_null
                };
                Sheet.prototype.setFocus = function()
                {
                    var eventHandler = this._eventHandler;
                    if (eventHandler)
                    {
                        eventHandler.setFocus()
                    }
                };
                Sheet.prototype._getHost = function()
                {
                    var self = this,
                        host;
                    var parentSpread = self.parent;
                    host = parentSpread && parentSpread._host;
                    if (!host)
                    {
                        var sheetCanvas = self._canvas;
                        host = sheetCanvas && sheetCanvas.parentElement
                    }
                    return host
                };
                Sheet.prototype._startEditImp = function(canvas, row, col, rowViewportIndex, colViewportIndex, selectAll, defaultText)
                {
                    if (row < 0 || col < 0)
                    {
                        return
                    }
                    var self = this;
                    if (self.isEditing())
                    {
                        return
                    }
                    var eventHandler = self._eventHandler;
                    if (eventHandler)
                    {
                        eventHandler.setFocus()
                    }
                    var r = row;
                    var c = col;
                    var cellRect = self.getCellRect(r, c);
                    if (!cellRect || cellRect.width <= 0 || cellRect.height <= 0)
                    {
                        return
                    }
                    self.showCell(self._activeRowIndex, self._activeColIndex, 3, 3);
                    var cellStyle = self.getActualStyle(row, col);
                    if (self.isProtected && cellStyle.locked !== false)
                    {
                        return
                    }
                    var ct = self.getCellType(r, c);
                    if (!ct)
                    {
                        return
                    }
                    var editor;
                    var context = {
                            sheet: self, row: row, col: col, sheetArea: 3
                        };
                    if (ct.isImeAware(context))
                    {
                        if (eventHandler)
                        {
                            editor = eventHandler._cellTypeFocusHolder
                        }
                    }
                    else
                    {
                        editor = ct.createEditorElement(context)
                    }
                    if (!editor)
                    {
                        return
                    }
                    self._editor = editor;
                    var args = {
                            sheet: self, sheetName: self._name, row: r, col: c, cancel: false
                        };
                    self.triggerEditStarting(args);
                    if (args && args.cancel === true)
                    {
                        return
                    }
                    var v = self.getValue(r, c),
                        f = self.getFormula(r, c);
                    var oldStatus = self._editorStatus;
                    if (self._startEditByKeydown)
                    {
                        self._editorStatus = 1
                    }
                    else
                    {
                        if ((v === keyword_null || v === keyword_undefined) && (f === keyword_null || f === keyword_undefined))
                        {
                            self._editorStatus = 1
                        }
                        else
                        {
                            self._editorStatus = 2
                        }
                    }
                    self.triggerEditorStatusChanged({
                        sheet: self, sheetName: self._name, oldStatus: oldStatus, newStatus: self._editorStatus
                    });
                    var sheetLayout = self._getSheetLayout();
                    var cellRect = self.getCellRect(r, c, rowViewportIndex, colViewportIndex);
                    if (ct.isImeAware(context))
                    {
                        eventHandler._resetFocusHolder()
                    }
                    ct.activateEditor(self._editor, cellStyle, cellRect, context);
                    self._setEditorValue(ct, self._editor, r, c, cellStyle, defaultText);
                    var colHeader = 1,
                        rowHeader = 2;
                    var host = self._getHost();
                    if (self.showEditingLocator)
                    {
                        var locator = ct._getLocator();
                        editor._editingLocator = locator;
                        var colHeaderText = this.getValue(this._sheetModelManager.getDataModel(colHeader).getRowCount() - 1, col, colHeader);
                        var rowHeaderText = this.getValue(row, this._sheetModelManager.getDataModel(rowHeader).getColumnCount() - 1, rowHeader);
                        locator.innerHTML = colHeaderText + "" + rowHeaderText;
                        ct._updateEditorLocator(self._editor, context);
                        host.insertBefore(locator, keyword_null)
                    }
                    if (!ct.isImeAware(context))
                    {
                        host.insertBefore(self._editor, keyword_null)
                    }
                    ct.updateEditor(self._editor, cellStyle, cellRect, context);
                    if (!ct.isImeAware(context) || !selectAll)
                    {
                        ct.focus(self._editor, context)
                    }
                    if (selectAll)
                    {
                        ct.selectAll(self._editor, context)
                    }
                    if (self._allowCellOverflow)
                    {
                        var crect = self.getCellRect(row, col, rowViewportIndex, colViewportIndex);
                        crect.x -= 2;
                        crect.y -= 2;
                        crect.width += 4;
                        crect.height += 4;
                        crect.x = sheetLayout.frozenX;
                        crect.width = sheetLayout.viewportWidth;
                        self.repaint(crect)
                    }
                    self._render.refreshTouchSelectionIndicator();
                    self._attachFormulaTextBox(ct.getEditingElement());
                    Sheets.FocusHelper.setActiveElement(self);
                    self.triggerEditStarted({
                        sheet: self, sheetName: self._name, row: r, col: c
                    })
                };
                Sheet.prototype._setEditorValue = function(ct, editor, r, c, cellStyle, defaultText)
                {
                    var self = this;
                    var t = self.getFormula(r, c);
                    if (t)
                    {
                        t = "=" + t
                    }
                    var actualValue = t;
                    var context = {
                            sheet: self, row: r, col: c, sheetArea: 3
                        };
                    if (!t || t.length === 0)
                    {
                        t = self.getValue(r, c);
                        var canUserEditFormula = self.parent ? self.parent.canUserEditFormula() : true;
                        if (t && t.length > 0 && (/^=/ig).test(t) && canUserEditFormula)
                        {
                            t = "'" + t
                        }
                        actualValue = t;
                        t = ct._formatEditorValue(editor, cellStyle, t, context)
                    }
                    editor._oldValue = t;
                    if (defaultText !== keyword_null && defaultText !== keyword_undefined)
                    {
                        t = defaultText
                    }
                    ct.setEditorValue(editor, t, context);
                    editor._originalValue = actualValue
                };
                Sheet.prototype._attachFormulaTextBox = function(editingElement)
                {
                    var self = this;
                    if (!Sheets.features.formulatextbox || !editingElement || (self.parent && !self.parent.canUserEditFormula()) || !self._enableFormulaTextbox)
                    {
                        return
                    }
                    if (self._formulaTextBox)
                    {
                        self._formulaTextBox.destroy()
                    }
                    self._formulaTextBox = new Sheets.FormulaTextBox(editingElement, self.parent);
                    var text = self._formulaTextBox.text();
                    var formulaInfo = self.getFormulaInformation(self._activeRowIndex, self._activeColIndex);
                    if (!formulaInfo || !formulaInfo.hasFormula)
                    {
                        if (text[0] === "=")
                        {
                            text = "'" + text;
                            self._formulaTextBox.text(text)
                        }
                    }
                    var fbx = self._formulaTextBox,
                        eventHandler = self._eventHandler,
                        render = self._render;
                    fbx.bind("AppendStarted", function(e)
                    {
                        fbx.close();
                        var EditorStatus = GcSpread.Sheets.EditorStatus,
                            oldStatus = self._editorStatus;
                        if (oldStatus !== 1)
                        {
                            self._editorStatus = 1;
                            self.triggerEditorStatusChanged({
                                sheet: self, sheetName: self._name, oldStatus: oldStatus, newStatus: 1
                            })
                        }
                    });
                    fbx.bind("AppendEnded", function(e)
                    {
                        render.paintFormulaTextBox()
                    });
                    fbx.bind("TextChanged", function(e, eData)
                    {
                        if (eData && eData.type !== "input")
                        {
                            eventHandler.updateEditingEditor(eData);
                            var activeRow = self._activeRowIndex,
                                activeCol = self._activeColIndex,
                                ct = self.getCellType(activeRow, activeCol);
                            self.triggerEditChange({
                                sheet: self, sheetName: self._name, row: activeRow, col: activeCol, editingText: ct.getEditorValue(self._editor)
                            })
                        }
                        render.paintFormulaTextBox();
                        self.triggerFormulaTextBoxTextChanged({
                            sheet: self, sheetName: self._name, text: fbx.text()
                        })
                    });
                    fbx.bind("CaretChanged", function()
                    {
                        render.paintFormulaTextBox();
                        self.triggerFormulaTextBoxCaretChanged({
                            sheet: self, sheetName: self._name, caret: fbx.caret()
                        })
                    });
                    fbx.add(Sheets.SR.getHelpFuncs());
                    var fnds = this._functionDescriptions;
                    if (fnds && fnds.length > 0)
                    {
                        fbx.add(fnds)
                    }
                    fnds = (this.parent && this.parent._functionDescriptions);
                    if (fnds && fnds.length > 0)
                    {
                        fbx.add(fnds)
                    }
                    render.paintFormulaTextBox()
                };
                Sheet.prototype._detachFormulaTextBox = function()
                {
                    var self = this;
                    if (self._formulaTextBox)
                    {
                        self._formulaTextBox.destroy();
                        self._formulaTextBox = keyword_null;
                        self._render.paintFormulaTextBox()
                    }
                };
                Sheet.prototype._showEditingLocator = function()
                {
                    var self = this;
                    if (self.isEditing() === false)
                    {
                        return
                    }
                    var editor = self._editor,
                        editorLocator = editor && editor._editingLocator;
                    if (editorLocator)
                    {
                        var $editor = $(editor);
                        var x = parseInt($editor.css(_cssLeft), 10) + self.getColumnWidth(self._activeColIndex) / 2,
                            y = parseInt($editor.css(_cssTop), 10) + self.getRowHeight(self._activeRowIndex) / 2;
                        var t = $(self._getCanvas()).offset();
                        x -= t.left;
                        y -= t.top;
                        var row = self._getRowIndexFromY(y, self._getRowViewportIndexFromY(y));
                        var col = self._getColumnIndexFromX(x, self._getColumnViewportIndexFromX(x));
                        if (row === self._activeRowIndex && col === self._activeColIndex)
                        {
                            $(editorLocator).css(cssVisibility, _cssHidden)
                        }
                        else
                        {
                            $(editorLocator).css(cssVisibility, "visible")
                        }
                    }
                };
                Sheet.prototype._getKeyAction = function(keyCode, ctrl, shift, alt, meta)
                {
                    var keyMap = this.keyMap;
                    if (!keyMap)
                    {
                        return keyword_null
                    }
                    var n = keyMap.length,
                        ka;
                    for (var i = 0; i < n; i++)
                    {
                        ka = keyMap[i];
                        if (ka && ka.key === keyCode && ka.ctrl === ctrl && ka.shift === shift && ka.alt === alt && ka.meta === meta)
                        {
                            return ka
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._getFloatingObjectKeyAction = function(keyCode, ctrl, shift, alt, meta)
                {
                    var foKeyMap = this.floatingObjectKeyMap;
                    if (!foKeyMap)
                    {
                        return keyword_null
                    }
                    var n = foKeyMap.length,
                        ka;
                    for (var i = 0; i < n; i++)
                    {
                        ka = foKeyMap[i];
                        if (ka && ka.key === keyCode && ka.ctrl === ctrl && ka.shift === shift && ka.alt === alt && ka.meta === meta)
                        {
                            return ka
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._getCommentKeyAction = function(keyCode, ctrl, shift, alt, meta)
                {
                    if (!this._commentKeyMap)
                    {
                        return keyword_null
                    }
                    var ka;
                    for (var i = 0; i < this._commentKeyMap.length; i++)
                    {
                        ka = this._commentKeyMap[i];
                        if (ka && ka.key === keyCode && ka.ctrl === ctrl && ka.shift === shift && ka.alt === alt && ka.meta === meta)
                        {
                            return ka
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._moveActiveCellUp = function(row, col, wrap)
                {
                    var self = this;
                    var upCell = self._getMoveUpCell(row, col, wrap, self._leadingCellCol || 0);
                    if (upCell)
                    {
                        var r = upCell.row,
                            c = upCell.col,
                            leadingCellCol = upCell.leadingCellCol;
                        if (self._canMoveCurrentTo(r, c))
                        {
                            self._leadingCellRow = r;
                            self._leadingCellCol = leadingCellCol;
                            self._setActiveCellCore(r, c)
                        }
                    }
                };
                Sheet.prototype._getMoveUpCell = function(row, col, wrap, leadingCellCol)
                {
                    var r = row,
                        c = col;
                    if (r === 0 && !wrap)
                    {
                        return keyword_null
                    }
                    var self = this;
                    var rowCount = self.getRowCount();
                    var colCount = self.getColumnCount();
                    var cell = self._getPrevRow(r, leadingCellCol);
                    if (!wrap)
                    {
                        self._adjustCell(cell)
                    }
                    r = cell.r;
                    c = cell.c;
                    if (r < 0 && wrap)
                    {
                        c = self._getPrevVisualColumn(c);
                        if (c < 0 || c === keyword_undefined || c === keyword_null)
                        {
                            c = self._getPrevVisualColumn(colCount)
                        }
                        leadingCellCol = c;
                        cell = self._getPrevRow(rowCount, c);
                        r = cell.r;
                        c = cell.c;
                        if (c === col && r <= row)
                        {
                            return keyword_null
                        }
                    }
                    return {
                            row: r, col: c, leadingCellCol: leadingCellCol
                        }
                };
                Sheet.prototype._moveActiveCellDown = function(row, col, wrap)
                {
                    var self = this;
                    var downCell = self._getMoveDownCell(row, col, wrap, self._leadingCellCol || 0);
                    if (downCell)
                    {
                        var r = downCell.row,
                            c = downCell.col,
                            leadingCellCol = downCell.leadingCellCol;
                        if (self._canMoveCurrentTo(r, c))
                        {
                            self._leadingCellRow = r;
                            self._leadingCellCol = leadingCellCol;
                            self._setActiveCellCore(r, c)
                        }
                    }
                };
                Sheet.prototype._getMoveDownCell = function(row, col, wrap, leadingCellCol)
                {
                    var self = this;
                    var rowCount = self.getRowCount();
                    var colCount = self.getColumnCount();
                    var r = row,
                        c = col;
                    if (r === rowCount - 1 && !wrap)
                    {
                        return
                    }
                    var cell = self._getNextRow(r, leadingCellCol);
                    if (!wrap)
                    {
                        self._adjustCell(cell)
                    }
                    r = cell.r;
                    c = cell.c;
                    if (r === rowCount && wrap)
                    {
                        c = self._getNextVisualColumn(c);
                        if (c >= colCount || c === keyword_undefined || c === keyword_null)
                        {
                            c = self._getNextVisualColumn(-1)
                        }
                        leadingCellCol = c;
                        cell = self._getNextRow(-1, c);
                        r = cell.r;
                        c = cell.c;
                        if (c === col && r >= row)
                        {
                            return
                        }
                    }
                    return {
                            row: r, col: c, leadingCellCol: leadingCellCol
                        }
                };
                Sheet.prototype._moveActiveCellLeft = function(row, col, wrap)
                {
                    var self = this;
                    var leftCell = self._getMoveLeftCell(row, col, wrap, self._leadingCellRow || 0);
                    if (leftCell)
                    {
                        var r = leftCell.row,
                            c = leftCell.col,
                            leadingCellRow = leftCell.leadingCellRow;
                        if (self._canMoveCurrentTo(r, c))
                        {
                            self._leadingCellRow = leadingCellRow;
                            self._leadingCellCol = c;
                            self._setActiveCellCore(r, c)
                        }
                    }
                };
                Sheet.prototype._getMoveLeftCell = function(row, col, wrap, leadingCellRow)
                {
                    var r = row,
                        c = col;
                    if (c === 0 && !wrap)
                    {
                        return keyword_null
                    }
                    var self = this;
                    var rowCount = self.getRowCount();
                    var colCount = self.getColumnCount();
                    var cell = self._getPrevColumn(leadingCellRow, c),
                        startLeadingCellRow = leadingCellRow;
                    if (!wrap)
                    {
                        self._adjustCell(cell)
                    }
                    r = cell.r;
                    c = cell.c;
                    while (c < 0 && wrap)
                    {
                        r = self._getPrevVisualRow(r, 3, true);
                        if (r < 0 || r === keyword_undefined || r === keyword_null)
                        {
                            r = self._getPrevVisualRow(rowCount, 3, true)
                        }
                        leadingCellRow = r;
                        cell = self._getPrevColumn(leadingCellRow, colCount);
                        r = cell.r;
                        c = cell.c;
                        if (r === row && c < col)
                        {
                            return keyword_null
                        }
                        else if (r === row && c === col)
                        {
                            if (leadingCellRow === startLeadingCellRow)
                            {
                                return keyword_null
                            }
                            cell = self._getPrevColumn(leadingCellRow, c);
                            r = cell.r;
                            c = cell.c
                        }
                    }
                    return {
                            row: r, col: c, leadingCellRow: leadingCellRow
                        }
                };
                Sheet.prototype._adjustCell = function(cell)
                {
                    var self = this;
                    if (cell.r < 0)
                    {
                        cell.r = self._getFirstVisualRow()
                    }
                    else if (cell.r >= self.getRowCount())
                    {
                        cell.r = self._getLastVisualRow()
                    }
                    if (cell.c < 0)
                    {
                        cell.c = self._getFirstVisualColumn()
                    }
                    else if (cell.c >= self.getColumnCount())
                    {
                        cell.c = self._getLastVisualColumn()
                    }
                };
                Sheet.prototype._fixRange = function(range)
                {
                    var r = (range.row < 0 ? 0 : range.row),
                        c = (range.col < 0 ? 0 : range.col),
                        rc = (range.row < 0 ? this.getRowCount() : range.rowCount),
                        cc = (range.col < 0 ? this.getColumnCount() : range.colCount);
                    return new Sheets.Range(r, c, rc, cc)
                };
                Sheet.prototype._moveActiveCellLeftInSelection = function(row, col)
                {
                    var self = this;
                    var selectionModel = self._selectionModel,
                        startRangeIndex = selectionModel.activeSelectedRangeIndex,
                        prevRangeIndex = -1;
                    var startRange = self._fixRange(self._getActiveSelectedRange()),
                        beginRow = startRange.row,
                        beginCol = startRange.col,
                        endCol = startRange.col + startRange.colCount - 1;
                    var r = row,
                        c = col,
                        cell;
                    while (true)
                    {
                        cell = self._getPrevColumnInSelection(r, c);
                        r = cell.r;
                        c = cell.c;
                        if (c >= beginCol)
                        {
                            break
                        }
                        if (prevRangeIndex === startRangeIndex && r === row && c <= col)
                        {
                            return
                        }
                        r--;
                        if (r >= beginRow)
                        {
                            c = endCol + 1
                        }
                        else
                        {
                            var prevRange = self._fixRange(self._getActiveSelectedRange(3));
                            prevRangeIndex = selectionModel.activeSelectedRangeIndex;
                            beginRow = prevRange.row;
                            beginCol = prevRange.col;
                            endCol = prevRange.col + prevRange.colCount - 1;
                            r = prevRange.row + prevRange.rowCount - 1;
                            c = prevRange.col + prevRange.colCount
                        }
                    }
                    if (r >= 0)
                    {
                        self._setActiveCellCore(r, c);
                        self._leadingCellRow = r;
                        self._leadingCellCol = c
                    }
                };
                Sheet.prototype._moveActiveCellRightInSelection = function(row, col)
                {
                    var self = this;
                    var selectionModel = self._selectionModel,
                        startRangeIndex = selectionModel.activeSelectedRangeIndex,
                        nextRangeIndex = -1;
                    var startRange = self._fixRange(self._getActiveSelectedRange()),
                        beginCol = startRange.col,
                        endRow = startRange.row + startRange.rowCount - 1,
                        endCol = startRange.col + startRange.colCount - 1;
                    var r = row,
                        c = col,
                        cell;
                    while (true)
                    {
                        cell = self._getNextColumnInSelection(r, c);
                        r = cell.r;
                        c = cell.c;
                        if (c <= endCol)
                        {
                            break
                        }
                        if (nextRangeIndex === startRangeIndex && r === row && c >= col)
                        {
                            return
                        }
                        r++;
                        if (r <= endRow)
                        {
                            c = beginCol - 1
                        }
                        else
                        {
                            var nextRange = self._fixRange(self._getActiveSelectedRange(4));
                            nextRangeIndex = selectionModel.activeSelectedRangeIndex;
                            beginCol = nextRange.col;
                            endRow = nextRange.row + nextRange.rowCount - 1;
                            endCol = nextRange.col + nextRange.colCount - 1;
                            r = nextRange.row;
                            c = nextRange.col - 1
                        }
                    }
                    if (r >= 0)
                    {
                        self._setActiveCellCore(r, c);
                        self._leadingCellRow = r;
                        self._leadingCellCol = c
                    }
                };
                Sheet.prototype._moveActiveCellRight = function(row, col, wrap)
                {
                    var self = this;
                    var rightCell = self._getMoveRightCell(row, col, wrap, self._leadingCellRow || 0);
                    if (rightCell)
                    {
                        var r = rightCell.row,
                            c = rightCell.col,
                            leadingCellRow = rightCell.leadingCellRow;
                        if (self._canMoveCurrentTo(r, c))
                        {
                            self._leadingCellRow = leadingCellRow;
                            self._leadingCellCol = c;
                            self._setActiveCellCore(r, c)
                        }
                    }
                };
                Sheet.prototype._getMoveRightCell = function(row, col, wrap, leadingCellRow)
                {
                    var self = this;
                    var rowCount = self.getRowCount();
                    var colCount = self.getColumnCount();
                    var r = row,
                        c = col;
                    if (c === colCount - 1 && !wrap)
                    {
                        return keyword_null
                    }
                    var cell = self._getNextColumn(leadingCellRow, c),
                        startLeadingCellRow = leadingCellRow;
                    if (!wrap)
                    {
                        if (cell.c === colCount)
                        {
                            return keyword_null
                        }
                        self._adjustCell(cell)
                    }
                    r = cell.r;
                    c = cell.c;
                    while (c === colCount && wrap)
                    {
                        r = self._getNextVisualRow(r, true);
                        if (r >= rowCount || r === keyword_undefined || r === keyword_null)
                        {
                            r = self._getNextVisualRow(-1, true)
                        }
                        leadingCellRow = r;
                        cell = self._getNextColumn(leadingCellRow, -1);
                        r = cell.r;
                        c = cell.c;
                        if (r === row && c > col)
                        {
                            return keyword_null
                        }
                        else if (r === row && c === col)
                        {
                            if (leadingCellRow === startLeadingCellRow)
                            {
                                return keyword_null
                            }
                            cell = self._getNextColumn(leadingCellRow, c);
                            r = cell.r;
                            c = cell.c
                        }
                    }
                    return {
                            row: r, col: c, leadingCellRow: leadingCellRow
                        }
                };
                Sheet.prototype._getPrevColumn = function(r, c)
                {
                    var startPosition = {
                            r: r, c: c
                        };
                    while (c >= 0)
                    {
                        r = startPosition.r;
                        c--;
                        if (c < 0)
                        {
                            break
                        }
                        var spans = this.getSpans(new Sheets.Range(r, c, 1, 1));
                        if (spans && spans.length > 0)
                        {
                            var span = spans[0];
                            if (c >= span.col)
                            {
                                c = span.col;
                                r = span.row
                            }
                        }
                        if (this._canMoveCurrentTo(r, c))
                        {
                            return {
                                    r: r, c: c
                                }
                        }
                    }
                    return {
                            r: r, c: c
                        }
                };
                Sheet.prototype._getPrevColumnInSelection = function(r, c)
                {
                    while (c >= 0)
                    {
                        c--;
                        if (c < 0)
                        {
                            break
                        }
                        var span = this._getSpanModel().find(r, c);
                        if (span)
                        {
                            var activeSelectedRange = this._getActiveSelectedRange();
                            if (activeSelectedRange.row <= span.row && span.row + span.rowCount <= activeSelectedRange.row + activeSelectedRange.rowCount && activeSelectedRange.col <= span.col && span.col + span.colCount <= activeSelectedRange.col + activeSelectedRange.colCount)
                            {
                                if (!(span.row === r && span.col === c))
                                {
                                    continue
                                }
                            }
                            else
                            {
                                continue
                            }
                            if (c >= span.col)
                            {
                                c = span.col;
                                r = span.row
                            }
                        }
                        if (this._canMoveCurrentTo(r, c))
                        {
                            return {
                                    r: r, c: c
                                }
                        }
                    }
                    return {
                            r: r, c: c
                        }
                };
                Sheet.prototype._getNextColumn = function(r, c)
                {
                    var self = this;
                    var colCount = self.getColumnCount();
                    var startPosition = {
                            r: r, c: c
                        };
                    while (c < colCount)
                    {
                        r = startPosition.r;
                        var currentSpan = this._getSpanModel().find(r, c);
                        if (!currentSpan)
                        {
                            c++
                        }
                        else
                        {
                            c += currentSpan.colCount
                        }
                        if (c >= colCount)
                        {
                            break
                        }
                        var spans = self.getSpans(new Sheets.Range(r, c, 1, 1));
                        if (spans && spans.length > 0)
                        {
                            var span = spans[0];
                            if (c > span.col)
                            {
                                c = Math_max(c, span.col + span.colCount)
                            }
                            else
                            {
                                r = span.row
                            }
                        }
                        if (self._canMoveCurrentTo(r, c))
                        {
                            return {
                                    r: r, c: c
                                }
                        }
                    }
                    return {
                            r: r, c: c
                        }
                };
                Sheet.prototype._getNextColumnInSelection = function(r, c)
                {
                    var self = this;
                    var colCount = self.getColumnCount();
                    while (c < colCount)
                    {
                        var currentSpan = this._getSpanModel().find(r, c);
                        if (!currentSpan)
                        {
                            c++
                        }
                        else
                        {
                            c += currentSpan.colCount
                        }
                        if (c >= colCount)
                        {
                            break
                        }
                        var span = this._getSpanModel().find(r, c);
                        if (span)
                        {
                            var activeSelectedRange = self._getActiveSelectedRange();
                            if (activeSelectedRange.row <= span.row && span.row + span.rowCount <= activeSelectedRange.row + activeSelectedRange.rowCount && activeSelectedRange.col <= span.col && span.col + span.colCount <= activeSelectedRange.col + activeSelectedRange.colCount)
                            {
                                if (!(span.row === r && span.col === c))
                                {
                                    continue
                                }
                            }
                            else
                            {
                                continue
                            }
                            if (c > span.col)
                            {
                                c = Math_max(c, span.col + span.colCount)
                            }
                            else
                            {
                                r = span.row
                            }
                        }
                        if (self._canMoveCurrentTo(r, c))
                        {
                            return {
                                    r: r, c: c
                                }
                        }
                    }
                    return {
                            r: r, c: c
                        }
                };
                Sheet.prototype._canMoveCurrentTo = function(r, c)
                {
                    var self = this;
                    var canMove = false;
                    var rowVisible = self.getRowVisible(r);
                    var colVisible = self.getColumnVisible(c);
                    var rowHeight = self._getZoomRowHeight(r);
                    var colWidth = self._getZoomColumnWidth(c);
                    canMove = (r >= 0 && r < self.getRowCount() && c >= 0 && c < self.getColumnCount() && rowVisible && colVisible && rowHeight > 0 && colWidth > 0);
                    var checkTab = !!self._isTabNavigation;
                    if (canMove === true && checkTab === true)
                    {
                        var styleInfo = self.getActualStyle(r, c);
                        if (styleInfo && styleInfo.tabStop === false)
                        {
                            canMove = false
                        }
                    }
                    return canMove
                };
                Sheet.prototype._getPrevRow = function(r, c)
                {
                    var startPosition = {
                            r: r, c: c
                        };
                    while (r >= 0)
                    {
                        r--;
                        if (r < 0)
                        {
                            break
                        }
                        var spans = this.getSpans(new Sheets.Range(r, c, 1, 1));
                        if (spans && spans.length > 0)
                        {
                            var span = spans[0];
                            if (r >= span.row)
                            {
                                r = span.row;
                                c = span.col
                            }
                        }
                        if (this._canMoveCurrentTo(r, c))
                        {
                            return {
                                    r: r, c: c
                                }
                        }
                    }
                    return {
                            r: r, c: c
                        }
                };
                Sheet.prototype._getNextRow = function(r, c)
                {
                    var self = this;
                    var rowCount = self.getRowCount();
                    var startPosition = {
                            r: r, c: c
                        };
                    while (r < rowCount)
                    {
                        var currentSpan = this._getSpanModel().find(r, c);
                        if (!currentSpan)
                        {
                            r++
                        }
                        else
                        {
                            r += currentSpan.rowCount
                        }
                        if (r >= rowCount)
                        {
                            break
                        }
                        var spans = self.getSpans(new Sheets.Range(r, c, 1, 1));
                        if (spans && spans.length > 0)
                        {
                            var span = spans[0];
                            if (r > span.row)
                            {
                                r = Math_max(r, span.row + span.rowCount)
                            }
                            else
                            {
                                c = span.col
                            }
                        }
                        if (self._canMoveCurrentTo(r, c))
                        {
                            return {
                                    r: r, c: c
                                }
                        }
                    }
                    return {
                            r: r, c: c
                        }
                };
                Sheet.prototype._setSelectedRange = function(r, c, rc, cc, repaint)
                {
                    this._selectionModel.add(r, c, rc, cc);
                    if (repaint && !this._paintSuspended)
                    {
                        this._render.repaintSelection()
                    }
                };
                Sheet.prototype._extendSelectedRange = function(r, c, repaint)
                {
                    var self = this;
                    var extendedRange = self._getExtendedRange(r, c, self._activeRowIndex, self._activeColIndex);
                    var newRow = extendedRange.row,
                        newCol = extendedRange.col,
                        newRowCount = extendedRange.rowCount,
                        newColCount = extendedRange.colCount;
                    var selectionPolicy = self.selectionPolicy(),
                        selectionUnit = self.selectionUnit();
                    if (selectionPolicy === 0)
                    {
                        return
                    }
                    else if (selectionPolicy === 1)
                    {
                        self._selectionModel.clear()
                    }
                    if (selectionUnit === 1)
                    {
                        newCol = -1;
                        newColCount = -1
                    }
                    else if (selectionUnit === 2)
                    {
                        newRow = -1;
                        newRowCount = -1
                    }
                    self._replaceActiveSelectedRange(newRow, newCol, newRowCount, newColCount, repaint)
                };
                Sheet.prototype._getExtendedRange = function(r, c, anchorRow, anchorCol)
                {
                    var self = this;
                    if (typeof(anchorRow) === const_undefined)
                    {
                        anchorRow = self._activeRowIndex
                    }
                    if (typeof(anchorCol) === const_undefined)
                    {
                        anchorCol = self._activeColIndex
                    }
                    var anchorRange = new Sheets.Range(anchorRow, anchorCol, 1, 1);
                    var spanAnchorRange = this._getSpanModel().find(anchorRow, anchorCol);
                    if (spanAnchorRange)
                    {
                        anchorRange = spanAnchorRange
                    }
                    var endRange = new Sheets.Range(r, c, 1, 1);
                    var spanEndRange = this._getSpanModel().find(r, c);
                    if (spanEndRange)
                    {
                        endRange = spanEndRange
                    }
                    var extendedRange = anchorRange.union(endRange);
                    var spans = self.getSpans();
                    if (spans && spans.length > 0)
                    {
                        extendedRange = self._inflateRangeToCoverSpans(spans, extendedRange)
                    }
                    return extendedRange
                };
                Sheet.prototype._replaceActiveSelectedRange = function(r, c, rc, cc, repaint)
                {
                    var self = this;
                    var oldSelectedRange = self._getActiveSelectedRange();
                    if (self._selectionModel.length > 0)
                    {
                        self._selectionModel.splice(self._selectionModel.activeSelectedRangeIndex, 1, new Sheets.Range(r, c, rc, cc))
                    }
                    else
                    {
                        self._selectionModel.add(r, c, rc, cc)
                    }
                    if (repaint && !self._paintSuspended)
                    {
                        var newSelectedRange = self._getActiveSelectedRange();
                        if (newSelectedRange.row === oldSelectedRange.row && newSelectedRange.col === oldSelectedRange.col && newSelectedRange.rowCount === oldSelectedRange.rowCount && newSelectedRange.colCount === oldSelectedRange.colCount)
                        {
                            return
                        }
                        var render = self._render;
                        if (oldSelectedRange.containsRange(newSelectedRange))
                        {
                            render.repaintSelection(oldSelectedRange)
                        }
                        else if (newSelectedRange.containsRange(oldSelectedRange))
                        {
                            render.repaintSelection(newSelectedRange)
                        }
                        else
                        {
                            render.repaintSelection(oldSelectedRange);
                            render.repaintSelection(newSelectedRange)
                        }
                    }
                };
                Sheet.prototype._changeActiveSelectedRange = function(key, isCtrl)
                {
                    var self = this;
                    if (self._selectionModel.length <= 0)
                    {
                        return
                    }
                    var oldActiveRange = self._getActiveSelectedRange();
                    var newRange = self._getKeyboardSelectedRange(oldActiveRange, key, isCtrl);
                    if (newRange)
                    {
                        var oldSelections = self._selectionModel.toArray();
                        var newRow = newRange.row,
                            newCol = newRange.col,
                            newRowCount = newRange.rowCount,
                            newColCount = newRange.colCount;
                        var selectionPolicy = self.selectionPolicy(),
                            selectionUnit = self.selectionUnit();
                        if (selectionPolicy === 0)
                        {
                            return
                        }
                        else if (selectionPolicy === 1)
                        {
                            self._selectionModel.clear()
                        }
                        if (selectionUnit === 1)
                        {
                            newCol = -1;
                            newColCount = -1
                        }
                        else if (selectionUnit === 2)
                        {
                            newRow = -1;
                            newRowCount = -1
                        }
                        self._replaceActiveSelectedRange(newRow, newCol, newRowCount, newColCount, true);
                        var newSelections = self._selectionModel.toArray();
                        if (self._eventHandler._notEqualSelecions(oldSelections, newSelections))
                        {
                            self.triggerSelectionChanging({
                                sheet: self, sheetName: self._name, oldSelections: oldSelections, newSelections: newSelections
                            });
                            self.triggerSelectionChanged({
                                sheet: self, sheetName: self._name
                            })
                        }
                    }
                };
                Sheet.prototype._getKeyboardSelectedRange = function(activeRange, key, isCtrl, anchorRow, anchorCol)
                {
                    var self = this;
                    var range = self._fixRange(activeRange);
                    var newRange = keyword_null;
                    if (key === 37)
                    {
                        newRange = isCtrl ? self._searchSelectedRangebyLeftCtrl(range, false, anchorRow, anchorCol) : self._searchSelectedRangebyLeft(range, anchorRow, anchorCol)
                    }
                    else if (key === 39)
                    {
                        newRange = isCtrl ? self._searchSelectedRangebyRightCtrl(range, false, anchorRow, anchorCol) : self._searchSelectedRangebyRight(range, anchorRow, anchorCol)
                    }
                    else if (key === 38)
                    {
                        newRange = isCtrl ? self._searchSelectedRangebyUpCtrl(range, false, anchorRow, anchorCol) : self._searchSelectedRangebyUp(range, anchorRow, anchorCol)
                    }
                    else if (key === 40)
                    {
                        newRange = isCtrl ? self._searchSelectedRangebyDownCtrl(range, false, anchorRow, anchorCol) : self._searchSelectedRangebyDown(range, anchorRow, anchorCol)
                    }
                    else if (key === 36)
                    {
                        newRange = isCtrl ? self._searchSelectedRangebyHomeCtrl(range, anchorRow, anchorCol) : self._searchSelectedRangebyHome(range, anchorRow, anchorCol)
                    }
                    else if (key === 35)
                    {
                        newRange = isCtrl ? self._searchSelectedRangebyEndCtrl(range, anchorRow, anchorCol) : self._searchSelectedRangebyEnd(range, anchorRow, anchorCol)
                    }
                    else if (key === 33)
                    {
                        newRange = self._searchSelectedRangebyPageUp(range, anchorRow, anchorCol)
                    }
                    else if (key === 34)
                    {
                        newRange = self._searchSelectedRangebyPageDown(range, anchorRow, anchorCol)
                    }
                    if (newRange)
                    {
                        if (activeRange.row < 0)
                        {
                            newRange.row = -1;
                            newRange.rowCount = -1
                        }
                        if (activeRange.col < 0)
                        {
                            newRange.col = -1;
                            newRange.colCount = -1
                        }
                    }
                    return newRange
                };
                Sheet.prototype._searchSelectedRangebyLeft = function(activeRange, anchorRow, anchorCol)
                {
                    var self = this;
                    var beginCol = activeRange.col + activeRange.colCount - 1;
                    var endCol = 0;
                    var startPosition = {
                            r: activeRange.row + activeRange.rowCount - 1, c: beginCol
                        };
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    while (beginCol > endCol)
                    {
                        beginCol--;
                        if (!self._canMoveCurrentTo(startPosition.r, beginCol))
                        {
                            continue
                        }
                        extendedRange = self._getExtendedRange(startPosition.r, beginCol, anchorRow, anchorCol);
                        row = Math_min(activeRange.row, extendedRange.row);
                        col = Math_min(activeRange.col, extendedRange.col);
                        row2 = Math_max(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                        col2 = Math_min(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        if (!(row === activeRange.row && col === activeRange.col && rowCount === activeRange.rowCount && colCount === activeRange.colCount))
                        {
                            var newLeftCol = self._getPrevVisualColumn(self._scrollLeftCol);
                            if (col === newLeftCol || col2 === newLeftCol)
                            {
                                self._setLeftColumn(newLeftCol)
                            }
                            return new Sheets.Range(row, col, rowCount, colCount)
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._searchSelectedRangebyLeftCtrl = function(activeRange, isHomeKey, anchorRow, anchorCol)
                {
                    var self = this;
                    var firstCol = self.frozenColCount ? self._getNextVisualColumn(self.frozenColCount - 1) : self._getFirstVisualColumn();
                    var beginCol = isHomeKey ? firstCol : self._getFirstVisualColumn();
                    if (beginCol === keyword_undefined || beginCol === keyword_null)
                    {
                        return
                    }
                    else if (self.frozenColCount <= 0 || isHomeKey)
                    {
                        self._setLeftColumn(beginCol)
                    }
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    extendedRange = self._getExtendedRange(activeRange.row, beginCol, anchorRow, anchorCol);
                    row = Math_min(activeRange.row, extendedRange.row);
                    col = Math_min(activeRange.col, extendedRange.col);
                    row2 = Math_max(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                    col2 = Math_min(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return new Sheets.Range(row, col, rowCount, colCount)
                };
                Sheet.prototype._searchSelectedRangebyRight = function(activeRange, anchorRow, anchorCol)
                {
                    var self = this;
                    var beginCol = activeRange.col;
                    var endCol = self.getColumnCount() - 1;
                    var startPosition = {
                            r: activeRange.row + activeRange.rowCount - 1, c: beginCol
                        };
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    while (beginCol < endCol)
                    {
                        beginCol++;
                        if (!self._canMoveCurrentTo(startPosition.r, beginCol))
                        {
                            continue
                        }
                        extendedRange = self._getExtendedRange(startPosition.r, beginCol, anchorRow, anchorCol);
                        row = Math_min(activeRange.row, extendedRange.row);
                        col = Math_max(activeRange.col, extendedRange.col);
                        row2 = Math_max(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                        col2 = Math_max(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        if (!(row === activeRange.row && col === activeRange.col && rowCount === activeRange.rowCount && colCount === activeRange.colCount))
                        {
                            var pageRightCol = self._getPageRightColumn();
                            if (col === pageRightCol || col2 === pageRightCol)
                            {
                                self._setLeftColumn(self._getNextVisualColumn(self._scrollLeftCol))
                            }
                            return new Sheets.Range(row, col, rowCount, colCount)
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._searchSelectedRangebyRightCtrl = function(activeRange, isEndKey, anchorRow, anchorCol)
                {
                    var self = this;
                    var newPageLeftCol = self._getLastPageLeftColumn();
                    if (newPageLeftCol === keyword_undefined || newPageLeftCol === keyword_null)
                    {
                        return
                    }
                    else
                    {
                        self._setLeftColumn(newPageLeftCol)
                    }
                    var endCol = self._getLastVisualColumn();
                    if (!isEndKey)
                    {
                        endCol += self._frozenTrailingColCount
                    }
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    extendedRange = self._getExtendedRange(activeRange.row, endCol, anchorRow, anchorCol);
                    row = Math_min(activeRange.row, extendedRange.row);
                    col = Math_max(activeRange.col, extendedRange.col);
                    row2 = Math_max(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                    col2 = Math_max(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return new Sheets.Range(row, col, rowCount, colCount)
                };
                Sheet.prototype._searchSelectedRangebyUp = function(activeRange, anchorRow, anchorCol)
                {
                    var self = this;
                    var beginRow = activeRange.row + activeRange.rowCount - 1;
                    var endRow = 0;
                    var startPosition = {
                            r: beginRow, c: activeRange.col + activeRange.colCount - 1
                        };
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    while (beginRow > endRow)
                    {
                        beginRow--;
                        if (!self._canMoveCurrentTo(beginRow, startPosition.c))
                        {
                            continue
                        }
                        extendedRange = self._getExtendedRange(beginRow, startPosition.c, anchorRow, anchorCol);
                        row = Math_min(activeRange.row, extendedRange.row);
                        col = Math_min(activeRange.col, extendedRange.col);
                        row2 = Math_min(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                        col2 = Math_max(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        if (!(row === activeRange.row && col === activeRange.col && rowCount === activeRange.rowCount && colCount === activeRange.colCount))
                        {
                            var newTopRow = self._getPrevVisualRow(self._scrollTopRow);
                            if (row === newTopRow || row2 === newTopRow)
                            {
                                self._setTopRow(newTopRow)
                            }
                            return new Sheets.Range(row, col, rowCount, colCount)
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._searchSelectedRangebyUpCtrl = function(activeRange, isHomeKey, anchorRow, anchorCol)
                {
                    var self = this;
                    var firstRow = self.frozenRowCount ? self._getNextVisualRow(self.frozenRowCount - 1) : self._getFirstVisualRow();
                    var beginRow = isHomeKey ? firstRow : self._getFirstVisualRow();
                    if (beginRow === keyword_undefined || beginRow === keyword_null)
                    {
                        return
                    }
                    else if (self.frozenRowCount <= 0 || isHomeKey)
                    {
                        self._setTopRow(beginRow)
                    }
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    extendedRange = self._getExtendedRange(beginRow, activeRange.col, anchorRow, anchorCol);
                    row = Math_min(activeRange.row, extendedRange.row);
                    col = Math_min(activeRange.col, extendedRange.col);
                    row2 = Math_min(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                    col2 = Math_max(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return new Sheets.Range(row, col, rowCount, colCount)
                };
                Sheet.prototype._searchSelectedRangebyDown = function(activeRange, anchorRow, anchorCol)
                {
                    var self = this;
                    var beginRow = activeRange.row;
                    var endRow = self.getRowCount() - 1;
                    var startPosition = {
                            r: beginRow, c: activeRange.col + activeRange.colCount - 1
                        };
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    while (beginRow < endRow)
                    {
                        beginRow++;
                        if (!self._canMoveCurrentTo(beginRow, startPosition.c))
                        {
                            continue
                        }
                        extendedRange = self._getExtendedRange(beginRow, startPosition.c, anchorRow, anchorCol);
                        row = Math_max(activeRange.row, extendedRange.row);
                        col = Math_min(activeRange.col, extendedRange.col);
                        row2 = Math_max(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                        col2 = Math_max(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        if (!(row === activeRange.row && col === activeRange.col && rowCount === activeRange.rowCount && colCount === activeRange.colCount))
                        {
                            var pageBottomRow = self._getPageBottomRow();
                            if (row === pageBottomRow || row2 === pageBottomRow)
                            {
                                self._setTopRow(self._getNextVisualRow(self._scrollTopRow))
                            }
                            return new Sheets.Range(row, col, rowCount, colCount)
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._searchSelectedRangebyDownCtrl = function(activeRange, isEndKey, anchorRow, anchorCol)
                {
                    var self = this;
                    var newTopRow = self._getLastPageTopRow();
                    if (newTopRow === keyword_undefined || newTopRow === keyword_null)
                    {
                        return
                    }
                    else
                    {
                        self._setTopRow(newTopRow)
                    }
                    var endRow = self._getLastVisualRow();
                    if (!isEndKey)
                    {
                        endRow += self._frozenTrailingRowCount
                    }
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    extendedRange = self._getExtendedRange(endRow, activeRange.col, anchorRow, anchorCol);
                    row = Math_max(activeRange.row, extendedRange.row);
                    col = Math_min(activeRange.col, extendedRange.col);
                    row2 = Math_max(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                    col2 = Math_max(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return new Sheets.Range(row, col, rowCount, colCount)
                };
                Sheet.prototype._searchSelectedRangebyHome = function(activeRange, anchorRow, anchorCol)
                {
                    var self = this;
                    var beginCol = self.frozenColCount ? self.frozenColCount - 1 : -1;
                    var endCol = self._activeColIndex;
                    var startPosition = {
                            r: activeRange.row + activeRange.rowCount - 1, c: activeRange.col
                        };
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    while (beginCol < endCol)
                    {
                        beginCol++;
                        if (!self._canMoveCurrentTo(startPosition.r, beginCol))
                        {
                            continue
                        }
                        if (activeRange.col <= beginCol && (activeRange.col + activeRange.colCount - 1) === self._activeColIndex)
                        {
                            break
                        }
                        extendedRange = self._getExtendedRange(startPosition.r, beginCol, anchorRow, anchorCol);
                        row = Math_min(activeRange.row, extendedRange.row);
                        col = Math_min(activeRange.col, extendedRange.col);
                        row2 = Math_max(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                        col2 = Math_min(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        self._setLeftColumn(self._getFirstVisualColumn());
                        return new Sheets.Range(row, col, rowCount, colCount)
                    }
                    return keyword_null
                };
                Sheet.prototype._searchSelectedRangebyHomeCtrl = function(activeRange, anchorRow, anchorCol)
                {
                    activeRange = this._searchSelectedRangebyLeftCtrl(activeRange, true, anchorRow, anchorCol);
                    activeRange = this._searchSelectedRangebyUpCtrl(activeRange, true, anchorRow, anchorCol);
                    return activeRange
                };
                Sheet.prototype._searchSelectedRangebyEnd = function(activeRange, anchorRow, anchorCol)
                {
                    var self = this;
                    var beginCol = self.getColumnCount();
                    var endCol = self._activeColIndex;
                    var startPosition = {
                            r: activeRange.row + activeRange.rowCount - 1, c: activeRange.col + activeRange.colCount - 1
                        };
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    while (beginCol > endCol)
                    {
                        beginCol--;
                        if (!self._canMoveCurrentTo(startPosition.r, beginCol))
                        {
                            continue
                        }
                        if (activeRange.col + activeRange.colCount - 1 >= beginCol && activeRange.col === self._activeColIndex)
                        {
                            break
                        }
                        extendedRange = self._getExtendedRange(startPosition.r, beginCol, anchorRow, anchorCol);
                        row = Math_min(activeRange.row, extendedRange.row);
                        col = Math_max(activeRange.col, extendedRange.col);
                        row2 = Math_max(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                        col2 = Math_max(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        self._setLeftColumn(self._getLastPageLeftColumn());
                        return new Sheets.Range(row, col, rowCount, colCount)
                    }
                    return keyword_null
                };
                Sheet.prototype._searchSelectedRangebyEndCtrl = function(activeRange, anchorRow, anchorCol)
                {
                    activeRange = this._searchSelectedRangebyRightCtrl(activeRange, true, anchorRow, anchorCol);
                    activeRange = this._searchSelectedRangebyDownCtrl(activeRange, true, anchorRow, anchorCol);
                    return activeRange
                };
                Sheet.prototype._searchSelectedRangebyPageUp = function(activeRange, anchorRow, anchorCol)
                {
                    var self = this;
                    var prevPageTopRow = self._getPrevPageTopRow();
                    if (prevPageTopRow === keyword_undefined || prevPageTopRow === keyword_null)
                    {
                        return keyword_null
                    }
                    var rls = self._getRowLayout(1);
                    var scrolled = self._setTopRow(prevPageTopRow);
                    var beginRow = -1;
                    if (scrolled)
                    {
                        beginRow = self._getNextVisualRow(activeRange.row + activeRange.rowCount - 1 - rls.length)
                    }
                    else if (self.frozenRowCount <= 0)
                    {
                        beginRow = self._getFirstVisualRow()
                    }
                    if (beginRow < self._scrollTopRow)
                    {
                        beginRow = self._scrollTopRow
                    }
                    else if (beginRow >= self._getPageBottomRow())
                    {
                        beginRow = self._getPrevVisualRow(self._getPageBottomRow())
                    }
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    extendedRange = self._getExtendedRange(beginRow, activeRange.col, anchorRow, anchorCol);
                    row = Math_min(activeRange.row, extendedRange.row);
                    col = Math_min(activeRange.col, extendedRange.col);
                    row2 = Math_min(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                    col2 = Math_max(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return new Sheets.Range(row, col, rowCount, colCount)
                };
                Sheet.prototype._searchSelectedRangebyPageDown = function(activeRange, anchorRow, anchorCol)
                {
                    var self = this;
                    var nextPageTopRow = self._getNextPageTopRow();
                    if (nextPageTopRow === keyword_undefined || nextPageTopRow === keyword_null)
                    {
                        return keyword_null
                    }
                    var rls = self._getRowLayout(1);
                    self._setTopRow(nextPageTopRow);
                    var beginRow = self._getPrevVisualRow(activeRange.row + activeRange.rowCount - 1 + rls.length);
                    if (beginRow < self._scrollTopRow)
                    {
                        beginRow = self._scrollTopRow
                    }
                    else if (beginRow >= self._getPageBottomRow())
                    {
                        if (self._scrollTopRow >= self._getLastPageTopRow())
                        {
                            beginRow = self._getPageBottomRow()
                        }
                        else
                        {
                            beginRow = self._getPrevVisualRow(self._getPageBottomRow())
                        }
                    }
                    var extendedRange,
                        row,
                        col,
                        row2,
                        col2,
                        rowCount,
                        colCount;
                    extendedRange = self._getExtendedRange(beginRow, activeRange.col, anchorRow, anchorCol);
                    row = Math_max(activeRange.row, extendedRange.row);
                    col = Math_min(activeRange.col, extendedRange.col);
                    row2 = Math_max(activeRange.row + activeRange.rowCount - 1, extendedRange.row + extendedRange.rowCount - 1);
                    col2 = Math_max(activeRange.col + activeRange.colCount - 1, extendedRange.col + extendedRange.colCount - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return new Sheets.Range(row, col, rowCount, colCount)
                };
                Sheet.prototype._getPrevPageTopRow = function()
                {
                    var self = this;
                    var rls = self._getRowLayout(1);
                    if (!rls || rls.length <= 0)
                    {
                        return keyword_null
                    }
                    var firstRow = self.frozenRowCount ? self._getNextVisualRow(self.frozenRowCount - 1) : self._getFirstVisualRow();
                    var h = 0;
                    var r = self._scrollTopRow;
                    var sheetLayout = self._getSheetLayout();
                    while (r > firstRow)
                    {
                        h += self._getZoomRowHeight(r);
                        if (h > sheetLayout.viewportHeight)
                        {
                            break
                        }
                        r--
                    }
                    return r
                };
                Sheet.prototype._getPrevPageLeftColumn = function()
                {
                    var self = this;
                    var rls = self._getColumnLayout(1);
                    if (!rls || rls.length <= 0)
                    {
                        return keyword_null
                    }
                    var firstColumn = self.frozenColCount ? self._getNextVisualColumn(self.frozenColCount - 1) : self._getFirstVisualColumn();
                    var w = 0;
                    var c = self._scrollLeftCol;
                    var sheetLayout = self._getSheetLayout();
                    while (c > firstColumn)
                    {
                        w += self._getZoomColumnWidth(c);
                        if (w > sheetLayout.viewportWidth)
                        {
                            break
                        }
                        c--
                    }
                    return c
                };
                Sheet.prototype._getNextPageTopRow = function()
                {
                    var rls = this._getRowLayout(1);
                    if (!rls || rls.length <= 0)
                    {
                        return keyword_null
                    }
                    if (this._getLastVisualRow() === rls[rls.length - 1].row)
                    {
                        return this._scrollTopRow
                    }
                    return rls[rls.length - 1].row
                };
                Sheet.prototype._getLastPageTopRow = function()
                {
                    var self = this;
                    if (self._getLastVisualRow() === self._getPageBottomRow())
                    {
                        var sheetLayout = self._getSheetLayout();
                        var rls = self._getRowLayout(1);
                        if (rls && rls.length >= 1)
                        {
                            var endRowLayout = rls[rls.length - 1];
                            if (endRowLayout.y + endRowLayout.height <= sheetLayout.viewportY + sheetLayout.viewportHeight)
                            {
                                return self._scrollTopRow
                            }
                        }
                    }
                    var catchTopRow = self._scrollTopRow;
                    try
                    {
                        self._scrollTopRow = self._getLastVisualRow();
                        var lastPageTopRow = self._getPrevPageTopRow();
                        lastPageTopRow = self._getNextVisualRow(lastPageTopRow);
                        return lastPageTopRow
                    }
                    catch(e) {}
                    finally
                    {
                        self._scrollTopRow = catchTopRow
                    }
                };
                Sheet.prototype._getLastPageLeftColumn = function()
                {
                    var self = this;
                    var sheetLayout;
                    if (self._getLastVisualColumn() === self._getPageRightColumn())
                    {
                        sheetLayout = self._getSheetLayout();
                        var rls = self._getColumnLayout(1);
                        if (rls && rls.length >= 1)
                        {
                            var endColLayout = rls[rls.length - 1];
                            if (endColLayout.x + endColLayout.width <= sheetLayout.viewportX + sheetLayout.width)
                            {
                                return self._scrollLeftCol
                            }
                        }
                    }
                    sheetLayout = self._getSheetLayout();
                    var width = 0;
                    var col = self._getLastVisualColumn();
                    while (col > 0)
                    {
                        width += self._getZoomColumnWidth(col);
                        if (width > sheetLayout.viewportWidth)
                        {
                            break
                        }
                        col--
                    }
                    if (col > 0)
                    {
                        col = self._getNextVisualColumn(col)
                    }
                    return col
                };
                Sheet.prototype._getPageBottomRow = function()
                {
                    var rls = this._getRowLayout(1);
                    if (!rls || rls.length <= 0)
                    {
                        return keyword_null
                    }
                    return rls[rls.length - 1].row
                };
                Sheet.prototype._getPageRightColumn = function()
                {
                    var rls = this._getColumnLayout(1);
                    if (!rls || rls.length <= 0)
                    {
                        return keyword_null
                    }
                    return rls[rls.length - 1].col
                };
                Sheet.prototype._getLastFullyVisibleRow = function()
                {
                    var rls = this._getRowLayout(1);
                    if (!rls || rls.length <= 0)
                    {
                        return keyword_null
                    }
                    var layout = this._getSheetLayout();
                    var i = rls.length - 1;
                    if (rls[i].y + rls[i].height <= layout.viewportY + layout.viewportHeight)
                    {
                        return rls[i].row
                    }
                    else
                    {
                        return rls[Math_max(i - 1, 0)].row
                    }
                };
                Sheet.prototype._getLastFullyVisibleColumn = function()
                {
                    var cls = this._getColumnLayout(1);
                    if (!cls || cls.length <= 0)
                    {
                        return keyword_null
                    }
                    var layout = this._getSheetLayout();
                    var i = cls.length - 1;
                    if (cls[i].x + cls[i].width <= layout.viewportX + layout.viewportWidth)
                    {
                        return cls[i].col
                    }
                    else
                    {
                        return cls[Math_max(i - 1, 0)].col
                    }
                };
                Sheet.prototype._getFirstVisualRow = function()
                {
                    return this._getNextVisualRow(-1)
                };
                Sheet.prototype._getLastVisualRow = function(sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var rowCount = this.getRowCount(sheetArea);
                    if (sheetArea === 3 || sheetArea === 2)
                    {
                        rowCount = rowCount - this._frozenTrailingRowCount
                    }
                    return this._getPrevVisualRow(rowCount, sheetArea)
                };
                Sheet.prototype._getFirstVisualColumn = function()
                {
                    return this._getNextVisualColumn(-1)
                };
                Sheet.prototype._getLastVisualColumn = function(sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var colCount = this.getColumnCount(sheetArea);
                    if (sheetArea === 3 || sheetArea === 1)
                    {
                        colCount = colCount - this._frozenTrailingColCount
                    }
                    return this._getPrevVisualColumn(colCount, sheetArea)
                };
                Sheet.prototype._getFirstPageLeftColumn = function()
                {
                    var self = this;
                    var firstLeftCol = 0;
                    var frozenColCount = isNaN(self.frozenColCount) ? 0 : self.frozenColCount;
                    if (frozenColCount > 0)
                    {
                        firstLeftCol = self._getNextVisualColumn(frozenColCount - 1)
                    }
                    else
                    {
                        firstLeftCol = self._getFirstVisualColumn()
                    }
                    return firstLeftCol
                };
                Sheet.prototype._getFirstPageTopRow = function()
                {
                    var self = this;
                    var firsTopRow = 0;
                    var frozenRowCount = isNaN(self.frozenRowCount) ? 0 : self.frozenRowCount;
                    if (frozenRowCount > 0)
                    {
                        firsTopRow = self._getNextVisualRow(frozenRowCount - 1)
                    }
                    else
                    {
                        firsTopRow = self._getFirstVisualRow()
                    }
                    return firsTopRow
                };
                Sheet.prototype._getNextVisualRow = function(row, ignoreFrozenTrailingRow)
                {
                    var self = this;
                    var endRow = ignoreFrozenTrailingRow ? self.getRowCount() - 1 : self.getRowCount() - 1 - self._frozenTrailingRowCount;
                    while (row < endRow)
                    {
                        row++;
                        if (self.getRowVisible(row) && self._getZoomRowHeight(row) > 0)
                        {
                            return row
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._getPrevVisualRow = function(row, sheetArea, ignoreFrozenRow)
                {
                    var minRow = ignoreFrozenRow ? 0 : this.frozenRowCount;
                    while (row > minRow)
                    {
                        row--;
                        if (this.getRowVisible(row, sheetArea) && this._getZoomRowHeight(row, sheetArea) > 0)
                        {
                            return row
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._getNextVisualColumn = function(col)
                {
                    var self = this;
                    var endCol = self.getColumnCount() - 1 - self._frozenTrailingColCount;
                    while (col < endCol)
                    {
                        col++;
                        if (self.getColumnVisible(col) && self._getZoomColumnWidth(col) > 0)
                        {
                            return col
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._getPrevVisualColumn = function(col, sheetArea)
                {
                    while (col > this.frozenColCount)
                    {
                        col--;
                        if (this.getColumnVisible(col, sheetArea) && this._getZoomColumnWidth(col, sheetArea) > 0)
                        {
                            return col
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._inflateRangeToCoverSpans = function(spans, cellRange)
                {
                    if (spans && spans.length > 0)
                    {
                        for (var i = 0; i < spans.length; i++)
                        {
                            var cr = spans[i];
                            if (cellRange.intersect(cr.row, cr.col, cr.rowCount, cr.colCount))
                            {
                                spans.splice(i--, 1);
                                return this._inflateRangeToCoverSpans(spans, cellRange.union(cr))
                            }
                        }
                    }
                    return cellRange
                };
                Sheet.prototype._getActiveSelectedRange = function(dir)
                {
                    var self = this;
                    var activeSelectedRange = new Sheets.Range(-1, -1, 0, 0);
                    if (self._selectionModel.length <= 0)
                    {
                        return activeSelectedRange
                    }
                    if (dir === 3)
                    {
                        self._selectionModel.activeSelectedRangeIndex--;
                        if (self._selectionModel.activeSelectedRangeIndex < 0)
                        {
                            self._selectionModel.activeSelectedRangeIndex = self._selectionModel.length - 1
                        }
                    }
                    else if (dir === 4)
                    {
                        self._selectionModel.activeSelectedRangeIndex++;
                        if (self._selectionModel.activeSelectedRangeIndex >= self._selectionModel.length)
                        {
                            self._selectionModel.activeSelectedRangeIndex = 0
                        }
                    }
                    if (self._selectionModel.activeSelectedRangeIndex >= 0)
                    {
                        activeSelectedRange = self._selectionModel[self._selectionModel.activeSelectedRangeIndex]
                    }
                    return activeSelectedRange
                };
                Sheet.prototype._initializeActiveCell = function()
                {
                    var self = this,
                        activeRowIndex = self._activeRowIndex,
                        activeColIndex = self._activeColIndex,
                        selectionModel = self._selectionModel;
                    if (activeRowIndex === keyword_undefined || activeRowIndex === keyword_null || activeColIndex === keyword_undefined || activeColIndex === keyword_null || selectionModel.length <= 0)
                    {
                        var row = 0,
                            col = 0,
                            rowCount = 1,
                            colCount = 1;
                        var spanCell = this._getSpanModel().find(row, col);
                        if (spanCell)
                        {
                            rowCount = spanCell.rowCount;
                            colCount = spanCell.colCount
                        }
                        selectionModel.add(row, col, rowCount, colCount);
                        self._activeRowIndex = row;
                        self._activeColIndex = col;
                        self._activeRowCount = rowCount;
                        self._activeColCount = colCount;
                        self._leadingCellRow = row;
                        self._leadingCellCol = col;
                        if (selectionModel.length > 0 && !self._paintSuspended)
                        {
                            var currentSelection = selectionModel[0];
                            self._render.repaintSelection(currentSelection)
                        }
                    }
                };
                Sheet.prototype._isResizeInfoEqual = function(newResizeInfo, oldResizeInfo)
                {
                    var equal = false;
                    if (!newResizeInfo && !oldResizeInfo)
                    {
                        equal = true
                    }
                    else if (newResizeInfo && oldResizeInfo)
                    {
                        equal = newResizeInfo.action === oldResizeInfo.action && newResizeInfo.index === oldResizeInfo.index && newResizeInfo.sheetArea === oldResizeInfo.sheetArea
                    }
                    return equal
                };
                Sheet.prototype._setHoverCell = function(target)
                {
                    var self = this;
                    var hoveredCellChanged = false;
                    var current = self._currentTarget;
                    if (!current)
                    {
                        hoveredCellChanged = true
                    }
                    if (!hoveredCellChanged && !target)
                    {
                        hoveredCellChanged = true
                    }
                    if (!hoveredCellChanged)
                    {
                        hoveredCellChanged = (target.col !== current.col || target.row !== current.row || target.colViewportIndex !== current.colViewportIndex || target.rowViewportIndex !== current.rowViewportIndex || target.hitTestType !== current.hitTestType || !self._isResizeInfoEqual(target.resizeInfo, current.resizeInfo))
                    }
                    self._currentTarget = target;
                    var adjX,
                        adjY,
                        gl;
                    if (hoveredCellChanged)
                    {
                        self._hoverCell = true;
                        var sheetLayout = self._getSheetLayout(),
                            render = self._render;
                        var r = keyword_null;
                        if (current)
                        {
                            if (current.rowViewportIndex < 0 || current.colViewportIndex < 0)
                            {
                                r = self.getCellRect(current.row, current.col, current.rowViewportIndex, current.colViewportIndex);
                                if (r && r.width > 0 && r.height > 0)
                                {
                                    adjX = 0;
                                    adjY = 0;
                                    gl = self._getGroupLayout();
                                    if (gl)
                                    {
                                        adjX = gl.width;
                                        adjY = gl.height
                                    }
                                    if (r.x < sheetLayout.rowHeaderWidth + adjX || r.y < sheetLayout.colHeaderHeight + adjY || r.y >= sheetLayout.height - sheetLayout.footerHeight)
                                    {
                                        render.update(r.x, r.y, r.width, r.height)
                                    }
                                }
                            }
                        }
                        if (target)
                        {
                            if (target.rowViewportIndex < 0 || target.colViewportIndex < 0)
                            {
                                r = self.getCellRect(target.row, target.col, target.rowViewportIndex, target.colViewportIndex);
                                if (r && r.width > 0 && r.height > 0)
                                {
                                    adjX = 0;
                                    adjY = 0;
                                    gl = self._getGroupLayout();
                                    if (gl)
                                    {
                                        adjX = gl.width;
                                        adjY = gl.height
                                    }
                                    if (r.x < sheetLayout.rowHeaderWidth + adjX || r.y < sheetLayout.colHeaderHeight + adjY || r.y >= sheetLayout.height - sheetLayout.footerHeight)
                                    {
                                        render.update(r.x, r.y, r.width, r.height)
                                    }
                                }
                            }
                        }
                        self._hoverCell = false
                    }
                };
                Sheet.prototype._getAvailableActiveCell = function(row, col, isHorizontal)
                {
                    var range = this._skipSpanCell(row, col, isHorizontal);
                    return this._skipInvisibleCell(range)
                };
                Sheet.prototype._skipSpanCell = function(row, col, isHorizontal)
                {
                    var spanCell = this._getSpanModel().find(row, col);
                    if (!spanCell)
                    {
                        return new Sheets.Range(row, col, 1, 1)
                    }
                    else
                    {
                        if ((isHorizontal && spanCell.rowCount === 1) || (!isHorizontal && spanCell.colCount === 1))
                        {
                            return spanCell
                        }
                    }
                    if (isHorizontal)
                    {
                        col++
                    }
                    else
                    {
                        row++
                    }
                    return this._skipSpanCell(row, col, isHorizontal)
                };
                Sheet.prototype._skipInvisibleCell = function(range)
                {
                    var self = this;
                    var row = range.row,
                        i;
                    var rowCount = self.getRowCount();
                    for (i = row; i < rowCount; i++)
                    {
                        if (self.getRowVisible(i) === true)
                        {
                            break
                        }
                    }
                    if (i < rowCount)
                    {
                        row = i
                    }
                    var col = range.col;
                    var columnCount = self.getColumnCount();
                    for (i = col; i < columnCount; i++)
                    {
                        if (self.getColumnVisible(i) === true)
                        {
                            break
                        }
                    }
                    if (i < columnCount)
                    {
                        col = i
                    }
                    return new Sheets.Range(row, col, range.rowCount, range.colCount)
                };
                Sheet.prototype._processKeyMap = function(event)
                {
                    var ctrlKey = event.ctrlKey,
                        shiftKey = event.shiftKey,
                        altKey = event.altKey,
                        metaKey = event.metaKey,
                        keyCode = event.keyCode;
                    var ka = this._getKeyAction(keyCode, ctrlKey, shiftKey, altKey, metaKey);
                    if (ka)
                    {
                        if (typeof(ka.action) === const_function)
                        {
                            var ret = ka.action.call(this);
                            if (ret)
                            {
                                Sheets.util.cancelDefault(event)
                            }
                            return ret
                        }
                    }
                    return false
                };
                Sheet.prototype._processFloatingObjectsKeyMap = function(event)
                {
                    if (!Sheets.features.floatingObject)
                    {
                        return false
                    }
                    var isUndoRedo = ((event.keyCode === 90 && event.ctrlKey === true) || (event.keyCode === 89 && event.ctrlKey === true));
                    if (isUndoRedo)
                    {
                        return false
                    }
                    var self = this,
                        eventHandler = self._eventHandler;
                    var isPaste = (event.keyCode === 86 && event.ctrlKey === true);
                    var ch = self._getFloatingObjectClipboardHelper();
                    var fromSheet = ch.fromSheet,
                        fromSheetEventHandler = fromSheet && fromSheet._eventHandler;
                    if (eventHandler || (fromSheetEventHandler))
                    {
                        var clipboardData = eventHandler._getClipboardFloatingObjectData();
                        if (!clipboardData && fromSheetEventHandler)
                        {
                            clipboardData = fromSheetEventHandler._getClipboardFloatingObjectData()
                        }
                        if (!clipboardData || !clipboardData.length)
                        {
                            isPaste = false
                        }
                    }
                    if (self._hasFloatingObjectsSelected() || isPaste)
                    {
                        var ka = self._getFloatingObjectKeyAction(event.keyCode, event.ctrlKey, event.shiftKey, event.altKey, event.metaKey);
                        if (ka && ka.action)
                        {
                            var ret = ka.action.call(self);
                            if (ret)
                            {
                                Sheets.util.cancelDefault(event)
                            }
                            return true
                        }
                    }
                    return false
                };
                Sheet.prototype._processCommentKeyMap = function(event)
                {
                    if (!Sheets.features.comment)
                    {
                        return false
                    }
                    var isUndoRedo = ((event.keyCode === 90 && event.ctrlKey === true) || (event.keyCode === 89 && event.ctrlKey === true));
                    if (isUndoRedo)
                    {
                        return false
                    }
                    var self = this,
                        activeComment = self._commentManager.getActiveComment();
                    if (activeComment)
                    {
                        if (event.keyCode === 9)
                        {
                            Sheets.util.cancelDefault(event);
                            return true
                        }
                        var ka = self._getCommentKeyAction(event.keyCode, event.ctrlKey, event.shiftKey, event.altKey, event.metaKey);
                        if (ka && ka.action)
                        {
                            var ret = ka.action.call(self);
                            if (ret)
                            {
                                Sheets.util.cancelDefault(event)
                            }
                            return true
                        }
                        else if (self._eventHandler.allowEnterEditing(event))
                        {
                            activeComment.commentState(2);
                            return true
                        }
                    }
                    return false
                };
                Sheet.prototype._hasFloatingObjectsSelected = function()
                {
                    var self = this,
                        floatingObjectArray = self._floatingObjectArray;
                    if (Sheets.features.floatingObject && floatingObjectArray && floatingObjectArray.length > 0)
                    {
                        var i,
                            len;
                        for (i = 0, len = floatingObjectArray.length; i < len; i++)
                        {
                            var item = floatingObjectArray[i];
                            if (item.isSelected())
                            {
                                return true
                            }
                        }
                    }
                    return false
                };
                Sheet.prototype._getZoomRowHeight = function(row, sheetArea)
                {
                    var height = this.getRowHeight(row, sheetArea),
                        zoomFactor = this._zoomFactor;
                    if (zoomFactor !== 1)
                    {
                        height *= zoomFactor
                    }
                    return Math_floor(height)
                };
                Sheet.prototype._getZoomColumnWidth = function(col, sheetArea)
                {
                    var width = this.getColumnWidth(col, sheetArea),
                        zoomFactor = this._zoomFactor;
                    if (zoomFactor !== 1)
                    {
                        width *= zoomFactor
                    }
                    return Math_floor(width)
                };
                Sheet.prototype._getGroupLayout = function()
                {
                    var self = this;
                    if (!self._cachedGroupLayout)
                    {
                        self._cachedGroupLayout = self._createGroupLayout()
                    }
                    return self._cachedGroupLayout
                };
                Sheet.prototype._getGroupButtonWidth = function()
                {
                    return 17
                };
                Sheet.prototype._getGroupButtonHeight = function()
                {
                    return 17
                };
                Sheet.prototype._getGroupPadding = function()
                {
                    return 2
                };
                Sheet.prototype._createGroupLayout = function()
                {
                    var groupLayout = {
                            x: 0, y: 0, width: 0, height: 0, rowMaxLevel: -1, colMaxLevel: -1
                        },
                        self = this,
                        GROUPBUTTON_WIDTH = self._getGroupButtonWidth(),
                        GROUPBUTTON_HEIGHT = self._getGroupButtonHeight(),
                        GROUPPADDING = self._getGroupPadding(),
                        rowRangeGroup = self.rowRangeGroup,
                        colRangeGroup = self.colRangeGroup,
                        showRowRangeGroup = self._showRowRangeGroup,
                        showColumnRangeGroup = self._showColumnRangeGroup,
                        zoomFactor = self._zoomFactor;
                    if (showRowRangeGroup && rowRangeGroup && !rowRangeGroup._isEmpty())
                    {
                        var rowMaxLevel = rowRangeGroup.getMaxLevel();
                        if (rowMaxLevel >= 0)
                        {
                            var width = Math_min(GROUPBUTTON_WIDTH, GROUPBUTTON_WIDTH * zoomFactor);
                            groupLayout.width = width * (rowMaxLevel + 2) + GROUPPADDING * 2;
                            groupLayout.rowMaxLevel = rowMaxLevel
                        }
                    }
                    if (showColumnRangeGroup && colRangeGroup && !colRangeGroup._isEmpty())
                    {
                        var colMaxLevel = colRangeGroup.getMaxLevel();
                        if (colMaxLevel >= 0)
                        {
                            var height = Math_min(GROUPBUTTON_HEIGHT, GROUPBUTTON_HEIGHT * zoomFactor);
                            groupLayout.height = height * (colMaxLevel + 2) + GROUPPADDING * 2;
                            groupLayout.colMaxLevel = colMaxLevel
                        }
                    }
                    return groupLayout
                };
                Sheet.prototype._createLayout = function()
                {
                    var self = this;
                    var bounds = new Sheets.Rect(self._bounds.x + self.borderWidth, self._bounds.y + self.borderWidth, Math_max(0, self._bounds.width - 2 * self.borderWidth), Math_max(0, self._bounds.height - 2 * self.borderWidth));
                    var totalWidth = bounds.width;
                    var totalHeight = bounds.height;
                    var layout = {
                            x: bounds.x, y: bounds.y, width: bounds.width, height: bounds.height, rowHeaderWidth: 0, colHeaderHeight: 0, frozenWidth: 0, frozenHeight: 0, frozenTrailingWidth: 0, frozenTrailingHeight: 0, footerHeight: 0, footerWidth: 0, footerX: 0, footerY: 0, frozenX: 0, frozenY: 0, frozenTrailingX: 0, frozenTrailingY: 0, viewportX: 0, viewportY: 0, viewportHeight: 0, viewportWidth: 0, headerX: 0, headerY: 0, headerCornerRect: function()
                                {
                                    var owner = this;
                                    return new Sheets.Rect(owner.x, owner.y, owner.rowHeaderWidth, owner.colHeaderHeight)
                                }, colHeaderRect: function(colViewportIndex)
                                {
                                    var owner = this;
                                    if (colViewportIndex === 0)
                                    {
                                        return new Sheets.Rect(owner.frozenX, owner.y, owner.frozenWidth, owner.colHeaderHeight)
                                    }
                                    else if (colViewportIndex === 1)
                                    {
                                        return new Sheets.Rect(owner.viewportX, owner.y, owner.viewportWidth, owner.colHeaderHeight)
                                    }
                                    else if (colViewportIndex === 2)
                                    {
                                        return new Sheets.Rect(owner.frozenTrailingX, owner.y, owner.frozenTrailingWidth, owner.colHeaderHeight)
                                    }
                                    else
                                    {
                                        return keyword_null
                                    }
                                }, rowHeaderRect: function(rowViewportIndex)
                                {
                                    var owner = this;
                                    if (rowViewportIndex === 0)
                                    {
                                        return new Sheets.Rect(owner.x, owner.frozenY, owner.rowHeaderWidth, owner.frozenHeight)
                                    }
                                    else if (rowViewportIndex === 1)
                                    {
                                        return new Sheets.Rect(owner.x, owner.viewportY, owner.rowHeaderWidth, owner.viewportHeight)
                                    }
                                    else if (rowViewportIndex === 2)
                                    {
                                        return new Sheets.Rect(owner.x, owner.frozenTrailingY, owner.rowHeaderWidth, owner.frozenTrailingHeight)
                                    }
                                    else
                                    {
                                        return keyword_null
                                    }
                                }, viewportRect: function(rowViewportIndex, colViewportIndex)
                                {
                                    var owner = this;
                                    if (rowViewportIndex === 0)
                                    {
                                        if (colViewportIndex === 0)
                                        {
                                            return new Sheets.Rect(owner.frozenX, owner.frozenY, owner.frozenWidth, owner.frozenHeight)
                                        }
                                        else if (colViewportIndex === 1)
                                        {
                                            return new Sheets.Rect(owner.viewportX, owner.frozenY, owner.viewportWidth, owner.frozenHeight)
                                        }
                                        else if (colViewportIndex === 2)
                                        {
                                            return new Sheets.Rect(owner.frozenTrailingX, owner.frozenY, owner.frozenTrailingWidth, owner.frozenHeight)
                                        }
                                        else
                                        {
                                            return keyword_null
                                        }
                                    }
                                    else if (rowViewportIndex === 1)
                                    {
                                        if (colViewportIndex === 0)
                                        {
                                            return new Sheets.Rect(owner.frozenX, owner.viewportY, owner.frozenWidth, owner.viewportHeight)
                                        }
                                        else if (colViewportIndex === 1)
                                        {
                                            return new Sheets.Rect(owner.viewportX, owner.viewportY, owner.viewportWidth, owner.viewportHeight)
                                        }
                                        else if (colViewportIndex === 2)
                                        {
                                            return new Sheets.Rect(owner.frozenTrailingX, owner.viewportY, owner.frozenTrailingWidth, owner.viewportHeight)
                                        }
                                        else
                                        {
                                            return keyword_null
                                        }
                                    }
                                    else if (rowViewportIndex === 2)
                                    {
                                        if (colViewportIndex === 0)
                                        {
                                            return new Sheets.Rect(owner.frozenX, owner.frozenTrailingY, owner.frozenWidth, owner.frozenTrailingHeight)
                                        }
                                        else if (colViewportIndex === 1)
                                        {
                                            return new Sheets.Rect(owner.viewportX, owner.frozenTrailingY, owner.viewportWidth, owner.frozenTrailingHeight)
                                        }
                                        else if (colViewportIndex === 2)
                                        {
                                            return new Sheets.Rect(owner.frozenTrailingX, owner.frozenTrailingY, owner.frozenTrailingWidth, owner.frozenTrailingHeight)
                                        }
                                        else
                                        {
                                            return keyword_null
                                        }
                                    }
                                    else
                                    {
                                        return keyword_null
                                    }
                                }, footerRect: function(colViewportIndex)
                                {
                                    var owner = this;
                                    if (colViewportIndex === 0)
                                    {
                                        return new Sheets.Rect(owner.frozenX, owner.footerY, owner.frozenWidth, owner.footerHeight)
                                    }
                                    else if (colViewportIndex === 1)
                                    {
                                        return new Sheets.Rect(owner.viewportX, owner.footerY, owner.viewportWidth, owner.footerHeight)
                                    }
                                    else if (colViewportIndex === 2)
                                    {
                                        return new Sheets.Rect(owner.frozenTrailingX, owner.footerY, owner.frozenTrailingWidth, owner.footerHeight)
                                    }
                                    else
                                    {
                                        return keyword_null
                                    }
                                }, footerCornerRect: function()
                                {
                                    var owner = this;
                                    return new Sheets.Rect(owner.footerX, owner.footerY, owner.footerWidth, owner.footerHeight)
                                }
                        };
                    var groupLayout = self._getGroupLayout();
                    layout.x += groupLayout.width;
                    layout.y += groupLayout.height;
                    totalWidth -= groupLayout.width;
                    totalHeight -= groupLayout.height;
                    var r,
                        rc,
                        c,
                        cc;
                    if (self.rowHeaderVisible === keyword_null || self.rowHeaderVisible === keyword_undefined || self.rowHeaderVisible)
                    {
                        cc = self.getColumnCount(2);
                        for (c = 0; c < cc; c++)
                        {
                            layout.rowHeaderWidth += self._getZoomColumnWidth(c, 2)
                        }
                    }
                    if (self.colHeaderVisible === keyword_null || self.colHeaderVisible === keyword_undefined || self.colHeaderVisible)
                    {
                        rc = self.getRowCount(1);
                        for (r = 0; r < rc; r++)
                        {
                            layout.colHeaderHeight += self._getZoomRowHeight(r, 1)
                        }
                    }
                    if (self.frozenColCount > 0)
                    {
                        cc = self.getColumnCount();
                        for (c = 0; c < self.frozenColCount && c < cc; c++)
                        {
                            if (self.getColumnVisible(c))
                            {
                                layout.frozenWidth += self._getZoomColumnWidth(c)
                            }
                        }
                    }
                    if (self.frozenRowCount > 0)
                    {
                        rc = self.getRowCount();
                        for (r = 0; r < self.frozenRowCount && r < rc; r++)
                        {
                            if (self.getRowVisible(r))
                            {
                                layout.frozenHeight += self._getZoomRowHeight(r)
                            }
                        }
                    }
                    if (self._frozenTrailingColCount > 0)
                    {
                        cc = self.getColumnCount();
                        for (c = Math_max(self.frozenColCount, cc - self._frozenTrailingColCount); c < cc; c++)
                        {
                            layout.frozenTrailingWidth += self._getZoomColumnWidth(c)
                        }
                    }
                    if (self._frozenTrailingRowCount > 0)
                    {
                        rc = self.getRowCount();
                        for (r = Math_max(self.frozenRowCount, rc - self._frozenTrailingRowCount); r < rc; r++)
                        {
                            layout.frozenTrailingHeight += self._getZoomRowHeight(r)
                        }
                    }
                    totalWidth -= layout.rowHeaderWidth;
                    totalHeight -= layout.colHeaderHeight;
                    totalWidth -= layout.frozenWidth;
                    totalHeight -= layout.frozenHeight;
                    totalWidth -= layout.frozenTrailingWidth;
                    totalHeight -= layout.frozenTrailingHeight;
                    totalHeight -= layout.footerHeight;
                    layout.viewportWidth = Math_max(0, totalWidth);
                    layout.viewportHeight = Math_max(0, totalHeight);
                    layout.headerX = layout.x;
                    layout.headerY = layout.y;
                    layout.frozenX = layout.headerX + layout.rowHeaderWidth;
                    layout.frozenY = layout.headerY + layout.colHeaderHeight;
                    layout.viewportX = layout.frozenX + layout.frozenWidth;
                    layout.viewportY = layout.frozenY + layout.frozenHeight;
                    layout.frozenTrailingX = layout.viewportX + layout.viewportWidth;
                    layout.frozenTrailingY = layout.viewportY + layout.viewportHeight;
                    layout.footerX = layout.headerX;
                    layout.footerY = layout.y + layout.height - layout.footerHeight;
                    return layout
                };
                Sheet.prototype._getSheetLayout = function()
                {
                    var self = this;
                    if (!self._layoutModel)
                    {
                        self._layoutModel = self._createLayout()
                    }
                    return self._layoutModel
                };
                Sheet.prototype._getColumnLayout = function(colViewportIndex, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null || sheetArea === 3 || sheetArea === 1)
                    {
                        return this._getViewportColumnLayout(colViewportIndex)
                    }
                    else if (sheetArea === 2)
                    {
                        return this._getRowHeaderColumnLayout()
                    }
                    return keyword_null
                };
                Sheet.prototype._getRowHeaderColumnLayout = function()
                {
                    var self = this;
                    if (!self._colLayoutCache.rowHeader)
                    {
                        self._colLayoutCache.rowHeader = self._createRowHeaderColumnLayout()
                    }
                    return self._colLayoutCache.rowHeader
                };
                Sheet.prototype._getViewportColumnLayout = function(colViewportIndex)
                {
                    var self = this;
                    if (!self._colLayoutCache.viewport)
                    {
                        self._colLayoutCache.viewport = {}
                    }
                    if (!self._colLayoutCache.viewport[colViewportIndex])
                    {
                        self._colLayoutCache.viewport[colViewportIndex] = self._createViewportColumnLayout(colViewportIndex)
                    }
                    return self._colLayoutCache.viewport[colViewportIndex]
                };
                Sheet.prototype._createRowHeaderColumnLayout = function()
                {
                    var colLayouts = new Sheets._LayoutModel;
                    var layout = this._getSheetLayout();
                    var colX = layout.headerX,
                        colWidth;
                    var colCount = this.getColumnCount(2);
                    for (var col = 0; col < colCount; col++)
                    {
                        colWidth = this._getZoomColumnWidth(col, 2);
                        colLayouts.push(new Sheets._Layout(-1, col, colX, -1, colWidth, -1));
                        colX += colWidth
                    }
                    return colLayouts
                };
                Sheet.prototype._createViewportColumnLayout = function(colViewportIndex)
                {
                    var self = this;
                    var colLayouts = new Sheets._LayoutModel;
                    var layout = self._getSheetLayout();
                    var colCount = self.getColumnCount(),
                        col,
                        colX,
                        colWidth,
                        cachePool = self._cachePool;
                    if (colViewportIndex === 0)
                    {
                        colX = layout.frozenX;
                        colCount = isNaN(self.frozenColCount) ? 0 : Math_min(self.frozenColCount, colCount);
                        for (col = 0; col < colCount; col++)
                        {
                            colWidth = cachePool.getZoomColWidth(col);
                            colLayouts.push(new Sheets._Layout(-1, col, colX, -1, colWidth, -1));
                            colX += colWidth
                        }
                    }
                    else if (colViewportIndex === 1)
                    {
                        colX = layout.viewportX;
                        colCount = colCount - self._frozenTrailingColCount;
                        var viewportWidth = layout.viewportWidth;
                        var leftCol = Math_max(self.frozenColCount, self._scrollLeftCol);
                        for (col = leftCol; (viewportWidth > 0 && col < colCount); col++)
                        {
                            colWidth = cachePool.getZoomColWidth(col);
                            colLayouts.push(new Sheets._Layout(-1, col, colX, -1, colWidth, -1));
                            colX += colWidth;
                            viewportWidth -= colWidth
                        }
                    }
                    else if (colViewportIndex === 2)
                    {
                        colX = layout.frozenTrailingX;
                        for (col = Math_max(self.frozenColCount, colCount - self._frozenTrailingColCount); col < colCount; col++)
                        {
                            colWidth = cachePool.getZoomColWidth(col);
                            colLayouts.push(new Sheets._Layout(-1, col, colX, -1, colWidth, -1));
                            colX += colWidth
                        }
                    }
                    return colLayouts
                };
                Sheet.prototype._getRowLayout = function(rowViewportIndex, sheetArea)
                {
                    if (typeof(sheetArea) === const_undefined || sheetArea === keyword_null || sheetArea === 3 || sheetArea === 2)
                    {
                        return this._getViewportRowLayout(rowViewportIndex)
                    }
                    else if (sheetArea === 1)
                    {
                        return this._getColumnHeaderRowLayout()
                    }
                    return keyword_null
                };
                Sheet.prototype._getAllRowLayout = function(sheetArea)
                {
                    var rowLayout = new Sheets._LayoutModel;
                    for (var index = 0; index < 3; index++)
                    {
                        var layout = this._getRowLayout(index, sheetArea);
                        if (layout && layout.length > 0)
                        {
                            rowLayout = ($.merge(rowLayout, layout))
                        }
                    }
                    return rowLayout
                };
                Sheet.prototype._getAllColumnLayout = function(sheetArea)
                {
                    var columnLayout = new Sheets._LayoutModel;
                    for (var index = 0; index < 3; index++)
                    {
                        var layout = this._getColumnLayout(index, sheetArea);
                        if (layout && layout.length > 0)
                        {
                            columnLayout = ($.merge(columnLayout, layout))
                        }
                    }
                    return columnLayout
                };
                Sheet.prototype._getColumnHeaderRowLayout = function()
                {
                    var self = this;
                    if (!self._rowLayoutCache.colHeader)
                    {
                        self._rowLayoutCache.colHeader = self._createColumnHeaderRowLayout()
                    }
                    return self._rowLayoutCache.colHeader
                };
                Sheet.prototype._getViewportRowLayout = function(viewportIndex)
                {
                    var self = this;
                    if (!self._rowLayoutCache.viewport)
                    {
                        self._rowLayoutCache.viewport = {}
                    }
                    if (!self._rowLayoutCache.viewport[viewportIndex])
                    {
                        self._rowLayoutCache.viewport[viewportIndex] = self._createViewportRowLayout(viewportIndex)
                    }
                    return self._rowLayoutCache.viewport[viewportIndex]
                };
                Sheet.prototype._createColumnHeaderRowLayout = function()
                {
                    var rowLayouts = new Sheets._LayoutModel;
                    var layout = this._getSheetLayout();
                    var rowY = layout.headerY,
                        rowHeight;
                    var rowCount = this.getRowCount(1);
                    for (var row = 0; row < rowCount; row++)
                    {
                        rowHeight = this._getZoomRowHeight(row, 1);
                        rowLayouts.push(new Sheets._Layout(row, -1, -1, rowY, -1, rowHeight));
                        rowY += rowHeight
                    }
                    return rowLayouts
                };
                Sheet.prototype._createViewportRowLayout = function(rowViewportIndex)
                {
                    var self = this;
                    var rowLayouts = new Sheets._LayoutModel;
                    var layout = self._getSheetLayout();
                    var rowCount = self.getRowCount(),
                        row,
                        rowY,
                        rowHeight,
                        cachePool = self._cachePool;
                    if (rowViewportIndex === 0)
                    {
                        rowY = layout.frozenY;
                        rowCount = isNaN(self.frozenRowCount) ? 0 : Math_min(self.frozenRowCount, rowCount);
                        for (row = 0; row < rowCount; row++)
                        {
                            rowHeight = cachePool.getZoomRowHeight(row);
                            rowLayouts.push(new Sheets._Layout(row, -1, -1, rowY, -1, rowHeight));
                            rowY += rowHeight
                        }
                    }
                    else if (rowViewportIndex === 1)
                    {
                        rowY = layout.viewportY;
                        rowCount = rowCount - self._frozenTrailingRowCount;
                        var viewportHeight = layout.viewportHeight;
                        var topRow = Math_max(self.frozenRowCount, self._scrollTopRow);
                        for (row = topRow; (viewportHeight > 0 && row < rowCount); row++)
                        {
                            rowHeight = cachePool.getZoomRowHeight(row);
                            rowLayouts.push(new Sheets._Layout(row, -1, -1, rowY, -1, rowHeight));
                            rowY += rowHeight;
                            viewportHeight -= rowHeight
                        }
                    }
                    else if (rowViewportIndex === 2)
                    {
                        rowY = layout.frozenTrailingY;
                        for (row = Math_max(self.frozenRowCount, rowCount - self._frozenTrailingRowCount); row < rowCount; row++)
                        {
                            rowHeight = cachePool.getZoomRowHeight(row);
                            rowLayouts.push(new Sheets._Layout(row, -1, -1, rowY, -1, rowHeight));
                            rowY += rowHeight
                        }
                    }
                    return rowLayouts
                };
                Sheet.prototype._getCellLayout = function(rowViewportIndex, colViewportIndex, sheetArea)
                {
                    var self = this;
                    var rowCount = self.getRowCount(sheetArea);
                    var colCount = self.getColumnCount(sheetArea);
                    var rowLayoutModel = self._getRowLayout(rowViewportIndex, sheetArea);
                    var colLayoutModel = self._getColumnLayout(colViewportIndex, sheetArea);
                    var cellLayoutModel = new Sheets._LayoutModel;
                    if (rowLayoutModel && rowLayoutModel.length > 0 && colLayoutModel && colLayoutModel.length > 0)
                    {
                        var topRow = rowLayoutModel[0].row;
                        var leftCol = colLayoutModel[0].col;
                        var bottomRow = rowLayoutModel[rowLayoutModel.length - 1].row;
                        var rightCol = colLayoutModel[colLayoutModel.length - 1].col;
                        var spans = self.getSpans(new Sheets.Range(topRow, leftCol, bottomRow - topRow + 1, rightCol - leftCol + 1), sheetArea);
                        if (spans && spans.length > 0)
                        {
                            self._addCellLayout(spans, topRow, leftCol, bottomRow, rightCol, cellLayoutModel, rowCount, colCount, sheetArea, rowLayoutModel, colLayoutModel)
                        }
                    }
                    return cellLayoutModel
                };
                Sheet.prototype._getCellLayoutByCell = function(rowViewportIndex, colViewportIndex, sheetArea, row, col)
                {
                    var self = this;
                    var rowCount = self.getRowCount(sheetArea);
                    var colCount = self.getColumnCount(sheetArea);
                    var rowLayoutModel = self._getRowLayout(rowViewportIndex, sheetArea);
                    var colLayoutModel = self._getColumnLayout(colViewportIndex, sheetArea);
                    var cellLayoutModel = new Sheets._LayoutModel;
                    if (rowLayoutModel && rowLayoutModel.length > 0 && colLayoutModel && colLayoutModel.length > 0)
                    {
                        var topRow = rowLayoutModel[0].row;
                        var leftCol = colLayoutModel[0].col;
                        var spanCell = self.getSpan(row, col, sheetArea);
                        if (spanCell)
                        {
                            var spans = [];
                            spans.push(spanCell);
                            self._addCellLayout(spans, topRow, leftCol, spanCell.row + spanCell.rowCount, spanCell.col + spanCell.colCount, cellLayoutModel, rowCount, colCount, sheetArea, rowLayoutModel, colLayoutModel)
                        }
                        if (cellLayoutModel.length > 0)
                        {
                            return cellLayoutModel[0]
                        }
                        return keyword_null
                    }
                    return keyword_null
                };
                Sheet.prototype._addCellLayout = function(spans, topRow, leftCol, bottomRow, rightCol, cellLayoutModel, rowCount, colCount, sheetArea, rowLayoutModel, colLayoutModel)
                {
                    var spanCount = spans.length;
                    if (spanCount <= 0)
                    {
                        return
                    }
                    var self = this;
                    var lastRow = bottomRow + 1;
                    var lastCol = rightCol + 1;
                    var heights = new Array(lastRow);
                    var widths = new Array(lastCol);
                    var xs = new Array(lastCol);
                    var ys = new Array(lastRow);
                    var x = 0;
                    var y = 0;
                    for (var i = topRow - 1; i >= 0; i--)
                    {
                        heights[i] = self._getZoomRowHeight(i, sheetArea);
                        y -= heights[i];
                        ys[i] = y
                    }
                    y = 0;
                    for (var i = topRow; i < lastRow; i++)
                    {
                        ys[i] = y;
                        heights[i] = self._getZoomRowHeight(i, sheetArea);
                        y += heights[i]
                    }
                    for (var i = leftCol - 1; i >= 0; i--)
                    {
                        widths[i] = self._getZoomColumnWidth(i, sheetArea);
                        x -= widths[i];
                        xs[i] = x
                    }
                    x = 0;
                    for (var i = leftCol; i < lastCol; i++)
                    {
                        xs[i] = x;
                        widths[i] = self._getZoomColumnWidth(i, sheetArea);
                        x += widths[i]
                    }
                    for (var k = 0; k < spanCount; k++)
                    {
                        var cellSpan = spans[k];
                        if (cellSpan.intersect(topRow, leftCol, bottomRow - topRow + 1, rightCol - leftCol + 1))
                        {
                            var lastRow1 = cellSpan.row + cellSpan.rowCount;
                            if (lastRow1 > lastRow)
                            {
                                for (var i = lastRow; i < lastRow1; i++)
                                {
                                    heights.push(self._getZoomRowHeight(i, sheetArea));
                                    ys.push(ys[i - 1] + heights[i])
                                }
                                lastRow = lastRow1
                            }
                            var lastCol1 = cellSpan.col + cellSpan.colCount;
                            if (lastCol1 > lastCol)
                            {
                                for (var i = lastCol; i < lastCol1; i++)
                                {
                                    widths.push(self._getZoomColumnWidth(i, sheetArea));
                                    xs.push(xs[i - 1] + widths[i])
                                }
                                lastCol = lastCol1
                            }
                            var x = xs[cellSpan.col],
                                y = ys[cellSpan.row],
                                width = 0,
                                height = 0,
                                row,
                                col;
                            for (col = cellSpan.col; col < cellSpan.col + cellSpan.colCount && col < colCount; col++)
                                width += widths[col];
                            for (row = cellSpan.row; row < cellSpan.row + cellSpan.rowCount && row < rowCount; row++)
                                height += heights[row];
                            cellLayoutModel.push(new Sheets._Layout(cellSpan.row, cellSpan.col, colLayoutModel[0].x + x, rowLayoutModel[0].y + y, width, height, cellSpan.rowCount, cellSpan.colCount))
                        }
                    }
                };
                Sheet.prototype._getRowViewportIndexNearY = function(y)
                {
                    var layout = this._getSheetLayout();
                    if (this.frozenRowCount > 0 && y < layout.frozenY + layout.frozenHeight)
                    {
                        return 0
                    }
                    else if (this._frozenTrailingRowCount > 0 && y > layout.frozenTrailingY)
                    {
                        return 2
                    }
                    else
                    {
                        return 1
                    }
                };
                Sheet.prototype._getColumnViewportIndexNearX = function(x)
                {
                    var layout = this._getSheetLayout();
                    if (this.frozenColCount > 0 && x < layout.frozenX + layout.frozenWidth)
                    {
                        return 0
                    }
                    else if (this._frozenTrailingColCount > 0 && x > layout.frozenTrailingX)
                    {
                        return 2
                    }
                    else
                    {
                        return 1
                    }
                };
                Sheet.prototype._getViewportColumnLayoutNearX = function(columnViewportIndex, x)
                {
                    var colLayoutModel = this._getColumnLayout(columnViewportIndex);
                    if (colLayoutModel)
                    {
                        return colLayoutModel.findNearX(x)
                    }
                    return keyword_null
                };
                Sheet.prototype._getViewportRowLayoutNearY = function(rowViewportIndex, y)
                {
                    var rowLayoutModel = this._getRowLayout(rowViewportIndex);
                    if (rowLayoutModel)
                    {
                        return rowLayoutModel.findNearY(y)
                    }
                    return keyword_null
                };
                Sheet.prototype._syncHScollbarPosition = function()
                {
                    var self = this,
                        tempSpread = self.parent;
                    var newLefCol = self._getScrollableColumn(self._scrollLeftCol);
                    if (newLefCol !== -1 && newLefCol !== self._scrollLeftCol)
                    {
                        self._scrollLeftCol = newLefCol
                    }
                    if (tempSpread && tempSpread._scrollbarH)
                    {
                        tempSpread._scrollbarH.value(self._scrollLeftCol)
                    }
                };
                Sheet.prototype._syncVScrollbarPosition = function()
                {
                    var self = this,
                        tempSpread = self.parent;
                    var newTopRow = self._getScrollableRow(self._scrollTopRow);
                    if (newTopRow !== -1 && newTopRow !== self._scrollTopRow)
                    {
                        self._scrollTopRow = newTopRow
                    }
                    if (tempSpread && tempSpread._scrollbarV)
                    {
                        tempSpread._scrollbarV.value(self._scrollTopRow)
                    }
                };
                Sheet.prototype._syncHScrollbarSize = function()
                {
                    var self = this;
                    if (self.parent && self.parent._resizeHScrollBar)
                    {
                        self.parent._resizeHScrollBar()
                    }
                };
                Sheet.prototype._syncVScrollbarSize = function()
                {
                    var self = this;
                    if (self.parent && self.parent._resizeVScrollBar)
                    {
                        self.parent._resizeVScrollBar()
                    }
                };
                Sheet.prototype._getScrollableRow = function(startRow, previous)
                {
                    var self = this;
                    var min = self.getFrozenRowCount();
                    var max = self.getRowCount() - self.getFrozenTrailingRowCount() - 1;
                    if (previous)
                    {
                        if (startRow > max)
                        {
                            startRow = max
                        }
                        var newTopRow = self._getPrevVisualRow(startRow + 1);
                        if (newTopRow != keyword_null && newTopRow >= min)
                        {
                            return newTopRow
                        }
                    }
                    else
                    {
                        if (startRow < min)
                        {
                            startRow = min
                        }
                        var newTopRow = self._getNextVisualRow(startRow - 1);
                        if (newTopRow != keyword_null && newTopRow <= max)
                        {
                            return newTopRow
                        }
                    }
                    return -1
                };
                Sheet.prototype._getScrollableColumn = function(startCol, previous)
                {
                    var self = this;
                    var min = self.getFrozenColumnCount();
                    var max = self.getColumnCount() - self.getFrozenTrailingColumnCount() - 1;
                    if (previous)
                    {
                        if (startCol > max)
                        {
                            startCol = max
                        }
                        var newLeftCol = self._getPrevVisualColumn(startCol + 1);
                        if (newLeftCol != keyword_null && newLeftCol >= min)
                        {
                            return newLeftCol
                        }
                    }
                    else
                    {
                        if (startCol < min)
                        {
                            startCol = min
                        }
                        var newLeftCol = self._getNextVisualColumn(startCol - 1);
                        if (newLeftCol != keyword_null && newLeftCol <= max)
                        {
                            return newLeftCol
                        }
                    }
                    return -1
                };
                Sheet.prototype._getTopRowWhenLastRowShowComplete = function(viewportHeight, startRow, endRow)
                {
                    if (endRow < startRow)
                    {
                        return endRow
                    }
                    var totalHeight = 0,
                        cachePool = this._cachePool;
                    for (var row = endRow, topRow = endRow; row >= startRow; row--)
                    {
                        var rowHeight = cachePool.getZoomRowHeight(row);
                        if (rowHeight <= 0)
                        {
                            continue
                        }
                        totalHeight += rowHeight;
                        if (totalHeight > viewportHeight)
                        {
                            break
                        }
                        topRow = row
                    }
                    return topRow
                };
                Sheet.prototype._getBottomRowWhenFirstRowShowComplete = function(viewportHeight, startRow, endRow)
                {
                    if (endRow < startRow)
                    {
                        return endRow
                    }
                    var totalHeight = 0,
                        cachePool = this._cachePool;
                    for (var row = startRow, bottomRow = startRow; row <= endRow; row++)
                    {
                        var rowHeight = cachePool.getZoomRowHeight(row);
                        if (rowHeight <= 0)
                        {
                            continue
                        }
                        totalHeight += rowHeight;
                        if (totalHeight > viewportHeight)
                        {
                            break
                        }
                        bottomRow = row
                    }
                    return bottomRow
                };
                Sheet.prototype._getLeftColWhenLastColShowComplete = function(viewportWidth, startColumn, endColumn)
                {
                    if (endColumn < startColumn)
                    {
                        return endColumn
                    }
                    var totalWidth = 0,
                        cachePool = this._cachePool;
                    for (var col = endColumn, leftColumn = endColumn; col >= startColumn; col--)
                    {
                        var columnWidth = cachePool.getZoomColWidth(col);
                        if (columnWidth <= 0)
                        {
                            continue
                        }
                        totalWidth += columnWidth;
                        if (totalWidth > viewportWidth)
                        {
                            break
                        }
                        leftColumn = col
                    }
                    return leftColumn
                };
                Sheet.prototype._getRightColWhenFirstColShowComplete = function(viewportWidth, startColumn, endColumn)
                {
                    if (endColumn < startColumn)
                    {
                        return endColumn
                    }
                    var totalWidth = 0,
                        cachePool = this._cachePool;
                    for (var col = startColumn, rightColumn = startColumn; col <= endColumn; col++)
                    {
                        var columnWidth = cachePool.getZoomColWidth(col);
                        if (columnWidth <= 0)
                        {
                            continue
                        }
                        totalWidth += columnWidth;
                        if (totalWidth > viewportWidth)
                        {
                            break
                        }
                        rightColumn = col
                    }
                    return rightColumn
                };
                Sheet.prototype._getLastVisualScrollRow = function(sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this,
                        sp = self.parent,
                        startRow = self.frozenRowCount;
                    if (sp && sp._scrollbarMaxAlign)
                    {
                        var layout = self._getSheetLayout();
                        return self._getTopRowWhenLastRowShowComplete(layout.viewportHeight, startRow, self.getRowCount() - self._frozenTrailingRowCount - 1)
                    }
                    var rowCount = self.getRowCount(sheetArea);
                    if (sheetArea === 3 || sheetArea === 2)
                    {
                        rowCount = rowCount - self._frozenTrailingRowCount
                    }
                    var lastScrollRow = self._getPrevVisualRow(rowCount, sheetArea);
                    if (lastScrollRow === keyword_null)
                    {
                        lastScrollRow = startRow
                    }
                    return lastScrollRow
                };
                Sheet.prototype._getLastVisualScrollColumn = function(sheetArea)
                {
                    if (sheetArea === keyword_undefined || sheetArea === keyword_null)
                    {
                        sheetArea = 3
                    }
                    var self = this,
                        sp = self.parent,
                        startColumn = self.frozenColCount;
                    if (sp && sp._scrollbarMaxAlign)
                    {
                        var layout = self._getSheetLayout();
                        return self._getLeftColWhenLastColShowComplete(layout.viewportWidth, startColumn, self.getColumnCount() - self._frozenTrailingColCount - 1)
                    }
                    var colCount = self.getColumnCount(sheetArea);
                    if (sheetArea === 3 || sheetArea === 1)
                    {
                        colCount = colCount - self._frozenTrailingColCount
                    }
                    var lastScrollColumn = self._getPrevVisualColumn(colCount, sheetArea);
                    if (lastScrollColumn === keyword_null)
                    {
                        lastScrollColumn = startColumn
                    }
                    return lastScrollColumn
                };
                Sheet.prototype._getLastNonNullRowAndCol = function()
                {
                    var self = this,
                        lastNonNullRow = self.frozenRowCount,
                        lastNonNullCol = self.frozenColCount,
                        floatingObjectArray = self._floatingObjectArray,
                        maxRowIndex = self.getRowCount() - self._frozenTrailingRowCount - 1,
                        maxColIndex = self.getColumnCount() - self._frozenTrailingColCount - 1;
                    var sheetModelManager = self._sheetModelManager;
                    if (sheetModelManager)
                    {
                        var rowInfos = sheetModelManager.getRowInfos(3),
                            colInfos = sheetModelManager.getColInfos(3);
                        if (rowInfos && rowInfos._getItems())
                        {
                            var infos = rowInfos._getItems();
                            if (infos.length > 0 && infos.length - 1 > lastNonNullRow)
                            {
                                lastNonNullRow = infos.length - 1
                            }
                        }
                        if (colInfos && colInfos._getItems())
                        {
                            var infos = colInfos._getItems();
                            if (infos.length > 0 && infos.length - 1 > lastNonNullCol)
                            {
                                lastNonNullCol = infos.length - 1
                            }
                        }
                        var dataModel = sheetModelManager.getDataModel(3);
                        if (dataModel)
                        {
                            if (dataModel._lastNonNullRow > lastNonNullRow)
                            {
                                lastNonNullRow = dataModel._lastNonNullRow
                            }
                            if (dataModel._lastNonNullColumn > lastNonNullCol)
                            {
                                lastNonNullCol = dataModel._lastNonNullColumn
                            }
                        }
                        var rowHeaderModel = sheetModelManager.getDataModel(2);
                        if (rowHeaderModel)
                        {
                            if (rowHeaderModel._lastNonNullRow > lastNonNullRow)
                            {
                                lastNonNullRow = rowHeaderModel._lastNonNullRow
                            }
                        }
                        var colHeaderModel = sheetModelManager.getDataModel(1);
                        if (colHeaderModel)
                        {
                            if (colHeaderModel._lastNonNullColumn > lastNonNullCol)
                            {
                                lastNonNullCol = colHeaderModel._lastNonNullColumn
                            }
                        }
                    }
                    var spanModel = sheetModelManager.getSpanModel(3);
                    if (spanModel)
                    {
                        if (spanModel._lastNonNullRow > lastNonNullRow)
                        {
                            lastNonNullRow = spanModel._lastNonNullRow
                        }
                        if (spanModel._lastNonNullColumn > lastNonNullCol)
                        {
                            lastNonNullCol = spanModel._lastNonNullColumn
                        }
                    }
                    var rowHeaderSpanModel = sheetModelManager.getSpanModel(2);
                    if (rowHeaderSpanModel)
                    {
                        if (rowHeaderSpanModel._lastNonNullRow > lastNonNullRow)
                        {
                            lastNonNullRow = rowHeaderSpanModel._lastNonNullRow
                        }
                    }
                    var colHeaderSpanModel = sheetModelManager.getSpanModel(1);
                    if (colHeaderSpanModel)
                    {
                        if (colHeaderSpanModel._lastNonNullColumn > lastNonNullCol)
                        {
                            lastNonNullCol = colHeaderSpanModel._lastNonNullColumn
                        }
                    }
                    var tableManager = self._tableManager;
                    if (tableManager)
                    {
                        var tableList = tableManager.getTables();
                        if (tableList)
                        {
                            for (var i = 0, len = tableList.length; i < len; i++)
                            {
                                var table = tableList[i];
                                if (table)
                                {
                                    var range = table.range();
                                    if (range.row + range.rowCount - 1 > lastNonNullRow)
                                    {
                                        lastNonNullRow = range.row + range.rowCount - 1
                                    }
                                    if (range.col + range.colCount - 1 > lastNonNullCol)
                                    {
                                        lastNonNullCol = range.col + range.colCount - 1
                                    }
                                }
                            }
                        }
                    }
                    if (floatingObjectArray && floatingObjectArray.length > 0)
                    {
                        for (var i = 0, len = floatingObjectArray.length; i < len; i++)
                        {
                            var fo = floatingObjectArray[i];
                            if (fo)
                            {
                                if (fo.endRow() > lastNonNullRow)
                                {
                                    lastNonNullRow = fo.endRow()
                                }
                                if (fo.endColumn() > lastNonNullCol)
                                {
                                    lastNonNullCol = fo.endColumn()
                                }
                            }
                        }
                    }
                    var commentManager = self._commentManager;
                    if (commentManager)
                    {
                        var commentViewList = commentManager._commentViewList;
                        if (commentViewList && commentViewList.length > 0)
                        {
                            for (var i = 0, len = commentViewList.length; i < len; i++)
                            {
                                var cv = commentViewList[i];
                                if (cv && cv._comment)
                                {
                                    if (cv._endRow > lastNonNullRow)
                                    {
                                        lastNonNullRow = cv._endRow
                                    }
                                    if (cv._endColumn > lastNonNullCol)
                                    {
                                        lastNonNullCol = cv._endColumn
                                    }
                                }
                            }
                        }
                    }
                    if (lastNonNullRow > maxRowIndex)
                    {
                        lastNonNullRow = maxRowIndex
                    }
                    if (lastNonNullCol > maxColIndex)
                    {
                        lastNonNullCol = maxColIndex
                    }
                    var result = {
                            lastNonNullRow: lastNonNullRow, lastNonNullCol: lastNonNullCol
                        };
                    return result
                };
                Sheet.prototype._setTopRow = function(row)
                {
                    var self = this;
                    var oldTopRow = self._scrollTopRow;
                    if (row >= self._getFirstPageTopRow() && row <= self._getLastVisualScrollRow() && row !== oldTopRow)
                    {
                        self._eventHandler.vScrollTo(row);
                        self._syncVScrollbarPosition();
                        var sp = self.parent;
                        if (sp && !sp._scrollbarShowMax)
                        {
                            self._syncVScrollbarSize()
                        }
                        self.triggerTopRowChanged({
                            sheet: self, sheetName: self._name, oldTopRow: oldTopRow, newTopRow: row
                        })
                    }
                };
                Sheet.prototype._setLeftColumn = function(col)
                {
                    var self = this;
                    var oldLeftCol = self._scrollLeftCol;
                    if (col >= self._getFirstPageLeftColumn() && col <= self._getLastVisualScrollColumn() && col !== oldLeftCol)
                    {
                        self._eventHandler.hScrollTo(col);
                        self._syncHScollbarPosition();
                        var sp = self.parent;
                        if (sp && !sp._scrollbarShowMax)
                        {
                            self._syncHScrollbarSize()
                        }
                        self.triggerLeftColumnChanged({
                            sheet: self, sheetName: self._name, oldLeftCol: oldLeftCol, newLeftCol: col
                        })
                    }
                };
                Sheet.prototype._getSpanModel = function(sheetArea)
                {
                    return this._sheetModelManager.getSpanModel(sheetArea)
                };
                Sheet.prototype._clipboardFloatingObjectCopy = function(names, isCutting, ignoreClipboard)
                {
                    if (!Sheets.features.floatingObject)
                    {
                        return
                    }
                    var self = this;
                    var ch = self._getFloatingObjectClipboardHelper(),
                        fromSheet = ch.fromSheet,
                        fromSheetEventHandler = fromSheet && fromSheet._eventHandler;
                    if (fromSheetEventHandler)
                    {
                        fromSheetEventHandler._setClipboardFloatingObjectData(keyword_null)
                    }
                    ch.fromSheet = self;
                    ch.isCutting = isCutting;
                    var floatingObjects = new Sheets.NamedObjectArray;
                    for (var index = 0; index < names.length; index++)
                    {
                        var floatingObject = self._findFloatingObjectInternal(names[index]);
                        if (floatingObject)
                        {
                            floatingObjects.push(floatingObject)
                        }
                    }
                    self._eventHandler._setClipboardFloatingObjectData(floatingObjects)
                };
                Sheet.prototype._clipboardCopy = function(range, isCutting, ignoreClipboard)
                {
                    if (!range)
                    {
                        return
                    }
                    var columnDelimiter = "\t";
                    var rowDelimiter = "\r\n";
                    var cellDelimiter = "\"";
                    var self = this,
                        eventHandler = self._eventHandler;
                    var copyData = staticMembers.getRangeText(self, range.row, range.rowCount, range.col, range.colCount, rowDelimiter, columnDelimiter, cellDelimiter, false, 0);
                    var ch = self._getClipboardHelper();
                    ch.fromSheet = self;
                    ch.range = range;
                    ch.isCutting = isCutting;
                    try
                    {
                        var args = {
                                sheet: self, sheetName: self._name, copyData: copyData, cancel: false
                            };
                        self.triggerClipboardChanging(args);
                        if (args && args.cancel === false)
                        {
                            if (eventHandler && !ignoreClipboard)
                            {
                                eventHandler._switchFocusForClipboard(copyData)
                            }
                            self.triggerClipboardChanged({
                                sheet: self, sheetName: self._name, copyData: copyData
                            });
                            setTimeout(function()
                            {
                                if (eventHandler && !ignoreClipboard)
                                {
                                    eventHandler._switchBackFocusAfterClipboard()
                                }
                            }, 100)
                        }
                        else
                        {
                            ch.fromSheet = keyword_null;
                            ch.range = keyword_null
                        }
                    }
                    catch(e) {}
                    finally
                    {
                        return copyData
                    }
                };
                Sheet.prototype._trySearch = function(source, searchString, searchFlags)
                {
                    if (source)
                    {
                        var sf = Sheets.SearchFlags;
                        source = source.toString();
                        searchString = searchString.toString();
                        var exactMatch = ((searchFlags & 2) > 0);
                        if (exactMatch && ((searchFlags & 4) === 0))
                        {
                            if ((searchFlags & 1) > 0)
                            {
                                var sourceLower = source.toLowerCase();
                                var searchStringLower = searchString.toLowerCase();
                                return sourceLower === searchStringLower
                            }
                            else
                            {
                                return source === searchString
                            }
                        }
                        else
                        {
                            var ignoreCase = ((searchFlags & 1) > 0);
                            var useWildCards = ((searchFlags & 4) > 0);
                            var rgExp;
                            if (ignoreCase)
                            {
                                rgExp = new RegExp(fixFormulaKeyword(searchString, useWildCards, exactMatch), "i")
                            }
                            else
                            {
                                rgExp = new RegExp(fixFormulaKeyword(searchString, useWildCards, exactMatch))
                            }
                            var result = source.search(rgExp) > -1;
                            if (exactMatch && result && (searchString.search(/\*/) <= -1))
                            {
                                result = (source.length === searchString.length)
                            }
                            return result
                        }
                    }
                    return false
                };
                Sheet.prototype._getFilterButtonModel = function()
                {
                    var self = this;
                    if (!self._filterButtonsModel && Sheets.features.filter_ui)
                    {
                        self._filterButtonsModel = self._createFilterButtonModle()
                    }
                    return self._filterButtonsModel
                };
                Sheet.prototype._createFilterButtonModle = function()
                {
                    var self = this;
                    var filerBtnInfoModel = new Sheets._FilterButtonInfoModel;
                    var filter = self.rowFilter();
                    if (filter && filter.range)
                    {
                        var cr = filter.range;
                        var col = cr.col < 0 ? 0 : cr.col;
                        var endCol = cr.col < 0 ? self.getColumnCount() : cr.col + cr.colCount;
                        var row,
                            sheetArea;
                        if (cr.row < 1)
                        {
                            row = self.getRowCount(1) - 1;
                            sheetArea = 1
                        }
                        else
                        {
                            row = cr.row - 1;
                            sheetArea = 3
                        }
                        if (row >= 0)
                        {
                            while (col < endCol)
                            {
                                if (filter.filterButtonVisible && filter.filterButtonVisible(col))
                                {
                                    var btnInfo = new Sheets._FilterButtonInfo(filter);
                                    btnInfo.sheetArea = sheetArea;
                                    btnInfo.row = row;
                                    var spans = self.getSpans(new Sheets.Range(row, col, 1, 1), sheetArea);
                                    if (spans && spans.length > 0)
                                    {
                                        var spanCell = spans[0];
                                        btnInfo.row = spanCell.row;
                                        btnInfo.col = spanCell.col;
                                        col += spanCell.colCount
                                    }
                                    else
                                    {
                                        btnInfo.col = col;
                                        col++
                                    }
                                    filerBtnInfoModel.push(btnInfo)
                                }
                                else
                                {
                                    col++
                                }
                            }
                        }
                    }
                    var tables = self.getTables(),
                        count = (tables ? tables.length : 0),
                        tb;
                    for (var i = 0; i < count; i++)
                    {
                        tb = tables[i];
                        if (tb && tb.showHeader())
                        {
                            var row = tb.headerIndex();
                            if (row >= 0)
                            {
                                var cr = tb.range();
                                for (var j = 0; j < cr.colCount; j++)
                                {
                                    var col = cr.col + j;
                                    if (tb.rowFilter().filterButtonVisible(col))
                                    {
                                        var btnInfo = new Sheets._FilterButtonInfo(tb.rowFilter(), row, col, 3);
                                        filerBtnInfoModel.push(btnInfo)
                                    }
                                }
                            }
                        }
                    }
                    return filerBtnInfoModel
                };
                Sheet.prototype._getFilterButtonHitInfo = function(target, x, y)
                {
                    if (!Sheets.features.filter_ui)
                    {
                        return keyword_null
                    }
                    var self = this;
                    var rowViewportIndex = target.rowViewportIndex;
                    var colViewportIndex = target.colViewportIndex;
                    var rowLayout,
                        colLayout,
                        sheetArea;
                    if (target.hitTestType === 1)
                    {
                        rowLayout = self._getColumnHeaderRowLayout().findY(y);
                        colLayout = self._getViewportColumnLayout(colViewportIndex).findX(x);
                        sheetArea = 1
                    }
                    else if (target.hitTestType === 3)
                    {
                        rowLayout = self._getViewportRowLayout(rowViewportIndex).findY(y);
                        colLayout = self._getViewportColumnLayout(colViewportIndex).findX(x);
                        sheetArea = 3
                    }
                    if (!rowLayout || !colLayout)
                    {
                        return keyword_null
                    }
                    var row = rowLayout.row;
                    var col = colLayout.col;
                    var spanCell = self.getSpan(row, col, sheetArea);
                    if (spanCell)
                    {
                        if (row !== spanCell.row + spanCell.rowCount - 1 || col !== spanCell.col + spanCell.colCount - 1)
                        {
                            return keyword_null
                        }
                        row = spanCell.row;
                        col = spanCell.col
                    }
                    var btnInfo = self._getFilterButtonModel().find(row, col, sheetArea);
                    if (btnInfo)
                    {
                        var cellRect = self.getCellRect(row, col, rowViewportIndex, colViewportIndex);
                        var btnRect = self._render._getFilterButtonRect(cellRect);
                        if (btnRect.x <= x && x <= btnRect.x + btnRect.width && btnRect.y <= y && y <= btnRect.y + btnRect.height)
                        {
                            return new Sheets._FilterButtonInfo(btnInfo.rowFilter, btnInfo.row, btnInfo.col, btnInfo.sheetArea, btnRect.x, btnRect.y, btnRect.width, btnRect.height)
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._getCellTypeHitInfo = function(target, x, y)
                {
                    var self = this;
                    var r = target.row,
                        c = target.col,
                        sheetArea = target.hitTestType;
                    if (r === keyword_null || r === keyword_undefined || c === keyword_null || c === keyword_undefined)
                    {
                        return keyword_null
                    }
                    var cellStyle = self.getActualStyle(r, c, sheetArea);
                    var rowViewportIndex = sheetArea === 1 ? -1 : keyword_undefined,
                        colViewportIndex = sheetArea === 2 ? -1 : keyword_undefined;
                    var cellRect = self.getCellRect(r, c, rowViewportIndex, colViewportIndex);
                    var context = {
                            sheet: self, row: r, col: c, sheetArea: sheetArea
                        };
                    var ct = (cellStyle.cellType || self.getDefaultCellType(sheetArea));
                    return self._allowEditorReservedLocations ? ct.getHitInfo(x, y, cellStyle, cellRect, context) : keyword_null
                };
                Sheet.prototype._getFloatingObjectHitInfo = function(x, y)
                {
                    var self = this,
                        floatingObjectArray = self._floatingObjectArray,
                        layout = self._getSheetLayout();
                    if (Sheets.features.floatingObject && layout && floatingObjectArray && floatingObjectArray.length > 0)
                    {
                        for (var index = floatingObjectArray.length - 1; index >= 0; index--)
                        {
                            var floatingObject = floatingObjectArray[index],
                                posX = floatingObject.position().x * self._zoomFactor + layout.headerX + layout.rowHeaderWidth,
                                posY = floatingObject.position().y * self._zoomFactor + layout.headerY + layout.colHeaderHeight,
                                width = floatingObject.width(),
                                height = floatingObject.height();
                            if (x >= posX && x < posX + width && y >= posY && y < posY + height)
                            {
                                return {
                                        x: x, y: y, floatingObject: floatingObject
                                    }
                            }
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._getCommentHitInfo = function(x, y)
                {
                    if (Sheets.features.comment)
                    {
                        return this._commentManager.getCommentHitInfo(x, y)
                    }
                    return keyword_null
                };
                Sheet.prototype._disposeUserEvents = function()
                {
                    this.unbindAll();
                    this._unbindAll()
                };
                Sheet.prototype._doCommand = function(action)
                {
                    var undoManager = this.undoManager();
                    undoManager.doAction(action)
                };
                Sheet.prototype._refreshTabStrip = function()
                {
                    var self = this;
                    if (self.parent && self.parent._tab && self.parent._tab.repaint)
                    {
                        self.parent._tab.repaint()
                    }
                };
                Sheet.prototype._isAnyCellInRangeLocked = function(range)
                {
                    var ar = this._getActualRange(range),
                        row = ar.row,
                        col = ar.col,
                        endRow = row + ar.rowCount,
                        endCol = col + ar.colCount,
                        style;
                    for (var r = row; r < endRow; r++)
                    {
                        for (var c = col; c < endCol; c++)
                        {
                            style = this.getActualStyle(r, c);
                            if (style.locked === true)
                            {
                                return true
                            }
                        }
                    }
                    return false
                };
                Sheet.prototype._isValidRange = function(row, column, rowCount, columnCount, maxRowCount, maxColumnCount)
                {
                    if (-1 <= row && row < maxRowCount && -1 <= column && column < maxColumnCount)
                    {
                        if (row === -1 && column === -1)
                        {
                            return true
                        }
                        else if (row === -1)
                        {
                            if (columnCount !== 0 && column + columnCount <= maxColumnCount)
                            {
                                return true
                            }
                        }
                        else if (column === -1)
                        {
                            if (rowCount !== 0 && row + rowCount <= maxRowCount)
                            {
                                return true
                            }
                        }
                        else
                        {
                            if (columnCount !== 0 && column + columnCount <= maxColumnCount && rowCount !== 0 && row + rowCount <= maxRowCount)
                            {
                                return true
                            }
                        }
                    }
                    return false
                };
                Sheet.prototype._hasPartSpans = function(row, column, rowCount, columnCount)
                {
                    var enumerator,
                        cs;
                    if (row < 0 && column < 0)
                    {
                        return false
                    }
                    else if (row < 0)
                    {
                        var columnHeaderSpanModel = this._getSpanModel(1);
                        if (columnHeaderSpanModel && columnHeaderSpanModel.length !== 0)
                        {
                            enumerator = columnHeaderSpanModel.getEnumerator(-1, column, -1, columnCount);
                            cs = keyword_null;
                            while (enumerator.moveNext())
                            {
                                cs = enumerator.current();
                                if (cs.col < column || cs.col + cs.colCount > column + columnCount)
                                {
                                    return true
                                }
                            }
                        }
                    }
                    else if (column < 0)
                    {
                        var rowHeaderSpanModel = this._getSpanModel(2);
                        if (rowHeaderSpanModel && rowHeaderSpanModel.length !== 0)
                        {
                            enumerator = rowHeaderSpanModel.getEnumerator(row, -1, rowCount, -1);
                            cs = keyword_null;
                            while (enumerator.moveNext())
                            {
                                cs = enumerator.current();
                                if (cs.row < row || cs.row + cs.rowCount > row + rowCount)
                                {
                                    return true
                                }
                            }
                        }
                    }
                    var spanModel = this._getSpanModel();
                    if (spanModel && spanModel.length !== 0)
                    {
                        var spanEnumerator = spanModel.getEnumerator(row, column, rowCount, columnCount);
                        cs = keyword_null;
                        while (spanEnumerator.moveNext())
                        {
                            cs = spanEnumerator.current();
                            if (row !== -1)
                            {
                                if (cs.row < row || cs.row + cs.rowCount > row + rowCount)
                                {
                                    return true
                                }
                            }
                            if (column !== -1)
                            {
                                if (cs.col < column || cs.col + cs.colCount > column + columnCount)
                                {
                                    return true
                                }
                            }
                        }
                    }
                    return false
                };
                Sheet.prototype._hasSpans = function(row, column, rowCount, columnCount)
                {
                    var spans = this._getSpanModel();
                    if (spans)
                    {
                        for (var i = 0, count = spans.length; i < count; i++)
                        {
                            var span = spans[i];
                            if (span.intersect(row, column, rowCount, columnCount))
                            {
                                return true
                            }
                        }
                    }
                    return false
                };
                Sheet.prototype._hasPartTable = function(row, column, rowCount, columnCount)
                {
                    var tables = this.getTables();
                    if (tables && tables.length > 0)
                    {
                        var range = new Sheets.Range(row, column, rowCount, columnCount);
                        var count = tables.length,
                            cr;
                        for (var i = 0; i < count; i++)
                        {
                            cr = tables[i].range();
                            if (range.intersect(cr.row, cr.col, cr.rowCount, cr.colCount) && !range.containsRange(cr))
                            {
                                return true
                            }
                        }
                    }
                    return false
                };
                Sheet.prototype._hasTable = function(row, column, rowCount, columnCount)
                {
                    if (this._tableManager && this._tableManager.has(row, column, rowCount, columnCount))
                    {
                        return true
                    }
                    return false
                };
                Sheet.prototype._hasPartArrayFormulas = function(row, column, rowCount, columnCount)
                {
                    return this._getCalcModel() && this._getCalcModel()._getFormulaExps(row, column, rowCount, columnCount, true, true)
                };
                Sheet.prototype._getsArrayFormulas = function(row, column, rowCount, columnCount)
                {
                    return this._getCalcModel() && this._getCalcModel()._getFormulaExps(row, column, rowCount, columnCount, false, true)
                };
                Sheet.prototype._hasArrayFormula = function(row, column, rowCount, columnCount)
                {
                    var result = this._getsArrayFormulas(row, column, rowCount, columnCount);
                    return result && result.formulas && result.formulas.length > 0
                };
                Sheet.prototype._suspendInvalidate = function()
                {
                    this._layoutSuspended++
                };
                Sheet.prototype._resumeInvalidate = function()
                {
                    var self = this;
                    self._layoutSuspended--;
                    if (self._layoutSuspended <= 0)
                    {
                        if (!self.isPaintSuspended())
                        {
                            self.invalidateLayout();
                            self.repaint();
                            return true
                        }
                        self._layoutSuspended = 0
                    }
                    return false
                };
                Sheet.prototype._nextNonNullRow = function(row, rowHeader)
                {
                    var self = this;
                    var bm = self._bindingManager,
                        ds = self.getDataSource();
                    row++;
                    var model = rowHeader ? self._getModel(2) : self._getModel(3);
                    var count = model.getRowCount();
                    if (rowHeader === false && ds)
                    {
                        count = Math_max(count, bm.getRowCount())
                    }
                    while (row >= 0 && row < count)
                    {
                        if (model.dataTable.hasOwnProperty(row) && model.dataTable[row])
                        {
                            break
                        }
                        if (rowHeader === false && ds)
                        {
                            if (bm.getDataItem(row))
                            {
                                break
                            }
                        }
                        row++
                    }
                    if (row < count)
                    {
                        return row
                    }
                    return -1
                };
                Sheet.prototype._nextNonNullColumn = function(row, col, columnHeader)
                {
                    var self = this;
                    var bm = self._bindingManager,
                        ds = self.getDataSource();
                    var dr = keyword_null;
                    var model = columnHeader ? self._getModel(1) : self._getModel(3);
                    if (row >= 0 && row < model.getRowCount())
                    {
                        if (model.dataTable.hasOwnProperty(row))
                        {
                            dr = model.dataTable[row]
                        }
                    }
                    if (columnHeader === false && !dr && ds)
                    {
                        if (row >= 0 && row < bm.getRowCount())
                        {
                            dr = bm.getDataItem(row)
                        }
                    }
                    if (!dr)
                    {
                        return -1
                    }
                    col++;
                    while (col >= 0 && (col < model.getColumnCount() || col < dr.length))
                    {
                        if (dr.hasOwnProperty(col) && dr[col])
                        {
                            break
                        }
                        if (columnHeader === false && ds)
                        {
                            var value = self._getValueImp(model, row, col);
                            if (value !== keyword_undefined && value !== keyword_null)
                            {
                                break
                            }
                        }
                        col++
                    }
                    if (col < model.getColumnCount() || (columnHeader === false && dr && col < dr.length))
                    {
                        return col
                    }
                    return -1
                };
                Sheet.prototype._closeDragFillPopup = function()
                {
                    if (this._smartTag)
                    {
                        this._smartTag.close()
                    }
                };
                Sheet.prototype._cellRangeInflate = function(spans, cellRange)
                {
                    if (spans && spans.length > 0)
                    {
                        for (var i = 0; i < spans.length; i++)
                        {
                            var cr = spans[i];
                            if (cellRange.intersect(cr.row, cr.col, cr.rowCount, cr.colCount))
                            {
                                spans.splice(i--, 1);
                                return this._cellRangeInflate(spans, this._unionCellRange(cellRange, cr))
                            }
                        }
                    }
                    return cellRange
                };
                Sheet.prototype._unionCellRange = function(range1, range2)
                {
                    var ltr = Math_min(range1.row, range2.row);
                    var ltc = Math_min(range1.col, range2.col);
                    var rbr = Math_max(range1.row + range1.rowCount - 1, range2.row + range2.rowCount - 1);
                    var rbc = Math_max(range1.col + range1.colCount - 1, range2.col + range2.colCount - 1);
                    if (ltr >= 0 && ltc >= 0)
                    {
                        return new Sheets.Range(ltr, ltc, rbr - ltr + 1, rbc - ltc + 1)
                    }
                    else if (ltr >= 0)
                    {
                        return new Sheets.Range(ltr, -1, rbr - ltr + 1, -1)
                    }
                    else if (ltc >= 0)
                    {
                        return new Sheets.Range(-1, ltc, -1, rbc - ltc + 1)
                    }
                    else
                    {
                        return new Sheets.Range(-1, -1, -1, -1)
                    }
                };
                Sheet.prototype._getClipboardHelper = function()
                {
                    var self = this;
                    if (!self._clipboardHelper && self.parent && self.parent._clipboardHelper)
                    {
                        self._clipboardHelper = self.parent._clipboardHelper
                    }
                    else if (!self._clipboardHelper)
                    {
                        self._clipboardHelper = {
                            fromSheet: keyword_null, range: keyword_null, isCutting: false
                        }
                    }
                    return self._clipboardHelper
                };
                Sheet.prototype._getFloatingObjectClipboardHelper = function()
                {
                    var self = this;
                    if (!self._floatingObjectClipboardHelper && self.parent && self.parent._floatingObjectClipboardHelper)
                    {
                        self._floatingObjectClipboardHelper = self.parent._floatingObjectClipboardHelper
                    }
                    else if (!self._floatingObjectClipboardHelper)
                    {
                        self._floatingObjectClipboardHelper = {
                            fromSheet: keyword_null, isCutting: false
                        }
                    }
                    return self._floatingObjectClipboardHelper
                };
                Sheet.prototype._checkPastedRange = function(fromSheet, fromRange, toRange, isCutting, clipboardText, outPara)
                {
                    var msg_sheetViewPasteSouceSheetCellsAreLocked = Sheets.SR.Exp_PasteSourceCellsLocked;
                    var msg_sheetViewTheCopyAreaAndPasteAreaAreNotTheSameSize = Sheets.SR.Exp_InvalidCopyPasteSize;
                    var msg_sheetViewPasteDestinationSheetCellsAreLocked = Sheets.SR.Exp_PasteDestinationCellsLocked;
                    var msg_sheetViewPasteChangeMergeCell = Sheets.SR.Exp_PasteChangeMergeCell;
                    var msg_sheetViewPasteChangePartOfArrayFormula = Sheets.SR.Exp_ChangePartOfArray;
                    outPara.pastedInternal = false;
                    outPara.pastedRange = keyword_null;
                    if (!fromSheet && (!clipboardText || clipboardText === ""))
                    {
                        return false
                    }
                    var self = this;
                    var toSheet = self;
                    if (self._isPastedInternal(fromSheet, fromRange, toSheet, clipboardText) || !clipboardText)
                    {
                        outPara.pastedInternal = true;
                        if (isCutting && fromSheet.isProtected && fromSheet._isAnyCellInRangeLocked(fromRange))
                        {
                            self._raiseInvalidOperation(1, msg_sheetViewPasteSouceSheetCellsAreLocked);
                            return false
                        }
                        outPara.pastedRange = self._getPastedRange(fromSheet, fromRange, toSheet, toRange, isCutting)
                    }
                    else
                    {
                        outPara.pastedRange = self._getPastedRangefromText(toRange, clipboardText)
                    }
                    if (!outPara.pastedRange)
                    {
                        self._raiseInvalidOperation(1, msg_sheetViewTheCopyAreaAndPasteAreaAreNotTheSameSize);
                        return false
                    }
                    if (toSheet.isProtected && toSheet._isAnyCellInRangeLocked(outPara.pastedRange))
                    {
                        self._raiseInvalidOperation(1, msg_sheetViewPasteDestinationSheetCellsAreLocked);
                        return false
                    }
                    if (outPara.pastedInternal)
                    {
                        if (fromSheet._hasPartSpans(fromRange.row, fromRange.col, fromRange.rowCount, fromRange.colCount))
                        {
                            self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                            return false
                        }
                        if (isCutting && fromSheet._hasPartArrayFormulas(fromRange.row, fromRange.col, fromRange.rowCount, fromRange.colCount))
                        {
                            self._raiseInvalidOperation(1, msg_sheetViewPasteChangePartOfArrayFormula);
                            return false
                        }
                        var toRowCount = outPara.pastedRange.row < 0 ? toSheet.getRowCount() : outPara.pastedRange.rowCount;
                        var toColumnCount = outPara.pastedRange.col < 0 ? toSheet.getColumnCount() : outPara.pastedRange.colCount;
                        var rowCount = fromRange.row < 0 ? fromSheet.getRowCount() : fromRange.rowCount;
                        var columnCount = fromRange.col < 0 ? fromSheet.getColumnCount() : fromRange.colCount;
                        if (toRowCount > rowCount || toColumnCount > columnCount)
                        {
                            var toRow = toRange.row;
                            var toColumn = toRange.col;
                            if (toRange.row < 0 && rowCount < toSheet.getRowCount())
                            {
                                toRow = 0
                            }
                            if (toRange.col < 0 && columnCount < toSheet.getColumnCount())
                            {
                                toColumn = 0
                            }
                            if (toRowCount % rowCount === 0 && toColumnCount === 1)
                            {
                                toColumnCount = columnCount;
                                outPara.pastedRange = new Sheets.Range(toRow, toColumn, toRowCount, toColumnCount)
                            }
                            else if (toRowCount === 1 && toColumnCount % columnCount === 0)
                            {
                                toRowCount = rowCount;
                                outPara.pastedRange = new Sheets.Range(toRow, toColumn, toRowCount, toColumnCount)
                            }
                            else if (toRowCount % rowCount !== 0 || toColumnCount % columnCount !== 0)
                            {
                                toRowCount = rowCount;
                                toColumnCount = columnCount;
                                outPara.pastedRange = new Sheets.Range(toRow, toColumn, toRowCount, toColumnCount)
                            }
                            var rn = Math_floor(toRowCount / rowCount);
                            var cn = Math_floor(toColumnCount / columnCount);
                            for (var r = 0; r < rn; r++)
                            {
                                for (var c = 0; c < cn; c++)
                                {
                                    if (toSheet._hasPartSpans((toRow < 0 ? -1 : toRow + r * rowCount), (toColumn < 0 ? -1 : toColumn + c * columnCount), (toRow < 0 ? -1 : rowCount), (toColumn < 0 ? -1 : columnCount)))
                                    {
                                        self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                                        return false
                                    }
                                    if (toSheet._hasPartArrayFormulas((toRow < 0 ? -1 : toRow + r * rowCount), (toColumn < 0 ? -1 : toColumn + c * columnCount), (toRow < 0 ? -1 : rowCount), (toColumn < 0 ? -1 : columnCount)))
                                    {
                                        self._raiseInvalidOperation(1, msg_sheetViewPasteChangePartOfArrayFormula);
                                        return false
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (toSheet._hasPartSpans(outPara.pastedRange.row, outPara.pastedRange.col, outPara.pastedRange.rowCount, outPara.pastedRange.colCount))
                            {
                                self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                                return false
                            }
                            if (toSheet._hasPartArrayFormulas(outPara.pastedRange.row, outPara.pastedRange.col, outPara.pastedRange.rowCount, outPara.pastedRange.colCount))
                            {
                                self._raiseInvalidOperation(1, msg_sheetViewPasteChangePartOfArrayFormula);
                                return false
                            }
                        }
                    }
                    else
                    {
                        if (toSheet._hasPartSpans(outPara.pastedRange.row, outPara.pastedRange.col, outPara.pastedRange.rowCount, outPara.pastedRange.colCount))
                        {
                            self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                            return false
                        }
                        if (toSheet._hasPartArrayFormulas(outPara.pastedRange.row, outPara.pastedRange.col, outPara.pastedRange.rowCount, outPara.pastedRange.colCount))
                        {
                            self._raiseInvalidOperation(1, msg_sheetViewPasteChangePartOfArrayFormula);
                            return false
                        }
                        if ((outPara.pastedRange.row + outPara.pastedRange.rowCount > toSheet.getRowCount()) || (outPara.pastedRange.col + outPara.pastedRange.colCount > toSheet.getColumnCount()))
                        {
                            self._raiseInvalidOperation(1, msg_sheetViewTheCopyAreaAndPasteAreaAreNotTheSameSize);
                            return false
                        }
                    }
                    return true
                };
                Sheet.prototype._isPastedInternal = function(srcSheet, srcRange, destSheet, clipboadText)
                {
                    if (srcSheet && srcRange && destSheet)
                    {
                        var csvText = staticMembers.getRangeText(srcSheet, srcRange.row, srcRange.rowCount, srcRange.col, srcRange.colCount, "\r\n", "\t", "\"", false, 0);
                        var isTextEqual = csvText === clipboadText;
                        if (!isTextEqual && ($.browser.chrome || $.browser.safari || $.browser.webkit))
                        {
                            isTextEqual = csvText === clipboadText + "\r\n"
                        }
                        return isTextEqual
                    }
                    return false
                };
                Sheet.prototype._getPastedRange = function(fromSheet, fromRange, toSheet, toRange, isCutting)
                {
                    var fromRow = fromRange.row < 0 ? 0 : fromRange.row;
                    var fromColumn = fromRange.col < 0 ? 0 : fromRange.col;
                    var fromRowCount = fromRange.row < 0 ? fromSheet.getRowCount() : fromRange.rowCount;
                    var fromColumnCount = fromRange.col < 0 ? fromSheet.getColumnCount() : fromRange.colCount;
                    var toRow = toRange.row < 0 ? 0 : toRange.row;
                    var toColumn = toRange.col < 0 ? 0 : toRange.col;
                    var toRowCount = toRange.row < 0 ? toSheet.getRowCount() : toRange.rowCount;
                    var toColumnCount = toRange.col < 0 ? toSheet.getColumnCount() : toRange.colCount;
                    if (isCutting)
                    {
                        toRowCount = fromRowCount;
                        toColumnCount = fromColumnCount
                    }
                    else if (toRowCount % fromRowCount === 0 && toColumnCount === 1)
                    {
                        toColumnCount = fromColumnCount
                    }
                    else if (toRowCount === 1 && toColumnCount % fromColumnCount === 0)
                    {
                        toRowCount = fromRowCount
                    }
                    else if (toRowCount % fromRowCount !== 0 || toColumnCount % fromColumnCount !== 0)
                    {
                        toRowCount = fromRowCount;
                        toColumnCount = fromColumnCount
                    }
                    if (!this._isValidRange(fromRow, fromColumn, fromRowCount, fromColumnCount, fromSheet.getRowCount(), fromSheet.getColumnCount()))
                    {
                        return keyword_null
                    }
                    if (!this._isValidRange(toRow, toColumn, toRowCount, toColumnCount, toSheet.getRowCount(), toSheet.getColumnCount()))
                    {
                        return keyword_null
                    }
                    var fixedToRange = new Sheets.Range(toRow, toColumn, toRowCount, toColumnCount);
                    if (!isCutting && fromSheet._name === toSheet._name)
                    {
                        if (fixedToRange.contains(fromRow, fromColumn, fromRowCount, fromColumnCount))
                        {
                            if ((fromRow - toRow) % fromRowCount !== 0 || (fromColumn - toColumn) % fromColumnCount !== 0)
                            {
                                return keyword_null
                            }
                        }
                        else if (fixedToRange.intersect(fromRow, fromColumn, fromRowCount, fromColumnCount))
                        {
                            if (toRowCount > fromRowCount || toColumnCount > fromColumnCount)
                            {
                                return keyword_null
                            }
                        }
                    }
                    if (toRange.row === -1)
                    {
                        toRow = -1;
                        toRowCount = -1
                    }
                    if (toRange.col === -1)
                    {
                        toColumn = -1;
                        toColumnCount = -1
                    }
                    return new Sheets.Range(toRow, toColumn, toRowCount, toColumnCount)
                };
                Sheet.prototype._getPastedRangefromText = function(toRange, clipboadText)
                {
                    var ret = keyword_null;
                    var textArray = staticMembers.parseCsv(clipboadText, "\r\n", "\t", "\"");
                    if (textArray)
                    {
                        var row = toRange.row < 0 ? 0 : toRange.row;
                        var column = toRange.col < 0 ? 0 : toRange.col;
                        var rowCount = textArray.length;
                        var columnCount = staticMembers.getMaxLength(textArray);
                        if (rowCount > 0 && columnCount > 0)
                        {
                            ret = new Sheets.Range(row, column, rowCount, columnCount)
                        }
                    }
                    return ret
                };
                Sheet.prototype._clearClipboard = function()
                {
                    var ch = this._getClipboardHelper();
                    if (ch)
                    {
                        ch.fromSheet = keyword_null;
                        ch.range = keyword_null;
                        ch.isCutting = false
                    }
                };
                Sheet.prototype._clipboardPaste = function(fromSheet, fromRange, toSheet, toRange, isCutting, clipboardText, option)
                {
                    if (fromSheet && toSheet._name === fromSheet._name && (toSheet.parent && !Sheets.ArrayHelper.contains(toSheet.parent.sheets, fromSheet)))
                    {
                        fromSheet._clearClipboard();
                        return
                    }
                    var toRow,
                        toColumn,
                        rowCount,
                        columnCount,
                        r,
                        c;
                    if (fromSheet && fromRange)
                    {
                        var convertPasteOption = Sheets.UndoRedo.ClipboardPasteRangeUndoAction.convertPasteOption;
                        var pasteOption = convertPasteOption(option);
                        if ((pasteOption & 2) !== 0 && (isCutting && fromSheet._hasPartArrayFormulas(fromRange.row, fromRange.col, fromRange.rowCount, fromRange.colCount) || toSheet._hasPartArrayFormulas(toRange.row, toRange.col, toRange.rowCount, toRange.colCount)))
                        {
                            throw Sheets.SR.Exp_ChangePartOfArray;
                        }
                        if (isCutting)
                        {
                            staticMembers.moveTo(fromSheet, fromRange.row, fromRange.col, toSheet, toRange.row, toRange.col, fromRange.rowCount, fromRange.colCount, pasteOption);
                            fromSheet._clearClipboard()
                        }
                        else
                        {
                            var toRowCount = toRange.row < 0 ? toSheet.getRowCount() : toRange.rowCount;
                            var toColumnCount = toRange.col < 0 ? toSheet.getColumnCount() : toRange.colCount;
                            rowCount = fromRange.row < 0 ? fromSheet.getRowCount() : fromRange.rowCount;
                            columnCount = fromRange.col < 0 ? fromSheet.getColumnCount() : fromRange.colCount;
                            if (toRowCount > rowCount || toColumnCount > columnCount)
                            {
                                toRow = toRange.row;
                                toColumn = toRange.col;
                                if (toRange.row < 0 && rowCount < toSheet.getRowCount())
                                {
                                    toRow = 0
                                }
                                if (toRange.col < 0 && columnCount < toSheet.getColumnCount())
                                {
                                    toColumn = 0
                                }
                                if (toRowCount % rowCount === 0 && toColumnCount === 1)
                                {
                                    toColumnCount = columnCount
                                }
                                else if (toRowCount === 1 && toColumnCount % columnCount === 0)
                                {
                                    toRowCount = rowCount
                                }
                                else if (toRowCount % rowCount !== 0 || toColumnCount % columnCount !== 0)
                                {
                                    toRowCount = rowCount;
                                    toColumnCount = columnCount
                                }
                                var rn = Math_floor(toRowCount / rowCount);
                                var cn = Math_floor(toColumnCount / columnCount);
                                fromSheet.suspendCalcService();
                                toSheet.suspendCalcService();
                                try
                                {
                                    for (r = 0; r < rn; r++)
                                    {
                                        for (c = 0; c < cn; c++)
                                        {
                                            staticMembers.copyTo(fromSheet, fromRange.row, fromRange.col, toSheet, (toRow < 0 ? -1 : toRow + r * rowCount), (toColumn < 0 ? -1 : toColumn + c * columnCount), (toRow < 0 ? -1 : rowCount), (toColumn < 0 ? -1 : columnCount), pasteOption, true)
                                        }
                                    }
                                }
                                finally
                                {
                                    fromSheet.resumeCalcService();
                                    toSheet.resumeCalcService()
                                }
                            }
                            else
                            {
                                staticMembers.copyTo(fromSheet, fromRange.row, fromRange.col, toSheet, toRange.row, toRange.col, fromRange.rowCount, fromRange.colCount, pasteOption, true)
                            }
                        }
                    }
                    else
                    {
                        toRow = toRange.row;
                        toColumn = toRange.col;
                        rowCount = toRange.rowCount;
                        columnCount = toRange.colCount;
                        var spanModel = toSheet._getSpanModel();
                        var spanEnumerator = spanModel.getEnumerator(toRow, toColumn, rowCount, columnCount),
                            removedSpans = [];
                        while (spanEnumerator.moveNext())
                        {
                            var cs = spanEnumerator.current();
                            if (cs)
                            {
                                removedSpans.push(cs)
                            }
                        }
                        for (var i = 0, len = removedSpans.length; i < len; i++)
                        {
                            spanModel.remove(removedSpans[i])
                        }
                        if ((!clipboardText) || (clipboardText === ""))
                        {
                            for (r = 0; r < rowCount; r++)
                            {
                                for (c = 0; c < columnCount; c++)
                                {
                                    toSheet.setValue(toRow + r, toColumn + c, keyword_null)
                                }
                            }
                        }
                        else
                        {
                            toSheet.setCsv(toRow, toColumn, clipboardText, "\r\n", "\t", 16)
                        }
                    }
                };
                Sheet.prototype._copyFormula = function(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount)
                {
                    Sheets.Calc.CalcOperatorAdjustor.copyFormula(this._getCalcModel(), fromRow, fromColumn, this._getCalcModel(), toRow, toColumn, rowCount, columnCount)
                };
                Sheet.prototype._getAutoFitType = function()
                {
                    if (this.parent != keyword_null)
                    {
                        var pSpread = this.parent;
                        return pSpread.autoFitType()
                    }
                    return 0
                };
                Sheet.prototype._doCut = function(ignoreClipboard)
                {
                    if (!this.isEditing())
                    {
                        var sels = this.getSelections();
                        if (sels && sels.length === 1)
                        {
                            return this._clipboardCopy(sels[0], true, ignoreClipboard)
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._doCopy = function(ignoreClipboard)
                {
                    if (!this.isEditing())
                    {
                        var sels = this.getSelections();
                        if (sels && sels.length === 1)
                        {
                            return this._clipboardCopy(sels[0], false, ignoreClipboard)
                        }
                    }
                    return keyword_null
                };
                Sheet.prototype._doFloatingObjectCopy = function(ignoreClipboard)
                {
                    var self = this;
                    if (self._hasFloatingObjectsSelected())
                    {
                        var selectedFloatingObjects = [];
                        var i,
                            len,
                            floatingObjectArray = self._floatingObjectArray;
                        for (i = 0, len = floatingObjectArray.length; i < len; i++)
                        {
                            var item = floatingObjectArray[i];
                            if (item.isSelected())
                            {
                                selectedFloatingObjects.push(item.name())
                            }
                        }
                        self._clipboardFloatingObjectCopy(selectedFloatingObjects, false, ignoreClipboard)
                    }
                };
                Sheet.prototype._doFloatingObjectCut = function(ignoreClipboard)
                {
                    var self = this;
                    if (self._hasFloatingObjectsSelected())
                    {
                        var selectedFloatingObjects = [];
                        var i,
                            len,
                            floatingObjectArray = self._floatingObjectArray;
                        for (i = 0, len = floatingObjectArray.length; i < len; i++)
                        {
                            var item = floatingObjectArray[i];
                            if (item.isSelected())
                            {
                                selectedFloatingObjects.push(item.name())
                            }
                        }
                        self._clipboardFloatingObjectCopy(selectedFloatingObjects, true, ignoreClipboard);
                        var deleteExtent = {names: selectedFloatingObjects};
                        var deleteFloationgObjectUndoAction = new Sheets.UndoRedo.DeleteFloatingObjectUndoAction(self, deleteExtent);
                        self._doCommand(deleteFloationgObjectUndoAction)
                    }
                };
                Sheet.prototype._doFloatingObjectPaste = function(pasteData, callback)
                {
                    var sheet = this;
                    if (sheet.isEditing() || !Sheets.features.floatingObject)
                    {
                        return
                    }
                    var ch = sheet._getFloatingObjectClipboardHelper();
                    var fromSheet = ch.fromSheet,
                        fromSheetEventHandler = fromSheet._eventHandler;
                    var isCutting = ch.isCutting;
                    setTimeout(function()
                    {
                        var clipboardData = pasteData;
                        if (fromSheetEventHandler && !pasteData)
                        {
                            clipboardData = fromSheetEventHandler._getClipboardFloatingObjectData()
                        }
                        if (clipboardData && clipboardData.length)
                        {
                            var names = [];
                            var i,
                                len;
                            for (i = 0, len = clipboardData.length; i < len; i++)
                            {
                                names.push(clipboardData[i].name())
                            }
                            var clipboardPasteFloatingObjectUndoAction = new Sheets.UndoRedo.ClipboardPasteFloatingObjectUndoAction(sheet, {names: names}, fromSheet);
                            sheet._doCommand(clipboardPasteFloatingObjectUndoAction)
                        }
                        if (callback)
                        {
                            callback()
                        }
                    }, 100)
                };
                Sheet.prototype._doPaste = function(pasteData, callback)
                {
                    var sheet = this,
                        eventHandler = sheet._eventHandler;
                    if (sheet.isEditing())
                    {
                        return
                    }
                    if (eventHandler && !pasteData)
                    {
                        eventHandler._switchFocusForClipboard("")
                    }
                    setTimeout(function()
                    {
                        var clipboardText = pasteData;
                        if (eventHandler && !pasteData)
                        {
                            clipboardText = eventHandler._getClipboardData();
                            eventHandler._switchBackFocusAfterClipboard()
                        }
                        var pasteInfo = sheet._getPasteInfo(clipboardText);
                        if (!pasteInfo)
                        {
                            return
                        }
                        var pasteUndoAction = sheet._createPasteAction(pasteInfo);
                        sheet._doCommand(pasteUndoAction);
                        if (callback)
                        {
                            callback()
                        }
                    }, 100)
                };
                Sheet.prototype._createPasteAction = function(pasteInfo)
                {
                    var sheet = this;
                    var pastedRanges = pasteInfo.pastedRanges;
                    var fromSheet = pasteInfo.fromSheet;
                    var fromRange = pasteInfo.fromRange;
                    var isCutting = pasteInfo.isCutting;
                    var pasteOption = pasteInfo.pasteOption;
                    var clipboardText = pasteInfo.clipboardText;
                    var pasteExtent = {
                            fromRange: fromRange, pastedRanges: pastedRanges.slice(0), isCutting: isCutting, clipboardText: clipboardText
                        };
                    var pasteUndoAction = new Sheets.UndoRedo.ClipboardPasteUndoAction(sheet, fromSheet, sheet, pasteExtent, pasteOption);
                    return pasteUndoAction
                };
                Sheet.prototype._getPasteInfo = function(clipboardText)
                {
                    var sheet = this,
                        eventHandler = sheet._eventHandler;
                    var msg_spreadActionPasteSizeDifferent = Sheets.SR.Exp_InvalidPastedArea;
                    var ch = sheet._getClipboardHelper();
                    var fromSheet = ch.fromSheet;
                    var fromRange = ch.range;
                    var isCutting = ch.isCutting;
                    if (isCutting && fromSheet && fromRange && fromSheet.isProtected && fromSheet._isAnyCellInRangeLocked(fromRange))
                    {
                        isCutting = false
                    }
                    var outPara = {
                            pastedRange: keyword_null, pastedInternal: false
                        };
                    var pastedRanges = [];
                    var selections = sheet.getSelections();
                    var toRange;
                    if (selections.length > 1)
                    {
                        for (var i = 0; i < selections.length; i++)
                        {
                            toRange = selections[i];
                            if (!sheet._checkPastedRange(fromSheet, fromRange, toRange, isCutting, clipboardText, outPara))
                            {
                                return
                            }
                            if (toRange.containsRange(outPara.pastedRange) && !toRange.equals(outPara.pastedRange))
                            {
                                sheet._raiseInvalidOperation(1, msg_spreadActionPasteSizeDifferent);
                                return
                            }
                            pastedRanges.push(outPara.pastedRange)
                        }
                    }
                    else if (selections.length > 0)
                    {
                        toRange = selections[0];
                        if (!sheet._checkPastedRange(fromSheet, fromRange, toRange, isCutting, clipboardText, outPara))
                        {
                            return
                        }
                        pastedRanges.push(outPara.pastedRange)
                    }
                    else
                    {
                        toRange = sheet._getSpanModel().find(sheet._activeRowIndex, sheet._activeColIndex);
                        if (!toRange)
                        {
                            toRange = new Sheets.Range(sheet._activeRowIndex, sheet._activeColIndex, 1, 1)
                        }
                        if (!sheet._checkPastedRange(fromSheet, fromRange, toRange, isCutting, clipboardText, outPara))
                        {
                            return
                        }
                        pastedRanges.push(outPara.pastedRange)
                    }
                    if (!outPara.pastedInternal)
                    {
                        fromSheet = keyword_null;
                        fromRange = keyword_null
                    }
                    var pasteOption = sheet.clipBoardOptions();
                    if (isCutting)
                    {
                        pasteOption = 0
                    }
                    return {
                            fromSheet: fromSheet, fromRange: fromRange, isCutting: isCutting, pasteOption: pasteOption, pastedRanges: pastedRanges, clipboardText: clipboardText
                        }
                };
                Sheet.prototype._getImageLoader = function()
                {
                    if (!this.imageLoader)
                    {
                        var self = this;
                        this.imageLoader = new Sheets._GcImageLoader(function()
                        {
                            self.repaint()
                        })
                    }
                    return this.imageLoader
                };
                Sheet.prototype._getContainerDiv = function()
                {
                    var self = this;
                    if (!self._containerDiv && self._canvas && self._canvas.parentNode)
                    {
                        self._containerDiv = document.createElement('div');
                        $(self._containerDiv).css({
                            position: 'absolute', left: 0, top: 0, width: 0, height: 0
                        });
                        $(self._canvas.parentNode).prepend(self._containerDiv)
                    }
                    return self._containerDiv
                };
                Sheet.prototype._raiseDragDropBlock = function(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, copy, insert, copyOption)
                {
                    var args = {
                            sheet: this, sheetName: this._name, fromRow: fromRow, fromCol: fromColumn, toRow: toRow, toCol: toColumn, rowCount: rowCount, colCount: columnCount, copy: copy, insert: insert, copyOption: copyOption, cancel: false
                        };
                    this.triggerDragDropBlock(args);
                    return args && args.cancel === true
                };
                Sheet.prototype._raiseDragDropBlockCompleted = function(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, copy, insert, copyOption)
                {
                    var args = {
                            sheet: this, sheetName: this._name, fromRow: fromRow, fromCol: fromColumn, toRow: toRow, toCol: toColumn, rowCount: rowCount, colCount: columnCount, copy: copy, insert: insert, copyOption: copyOption
                        };
                    this.triggerDragDropBlockCompleted(args)
                };
                Sheet.prototype._raiseInvalidOperation = function(invalidType, message)
                {
                    var args = {
                            sheet: this, sheetName: this._name, invalidType: invalidType, message: message
                        };
                    this.triggerInvalidOperation(args)
                };
                Sheet.prototype._raiseSelectionChanging = function(oldSelections, newSelections)
                {
                    var self = this;
                    var notEqual = self._eventHandler._notEqualSelecions(oldSelections, newSelections);
                    if (notEqual === true)
                    {
                        self.triggerSelectionChanging({
                            sheet: self, sheetName: self._name, oldSelections: oldSelections, newSelections: newSelections
                        });
                        return true
                    }
                    return false
                };
                Sheet.prototype._raiseSelectionChanged = function()
                {
                    this.triggerSelectionChanged({
                        sheet: this, sheetName: this._name
                    })
                };
                Sheet.prototype._raiseDragFillBlock = function(args)
                {
                    args.cancel = false;
                    this.triggerDragFillBlock(args);
                    return args && args.cancel === true
                };
                Sheet.prototype._raiseDragFillBlockCompleted = function(args)
                {
                    this.triggerDragFillBlockCompleted(args)
                };
                Sheet.prototype._raiseCellChanged = function(propertyName, row, column, sheetArea)
                {
                    var args = {
                            sheet: this, sheetName: this._name, row: row, col: column, sheetArea: sheetArea, propertyName: propertyName
                        };
                    this.triggerCellChanged(args)
                };
                Sheet.prototype._raiseClipboardPasting = function(cellRange, pasteOption)
                {
                    var args = {
                            sheet: this, sheetName: this._name, cellRange: cellRange, pasteOption: pasteOption, cancel: false
                        };
                    this.triggerClipboardPasting(args);
                    return args.cancel === true
                };
                Sheet.prototype._raiseClipboardPasted = function(cellRange, pasteOption)
                {
                    var args = {
                            sheet: this, sheetName: this._name, cellRange: cellRange, pasteOption: pasteOption
                        };
                    this.triggerClipboardPasted(args)
                };
                Sheet.prototype._raiseValueChanged = function(row, column)
                {
                    var args = {
                            sheet: this, sheetName: this._name, row: row, col: column
                        };
                    this.triggerValueChanged(args)
                };
                Sheet.prototype._raiseRangeDataChanged = function(row, column, rowCount, columnCount, changedCells, action)
                {
                    var args = {
                            sheet: this, sheetName: this._name, row: row, column: column, rowCount: rowCount, columnCount: columnCount, changedCells: changedCells, action: action
                        };
                    this.triggerRangeChanged(args)
                };
                Sheet.prototype._trigger = function(type, data)
                {
                    var eventHandler = this._eventHandler;
                    if (eventHandler._eventSuspended === 0)
                    {
                        eventHandler.trigger(type, data)
                    }
                };
                Sheet.prototype.triggerValidationError = function(data)
                {
                    this._trigger(Sheets.Events.ValidationError, data)
                };
                Sheet.prototype.triggerCellClick = function(data)
                {
                    this._trigger(Sheets.Events.CellClick, data)
                };
                Sheet.prototype.triggerCellDoubleClick = function(data)
                {
                    this._trigger(Sheets.Events.CellDoubleClick, data)
                };
                Sheet.prototype.triggerEnterCell = function(data)
                {
                    this._trigger(Sheets.Events.EnterCell, data)
                };
                Sheet.prototype.triggerLeaveCell = function(data)
                {
                    this._trigger(Sheets.Events.LeaveCell, data)
                };
                Sheet.prototype.triggerValueChanged = function(data)
                {
                    this._trigger(Sheets.Events.ValueChanged, data)
                };
                Sheet.prototype.triggerTopRowChanged = function(data)
                {
                    this._trigger(Sheets.Events.TopRowChanged, data)
                };
                Sheet.prototype.triggerLeftColumnChanged = function(data)
                {
                    this._trigger(Sheets.Events.LeftColumnChanged, data)
                };
                Sheet.prototype.triggerInvalidOperation = function(data)
                {
                    this._trigger(Sheets.Events.InvalidOperation, data)
                };
                Sheet.prototype.triggerRangeFiltering = function(data)
                {
                    this._trigger(Sheets.Events.RangeFiltering, data)
                };
                Sheet.prototype.triggerRangeFiltered = function(data)
                {
                    this._trigger(Sheets.Events.RangeFiltered, data)
                };
                Sheet.prototype.triggerTableFiltering = function(data)
                {
                    this._trigger(Sheets.Events.TableFiltering, data)
                };
                Sheet.prototype.triggerTableFiltered = function(data)
                {
                    this._trigger(Sheets.Events.TableFiltered, data)
                };
                Sheet.prototype.triggerRangeSorting = function(data)
                {
                    this._trigger(Sheets.Events.RangeSorting, data)
                };
                Sheet.prototype.triggerRangeSorted = function(data)
                {
                    this._trigger(Sheets.Events.RangeSorted, data)
                };
                Sheet.prototype.triggerClipboardChanging = function(data)
                {
                    this._trigger(Sheets.Events.ClipboardChanging, data)
                };
                Sheet.prototype.triggerClipboardChanged = function(data)
                {
                    this._trigger(Sheets.Events.ClipboardChanged, data)
                };
                Sheet.prototype.triggerClipboardPasting = function(data)
                {
                    this._trigger(Sheets.Events.ClipboardPasting, data)
                };
                Sheet.prototype.triggerClipboardPasted = function(data)
                {
                    this._trigger(Sheets.Events.ClipboardPasted, data)
                };
                Sheet.prototype.triggerColumnWidthChanging = function(data)
                {
                    this._trigger(Sheets.Events.ColumnWidthChanging, data)
                };
                Sheet.prototype.triggerColumnWidthChanged = function(data)
                {
                    this._trigger(Sheets.Events.ColumnWidthChanged, data)
                };
                Sheet.prototype.triggerRowHeightChanging = function(data)
                {
                    this._trigger(Sheets.Events.RowHeightChanging, data)
                };
                Sheet.prototype.triggerRowHeightChanged = function(data)
                {
                    this._trigger(Sheets.Events.RowHeightChanged, data)
                };
                Sheet.prototype.triggerDragDropBlock = function(data)
                {
                    this._trigger(Sheets.Events.DragDropBlock, data)
                };
                Sheet.prototype.triggerDragDropBlockCompleted = function(data)
                {
                    this._trigger(Sheets.Events.DragDropBlockCompleted, data)
                };
                Sheet.prototype.triggerDragFillBlock = function(data)
                {
                    this._trigger(Sheets.Events.DragFillBlock, data)
                };
                Sheet.prototype.triggerDragFillBlockCompleted = function(data)
                {
                    this._trigger(Sheets.Events.DragFillBlockCompleted, data)
                };
                Sheet.prototype.triggerEditStarting = function(data)
                {
                    this._trigger(Sheets.Events.EditStarting, data)
                };
                Sheet.prototype.triggerEditChange = function(data)
                {
                    this._trigger(Sheets.Events.EditChange, data)
                };
                Sheet.prototype.triggerEditEnding = function(data)
                {
                    this._trigger(Sheets.Events.EditEnding, data)
                };
                Sheet.prototype.triggerEditEnded = function(data)
                {
                    this._trigger(Sheets.Events.EditEnded, data)
                };
                Sheet.prototype.triggerRangeGroupStateChanging = function(data)
                {
                    this._trigger(Sheets.Events.RangeGroupStateChanging, data)
                };
                Sheet.prototype.triggerRangeGroupStateChanged = function(data)
                {
                    this._trigger(Sheets.Events.RangeGroupStateChanged, data)
                };
                Sheet.prototype.triggerSelectionChanging = function(data)
                {
                    this._trigger(Sheets.Events.SelectionChanging, data)
                };
                Sheet.prototype.triggerSelectionChanged = function(data)
                {
                    this._trigger(Sheets.Events.SelectionChanged, data)
                };
                Sheet.prototype.triggerSheetNameChanging = function(data)
                {
                    this._trigger(Sheets.Events.SheetNameChanging, data)
                };
                Sheet.prototype.triggerSheetNameChanged = function(data)
                {
                    this._trigger(Sheets.Events.SheetNameChanged, data)
                };
                Sheet.prototype.triggerUserZooming = function(data)
                {
                    this._trigger(Sheets.Events.UserZooming, data)
                };
                Sheet.prototype.triggerUserFormulaEntered = function(data)
                {
                    this._trigger(Sheets.Events.UserFormulaEntered, data)
                };
                Sheet.prototype.triggerCellChanged = function(data)
                {
                    this._trigger(Sheets.Events.CellChanged, data)
                };
                Sheet.prototype.triggerColumnChanged = function(data)
                {
                    this._trigger(Sheets.Events.ColumnChanged, data)
                };
                Sheet.prototype.triggerRowChanged = function(data)
                {
                    this._trigger(Sheets.Events.RowChanged, data)
                };
                Sheet.prototype.triggerSparklineChanged = function(data)
                {
                    this._trigger(Sheets.Events.SparklineChanged, data)
                };
                Sheet.prototype.triggerRangeChanged = function(data)
                {
                    if (data.changedCells && data.changedCells.length > 0)
                    {
                        this._trigger(Sheets.Events.RangeChanged, data)
                    }
                };
                Sheet.prototype.triggerEditorStatusChanged = function(data)
                {
                    this._trigger(Sheets.Events.EditorStatusChanged, data)
                };
                Sheet.prototype.triggerFloatingObjectChanged = function(data)
                {
                    this._trigger(Sheets.Events.FloatingObjectChanged, data)
                };
                Sheet.prototype.triggerFloatingObjectSelectionChanged = function(data)
                {
                    this._trigger(Sheets.Events.FloatingObjectSelectionChanged, data)
                };
                Sheet.prototype.triggerPictureChanged = function(data)
                {
                    this._trigger(Sheets.Events.PictureChanged, data)
                };
                Sheet.prototype.triggerPictureSelectionChanged = function(data)
                {
                    this._trigger(Sheets.Events.PictureSelectionChanged, data)
                };
                Sheet.prototype.triggerCustomFloatingObjectLoaded = function(data)
                {
                    this._trigger(Sheets.Events.CustomFloatingObjectLoaded, data)
                };
                Sheet.prototype.triggerTouchToolStripOpening = function(data)
                {
                    this._trigger(Sheets.Events.TouchToolStripOpening, data)
                };
                Sheet.prototype.triggerCommentChanged = function(data)
                {
                    this._trigger(Sheets.Events.CommentChanged, data)
                };
                Sheet.prototype.triggerEditEnd = function(data)
                {
                    this._trigger(Sheets.Events.EditEnd, data)
                };
                Sheet.prototype.triggerEditStarted = function(data)
                {
                    this._trigger(Sheets.Events.EditStarted, data)
                };
                Sheet.prototype.triggerFormulaTextBoxTextChanged = function(data)
                {
                    this._trigger("FormulaTextBoxTextChanged", data)
                };
                Sheet.prototype.triggerFormulaTextBoxCaretChanged = function(data)
                {
                    this._trigger("FormulaTextBoxCaretChanged", data)
                };
                Sheet.sheetId = 1;
                return Sheet
            })();
        Sheets.Sheet = Sheet;
        var ImportExportOptions = (function()
            {
                function ImportExportOptions(flags)
                {
                    var IncludeRowHeader = 1,
                        IncludeColumnHeader = 2,
                        UnFormatted = 8,
                        ImportFormula = 16,
                        self = this;
                    self.rowHeader = ((flags & IncludeRowHeader) === IncludeRowHeader);
                    self.columnHeader = ((flags & IncludeColumnHeader) === IncludeColumnHeader);
                    self.unFormatted = ((flags & UnFormatted) === UnFormatted);
                    self.formula = ((flags & ImportFormula) === ImportFormula);
                    self.expandRows = true;
                    self.expandColumns = true
                }
                ImportExportOptions.prototype.fixOptions = function(sheet)
                {
                    if (!sheet)
                    {
                        return
                    }
                    if (sheet.getColumnCount(2) <= 0)
                    {
                        this.rowHeader = false
                    }
                    if (sheet.getRowCount(1) <= 0)
                    {
                        this.columnHeader = false
                    }
                };
                return ImportExportOptions
            })();
        function raiseInvalidRangeException(item, value, start, end)
        {
            throw new Error(Sheets.SR.Exp_InvalidAndSpace + item + Sheets.SR.ColonSpace + value + Sheets.SR.MustBeBetween + start + Sheets.SR.SpaceAndSpace + end + Sheets.SR.RightBracketFullStop);
        }
        var staticMembers = (function()
            {
                function staticMembers(){}
                staticMembers.saveTable = function(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount)
                {
                    var savedTables = {};
                    var tables = src.getTables();
                    if (tables)
                    {
                        if (srcRow < 0)
                        {
                            srcRow = 0;
                            rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                        }
                        if (srcColumn < 0)
                        {
                            srcColumn = 0;
                            columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                        }
                        var srcTableManager = src._tableManager;
                        var range = new Sheets.Range(srcRow, srcColumn, rowCount, columnCount);
                        for (var i = tables.length - 1; i >= 0; i--)
                        {
                            var table = tables[i];
                            if (range.containsRange(table.range()))
                            {
                                srcTableManager._tableList.splice(i, 1);
                                table._clearSheetModelFormula();
                                savedTables[table.name()] = {
                                    jsonData: JSON.stringify(table.toJSON()), dataSource: table.bindingPath() ? keyword_undefined : table.getSource()
                                }
                            }
                        }
                    }
                    return savedTables
                };
                staticMembers.restoreTableForCopyTo = function(savedTables, src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount)
                {
                    if (srcRow < 0)
                    {
                        srcRow = 0
                    }
                    if (srcColumn < 0)
                    {
                        srcColumn = 0
                    }
                    if (destRow < 0)
                    {
                        destRow = 0
                    }
                    if (destColumn < 0)
                    {
                        destColumn = 0
                    }
                    var srcTableManager = src._tableManager;
                    var destTableManager = dest._tableManager;
                    for (var name in savedTables)
                    {
                        var tableData = savedTables[name],
                            jsonData = tableData.jsonData,
                            dataSource = tableData.dataSource;
                        var srcTable = new Sheets.SheetTable;
                        srcTable._setOwner(srcTableManager);
                        srcTable.fromJSON(JSON.parse(jsonData));
                        srcTableManager._tableList.push(srcTable);
                        srcTable._syncSheetModelFormula();
                        if (dataSource)
                        {
                            srcTable.copyDataSourceImp(dataSource)
                        }
                        var destTable = new Sheets.SheetTable;
                        destTable._setOwner(destTableManager);
                        destTable.fromJSON(JSON.parse(jsonData));
                        var destTableRange = destTable.range();
                        destTable.name(destTableManager.getNoConflictTableName(destTable.name()));
                        destTable._moveToCore(destRow + destTableRange.row - srcRow, destColumn + destTableRange.col - srcColumn);
                        destTableManager._tableList.push(destTable);
                        destTable._syncSheetModelFormula();
                        if (dataSource)
                        {
                            destTable.copyDataSourceImp(dataSource)
                        }
                    }
                };
                staticMembers.restoreTableForMoveTo = function(savedTables, src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount)
                {
                    if (srcRow < 0)
                    {
                        srcRow = 0
                    }
                    if (srcColumn < 0)
                    {
                        srcColumn = 0
                    }
                    if (destRow < 0)
                    {
                        destRow = 0
                    }
                    if (destColumn < 0)
                    {
                        destColumn = 0
                    }
                    var destTableManager = dest._tableManager;
                    for (var name in savedTables)
                    {
                        var tableData = savedTables[name],
                            jsonData = tableData.jsonData,
                            dataSource = tableData.dataSource;
                        var destTable = new Sheets.SheetTable;
                        destTable._setOwner(destTableManager);
                        destTable.fromJSON(JSON.parse(jsonData));
                        var destTableRange = destTable.range();
                        destTable._moveToCore(destRow + destTableRange.row - srcRow, destColumn + destTableRange.col - srcColumn);
                        destTableManager._tableList.push(destTable);
                        destTable._syncSheetModelFormula();
                        if (dataSource)
                        {
                            destTable.copyDataSourceImp(dataSource)
                        }
                    }
                };
                staticMembers.copyTo = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, option, ignoreFilteredOutRow)
                {
                    var self = staticMembers,
                        srcCalcModel = src._getCalcModel(),
                        destCalcModel = dest._getCalcModel();
                    self.checkArguments(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount);
                    if ((option & 64) > 0)
                    {
                        self.copyStyle(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                    }
                    if ((option & 1) > 0 && (option & 2) > 0)
                    {
                        var savedTables = self.saveTable(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount)
                    }
                    src.suspendCalcService();
                    dest.suspendCalcService();
                    var savedValues = keyword_null;
                    if ((option & 256) > 0)
                    {
                        savedValues = self.copyBindingPath(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                    }
                    try
                    {
                        if ((option & 1) > 0)
                        {
                            self.copyValue(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow);
                            if ((option & 2) === 0)
                            {
                                self.clearFormula(dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                            }
                            if ((option & 256) > 0)
                            {
                                var count = savedValues.length;
                                var baseRow = destRow < 0 ? 0 : destRow;
                                var baseCol = destColumn < 0 ? 0 : destColumn;
                                for (var i = 0; i < count; i++)
                                {
                                    var cv = savedValues[i];
                                    if (ignoreFilteredOutRow && dest.isRowFilterOut(baseRow + cv.row))
                                    {
                                        continue
                                    }
                                    dest.setValue(baseRow + cv.row, baseCol + cv.col, cv.value)
                                }
                            }
                        }
                        if ((option & 2) > 0)
                        {
                            Sheets.Calc.CalcOperatorAdjustor.copyFormula(srcCalcModel, srcRow, srcColumn, destCalcModel, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                        }
                    }
                    finally
                    {
                        if ((option & 1) > 0 && (option & 2) > 0)
                        {
                            self.restoreTableForCopyTo(savedTables, src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount)
                        }
                        src.resumeCalcService();
                        dest.resumeCalcService()
                    }
                    if ((option & 512) > 0)
                    {
                        self.copyConditionalFormatRules(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount)
                    }
                    if ((option & 4) > 0)
                    {
                        self.copyComment(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                    }
                    if ((option & 128) > 0)
                    {
                        self.copyTag(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount)
                    }
                    if ((option & 16) > 0)
                    {
                        self.copySparkline(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount)
                    }
                    if ((option & 8) > 0)
                    {
                        if (srcRow < 0)
                        {
                            self.copyColumnRangeGroup(src, srcColumn, dest, destColumn, copyColumnCount)
                        }
                        if (srcColumn < 0)
                        {
                            self.copyRowRangeGroup(src, srcRow, dest, destRow, copyRowCount)
                        }
                    }
                    if ((option & 32) > 0)
                    {
                        self.copySpan(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount)
                    }
                    if (srcRow < 0)
                    {
                        self.copyColumnAxis(src, srcColumn, dest, destColumn, copyColumnCount, option)
                    }
                    if (srcColumn < 0)
                    {
                        self.copyRowAxis(src, srcRow, dest, destRow, copyRowCount, option, ignoreFilteredOutRow)
                    }
                    if (srcRow < 0 && destRow < 0 && srcColumn < 0 && destColumn < 0)
                    {
                        self.copySheetInfo(src, dest, option)
                    }
                };
                staticMembers.checkArguments = function(src, fromRow, fromColumn, dest, toRow, toColumn, rowCount, columnCount)
                {
                    if (!src)
                    {
                        throw new Error(Sheets.SR.Exp_SrcIsNull);
                    }
                    if (!dest)
                    {
                        throw new Error(Sheets.SR.Exp_DestIsNull);
                    }
                    if (fromRow < -1 || fromRow >= src.getRowCount())
                    {
                        raiseInvalidRangeException("from row index", fromRow, "-1", (src.getRowCount() - 1))
                    }
                    if (fromColumn < -1 || fromColumn >= src.getColumnCount())
                    {
                        raiseInvalidRangeException("from column index", fromColumn, "-1", (src.getColumnCount() - 1))
                    }
                    if (toRow < -1 || toRow >= dest.getRowCount())
                    {
                        raiseInvalidRangeException("to row index", toRow, "-1", (dest.getRowCount() - 1))
                    }
                    if (toColumn < -1 || toColumn >= dest.getColumnCount())
                    {
                        raiseInvalidRangeException("to column index", toColumn, "-1", (dest.getColumnCount() - 1))
                    }
                    var fromColumn2 = fromColumn;
                    if (fromColumn < 0)
                    {
                        fromColumn2 = 0;
                        columnCount = src.getColumnCount()
                    }
                    var toColumn2 = toColumn < 0 ? 0 : toColumn;
                    if (columnCount < 1 || fromColumn2 + columnCount > src.getColumnCount() || toColumn2 + columnCount > dest.getColumnCount())
                    {
                        raiseInvalidRangeException("column count", columnCount, "1", Math_min(src.getColumnCount() - fromColumn2, dest.getColumnCount() - toColumn2))
                    }
                    var fromRow2 = fromRow;
                    if (fromRow < 0)
                    {
                        fromRow2 = 0;
                        rowCount = src.getRowCount()
                    }
                    var toRow2 = toRow < 0 ? 0 : toRow;
                    if (rowCount < 1 || fromRow2 + rowCount > src.getRowCount() || toRow2 + rowCount > dest.getRowCount())
                    {
                        raiseInvalidRangeException("row count", rowCount, "1", Math_min(src.getRowCount() - fromRow2, dest.getRowCount() - toRow2))
                    }
                };
                staticMembers.copyValue = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                {
                    var crossSheet = !(src === dest && src._name === dest._name);
                    var hRowCount,
                        hColumnCount,
                        r,
                        c,
                        value;
                    if (srcRow < 0)
                    {
                        var colHeader = 1;
                        var fColumn = srcColumn;
                        var tColumn = destColumn;
                        hRowCount = Math_min(src.getRowCount(colHeader), dest.getRowCount(colHeader));
                        hColumnCount = copyColumnCount;
                        if (srcColumn < 0)
                        {
                            fColumn = 0;
                            hColumnCount = src.getColumnCount()
                        }
                        if (destColumn < 0)
                        {
                            tColumn = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    value = src._sheetModelManager.getDataModel(colHeader).getValue(r, fColumn + c);
                                    if (typeof(value) === const_undefined || value === keyword_null)
                                    {
                                        if (src.isColumnBound(fColumn + c) && (r === src.colHeaderAutoTextIndex || (r === hRowCount - 1 && src.colHeaderAutoTextIndex === -1)))
                                        {
                                            value = src.getDataColumnName(fColumn + c)
                                        }
                                    }
                                    if (typeof(value) === const_undefined || value === keyword_null)
                                    {
                                        dest._setValueInternal(r, tColumn + c, keyword_null, colHeader, false)
                                    }
                                    else
                                    {
                                        dest._setValueInternal(r, tColumn + c, staticMembers.cloneObject(value), colHeader, false)
                                    }
                                }
                            }
                        }
                        else
                        {
                            var savedColumnHeaderValues = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    value = src._sheetModelManager.getDataModel(colHeader).getValue(r, fColumn + c);
                                    if (typeof(value) === const_undefined || value === keyword_null)
                                    {
                                        if (src.isColumnBound(fColumn + c) && (r === src.colHeaderAutoTextIndex || (r === hRowCount - 1 && src.colHeaderAutoTextIndex === -1)))
                                        {
                                            value = src.getDataColumnName(fColumn + c)
                                        }
                                    }
                                    if (typeof(value) !== const_undefined && value !== keyword_null)
                                    {
                                        savedColumnHeaderValues.setValue(r, c, staticMembers.cloneObject(value))
                                    }
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest._setValueInternal(r, tColumn + c, savedColumnHeaderValues.getValue(r, c), colHeader, false)
                                }
                            }
                        }
                    }
                    if (srcColumn < 0)
                    {
                        var rowHeader = 2;
                        var fRow = srcRow;
                        var tRow = destRow;
                        hRowCount = copyRowCount;
                        hColumnCount = Math_min(src.getColumnCount(rowHeader), dest.getColumnCount(rowHeader));
                        if (srcRow < 0)
                        {
                            fRow = 0;
                            hRowCount = src.getRowCount()
                        }
                        if (destRow < 0)
                        {
                            tRow = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    value = src._sheetModelManager.getDataModel(rowHeader).getValue(fRow + r, c);
                                    if (typeof(value) === const_undefined || value === keyword_null)
                                    {
                                        dest._setValueInternal(tRow + r, c, keyword_null, rowHeader, false)
                                    }
                                    else
                                    {
                                        dest._setValueInternal(tRow + r, c, staticMembers.cloneObject(value), rowHeader, false)
                                    }
                                }
                            }
                        }
                        else
                        {
                            var savedRowHeaderValues = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    value = src._sheetModelManager.getDataModel(rowHeader).getValue(fRow + r, c);
                                    if (typeof(value) !== const_undefined && value !== keyword_null)
                                    {
                                        savedRowHeaderValues.setValue(r, c, staticMembers.cloneObject(value))
                                    }
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest._setValueInternal(tRow + r, c, savedRowHeaderValues.getValue(r, c), rowHeader, false)
                                }
                            }
                        }
                    }
                    var viewport = 3;
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = copyRowCount;
                    var columnCount = copyColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    if (crossSheet)
                    {
                        for (r = 0; r < rowCount; r++)
                        {
                            if (ignoreFilteredOutRow && dest.isRowFilterOut(toRow + r))
                            {
                                continue
                            }
                            for (c = 0; c < columnCount; c++)
                            {
                                value = src.getValue(fromRow + r, fromColumn + c, viewport);
                                if (typeof(value) === const_undefined || value === keyword_null)
                                {
                                    dest._setValueInternal(toRow + r, toColumn + c, keyword_null, viewport, false)
                                }
                                else
                                {
                                    dest._setValueInternal(toRow + r, toColumn + c, staticMembers.cloneObject(value), viewport, false)
                                }
                            }
                        }
                    }
                    else
                    {
                        var savedValues = new Sheets._GcSheetModel(rowCount, columnCount, keyword_null);
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                value = src.getValue(fromRow + r, fromColumn + c, viewport);
                                if (typeof(value) !== const_undefined && value !== keyword_null)
                                {
                                    savedValues.setValue(r, c, staticMembers.cloneObject(value))
                                }
                            }
                        }
                        for (r = 0; r < rowCount; r++)
                        {
                            if (ignoreFilteredOutRow && dest.isRowFilterOut(toRow + r))
                            {
                                continue
                            }
                            for (c = 0; c < columnCount; c++)
                            {
                                dest._setValueInternal(toRow + r, toColumn + c, savedValues.getValue(r, c), viewport, false)
                            }
                        }
                    }
                };
                staticMembers._copyMoveBindingPath = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, isMove, ignoreFilteredOutRow)
                {
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = copyRowCount;
                    var columnCount = copyColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var savedValues = [];
                    var crossSheet = !(src === dest && src._name === dest._name);
                    if (crossSheet)
                    {
                        var path;
                        for (var r = 0; r < rowCount; r++)
                        {
                            for (var c = 0; c < columnCount; c++)
                            {
                                path = src.getBindingPath(fromRow + r, fromColumn + c);
                                dest.setBindingPath(toRow + r, toColumn + c, path);
                                if (path)
                                {
                                    savedValues.push({
                                        row: r, col: c, value: src.getValue(fromRow + r, fromColumn + c)
                                    })
                                }
                                if (isMove)
                                {
                                    src.setBindingPath(fromRow + r, fromColumn + c, keyword_null)
                                }
                            }
                        }
                    }
                    else
                    {
                        var savedPaths = new Sheets._GcSheetModel(rowCount, columnCount, keyword_null);
                        var path;
                        for (var r = 0; r < rowCount; r++)
                        {
                            for (var c = 0; c < columnCount; c++)
                            {
                                path = src.getBindingPath(fromRow + r, fromColumn + c);
                                savedPaths.setBindingPath(r, c, path);
                                if (path)
                                {
                                    savedValues.push({
                                        row: r, col: c, value: src.getValue(fromRow + r, fromColumn + c)
                                    })
                                }
                                if (isMove)
                                {
                                    src.setBindingPath(fromRow + r, fromColumn + c, keyword_null)
                                }
                            }
                        }
                        for (var r = 0; r < rowCount; r++)
                        {
                            if (ignoreFilteredOutRow && dest.isRowFilterOut(toRow + r))
                            {
                                continue
                            }
                            for (var c = 0; c < columnCount; c++)
                            {
                                dest.setBindingPath(toRow + r, toColumn + c, savedPaths.getBindingPath(r, c))
                            }
                        }
                    }
                    return savedValues
                };
                staticMembers.copyBindingPath = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                {
                    return staticMembers._copyMoveBindingPath(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, false, ignoreFilteredOutRow)
                };
                staticMembers.cloneObject = function(obj)
                {
                    var objClone;
                    if (typeof(obj) === const_number || typeof(obj) === const_string || typeof(obj) === const_boolean || typeof(obj) === const_undefined)
                    {
                        objClone = obj;
                        return objClone
                    }
                    else if (obj instanceof Date)
                    {
                        objClone = new Date(obj);
                        return objClone
                    }
                    else if (obj instanceof Object)
                    {
                        objClone = new obj.constructor
                    }
                    else
                    {
                        objClone = new obj.constructor(obj.valueOf())
                    }
                    for (var key in obj)
                    {
                        if (obj.hasOwnProperty(key) && objClone[key] !== obj[key])
                        {
                            if (typeof(this[key]) === 'object')
                            {
                                objClone[key] = staticMembers.cloneObject(obj[key])
                            }
                            else
                            {
                                objClone[key] = obj[key]
                            }
                        }
                    }
                    objClone.toString = obj.toString;
                    objClone.valueOf = obj.valueOf;
                    return objClone
                };
                staticMembers.clearFormula = function(sheet, row, column, rowCount, columnCount, ignoreFilteredOutRow)
                {
                    if (row < 0)
                    {
                        row = 0;
                        rowCount = sheet.getRowCount()
                    }
                    if (column < 0)
                    {
                        column = 0;
                        columnCount = sheet.getColumnCount()
                    }
                    for (var r = 0; r < rowCount; r++)
                    {
                        if (ignoreFilteredOutRow && sheet.isRowFilterOut(r + row))
                        {
                            continue
                        }
                        for (var c = 0; c < columnCount; c++)
                        {
                            sheet.setFormula(r + row, c + column, keyword_null)
                        }
                    }
                };
                staticMembers.copyStyle = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                {
                    var crossSheet = !(src === dest && src._name === dest._name);
                    var hRowCount,
                        hColumnCount,
                        r,
                        c,
                        style;
                    if (srcRow < 0)
                    {
                        var fColumn = srcColumn;
                        var tColumn = destColumn;
                        hRowCount = Math_min(src.getRowCount(1), dest.getRowCount(1));
                        hColumnCount = copyColumnCount;
                        if (srcColumn < 0)
                        {
                            fColumn = 0;
                            hColumnCount = src.getColumnCount()
                        }
                        if (destColumn < 0)
                        {
                            tColumn = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    style = src.getCompositeStyle(r, fColumn + c, 1);
                                    if (!style)
                                    {
                                        dest.setStyle(r, tColumn + c, keyword_null, 1)
                                    }
                                    else
                                    {
                                        dest.setStyle(r, tColumn + c, style.clone(), 1)
                                    }
                                }
                            }
                        }
                        else
                        {
                            var savedColumnHeaderStyles = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    style = src.getCompositeStyle(r, fColumn + c, 1);
                                    if (style)
                                    {
                                        savedColumnHeaderStyles.setValue(r, c, style.clone())
                                    }
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest.setStyle(r, tColumn + c, savedColumnHeaderStyles.getValue(r, c), 1)
                                }
                            }
                        }
                    }
                    if (srcColumn < 0)
                    {
                        var fRow = srcRow;
                        var tRow = destRow;
                        hRowCount = copyRowCount;
                        hColumnCount = Math_min(src.getColumnCount(2), dest.getColumnCount(2));
                        if (srcRow < 0)
                        {
                            fRow = 0;
                            hRowCount = src.getRowCount()
                        }
                        if (destRow < 0)
                        {
                            tRow = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    style = src.getCompositeStyle(fRow + r, c, 2);
                                    if (!style)
                                    {
                                        dest.setStyle(tRow + r, c, keyword_null, 2)
                                    }
                                    else
                                    {
                                        dest.setStyle(tRow + r, c, style.clone(), 2)
                                    }
                                }
                            }
                        }
                        else
                        {
                            var savedRowHeaderStyles = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    style = src.getCompositeStyle(fRow + r, c, 2);
                                    if (style)
                                    {
                                        savedRowHeaderStyles.setValue(r, c, style.clone())
                                    }
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest.setStyle(tRow + r, c, savedRowHeaderStyles.getValue(r, c), 2)
                                }
                            }
                        }
                    }
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = copyRowCount;
                    var columnCount = copyColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    if (crossSheet)
                    {
                        for (r = 0; r < rowCount; r++)
                        {
                            if (ignoreFilteredOutRow && dest.isRowFilterOut(toRow + r))
                            {
                                continue
                            }
                            for (c = 0; c < columnCount; c++)
                            {
                                style = src.getCompositeStyle(fromRow + r, fromColumn + c, 3);
                                if (!style)
                                {
                                    dest.setStyle(toRow + r, toColumn + c, keyword_null, 3)
                                }
                                else
                                {
                                    dest.setStyle(toRow + r, toColumn + c, style.clone(), 3)
                                }
                            }
                        }
                    }
                    else
                    {
                        var savedStyles = new Sheets._GcSheetModel(rowCount, columnCount, keyword_null);
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                style = src.getCompositeStyle(fromRow + r, fromColumn + c, 3);
                                if (style)
                                {
                                    savedStyles.setValue(r, c, style.clone())
                                }
                            }
                        }
                        for (r = 0; r < rowCount; r++)
                        {
                            if (ignoreFilteredOutRow && dest.isRowFilterOut(toRow + r))
                            {
                                continue
                            }
                            for (c = 0; c < columnCount; c++)
                            {
                                dest.setStyle(toRow + r, toColumn + c, savedStyles.getValue(r, c), 3)
                            }
                        }
                    }
                };
                staticMembers.copyConditionalFormatRules = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount)
                {
                    var dealedRanges = new Array;
                    var conditionalFormats = src._conditionalFormats;
                    if (!conditionalFormats)
                    {
                        return
                    }
                    for (var rowOffset = 0; rowOffset < copyRowCount; rowOffset++)
                    {
                        for (var colOffset = 0; colOffset < copyColumnCount; colOffset++)
                        {
                            var srcRules = conditionalFormats.getRules(srcRow + rowOffset, srcColumn + colOffset);
                            for (var ruleIndex = 0; ruleIndex < srcRules.length; ruleIndex++)
                            {
                                var rule = srcRules[ruleIndex];
                                var tempRanges = new Array;
                                for (var rangeIndex = 0; rangeIndex < rule.ranges.length; rangeIndex++)
                                {
                                    var range = rule.ranges[rangeIndex];
                                    if (Sheets.ArrayHelper.indexOf(dealedRanges, range) > -1 || !range.contains(srcRow + rowOffset, srcColumn + colOffset))
                                    {
                                        continue;
                                        ;
                                    }
                                    else
                                    {
                                        dealedRanges.push(range)
                                    }
                                    var newRange = new Sheets.Range(-1, -1, -1, -1);
                                    newRange.row = destRow + rowOffset;
                                    newRange.col = destColumn + colOffset;
                                    if (range.row + range.rowCount >= copyRowCount + srcRow)
                                    {
                                        newRange.rowCount = copyRowCount - rowOffset
                                    }
                                    else
                                    {
                                        if (srcRow < range.row)
                                        {
                                            newRange.rowCount = range.rowCount
                                        }
                                        else
                                        {
                                            newRange.rowCount = range.row + range.rowCount - srcRow
                                        }
                                    }
                                    if (range.col + range.colCount >= copyColumnCount + srcColumn)
                                    {
                                        newRange.colCount = copyColumnCount - colOffset
                                    }
                                    else
                                    {
                                        if (srcColumn < range.col)
                                        {
                                            newRange.colCount = range.colCount
                                        }
                                        else
                                        {
                                            newRange.colCount = range.col + range.colCount - srcColumn
                                        }
                                    }
                                    tempRanges.push(newRange)
                                }
                                rule.ranges = rule.ranges.concat(tempRanges)
                            }
                        }
                    }
                    conditionalFormats._resetCache()
                };
                staticMembers.copyComment = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                {
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = copyRowCount;
                    var columnCount = copyColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var destComments = [];
                    for (var r = 0; r < rowCount; r++)
                    {
                        if (ignoreFilteredOutRow && dest.isRowFilterOut(toRow + r))
                        {
                            continue
                        }
                        for (var c = 0; c < columnCount; c++)
                        {
                            var comment = src.getComment(fromRow + r, fromColumn + c);
                            if (comment)
                            {
                                var clonedComment = comment.clone();
                                clonedComment._sheet = dest;
                                clonedComment._rowIndex = toRow + r;
                                clonedComment._colIndex = toColumn + c;
                                clonedComment._location = clonedComment._defaultLocation;
                                destComments.push(clonedComment)
                            }
                        }
                    }
                    for (var i = 0, length = destComments.length; i < length; i++)
                    {
                        var comment = destComments[i];
                        dest.setComment(comment._rowIndex, comment._colIndex, comment)
                    }
                };
                staticMembers.copyTag = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                {
                    var crossSheet = !(src === dest && src._name === dest._name);
                    var hRowCount,
                        hColumnCount,
                        r,
                        c,
                        tag;
                    if (srcRow < 0)
                    {
                        var colHeader = 1;
                        var fColumn = srcColumn;
                        var tColumn = destColumn;
                        hRowCount = Math_min(src.getRowCount(colHeader), dest.getRowCount(colHeader));
                        hColumnCount = copyColumnCount;
                        if (srcColumn < 0)
                        {
                            fColumn = 0;
                            hColumnCount = src.getColumnCount()
                        }
                        if (destColumn < 0)
                        {
                            tColumn = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    tag = src.getTag(r, fColumn + c, colHeader);
                                    if (typeof(tag) === const_undefined || tag === keyword_null)
                                    {
                                        dest.setTag(r, tColumn + c, keyword_null, colHeader)
                                    }
                                    else
                                    {
                                        dest.setTag(r, tColumn + c, staticMembers.cloneObject(tag), colHeader)
                                    }
                                }
                            }
                            for (c = 0; c < hColumnCount; c++)
                            {
                                tag = src.getTag(-1, fColumn + c);
                                if (typeof(tag) === const_undefined || tag === keyword_null)
                                {
                                    dest.setTag(-1, tColumn + c, keyword_null)
                                }
                                else
                                {
                                    dest.setTag(-1, tColumn + c, staticMembers.cloneObject(tag))
                                }
                            }
                        }
                        else
                        {
                            var savedColumnHeaderTags = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    tag = src.getTag(r, fColumn + c, colHeader);
                                    if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                    {
                                        savedColumnHeaderTags.setTag(r, c, staticMembers.cloneObject(tag))
                                    }
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest.setTag(r, tColumn + c, savedColumnHeaderTags.getTag(r, c), colHeader)
                                }
                            }
                            var savedColumnTags = {};
                            for (c = 0; c < hColumnCount; c++)
                            {
                                tag = src.getTag(-1, fColumn + c);
                                if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                {
                                    savedColumnTags[c] = staticMembers.cloneObject(tag)
                                }
                            }
                            for (var item in savedColumnTags)
                            {
                                var index = parseInt(item);
                                if (!isNaN(index))
                                {
                                    dest.setTag(-1, tColumn + index, savedColumnTags[index])
                                }
                            }
                        }
                    }
                    if (srcColumn < 0)
                    {
                        var rowHeader = 2;
                        var fRow = srcRow;
                        var tRow = destRow;
                        hRowCount = copyRowCount;
                        hColumnCount = Math_min(src.getColumnCount(rowHeader), dest.getColumnCount(rowHeader));
                        if (srcRow < 0)
                        {
                            fRow = 0;
                            hRowCount = src.getRowCount()
                        }
                        if (destRow < 0)
                        {
                            tRow = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    tag = src.getTag(fRow + r, c, rowHeader);
                                    if (typeof(tag) === const_undefined || tag === keyword_null)
                                    {
                                        dest.setTag(tRow + r, c, keyword_null, rowHeader)
                                    }
                                    else
                                    {
                                        dest.setTag(tRow + r, c, staticMembers.cloneObject(tag), rowHeader)
                                    }
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                tag = src.getTag(fRow + r, -1);
                                if (typeof(tag) === const_undefined || tag === keyword_null)
                                {
                                    dest.setTag(tRow + r, -1, keyword_null)
                                }
                                else
                                {
                                    dest.setTag(tRow + r, -1, staticMembers.cloneObject(tag))
                                }
                            }
                        }
                        else
                        {
                            var savedRowHeaderTags = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    tag = src.getTag(fRow + r, c, rowHeader);
                                    if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                    {
                                        savedRowHeaderTags.setTag(r, c, staticMembers.cloneObject(tag))
                                    }
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest.setTag(tRow + r, c, savedRowHeaderTags.getTag(r, c), rowHeader)
                                }
                            }
                            var savedRowTags = {};
                            for (r = 0; r < hRowCount; r++)
                            {
                                tag = src.getTag(fRow + r, -1);
                                if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                {
                                    savedRowTags[r] = staticMembers.cloneObject(tag)
                                }
                            }
                            for (var item in savedRowTags)
                            {
                                var index = parseInt(item);
                                if (!isNaN(index))
                                {
                                    dest.setTag(tRow + index, -1, savedRowTags[index])
                                }
                            }
                        }
                    }
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = copyRowCount;
                    var columnCount = copyColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    if (crossSheet)
                    {
                        for (r = 0; r < rowCount; r++)
                        {
                            if (ignoreFilteredOutRow && dest.isRowFilterOut(toRow + r))
                            {
                                continue
                            }
                            for (c = 0; c < columnCount; c++)
                            {
                                tag = src.getTag(fromRow + r, fromColumn + c);
                                if (typeof(tag) === const_undefined || tag === keyword_null)
                                {
                                    dest.setTag(toRow + r, toColumn + c, keyword_null)
                                }
                                else
                                {
                                    dest.setTag(toRow + r, toColumn + c, staticMembers.cloneObject(tag))
                                }
                            }
                        }
                    }
                    else
                    {
                        var savedTags = new Sheets._GcSheetModel(rowCount, columnCount, keyword_null);
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                tag = src.getTag(fromRow + r, fromColumn + c);
                                if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                {
                                    savedTags.setTag(r, c, staticMembers.cloneObject(tag))
                                }
                            }
                        }
                        for (r = 0; r < rowCount; r++)
                        {
                            if (ignoreFilteredOutRow && dest.isRowFilterOut(toRow + r))
                            {
                                continue
                            }
                            for (c = 0; c < columnCount; c++)
                            {
                                dest.setTag(toRow + r, toColumn + c, savedTags.getTag(r, c))
                            }
                        }
                    }
                    if (srcRow < 0 && srcColumn < 0)
                    {
                        if (!crossSheet)
                        {
                            return
                        }
                        var tempTag = staticMembers.cloneObject(src.tag());
                        dest.tag(tempTag)
                    }
                };
                staticMembers.copyColumnRangeGroup = function(src, srcColumn, dest, destColumn, copyColumnCount)
                {
                    var fromColumn = srcColumn;
                    var toColumn = destColumn;
                    var columnCount = copyColumnCount;
                    if (fromColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var crossSheet = !(src === dest && src._name === dest._name);
                    if (crossSheet)
                    {
                        if (src.colRangeGroup && dest.colRangeGroup)
                        {
                            staticMembers.crossSheetCopyRangeGroup(src.colRangeGroup, fromColumn, dest.colRangeGroup, toColumn, columnCount)
                        }
                    }
                    else
                    {
                        var columnGroup = src.colRangeGroup;
                        if (columnGroup)
                        {
                            columnGroup._copy(fromColumn, toColumn, columnCount)
                        }
                    }
                };
                staticMembers.crossSheetCopyRangeGroup = function(srcGroup, from, destGroup, to, count)
                {
                    if (from < 0)
                    {
                        from = 0
                    }
                    if (to < 0)
                    {
                        to = 0
                    }
                    var clonedItems = [];
                    if (srcGroup)
                    {
                        var index = Sheets.ArrayHelper.nextNonEmptyIndex(srcGroup.items, from - 1);
                        while (index >= 0 && index < (from + count))
                        {
                            clonedItems[index - from] = new Sheets.RangeGroupItemInfo(srcGroup.items[index]);
                            index = Sheets.ArrayHelper.nextNonEmptyIndex(srcGroup.items, index)
                        }
                    }
                    if (destGroup)
                    {
                        Sheets.ArrayHelper.clear(destGroup.items, to, count);
                        if (clonedItems.length > 0)
                        {
                            for (var key in clonedItems)
                            {
                                if (clonedItems.hasOwnProperty(key))
                                {
                                    var value = clonedItems[key];
                                    destGroup.items[to + key] = value
                                }
                            }
                        }
                    }
                };
                staticMembers.copySparkline = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow)
                {
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = copyRowCount;
                    var columnCount = copyColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var crossSheet = !(src === dest && src._name === dest._name);
                    var sparkline;
                    if (crossSheet)
                    {
                        sparkline = dest._sparklineGroupManager;
                        if (sparkline)
                        {
                            sparkline._exCopy(src, fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, ignoreFilteredOutRow)
                        }
                    }
                    else
                    {
                        sparkline = src._sparklineGroupManager;
                        if (sparkline)
                        {
                            sparkline._copy(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, ignoreFilteredOutRow)
                        }
                    }
                };
                staticMembers.copyRowRangeGroup = function(src, srcRow, dest, destRow, copyRowCount)
                {
                    var fromRow = srcRow;
                    var toRow = destRow;
                    var rowCount = copyRowCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    var crossSheet = !(src === dest && src._name === dest._name);
                    if (crossSheet)
                    {
                        if (src.rowRangeGroup && dest.rowRangeGroup)
                        {
                            staticMembers.crossSheetCopyRangeGroup(src.rowRangeGroup, fromRow, dest.rowRangeGroup, toRow, rowCount)
                        }
                    }
                    else
                    {
                        var rowGroup = src.rowRangeGroup;
                        if (rowGroup)
                        {
                            rowGroup._copy(fromRow, toRow, rowCount)
                        }
                    }
                };
                staticMembers.copySpan = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount)
                {
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = copyRowCount;
                    var columnCount = copyColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (fromColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var crossSheet = !(src === dest && src._name === dest._name);
                    if (srcRow < 0)
                    {
                        if (crossSheet)
                        {
                            staticMembers.crossSheetCopySpans(src._getSpanModel(1), -1, fromColumn, dest._getSpanModel(1), -1, toColumn, -1, columnCount)
                        }
                        else
                        {
                            var csm = src._getSpanModel(1);
                            if (csm)
                            {
                                csm.copy(-1, fromColumn, -1, toColumn, -1, columnCount)
                            }
                        }
                    }
                    if (srcColumn < 0)
                    {
                        if (crossSheet)
                        {
                            staticMembers.crossSheetCopySpans(src._getSpanModel(2), fromRow, -1, dest._getSpanModel(2), toRow, -1, rowCount, -1)
                        }
                        else
                        {
                            var rsm = src._getSpanModel(2);
                            if (rsm)
                            {
                                rsm.copy(fromRow, -1, toRow, -1, rowCount, -1)
                            }
                        }
                    }
                    if (crossSheet)
                    {
                        staticMembers.crossSheetCopySpans(src._getSpanModel(), fromRow, fromColumn, dest._getSpanModel(), toRow, toColumn, rowCount, columnCount)
                    }
                    else
                    {
                        var sm = src._getSpanModel(3);
                        if (sm)
                        {
                            sm.copy(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount)
                        }
                    }
                };
                staticMembers.crossSheetCopySpans = function(srcSpanModel, fromRow, fromColumn, destSpanModel, toRow, toColumn, rowCount, columnCount)
                {
                    var srcSpans = staticMembers.getSpans(srcSpanModel);
                    var destSpans = staticMembers.getSpans(destSpanModel);
                    var addList = [],
                        i,
                        j,
                        cs,
                        span;
                    if (fromRow === -1)
                    {
                        if (srcSpans && srcSpans.length > 0)
                        {
                            for (i = 0; i < srcSpans.length; i++)
                            {
                                cs = srcSpans[i];
                                if (cs.col >= fromColumn && cs.col + cs.colCount <= fromColumn + columnCount)
                                {
                                    addList.push(new Sheets.Range(cs.row, toColumn + cs.col - fromColumn, cs.rowCount, cs.colCount))
                                }
                            }
                        }
                        if (destSpans && destSpans.length > 0)
                        {
                            for (i = 0; i < destSpans.length; i++)
                            {
                                cs = destSpans[i];
                                if (cs.col >= toColumn && cs.col < toColumn + columnCount)
                                {
                                    for (j = 0; j < destSpanModel.length; j++)
                                    {
                                        span = destSpanModel[j];
                                        if (span.row === cs.row && span.col === cs.col)
                                        {
                                            destSpanModel.splice(j, 1);
                                            break
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else if (fromColumn === -1)
                    {
                        if (srcSpans && srcSpans.length > 0)
                        {
                            for (i = 0; i < srcSpans.length; i++)
                            {
                                cs = srcSpans[i];
                                if (fromRow <= cs.row && cs.row + cs.rowCount <= fromRow + rowCount)
                                {
                                    addList.push(new Sheets.Range(toRow + cs.row - fromRow, cs.col, cs.rowCount, cs.colCount))
                                }
                            }
                        }
                        if (destSpans && destSpans.length > 0)
                        {
                            for (i = 0; i < destSpans.length; i++)
                            {
                                cs = destSpans[i];
                                if (cs.row >= toRow && cs.row < toRow + rowCount)
                                {
                                    for (j = 0; j < destSpanModel.length; j++)
                                    {
                                        span = destSpanModel[j];
                                        if (span.row === cs.row && span.col === cs.col)
                                        {
                                            destSpanModel.splice(j, 1);
                                            break
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        if (srcSpans && srcSpans.length > 0)
                        {
                            for (i = 0; i < srcSpans.length; i++)
                            {
                                cs = srcSpans[i];
                                if (fromRow <= cs.row && cs.row < fromRow + rowCount && fromColumn <= cs.col && cs.col < fromColumn + columnCount)
                                {
                                    addList.push(new Sheets.Range(toRow + cs.row - fromRow, toColumn + cs.col - fromColumn, cs.rowCount, cs.colCount))
                                }
                            }
                        }
                        if (destSpans && destSpans.length > 0)
                        {
                            for (i = 0; i < destSpans.length; i++)
                            {
                                cs = destSpans[i];
                                if (cs.row >= toRow && cs.row < toRow + rowCount && cs.col >= toColumn && cs.col < toColumn + columnCount)
                                {
                                    for (j = 0; j < destSpanModel.length; j++)
                                    {
                                        span = destSpanModel[j];
                                        if (span.row === cs.row && span.col === cs.col)
                                        {
                                            destSpanModel.splice(j, 1);
                                            break
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (addList.length > 0 && destSpanModel)
                    {
                        for (i = 0; i < addList.length; i++)
                        {
                            var cr = addList[i];
                            destSpanModel.push(cr)
                        }
                    }
                };
                staticMembers.getSpans = function(spanModel)
                {
                    if (spanModel && spanModel.length > 0)
                    {
                        return spanModel.slice(0)
                    }
                    return keyword_null
                };
                staticMembers.copyColumnAxis = function(src, srcColumn, dest, destColumn, copyColumnCount, option)
                {
                    var fromColumn = srcColumn;
                    var toColumn = destColumn;
                    var columnCount = copyColumnCount;
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var colHeader = 1;
                    for (var c = 0; c < columnCount; c++)
                    {
                        var width = src._getActualColumnWidth(c + fromColumn);
                        if (width !== keyword_undefined && width !== keyword_null)
                        {
                            dest.setColumnWidth(c + toColumn, width)
                        }
                        var visible = src.getColumnVisible(c + fromColumn);
                        if (visible !== keyword_undefined && visible !== keyword_null)
                        {
                            dest.setColumnVisible(c + toColumn, visible)
                        }
                        if ((option & 64) > 0)
                        {
                            var style = src.getActualStyle(-1, c + fromColumn);
                            if (!style)
                            {
                                dest.setStyle(-1, c + toColumn, keyword_null)
                            }
                            else
                            {
                                dest.setStyle(-1, c + toColumn, style.clone())
                            }
                            style = src.getActualStyle(-1, c + fromColumn, colHeader);
                            if (!style)
                            {
                                dest.setStyle(-1, c + toColumn, keyword_null, colHeader)
                            }
                            else
                            {
                                dest.setStyle(-1, c + toColumn, style.clone(), colHeader)
                            }
                        }
                    }
                    var colHeaderRowCount = Math_min(src.getRowCount(colHeader), dest.getRowCount(colHeader));
                    for (var r = 0; r < colHeaderRowCount; r++)
                    {
                        var height = src._getActualRowHeight(r, colHeader);
                        if (height !== keyword_undefined && height !== keyword_null)
                        {
                            dest.setRowHeight(r, height, colHeader)
                        }
                    }
                };
                staticMembers.cloneAxisInfo = function(srcInfo, fromIndex, count)
                {
                    var ret = [];
                    for (var index = 0; index < count; index++)
                    {
                        var axisInfo = srcInfo[fromIndex + index];
                        if (!axisInfo)
                        {
                            ret.push(keyword_null)
                        }
                        else
                        {
                            var vColumn = {};
                            for (var key in axisInfo)
                            {
                                if (axisInfo.hasOwnProperty(key))
                                {
                                    vColumn[key] = axisInfo[key]
                                }
                            }
                            ret.push(vColumn)
                        }
                    }
                    return ret
                };
                staticMembers.getAxisInfo = function(srcInfo, fromIndex, count)
                {
                    var ret = [];
                    for (var index = 0; index < count; index++)
                    {
                        ret.push(srcInfo[fromIndex + index])
                    }
                    return ret
                };
                staticMembers.setAxisInfo = function(infos, destAxis, toIndex)
                {
                    if (destAxis)
                    {
                        for (var index = 0; index < infos.length; index++)
                        {
                            destAxis[toIndex + index] = infos[index]
                        }
                    }
                };
                staticMembers.copyRowAxis = function(src, srcRow, dest, destRow, copyRowCount, option, ignoreFilteredOutRow)
                {
                    var fromRow = srcRow;
                    var toRow = destRow;
                    var rowCount = copyRowCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    var rowHeader = 2;
                    for (var r = 0; r < rowCount; r++)
                    {
                        if (ignoreFilteredOutRow && dest.isRowFilterOut(r + toRow))
                        {
                            continue
                        }
                        var height = src._getActualRowHeight(r + fromRow);
                        if (height !== keyword_undefined && height !== keyword_null)
                        {
                            dest.setRowHeight(r + toRow, height)
                        }
                        var visible = src.getRowVisible(r + fromRow);
                        if (visible !== keyword_undefined && visible !== keyword_null)
                        {
                            dest.setRowVisible(r + toRow, visible)
                        }
                        if ((option & 64) > 0)
                        {
                            var style = src.getActualStyle(r + fromRow, -1);
                            if (!style)
                            {
                                dest.setStyle(r + toRow, -1, keyword_null)
                            }
                            else
                            {
                                dest.setStyle(r + toRow, -1, style.clone())
                            }
                            style = src.getActualStyle(r + fromRow, -1, rowHeader);
                            if (!style)
                            {
                                dest.setStyle(r + toRow, -1, keyword_null, rowHeader)
                            }
                            else
                            {
                                dest.setStyle(r + toRow, -1, style.clone(), rowHeader)
                            }
                        }
                    }
                    var rowHeaderColCount = Math_min(src.getColumnCount(rowHeader), dest.getColumnCount(rowHeader));
                    for (var c = 0; c < rowHeaderColCount; c++)
                    {
                        var width = src._getActualColumnWidth(c, rowHeader);
                        if (width !== keyword_undefined && width !== keyword_null)
                        {
                            dest.setColumnWidth(c, width, rowHeader)
                        }
                    }
                };
                staticMembers.copySheetInfo = function(src, dest, option)
                {
                    if (!(src === dest && src._name === dest._name))
                    {
                        if ((option & 64) > 0)
                        {
                            var colHeader = 1;
                            var rowHeader = 2;
                            dest.setDefaultStyle(src.getDefaultStyle().clone());
                            dest.setDefaultStyle(src.getDefaultStyle(colHeader).clone(), colHeader);
                            dest.setDefaultStyle(src.getDefaultStyle(rowHeader).clone(), rowHeader)
                        }
                        dest.defaults.colWidth = src.defaults.colWidth;
                        dest.defaults.rowHeight = src.defaults.rowHeight;
                        dest.defaults.rowHeaderColWidth = src.defaults.rowHeaderColWidth
                    }
                };
                staticMembers.moveTo = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, option)
                {
                    var self = staticMembers,
                        operatorAdjustor = Sheets.util.hasCalc() && Sheets.Calc.CalcOperatorAdjustor;
                    self.checkArguments(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount);
                    if ((option & 64) > 0)
                    {
                        self.moveStyle(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                    }
                    if ((option & 1) > 0 && (option & 2) > 0)
                    {
                        var savedTables = self.saveTable(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                    }
                    src.suspendCalcService();
                    dest.suspendCalcService();
                    var savedValues = keyword_null;
                    if ((option & 256) > 0)
                    {
                        savedValues = self.moveBindingPath(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                    }
                    try
                    {
                        if ((option & 1) > 0)
                        {
                            self.moveValue(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount);
                            if ((option & 2) === 0)
                            {
                                self.clearFormula(dest, destRow, destColumn, moveRowCount, moveColumnCount)
                            }
                            if ((option & 256) > 0)
                            {
                                var count = savedValues.length;
                                var baseRow = destRow < 0 ? 0 : destRow;
                                var baseCol = destColumn < 0 ? 0 : destColumn;
                                for (var i = 0; i < count; i++)
                                {
                                    var cv = savedValues[i];
                                    dest.setValue(baseRow + cv.row, baseCol + cv.col, cv.value)
                                }
                            }
                        }
                        self.adjustCustomNameOnMove(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount);
                        if ((option & 2) > 0)
                        {
                            self.moveFormula(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                        }
                    }
                    finally
                    {
                        if ((option & 1) > 0 && (option & 2) > 0)
                        {
                            self.restoreTableForMoveTo(savedTables, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                        }
                        src.resumeCalcService();
                        dest.resumeCalcService()
                    }
                    if ((option & 512) > 0)
                    {
                        self.moveConditionalFormatRules(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                    }
                    if ((option & 4) > 0)
                    {
                        self.moveComment(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                    }
                    if ((option & 128) > 0)
                    {
                        self.moveTag(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                    }
                    if ((option & 16) > 0)
                    {
                        self.moveSparkline(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                    }
                    if ((option & 8) > 0)
                    {
                        if (srcRow < 0)
                        {
                            self.moveColumnRangeGroup(src, srcColumn, dest, destColumn, moveColumnCount)
                        }
                        if (srcColumn < 0)
                        {
                            self.moveRowRangeGroup(src, srcRow, dest, destRow, moveRowCount)
                        }
                    }
                    if ((option & 32) > 0)
                    {
                        self.moveSpan(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                    }
                    if (srcRow < 0)
                    {
                        self.moveColumnAxis(src, srcColumn, dest, destColumn, moveColumnCount, option)
                    }
                    if (srcColumn < 0)
                    {
                        self.moveRowAxis(src, srcRow, dest, destRow, moveRowCount, option)
                    }
                    if (srcRow < 0 && destRow < 0 && srcColumn < 0 && destColumn < 0)
                    {
                        self.moveSheetInfo(src, dest, option)
                    }
                    if (srcRow < 0)
                    {
                        var fColumn = srcColumn;
                        var hColumnCount = moveColumnCount;
                        if (srcColumn < 0)
                        {
                            fColumn = 0;
                            hColumnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                        }
                        for (var c = 0; c < hColumnCount; c++)
                        {
                            if (src.isColumnBound(fColumn + c))
                            {
                                src._sheetModelManager.getColInfos().reset(fColumn + c)
                            }
                        }
                    }
                };
                staticMembers.moveFormula = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    var srcCalcModel = src._getCalcModel(),
                        destCalcModel = dest._getCalcModel();
                    if (!srcCalcModel || !destCalcModel)
                    {
                        return
                    }
                    var operatorAdjustor = srcCalcModel.getCalcService().getOperatorAdjustor();
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = moveRowCount;
                    var columnCount = moveColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var crossSheet = !(src === dest && src._name === dest._name);
                    srcCalcModel.unlinkCellExpression(fromRow, fromColumn, rowCount, columnCount);
                    operatorAdjustor._addDependentsToAdjust(srcCalcModel, fromRow, fromColumn, rowCount, columnCount);
                    destCalcModel.unlinkCellExpression(toRow, toColumn, rowCount, columnCount);
                    operatorAdjustor._addDependentsToAdjust(destCalcModel, toRow, toColumn, rowCount, columnCount);
                    var srcModel = src._getModel();
                    var destModel = dest._getModel();
                    var nodes = [],
                        r,
                        c;
                    for (r = 0; r < rowCount; r++)
                    {
                        for (c = 0; c < columnCount; c++)
                        {
                            var expr = srcCalcModel._getExpr(r + fromRow, c + fromColumn);
                            var arrayInfo = srcCalcModel.getArrayInfo(r + fromRow, c + fromColumn);
                            var workingExpr = srcCalcModel._getWorkingExpr(r + fromRow, c + fromColumn);
                            if (expr)
                            {
                                nodes.push({
                                    expr: expr, arrayInfo: arrayInfo, workingExpr: workingExpr
                                });
                                srcModel.setFormula(r + fromRow, c + fromColumn, keyword_null);
                                srcCalcModel._clearAllExpr(r + fromRow, c + fromColumn)
                            }
                            else
                            {
                                nodes.push(keyword_null)
                            }
                        }
                    }
                    var calcSvc = dest.getCalcService();
                    var toArrayInfo;
                    for (r = 0; r < rowCount; r++)
                    {
                        for (c = 0; c < columnCount; c++)
                        {
                            var exprInfo = nodes.shift();
                            if (exprInfo)
                            {
                                var expr = exprInfo.expr;
                                var arrayInfo = exprInfo.arrayInfo;
                                if (calcSvc && arrayInfo && arrayInfo.row === fromRow + r && arrayInfo.col === fromColumn + c)
                                {
                                    toArrayInfo = new Sheets.Range(r + toRow, c + toColumn, arrayInfo.rowCount, arrayInfo.colCount);
                                    destModel.setFormula(r + toRow, c + toColumn, calcSvc.unparseWithoutCulture(destCalcModel.source, expr, r + toRow, c + toColumn), toArrayInfo)
                                }
                                if (arrayInfo)
                                {
                                    arrayInfo.row = r + toRow;
                                    arrayInfo.col = c + toColumn
                                }
                                destCalcModel._setExpr(r + toRow, c + toColumn, expr);
                                destCalcModel._setArrayInfo(r + toRow, c + toColumn, arrayInfo ? toArrayInfo : keyword_undefined);
                                destCalcModel._setWorkingExpr(r + toRow, c + toColumn, exprInfo.workingExpr)
                            }
                            else
                            {
                                if (calcSvc)
                                {
                                    destModel.setFormula(r + toRow, c + toColumn, keyword_undefined)
                                }
                                destCalcModel._setExpr(r + toRow, c + toColumn, keyword_undefined);
                                destCalcModel._setArrayInfo(r + toRow, c + toColumn, keyword_undefined)
                            }
                        }
                    }
                    operatorAdjustor._addCellsToAdjust(srcCalcModel, fromRow, fromColumn, rowCount, columnCount);
                    operatorAdjustor._addCellsToAdjust(destCalcModel, toRow, toColumn, rowCount, columnCount);
                    operatorAdjustor.adjustFormulasOnMoveSwap(srcCalcModel.source, fromRow, fromColumn, destCalcModel.source, toRow, toColumn, rowCount, columnCount, true);
                    if (crossSheet === true)
                    {
                        operatorAdjustor.adjustFormulasOnMoveSwap(srcCalcModel.source, fromRow, fromColumn, destCalcModel.source, toRow, toColumn, rowCount, columnCount, true)
                    }
                };
                staticMembers.moveValue = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    var crossSheet = !(src === dest && src._name === dest._name);
                    var hRowCount,
                        hColumnCount,
                        r,
                        c,
                        value;
                    if (srcRow < 0)
                    {
                        var colHeader = 1;
                        var fColumn = srcColumn;
                        var tColumn = destColumn;
                        hRowCount = Math_min(src.getRowCount(colHeader), dest.getRowCount(colHeader));
                        hColumnCount = moveColumnCount;
                        if (srcColumn < 0)
                        {
                            fColumn = 0;
                            hColumnCount = src.getColumnCount()
                        }
                        if (destColumn < 0)
                        {
                            tColumn = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    value = src._sheetModelManager.getDataModel(colHeader).getValue(r, fColumn + c);
                                    if (typeof(value) === const_undefined || value === keyword_null)
                                    {
                                        if (src.isColumnBound(fColumn + c) && (r === src.colHeaderAutoTextIndex || (r === hRowCount - 1 && src.colHeaderAutoTextIndex === -1)))
                                        {
                                            value = src.getDataColumnName(fColumn + c)
                                        }
                                    }
                                    if (typeof(value) === const_undefined || value === keyword_null)
                                    {
                                        dest._setValueInternal(r, tColumn + c, keyword_null, colHeader, false)
                                    }
                                    else
                                    {
                                        dest._setValueInternal(r, tColumn + c, value, colHeader, false);
                                        src._setValueInternal(r, fColumn + c, keyword_null, colHeader, false)
                                    }
                                }
                            }
                        }
                        else
                        {
                            var savedColumnHeaderValues = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    value = src._sheetModelManager.getDataModel(colHeader).getValue(r, fColumn + c);
                                    if (typeof(value) === const_undefined || value === keyword_null)
                                    {
                                        if (src.isColumnBound(fColumn + c) && (r === src.colHeaderAutoTextIndex || (r === hRowCount - 1 && src.colHeaderAutoTextIndex === -1)))
                                        {
                                            value = src.getDataColumnName(fColumn + c)
                                        }
                                    }
                                    if (typeof(value) !== const_undefined && value !== keyword_null)
                                    {
                                        savedColumnHeaderValues.setValue(r, c, value)
                                    }
                                    src._setValueInternal(r, fColumn + c, keyword_null, colHeader, false)
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest._setValueInternal(r, tColumn + c, savedColumnHeaderValues.getValue(r, c), colHeader, false)
                                }
                            }
                        }
                    }
                    var rowHeader = 2;
                    if (srcColumn < 0)
                    {
                        var fRow = srcRow;
                        var tRow = destRow;
                        hRowCount = moveRowCount;
                        hColumnCount = Math_min(src.getColumnCount(rowHeader), dest.getColumnCount(rowHeader));
                        if (srcRow < 0)
                        {
                            fRow = 0;
                            hRowCount = src.getRowCount()
                        }
                        if (destRow < 0)
                        {
                            tRow = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    value = src.getValue(fRow + r, c, rowHeader);
                                    if (typeof(value) === const_undefined || value === keyword_null)
                                    {
                                        dest._setValueInternal(tRow + r, c, keyword_null, rowHeader, false)
                                    }
                                    else
                                    {
                                        dest._setValueInternal(tRow + r, c, value, rowHeader, false);
                                        src._setValueInternal(fRow + r, c, keyword_null, rowHeader, false)
                                    }
                                }
                            }
                        }
                        else
                        {
                            var savedRowHeaderValues = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    value = src._getModel(rowHeader).getValue(fRow + r, c);
                                    if (typeof(value) !== const_undefined && value !== keyword_null)
                                    {
                                        savedRowHeaderValues.setValue(r, c, value)
                                    }
                                    src._setValueInternal(fRow + r, c, keyword_null, rowHeader, false)
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest._setValueInternal(tRow + r, c, savedRowHeaderValues.getValue(r, c), rowHeader, false)
                                }
                            }
                        }
                    }
                    var viewport = 3;
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = moveRowCount;
                    var columnCount = moveColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    if (crossSheet)
                    {
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                value = src.getValue(fromRow + r, fromColumn + c);
                                if (typeof(value) === const_undefined || value === keyword_null)
                                {
                                    dest._setValueInternal(toRow + r, toColumn + c, keyword_null, viewport, false)
                                }
                                else
                                {
                                    dest._setValueInternal(toRow + r, toColumn + c, value, viewport, false);
                                    src._setValueInternal(fromRow + r, fromColumn + c, keyword_null, viewport, false)
                                }
                            }
                        }
                    }
                    else
                    {
                        var savedValues = new Sheets._GcSheetModel(rowCount, columnCount, keyword_null);
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                value = src.getValue(fromRow + r, fromColumn + c);
                                if (typeof(value) !== const_undefined && value !== keyword_null)
                                {
                                    savedValues.setValue(r, c, value)
                                }
                            }
                        }
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                src._setValueInternal(fromRow + r, fromColumn + c, keyword_null, viewport, false)
                            }
                        }
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                dest._setValueInternal(toRow + r, toColumn + c, savedValues.getValue(r, c), viewport, false)
                            }
                        }
                    }
                };
                staticMembers.adjustCustomNameOnMove = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    var self = staticMembers,
                        sheetNames;
                    if (!src.parent || !src.parent.sheets)
                    {
                        sheetNames = src.getCustomNames();
                        if (sheetNames && sheetNames.length > 0)
                        {
                            for (var nameIndex = 0; nameIndex < sheetNames.length; nameIndex++)
                            {
                                oldExpr = sheetNames[nameIndex].getExpression();
                                newExpr = self.adjustCustomNameExpOnMove(src, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, oldExpr);
                                if (newExpr !== oldExpr)
                                {
                                    sheetNames[nameIndex].setExpression(newExpr)
                                }
                            }
                        }
                        return
                    }
                    var sheets = src.parent.sheets,
                        workBookNames = src.parent.getCustomNames(),
                        oldExpr,
                        newExpr;
                    if (workBookNames && workBookNames.length > 0)
                    {
                        for (var nameIndex = 0; nameIndex < workBookNames.length; nameIndex++)
                        {
                            oldExpr = workBookNames[nameIndex].getExpression();
                            newExpr = self.adjustCustomNameExpOnMove(null, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, oldExpr);
                            if (newExpr !== oldExpr)
                            {
                                workBookNames[nameIndex].setExpression(newExpr)
                            }
                        }
                    }
                    for (var sheetIndex = 0; sheetIndex < sheets.length; sheetIndex++)
                    {
                        sheetNames = sheets[sheetIndex].getCustomNames();
                        if (sheetNames && sheetNames.length > 0)
                        {
                            for (var nameIndex = 0; nameIndex < sheetNames.length; nameIndex++)
                            {
                                oldExpr = sheetNames[nameIndex].getExpression();
                                newExpr = self.adjustCustomNameExpOnMove(sheets[sheetIndex], src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, oldExpr);
                                if (newExpr !== oldExpr)
                                {
                                    sheetNames[nameIndex].setExpression(newExpr)
                                }
                            }
                        }
                    }
                };
                staticMembers.adjustCustomNameExpOnMove = function(owner, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, expr)
                {
                    var self = staticMembers,
                        offsetRow = destRow - srcRow,
                        offsetColumn = destColumn - srcColumn,
                        srcSource = src._getSheetSource(),
                        destSource = dest._getSheetSource();
                    if (expr.t === 10)
                    {
                        var bopExp = expr;
                        var left = bopExp.left,
                            right = bopExp.right;
                        var newLeft = self.adjustCustomNameExpOnMove(owner, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, left);
                        var newRight = self.adjustCustomNameExpOnMove(owner, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, right);
                        if (left !== newLeft || right !== newRight)
                        {
                            return new Sheets.Calc.Expressions.BinaryOperatorExpression(bopExp.operator, newLeft, newRight)
                        }
                    }
                    else if (expr.t === 11)
                    {
                        var uopExp = expr;
                        var opd = uopExp.operand;
                        var newOpd = self.adjustCustomNameExpOnMove(owner, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, opd);
                        if (opd !== newOpd)
                        {
                            return new Sheets.Calc.Expressions.UnaryOperatorExpression(uopExp.operator, newOpd)
                        }
                    }
                    else if (expr.t === 7)
                    {
                        var funcExp = expr,
                            hasChange = false,
                            newArgs = [],
                            arg;
                        for (var argIndex = 0; argIndex < funcExp.args.length; argIndex++)
                        {
                            arg = (funcExp.args[argIndex]);
                            var newArg = self.adjustCustomNameExpOnMove(owner, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, arg);
                            hasChange = hasChange || arg !== newArg;
                            newArgs.push(newArg)
                        }
                        if (hasChange)
                        {
                            return new Sheets.Calc.Expressions.FunctionExpression(funcExp.fn, newArgs)
                        }
                    }
                    else if (expr.t === 1)
                    {
                        var eCellExp = expr;
                        if (eCellExp.source === srcSource && !eCellExp.rowRelative && eCellExp.row >= srcRow && eCellExp.row < srcRow + moveRowCount && !eCellExp.columnRelative && eCellExp.column >= srcColumn && eCellExp.column < srcColumn + moveColumnCount)
                        {
                            return new Sheets.Calc.Expressions.ExternalCellExpression(destSource, eCellExp.row + offsetRow, eCellExp.column + offsetColumn)
                        }
                    }
                    else if (expr.t === 22)
                    {}
                    else if (expr.t === 0)
                    {
                        var cellExp = expr;
                        if (owner === src && !cellExp.rowRelative && cellExp.row >= srcRow && cellExp.row < srcRow + moveRowCount && !cellExp.columnRelative && cellExp.column >= srcColumn && cellExp.column < srcColumn + moveColumnCount)
                        {
                            return new Sheets.Calc.Expressions.ExternalCellExpression(destSource, cellExp.row + offsetRow, cellExp.column + offsetColumn)
                        }
                    }
                    else if (expr.t === 3)
                    {
                        var eRangeExp = expr,
                            startCellAbsolute = !eRangeExp.startRowRelative && !eRangeExp.startColumnRelative,
                            endCellAbsolute = !eRangeExp.endRowRelative && !eRangeExp.endColumnRelative;
                        if (eRangeExp.source === srcSource && (startCellAbsolute && eRangeExp.startRow >= srcRow && eRangeExp.startColumn >= srcColumn || endCellAbsolute && eRangeExp.endColumn < srcColumn + moveColumnCount && eRangeExp.endRow < srcRow + moveRowCount))
                        {
                            return new Sheets.Calc.Expressions.ExternalRangeExpression(destSource, eRangeExp.startRow + (startCellAbsolute ? offsetRow : 0), eRangeExp.startColumn + (startCellAbsolute ? offsetColumn : 0), eRangeExp.endRow + (endCellAbsolute ? offsetRow : 0), eRangeExp.endColumn + (endCellAbsolute ? offsetColumn : 0), eRangeExp.startRowRelative, eRangeExp.startColumnRelative, eRangeExp.endRowRelative, eRangeExp.endColumnRelative)
                        }
                    }
                    else if (expr.t === 23)
                    {}
                    else if (expr.t === 2)
                    {
                        var rangeExp = expr,
                            startCellAbsolute = !rangeExp.startRowRelative && !rangeExp.startColumnRelative,
                            endCellAbsolute = !rangeExp.endRowRelative && !rangeExp.endColumnRelative;
                        if (owner === src && (startCellAbsolute && rangeExp.startRow >= srcRow && rangeExp.startColumn >= srcColumn || endCellAbsolute && rangeExp.endColumn < srcColumn + moveColumnCount && rangeExp.endRow < srcRow + moveRowCount))
                        {
                            return new Sheets.Calc.Expressions.ExternalRangeExpression(destSource, rangeExp.startRow + (startCellAbsolute ? offsetRow : 0), rangeExp.startColumn + (startCellAbsolute ? offsetColumn : 0), rangeExp.endRow + (endCellAbsolute ? offsetRow : 0), rangeExp.endColumn + (endCellAbsolute ? offsetColumn : 0), rangeExp.startRowRelative, rangeExp.startColumnRelative, rangeExp.endRowRelative, rangeExp.endColumnRelative)
                        }
                    }
                    else if (expr.t === 14)
                    {
                        var partExp = expr,
                            argExp = partExp.argument,
                            newExp = self.adjustCustomNameExpOnMove(owner, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, argExp);
                        if (argExp !== newExp)
                        {
                            return new Sheets.Calc.Expressions.ParenthesesExpression(newExp)
                        }
                    }
                    return expr
                };
                staticMembers.adjustCustomNameOnInsertRemove = function(src, index, count, isInsert, isRow)
                {
                    var self = staticMembers,
                        sheetNames;
                    if (!src.parent || !src.parent.sheets)
                    {
                        sheetNames = src.getCustomNames();
                        if (sheetNames && sheetNames.length > 0)
                        {
                            for (var nameIndex = 0; nameIndex < sheetNames.length; nameIndex++)
                            {
                                oldExpr = sheetNames[nameIndex].getExpression();
                                newExpr = self.adjustCustomNameExpOnInsertRemove(src, src, index, count, isInsert, isRow, oldExpr);
                                if (newExpr !== oldExpr)
                                {
                                    sheetNames[nameIndex].setExpression(newExpr)
                                }
                            }
                        }
                        return
                    }
                    var sheets = src.parent.sheets,
                        workBookNames = src.parent.getCustomNames(),
                        oldExpr,
                        newExpr;
                    if (workBookNames && workBookNames.length > 0)
                    {
                        for (var nameIndex = 0; nameIndex < workBookNames.length; nameIndex++)
                        {
                            oldExpr = workBookNames[nameIndex].getExpression();
                            newExpr = self.adjustCustomNameExpOnInsertRemove(null, src, index, count, isInsert, isRow, oldExpr);
                            if (newExpr !== oldExpr)
                            {
                                workBookNames[nameIndex].setExpression(newExpr)
                            }
                        }
                    }
                    for (var sheetIndex = 0; sheetIndex < sheets.length; sheetIndex++)
                    {
                        sheetNames = sheets[sheetIndex].getCustomNames();
                        if (sheetNames && sheetNames.length > 0)
                        {
                            for (var nameIndex = 0; nameIndex < sheetNames.length; nameIndex++)
                            {
                                oldExpr = sheetNames[nameIndex].getExpression();
                                newExpr = self.adjustCustomNameExpOnInsertRemove(sheets[sheetIndex], src, index, count, isInsert, isRow, oldExpr);
                                if (newExpr !== oldExpr)
                                {
                                    sheetNames[nameIndex].setExpression(newExpr)
                                }
                            }
                        }
                    }
                };
                staticMembers.adjustCustomNameExpOnInsertRemove = function(owner, src, index, count, isInsert, isRow, expr)
                {
                    var self = staticMembers,
                        srcSource = src._getSheetSource(),
                        refError = new Sheets.Calc.Expressions.ExternalErrorExpression(srcSource, Sheets.Calc.Errors.Reference);
                    if (expr.t === 10)
                    {
                        var bopExp = expr;
                        var left = bopExp.left,
                            right = bopExp.right;
                        var newLeft = self.adjustCustomNameExpOnInsertRemove(owner, src, index, count, isInsert, isRow, left);
                        var newRight = self.adjustCustomNameExpOnInsertRemove(owner, src, index, count, isInsert, isRow, right);
                        if (left !== newLeft || right !== newRight)
                        {
                            return new Sheets.Calc.Expressions.BinaryOperatorExpression(bopExp.operator, newLeft, newRight)
                        }
                    }
                    else if (expr.t === 11)
                    {
                        var uopExp = expr;
                        var opd = uopExp.operand;
                        var newOpd = self.adjustCustomNameExpOnInsertRemove(owner, src, index, count, isInsert, isRow, opd);
                        if (opd !== newOpd)
                        {
                            return new Sheets.Calc.Expressions.UnaryOperatorExpression(uopExp.operator, newOpd)
                        }
                    }
                    else if (expr.t === 7)
                    {
                        var funcExp = expr,
                            hasChange = false,
                            newArgs = [],
                            arg;
                        for (var argIndex = 0; argIndex < funcExp.args.length; argIndex++)
                        {
                            arg = (funcExp.args[argIndex]);
                            var newArg = self.adjustCustomNameExpOnInsertRemove(owner, src, index, count, isInsert, isRow, arg);
                            hasChange = hasChange || arg !== newArg;
                            newArgs.push(newArg)
                        }
                        if (hasChange)
                        {
                            return new Sheets.Calc.Expressions.FunctionExpression(funcExp.fn, newArgs)
                        }
                    }
                    else if (expr.t === 22)
                    {}
                    else if ((expr.t === 1) || (expr.t === 0))
                    {
                        var eCellExp = expr;
                        var source = expr.source || owner && owner._getSheetSource();
                        if (source && source === srcSource && (isRow && !eCellExp.rowRelative || !isRow && !eCellExp.columnRelative))
                        {
                            if (isRow && isInsert)
                            {
                                if (eCellExp.row >= index)
                                {
                                    return new Sheets.Calc.Expressions.ExternalCellExpression(srcSource, eCellExp.row + count, eCellExp.column, eCellExp.rowRelative, eCellExp.columnRelative)
                                }
                            }
                            else if (!isRow && isInsert)
                            {
                                if (eCellExp.column >= index)
                                {
                                    return new Sheets.Calc.Expressions.ExternalCellExpression(srcSource, eCellExp.row, eCellExp.column + count, eCellExp.rowRelative, eCellExp.columnRelative)
                                }
                            }
                            else if (isRow && !isInsert)
                            {
                                if (eCellExp.row >= index + count)
                                {
                                    return new Sheets.Calc.Expressions.ExternalCellExpression(srcSource, eCellExp.row - count, eCellExp.column, eCellExp.rowRelative, eCellExp.columnRelative)
                                }
                                else if (eCellExp.row >= index)
                                {
                                    return refError
                                }
                            }
                            else
                            {
                                if (eCellExp.column >= index + count)
                                {
                                    return new Sheets.Calc.Expressions.ExternalCellExpression(srcSource, eCellExp.row, eCellExp.column - count, eCellExp.rowRelative, eCellExp.columnRelative)
                                }
                                else if (eCellExp.column >= index)
                                {
                                    return refError
                                }
                            }
                        }
                    }
                    else if (expr.t === 23)
                    {}
                    else if ((expr.t === 3) || (expr.t === 2))
                    {
                        var rangeExp = expr;
                        var source = expr.source || owner && owner._getSheetSource();
                        var startRow = rangeExp.startRow,
                            startColumn = rangeExp.startColumn,
                            endRow = rangeExp.endRow,
                            endColumn = rangeExp.endColumn;
                        if (source && source === srcSource)
                        {
                            if (isRow && isInsert)
                            {
                                if (!rangeExp.startRowRelative && startRow >= index)
                                {
                                    startRow += count
                                }
                                if (!rangeExp.endRowRelative && endRow >= index)
                                {
                                    endRow += count
                                }
                                if (startRow !== rangeExp.startRow || endRow !== rangeExp.endRow)
                                {
                                    return new Sheets.Calc.Expressions.ExternalRangeExpression(srcSource, startRow, startColumn, endRow, endColumn, rangeExp.startRowRelative, rangeExp.startColumnRelative, rangeExp.endRowRelative, rangeExp.endColumnRelative)
                                }
                            }
                            else if (!isRow && isInsert)
                            {
                                if (!rangeExp.startColumnRelative && startColumn <= index)
                                {
                                    startColumn += count
                                }
                                if (!rangeExp.endColumnRelative && endColumn >= index)
                                {
                                    endColumn += count
                                }
                                if (startColumn !== rangeExp.startColumn || endColumn !== rangeExp.endColumn)
                                {
                                    return new Sheets.Calc.Expressions.ExternalRangeExpression(srcSource, startRow, startColumn, endRow, endColumn, rangeExp.startRowRelative, rangeExp.startColumnRelative, rangeExp.endRowRelative, rangeExp.endColumnRelative)
                                }
                            }
                            else if (isRow && !isInsert)
                            {
                                if (!rangeExp.startRowRelative && startRow >= index && !rangeExp.endRowRelative && endRow < index + count)
                                {
                                    return refError
                                }
                                else if (rangeExp.startRowRelative && rangeExp.endRowRelative || endRow < index)
                                {
                                    return expr
                                }
                                if (!rangeExp.startRowRelative)
                                {
                                    if (startRow >= index + count)
                                    {
                                        startRow -= count
                                    }
                                    else if (startRow < index)
                                    {}
                                    else if (rangeExp.endRowRelative)
                                    {
                                        return refError
                                    }
                                    else if (startRow > index)
                                    {
                                        startRow = index
                                    }
                                }
                                if (!rangeExp.endRowRelative)
                                {
                                    if (endRow >= index + count)
                                    {
                                        endRow -= count
                                    }
                                    else if (rangeExp.startRowRelative)
                                    {
                                        return refError
                                    }
                                    else if (endRow < index + count)
                                    {
                                        endRow = index - 1
                                    }
                                }
                                if (startRow !== rangeExp.startRow || endRow !== rangeExp.endRow)
                                {
                                    return new Sheets.Calc.Expressions.ExternalRangeExpression(srcSource, startRow, startColumn, endRow, endColumn, rangeExp.startRowRelative, rangeExp.startColumnRelative, rangeExp.endRowRelative, rangeExp.endColumnRelative)
                                }
                            }
                            else
                            {
                                if (!rangeExp.startColumnRelative && startColumn >= index && !rangeExp.endColumnRelative && endColumn < index + count)
                                {
                                    return refError
                                }
                                else if (rangeExp.startColumnRelative && rangeExp.endColumnRelative || endColumn < index)
                                {
                                    return expr
                                }
                                if (!rangeExp.startColumnRelative)
                                {
                                    if (startColumn >= index + count)
                                    {
                                        startColumn -= count
                                    }
                                    else if (startColumn < index)
                                    {}
                                    else if (rangeExp.endColumnRelative)
                                    {
                                        return refError
                                    }
                                    else if (startColumn > index)
                                    {
                                        startColumn = index
                                    }
                                }
                                if (!rangeExp.endColumnRelative)
                                {
                                    if (endColumn >= index + count)
                                    {
                                        endColumn -= count
                                    }
                                    else if (rangeExp.startColumnRelative)
                                    {
                                        return refError
                                    }
                                    else if (endColumn < index + count)
                                    {
                                        endColumn = index - 1
                                    }
                                }
                                if (startColumn !== rangeExp.startColumn || endColumn !== rangeExp.endColumn)
                                {
                                    return new Sheets.Calc.Expressions.ExternalRangeExpression(srcSource, startRow, startColumn, endRow, endColumn, rangeExp.startRowRelative, rangeExp.startColumnRelative, rangeExp.endRowRelative, rangeExp.endColumnRelative)
                                }
                            }
                        }
                    }
                    else if (expr.t === 14)
                    {
                        var partExp = expr,
                            argExp = partExp.argument,
                            newExp = self.adjustCustomNameExpOnInsertRemove(owner, src, index, count, isInsert, isRow, argExp);
                        if (argExp !== newExp)
                        {
                            return new Sheets.Calc.Expressions.ParenthesesExpression(newExp)
                        }
                    }
                    return expr
                };
                staticMembers.moveStyle = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    var crossSheet = !(src === dest && src._name === dest._name);
                    var colHeader = 1,
                        hRowCount,
                        hColumnCount,
                        r,
                        c,
                        style;
                    if (srcRow < 0)
                    {
                        var fColumn = srcColumn;
                        var tColumn = destColumn;
                        hRowCount = Math_min(src.getRowCount(colHeader), dest.getRowCount(colHeader));
                        hColumnCount = moveColumnCount;
                        if (srcColumn < 0)
                        {
                            fColumn = 0;
                            hColumnCount = src.getColumnCount()
                        }
                        if (destColumn < 0)
                        {
                            tColumn = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    style = src.getCompositeStyle(r, fColumn + c, colHeader);
                                    if (!style)
                                    {
                                        dest.setStyle(r, tColumn + c, keyword_null, colHeader)
                                    }
                                    else
                                    {
                                        dest.setStyle(r, tColumn + c, style.clone(), colHeader);
                                        src.setStyle(r, fColumn + c, keyword_null, colHeader)
                                    }
                                }
                            }
                        }
                        else
                        {
                            var savedColumnHeaderStyles = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    style = src.getCompositeStyle(r, fColumn + c, colHeader);
                                    if (style)
                                    {
                                        savedColumnHeaderStyles.setValue(r, c, style.clone())
                                    }
                                    src.setStyle(r, fColumn + c, keyword_null, colHeader)
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest.setStyle(r, tColumn + c, savedColumnHeaderStyles.getValue(r, c), colHeader)
                                }
                            }
                        }
                    }
                    var rowHeader = 2;
                    if (srcColumn < 0)
                    {
                        var fRow = srcRow;
                        var tRow = destRow;
                        hRowCount = moveRowCount;
                        hColumnCount = Math_min(src.getColumnCount(rowHeader), dest.getColumnCount(rowHeader));
                        if (srcRow < 0)
                        {
                            fRow = 0;
                            hRowCount = src.getRowCount()
                        }
                        if (destRow < 0)
                        {
                            tRow = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    style = src.getCompositeStyle(fRow + r, c, rowHeader);
                                    if (!style)
                                    {
                                        dest.setStyle(tRow + r, c, keyword_null, rowHeader)
                                    }
                                    else
                                    {
                                        dest.setStyle(tRow + r, c, style.clone(), rowHeader);
                                        src.setStyle(fRow + r, c, keyword_null, rowHeader)
                                    }
                                }
                            }
                        }
                        else
                        {
                            var savedRowHeaderStyles = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    style = src.getCompositeStyle(fRow + r, c, rowHeader);
                                    if (style)
                                    {
                                        savedRowHeaderStyles.setValue(r, c, style.clone())
                                    }
                                    src.setStyle(fRow + r, c, keyword_null, rowHeader)
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest.setStyle(tRow + r, c, savedRowHeaderStyles.getValue(r, c), rowHeader)
                                }
                            }
                        }
                    }
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = moveRowCount;
                    var columnCount = moveColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    if (crossSheet)
                    {
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                style = src.getCompositeStyle(fromRow + r, fromColumn + c);
                                if (!style)
                                {
                                    dest.setStyle(toRow + r, toColumn + c, keyword_null)
                                }
                                else
                                {
                                    dest.setStyle(toRow + r, toColumn + c, style.clone());
                                    src.setStyle(fromRow + r, fromColumn + c, keyword_null)
                                }
                            }
                        }
                    }
                    else
                    {
                        var savedStyles = new Sheets._GcSheetModel(rowCount, columnCount, keyword_null);
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                style = src.getCompositeStyle(fromRow + r, fromColumn + c);
                                if (style)
                                {
                                    savedStyles.setValue(r, c, style.clone())
                                }
                                src.setStyle(fromRow + r, fromColumn + c, keyword_null)
                            }
                        }
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                dest.setStyle(toRow + r, toColumn + c, savedStyles.getValue(r, c))
                            }
                        }
                    }
                };
                staticMembers.moveTag = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    var crossSheet = !(src === dest && src._name === dest._name);
                    var hRowCount,
                        hColumnCount,
                        r,
                        c,
                        tag;
                    if (srcRow < 0)
                    {
                        var colHeader = 1;
                        var fColumn = srcColumn;
                        var tColumn = destColumn;
                        hRowCount = Math_min(src.getRowCount(colHeader), dest.getRowCount(colHeader));
                        hColumnCount = moveColumnCount;
                        if (srcColumn < 0)
                        {
                            fColumn = 0;
                            hColumnCount = src.getColumnCount()
                        }
                        if (destColumn < 0)
                        {
                            tColumn = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    tag = src.getTag(r, fColumn + c, colHeader);
                                    if (typeof(tag) === const_undefined || tag === keyword_null)
                                    {
                                        dest.setTag(r, tColumn + c, keyword_null, colHeader)
                                    }
                                    else
                                    {
                                        dest.setTag(r, tColumn + c, tag, colHeader);
                                        src.setTag(r, fColumn + c, keyword_null, colHeader)
                                    }
                                }
                            }
                            for (c = 0; c < hColumnCount; c++)
                            {
                                tag = src.getTag(-1, fColumn + c);
                                if (typeof(tag) === const_undefined || tag === keyword_null)
                                {
                                    dest.setTag(-1, tColumn + c, keyword_null)
                                }
                                else
                                {
                                    dest.setTag(-1, tColumn + c, tag);
                                    src.setTag(-1, fColumn + c, keyword_null)
                                }
                            }
                        }
                        else
                        {
                            var savedColumnHeaderTags = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    tag = src.getTag(r, fColumn + c, colHeader);
                                    if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                    {
                                        savedColumnHeaderTags.setTag(r, c, tag)
                                    }
                                    src.setTag(r, fColumn + c, keyword_null, colHeader)
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest.setTag(r, tColumn + c, savedColumnHeaderTags.getTag(r, c), colHeader)
                                }
                            }
                            var savedColumnTags = {};
                            for (c = 0; c < hColumnCount; c++)
                            {
                                tag = src.getTag(-1, fColumn + c);
                                if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                {
                                    savedColumnTags[c] = tag
                                }
                                src.setTag(-1, fColumn + c, keyword_null)
                            }
                            for (var item in savedColumnTags)
                            {
                                var index = parseInt(item);
                                if (!isNaN(index))
                                {
                                    dest.setTag(-1, tColumn + index, savedColumnTags[index])
                                }
                            }
                        }
                    }
                    if (srcColumn < 0)
                    {
                        var rowHeader = 2;
                        var fRow = srcRow;
                        var tRow = destRow;
                        hRowCount = moveRowCount;
                        hColumnCount = Math_min(src.getColumnCount(rowHeader), dest.getColumnCount(rowHeader));
                        if (srcRow < 0)
                        {
                            fRow = 0;
                            hRowCount = src.getRowCount()
                        }
                        if (destRow < 0)
                        {
                            tRow = 0
                        }
                        if (crossSheet)
                        {
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    tag = src.getTag(fRow + r, c, rowHeader);
                                    if (typeof(tag) === const_undefined || tag === keyword_null)
                                    {
                                        dest.setTag(tRow + r, c, keyword_null, rowHeader)
                                    }
                                    else
                                    {
                                        dest.setTag(tRow + r, c, tag, rowHeader);
                                        src.setTag(fRow + r, c, keyword_null, rowHeader)
                                    }
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                tag = src.getTag(fRow + r, -1);
                                if (typeof(tag) === const_undefined || tag === keyword_null)
                                {
                                    dest.setTag(tRow + r, -1, keyword_null)
                                }
                                else
                                {
                                    dest.setTag(tRow + r, -1, tag);
                                    src.setTag(fRow + r, -1, keyword_null)
                                }
                            }
                        }
                        else
                        {
                            var savedRowHeaderTags = new Sheets._GcSheetModel(hRowCount, hColumnCount, keyword_null);
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    tag = src.getTag(fRow + r, c, rowHeader);
                                    if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                    {
                                        savedRowHeaderTags.setTag(r, c, tag)
                                    }
                                    src.setTag(fRow + r, c, keyword_null, rowHeader)
                                }
                            }
                            for (r = 0; r < hRowCount; r++)
                            {
                                for (c = 0; c < hColumnCount; c++)
                                {
                                    dest.setTag(tRow + r, c, savedRowHeaderTags.getTag(r, c), rowHeader)
                                }
                            }
                            var savedRowTags = {};
                            for (r = 0; r < hRowCount; r++)
                            {
                                tag = src.getTag(fRow + r, -1);
                                if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                {
                                    savedRowTags[r] = tag
                                }
                                src.setTag(fRow + r, -1, keyword_null)
                            }
                            for (var item in savedRowTags)
                            {
                                var index = parseInt(item);
                                if (!isNaN(index))
                                {
                                    dest.setTag(tRow + index, -1, savedRowTags[index])
                                }
                            }
                        }
                    }
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = moveRowCount;
                    var columnCount = moveColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    if (crossSheet)
                    {
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                tag = src.getTag(fromRow + r, fromColumn + c);
                                if (typeof(tag) === const_undefined || tag === keyword_null)
                                {
                                    dest.setTag(toRow + r, toColumn + c, keyword_null)
                                }
                                else
                                {
                                    dest.setTag(toRow + r, toColumn + c, tag);
                                    src.setTag(fromRow + r, fromColumn + c, keyword_null)
                                }
                            }
                        }
                    }
                    else
                    {
                        var savedTags = new Sheets._GcSheetModel(rowCount, columnCount, keyword_null);
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                tag = src.getTag(fromRow + r, fromColumn + c);
                                if (typeof(tag) !== const_undefined && tag !== keyword_null)
                                {
                                    savedTags.setTag(r, c, tag)
                                }
                                src.setTag(fromRow + r, fromColumn + c, keyword_null)
                            }
                        }
                        for (r = 0; r < rowCount; r++)
                        {
                            for (c = 0; c < columnCount; c++)
                            {
                                dest.setTag(toRow + r, toColumn + c, savedTags.getTag(r, c))
                            }
                        }
                    }
                    if (srcRow < 0 && srcColumn < 0)
                    {
                        if (!crossSheet)
                        {
                            return
                        }
                        var tempTag = src.tag();
                        src.tag(keyword_null);
                        dest.tag(tempTag)
                    }
                };
                staticMembers.moveConditionalFormatRules = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    this.copyConditionalFormatRules(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount);
                    this._deleteConditionalFormatRange(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                };
                staticMembers._deleteConditionalFormatRange = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    var dealedRanges = new Array;
                    var conditionalFormats = src._conditionalFormats;
                    if (!conditionalFormats)
                    {
                        return
                    }
                    for (var rowOffset = 0; rowOffset < moveRowCount; rowOffset++)
                    {
                        for (var colOffset = 0; colOffset < moveColumnCount; colOffset++)
                        {
                            var srcRules = conditionalFormats.getRules(srcRow + rowOffset, srcColumn + colOffset);
                            for (var ruleIndex = 0; ruleIndex < srcRules.length; ruleIndex++)
                            {
                                var rule = srcRules[ruleIndex];
                                var newRanges = new Array;
                                for (var rangeIndex = 0; rangeIndex < rule.ranges.length; rangeIndex++)
                                {
                                    var range = rule.ranges[rangeIndex];
                                    if (Sheets.ArrayHelper.indexOf(dealedRanges, range) > -1 || !range.contains(srcRow + rowOffset, srcColumn + colOffset))
                                    {
                                        continue;
                                        ;
                                    }
                                    else
                                    {
                                        dealedRanges.push(range)
                                    }
                                    if (srcRow > range.row)
                                    {
                                        var newTopRange = new Sheets.Range(-1, -1, -1, -1);
                                        newTopRange.row = range.row;
                                        newTopRange.col = range.col;
                                        newTopRange.rowCount = srcRow - range.row;
                                        newTopRange.colCount = range.colCount;
                                        newRanges.push(newTopRange)
                                    }
                                    if (srcColumn > range.col)
                                    {
                                        var newLeftRange = new Sheets.Range(-1, -1, -1, -1);
                                        newLeftRange.row = Math_max(srcRow, range.row);
                                        newLeftRange.col = range.col;
                                        newLeftRange.rowCount = Math_min(srcRow + moveRowCount, range.row + range.rowCount) - newLeftRange.row;
                                        newLeftRange.colCount = srcColumn - range.col;
                                        newRanges.push(newLeftRange)
                                    }
                                    if (srcColumn + moveColumnCount < range.col + range.colCount)
                                    {
                                        var newRightRange = new Sheets.Range(-1, -1, -1, -1);
                                        newRightRange.row = Math_max(srcRow, range.row);
                                        newRightRange.col = srcColumn + moveColumnCount;
                                        newRightRange.rowCount = Math_min(srcRow + moveRowCount, range.row + range.rowCount) - newRightRange.row;
                                        newRightRange.colCount = range.col + range.colCount - (srcColumn + moveColumnCount);
                                        newRanges.push(newRightRange)
                                    }
                                    if (srcRow + moveRowCount < range.row + range.rowCount)
                                    {
                                        var newBottomRange = new Sheets.Range(-1, -1, -1, -1);
                                        newBottomRange.row = srcRow + moveRowCount;
                                        newBottomRange.col = range.col;
                                        newBottomRange.rowCount = range.row + range.rowCount - (srcRow + moveRowCount);
                                        newBottomRange.colCount = range.colCount;
                                        newRanges.push(newBottomRange)
                                    }
                                }
                                for (var delIndex = 0; delIndex < dealedRanges.length; delIndex++)
                                {
                                    Sheets.ArrayHelper.remove(rule.ranges, dealedRanges[delIndex])
                                }
                                rule.ranges = rule.ranges.concat(newRanges)
                            }
                        }
                    }
                    conditionalFormats._resetCache()
                };
                staticMembers.moveComment = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = moveRowCount;
                    var columnCount = moveColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var destComments = [];
                    for (var r = 0; r < rowCount; r++)
                    {
                        for (var c = 0; c < columnCount; c++)
                        {
                            var comment = src.getComment(fromRow + r, fromColumn + c);
                            if (comment)
                            {
                                var clonedComment = comment.clone();
                                clonedComment._sheet = dest;
                                clonedComment._rowIndex = toRow + r;
                                clonedComment._colIndex = toColumn + c;
                                destComments.push(clonedComment);
                                src.setComment(fromRow + r, fromColumn + c, keyword_null)
                            }
                        }
                    }
                    for (var i = 0, length = destComments.length; i < length; i++)
                    {
                        var comment = destComments[i];
                        dest.setComment(comment._rowIndex, comment._colIndex, comment)
                    }
                };
                staticMembers.moveSparkline = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = moveRowCount;
                    var columnCount = moveColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var crossSheet = !(src === dest && src._name === dest._name);
                    var sparkline;
                    if (crossSheet)
                    {
                        sparkline = dest._sparklineGroupManager;
                        if (sparkline)
                        {
                            sparkline._exMove(src, fromRow, fromColumn, toRow, toColumn, rowCount, columnCount)
                        }
                    }
                    else
                    {
                        sparkline = src._sparklineGroupManager;
                        if (sparkline)
                        {
                            sparkline._move(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount)
                        }
                    }
                };
                staticMembers.moveColumnRangeGroup = function(src, srcColumn, dest, destColumn, moveColumnCount)
                {
                    var fromColumn = srcColumn;
                    var toColumn = destColumn;
                    var columnCount = moveColumnCount;
                    if (fromColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var crossSheet = !(src === dest && src._name === dest._name);
                    if (crossSheet)
                    {
                        if (src.colRangeGroup && dest.colRangeGroup)
                        {
                            staticMembers.crossSheetCopyRangeGroup(src.colRangeGroup, fromColumn, dest.colRangeGroup, toColumn, columnCount);
                            Sheets.ArrayHelper.clear(src.colRangeGroup.items, fromColumn, columnCount)
                        }
                    }
                    else
                    {
                        var columnGroup = src.colRangeGroup;
                        if (columnGroup)
                        {
                            columnGroup._move(fromColumn, toColumn, columnCount)
                        }
                    }
                };
                staticMembers.moveRowRangeGroup = function(src, srcRow, dest, destRow, moveRowCount)
                {
                    var fromRow = srcRow;
                    var toRow = destRow;
                    var rowCount = moveRowCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    var crossSheet = !(src === dest && src._name === dest._name);
                    if (crossSheet)
                    {
                        if (src.rowRangeGroup && dest.rowRangeGroup)
                        {
                            staticMembers.crossSheetCopyRangeGroup(src.rowRangeGroup, fromRow, dest.rowRangeGroup, toRow, rowCount);
                            Sheets.ArrayHelper.clear(src.rowRangeGroup.items, fromRow, rowCount)
                        }
                    }
                    else
                    {
                        var rowGroup = src.rowRangeGroup;
                        if (rowGroup)
                        {
                            rowGroup._move(fromRow, toRow, rowCount)
                        }
                    }
                };
                staticMembers.moveSpan = function(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount)
                {
                    var fromRow = srcRow;
                    var fromColumn = srcColumn;
                    var toRow = destRow;
                    var toColumn = destColumn;
                    var rowCount = moveRowCount;
                    var columnCount = moveColumnCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (fromColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var crossSheet = !(src === dest && src._name === dest._name);
                    if (srcRow < 0)
                    {
                        if (crossSheet)
                        {
                            staticMembers.crossSheetCopySpans(src._getSpanModel(1), -1, fromColumn, dest._getSpanModel(1), -1, toColumn, -1, columnCount);
                            if (src._getSpanModel(1))
                            {
                                src._getSpanModel(1).clear(-1, fromColumn, -1, columnCount)
                            }
                        }
                        else
                        {
                            var csm = src._getSpanModel(1);
                            if (csm)
                            {
                                csm.move(-1, fromColumn, -1, toColumn, -1, columnCount)
                            }
                        }
                    }
                    if (srcColumn < 0)
                    {
                        if (crossSheet)
                        {
                            staticMembers.crossSheetCopySpans(src._getSpanModel(2), fromRow, -1, dest._getSpanModel(2), toRow, -1, rowCount, -1);
                            if (src._getSpanModel(2))
                            {
                                src._getSpanModel(2).clear(fromRow, -1, rowCount, -1)
                            }
                        }
                        else
                        {
                            var rsm = src._getSpanModel(2);
                            if (rsm)
                            {
                                rsm.move(fromRow, -1, toRow, -1, rowCount, -1)
                            }
                        }
                    }
                    if (crossSheet)
                    {
                        staticMembers.crossSheetCopySpans(src._getSpanModel(), fromRow, fromColumn, dest._getSpanModel(), toRow, toColumn, rowCount, columnCount);
                        if (src._getSpanModel())
                        {
                            src._getSpanModel().clear(fromRow, fromColumn, rowCount, columnCount)
                        }
                    }
                    else
                    {
                        var sm = src._getSpanModel();
                        if (sm)
                        {
                            sm.move(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount)
                        }
                    }
                };
                staticMembers.moveColumnAxis = function(src, srcColumn, dest, destColumn, moveColumnCount, option)
                {
                    var fromColumn = srcColumn;
                    var toColumn = destColumn;
                    var columnCount = moveColumnCount;
                    if (srcColumn < 0)
                    {
                        fromColumn = 0;
                        columnCount = Math_min(src.getColumnCount(), dest.getColumnCount())
                    }
                    if (destColumn < 0)
                    {
                        toColumn = 0
                    }
                    var colHeader = 1;
                    for (var c = 0; c < columnCount; c++)
                    {
                        var width = src._getActualColumnWidth(c + fromColumn);
                        if (width !== keyword_undefined && width !== keyword_null)
                        {
                            src.setColumnWidth(c + fromColumn, src.defaults.colWidth);
                            dest.setColumnWidth(c + toColumn, width)
                        }
                        var visible = src.getColumnVisible(c + fromColumn);
                        if (visible !== keyword_undefined && visible !== keyword_null)
                        {
                            src.setColumnVisible(c + fromColumn, true);
                            dest.setColumnVisible(c + toColumn, visible)
                        }
                        if ((option & 64) > 0)
                        {
                            var style = src.getActualStyle(-1, c + fromColumn);
                            if (!style)
                            {
                                dest.setStyle(-1, c + toColumn, keyword_null)
                            }
                            else
                            {
                                dest.setStyle(-1, c + toColumn, style.clone());
                                src.setStyle(-1, c + fromColumn, keyword_null)
                            }
                            style = src.getActualStyle(-1, c + fromColumn, colHeader);
                            if (!style)
                            {
                                dest.setStyle(-1, c + toColumn, keyword_null, colHeader)
                            }
                            else
                            {
                                dest.setStyle(-1, c + toColumn, style.clone(), colHeader);
                                src.setStyle(-1, c + fromColumn, keyword_null, colHeader)
                            }
                        }
                    }
                    var colHeaderRowCount = Math_min(src.getRowCount(colHeader), dest.getRowCount(colHeader));
                    for (var r = 0; r < colHeaderRowCount; r++)
                    {
                        var height = src._getActualRowHeight(r, colHeader);
                        if (height !== keyword_undefined && height !== keyword_null)
                        {
                            src.setRowHeight(r, src.defaults.colHeaderRowHeight, colHeader);
                            dest.setRowHeight(r, height, colHeader)
                        }
                    }
                };
                staticMembers.moveRowAxis = function(src, srcRow, dest, destRow, moveRowCount, option)
                {
                    var fromRow = srcRow;
                    var toRow = destRow;
                    var rowCount = moveRowCount;
                    if (srcRow < 0)
                    {
                        fromRow = 0;
                        rowCount = Math_min(src.getRowCount(), dest.getRowCount())
                    }
                    if (destRow < 0)
                    {
                        toRow = 0
                    }
                    var rowHeader = 2;
                    for (var r = 0; r < rowCount; r++)
                    {
                        var height = src._getActualRowHeight(r + fromRow);
                        if (height !== keyword_undefined && height !== keyword_null)
                        {
                            src.setRowHeight(r + fromRow, src.defaults.rowHeight);
                            dest.setRowHeight(r + toRow, height)
                        }
                        var visible = src.getRowVisible(r + fromRow);
                        if (visible !== keyword_undefined && visible !== keyword_null)
                        {
                            src.setRowVisible(r + fromRow, true);
                            dest.setRowVisible(r + toRow, visible)
                        }
                        if ((option & 64) > 0)
                        {
                            var style = src.getActualStyle(r + fromRow, -1);
                            if (!style)
                            {
                                dest.setStyle(r + toRow, -1, keyword_null)
                            }
                            else
                            {
                                dest.setStyle(r + toRow, -1, style.clone());
                                src.setStyle(r + fromRow, -1, keyword_null)
                            }
                            style = src.getActualStyle(r + fromRow, -1, rowHeader);
                            if (!style)
                            {
                                dest.setStyle(r + toRow, -1, keyword_null, rowHeader)
                            }
                            else
                            {
                                dest.setStyle(r + toRow, -1, style.clone(), rowHeader);
                                src.setStyle(r + fromRow, -1, keyword_null, rowHeader)
                            }
                        }
                    }
                    var rowHeaderColCount = Math_min(src.getColumnCount(rowHeader), dest.getColumnCount(rowHeader));
                    for (var c = 0; c < rowHeaderColCount; c++)
                    {
                        var width = src._getActualColumnWidth(c, rowHeader);
                        if (width !== keyword_undefined && width !== keyword_null)
                        {
                            src.setColumnWidth(c, src.defaults.rowHeaderColWidth, rowHeader);
                            dest.setColumnWidth(c, width, rowHeader)
                        }
                    }
                };
                staticMembers.moveSheetInfo = function(src, dest, option)
                {
                    if ((src !== dest) || (src._name !== dest._name))
                    {
                        if ((option & 64) > 0)
                        {
                            var colHeader = 1;
                            var rowHeader = 2;
                            dest.setDefaultStyle(src.getDefaultStyle());
                            dest.setDefaultStyle(src.getDefaultStyle(colHeader), colHeader);
                            dest.setDefaultStyle(src.getDefaultStyle(rowHeader), rowHeader);
                            src.setDefaultStyle(keyword_null);
                            src.setDefaultStyle(keyword_null, colHeader);
                            src.setDefaultStyle(keyword_null, rowHeader)
                        }
                        dest.defaults.colWidth = src.defaults.colWidth;
                        dest.defaults.rowHeight = src.defaults.rowHeight;
                        dest.defaults.rowHeaderColWidth = src.defaults.rowHeaderColWidth;
                        src.defaults.colWidth = 62;
                        src.defaults.rowHeight = 20;
                        src.defaults.rowHeaderColWidth = 40
                    }
                };
                staticMembers.moveBindingPath = function(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount)
                {
                    return staticMembers._copyMoveBindingPath(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, true)
                };
                staticMembers.setRangeText = function(sheet, row, column, data, rowDelimiter, columnDelimiter, cellDelimiter, flags)
                {
                    if (!sheet)
                    {
                        throw new Error(Sheets.SR.Exp_SheetIsNull);
                    }
                    if (row < -1 || row >= sheet.getRowCount())
                    {
                        raiseInvalidRangeException("row", row, "-1", sheet.getRowCount() - 1)
                    }
                    if (column < -1 || column >= sheet.getColumnCount())
                    {
                        raiseInvalidRangeException("column", column, "-1", sheet.getColumnCount() - 1)
                    }
                    if (data === keyword_undefined || data === keyword_null || data === "")
                    {
                        return
                    }
                    if (row === -1)
                    {
                        row = 0
                    }
                    if (column === -1)
                    {
                        column = 0
                    }
                    var sheetData = staticMembers.parseText(data, rowDelimiter, columnDelimiter, cellDelimiter);
                    if (sheetData && sheetData.length > 0)
                    {
                        staticMembers.setSheetData(sheet, row, column, sheetData, flags)
                    }
                };
                staticMembers.getRangeText = function(sheet, row, rowCount, column, columnCount, rowDelimiter, columnDelimiter, cellDelimiter, forceCellDelimiter, flags)
                {
                    if (!sheet)
                    {
                        throw new Error(Sheets.SR.Exp_SheetIsNull);
                    }
                    if (row < -1 || row >= sheet.getRowCount())
                    {
                        raiseInvalidRangeException("row", row, "-1", sheet.getRowCount() - 1)
                    }
                    if (rowCount < -1 || row + rowCount > sheet.getRowCount())
                    {
                        raiseInvalidRangeException("rowCount", row, "-1", sheet.getRowCount() - row)
                    }
                    if (column < -1 || column >= sheet.getColumnCount())
                    {
                        raiseInvalidRangeException("column", column, "-1", sheet.getColumnCount() - 1)
                    }
                    if (columnCount < -1 || column + columnCount > sheet.getColumnCount())
                    {
                        raiseInvalidRangeException("columnCount", column, "-1", sheet.getColumnCount() - column)
                    }
                    var endRow = -1;
                    var endColumn = -1;
                    if (row === -1 && column === -1 && rowCount === -1 && columnCount === -1)
                    {
                        row = 0;
                        column = 0;
                        endRow = sheet.getRowCount() - 1;
                        endColumn = sheet.getColumnCount() - 1
                    }
                    else
                    {
                        if (row === -1)
                        {
                            row = 0
                        }
                        if (column === -1)
                        {
                            column = 0
                        }
                        if (rowCount === -1)
                        {
                            rowCount = sheet.getRowCount() - row
                        }
                        if (columnCount === -1)
                        {
                            columnCount = sheet.getColumnCount() - column
                        }
                        endRow = row + rowCount - 1;
                        endColumn = column + columnCount - 1
                    }
                    if (rowDelimiter === keyword_undefined || rowDelimiter === keyword_null || rowDelimiter === "")
                    {
                        rowDelimiter = "\r\n"
                    }
                    if (columnDelimiter === keyword_undefined || columnDelimiter === keyword_null || columnDelimiter === "")
                    {
                        columnDelimiter = "\t"
                    }
                    if (cellDelimiter === keyword_undefined || cellDelimiter === keyword_null || cellDelimiter === "")
                    {
                        cellDelimiter = "\""
                    }
                    var sbr = "";
                    for (var r = row; r <= endRow; r++)
                    {
                        var newLine = true;
                        for (var c = column; c <= endColumn; c++)
                        {
                            if (!newLine)
                            {
                                sbr += columnDelimiter
                            }
                            newLine = false;
                            var cellStr = "";
                            var cellData = sheet.getText(r, c);
                            if (cellData !== keyword_undefined && cellData !== keyword_null)
                            {
                                cellStr = cellData;
                                cellStr = cellStr.replace(new RegExp(cellDelimiter, "g"), cellDelimiter + cellDelimiter)
                            }
                            if (forceCellDelimiter || cellStr.indexOf(cellDelimiter) !== -1 || cellStr.indexOf(columnDelimiter) !== -1 || cellStr.indexOf(rowDelimiter) !== -1 || cellStr.indexOf("\n") !== -1)
                            {
                                sbr += cellDelimiter + cellStr + cellDelimiter
                            }
                            else
                            {
                                sbr += cellStr
                            }
                        }
                        sbr += rowDelimiter
                    }
                    return sbr.toString()
                };
                staticMembers.parseText = function(data, rowDelimiter, columnDelimiter, cellDelimiter)
                {
                    if (data === keyword_undefined || data === keyword_null || data === "")
                    {
                        return keyword_null
                    }
                    if (rowDelimiter === keyword_undefined || rowDelimiter === keyword_null || rowDelimiter === "")
                    {
                        rowDelimiter = "\r\n"
                    }
                    if (columnDelimiter === keyword_undefined || columnDelimiter === keyword_null || columnDelimiter === "")
                    {
                        columnDelimiter = "\t"
                    }
                    if (cellDelimiter === keyword_undefined || cellDelimiter === keyword_null || cellDelimiter === "")
                    {
                        cellDelimiter = "\""
                    }
                    if (!Sheets.StringHelper.EndsWith(data, rowDelimiter))
                    {
                        data += rowDelimiter
                    }
                    var sheetData = [],
                        rowData = [];
                    var sbr = "";
                    var inCell = false;
                    var dl = cellDelimiter.length;
                    var rdl = rowDelimiter.length;
                    var cdl = columnDelimiter.length;
                    for (var index = 0; index < data.length; index++)
                    {
                        sbr += data[index];
                        if (sbr.length >= dl && cellDelimiter === sbr.substr(sbr.length - dl, dl))
                        {
                            if (inCell && data.length >= index + 1 + dl && cellDelimiter === data.substr(index + 1, dl))
                            {
                                index += dl
                            }
                            else
                            {
                                if (!inCell)
                                {
                                    var temp = sbr;
                                    if (temp.indexOf(cellDelimiter) === 0)
                                    {
                                        sbr = sbr.substr(0, sbr.length - dl);
                                        inCell = true
                                    }
                                }
                                else
                                {
                                    sbr = sbr.substr(0, sbr.length - dl);
                                    inCell = false
                                }
                            }
                        }
                        else if (!inCell && sbr.length >= cdl && columnDelimiter === sbr.substr(sbr.length - cdl, cdl))
                        {
                            sbr = sbr.substr(0, sbr.length - cdl);
                            rowData.push(sbr.toString());
                            sbr = ""
                        }
                        else if (!inCell && sbr.length >= rdl && rowDelimiter === sbr.substr(sbr.length - rdl, rdl))
                        {
                            sbr = sbr.substr(0, sbr.length - rdl);
                            rowData.push(sbr.toString());
                            sheetData.push(rowData);
                            rowData = [];
                            sbr = ""
                        }
                        else if (inCell)
                        {
                            if (data.length >= index + 1 + cdl && columnDelimiter === data.substr(index + 1, cdl) && columnDelimiter != ',')
                            {
                                index += dl
                            }
                        }
                    }
                    if (inCell)
                    {
                        if (rowData.length > 0)
                        {
                            for (var i = 0; i < sheetData.length; i++)
                            {
                                if (sheetData[i] === rowData)
                                {
                                    break
                                }
                            }
                            if (i >= sheetData.length)
                            {
                                sheetData.push(rowData)
                            }
                        }
                        var inCellStr = sbr.toString();
                        if (inCellStr)
                        {
                            inCellStr = inCellStr.replace(new RegExp(columnDelimiter, "g"), "");
                            if (Sheets.StringHelper.EndsWith(inCellStr, rowDelimiter))
                            {
                                inCellStr = inCellStr.substr(0, inCellStr.length - rdl)
                            }
                            if (sheetData.length == 0)
                            {
                                sheetData.push([inCellStr])
                            }
                        }
                    }
                    if (sheetData.length == 0 && data)
                    {
                        var text = data;
                        if (Sheets.StringHelper.EndsWith(data, rowDelimiter))
                        {
                            text = text.substr(0, text.length - rdl)
                        }
                        sheetData.push([text])
                    }
                    return sheetData
                };
                staticMembers.setSheetData = function(sheet, rowIndex, columnIndex, data, flags)
                {
                    var dataRowCount = data.length;
                    var dataColumnCount = staticMembers.getMaxLength(data);
                    if (dataRowCount === 0 || dataColumnCount === 0)
                    {
                        return
                    }
                    var opt = new ImportExportOptions(flags);
                    opt.fixOptions(sheet);
                    var rowHeaderColumnCount = opt.rowHeader ? sheet.getColumnCount(2) : 0;
                    var columnHeaderRowCount = opt.columnHeader ? sheet.getRowCount(1) : 0;
                    var columnFooterRowCount = 0;
                    dataColumnCount -= rowHeaderColumnCount;
                    if (dataColumnCount <= 0)
                    {
                        dataColumnCount = 0
                    }
                    dataRowCount -= columnHeaderRowCount;
                    if (dataRowCount <= 0)
                    {
                        columnFooterRowCount = 0
                    }
                    dataRowCount -= columnFooterRowCount;
                    if (dataRowCount <= 0)
                    {
                        dataRowCount = 0
                    }
                    if (opt.expandRows && rowIndex + dataRowCount > sheet.getRowCount())
                    {
                        sheet.setRowCount(rowIndex + dataRowCount)
                    }
                    if (opt.expandColumns && columnIndex + dataColumnCount > sheet.getColumnCount())
                    {
                        sheet.setColumnCount(columnIndex + dataColumnCount)
                    }
                    for (var r = 0, sheetRowIndex = 0; r < data.length; r++, sheetRowIndex++)
                    {
                        var rowData = data[r];
                        if (rowData.length <= 0)
                        {
                            continue
                        }
                        if (columnHeaderRowCount > 0 && r < columnHeaderRowCount)
                        {
                            staticMembers.setRowData(sheet, rowData, sheetRowIndex, columnIndex, dataColumnCount, 1, opt)
                        }
                        else if (dataRowCount > 0 && sheetRowIndex < sheet.getRowCount())
                        {
                            if (r === columnHeaderRowCount)
                            {
                                sheetRowIndex = rowIndex
                            }
                            staticMembers.setRowData(sheet, rowData, sheetRowIndex, 0, rowHeaderColumnCount, 2, opt);
                            rowData.splice(0, rowHeaderColumnCount);
                            staticMembers.setRowData(sheet, rowData, sheetRowIndex, columnIndex, dataColumnCount, 3, opt)
                        }
                    }
                };
                staticMembers.setRowData = function(sheet, rowData, sheetRowIndex, columnIndex, columnCount, area, opt)
                {
                    for (var c = 0, sheetColumnIndex = columnIndex; c < rowData.length; c++, sheetColumnIndex++)
                    {
                        if (columnCount > 0 && sheetColumnIndex < sheet.getColumnCount(area))
                        {
                            staticMembers.setCellData(sheet, area, sheetRowIndex, sheetColumnIndex, rowData[c], opt)
                        }
                    }
                };
                staticMembers.setCellData = function(sheet, area, rowIndex, columnIndex, value, opt)
                {
                    var setvalue = value;
                    var autodisplayformatter = keyword_null;
                    if (opt.unFormatted === false && Sheets.features.formatter)
                    {
                        var outPara = {value: value};
                        autodisplayformatter = (new Sheets.GeneralFormatter).GetPreferredDisplayFormatter(value, outPara);
                        setvalue = outPara.value
                    }
                    if (setvalue === keyword_undefined || setvalue === keyword_null)
                    {
                        sheet.setValue(rowIndex, columnIndex, setvalue, area)
                    }
                    else
                    {
                        if (value !== "")
                        {
                            if (opt.formula && value[0] === "=")
                            {
                                try
                                {
                                    sheet.setFormula(rowIndex, columnIndex, value.substr(1))
                                }
                                catch(ex)
                                {
                                    sheet.setText(rowIndex, columnIndex, value, area)
                                }
                            }
                            else
                            {
                                var style = sheet.getActualStyle(rowIndex, columnIndex, area);
                                if (style)
                                {
                                    if (opt.unFormatted === false && Sheets.features.formatter)
                                    {
                                        if (!style.formatter)
                                        {
                                            var autoFormatter = new Sheets.AutoFormatter(autodisplayformatter);
                                            sheet.getCell(rowIndex, columnIndex, area)._setStyleProperty("_autoFormatter", autoFormatter)
                                        }
                                        else
                                        {
                                            if (style.formatter.toString() === "@")
                                            {
                                                setvalue = value.toString()
                                            }
                                        }
                                    }
                                    else
                                    {
                                        if (style.formatter)
                                        {
                                            sheet.getCell(rowIndex, columnIndex, area).formatter(keyword_null)
                                        }
                                    }
                                }
                                sheet.setValue(rowIndex, columnIndex, setvalue, area)
                            }
                        }
                        else
                        {
                            sheet.setValue(rowIndex, columnIndex, keyword_null, area)
                        }
                    }
                };
                staticMembers.getMaxLength = function(data)
                {
                    if (data === keyword_undefined || data === keyword_null)
                    {
                        return 0
                    }
                    var len = 0;
                    for (var i = 0; i < data.length; i++)
                    {
                        var list = data[i];
                        len = Math_max(list.length, len)
                    }
                    return len
                };
                staticMembers.parseCsv = function(text, rowDelimiter, columnDelimiter, cellDelimiter)
                {
                    var ret = keyword_null;
                    var parsedText = staticMembers.parseText(text, rowDelimiter, columnDelimiter, cellDelimiter);
                    if (parsedText)
                    {
                        var rowCount = parsedText.length;
                        var columnCount = staticMembers.getMaxLength(parsedText);
                        var textArray = [];
                        for (var r = 0; r < rowCount; r++)
                        {
                            textArray[r] = [];
                            for (var c = 0; c < columnCount; c++)
                            {
                                if (c < parsedText[r].length)
                                {
                                    textArray[r][c] = parsedText[r][c]
                                }
                                else
                                {
                                    textArray[r][c] = keyword_null
                                }
                            }
                        }
                        ret = textArray
                    }
                    return ret
                };
                staticMembers.tryConvertDateToOADate = function(value)
                {
                    if (typeof(value) !== const_undefined && value !== keyword_null && value.constructor === Date)
                    {
                        value = "/OADate(" + new Sheets._DateTimeHelper(value).toOADate() + ")/"
                    }
                    return value
                };
                staticMembers.tryConvertOADateToDate = function(t)
                {
                    if (typeof(t) === const_string && t.charAt(0) === '/')
                    {
                        var x;
                        if (_jsonOADateRegExp.test(t))
                        {
                            x = t.match(_jsonOADateRegExp);
                            t = Sheets._DateTimeHelper.fromOADate(parseFloat(x[1]))
                        }
                        else if (_jsonDateRegExp.test(t))
                        {
                            x = t.match(_jsonDateRegExp);
                            t = new Date(parseFloat(x[1]))
                        }
                    }
                    return t
                };
                staticMembers.adjustModelFormulasAfterSetSheetName = function(sheet)
                {
                    if (!Sheets.util.hasCalc())
                    {
                        return
                    }
                    var service = sheet.getCalcService(),
                        sourceModel = service.getSourceModel(sheet._getSheetSource()),
                        dataModel;
                    if (!sourceModel)
                    {
                        return
                    }
                    var adjustOneFormula = function(calcInfo)
                        {
                            var source = calcInfo.sourceModel.source;
                            dataModel = source.getSheet()._getModel();
                            var row = calcInfo.row;
                            var col = calcInfo.column;
                            row = row === undefined ? -1 : row;
                            col = col === undefined ? -1 : col;
                            var depNode = calcInfo.sourceModel.getNode(row, col);
                            var expr = depNode.expr;
                            var arrayInfo = depNode.arrayInfo;
                            var formula = service.unparseWithoutCulture(source, expr, row < 0 ? 0 : row, col < 0 ? 0 : col);
                            dataModel.setFormula(row, col, formula, arrayInfo)
                        };
                    var nodes = sourceModel.getAllNodes();
                    for (var i = 0; i < nodes.length; i++)
                    {
                        var node = nodes[i];
                        var calc = node.calc;
                        if (calc)
                        {
                            if (node.expr)
                            {
                                adjustOneFormula(calc)
                            }
                            var listeners = calc._listeners,
                                dep;
                            for (var lIndex = 0; lIndex < listeners.length; lIndex++)
                            {
                                var cls = calc[listeners[lIndex]];
                                if (cls)
                                {
                                    var cLength = cls.length;
                                    for (var j = 0; j < cLength; j++)
                                    {
                                        dep = cls[j];
                                        if (dep.sourceModel !== sourceModel)
                                        {
                                            adjustOneFormula(dep)
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                staticMembers.getDataValidatorsBeforeSetSheetName = function(currentSheet)
                {
                    if (!Sheets.util.hasCalc())
                    {
                        return
                    }
                    var service = currentSheet.getCalcService(),
                        model = currentSheet._getSheetSource(),
                        baseRow = 0,
                        baseCol = 0;
                    var conditions = [[], []];
                    if (Sheets.features.dataValidator)
                    {
                        var validators = Sheets._DataValidatorCache.getAllValidators();
                        var dataValidator,
                            condition,
                            formulas,
                            formula,
                            sheet,
                            exprs;
                        for (var i = 0; i < validators.length; i++)
                        {
                            dataValidator = validators[i].validator;
                            sheet = validators[i].sheet;
                            var sheetSource = sheet._getSheetSource();
                            condition = dataValidator.condition;
                            formulas = condition.getFormulas();
                            exprs = [];
                            if (formulas && formulas.length > 0)
                            {
                                for (var j = 0; j < formulas.length; j++)
                                {
                                    formula = formulas[j];
                                    var expr = service.parse(model, formula, baseRow, baseCol);
                                    exprs.push(expr);
                                    var newFormula;
                                    newFormula = model.service.unparse(model, expr, baseRow, baseCol)
                                }
                                conditions[0].push(condition);
                                conditions[1].push(exprs)
                            }
                        }
                    }
                    return conditions
                };
                staticMembers.adjustValidatorsAfterSetSheetName = function(sheet, conditions)
                {
                    if (!Sheets.util.hasCalc())
                    {
                        return
                    }
                    var length = conditions[0].length;
                    var service = sheet.getCalcService(),
                        model = sheet._getSheetSource(),
                        baseRow = 0,
                        baseCol = 0;
                    for (var i = 0; i < length; i++)
                    {
                        var condition = conditions[0][i],
                            exprs = conditions[1][i],
                            formulas = [];
                        for (var k = 0; k < exprs.length; k++)
                        {
                            var newFormula = service.unparse(model, exprs[k], baseRow, baseCol);
                            formulas.push(newFormula)
                        }
                        condition.setFormulas(formulas)
                    }
                };
                return staticMembers
            })();
        var regExpKeyPattern = [/\\/g, /\(/g, /\[/g, /\{/g, /\^/g, /\$/g, /\|/g, /\)/g, /\+/g, /\./g];
        var questionMarkHolder = new RegExp("{113E2532-EAF5-444c-A5CB-3D7446971C4D}", "g"),
            asteriskHolder = new RegExp("{E21523B3-0F1F-458f-B547-23D25713D0EC}", "g");
        function fixFormulaKeyword(searchString, useWildCards, exactMatch)
        {
            for (var i in regExpKeyPattern)
            {
                if (regExpKeyPattern[i])
                {
                    searchString = searchString.replace(regExpKeyPattern[i], regExpKeyPattern[i].source)
                }
            }
            if (useWildCards === true)
            {
                searchString = searchString.replace(/~\?/g, questionMarkHolder.source);
                searchString = searchString.replace(/~\*/g, asteriskHolder.source);
                searchString = searchString.replace(/\?/g, ".");
                if (exactMatch)
                {
                    searchString = searchString.replace(/\*/g, "((.|\\n)+)")
                }
                else
                {
                    searchString = searchString.replace(/\*/g, "((.|\\n)*)")
                }
                searchString = searchString.replace(questionMarkHolder, "\\?");
                searchString = searchString.replace(asteriskHolder, "\\*")
            }
            else
            {
                searchString = searchString.replace(/\?/g, "\\?");
                searchString = searchString.replace(/\*/g, "\\*")
            }
            return searchString
        }
        var DataContext = (function()
            {
                function DataContext(read, create, update, remove)
                {
                    var self = this;
                    self.read = read;
                    self.create = create;
                    self.update = update;
                    self.remove = remove
                }
                return DataContext
            })();
        Sheets.DataContext = DataContext;
        var _gcSheet = ".gcSheet";
        var _gcSheetInternal = ".gcSheetInternal";
        var _mouseDown_gcSheet = "mousedown" + _gcSheet;
        var _mouseMove_gcSheet = "mousemove" + _gcSheet;
        var _mouseUp_gcSheet = "mouseup" + _gcSheet;
        var _mouseOut_gcSheet = "mouseout" + _gcSheet;
        var _dblclick_gcSheet = "dblclick" + _gcSheet;
        var _mouseWheel_gcSheet = "gcmousewheel" + _gcSheet;
        var _resize_gcSheet = "resize" + _gcSheet;
        var _value = "value";
        var _tag = "tag";
        var _cssLeft = "left",
            _cssTop = "top",
            _cssWidth = "width",
            _cssHeight = "height",
            _cssHidden = "hidden",
            cssVisibility = "visibility";
        var ajax_Type = "POST",
            ajax_DataType = "json",
            ajax_MIME = "application/json;charset=UTF-8";
        var _jsonDateRegExp = new RegExp("^/Date\\((-?\\d+)([-+]{1}\\d+)?\\)/\\s*$");
        var _jsonOADateRegExp = new RegExp("^/OADate\\(([-+]?(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)\\)/\\s*$")
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.spread", ["core.common", "core.theme", "core.sheet_event", "core.sheet_action", "core.sheet", "core.spreadpanelex", "core.stringResource", "core.imageLoader"]);
        var keyword_null = null,
            keyword_undefined = undefined,
            Math_round = Math.round,
            Math_max = Math.max,
            Math_min = Math.min,
            Math_pow = Math.pow,
            Math_sqrt = Math.sqrt,
            const_string = "string",
            const_boolean = "boolean",
            const_number = "number",
            const_undefined = "undefined";
        var document = window.document;
        var cmd_refresh = "refresh",
            cmd_scroll = "scroll",
            cmd_resize = "resize",
            dir_horizontal = "horizontal",
            dir_vertical = "vertical",
            tag_input = "input",
            tag_div = "div",
            pixel = "px",
            zero = "0",
            thousands = "3000",
            cssHidden = "hidden",
            cssVisible = "visible",
            cssTop = "top",
            cssNone = "none",
            ns_spread = ".gcSpread",
            ns_spreadInternal = ".gcSpreadInternal",
            data_postfix = "_data",
            ns_scrollbar = '.gcScrollbar',
            cssScrollerHandle = "scroll-handle",
            cssScrollbar = "scroll-bar",
            e_mousedown = "mousedown",
            e_mouseup = "mouseup";
        var Spread = (function()
            {
                function Spread(host, options)
                {
                    this._isResizing = false;
                    var self = this;
                    self._host = keyword_null;
                    self._allowUndo = true;
                    self._paintSuspended = false;
                    self._availableSheetIndex = -1;
                    self._useTouchLayout = false;
                    self.touchScrollOnRails(true);
                    self.sheets = keyword_null;
                    self.name = keyword_null;
                    self._tabStripRatio = 0.5;
                    self._tabStripRatioUserSet = 0.5;
                    self._activeSheetIndex = 0;
                    self._allowUserZoom = true;
                    self._allowUserResize = true;
                    self._allowSheetReorder = true;
                    self._tabStripVisible = true;
                    self._tabEditable = true;
                    self._newTabVisible = true;
                    self._firstTabUserSet = 0;
                    self._canUserEditFormula = true;
                    self._enableFormulaTextbox = true;
                    self._highlightInvalidData = false;
                    self._autoFitType = 0;
                    self._allowDragDrop = true;
                    self._allowDragFill = true;
                    self._showDragFillSmartTag = true;
                    self._defaultDragFillType = 5;
                    self._showScrollTip = 0;
                    self._showResizeTip = 0;
                    self._showDragDropTip = true;
                    self._showDragFillTip = true;
                    self._tooltip = keyword_null;
                    self._showVerticalScrollbar = true;
                    self._showHorizontalScrollbar = true;
                    self._backColor = "white";
                    self._backgroundImage = keyword_null;
                    self._backgroundImageLayout = 0;
                    self._grayAreaBackColor = "gray";
                    self._imageLoader = keyword_null;
                    self._suspendSetFocus = false;
                    self._cutCopyIndicatorVisible = true;
                    self._cutCopyIndicatorBorderColor = "#217346";
                    self._defaultSheetCount = 1;
                    self._defaultActiveSheetIndex = 0;
                    self._windowResizeTimer = keyword_null;
                    self._scrollbarMaxAlign = false;
                    self._scrollbarShowMax = true;
                    self._hideSelection = false;
                    if (typeof options === const_number || options === keyword_null || options === keyword_undefined)
                    {
                        var tempOption = {};
                        if (typeof arguments[0] === const_string)
                        {
                            tempOption.name = arguments[0]
                        }
                        if (typeof arguments[1] === const_number)
                        {
                            tempOption.sheetCount = arguments[1]
                        }
                        options = tempOption
                    }
                    if (typeof host === const_string || host === keyword_null || host === keyword_undefined)
                    {
                        host = keyword_null;
                        if (typeof arguments[2] === "object")
                        {
                            host = arguments[2]
                        }
                    }
                    var sheetCount = 1,
                        sheetsSettings = [];
                    if (options)
                    {
                        if (typeof(options.sheetCount) === const_number)
                        {
                            sheetCount = options.sheetCount
                        }
                        if (typeof(options.name) === const_string && options.name.length > 0)
                        {
                            self.name = options.name
                        }
                        if (typeof(options.font) === const_string && options.font.length > 0)
                        {
                            self._font = options.font
                        }
                        if (typeof(options.allowUserZoom) === const_boolean)
                        {
                            self._allowUserZoom = options.allowUserZoom
                        }
                        if (typeof(options.allowUserResize) === const_boolean)
                        {
                            self._allowUserResize = options.allowUserResize
                        }
                        if (typeof(options.tabStripVisible) === const_boolean)
                        {
                            self._tabStripVisible = options.tabStripVisible
                        }
                        if (typeof(options.tabEditable) === const_boolean)
                        {
                            self._tabEditable = options.tabEditable
                        }
                        if (typeof(options.newTabVisible) === const_boolean)
                        {
                            self._newTabVisible = options.newTabVisible
                        }
                        if (typeof(options.tabStripRatio) === const_number)
                        {
                            self._tabStripRatio = options.tabStripRatio
                        }
                        if (typeof(options.activeSheetIndex) === const_number)
                        {
                            self._activeSheetIndex = options.activeSheetIndex
                        }
                        if (options.sheets && options.sheets.length > 0)
                        {
                            sheetsSettings = options.sheets
                        }
                    }
                    self._init(sheetCount, sheetsSettings, host)
                }
                Spread.prototype._init = function(count, sheetsSetting, host)
                {
                    var self = this;
                    if (Sheets.util.hasCalc())
                    {
                        this.calcService = this._createCalcService()
                    }
                    self._userEvents = [];
                    self._userEventsElem = document.createElement(tag_input);
                    self._eventSuspended = 0;
                    self._undoManager = new Sheets._UndoManager(self, -1, self.allowUndo());
                    self._clipboardHelper = {
                        fromSheet: keyword_null, range: keyword_null, isCutting: false
                    };
                    self._floatingObjectClipboardHelper = {
                        fromSheet: keyword_null, isCutting: false
                    };
                    self._containerDiv = keyword_null;
                    if (Sheets.features.touch)
                    {
                        self._touchEventProvider = new Sheets.TouchEventProvider
                    }
                    self.sheets = [];
                    self._namedStyles = {};
                    if (Sheets.features.sparklineEx)
                    {
                        self._sparklineExs = {};
                        self.addSparklineEx(new Sheets.PieSparkline);
                        self.addSparklineEx(new Sheets.AreaSparkline);
                        self.addSparklineEx(new Sheets.ScatterSparkline);
                        self.addSparklineEx(new Sheets.LineSparkline);
                        self.addSparklineEx(new Sheets.ColumnSparkline);
                        self.addSparklineEx(new Sheets.WinlossSparkline);
                        self.addSparklineEx(new Sheets.BulletSparkline);
                        self.addSparklineEx(new Sheets.SpreadSparkline);
                        self.addSparklineEx(new Sheets.StackedSparkline);
                        self.addSparklineEx(new Sheets.HBarSparkline);
                        self.addSparklineEx(new Sheets.VBarSparkline);
                        self.addSparklineEx(new Sheets.BoxPlotSparkline);
                        self.addSparklineEx(new Sheets.VariSparkline);
                        self.addSparklineEx(new Sheets.CascadeSparkline);
                        self.addSparklineEx(new Sheets.ParetoSparkline)
                    }
                    var i;
                    for (i = 0; i < count; i++)
                    {
                        var sheet = self._createSheet(self._getDefaultSheetName(i));
                        self.sheets.push(sheet);
                        sheet.onAttached(self)
                    }
                    var isStandardCanvas = Sheets.util._isStandardCanvas(),
                        isSilverlightCanvas = Sheets.util._isSilverlightCanvas();
                    if (isStandardCanvas)
                    {
                        self._suspendInvalidate()
                    }
                    if (host)
                    {
                        self._setHost(host)
                    }
                    if (sheetsSetting && sheetsSetting.length > 0)
                    {
                        var sheetTemp;
                        if (self.getSheetCount() < sheetsSetting.length)
                        {
                            var n = self.getSheetCount();
                            while (n < sheetsSetting.length)
                            {
                                sheetTemp = self._createSheet(self._getDefaultSheetName(n));
                                self._addSheetImp(n, 0, sheetTemp);
                                n = self.getSheetCount()
                            }
                        }
                        for (i = 0; i < sheetsSetting.length; i++)
                        {
                            sheetTemp = self.getSheet(i);
                            sheetTemp.applyOptions(sheetsSetting[i])
                        }
                    }
                    if (isStandardCanvas)
                    {
                        var repained = self._resumeInvalidate();
                        if (!repained)
                        {
                            self.invalidateLayout();
                            self.repaint()
                        }
                    }
                    else if (isSilverlightCanvas)
                    {
                        if (window.slcanvas && window.slcanvas.autoLoad)
                        {
                            window.slcanvas.autoLoad()
                        }
                    }
                    if (Sheets.features.touch && !self.touchToolStrip)
                    {
                        self.touchToolStrip = new Sheets.TouchToolStrip(self)
                    }
                };
                Spread.prototype._getContainerDiv = function()
                {
                    var self = this;
                    if (!self._containerDiv && self._host)
                    {
                        self._containerDiv = document.createElement("div");
                        $(self._containerDiv).css({
                            position: 'relative', left: 0, top: 0, width: 0, height: 0
                        });
                        $(self._host).prepend(self._containerDiv)
                    }
                    return self._containerDiv
                };
                Spread.prototype._getDefaultSheetName = function(sheetIndex)
                {
                    var self = this;
                    if (self._availableSheetIndex < self.getSheetCount())
                    {
                        self._availableSheetIndex = self.getSheetCount()
                    }
                    else
                    {
                        self._availableSheetIndex++
                    }
                    if (sheetIndex === keyword_undefined || sheetIndex === keyword_null || sheetIndex < self._availableSheetIndex)
                    {
                        sheetIndex = self._availableSheetIndex
                    }
                    var conflict = false,
                        name;
                    do
                    {
                        name = "Sheet" + (sheetIndex + 1);
                        var len = self.sheets.length;
                        if (len > 0)
                        {
                            for (var i = 0; i < len; i++)
                            {
                                if (i in self.sheets)
                                {
                                    var sheet = self.sheets[i];
                                    if (sheet._name === name)
                                    {
                                        sheetIndex++;
                                        conflict = true;
                                        break
                                    }
                                    else if (conflict)
                                    {
                                        conflict = false
                                    }
                                }
                            }
                        }
                    } while (conflict);
                    return name
                };
                Spread.prototype._createCalcService = function()
                {
                    return new Sheets.Calc.CalcService
                };
                Spread.prototype._createSheet = function(sheetName)
                {
                    var sheet = new Sheets.Sheet(sheetName);
                    return sheet
                };
                Spread.prototype._slSetHost = function(host)
                {
                    var self = this;
                    $(host).data("spread", self);
                    var canvas = document.createElement("canvas");
                    canvas.setAttribute("width", "" + host.clientWidth);
                    canvas.setAttribute("height", "" + host.clientHeight);
                    host.appendChild(canvas);
                    self.canvas = canvas;
                    canvas.setAttribute('renderMethod', 'auto');
                    canvas.setAttribute('gcSpreadsheet', 'true');
                    canvas.setAttribute("onload", "GcSpread.Sheets.util.initPaint(\'" + host.id + "\')");
                    this._resizeHandler = Sheets.util.createEventHandler(self, self._doResize);
                    $(window).bind("resize.gcSpread", this._resizeHandler)
                };
                Spread.prototype._setHost = function(host)
                {
                    var self = this;
                    if (host)
                    {
                        var isStandardCanvas = Sheets.util._isStandardCanvas(),
                            isSilverlightCanvas = Sheets.util._isSilverlightCanvas();
                        if (!isStandardCanvas && isSilverlightCanvas)
                        {
                            self._slSetHost(host);
                            return
                        }
                        self._host = host;
                        $(host).data("spread", self);
                        host.setAttribute("gcUIElement", "gcSpread");
                        Sheets.Global.prototype._createDummyObjects();
                        var table = $("<table cellspacing=0 cellpadding=0 border=0>" + "<tr><td></td><td></td></tr>" + "<tr><td></td><td></td></tr></table>")[0];
                        host.appendChild(table);
                        $(host).bind(Sheets.Events.CultureChanged, self, self._onCultureChanged);
                        $(host).addClass("gc-host-none-user-select");
                        self._vp = document.createElement(tag_div);
                        self._vp.id = host.id + "vp";
                        table.rows[0].cells[0].insertBefore(self._vp, keyword_null);
                        var full = "100%";
                        table.style.width = full;
                        table.style.height = full;
                        table.style.border = zero;
                        table.style.margin = zero;
                        var i,
                            j;
                        for (i = 0; i < table.rows.length; i++)
                        {
                            for (j = 0; j < table.rows[i].cells.length; j++)
                            {
                                table.rows[i].cells[j].style.padding = zero;
                                table.rows[i].cells[j].style.border = zero
                            }
                        }
                        self._scrollbarV = new Sheets.Scrollbar(false);
                        var vScrollbar = self._scrollbarV.getScrollbar();
                        table.rows[0].cells[1].insertBefore(vScrollbar, keyword_null);
                        $(vScrollbar).bind(cmd_scroll + ns_scrollbar, function(e, args)
                        {
                            var sheet = self.getActiveSheet(),
                                scrollEventType = args.scrollEventType,
                                scrollOrientation = args.scrollOrientation;
                            e.data = self;
                            if (scrollOrientation === 1)
                            {
                                switch (scrollEventType)
                                {
                                    case 0:
                                    case 1:
                                    case 2:
                                    case 3:
                                    case 5:
                                        self._vscrollDelegate(e, args);
                                        break;
                                    case 4:
                                        self._vScrollStop(e);
                                        break;
                                    default:
                                        break
                                }
                            }
                        });
                        $(vScrollbar).bind(e_mousedown + ns_scrollbar, function(e, args)
                        {
                            e.data = self;
                            self._vScrollMouseDown(e)
                        });
                        $(vScrollbar).bind(e_mouseup + ns_scrollbar, function(e, args)
                        {
                            e.data = self;
                            self._scrollMouseUp(e)
                        });
                        table.rows[1].cells[0].innerHTML = "<table cellspacing=0 cellpadding=0 border=0><tr><td></td><td></td></tr></table>";
                        var t1 = table.rows[1].cells[0].firstChild;
                        t1.style.border = zero;
                        t1.style.margin = zero;
                        $(t1).css("user-select", "none");
                        for (i = 0; i < t1.rows.length; i++)
                        {
                            for (j = 0; j < t1.rows[i].cells.length; j++)
                            {
                                t1.rows[i].cells[j].style.padding = zero;
                                t1.rows[i].cells[j].style.border = zero
                            }
                        }
                        self._tabs = document.createElement(tag_div);
                        self._tabs.style.width = "" + self._getActualTabStripRatio() * $(self._host).width() + pixel;
                        self._tabs.style.height = "" + self._getScrollbarSize() + pixel;
                        self._tabs.style.fontSize = "10pt";
                        self._tabs.style.fontFamily = "Arial";
                        t1.rows[0].cells[0].insertBefore(self._tabs, keyword_null);
                        self._tab = new _GcTab(host.getAttribute("id") + "_tabStrip");
                        self._tab.setOwner(self);
                        self._tab._setHost(self._tabs);
                        self._scrollbarH = new Sheets.Scrollbar(true);
                        var hScrollbar = self._scrollbarH.getScrollbar();
                        t1.rows[0].cells[1].insertBefore(hScrollbar, keyword_null);
                        $(hScrollbar).bind(cmd_scroll + ns_scrollbar, function(e, args)
                        {
                            var sheet = self.getActiveSheet(),
                                scrollEventType = args.scrollEventType,
                                scrollOrientation = args.scrollOrientation;
                            e.data = self;
                            if (scrollOrientation === 0)
                            {
                                switch (scrollEventType)
                                {
                                    case 0:
                                    case 1:
                                    case 2:
                                    case 3:
                                    case 5:
                                        self._hscrollDelegate(e, args);
                                        break;
                                    case 4:
                                        self._hScrollStop(e);
                                        break;
                                    default:
                                        break
                                }
                            }
                        });
                        $(hScrollbar).bind(e_mousedown + ns_scrollbar, function(e, args)
                        {
                            e.data = self;
                            self._hScrollMouseDown(e)
                        });
                        $(hScrollbar).bind(e_mouseup + ns_scrollbar, function(e, args)
                        {
                            e.data = self;
                            self._scrollMouseUp(e)
                        });
                        this._resizeHandler = Sheets.util.createEventHandler(self, self._doWindowResize);
                        $(window).bind(cmd_resize + ns_spread, this._resizeHandler);
                        if (Sheets.features.comment)
                        {
                            self._commentRender = new Sheets.CommentRender(self._getContainerDiv())
                        }
                        var sheet = self.getActiveSheet();
                        if (sheet)
                        {
                            sheet._setHost(self._vp);
                            $(window).unbind('resize.gcSheet')
                        }
                        self._doResize();
                        self._createFocusElementForTab(host)
                    }
                };
                Spread.prototype._createFocusElementForTab = function(host)
                {
                    var self = this;
                    var tabIndex = parseInt($(host).attr("tabindex"), 10) || 0;
                    var focusElement = document.createElement("div");
                    $(focusElement).css("position", "absolute").css("overflow", "hidden").attr("gcUIElement", "gcSheetFocusElementForTab").attr("tabindex", tabIndex).bind("focus", function()
                    {
                        if (!self._ignoreFocusEvent)
                        {
                            var activeSheet = self.getActiveSheet();
                            activeSheet.setFocus()
                        }
                        self._ignoreFocusEvent = false
                    });
                    host.insertBefore(focusElement, keyword_null);
                    self._tabFocusElement = focusElement
                };
                Spread.prototype.focusTabFocusElement = function()
                {
                    var self = this,
                        focusElement = self._tabFocusElement;
                    if (focusElement)
                    {
                        self._ignoreFocusEvent = true;
                        focusElement.focus()
                    }
                };
                Spread.prototype._onCultureChanged = function(e, data)
                {
                    var spreadTmp = e.data;
                    spreadTmp.invalidateLayout();
                    if (spreadTmp.touchToolStrip)
                    {
                        spreadTmp.touchToolStrip._updateResource()
                    }
                    for (var i = 0, len = spreadTmp.sheets.length; i < len; i++)
                    {
                        var sheet = spreadTmp.sheets[i];
                        var rowCount = sheet.getRowCount();
                        var colCount = sheet.getColumnCount();
                        for (var row = 0; row < rowCount; row++)
                        {
                            for (var col = 0; col < colCount; col++)
                            {
                                var value = sheet.getValue(row, col);
                                if (value === keyword_null)
                                {
                                    continue
                                }
                                var style = sheet.getStyle(row, col);
                                if (style)
                                {
                                    style._setActualAutoFormatter(value)
                                }
                            }
                        }
                    }
                    spreadTmp.repaint()
                };
                Spread.prototype._hscrollDelegate = function(e, data)
                {
                    var hostSpread = e.data;
                    var sheet = hostSpread.getActiveSheet();
                    if (sheet && data)
                    {
                        var v = parseInt(data.newValue, 10);
                        if (data.oldValue === keyword_undefined || data.oldValue === keyword_null)
                        {
                            data.oldValue = 0
                        }
                        data.oldValue = parseInt(data.oldValue, 10);
                        sheet._needSyncHScrollbarSize = false;
                        if (data.scrollEventType === 2 || data.scrollEventType === 0)
                        {
                            if (data.scrollEventType === 2)
                            {
                                v = sheet._getPrevPageLeftColumn()
                            }
                            var newV = sheet._getScrollableColumn(v, true);
                            if (newV != -1 && newV != v)
                            {
                                v = newV
                            }
                            if (!hostSpread._scrollbarShowMax)
                            {
                                sheet._needSyncHScrollbarSize = true;
                                data.ignoreUpdatePosition = true
                            }
                        }
                        else if (data.scrollEventType === 3 || data.scrollEventType === 1)
                        {
                            if (data.scrollEventType === 3)
                            {
                                v = sheet._getPageRightColumn()
                            }
                            if (!hostSpread._scrollbarShowMax)
                            {
                                sheet._needSyncHScrollbarSize = true;
                                if (data.scrollEventType === 1 && data.newValue === data.oldValue)
                                {
                                    v++
                                }
                            }
                            var newV = sheet._getScrollableColumn(v);
                            if (newV != -1 && newV != v)
                            {
                                v = newV
                            }
                        }
                        var firstPageLeftColumn = sheet._getFirstPageLeftColumn();
                        if (v < firstPageLeftColumn)
                        {
                            v = firstPageLeftColumn
                        }
                        if (v > sheet._getLastVisualScrollColumn())
                        {
                            v = sheet._getLastVisualScrollColumn()
                        }
                        if (data.newValue !== v)
                        {
                            data.newValue = v
                        }
                        if (data.oldValue !== v)
                        {
                            sheet._eventHandler.doHScroll(v);
                            sheet.triggerLeftColumnChanged({
                                sheet: sheet, sheetName: sheet._name, oldLeftCol: data.oldValue, newLeftCol: data.newValue
                            })
                        }
                    }
                };
                Spread.prototype._hScrollStop = function(e)
                {
                    var hostSpread = e.data;
                    var sheet = hostSpread.getActiveSheet();
                    if (sheet)
                    {
                        var scrollbarH = hostSpread._scrollbarH,
                            value = scrollbarH.value();
                        if (value < sheet._getFirstPageLeftColumn())
                        {
                            scrollbarH.value(sheet._getFirstPageLeftColumn())
                        }
                        else if (value > sheet._getLastVisualScrollColumn())
                        {
                            scrollbarH.value(sheet._getLastVisualScrollColumn())
                        }
                        sheet._eventHandler._removeTooltip();
                        if (!hostSpread._scrollbarShowMax)
                        {
                            if (sheet._eventHandler.scrolling)
                            {
                                sheet._needSyncHScrollbarSize = true
                            }
                            else
                            {
                                hostSpread._resizeHScrollBar()
                            }
                        }
                        if (sheet._formulaTextBox)
                        {
                            sheet._formulaTextBox.focus()
                        }
                    }
                };
                Spread.prototype._hScrollMouseDown = function(e)
                {
                    var hostSpread = e.data;
                    if (!hostSpread)
                    {
                        return
                    }
                    var sheet = hostSpread.getActiveSheet();
                    if (sheet)
                    {
                        sheet.setFocus()
                    }
                    var showScrollTip = hostSpread.showScrollTip();
                    if (showScrollTip === 1 || showScrollTip === 3)
                    {
                        var ele = $(e.srcElement ? e.srcElement : e.target);
                        var parent = ele.parent();
                        if ((ele && ele.hasClass(cssScrollerHandle)) || (parent && parent.hasClass(cssScrollerHandle)) || (ele && ele.hasClass(cssScrollbar)) || (parent && parent.hasClass(cssScrollbar)))
                        {
                            if (ele || parent)
                            {
                                var eventHandler = sheet && sheet._eventHandler;
                                if (eventHandler)
                                {
                                    eventHandler._showScrollTooltip(false, e)
                                }
                            }
                        }
                    }
                };
                Spread.prototype._vscrollDelegate = function(e, data)
                {
                    var hostSpread = e.data;
                    var sheet = hostSpread.getActiveSheet();
                    if (sheet && data)
                    {
                        var v = parseInt(data.newValue, 10);
                        if (data.oldValue === keyword_undefined || data.oldValue === keyword_null)
                        {
                            data.oldValue = 0
                        }
                        data.oldValue = parseInt(data.oldValue, 10);
                        sheet._needSyncVScrollbarSize = false;
                        if (data.scrollEventType === 2 || data.scrollEventType === 0)
                        {
                            if (data.scrollEventType === 2)
                            {
                                v = sheet._getPrevPageTopRow()
                            }
                            var newV = sheet._getScrollableRow(v, true);
                            if (newV != -1 && newV != v)
                            {
                                v = newV
                            }
                            if (!hostSpread._scrollbarShowMax)
                            {
                                sheet._needSyncVScrollbarSize = true;
                                data.ignoreUpdatePosition = true
                            }
                        }
                        else if (data.scrollEventType === 3 || data.scrollEventType === 1)
                        {
                            if (data.scrollEventType === 3)
                            {
                                v = sheet._getPageBottomRow()
                            }
                            if (!hostSpread._scrollbarShowMax)
                            {
                                sheet._needSyncVScrollbarSize = true;
                                if (data.scrollEventType === 1 && data.newValue === data.oldValue)
                                {
                                    v++
                                }
                            }
                            var newV = sheet._getScrollableRow(v);
                            if (newV != -1 && newV != v)
                            {
                                v = newV
                            }
                        }
                        var firstPageTopRow = sheet._getFirstPageTopRow();
                        if (v < firstPageTopRow)
                        {
                            v = firstPageTopRow
                        }
                        if (v > sheet._getLastVisualScrollRow())
                        {
                            v = sheet._getLastVisualScrollRow()
                        }
                        if (data.newValue !== v)
                        {
                            data.newValue = v
                        }
                        if (data.oldValue !== v)
                        {
                            sheet._eventHandler.doVScroll(v);
                            sheet.triggerTopRowChanged({
                                sheet: sheet, sheetName: sheet._name, oldTopRow: data.oldValue, newTopRow: v
                            })
                        }
                    }
                };
                Spread.prototype._initPaint = function()
                {
                    var isStandardCanvas = Sheets.util._isStandardCanvas();
                    if (isStandardCanvas)
                    {
                        return
                    }
                    var self = this;
                    var sheet = self.getActiveSheet();
                    if (!sheet)
                    {
                        return
                    }
                    var control = sheet._getCanvas();
                    if (control && control.firstChild && control.firstChild.loaded)
                    {
                        self.invalidateLayout();
                        self.repaint()
                    }
                    else
                    {
                        window.setTimeout(function()
                        {
                            self._initPaint.call(self)
                        }, 10)
                    }
                };
                Spread.prototype._vScrollStop = function(e)
                {
                    var hostSpread = e.data;
                    var sheet = hostSpread.getActiveSheet();
                    if (sheet)
                    {
                        var scrollbarV = hostSpread._scrollbarV,
                            value = scrollbarV.value();
                        if (value < sheet._getFirstPageTopRow())
                        {
                            scrollbarV.value(sheet._getFirstPageTopRow())
                        }
                        else if (value > sheet._getLastVisualScrollRow())
                        {
                            scrollbarV.value(sheet._getLastVisualScrollRow())
                        }
                        sheet._eventHandler._removeTooltip();
                        if (!hostSpread._scrollbarShowMax)
                        {
                            if (sheet._eventHandler.scrolling)
                            {
                                sheet._needSyncVScrollbarSize = true
                            }
                            else
                            {
                                hostSpread._resizeVScrollBar()
                            }
                        }
                        if (sheet._formulaTextBox)
                        {
                            sheet._formulaTextBox.focus()
                        }
                    }
                };
                Spread.prototype._vScrollMouseDown = function(e)
                {
                    var hostSpread = e.data;
                    if (!hostSpread)
                    {
                        return
                    }
                    var sheet = hostSpread.getActiveSheet();
                    if (sheet)
                    {
                        sheet.setFocus()
                    }
                    var showScrollTip = hostSpread.showScrollTip();
                    if (showScrollTip === 2 || showScrollTip === 3)
                    {
                        var ele = $(e.srcElement ? e.srcElement : e.target);
                        if (ele)
                        {
                            var parent = ele.parent();
                            if (ele.hasClass(cssScrollerHandle) || (parent && parent.hasClass(cssScrollerHandle)) || ele.hasClass(cssScrollbar) || (parent && parent.hasClass(cssScrollbar)))
                            {
                                var eventHandler = sheet && sheet._eventHandler;
                                if (eventHandler)
                                {
                                    eventHandler._showScrollTooltip(true, e)
                                }
                            }
                        }
                    }
                };
                Spread.prototype._scrollMouseUp = function(e)
                {
                    var hostSpread = e.data;
                    if (!hostSpread)
                    {
                        return
                    }
                    var sheet = hostSpread.getActiveSheet(),
                        eventHandler = sheet && sheet._eventHandler;
                    if (eventHandler)
                    {
                        eventHandler._removeTooltip()
                    }
                };
                Spread.prototype._dispose = function()
                {
                    var self = this;
                    Sheets.DPIHelper.disposeSpread(self);
                    $(window).unbind(cmd_resize + ns_spread, this._resizeHandler);
                    if (self._scrollbarH)
                    {
                        self._scrollbarH.dispose()
                    }
                    if (self._scrollbarV)
                    {
                        self._scrollbarV.dispose()
                    }
                    if (self._touchEventProvider)
                    {
                        self._touchEventProvider.dispose()
                    }
                    self._disposeUserEvents();
                    var sheet = self.getActiveSheet();
                    if (sheet)
                    {
                        sheet._dispose()
                    }
                    if (self._host)
                    {
                        self._host.innerHTML = "";
                        self._host.removeAttribute("gcUIElement");
                        var $host = $(self._host);
                        $host.unbind(Sheets.Events.CultureChanged);
                        $host.removeClass("gc-host-none-user-select");
                        if (!$host.attr("class"))
                        {
                            $host.removeAttr("class")
                        }
                    }
                    if (self.touchToolStrip)
                    {
                        self.touchToolStrip._dispose();
                        self.touchToolStrip = keyword_null
                    }
                    if (self._commentRender)
                    {
                        self._commentRender = keyword_null
                    }
                };
                Spread.prototype._disposeUserEvents = function()
                {
                    $(this._userEventsElem).unbind(ns_spread);
                    for (var i = 0; i < this.sheets.length; i++)
                    {
                        var sheet = this.sheets[i];
                        sheet._disposeUserEvents()
                    }
                };
                Spread.prototype._getCalcContexts = function()
                {
                    var t = [];
                    for (var i = 0; i < this.sheets.length; i++)
                    {
                        var e = this.sheets[i];
                        var ct = e._getCalcContexts();
                        if (ct)
                        {
                            while (ct.length > 0)
                            {
                                t.push(ct.pop())
                            }
                        }
                    }
                    return t
                };
                Spread.prototype._doWindowResize = function()
                {
                    var self = this;
                    if (self._windowResizeTimer)
                    {
                        window.clearTimeout(self._windowResizeTimer)
                    }
                    self._windowResizeTimer = window.setTimeout(function()
                    {
                        Sheets.DPIHelper.updateDPI();
                        self._doResize();
                        self._windowResizeTimer = keyword_null
                    }, 100)
                };
                Spread.prototype._doResize = function()
                {
                    var self = this;
                    if (self._isResizing)
                    {
                        return
                    }
                    self._isResizing = true;
                    self._doResizeImp();
                    self._isResizing = false
                };
                Spread.prototype._doResizeImp = function()
                {
                    var self = this;
                    if ($.browser.msie && (parseInt($.browser.version, 10) < 9))
                    {
                        var canvas = self.canvas;
                        if (canvas)
                        {
                            var ssContainer = canvas.parentElement;
                            var spContainer = ssContainer.parentElement;
                            var control = canvas.firstChild;
                            if (control && spContainer)
                            {
                                var isAutoSize = function(w)
                                    {
                                        return w === "" || w === "auto" || /%$/ig.test(w)
                                    };
                                if (isAutoSize(ssContainer.style.width) && spContainer.offsetWidth > 12)
                                {
                                    control.width = spContainer.offsetWidth - 12
                                }
                                if (isAutoSize(ssContainer.style.height && spContainer.offsetHeight > 10))
                                {
                                    control.height = spContainer.offsetHeight - 10
                                }
                            }
                        }
                    }
                    var scrollbarSize = self._getScrollbarSize();
                    var host = self._host;
                    if (!host)
                    {
                        return
                    }
                    var $host = $(host),
                        w = $host.width(),
                        h = $(host).height();
                    if (self.showVerticalScrollbar())
                    {
                        self._vp.style.width = "" + (w - scrollbarSize) + pixel
                    }
                    else
                    {
                        self._vp.style.width = "" + w + pixel
                    }
                    if (self.showHorizontalScrollbar() || self._tabStripVisible)
                    {
                        self._vp.style.height = "" + (h - scrollbarSize) + pixel
                    }
                    else
                    {
                        self._vp.style.height = "" + h + pixel
                    }
                    var availableWidth = $(self._vp).width();
                    var tabStripWidth = self._getActualTabStripRatio() * availableWidth;
                    self._tabs.style.width = "" + (tabStripWidth - 1) + pixel;
                    self._tabs.style.height = "" + scrollbarSize + pixel;
                    self._scrollbarV.width(scrollbarSize);
                    self._scrollbarV.height($(self._vp).height());
                    var hsWidth = w - (self._tabStripVisible ? tabStripWidth : 0) - (self.showVerticalScrollbar() ? scrollbarSize : 0);
                    self._scrollbarH.width(hsWidth > 0 ? hsWidth : 1);
                    self._scrollbarH.height(scrollbarSize);
                    var sheet = self.getActiveSheet();
                    if (sheet)
                    {
                        if (sheet._scrollTopRow === 0)
                        {
                            sheet._scrollTopRow = sheet._getFirstPageTopRow()
                        }
                        if (sheet._scrollLeftCol === 0)
                        {
                            sheet._scrollLeftCol = sheet._getFirstPageLeftColumn()
                        }
                    }
                    if (sheet)
                    {
                        sheet._eventHandler.doResize()
                    }
                    self._resizeHScrollBar();
                    self._resizeVScrollBar();
                    if (self._tabStripVisible === true)
                    {
                        $(self._tabs).show()
                    }
                    else
                    {
                        $(self._tabs).hide()
                    }
                    self._tab.doResize();
                    var fixWidth = $host.width();
                    if (w !== fixWidth && !self._haveLayoutFixing)
                    {
                        self._haveLayoutFixing = true;
                        setTimeout(function()
                        {
                            delete self._haveLayoutFixing;
                            self._doResizeImp()
                        }, 1)
                    }
                };
                Spread.prototype._resizeHScrollBar = function()
                {
                    var self = this,
                        sheet = self.getActiveSheet();
                    if (!sheet)
                    {
                        return
                    }
                    var columnCount = sheet.getColumnCount() - sheet._frozenTrailingColCount - sheet.frozenColCount,
                        startColumn = sheet.frozenColCount,
                        layout = sheet._getSheetLayout(),
                        lastColumn = startColumn + columnCount - 1,
                        endColumn = lastColumn,
                        scrollLeftCol = sheet._scrollLeftCol,
                        pageValueH = 1;
                    var leftCol = sheet._getLeftColWhenLastColShowComplete(layout.viewportWidth, startColumn, endColumn);
                    if (leftCol !== startColumn)
                    {
                        pageValueH = lastColumn - leftCol + 1
                    }
                    else
                    {
                        pageValueH = 1
                    }
                    if (self._scrollbarMaxAlign)
                    {
                        endColumn = leftCol
                    }
                    if (!self._scrollbarShowMax)
                    {
                        var lastNonNullRowAndCol = sheet._getLastNonNullRowAndCol(),
                            lastNonNullCol = lastNonNullRowAndCol.lastNonNullCol,
                            maxDirtyEndColumn = sheet._getLeftColWhenLastColShowComplete(layout.viewportWidth, startColumn, lastNonNullCol);
                        if (maxDirtyEndColumn === startColumn)
                        {
                            maxDirtyEndColumn++;
                            if (maxDirtyEndColumn > endColumn)
                            {
                                maxDirtyEndColumn = endColumn
                            }
                        }
                        if (scrollLeftCol > maxDirtyEndColumn)
                        {
                            endColumn = scrollLeftCol < endColumn ? scrollLeftCol : endColumn
                        }
                        else
                        {
                            endColumn = maxDirtyEndColumn
                        }
                        var rightCol = sheet._getRightColWhenFirstColShowComplete(layout.viewportWidth, endColumn, lastColumn);
                        if (rightCol !== lastColumn)
                        {
                            pageValueH = rightCol - endColumn + 1
                        }
                    }
                    if (scrollLeftCol > endColumn)
                    {
                        sheet._scrollLeftCol = endColumn
                    }
                    var newLeftCol = sheet._getScrollableColumn(sheet._scrollLeftCol);
                    if (newLeftCol !== -1 && newLeftCol !== sheet._scrollLeftCol)
                    {
                        sheet._scrollLeftCol = newLeftCol
                    }
                    var scrollbarH = self._scrollbarH;
                    if (scrollbarH)
                    {
                        scrollbarH.minimum(startColumn);
                        scrollbarH.maximum(endColumn);
                        scrollbarH.pageValue(pageValueH);
                        scrollbarH.refreshLayout();
                        scrollbarH.value(sheet._scrollLeftCol)
                    }
                };
                Spread.prototype._resizeVScrollBar = function()
                {
                    var self = this,
                        sheet = self.getActiveSheet();
                    if (!sheet)
                    {
                        return
                    }
                    var rowCount = sheet.getRowCount() - sheet._frozenTrailingRowCount - sheet.frozenRowCount,
                        startRow = sheet.frozenRowCount,
                        layout = sheet._getSheetLayout(),
                        lastRow = startRow + rowCount - 1,
                        endRow = lastRow,
                        scrollTopRow = sheet._scrollTopRow,
                        pageValueV = 1;
                    var topRow = sheet._getTopRowWhenLastRowShowComplete(layout.viewportHeight, startRow, endRow);
                    if (topRow !== startRow)
                    {
                        pageValueV = lastRow - topRow + 1
                    }
                    else
                    {
                        pageValueV = 1
                    }
                    if (self._scrollbarMaxAlign)
                    {
                        endRow = topRow
                    }
                    if (!self._scrollbarShowMax)
                    {
                        var lastNonNullRowAndCol = sheet._getLastNonNullRowAndCol(),
                            lastNonNullRow = lastNonNullRowAndCol.lastNonNullRow,
                            maxDirtyEndRow = sheet._getTopRowWhenLastRowShowComplete(layout.viewportHeight, startRow, lastNonNullRow);
                        if (maxDirtyEndRow === startRow)
                        {
                            maxDirtyEndRow++;
                            if (maxDirtyEndRow > endRow)
                            {
                                maxDirtyEndRow = endRow
                            }
                        }
                        if (scrollTopRow > maxDirtyEndRow)
                        {
                            endRow = scrollTopRow < endRow ? scrollTopRow : endRow
                        }
                        else
                        {
                            endRow = maxDirtyEndRow
                        }
                        var bottomRow = sheet._getBottomRowWhenFirstRowShowComplete(layout.viewportHeight, endRow, lastRow);
                        if (bottomRow !== lastRow)
                        {
                            pageValueV = bottomRow - endRow + 1
                        }
                    }
                    if (scrollTopRow > endRow)
                    {
                        sheet._scrollTopRow = endRow
                    }
                    var newTopRow = sheet._getScrollableRow(sheet._scrollTopRow);
                    if (newTopRow !== -1 && newTopRow !== sheet._scrollTopRow)
                    {
                        sheet._scrollTopRow = newTopRow
                    }
                    var scrollbarV = self._scrollbarV;
                    if (scrollbarV)
                    {
                        scrollbarV.minimum(startRow);
                        scrollbarV.maximum(endRow);
                        scrollbarV.pageValue(pageValueV);
                        scrollbarV.refreshLayout();
                        scrollbarV.value(sheet._scrollTopRow)
                    }
                };
                Spread.prototype._doTabHSResize = function()
                {
                    var self = this;
                    var scrollbarSize = self._getScrollbarSize();
                    var host = self._host;
                    if (!host)
                    {
                        return
                    }
                    var $host = $(host),
                        w = $host.width();
                    var availableWidth = $(self._vp).width();
                    var tabStripWidth = self._getActualTabStripRatio() * availableWidth;
                    self._tabs.style.width = "" + (tabStripWidth - 1) + pixel;
                    self._tabs.style.height = "" + scrollbarSize + pixel;
                    var hsWidth = w - (self._tabStripVisible ? tabStripWidth : 0) - (self.showVerticalScrollbar() ? scrollbarSize : 0);
                    self._scrollbarH.width(hsWidth > 0 ? hsWidth : 1);
                    self._scrollbarH.height(scrollbarSize);
                    self._scrollbarH.refreshLayout();
                    var sheet = self.getActiveSheet();
                    if (sheet)
                    {
                        if (sheet._scrollLeftCol === 0)
                        {
                            sheet._scrollLeftCol = sheet._getFirstPageLeftColumn()
                        }
                        self._scrollbarH.value(sheet._scrollLeftCol)
                    }
                    if (self._tabStripVisible === true)
                    {
                        $(self._tabs).show()
                    }
                    else
                    {
                        $(self._tabs).hide()
                    }
                    self._tab.doResize()
                };
                Spread.prototype._copyUserEvents = function(sheet)
                {
                    sheet._eventHandler._eventSuspended = this._eventSuspended;
                    for (var e = 0; e < this._userEvents.length; e++)
                    {
                        var item = this._userEvents[e];
                        sheet.bind(item.type, item.data, item.fn)
                    }
                };
                Spread.prototype._suspendInvalidate = function()
                {
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        sheet._suspendInvalidate()
                    }
                };
                Spread.prototype._resumeInvalidate = function()
                {
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        return sheet._resumeInvalidate()
                    }
                    return false
                };
                Spread.prototype._paintSpreadBackgroundImage = function()
                {
                    var self = this;
                    var sheet = self.getActiveSheet();
                    if (sheet)
                    {
                        if (!self._backgroundImage)
                        {
                            return
                        }
                        var canvas = $(sheet._getCanvas());
                        canvas.css("background-image", "url('" + self._backgroundImage + "')").css("background-repeat", "no-repeat");
                        if (self._backgroundImageLayout === keyword_null || self._backgroundImageLayout === keyword_undefined)
                        {
                            return
                        }
                        var imgSrc = self._backgroundImage;
                        if (!self._imageLoader)
                        {
                            self._imageLoader = new Sheets._GcImageLoader(function()
                            {
                                self._paintSpreadBackgroundImage()
                            })
                        }
                        try
                        {
                            if (self._imageLoader.getState(imgSrc))
                            {
                                var img = self._imageLoader.getImage(imgSrc),
                                    contentWidth = sheet._bounds.width,
                                    contentHeight = sheet._bounds.height;
                                Sheets.util._applyBackgroundImageLayout(sheet._getCanvas(), contentWidth, contentHeight, img.width, img.height, self._backgroundImageLayout)
                            }
                            else
                            {
                                self._imageLoader.addImage(imgSrc)
                            }
                        }
                        catch(ex) {}
                    }
                };
                Spread.prototype.touchScrollOnRails = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._touchScrollOnRails
                    }
                    else
                    {
                        self._touchScrollOnRails = value;
                        if (Sheets.features.touch)
                        {
                            Sheets.TouchHelper.TouchScrollOnRails(value)
                        }
                        return self
                    }
                };
                Spread.prototype._changeSheetForFormulaAcrossSheet = function(sheet, saveValue)
                {
                    if (typeof saveValue === "undefined")
                    {
                        saveValue = true
                    }
                    var self = this;
                    self._tab._doSheetTabClickChange(self.getSheetIndex(sheet.getName()), saveValue)
                };
                Spread.prototype.scrollbarMaxAlign = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._scrollbarMaxAlign
                    }
                    if (self._scrollbarMaxAlign !== value)
                    {
                        self._scrollbarMaxAlign = value;
                        var sheet = self.getActiveSheet();
                        if (sheet)
                        {
                            sheet._needSyncHScrollbarSize = true;
                            sheet._needSyncVScrollbarSize = true;
                            sheet.invalidate()
                        }
                    }
                    return self
                };
                Spread.prototype.scrollbarShowMax = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._scrollbarShowMax
                    }
                    if (self._scrollbarShowMax !== value)
                    {
                        self._scrollbarShowMax = value;
                        var sheet = self.getActiveSheet();
                        if (sheet)
                        {
                            sheet._needSyncHScrollbarSize = true;
                            sheet._needSyncVScrollbarSize = true;
                            sheet.invalidate()
                        }
                    }
                    return self
                };
                Spread.prototype.showVerticalScrollbar = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._showVerticalScrollbar
                    }
                    if (self._showVerticalScrollbar !== value)
                    {
                        self._showVerticalScrollbar = value;
                        if (value)
                        {
                            $(self._scrollbarV.getScrollbar()).show()
                        }
                        else
                        {
                            $(self._scrollbarV.getScrollbar()).hide()
                        }
                        self._doResize()
                    }
                    return self
                };
                Spread.prototype.showHorizontalScrollbar = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._showHorizontalScrollbar
                    }
                    if (self._showHorizontalScrollbar !== value)
                    {
                        self._showHorizontalScrollbar = value;
                        if (value)
                        {
                            $(self._scrollbarH.getScrollbar()).show();
                            self.setTabStripRatio(self.getTabStripRatio())
                        }
                        else
                        {
                            $(self._scrollbarH.getScrollbar()).hide();
                            self._setActualTabStripRatio(1)
                        }
                        self._doResize()
                    }
                    return self
                };
                Spread.prototype.allowUserZoom = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._allowUserZoom
                    }
                    this._allowUserZoom = value;
                    return this
                };
                Spread.prototype.allowSheetReorder = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._allowSheetReorder
                    }
                    this._allowSheetReorder = value;
                    return this
                };
                Spread.prototype.allowUserResize = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._allowUserResize
                    }
                    this._allowUserResize = value;
                    return this
                };
                Spread.prototype.tabStripVisible = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._tabStripVisible
                    }
                    if (self._tabStripVisible !== value)
                    {
                        self._tabStripVisible = value;
                        self._doResize()
                    }
                    return self
                };
                Spread.prototype.tabEditable = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._tabEditable
                    }
                    this._tabEditable = value;
                    return this
                };
                Spread.prototype.newTabVisible = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._newTabVisible
                    }
                    if (self._newTabVisible !== value)
                    {
                        self._newTabVisible = value;
                        self._doTabHSResize()
                    }
                    return self
                };
                Spread.prototype.cutCopyIndicatorVisible = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._cutCopyIndicatorVisible
                    }
                    if (self._cutCopyIndicatorVisible === value)
                    {
                        return self
                    }
                    var sheet = self.getActiveSheet();
                    if (sheet)
                    {
                        return sheet._bindToAutoRefresh(function(value)
                            {
                                self._cutCopyIndicatorVisible = value;
                                return self
                            })(value)
                    }
                    else
                    {
                        self._cutCopyIndicatorVisible = value;
                        return self
                    }
                };
                Spread.prototype.cutCopyIndicatorBorderColor = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._cutCopyIndicatorBorderColor
                    }
                    if (self._cutCopyIndicatorBorderColor === value)
                    {
                        return self
                    }
                    var sheet = self.getActiveSheet();
                    if (sheet)
                    {
                        return sheet._bindToAutoRefresh(function(value)
                            {
                                self._cutCopyIndicatorBorderColor = value;
                                return self
                            })(value)
                    }
                    else
                    {
                        self._cutCopyIndicatorBorderColor = value;
                        return self
                    }
                };
                Spread.prototype.canUserEditFormula = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return Sheets.util.hasCalc() && this._canUserEditFormula
                    }
                    this._canUserEditFormula = value;
                    return this
                };
                Spread.prototype.enableFormulaTextbox = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._enableFormulaTextbox
                    }
                    for (var i = 0; i < self.sheets.length; i++)
                    {
                        self.sheets[i].enableFormulaTextbox(value)
                    }
                    self._enableFormulaTextbox = value;
                    return self
                };
                Spread.prototype.autoFitType = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._autoFitType
                    }
                    this._autoFitType = value;
                    return this
                };
                Spread.prototype.startSheetIndex = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return (self._tab) ? self._firstTabUserSet : 0
                    }
                    if (self._tab && 0 <= value && value < self.getSheetCount())
                    {
                        self._firstTabUserSet = value;
                        if (self.sheets[value].visible())
                        {
                            self._tab._firstTab = value
                        }
                        else
                        {
                            var actualFirstTab = self._tab._getNextVisibleIndex(value);
                            if (actualFirstTab !== -1)
                            {
                                self._tab._firstTab = actualFirstTab
                            }
                        }
                    }
                    self._doTabHSResize();
                    return self
                };
                Spread.prototype.highlightInvalidData = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._highlightInvalidData
                    }
                    var self = this;
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        return sheet._bindToAutoRefresh(function(value)
                            {
                                self._highlightInvalidData = value;
                                return self
                            })(value)
                    }
                    else
                    {
                        self._highlightInvalidData = value
                    }
                };
                Spread.prototype.isPaintSuspended = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._paintSuspended
                    }
                    else
                    {
                        if (self._paintSuspended !== value)
                        {
                            self._paintSuspended = value;
                            for (var i = 0; i < self.sheets.length; i++)
                            {
                                self.sheets[i].isPaintSuspended(value)
                            }
                            if (self._tab)
                            {
                                self._tab.isPaintSuspended(value)
                            }
                        }
                        return self
                    }
                };
                Spread.prototype.destroy = function()
                {
                    $(window).unbind("resize.gcSpread", this._resizeHandler);
                    this._dispose()
                };
                Spread.prototype.repaint = function()
                {
                    var self = this;
                    if (self._tab)
                    {
                        self._tab.repaint()
                    }
                    var sheet = self.getActiveSheet();
                    if (sheet)
                    {
                        sheet.repaint()
                    }
                };
                Spread.prototype.refresh = function()
                {
                    var self = this;
                    if (self._host)
                    {
                        self._doResize();
                        self.repaint()
                    }
                };
                Spread.prototype.getHost = function()
                {
                    return this._host
                };
                Spread.prototype.invalidateLayout = function()
                {
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        sheet.invalidateLayout()
                    }
                };
                Spread.prototype.getActiveSheet = function()
                {
                    if (this.sheets.length > 0)
                    {
                        return this.sheets[this._activeSheetIndex]
                    }
                    else
                    {
                        return keyword_null
                    }
                };
                Spread.prototype.setActiveSheet = function(name)
                {
                    this._setActiveSheetInternal(name, 2)
                };
                Spread.prototype._setActiveSheetInternal = function(name, focusPolicy)
                {
                    var sheets = this.sheets;
                    for (var i = 0; i < sheets.length; i++)
                    {
                        if (sheets[i].getName() === name)
                        {
                            this._setActiveSheetIndexImp(i, focusPolicy)
                        }
                    }
                };
                Spread.prototype.getActiveSheetIndex = function()
                {
                    return this._activeSheetIndex
                };
                Spread.prototype.setActiveSheetIndex = function(value)
                {
                    this._setActiveSheetIndexImp(value, 2)
                };
                Spread.prototype._setActiveSheetIndexImp = function(value, focusPolicy)
                {
                    if (typeof value !== "number")
                    {
                        return
                    }
                    var self = this;
                    if (value === self._activeSheetIndex)
                    {
                        return
                    }
                    var newSheet = self.sheets[value];
                    if (!(newSheet && newSheet.visible()))
                    {
                        return
                    }
                    var sheet = self.getActiveSheet();
                    self._activeSheetIndex = value;
                    if (newSheet !== sheet)
                    {
                        if (sheet)
                        {
                            sheet._dispose(false)
                        }
                        self._setActiveSheetImp(newSheet, focusPolicy, false)
                    }
                    self._doResize()
                };
                Spread.prototype.addNamedStyle = function(style)
                {
                    this._addNamedStyleImp(style, true)
                };
                Spread.prototype._addNamedStyleImp = function(style, refresh)
                {
                    var self = this;
                    if (style !== keyword_null && style !== keyword_undefined)
                    {
                        if (style.name === keyword_null || style.name === keyword_undefined || style.name === '')
                        {
                            throw new Error(Sheets.SR.Exp_EmptyNamedStyle);
                        }
                        if (refresh)
                        {
                            var name = style.name.toUpperCase();
                            var sheet = self.getActiveSheet();
                            if (sheet)
                            {
                                sheet._bindToAutoRefresh(function(style)
                                {
                                    self._namedStyles[name] = style
                                })(style)
                            }
                            else
                            {
                                self._namedStyles[name] = style
                            }
                        }
                        else
                        {
                            var name = style.name.toUpperCase();
                            self._namedStyles[name] = style
                        }
                    }
                };
                Spread.prototype.getNamedStyle = function(name)
                {
                    return this.getNamedStyleImp(name, true)
                };
                Spread.prototype.getNamedStyleImp = function(name, clearCache)
                {
                    var namedStyles = this._namedStyles;
                    if (namedStyles && name)
                    {
                        name = name.toUpperCase();
                        var result = (namedStyles[name] || keyword_null);
                        if (result && clearCache)
                        {
                            this.clearStyleCache()
                        }
                        return result
                    }
                    return keyword_null
                };
                Spread.prototype.removeNamedStyle = function(name)
                {
                    var namedStyles = this._namedStyles;
                    if (namedStyles && name)
                    {
                        name = name.toUpperCase();
                        if (namedStyles.hasOwnProperty(name))
                        {
                            delete namedStyles[name];
                            var sheet = this.getActiveSheet();
                            if (sheet)
                            {
                                sheet.invalidate()
                            }
                        }
                    }
                };
                Spread.prototype.getNamedStyles = function()
                {
                    var namedStylesClone = [],
                        namedStyles = this._namedStyles;
                    if (namedStyles)
                    {
                        $.each(namedStyles, function(index, item)
                        {
                            namedStylesClone.push(item)
                        })
                    }
                    this.clearStyleCache();
                    return namedStylesClone
                };
                Spread.prototype.clearStyleCache = function()
                {
                    for (var i = 0; i < this.sheets.length; i++)
                    {
                        this.sheets[i].clearStyleCache()
                    }
                };
                Spread.prototype._setActiveSheetImp = function(sheet, focusPolicy, ignoreSetHost)
                {
                    if (!ignoreSetHost)
                    {
                        sheet._setHost(this._vp)
                    }
                    var setFocus = true;
                    switch (focusPolicy)
                    {
                        case 1:
                            setFocus = true;
                            break;
                        case 0:
                            setFocus = false;
                            break;
                        case 2:
                            setFocus = Sheets.FocusHelper.isActiveElement(sheet);
                            break
                    }
                    Sheets.FocusHelper.setActiveElement(keyword_null);
                    if (!this._suspendSetFocus && setFocus)
                    {
                        sheet.setFocus()
                    }
                    sheet._syncHScollbarPosition();
                    sheet._syncVScrollbarPosition()
                };
                Spread.prototype.addSheet = function(index, sheet)
                {
                    this._addSheetImp(index, 2, sheet)
                };
                Spread.prototype._addSheetImp = function(index, focusPolicy, sheet)
                {
                    var self = this;
                    if (!sheet)
                    {
                        sheet = self._createSheet(self._getDefaultSheetName(index))
                    }
                    var i,
                        length = self.sheets.length;
                    if (!sheet._name)
                    {
                        sheet._name = self._getDefaultSheetName(index)
                    }
                    else
                    {
                        for (i = 0; i < length; i++)
                        {
                            if (self.sheets[i]._name === sheet._name)
                            {
                                throw Sheets.SR.Exp_NotSupport;
                            }
                        }
                    }
                    self._copyUserEvents(sheet);
                    var oldActiveSheet = self.getActiveSheet();
                    var oldActiveSheetIndex = self._activeSheetIndex;
                    var p = self.sheets.length - index;
                    var tmp = [];
                    for (i = 0; i < p && self.sheets.length > 0; i++)
                    {
                        tmp.push(self.sheets.pop())
                    }
                    self.sheets.push(sheet);
                    sheet.onAttached(self);
                    while (tmp.length > 0)
                    {
                        self.sheets.push(tmp.pop())
                    }
                    if (self.sheets.length === 1)
                    {
                        if (self._vp)
                        {
                            sheet._setHost(self._vp)
                        }
                        self._activeSheetIndex = 0
                    }
                    else
                    {
                        self._activeSheetIndex = (oldActiveSheetIndex < 0) ? 0 : oldActiveSheetIndex
                    }
                    var newActiveSheet = self.getActiveSheet();
                    if (newActiveSheet !== oldActiveSheet)
                    {
                        if (oldActiveSheet)
                        {
                            oldActiveSheet._dispose(false)
                        }
                        if (newActiveSheet)
                        {
                            self._setActiveSheetImp(newActiveSheet, focusPolicy, self.sheets.length === 1)
                        }
                        self._doResize()
                    }
                    if (self._tab)
                    {
                        self._tab.repaint()
                    }
                };
                Spread.prototype.removeSheet = function(index)
                {
                    this._removeSheetImp(index, 2)
                };
                Spread.prototype._removeSheetImp = function(index, focusPolicy)
                {
                    var self = this;
                    if (isNaN(index) || index < 0 || index >= self.sheets.length)
                    {
                        throw new Error(Sheets.SR.Exp_IndexOutOfRange);
                    }
                    var activeSheetChanged = index <= self._activeSheetIndex || index === self.sheets.length - 1;
                    var oldActiveSheet = self.getActiveSheet();
                    if (index < self._activeSheetIndex)
                    {
                        self._activeSheetIndex--
                    }
                    var removedSheet = self.sheets[index];
                    removedSheet._disposeUserEvents();
                    self.sheets.splice(index, 1);
                    var sheets = self.sheets;
                    var sheetCounts = sheets.length;
                    if (sheetCounts === 0)
                    {
                        self._activeSheetIndex = -1
                    }
                    else
                    {
                        if (self._activeSheetIndex >= sheetCounts)
                        {
                            self._activeSheetIndex = self._tab._getPreVisibleIndex(sheetCounts)
                        }
                        else
                        {
                            for (var i = self._activeSheetIndex; i < sheetCounts; i++)
                            {
                                if (sheets[i]._visible)
                                {
                                    self._activeSheetIndex = i;
                                    break
                                }
                            }
                            if (i >= sheetCounts)
                            {
                                self._activeSheetIndex = -1
                            }
                        }
                    }
                    if (activeSheetChanged)
                    {
                        var newSheet = self.sheets[self._activeSheetIndex];
                        if (oldActiveSheet !== newSheet)
                        {
                            if (oldActiveSheet)
                            {
                                oldActiveSheet._dispose(false)
                            }
                            if (newSheet)
                            {
                                self._setActiveSheetImp(newSheet, focusPolicy, false)
                            }
                        }
                    }
                    if (self.calcService)
                    {
                        self.calcService.removeSource(removedSheet._getSheetSource())
                    }
                    if (self._tab)
                    {
                        var length = self.sheets.length;
                        if (self._tab._firstTab >= length)
                        {
                            self.startSheetIndex(self._tab._getPreVisibleIndex(length))
                        }
                        else if (self._tab._firstTab < 0)
                        {
                            self.startSheetIndex(0)
                        }
                        else
                        {
                            self._doResize()
                        }
                    }
                };
                Spread.prototype.clearSheets = function()
                {
                    var self = this,
                        sheets = self.sheets;
                    var oldSheet = self.getActiveSheet();
                    for (var i = 0; i < sheets.length; i++)
                    {
                        sheets[i]._disposeUserEvents();
                        sheets[i]._dispose()
                    }
                    sheets.splice(0, sheets.length);
                    if (self.calcService)
                    {
                        self.calcService.clearSource()
                    }
                    self._activeSheetIndex = -1;
                    if (self._tab)
                    {
                        self._tab._firstTab = 0;
                        self._tab.repaint()
                    }
                };
                Spread.prototype.getSheet = function(index)
                {
                    if (index >= 0 && index < this.sheets.length)
                    {
                        return this.sheets[index]
                    }
                    else
                    {
                        return keyword_null
                    }
                };
                Spread.prototype.getSheetFromName = function(name)
                {
                    var sheets = this.sheets;
                    for (var i = 0; i < sheets.length; i++)
                    {
                        if (sheets[i].getName() === name)
                        {
                            return sheets[i]
                        }
                    }
                    return keyword_null
                };
                Spread.prototype.getSheetIndex = function(name)
                {
                    var sheets = this.sheets;
                    for (var i = 0; i < sheets.length; i++)
                    {
                        if (sheets[i].getName() === name)
                        {
                            return i
                        }
                    }
                    return keyword_null
                };
                Spread.prototype.getSheetCount = function()
                {
                    return this.sheets.length
                };
                Spread.prototype.setSheetCount = function(count)
                {
                    this._setSheetCountImp(count, 2)
                };
                Spread.prototype._setSheetCountImp = function(count, focusPolicy)
                {
                    var self = this;
                    if (count < 0)
                    {
                        throw Sheets.SR.Exp_ArgumentOutOfRange;
                    }
                    else if (count === 0)
                    {
                        self.clearSheets()
                    }
                    var length = self.sheets.length,
                        i;
                    if (count < length)
                    {
                        for (i = length - 1; i >= count; i--)
                        {
                            self._removeSheetImp(i, focusPolicy)
                        }
                    }
                    else if (count > length)
                    {
                        for (i = length; i < count; i++)
                        {
                            self._addSheetImp(i, focusPolicy, keyword_undefined)
                        }
                    }
                };
                Spread.prototype.search = function(searchCondition)
                {
                    if (!searchCondition || !Sheets.features.search)
                    {
                        return keyword_null
                    }
                    var self = this;
                    var SearchFoundFlags_None = 0;
                    if (!searchCondition.searchString || searchCondition.searchTarget === SearchFoundFlags_None || self.getSheetCount() <= 0)
                    {
                        return new Sheets.SearchResult
                    }
                    if (searchCondition.startSheetIndex === -1)
                    {
                        searchCondition.startSheetIndex = 0
                    }
                    if (searchCondition.endSheetIndex === -1)
                    {
                        searchCondition.endSheetIndex = self.getSheetCount() - 1
                    }
                    if (searchCondition.endSheetIndex >= searchCondition.startSheetIndex && 0 <= searchCondition.startSheetIndex && searchCondition.startSheetIndex < self.getSheetCount() && 0 <= searchCondition.endSheetIndex && searchCondition.endSheetIndex < self.getSheetCount())
                    {
                        for (var sheetIndex = searchCondition.startSheetIndex; sheetIndex <= searchCondition.endSheetIndex; sheetIndex++)
                        {
                            var sheet = self.getSheet(sheetIndex);
                            var searchResult = sheet.search(searchCondition);
                            if (searchResult && searchResult.searchFoundFlag !== SearchFoundFlags_None)
                            {
                                searchResult.foundSheetIndex = sheetIndex;
                                return searchResult
                            }
                        }
                    }
                    return new Sheets.SearchResult
                };
                Spread.prototype.showCell = function(row, col, verticalPosition, horizontalPosition)
                {
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        sheet.showCell(row, col, verticalPosition, horizontalPosition)
                    }
                };
                Spread.prototype.showColumn = function(col, horizontalPosition)
                {
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        sheet.showColumn(col, horizontalPosition)
                    }
                };
                Spread.prototype.showRow = function(row, verticalPosition)
                {
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        sheet.showRow(row, verticalPosition)
                    }
                };
                Spread.prototype.showActiveCell = function(verticalPosition, horizontalPosition)
                {
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        sheet.showCell(sheet._activeRowIndex, sheet._activeColIndex, verticalPosition, horizontalPosition)
                    }
                };
                Spread.prototype.getCustomName = function(name)
                {
                    return this._names ? this._names[name.toUpperCase()] : keyword_null
                };
                Spread.prototype.getCustomNames = function()
                {
                    var result = [];
                    if (this._names)
                    {
                        $.each(this._names, function(p, v)
                        {
                            result.push(v)
                        })
                    }
                    return result
                };
                Spread.prototype.addCustomName = function(name, formula, baseRow, baseCol)
                {
                    this._addCustomNameCore(name, formula, baseRow, baseCol, false)
                };
                Spread.prototype._addCustomNameCore = function(name, formula, baseRow, baseCol, ignoreError)
                {
                    if (name === keyword_undefined || name === keyword_null || name === '' || formula === keyword_undefined || formula === keyword_null || formula === '')
                    {
                        throw new Error(Sheets.SR.Exp_InvalidCustomName);
                    }
                    var self = this;
                    if (!self._names)
                    {
                        self._names = {}
                    }
                    if (self.calcService)
                    {
                        if (ignoreError)
                        {
                            try
                            {
                                expr = self.calcService.parse(keyword_null, formula, baseRow, baseCol, false, true)
                            }
                            catch(ex) {}
                        }
                        else
                        {
                            var expr = self.calcService.parse(keyword_null, formula, baseRow, baseCol)
                        }
                        var upperName = name.toUpperCase();
                        self._names[upperName] = new Sheets.NameInfo(name, expr, baseRow, baseCol);
                        self._recalcAll()
                    }
                };
                Spread.prototype.removeCustomName = function(name)
                {
                    var self = this;
                    if (self._names && name !== keyword_undefined && name !== keyword_null && name !== '')
                    {
                        var upperName = name.toUpperCase();
                        if (self._names[upperName])
                        {
                            delete self._names[upperName];
                            self._recalcAll()
                        }
                    }
                };
                Spread.prototype.clearCustomNames = function()
                {
                    if (this._names)
                    {
                        delete this._names;
                        this._recalcAll()
                    }
                };
                Spread.prototype._findCustomName = function(name)
                {
                    if (name === keyword_undefined || name === keyword_null || name === '')
                    {
                        return keyword_null
                    }
                    var fn = this.getCustomName(name);
                    return fn
                };
                Spread.prototype.addCustomFunction = function(fn)
                {
                    this._addCustomFunctionCore(fn);
                    this._recalcAll()
                };
                Spread.prototype._addCustomFunctionCore = function(fn)
                {
                    if (!Sheets.util.hasCalc())
                    {
                        return
                    }
                    if (fn === keyword_undefined || fn === keyword_null || !(fn instanceof Sheets.Calc.Functions.Function))
                    {
                        throw new Error(Sheets.SR.Exp_InvalidCustomFunction);
                    }
                    var self = this;
                    var fnName = fn.name.toUpperCase();
                    if (!self._functions)
                    {
                        self._functions = {}
                    }
                    self._functions[fnName] = fn
                };
                Spread.prototype.getCustomFunction = function(name)
                {
                    if (this._functions && name !== keyword_undefined && name !== keyword_null && name !== '')
                    {
                        return this._functions[name.toUpperCase()]
                    }
                    return keyword_null
                };
                Spread.prototype.removeCustomFunction = function(name)
                {
                    var self = this;
                    if (self._functions && name !== keyword_undefined && name !== keyword_null && name !== '')
                    {
                        name = name.toUpperCase();
                        if (self._functions.hasOwnProperty(name))
                        {
                            delete self._functions[name];
                            self._recalcAll()
                        }
                    }
                };
                Spread.prototype.clearCustomFunctions = function()
                {
                    if (this._functions)
                    {
                        this._functions = keyword_null;
                        this._recalcAll()
                    }
                };
                Spread.prototype._recalcAll = function()
                {
                    if (this.calcService && !this.calcService.IsSuspended())
                    {
                        this.calcService.recalculateAll()
                    }
                };
                Spread.prototype.getCalcService = function()
                {
                    return this.calcService
                };
                Spread.prototype.addCustomFunctionDescription = function(fnd)
                {
                    if (!fnd || !fnd.name || this.getCustomFunctionDescription(fnd.name))
                    {
                        return
                    }
                    var fnds = this._functionDescriptions;
                    if (!fnds)
                    {
                        fnds = this._functionDescriptions = []
                    }
                    fnds.push(fnd)
                };
                Spread.prototype.getCustomFunctionDescription = function(name)
                {
                    var fnds = this._functionDescriptions;
                    if (fnds && name)
                    {
                        name = name.toUpperCase();
                        var count = fnds.length,
                            fnd;
                        for (var i = 0; i < count; i++)
                        {
                            fnd = fnds[i];
                            if (fnd.name && fnd.name.toUpperCase() === name)
                            {
                                return fnd
                            }
                        }
                    }
                    return keyword_null
                };
                Spread.prototype.removeCustomFunctionDescription = function(name)
                {
                    var fnds = this._functionDescriptions;
                    if (!fnds || !name)
                    {
                        return
                    }
                    name = name.toUpperCase();
                    var count = fnds.length,
                        fnd;
                    for (var i = 0; i < count; i++)
                    {
                        fnd = fnds[i];
                        if (fnd.name && fnd.name.toUpperCase() === name)
                        {
                            fnds.splice(i, 1);
                            break
                        }
                    }
                };
                Spread.prototype.clearCustomFunctionDescriptions = function()
                {
                    if (this._functionDescriptions)
                    {
                        this._functionDescriptions = keyword_null
                    }
                };
                Spread.prototype.referenceStyle = function(value)
                {
                    var self = this;
                    var R1C1 = 1,
                        A1 = 0;
                    if (arguments.length === 0)
                    {
                        if (self.calcService)
                        {
                            return self.calcService.useR1C1 ? R1C1 : A1
                        }
                        else
                        {
                            return A1
                        }
                    }
                    if (self.calcService)
                    {
                        self.calcService.useR1C1 = (value === R1C1)
                    }
                    return self
                };
                Spread.prototype.bind = function(type, data, fn)
                {
                    var self = this;
                    self._userEvents.push({
                        type: type, data: data, fn: fn
                    });
                    $(self._userEventsElem).bind(type + ns_spread, data, fn);
                    for (var i = 0; i < self.sheets.length; i++)
                    {
                        var sheet = self.sheets[i];
                        sheet.bind(type, data, fn)
                    }
                };
                Spread.prototype.unbind = function(type, fn)
                {
                    var self = this;
                    for (var e = 0; e < self._userEvents.length; e++)
                    {
                        var item = self._userEvents[e];
                        if (item.type === type)
                        {
                            self._userEvents.splice(e, 1)
                        }
                    }
                    $(self._userEventsElem).unbind(type + ns_spread, fn);
                    for (var i = 0; i < self.sheets.length; i++)
                    {
                        var sheet = self.sheets[i];
                        sheet.unbind(type, fn)
                    }
                };
                Spread.prototype.unbindAll = function()
                {
                    var self = this;
                    self._userEvents.length = 0;
                    $(self._userEventsElem).unbind(ns_spread);
                    for (var i = 0; i < self.sheets.length; i++)
                    {
                        var sheet = self.sheets[i];
                        sheet.unbindAll()
                    }
                };
                Spread.prototype._bind = function(type, data, fn)
                {
                    var self = this;
                    self._userEvents.push({
                        type: type, data: data, fn: fn
                    });
                    $(self._userEventsElem).bind(type + ns_spreadInternal, data, fn);
                    for (var i = 0; i < self.sheets.length; i++)
                    {
                        var sheet = self.sheets[i];
                        sheet._bind(type, data, fn)
                    }
                };
                Spread.prototype._unbind = function(type, fn)
                {
                    var self = this;
                    for (var e = 0; e < self._userEvents.length; e++)
                    {
                        var item = self._userEvents[e];
                        if (item.type === type)
                        {
                            self._userEvents.splice(e, 1)
                        }
                    }
                    $(self._userEventsElem).unbind(type + ns_spreadInternal, fn);
                    for (var i = 0; i < self.sheets.length; i++)
                    {
                        var sheet = self.sheets[i];
                        sheet._unbind(type, fn)
                    }
                };
                Spread.prototype._unbindAll = function()
                {
                    var self = this;
                    self._userEvents.length = 0;
                    $(self._userEventsElem).unbind(ns_spreadInternal);
                    for (var i = 0; i < self.sheets.length; i++)
                    {
                        var sheet = self.sheets[i];
                        sheet._unbindAll()
                    }
                };
                Spread.prototype.suspendEvent = function()
                {
                    this._eventSuspended++;
                    for (var i = 0; i < this.sheets.length; i++)
                    {
                        var sheet = this.sheets[i];
                        sheet.suspendEvent()
                    }
                };
                Spread.prototype.resumeEvent = function()
                {
                    var self = this;
                    self._eventSuspended--;
                    if (self._eventSuspended < 0)
                    {
                        self._eventSuspended = 0
                    }
                    for (var i = 0; i < self.sheets.length; i++)
                    {
                        var sheet = self.sheets[i];
                        sheet.resumeEvent()
                    }
                };
                Spread.prototype.doCommand = function(action)
                {
                    this._undoManager.doAction(action)
                };
                Spread.prototype.allowUndo = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._allowUndo
                    }
                    self._allowUndo = value;
                    if (self._undoManager)
                    {
                        self._undoManager._allowUndo = value
                    }
                    return self
                };
                Spread.prototype.undoManager = function()
                {
                    var self = this;
                    if (!self._undoManager)
                    {
                        self._undoManager = new Sheets._UndoManager(self, -1, self.allowUndo())
                    }
                    return self._undoManager
                };
                Spread.prototype.canUserDragDrop = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._allowDragDrop
                    }
                    else
                    {
                        this._allowDragDrop = value;
                        return this
                    }
                };
                Spread.prototype.canUserDragFill = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        if (!Sheets.features.fill)
                        {
                            return false
                        }
                        return self._allowDragFill
                    }
                    else
                    {
                        if (self._allowDragFill !== value)
                        {
                            self._allowDragFill = value;
                            var sheet = self.getActiveSheet();
                            if (sheet)
                            {
                                if (sheet.getSelections().length === 1 && !sheet._paintSuspended)
                                {
                                    sheet._render.repaintSelection(sheet.getSelections()[0])
                                }
                            }
                        }
                        return self
                    }
                };
                Spread.prototype.showDragFillSmartTag = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._showDragFillSmartTag
                    }
                    else
                    {
                        if (typeof value === "boolean" && self._showDragFillSmartTag !== value)
                        {
                            self._showDragFillSmartTag = value
                        }
                        return self
                    }
                };
                Spread.prototype.defaultDragFillType = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._defaultDragFillType
                    }
                    else
                    {
                        if (Sheets.AutoFillType[value] !== keyword_undefined && value !== 4 && value !== self._defaultDragFillType)
                        {
                            self._defaultDragFillType = value
                        }
                        return self
                    }
                };
                Spread.prototype.toJSON = function(serializationOption)
                {
                    var self = this;
                    var sheetCount = self.getSheetCount();
                    var dataDic = {
                            activeSheetIndex: self.getActiveSheetIndex(), sheetCount: sheetCount, tabStripRatio: self.getTabStripRatio(), tabStripVisible: self._tabStripVisible, tabEditable: self._tabEditable, newTabVisible: self._newTabVisible, referenceStyle: self.referenceStyle(), canUserEditFormula: self._canUserEditFormula, startSheetIndex: self.startSheetIndex(), allowUndo: self._allowUndo, allowUserZoom: self._allowUserZoom, allowUserResize: self._allowUserResize, allowDragDrop: self._allowDragDrop, allowDragFill: self._allowDragFill, showDragFillSmartTag: self._showDragFillSmartTag, defaultDragFillType: self._defaultDragFillType, allowSheetReorder: self._allowSheetReorder, highlightInvalidData: self._highlightInvalidData, autoFitType: self._autoFitType, showScrollTip: self._showScrollTip, showResizeTip: self._showResizeTip, showDragDropTip: self._showDragDropTip, showDragFillTip: self._showDragFillTip, showHorizontalScrollbar: self._showHorizontalScrollbar, showVerticalScrollbar: self._showVerticalScrollbar, scrollbarMaxAlign: self._scrollbarMaxAlign, scrollbarShowMax: self._scrollbarShowMax, backColor: self._backColor, backgroundImage: self._backgroundImage, backgroundImageLayout: self._backgroundImageLayout, grayAreaBackColor: self._grayAreaBackColor, cutCopyIndicatorVisible: self._cutCopyIndicatorVisible, cutCopyIndicatorBorderColor: self._cutCopyIndicatorBorderColor, useTouchLayout: self._useTouchLayout, hideSelection: self._hideSelection, customFunctions: self._functions
                        };
                    var sdata = {version: Sheets.productInfo.productVersion};
                    for (var item in dataDic)
                    {
                        var value = dataDic[item];
                        if (!self._isDefaultValue(item, value))
                        {
                            sdata[item] = value
                        }
                    }
                    var sheets = {};
                    for (var i = 0; i < sheetCount; i++)
                    {
                        var sheet = self.getSheet(i);
                        sheets[sheet._name] = sheet.toJSON(serializationOption);
                        sheets[sheet._name].index = i
                    }
                    if (!$.isEmptyObject(sheets))
                    {
                        sdata["sheets"] = sheets
                    }
                    var namedStyles = [];
                    if (self._namedStyles)
                    {
                        for (var item in self._namedStyles)
                        {
                            namedStyles.push(self._namedStyles[item])
                        }
                    }
                    if (namedStyles.length > 0)
                    {
                        sdata["namedStyles"] = namedStyles
                    }
                    var names = [];
                    if (self._names && self.calcService)
                    {
                        for (var n in self._names)
                        {
                            if (self._names.hasOwnProperty(n))
                            {
                                var ni = self._names[n];
                                var name = ni.getName(),
                                    row = ni.getRow(),
                                    col = ni.getColumn(),
                                    expr = ni.getExpression();
                                var f = self.calcService.unparseWithoutCulture(keyword_null, expr, row, col, true);
                                names.push({
                                    name: name, formula: f, row: row, col: col
                                })
                            }
                        }
                    }
                    if (names.length > 0)
                    {
                        sdata["names"] = names
                    }
                    var sparklineExs = [];
                    for (var name in self._sparklineExs)
                    {
                        var sparklineEx = self._sparklineExs[name];
                        var jsonData = sparklineEx.toJSON();
                        if (jsonData && jsonData.typeName)
                        {
                            sparklineExs.push(jsonData)
                        }
                    }
                    if (sparklineExs.length > 0)
                    {
                        sdata["sparklineExs"] = sparklineExs
                    }
                    return sdata
                };
                Spread.prototype._isDefaultValue = function(propertyName, value)
                {
                    switch (propertyName)
                    {
                        case"activeSheetIndex":
                            return value === this._defaultActiveSheetIndex;
                        case"sheetCount":
                            return value === this._defaultSheetCount;
                        case"tabStripRatio":
                            return value === 0.5;
                        case"tabStripVisible":
                            return value === true;
                        case"tabEditable":
                            return value === true;
                        case"newTabVisible":
                            return value === true;
                        case"referenceStyle":
                            return value === 0;
                        case"canUserEditFormula":
                            return value === true;
                        case"startSheetIndex":
                            return value === 0;
                        case"allowUndo":
                            return value === true;
                        case"allowUserZoom":
                            return value === true;
                        case"allowUserResize":
                            return value === true;
                        case"allowDragDrop":
                            return value === true;
                        case"allowDragFill":
                            return value === true;
                        case"showDragFillSmartTag":
                            return value === true;
                        case"defaultDragFillType":
                            return value === 5;
                        case"allowSheetReorder":
                            return value === true;
                        case"highlightInvalidData":
                            return value === false;
                        case"autoFitType":
                            return value === 0;
                        case"showScrollTip":
                            return value === 0;
                        case"showResizeTip":
                            return value === 0;
                        case"showDragDropTip":
                            return value === true;
                        case"showDragFillTip":
                            return value === true;
                        case"showHorizontalScrollbar":
                            return value === true;
                        case"showVerticalScrollbar":
                            return value === true;
                        case"scrollbarMaxAlign":
                            return value === false;
                        case"scrollbarShowMax":
                            return value === true;
                        case"backColor":
                            return value === "white";
                        case"backgroundImage":
                            return value === keyword_null;
                        case"backgroundImageLayout":
                            return value === 0;
                        case"grayAreaBackColor":
                            return value === "gray";
                        case"cutCopyIndicatorVisible":
                            return value === true;
                        case"cutCopyIndicatorBorderColor":
                            return value === "#217346";
                        case"useTouchLayout":
                            return value === false;
                        case"hideSelection":
                            return value === false;
                        default:
                            return
                    }
                };
                Spread.prototype.fromJSON = function(spreadData)
                {
                    if (!spreadData)
                    {
                        return
                    }
                    var self = this;
                    var isNoneSchema = self._getJsonDataVersion(spreadData) < 3.0;
                    self._suspendSetFocus = true;
                    var oldState = self.isPaintSuspended();
                    self.isPaintSuspended(true);
                    self.suspendEvent();
                    var oldCulture = GcSpread.Sheets.Culture();
                    GcSpread.Sheets.switchCulture("");
                    try
                    {
                        if (Sheets.util.hasCalc())
                        {
                            self.calcService = new Sheets.Calc.CalcService
                        }
                        self._availableSheetIndex = -1;
                        self.clearSheets();
                        var sheetCount = spreadData.sheetCount;
                        if (typeof sheetCount === const_undefined)
                        {
                            sheetCount = self._defaultSheetCount
                        }
                        self._setSheetCountImp(sheetCount, 0);
                        if (spreadData.referenceStyle !== keyword_null && spreadData.referenceStyle !== keyword_undefined)
                        {
                            self.referenceStyle(spreadData.referenceStyle)
                        }
                        self._names = {};
                        self._namedStyles = {};
                        if (spreadData.namedStyles)
                        {
                            for (var i = 0; i < spreadData.namedStyles.length; i++)
                            {
                                var item = spreadData.namedStyles[i];
                                var style = new Sheets.Style;
                                style.fromJSON(item, isNoneSchema);
                                if (typeof(item.validator) !== const_undefined)
                                {
                                    var dv;
                                    if (Sheets.features.dataValidator)
                                    {
                                        dv = new GcSpread.Sheets.DefaultDataValidator;
                                        dv.fromJSON(item.validator, isNoneSchema)
                                    }
                                    style.validator = dv
                                }
                                self._addNamedStyleImp(style, false)
                            }
                        }
                        var i = 0,
                            sheet,
                            sheets = spreadData.sheets;
                        if (sheets)
                        {
                            for (var s in sheets)
                            {
                                if (typeof(s) === "string")
                                {
                                    var sheetData = sheets[s];
                                    var index = sheetData.index !== keyword_undefined ? sheetData.index : sheetData._index;
                                    if (index != keyword_undefined)
                                    {
                                        sheet = self.sheets[index]
                                    }
                                    else
                                    {
                                        sheet = self.sheets[i]
                                    }
                                    sheet.fromJSON(sheetData, false, isNoneSchema);
                                    i++
                                }
                            }
                        }
                        var activeSheetIndex = spreadData.activeSheetIndex;
                        if (typeof activeSheetIndex === const_undefined)
                        {
                            activeSheetIndex = self._defaultActiveSheetIndex
                        }
                        self._setActiveSheetIndexImp(activeSheetIndex, 0);
                        if (typeof spreadData.tabStripRatio !== const_undefined)
                        {
                            self.setTabStripRatio(spreadData.tabStripRatio)
                        }
                        if (typeof spreadData.tabStripVisible !== const_undefined)
                        {
                            self._tabStripVisible = spreadData.tabStripVisible
                        }
                        if (typeof spreadData.tabEditable !== const_undefined)
                        {
                            self._tabEditable = spreadData.tabEditable
                        }
                        if (typeof spreadData.newTabVisible !== const_undefined)
                        {
                            self._newTabVisible = spreadData.newTabVisible
                        }
                        self.gcSpreadsheet = spreadData.gcSpreadsheet;
                        if (typeof spreadData.canUserEditFormula !== const_undefined)
                        {
                            self._canUserEditFormula = spreadData.canUserEditFormula
                        }
                        if (typeof spreadData.startSheetIndex !== const_undefined)
                        {
                            self.startSheetIndex(spreadData.startSheetIndex)
                        }
                        if (typeof spreadData.allowUndo !== const_undefined)
                        {
                            self.allowUndo(spreadData.allowUndo)
                        }
                        if (typeof spreadData.allowUserZoom !== const_undefined)
                        {
                            self._allowUserZoom = spreadData.allowUserZoom
                        }
                        if (typeof spreadData.allowUserResize !== const_undefined)
                        {
                            self._allowUserResize = spreadData.allowUserResize
                        }
                        var spreadSheets = self.sheets;
                        if (typeof spreadData.allowDragDrop !== const_undefined)
                        {
                            self._allowDragDrop = spreadData.allowDragDrop;
                            if (spreadSheets && spreadSheets.length > 0)
                            {
                                for (var i = 0; i < spreadSheets.length; i++)
                                {
                                    spreadSheets[i]._allowDragDrop = self._allowDragDrop
                                }
                            }
                        }
                        if (typeof spreadData.allowDragFill !== const_undefined)
                        {
                            self._allowDragFill = spreadData.allowDragFill;
                            if (spreadSheets && spreadSheets.length > 0)
                            {
                                for (var i = 0; i < spreadSheets.length; i++)
                                {
                                    spreadSheets[i]._allowDragFill = self._allowDragFill
                                }
                            }
                        }
                        if (typeof spreadData.showDragFillSmartTag !== const_undefined)
                        {
                            self._showDragFillSmartTag = spreadData.showDragFillSmartTag;
                            if (spreadSheets && spreadSheets.length > 0)
                            {
                                for (var i = 0; i < spreadSheets.length; i++)
                                {
                                    spreadSheets[i]._showDragFillSmartTag = self._showDragFillSmartTag
                                }
                            }
                        }
                        if (typeof spreadData.defaultDragFillType !== const_undefined)
                        {
                            self._defaultDragFillType = spreadData.defaultDragFillType;
                            if (spreadSheets && spreadSheets.length > 0)
                            {
                                for (var i = 0; i < spreadSheets.length; i++)
                                {
                                    spreadSheets[i]._defaultDragFillType = self._defaultDragFillType
                                }
                            }
                        }
                        if (typeof spreadData.allowSheetReorder !== const_undefined)
                        {
                            self._allowSheetReorder = spreadData.allowSheetReorder
                        }
                        if (typeof spreadData.highlightInvalidData !== const_undefined)
                        {
                            self._highlightInvalidData = spreadData.highlightInvalidData
                        }
                        if (typeof spreadData.autoFitType !== const_undefined)
                        {
                            self.autoFitType(spreadData.autoFitType)
                        }
                        if (typeof spreadData.showResizeTip !== const_undefined)
                        {
                            self._showResizeTip = spreadData.showResizeTip
                        }
                        if (typeof spreadData.showScrollTip !== const_undefined)
                        {
                            self._showScrollTip = spreadData.showScrollTip
                        }
                        if (typeof spreadData.showDragDropTip !== const_undefined)
                        {
                            self._showDragDropTip = spreadData.showDragDropTip
                        }
                        if (typeof spreadData.showDragFillTip !== const_undefined)
                        {
                            self._showDragFillTip = spreadData.showDragFillTip
                        }
                        if (typeof spreadData.showHorizontalScrollbar !== const_undefined)
                        {
                            self.showHorizontalScrollbar(spreadData.showHorizontalScrollbar)
                        }
                        if (typeof spreadData.showVerticalScrollbar !== const_undefined)
                        {
                            self.showVerticalScrollbar(spreadData.showVerticalScrollbar)
                        }
                        if (typeof spreadData.scrollbarMaxAlign !== const_undefined)
                        {
                            self.scrollbarMaxAlign(spreadData.scrollbarMaxAlign)
                        }
                        if (typeof spreadData.scrollbarShowMax !== const_undefined)
                        {
                            self.scrollbarShowMax(spreadData.scrollbarShowMax)
                        }
                        if (typeof spreadData.backColor !== const_undefined)
                        {
                            self.backColor(spreadData.backColor)
                        }
                        if (typeof spreadData.backgroundImage !== const_undefined)
                        {
                            self.backgroundImage(spreadData.backgroundImage)
                        }
                        if (typeof spreadData.backgroundImageLayout !== const_undefined)
                        {
                            self.backgroundImageLayout(spreadData.backgroundImageLayout)
                        }
                        if (typeof spreadData.grayAreaBackColor !== const_undefined)
                        {
                            self.grayAreaBackColor(spreadData.grayAreaBackColor)
                        }
                        if (typeof spreadData.cutCopyIndicatorVisible !== const_undefined)
                        {
                            self.cutCopyIndicatorVisible(spreadData.cutCopyIndicatorVisible)
                        }
                        if (typeof spreadData.cutCopyIndicatorBorderColor !== const_undefined)
                        {
                            self.cutCopyIndicatorBorderColor(spreadData.cutCopyIndicatorBorderColor)
                        }
                        if (typeof spreadData.useTouchLayout !== const_undefined)
                        {
                            self.useTouchLayout(spreadData.useTouchLayout)
                        }
                        if (typeof spreadData.hideSelection !== const_undefined)
                        {
                            self.hideSelection(spreadData.hideSelection)
                        }
                        if (self.calcService)
                        {
                            self.calcService.suspend()
                        }
                        self.clearCustomNames();
                        if (spreadData.names)
                        {
                            for (var n = 0; n < spreadData.names.length; n++)
                            {
                                var ni = spreadData.names[n];
                                self._addCustomNameCore(ni.name, ni.formula, ni.row, ni.col, true)
                            }
                        }
                        var customFunctions = spreadData.customFunctions;
                        if (customFunctions)
                        {
                            for (var func in customFunctions)
                            {
                                var funcJsonData = customFunctions[func];
                                var customFunctionClass = Sheets.getTypeFromString(funcJsonData.typeName);
                                if (customFunctionClass)
                                {
                                    var customFunc = new customFunctionClass;
                                    customFunc.fromJSON(funcJsonData, isNoneSchema);
                                    sheet._addCustomFunctionCore(customFunc)
                                }
                            }
                        }
                        var sparklineExs = spreadData.sparklineExs;
                        if (sparklineExs)
                        {
                            for (var n = 0; n < sparklineExs.length; n++)
                            {
                                var sparklineExJsonData = spreadData.sparklineExs[n];
                                var sparklineExClass = Sheets.getTypeFromString(sparklineExJsonData.typeName);
                                if (sparklineExClass)
                                {
                                    var sparkline = new sparklineExClass;
                                    sparkline.fromJSON(sparklineExJsonData);
                                    self.addSparklineEx(sparkline)
                                }
                            }
                        }
                        if (sheets)
                        {
                            i = 0;
                            for (var s in sheets)
                            {
                                if (typeof(s) === "string")
                                {
                                    var sheetData = sheets[s];
                                    var index = sheetData.index !== keyword_undefined ? sheetData.index : sheetData._index;
                                    if (index != keyword_undefined)
                                    {
                                        sheet = self.sheets[index]
                                    }
                                    else
                                    {
                                        sheet = self.sheets[i]
                                    }
                                    sheet.formulaFromJSON(sheetData, isNoneSchema);
                                    i++
                                }
                            }
                        }
                        if (self.calcService)
                        {
                            if (spreadData.noRecalc)
                            {
                                self.calcService.resumeWithoutCalc()
                            }
                            else
                            {
                                self.calcService.resume(true)
                            }
                        }
                    }
                    finally
                    {
                        GcSpread.Sheets.switchCulture(oldCulture);
                        self._suspendSetFocus = false;
                        var activeSheet = self.getActiveSheet();
                        if (activeSheet && Sheets.FocusHelper.isActiveElement(activeSheet))
                        {
                            activeSheet.setFocus()
                        }
                        self.resumeEvent();
                        self.isPaintSuspended(oldState)
                    }
                };
                Spread.prototype._getJsonDataVersion = function(spreadData)
                {
                    var version = spreadData.version;
                    if (!version || !((typeof version) === "string"))
                    {
                        return 1.0
                    }
                    var versionInfo = version.split(".");
                    if (!versionInfo || versionInfo.length === 0)
                    {
                        return 1.0
                    }
                    if (versionInfo.length > 3)
                    {
                        return 3.0
                    }
                    var mjaorVersion = parseFloat(versionInfo[0]);
                    if (versionInfo.length <= 2)
                    {
                        if (isNaN(mjaorVersion))
                        {
                            return 1.0
                        }
                        return mjaorVersion
                    }
                    else
                    {
                        var yearVersion = parseFloat(versionInfo[1]);
                        if (mjaorVersion >= 3.0)
                        {
                            if (yearVersion >= 20143)
                            {
                                return 3.0
                            }
                            else if (yearVersion >= 20142)
                            {
                                return 2.0
                            }
                        }
                        return 1.0
                    }
                };
                Spread.prototype.setTabStripRatio = function(tabStripRatio, skipRefreshScrollbar)
                {
                    var ratio;
                    if (isNaN(ratio = tabStripRatio))
                    {
                        throw Sheets.SR.Exp_InvalidArgument;
                    }
                    var self = this;
                    var totalWidth = $(self._vp).width();
                    var minRatio = self._tab._resizeBarWidth / totalWidth;
                    if (ratio < minRatio)
                    {
                        self._tabStripRatio = minRatio
                    }
                    else if (ratio > 1)
                    {
                        self._tabStripRatio = 1
                    }
                    else
                    {
                        self._tabStripRatio = ratio
                    }
                    if (ratio < 0)
                    {
                        self._tabStripRatioUserSet = 0
                    }
                    else if (ratio > 1)
                    {
                        self._tabStripRatioUserSet = 1
                    }
                    else
                    {
                        self._tabStripRatioUserSet = ratio
                    }
                    self._doTabHSResize()
                };
                Spread.prototype.getTabStripRatio = function()
                {
                    return this._tabStripRatioUserSet
                };
                Spread.prototype._getActualTabStripRatio = function()
                {
                    if (this.showHorizontalScrollbar())
                    {
                        return this._tabStripRatio
                    }
                    return 1
                };
                Spread.prototype._setActualTabStripRatio = function(tabStripRatio)
                {
                    this._tabStripRatio = tabStripRatio
                };
                Spread.prototype.showScrollTip = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._showScrollTip
                    }
                    else
                    {
                        this._showScrollTip = value;
                        return this
                    }
                };
                Spread.prototype.showResizeTip = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._showResizeTip
                    }
                    else
                    {
                        this._showResizeTip = value;
                        return this
                    }
                };
                Spread.prototype.showDragDropTip = function(value)
                {
                    if (arguments.length === 0)
                    {
                        if (!Sheets.util.hasCalc())
                        {
                            return false
                        }
                        return this._showDragDropTip
                    }
                    else
                    {
                        this._showDragDropTip = value;
                        return this
                    }
                };
                Spread.prototype.showDragFillTip = function(value)
                {
                    if (arguments.length === 0)
                    {
                        if (!Sheets.features.fill)
                        {
                            return false
                        }
                        return this._showDragFillTip
                    }
                    else
                    {
                        this._showDragFillTip = value;
                        return this
                    }
                };
                Spread.prototype.grayAreaBackColor = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._grayAreaBackColor
                    }
                    var self = this;
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        return sheet._bindToAutoRefresh(function(value)
                            {
                                self._grayAreaBackColor = value;
                                return self
                            })(value)
                    }
                    else
                    {
                        self._grayAreaBackColor = value
                    }
                };
                Spread.prototype.backColor = function(value)
                {
                    if (arguments.length === 0)
                    {
                        return this._backColor
                    }
                    var self = this;
                    var sheet = this.getActiveSheet();
                    if (sheet)
                    {
                        return sheet._bindToAutoRefresh(function(value)
                            {
                                self._backColor = value;
                                return self
                            })(value)
                    }
                    else
                    {
                        self._backColor = value
                    }
                };
                Spread.prototype.backgroundImage = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._backgroundImage
                    }
                    var sheet = self.getActiveSheet();
                    if (sheet)
                    {
                        return sheet._bindToAutoRefresh(function(value)
                            {
                                self._backgroundImage = value;
                                self._paintSpreadBackgroundImage();
                                return self
                            })(value)
                    }
                    else
                    {
                        self._backgroundImage = value;
                        return self
                    }
                };
                Spread.prototype.backgroundImageLayout = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._backgroundImageLayout
                    }
                    else
                    {
                        self._backgroundImageLayout = value;
                        self._paintSpreadBackgroundImage();
                        return self
                    }
                };
                Spread.prototype._findTable = function(name)
                {
                    if (!this.sheets || this.sheets.length === 0)
                    {
                        return keyword_null
                    }
                    var sheets = this.sheets,
                        count = sheets.length;
                    for (var i = 0; i < count; i++)
                    {
                        var sheet = sheets[i];
                        var table = sheet.findTableByName(name);
                        if (table)
                        {
                            return table
                        }
                    }
                    return keyword_null
                };
                Spread.prototype.addSparklineEx = function(sparklineEx)
                {
                    var sparklineExs = this._sparklineExs;
                    if (sparklineEx && sparklineExs)
                    {
                        sparklineExs[sparklineEx.name()] = sparklineEx
                    }
                };
                Spread.prototype.getSparklineEx = function(name)
                {
                    var sparklineExs = this._sparklineExs;
                    return sparklineExs && sparklineExs[name]
                };
                Spread.prototype.removeSparklineEx = function(name)
                {
                    var sparklineExs = this._sparklineExs;
                    if (sparklineExs)
                    {
                        sparklineExs[name] = keyword_undefined
                    }
                };
                Spread.prototype.useTouchLayout = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._useTouchLayout
                    }
                    self._useTouchLayout = value;
                    self._doResize();
                    return self
                };
                Spread.prototype.focus = function(focusIn)
                {
                    if (focusIn === false)
                    {
                        Sheets.FocusHelper.setActiveElement(keyword_null)
                    }
                    else
                    {
                        var sheet = this.getActiveSheet();
                        if (sheet)
                        {
                            sheet.setFocus()
                        }
                    }
                };
                Spread.prototype.hideSelection = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._hideSelection
                    }
                    self._hideSelection = value;
                    var sheet = self.getActiveSheet();
                    if (value)
                    {
                        Sheets.FocusHelper.hideSelection(sheet)
                    }
                    else
                    {
                        Sheets.FocusHelper.showSelection(sheet)
                    }
                    return self
                };
                Spread.prototype.nextControl = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._nextControl
                    }
                    self._nextControl = value;
                    return self
                };
                Spread.prototype.previousControl = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._previousControl
                    }
                    self._previousControl = value;
                    return self
                };
                Spread.prototype._getScrollbarSize = function()
                {
                    return 18
                };
                Spread.prototype.suspendCalcService = function(ignoreDirty)
                {
                    if (this.calcService)
                    {
                        this.calcService.suspend(ignoreDirty)
                    }
                };
                Spread.prototype.resumeCalcService = function(recalcAll)
                {
                    if (this.calcService)
                    {
                        this.calcService.resume(recalcAll)
                    }
                };
                Spread.prototype._trigger = function(type, data)
                {
                    if (this._eventSuspended === 0)
                    {
                        $(this._userEventsElem).trigger(type, data)
                    }
                };
                Spread.prototype.triggerSheetTabClick = function(data)
                {
                    this._trigger(Sheets.Events.SheetTabClick, data)
                };
                Spread.prototype.triggerSheetTabDoubleClick = function(data)
                {
                    this._trigger(Sheets.Events.SheetTabDoubleClick, data)
                };
                Spread.prototype.triggerActiveSheetChanging = function(data)
                {
                    this._trigger(Sheets.Events.ActiveSheetChanging, data)
                };
                Spread.prototype.triggerActiveSheetChanged = function(data)
                {
                    this._trigger(Sheets.Events.ActiveSheetChanged, data)
                };
                Spread.prototype.triggerButtonClicked = function(data)
                {
                    this._trigger(Sheets.Events.ButtonClicked, data)
                };
                return Spread
            })();
        Sheets.Spread = Spread;
        var gcTab_ns = ".gcTab",
            tabNameEditor_ns = ".tabNameEditor",
            spliter_ns = ".spliter";
        var mouse = "mouse",
            e_down = "down",
            e_move = "move",
            e_up = "up",
            e_out = "out",
            e_focusin = "focusin",
            e_focusout = "focusout",
            e_keydown = "keydown";
        var spliter_mousemove = mouse + e_move + spliter_ns,
            spliter_mouseup = mouse + e_up + spliter_ns;
        var tabNameEditor_keydown = e_keydown + tabNameEditor_ns,
            tabNameEditor_focusin = e_focusin + tabNameEditor_ns,
            tabNameEditor_focusout = e_focusout + tabNameEditor_ns;
        var gcTab_mousedown = mouse + e_down + gcTab_ns,
            gcTab_mousemove = mouse + e_move + gcTab_ns,
            gcTab_mouseup = mouse + e_up + gcTab_ns,
            gcTab_mouseout = mouse + e_out + gcTab_ns,
            gcTable_dbclick = "dblclick" + gcTab_ns;
        var tag_canvas = "canvas",
            dc_2d = "2d";
        var hit_element_resizebar = "resizeBar",
            hit_element_navbutton = "navButton",
            hit_element_tab = "tab",
            hit_element_newTab = "newTab";
        var color_FFFFFF = "#FFFFFF",
            color_D8E7FA = "#D8E7FA",
            color_D5E5F9 = "#D5E5F9",
            color_B6D2F5 = "#B6D2F5",
            color_D9E7F9 = "#D9E7F9",
            color_688CAF = "#688CAF",
            color_92A5C7 = "#92A5C7",
            color_black = "black",
            color_white = "white";
        var tabIndicatorHeight = 4;
        var tabTipClass = "tab-tip-span";
        var _GcTab = (function()
            {
                function _GcTab(name)
                {
                    this._reorderMaxDistance = 10;
                    var self = this;
                    self._spread = keyword_null;
                    self._activeIndex = 0;
                    self._firstTab = 0;
                    self._tabLeftPadding = 12;
                    self._tabRightPadding = 8;
                    self._tabSpace = 3;
                    self._activePos = 70;
                    self._hoverNavButton = -1;
                    self._hoverTab = -1;
                    self._newTabSize = 48;
                    self._firstTabSpace = 5;
                    self._font = "10pt Arial";
                    self._resizeBarWidth = 8;
                    self._tabSizes = [];
                    self._targetTabIndex = -1;
                    self._sourceTabIndex = -1;
                    self._reorderSpeedTimeout = keyword_null;
                    self._paintSuspended = false;
                    self._init(name)
                }
                _GcTab.prototype._init = function(name)
                {
                    this._bounds = new Sheets.Rect(0, 0, 200, 20);
                    this.name = name
                };
                _GcTab.prototype._setHost = function(host)
                {
                    var self = this;
                    var canvas = document.createElement(tag_canvas);
                    Sheets.DPIHelper.adjustDevicePixel(canvas, self._spread);
                    canvas.setAttribute("id", self.name);
                    self._tabIndicator = self._getTabIndicator();
                    host.appendChild(self._tabIndicator[0]);
                    host.appendChild(canvas);
                    canvas.gcObject = true;
                    if (self.canvas)
                    {
                        $(self.canvas).unbind(gcTab_mousedown).unbind(gcTab_mousemove).unbind(gcTab_mouseup).unbind(gcTab_mouseout).unbind(gcTable_dbclick);
                        self._unbindTouchEvents();
                        self.canvas.parentNode.removeChild(self.canvas)
                    }
                    self.canvas = canvas;
                    if (!Sheets.util._isStandardCanvas() && Sheets.util._isSilverlightCanvas())
                    {
                        canvas.setAttribute('renderMethod', 'auto');
                        canvas.setAttribute('onload', self._test(self))
                    }
                    $(canvas).bind(gcTab_mousedown, Sheets.util.createEventHandler(self, self.doMouseDown)).bind(gcTab_mousemove, Sheets.util.createEventHandler(self, self.doMouseMove)).bind(gcTab_mouseup, Sheets.util.createEventHandler(self, self.doMouseUp)).bind(gcTab_mouseout, Sheets.util.createEventHandler(self, self.doMouseOut)).bind(gcTable_dbclick, Sheets.util.createEventHandler(self, self.doMouseDbClick));
                    self._bindTouchEvents();
                    self.doResize()
                };
                _GcTab.prototype._unbindTouchEvents = function()
                {
                    if (this._touchManager)
                    {
                        this._touchManager.unbindTouchEvents()
                    }
                };
                _GcTab.prototype._bindTouchEvents = function()
                {
                    if (!Sheets.features.touch)
                    {
                        return
                    }
                    var self = this;
                    var touchManager = new Sheets.TabStripTouchManager(self.canvas, self, self._spread._touchEventProvider);
                    touchManager.bindTouchEvents();
                    self._touchManager = touchManager;
                    self._resizeBarWidth = 12
                };
                _GcTab.prototype._getTabIndicator = function()
                {
                    return $("<div>").css({
                            position: "absolute", "border-style": "solid", "border-color": color_black, "border-width": tabIndicatorHeight, display: "none", width: "0", "border-bottom": "0", "border-left-color": "transparent", "border-right-color": "transparent"
                        })
                };
                _GcTab.prototype._getNavigationButtonWidth = function()
                {
                    var width = 0,
                        sp = this._spread;
                    if (sp)
                    {
                        if (sp.useTouchLayout())
                        {
                            width = sp._getScrollbarSize() * 2
                        }
                        else
                        {
                            width = sp._getScrollbarSize()
                        }
                    }
                    return width
                };
                _GcTab.prototype._getNavigationButtonHeight = function()
                {
                    return this._spread ? this._spread._getScrollbarSize() : 0
                };
                _GcTab.prototype._getTabStartPosition = function()
                {
                    return this._getNavigationButtonWidth() * 4 + 2
                };
                _GcTab.prototype._test = function(tab)
                {
                    return tab._spread.initPaint(tab._spread)
                };
                _GcTab.prototype.setOwner = function(owner)
                {
                    this._spread = owner;
                    if (owner && owner._font && owner._font.length > 0)
                    {
                        this._font = owner._font
                    }
                };
                _GcTab.prototype._dispose = function()
                {
                    var canvas = this.canvas;
                    if (canvas)
                    {
                        $(canvas).unbind(gcTab_mousedown).unbind(gcTab_mousemove).unbind(gcTab_mouseup).unbind(gcTable_dbclick).unbind(gcTab_mouseout);
                        canvas.parentNode.removeChild(canvas)
                    }
                };
                _GcTab.prototype.getBounds = function()
                {
                    var bounds = this._bounds;
                    return new Sheets.Rect(bounds.x, bounds.y, bounds.width, bounds.height)
                };
                _GcTab.prototype.setBounds = function(rect)
                {
                    var bounds = this._bounds;
                    bounds.x = rect.x;
                    bounds.y = rect.y;
                    bounds.width = rect.width;
                    bounds.height = rect.height
                };
                _GcTab.prototype._clearRepeatDown = function()
                {
                    if (this._repeatDown)
                    {
                        window.clearTimeout(this._repeatDown);
                        this._repeatDown = keyword_null
                    }
                };
                _GcTab.prototype.doNavButtonClick = function(btnClicked, ignoreRepeat)
                {
                    var self = this;
                    self._clearRepeatDown();
                    var visibleTabs = self._getVisibleTabs();
                    if (visibleTabs.length <= 0)
                    {
                        return
                    }
                    var repeatClickIntevel = 200;
                    switch (btnClicked)
                    {
                        case 0:
                            self._navigateToFirst(visibleTabs);
                            break;
                        case 1:
                            if (!ignoreRepeat)
                            {
                                self._repeatDown = window.setTimeout(function()
                                {
                                    self.doNavButtonClick(1)
                                }, repeatClickIntevel)
                            }
                            self._navigateToPrevious(visibleTabs);
                            break;
                        case 2:
                            if (!ignoreRepeat)
                            {
                                self._repeatDown = window.setTimeout(function()
                                {
                                    self.doNavButtonClick(2)
                                }, repeatClickIntevel)
                            }
                            self._navigateToNext(visibleTabs);
                            break;
                        case 3:
                            self._navigateToLast(visibleTabs);
                            break;
                        default:
                            return
                    }
                };
                _GcTab.prototype._getVisibleTabs = function()
                {
                    var visibleTabs = [],
                        index;
                    for (index = 0; index < this._spread.sheets.length; index++)
                    {
                        if (this._tabVisible(index))
                        {
                            visibleTabs.push(index)
                        }
                    }
                    return visibleTabs
                };
                _GcTab.prototype._navigateToFirst = function(visibleTabs)
                {
                    if (visibleTabs.length <= 0)
                    {
                        return
                    }
                    if (this._firstTab != visibleTabs[0])
                    {
                        this._spread.startSheetIndex(visibleTabs[0])
                    }
                };
                _GcTab.prototype._navigateToPrevious = function(visibleTabs)
                {
                    if (visibleTabs.length <= 0)
                    {
                        return
                    }
                    var self = this;
                    if (self._firstTab > visibleTabs[0])
                    {
                        var preVisibleIndex = self._getPreVisibleIndex(self._firstTab);
                        if (preVisibleIndex !== -1)
                        {
                            self._spread.startSheetIndex(preVisibleIndex)
                        }
                    }
                };
                _GcTab.prototype._navigateToNext = function(visibleTabs)
                {
                    if (visibleTabs.length <= 0)
                    {
                        return
                    }
                    var self = this;
                    if (self._firstTab < visibleTabs[visibleTabs.length - 1])
                    {
                        var currTabIndex = self._reCalculateFirstTabIndex(visibleTabs);
                        if (currTabIndex !== -1)
                        {
                            self._spread.startSheetIndex(self._getNextVisibleIndex(self._firstTab))
                        }
                    }
                };
                _GcTab.prototype._navigateToLast = function(visibleTabs)
                {
                    if (visibleTabs.length <= 0)
                    {
                        return
                    }
                    if (this._firstTab < visibleTabs[visibleTabs.length - 1])
                    {
                        var currTabIndex = this._reCalculateFirstTabIndex(visibleTabs);
                        if (currTabIndex !== -1)
                        {
                            this._spread.startSheetIndex(currTabIndex)
                        }
                    }
                };
                _GcTab.prototype._reCalculateFirstTabIndex = function(visibleTabs)
                {
                    if (visibleTabs.length <= 0)
                    {
                        return -1
                    }
                    var self = this;
                    var availableWidth = self._bounds.width - self._resizeBarWidth;
                    var tabSumWidth = 0;
                    var tabsWidth = self._tabSizes,
                        i,
                        index;
                    var tabOverlapWidth = self._bounds.height;
                    var basisWidth = self._getTabStartPosition() + tabOverlapWidth;
                    if (self._spread._newTabVisible)
                    {
                        basisWidth += self._newTabSize;
                        basisWidth += self._tabSpace
                    }
                    var startIndex = self._getVisibleTabIndex(self._firstTab, visibleTabs);
                    if (startIndex === -1)
                    {
                        startIndex = 0
                    }
                    for (i = visibleTabs.length - 1; i >= startIndex; i--)
                    {
                        index = visibleTabs[i];
                        var itemWidth = tabsWidth[index];
                        tabSumWidth += itemWidth;
                        if (i !== visibleTabs.length - 1)
                        {
                            tabSumWidth += self._tabSpace
                        }
                        var totalWidth = basisWidth + tabSumWidth;
                        if (i !== 0)
                        {
                            totalWidth += self._firstTabSpace
                        }
                        if (totalWidth > availableWidth)
                        {
                            var currIndex;
                            if (i + 1 < visibleTabs.length)
                            {
                                currIndex = visibleTabs[i + 1]
                            }
                            else
                            {
                                currIndex = visibleTabs[visibleTabs.length - 1]
                            }
                            if (self._firstTab < currIndex)
                            {
                                return currIndex
                            }
                            else
                            {
                                return -1
                            }
                        }
                    }
                    return -1
                };
                _GcTab.prototype._getPreVisibleIndex = function(tabIndex)
                {
                    var tabCount = this._spread.sheets.length;
                    var index;
                    for (index = tabIndex - 1; index >= 0; index--)
                    {
                        if (this._tabVisible(index))
                        {
                            return index
                        }
                    }
                    return -1
                };
                _GcTab.prototype._getNextVisibleIndex = function(tabIndex)
                {
                    var tabCount = this._spread.sheets.length;
                    var index;
                    for (index = tabIndex + 1; index < tabCount; index++)
                    {
                        if (this._tabVisible(index))
                        {
                            return index
                        }
                    }
                    return -1
                };
                _GcTab.prototype._getVisibleTabIndex = function(tabIndex, visibleTabs)
                {
                    var index;
                    for (index = 0; index <= visibleTabs.length - 1; index++)
                    {
                        if (tabIndex === visibleTabs[index])
                        {
                            return index
                        }
                    }
                    return -1
                };
                _GcTab.prototype._tabVisible = function(tabIndex)
                {
                    return this._spread.sheets[tabIndex].visible()
                };
                _GcTab.prototype._hitTest = function(left, top)
                {
                    var self = this;
                    var rect = self.getBounds();
                    if (rect.x + rect.width - self._resizeBarWidth < left && left < rect.x + rect.width)
                    {
                        if (self._spread.showHorizontalScrollbar())
                        {
                            return {element: hit_element_resizebar}
                        }
                    }
                    var navButton = -1;
                    var x = 0,
                        i,
                        navigationButtonWidth = self._getNavigationButtonWidth();
                    for (i = 0; i < 4; i++)
                    {
                        if (x <= left && left < x + navigationButtonWidth)
                        {
                            navButton = i;
                            break
                        }
                        x += navigationButtonWidth
                    }
                    if (navButton !== -1)
                    {
                        return {
                                element: hit_element_navbutton, index: i
                            }
                    }
                    x = self._getTabStartPosition();
                    var preTabIndex = self._getPreVisibleIndex(self._firstTab);
                    if (preTabIndex !== -1)
                    {
                        if (x < left && left < x + self._firstTabSpace + self._tabSpace)
                        {
                            return {
                                    element: hit_element_tab, index: preTabIndex, position: x
                                }
                        }
                        x += self._firstTabSpace
                    }
                    var tabSize = 0;
                    if (self._firstTab > -1)
                    {
                        for (i = self._firstTab; i < self._spread.sheets.length && i < self._tabSizes.length; i++)
                        {
                            if (self._spread.sheets[i].visible())
                            {
                                tabSize = self._tabSizes[i];
                                if (x < left && left < x + tabSize + self._tabSpace)
                                {
                                    return {
                                            element: hit_element_tab, index: i, position: x
                                        }
                                }
                                x += (tabSize + self._tabSpace)
                            }
                        }
                    }
                    if (self._spread._newTabVisible)
                    {
                        if (left > x && left < x + self._newTabSize)
                        {
                            return {
                                    element: hit_element_newTab, position: x
                                }
                        }
                    }
                    return {element: ""}
                };
                _GcTab.prototype.doSheetTabClick = function(index, position)
                {
                    var self = this;
                    var E = Sheets.Events;
                    self._activeIndex = index;
                    self._activePos = position;
                    var oldStatus = self._spread.isPaintSuspended();
                    self._spread.isPaintSuspended(true);
                    var activeSheet = self._spread.getActiveSheet();
                    var sheet = self._spread.getSheet(index);
                    if (sheet && sheet.isEditing() && sheet !== activeSheet)
                    {
                        sheet.endEdit()
                    }
                    self._spread.triggerSheetTabClick({
                        sheet: sheet, sheetName: sheet._name, sheetTabIndex: index
                    });
                    self._doSheetTabClickChange(index);
                    self._spread.isPaintSuspended(oldStatus);
                    self.repaint()
                };
                _GcTab.prototype._doSheetTabClickChange = function(index, saveValue)
                {
                    if (typeof saveValue === "undefined")
                    {
                        saveValue = true
                    }
                    var self = this;
                    var E = Sheets.Events;
                    var sheet = self._spread.getSheet(index);
                    var activeSheet = self._spread.getActiveSheet();
                    if (index !== self._spread._activeSheetIndex)
                    {
                        var args = {
                                oldSheet: activeSheet, newSheet: sheet, cancel: false
                            };
                        self._spread.triggerActiveSheetChanging(args);
                        if (args && args.cancel === false)
                        {
                            self._spread._setActiveSheetIndexImp(index, 1);
                            this._spread.triggerActiveSheetChanged({
                                oldSheet: activeSheet, newSheet: sheet
                            });
                            var nextIndex = self._getNextVisibleIndex(self._firstTab);
                            if (self._activeIndex > self._firstTab && self._activePos + self._tabSizes[self._activeIndex] > self.getBounds().width - self._resizeBarWidth && nextIndex != -1)
                            {
                                self._firstTab = nextIndex
                            }
                        }
                    }
                    if (self._activeIndex < self._firstTab)
                    {
                        self._firstTab = self._getPreVisibleIndex(self._firstTab)
                    }
                };
                _GcTab.prototype.doNewTabClick = function(position)
                {
                    var self = this;
                    var E = Sheets.Events;
                    var spreadTmp = self._spread;
                    var activeSheet = spreadTmp.getActiveSheet();
                    if (activeSheet && activeSheet._formulaTextBox)
                    {
                        if (activeSheet._formulaTextBox.canAppendRange())
                        {
                            return
                        }
                    }
                    spreadTmp.triggerSheetTabClick({
                        sheet: keyword_null, sheetName: keyword_null, sheetTabIndex: -1
                    });
                    var index = spreadTmp.sheets.length;
                    var sheet = spreadTmp._createSheet(spreadTmp._getDefaultSheetName(index));
                    spreadTmp._addSheetImp(index, 1, sheet);
                    self._activeIndex = index;
                    self._activePos = position;
                    var args = {
                            oldSheet: activeSheet, newSheet: sheet, cancel: false
                        };
                    spreadTmp.triggerActiveSheetChanging(args);
                    if (args && args.cancel === false)
                    {
                        spreadTmp._setActiveSheetIndexImp(index, 1);
                        spreadTmp.triggerActiveSheetChanged({
                            oldSheet: activeSheet, newSheet: sheet
                        });
                        while (self._activeIndex > self._firstTab && self._activePos + self._tabSizes[self._activeIndex] + self._newTabSize > self.getBounds().width - self._resizeBarWidth)
                        {
                            if (spreadTmp.sheets[self._firstTab].visible())
                            {
                                self._activePos -= self._tabSizes[self._firstTab]
                            }
                            self._firstTab++
                        }
                        self.repaint()
                    }
                };
                _GcTab.prototype.doMouseDown = function(e)
                {
                    var device = Sheets.util.device();
                    var needIgnoreMouseEvent = device.ipad || device.iphone;
                    if (needIgnoreMouseEvent)
                    {
                        return
                    }
                    var self = this;
                    if (self._touchManager && self._touchManager.preProcessMouseDown(e))
                    {
                        Sheets.util.cancelDefault(e);
                        return false
                    }
                    var t = $(self._getCanvas()).offset();
                    var left = e.pageX - t.left;
                    var top = e.pageY - t.top;
                    var activeSheet = self._spread.getActiveSheet();
                    var args;
                    if (self._tabNameEditor)
                    {
                        self.endSheetTabEditing(activeSheet, false)
                    }
                    var hitTestInfo = self._hitTest(left, top);
                    var E = Sheets.Events;
                    if (e.button === 0)
                    {
                        if (hitTestInfo.element === hit_element_resizebar)
                        {
                            self.resizeTab = true;
                            self.activeX = e.pageX;
                            self.handleDocumentMouseMove()
                        }
                        else if (hitTestInfo.element === hit_element_navbutton)
                        {
                            self.doNavButtonClick(hitTestInfo.index)
                        }
                        else if (hitTestInfo.element === hit_element_tab)
                        {
                            self.doSheetTabClick(hitTestInfo.index, hitTestInfo.position);
                            self._initTabReorder(e, hitTestInfo)
                        }
                        else if (hitTestInfo.element === hit_element_newTab)
                        {
                            self.doNewTabClick(hitTestInfo.position)
                        }
                        activeSheet = self._spread.getActiveSheet();
                        var eventHandler = activeSheet && activeSheet._eventHandler;
                        if (eventHandler && !activeSheet.isEditing())
                        {
                            try
                            {
                                eventHandler._tabStripHitTestResult = {
                                    left: e.pageX, top: e.pageY
                                };
                                activeSheet.setFocus()
                            }
                            finally
                            {
                                eventHandler._tabStripHitTestResult = keyword_null
                            }
                        }
                    }
                    self._isMouseDownInTab = true;
                    return false
                };
                _GcTab.prototype._initTabReorder = function(e, hitTestInfo)
                {
                    var self = this,
                        owner = self._spread,
                        activeSheet = owner && owner.getActiveSheet(),
                        formulaTextBox = activeSheet && activeSheet._formulaTextBox,
                        formulatextboxAcrossSheetInstance = Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance,
                        formulaAcrossSheetInputing = Sheets.features.formulatextbox && formulatextboxAcrossSheetInstance && formulatextboxAcrossSheetInstance.text;
                    if (this._spread._allowSheetReorder && !formulaAcrossSheetInputing && !formulaTextBox)
                    {
                        self._sourceTabIndex = hitTestInfo.index;
                        self._tabTip = self._getTabTip(self._sourceTabIndex);
                        self._tabStartPos = new Sheets.Point(e.pageX, e.pageY);
                        self.handleDocumentMouseMove()
                    }
                    else
                    {
                        self._reorderSheet = false
                    }
                };
                _GcTab.prototype._getTabTip = function(index)
                {
                    var sheets = this._spread.sheets;
                    var len = sheets.length;
                    if (index >= len || index < 0)
                    {
                        return
                    }
                    var name = sheets[index]._name;
                    if (!name)
                    {
                        name = "sheet"
                    }
                    var tip = $("<span>").text(name).css({
                            position: "absolute", cursor: "default", "border-radius": "5px", opacity: ".7"
                        });
                    tip.addClass("ui-widget-header tab-tip-span btn-primary");
                    return tip
                };
                _GcTab.prototype.doMouseMove = function(e)
                {
                    var device = Sheets.util.device();
                    var needIgnoreMouseEvent = device.ipad || device.iphone;
                    if (needIgnoreMouseEvent)
                    {
                        return
                    }
                    var self = this;
                    if (self._touchManager && self._touchManager.preProcessMouseMove(e))
                    {
                        Sheets.util.cancelDefault(e);
                        return false
                    }
                    var cursor_default = "default",
                        cursor_wresize = "w-resize";
                    if (self._tabStartPos && !self._reorderSheet)
                    {
                        var mousemoveDistance = Math_sqrt(Math_pow(self._tabStartPos.x - e.pageX, 2) + Math_pow(self._tabStartPos.y - e.pageY, 2));
                        if (mousemoveDistance > self._reorderMaxDistance)
                        {
                            self._reorderSheet = true
                        }
                    }
                    if (self.resizeTab)
                    {
                        self.canvas.style.cursor = cursor_wresize;
                        var d = e.pageX - self.activeX;
                        var totalWidth = self._spread._vp.clientWidth;
                        var ss = self._spread;
                        ss.setTabStripRatio(ss._getActualTabStripRatio() + d / totalWidth, true);
                        var minRatio = self._resizeBarWidth / totalWidth;
                        var maxRatio = 1;
                        if (ss._getActualTabStripRatio() < minRatio)
                        {
                            ss.setTabStripRatio(minRatio, true);
                            self.activeX = self._resizeBarWidth
                        }
                        else if (ss._getActualTabStripRatio() >= maxRatio)
                        {
                            ss.setTabStripRatio(maxRatio, true);
                            self.activeX = totalWidth
                        }
                        else
                        {
                            self.activeX = e.pageX
                        }
                    }
                    else if (self._reorderSheet)
                    {
                        self._showTabTip(e.pageX, e.pageY);
                        self._setTabIndicator(e)
                    }
                    else
                    {
                        self._hoverNavButton = -1;
                        self._hoverTab = -1;
                        var t = $(self._getCanvas()).offset();
                        var left = e.pageX - t.left;
                        var top = e.pageY - t.top;
                        var hitTestInfo = self._hitTest(left, top);
                        if (hitTestInfo.element === "")
                        {
                            self.canvas.style.cursor = cursor_default;
                            self.repaint();
                            return false
                        }
                        else if (hitTestInfo.element === hit_element_resizebar)
                        {
                            self.canvas.style.cursor = cursor_wresize
                        }
                        else
                        {
                            self.canvas.style.cursor = cursor_default;
                            if (hitTestInfo.element === hit_element_navbutton)
                            {
                                self._hoverNavButton = hitTestInfo.index
                            }
                            else if (hitTestInfo.element === hit_element_tab)
                            {
                                self._hoverTab = hitTestInfo.index
                            }
                            else if (hitTestInfo.element === hit_element_newTab)
                            {
                                self._hoverTab = -2
                            }
                        }
                        self.repaint()
                    }
                    return false
                };
                _GcTab.prototype._showTabTip = function(x, y)
                {
                    var self = this;
                    if (self._tabTip && $("." + tabTipClass).length === 0)
                    {
                        self._tabTip.appendTo(document.body);
                        self._tabTip.hide()
                    }
                    var tipWidth = self._tabTip.width();
                    var tipHeight = self._tabTip.height();
                    self._tabTip.css({
                        left: x - tipWidth / 2, top: y - tipHeight / 2
                    });
                    self._tabTip.show()
                };
                _GcTab.prototype._setTabIndicator = function(e)
                {
                    var self = this;
                    var $canvas = $(self._getCanvas());
                    var t = $canvas.position();
                    var offset = $canvas.offset();
                    var left = e.pageX - offset.left;
                    var top = e.pageY - offset.top;
                    var hitTestInfo = self._hitTest(left, top);
                    var rect = self.getBounds();
                    var tabStartPosition = self._getTabStartPosition();
                    var sheetLength = self._spread.sheets.length;
                    var timeInterval = 100;
                    if (left > rect.x + rect.width - self._resizeBarWidth)
                    {
                        if (self._reorderSpeedTimeout === keyword_null && self._targetTabIndex < sheetLength)
                        {
                            self._reorderSpeedTimeout = setInterval(function()
                            {
                                self._navigateToNext(self._getVisibleTabs());
                                if (self._targetTabIndex === sheetLength)
                                {
                                    self._clearSpeedTimeout();
                                    self._tabIndicator.css({
                                        left: t.left + self._getLastTabPos() - tabIndicatorHeight, top: t.top - tabIndicatorHeight
                                    });
                                    self._tabIndicator.show()
                                }
                                else
                                {
                                    self._targetTabIndex++;
                                    self._tabIndicator.hide()
                                }
                            }, timeInterval)
                        }
                    }
                    else if (left < tabStartPosition)
                    {
                        if (self._reorderSpeedTimeout === keyword_null && self._targetTabIndex > 0)
                        {
                            self._reorderSpeedTimeout = setInterval(function()
                            {
                                self._navigateToPrevious(self._getVisibleTabs());
                                if (self._targetTabIndex === 0)
                                {
                                    self._clearSpeedTimeout();
                                    self._tabIndicator.css({
                                        left: t.left + tabStartPosition - tabIndicatorHeight, top: t.top - tabIndicatorHeight
                                    });
                                    self._tabIndicator.show()
                                }
                                else
                                {
                                    self._targetTabIndex--;
                                    self._tabIndicator.hide()
                                }
                            }, timeInterval)
                        }
                    }
                    else
                    {
                        self._clearSpeedTimeout();
                        if (hitTestInfo.element === hit_element_tab || hitTestInfo.element === hit_element_newTab)
                        {
                            if (typeof hitTestInfo.index !== const_undefined)
                            {
                                self._targetTabIndex = hitTestInfo.index
                            }
                            else
                            {
                                self._targetTabIndex = self._spread.sheets.length
                            }
                            self._tabIndicator.css({
                                left: t.left + hitTestInfo.position - tabIndicatorHeight, top: t.top - tabIndicatorHeight
                            });
                            self._tabIndicator.show()
                        }
                    }
                };
                _GcTab.prototype._getLastTabPos = function()
                {
                    var self = this;
                    var tabsWidth = self._tabSizes;
                    var visibleTabs = self._getVisibleTabs();
                    var startIndex = self._getVisibleTabIndex(self._firstTab, visibleTabs);
                    var index = 0;
                    var tabOverlapWidth = self._bounds.height;
                    var tabSumWidth = self._getTabStartPosition() + self._firstTabSpace;
                    for (var i = startIndex; i < visibleTabs.length; i++)
                    {
                        index = visibleTabs[i];
                        var itemWidth = tabsWidth[index];
                        tabSumWidth += itemWidth;
                        tabSumWidth += self._tabSpace
                    }
                    return tabSumWidth
                };
                _GcTab.prototype.doMouseUp = function(e)
                {
                    var device = Sheets.util.device();
                    var needIgnoreMouseEvent = device.ipad || device.iphone;
                    if (needIgnoreMouseEvent)
                    {
                        return
                    }
                    var self = this;
                    if (self._touchManager && self._touchManager.preProcessMouseUp(e))
                    {
                        Sheets.util.cancelDefault(e);
                        return false
                    }
                    if (self.resizeTab)
                    {
                        self.resizeTab = false;
                        self._spread._doTabHSResize()
                    }
                    self._clearSpeedTimeout();
                    if (self._reorderSheet)
                    {
                        self._reorderSheet = false;
                        self._tabTip.remove();
                        self._reorderTab();
                        self._tabIndicator.hide()
                    }
                    self._tabStartPos = null;
                    self._clearRepeatDown();
                    self.unhandleDocumentMouseMove();
                    if (!self._isMouseDownInTab)
                    {
                        return true
                    }
                    else
                    {
                        self._isMouseDownInTab = false;
                        return false
                    }
                };
                _GcTab.prototype._reorderTab = function()
                {
                    var self = this;
                    var tarIndex = self._targetTabIndex;
                    var sourIndex = self._sourceTabIndex;
                    var activeSheetIndex = -1;
                    if (tarIndex !== -1 && sourIndex !== -1 && sourIndex !== tarIndex && sourIndex !== tarIndex - 1 && self._tabIndicator.is(":visible"))
                    {
                        var sheets = self._spread.sheets;
                        var sourceSheet = sheets[sourIndex];
                        if (sourIndex > tarIndex)
                        {
                            for (var i = sourIndex; i > tarIndex; i--)
                            {
                                sheets[i] = sheets[i - 1]
                            }
                            sheets[tarIndex] = sourceSheet;
                            activeSheetIndex = tarIndex
                        }
                        else if (sourIndex < tarIndex - 1)
                        {
                            for (var i = sourIndex; i < tarIndex - 1; i++)
                            {
                                sheets[i] = sheets[i + 1]
                            }
                            sheets[tarIndex - 1] = sourceSheet;
                            activeSheetIndex = tarIndex - 1
                        }
                        self._spread._activeSheetIndex = activeSheetIndex;
                        self.doResize()
                    }
                };
                _GcTab.prototype._clearSpeedTimeout = function()
                {
                    if (this._reorderSpeedTimeout !== keyword_null)
                    {
                        window.clearInterval(this._reorderSpeedTimeout);
                        this._reorderSpeedTimeout = keyword_null
                    }
                };
                _GcTab.prototype.doMouseOut = function(e)
                {
                    var device = Sheets.util.device();
                    var needIgnoreMouseEvent = device.ipad || device.iphone;
                    if (needIgnoreMouseEvent)
                    {
                        return
                    }
                    var self = this;
                    self._clearRepeatDown();
                    var oldNav = self._hoverNavButton;
                    self._hoverNavButton = -1;
                    var oldTab = self._hoverTab;
                    self._hoverTab = -1;
                    if (self._hoverNavButton !== oldNav || self._hoverTab !== oldTab)
                    {
                        self.repaint()
                    }
                    return false
                };
                _GcTab.prototype._doMouseDbClickImp = function(left, top)
                {
                    var self = this;
                    var hitTestInfo = self._hitTest(left, top);
                    if (hitTestInfo.element === hit_element_tab)
                    {
                        var tabIndex = self._activeIndex;
                        var currentSheet = self._spread.sheets[tabIndex];
                        self._spread.triggerSheetTabDoubleClick({
                            sheet: currentSheet, sheetName: currentSheet._name, sheetTabIndex: tabIndex
                        });
                        if (!self._spread._tabEditable)
                        {
                            return false
                        }
                        var element = Sheets.FocusHelper.getActiveElement();
                        if (element && element.endEdit)
                        {
                            element.endEdit()
                        }
                        Sheets.FocusHelper.setActiveElement(keyword_null);
                        var currentTabSize = self._tabSizes[tabIndex];
                        var canvasOffset = $(self._getCanvas()).offset();
                        var t = document.createElement(tag_input),
                            tStyle = t.style;
                        t.type = "text";
                        t.value = currentSheet._name;
                        t.setAttribute("contentEditable", "true");
                        t.setAttribute("autocomplete", "off");
                        tStyle.position = "absolute";
                        tStyle.margin = zero;
                        tStyle.padding = zero;
                        tStyle.margin = zero;
                        tStyle.left = canvasOffset.left + self._activePos + self._tabLeftPadding + pixel;
                        tStyle.top = canvasOffset.top + 1 + pixel;
                        tStyle.width = currentTabSize - self._tabLeftPadding - self._tabRightPadding + 2 + pixel;
                        tStyle.backgroundColor = color_white;
                        tStyle.borderWidth = "0px";
                        tStyle.outline = cssNone;
                        document.body.insertBefore(t, keyword_null);
                        self._tabNameEditor = t;
                        $(t).addClass("sheetTabEditor").bind(tabNameEditor_keydown, function(e)
                        {
                            if (e.keyCode === 13)
                            {
                                self.endSheetTabEditing(currentSheet, false);
                                return false
                            }
                            else if (e.keyCode === 27)
                            {
                                self.endSheetTabEditing(currentSheet, true);
                                return false
                            }
                        }).bind(tabNameEditor_focusin, function(e)
                        {
                            t.selectionStart = 0;
                            t.selectionEnd = t.value.length
                        }).bind(tabNameEditor_focusout, function(e)
                        {
                            self.endSheetTabEditing(currentSheet, false)
                        });
                        t.focus()
                    }
                    return false
                };
                _GcTab.prototype.doMouseDbClick = function(e)
                {
                    var device = Sheets.util.device();
                    var needIgnoreMouseEvent = device.ipad || device.iphone;
                    if (needIgnoreMouseEvent)
                    {
                        return
                    }
                    var sheet = this._spread.getActiveSheet();
                    needIgnoreMouseEvent = sheet._formulaTextBox && sheet._formulaTextBox.canAppendRange();
                    var ftbAcrossSheet = Sheets.IFormulatextboxAcrossSheetSingleton.formulatextboxAcrossSheetInstance;
                    if (needIgnoreMouseEvent)
                    {
                        return
                    }
                    else if (ftbAcrossSheet && ftbAcrossSheet.dom)
                    {
                        ftbAcrossSheet.clear()
                    }
                    var offset = $(this._getCanvas()).offset();
                    var left = e.pageX - offset.left;
                    var top = e.pageY - offset.top;
                    return this._doMouseDbClickImp(left, top)
                };
                _GcTab.prototype._isValidSheetName = function(sheetName)
                {
                    if (sheetName === keyword_undefined || sheetName === keyword_null || sheetName === "")
                    {
                        return false
                    }
                    var length = this._spread.sheets.length;
                    for (var i = 0; i < length; i++)
                    {
                        var sheet = this._spread.sheets[i];
                        if (sheetName === sheet._name)
                        {
                            return false
                        }
                    }
                    return true
                };
                _GcTab.prototype.endSheetTabEditing = function(sheet, cancel)
                {
                    var self = this;
                    if (self._tabNameEditor)
                    {
                        var newName = self._tabNameEditor.value;
                        if (cancel === false && newName !== keyword_undefined && newName !== keyword_null && newName !== "" && self._isValidSheetName(newName))
                        {
                            var oldName = sheet.getName();
                            var args = {
                                    sheet: sheet, oldValue: oldName, newValue: newName, cancel: false
                                };
                            sheet.triggerSheetNameChanging(args);
                            if (args && args.cancel === false)
                            {
                                var action = new Sheets.UndoRedo.SheetRenameUndoAction(sheet, newName);
                                sheet._doCommand(action);
                                var argsEdited = {
                                        sheet: sheet, oldValue: oldName, newValue: newName
                                    };
                                sheet.triggerSheetNameChanged(argsEdited)
                            }
                        }
                        $(self._tabNameEditor).unbind(tabNameEditor_keydown).unbind(tabNameEditor_focusin).unbind(tabNameEditor_focusout);
                        self._tabNameEditor.parentNode.removeChild(self._tabNameEditor);
                        delete self._tabNameEditor
                    }
                };
                _GcTab.prototype.handleDocumentMouseMove = function()
                {
                    var self = this;
                    if (!self._isCapture)
                    {
                        $(document).bind(spliter_mousemove, function(e)
                        {
                            self.doMouseMove(e)
                        }).bind(spliter_mouseup, function(e)
                        {
                            self.doMouseUp(e)
                        });
                        var sheet = self._spread.getActiveSheet();
                        if (sheet)
                        {
                            sheet._continueMouseUpBubble = true
                        }
                        self._isCapture = true
                    }
                };
                _GcTab.prototype.unhandleDocumentMouseMove = function()
                {
                    if (this._isCapture)
                    {
                        this._isCapture = false;
                        $(document).unbind(spliter_mousemove).unbind(spliter_mouseup);
                        var sheet = this._spread.getActiveSheet();
                        if (sheet)
                        {
                            delete sheet._continueMouseUpBubble
                        }
                    }
                };
                _GcTab.prototype.isPaintSuspended = function(value)
                {
                    var self = this;
                    if (arguments.length === 0)
                    {
                        return self._paintSuspended
                    }
                    else
                    {
                        if (self._paintSuspended !== value)
                        {
                            self._paintSuspended = value;
                            if (!value)
                            {
                                self.repaint()
                            }
                        }
                        return self
                    }
                };
                _GcTab.prototype.repaint = function(clipRect)
                {
                    var c = this._getCanvas();
                    if (c)
                    {
                        if (!c.getContext && Sheets.util._isSilverlightCanvas())
                        {
                            if (!c.getContext)
                            {
                                return
                            }
                        }
                        if (!c.getContext && typeof window.FlashCanvas !== const_undefined)
                        {
                            window.FlashCanvas.initElement(c)
                        }
                        if (c.getContext)
                        {
                            this.paint(c.getContext(dc_2d), clipRect)
                        }
                    }
                };
                _GcTab.prototype.doResize = function()
                {
                    var self = this;
                    var canvas = self._getCanvas();
                    if (!canvas || !canvas.parentNode)
                    {
                        return
                    }
                    var $parent = $(canvas.parentNode);
                    if ($parent.width() === 0 || $parent.height() === 0)
                    {
                        return
                    }
                    var width = Math_max($parent.width(), 0),
                        height = Math_max($parent.height(), 0);
                    canvas.style.display = cssNone;
                    canvas.width = width;
                    canvas.height = height;
                    canvas.style.display = "";
                    canvas.style.width = width + "px";
                    canvas.style.height = height + "px";
                    width = canvas.clientWidth || canvas.width;
                    height = canvas.clientHeight || canvas.height;
                    self._bounds.width = width;
                    self._bounds.height = height;
                    Sheets.DPIHelper.setSize(canvas, width, height);
                    self.repaint()
                };
                _GcTab.prototype.paint = function(ctx, clipRect)
                {
                    var self = this;
                    if (self._paintSuspended)
                    {
                        return
                    }
                    var rect = self.getBounds(),
                        canvas = self.canvas;
                    if (clipRect)
                    {
                        if (clipRect.x >= rect.x + rect.width)
                        {
                            return
                        }
                        if (clipRect.y >= rect.y + rect.height)
                        {
                            return
                        }
                        if (clipRect.x + clipRect.width > rect.width)
                        {
                            clipRect.width = rect.width - clipRect.x;
                            if (clipRect.width <= 0)
                            {
                                return
                            }
                        }
                        if (clipRect.y + clipRect.height > rect.height)
                        {
                            clipRect.height = rect.height - clipRect.y;
                            if (clipRect.height <= 0)
                            {
                                return
                            }
                        }
                        if (clipRect.width <= 0 || clipRect.height <= 0)
                        {
                            return
                        }
                    }
                    var bufferCtx,
                        useDoubleBuffer = Sheets.util._useDoubleBuffer();
                    if (useDoubleBuffer)
                    {
                        var buffer = self.buffer;
                        if (!buffer || buffer && (buffer.width !== canvas.width || buffer.height !== canvas.height) || !buffer && (buffer.width !== rect.width || buffer.height !== rect.height))
                        {
                            if (buffer)
                            {
                                Sheets.DPIHelper.disposeCanvasForSpread(self._spread, buffer)
                            }
                            self.buffer = buffer = document.createElement(tag_canvas);
                            Sheets.DPIHelper.adjustDevicePixel(buffer, self._spread);
                            Sheets.DPIHelper.setSize(buffer, rect.width, rect.height)
                        }
                        if (!buffer.getContext)
                        {
                            if (Sheets.util._isSilverlightCanvas())
                            {
                                if (!buffer.getContext)
                                {
                                    return
                                }
                            }
                            else if (typeof window.FlashCanvas !== const_undefined)
                            {
                                var c = self._getCanvas();
                                window.FlashCanvas.initElement(c);
                                if (!buffer.getContext)
                                {
                                    return
                                }
                            }
                        }
                    }
                    if (rect.width <= 0 || rect.height <= 0 || clipRect && (clipRect.width <= 0 || clipRect.height <= 0))
                    {
                        return
                    }
                    bufferCtx = useDoubleBuffer ? self.buffer.getContext(dc_2d) : ctx;
                    bufferCtx.clearRect(0, 0, rect.width, rect.height);
                    bufferCtx.translate(-rect.x, -rect.y);
                    self.paintTabs(bufferCtx, clipRect);
                    bufferCtx.translate(rect.x, rect.y);
                    if (useDoubleBuffer)
                    {
                        var targX = (rect.x >= 0) ? 0 : -rect.x;
                        var targY = (rect.y >= 0) ? 0 : -rect.y;
                        var srcX = targX,
                            srcY = targY;
                        var width,
                            height;
                        if (clipRect)
                        {
                            srcX = rect.x + clipRect.x;
                            srcY = rect.y + clipRect.y;
                            rect = new Sheets.Rect(srcX, srcY, clipRect.width, clipRect.height)
                        }
                        targX = (rect.x >= 0) ? rect.x : 0;
                        targY = (rect.y >= 0) ? rect.y : 0;
                        var imgData = keyword_null;
                        var ratioX = Sheets.DPIHelper.getScaleX(canvas),
                            ratioY = Sheets.DPIHelper.getScaleY(canvas);
                        if (canvas)
                        {
                            if (ratioX !== 1)
                            {
                                srcX *= ratioX;
                                srcY *= ratioY;
                                rect.x *= ratioX;
                                rect.y *= ratioY;
                                rect.width *= ratioX;
                                rect.height *= ratioY
                            }
                        }
                        try
                        {
                            if (canvas)
                            {
                                if (!clipRect)
                                {
                                    width = Math_min(rect.width - srcX, Math_max(canvas.width - rect.x, 3));
                                    height = Math_min(rect.height - srcY, Math_max(canvas.height - rect.y, 3))
                                }
                                else
                                {
                                    width = Math_max(rect.width - srcX, 0);
                                    height = Math_max(rect.height - srcY, 0)
                                }
                            }
                            else
                            {
                                srcX = clipRect.x;
                                srcY = clipRect.y;
                                width = clipRect.width;
                                height = clipRect.height
                            }
                            if (canvas)
                            {
                                ctx.scale(1 / ratioX, 1 / ratioY);
                                ctx.drawImage(self.buffer, srcX, srcY, width, height, targX, targY, width, height);
                                ctx.scale(ratioX, ratioY)
                            }
                            else
                            {
                                bufferCtx = self.buffer.getContext(dc_2d);
                                imgData = bufferCtx.getImageData(srcX, srcY, width, height)
                            }
                        }
                        catch(ex)
                        {
                            return
                        }
                        if (!canvas && imgData && rect.width > 0 && rect.height > 0)
                        {
                            ctx.putImageData(imgData, targX, targY)
                        }
                    }
                };
                _GcTab.prototype._getCanvas = function()
                {
                    var c = this.canvas;
                    if (c && !c.getContext && c.firstChild)
                    {
                        c.getContext = c.firstChild.getContext
                    }
                    return c
                };
                _GcTab.prototype._getTabStripBackColor = function(ctx, rect)
                {
                    var gradFill = ctx.createLinearGradient(rect.x, rect.y, rect.width, rect.height);
                    var headerStyle = window.gcGlobal.getExternalThemeStyle(0, "gc-tabStripBackColor"),
                        backgroundImg = headerStyle && headerStyle.backgroundImage,
                        backgroundColor = headerStyle && headerStyle.backgroundColor;
                    if (backgroundImg && backgroundImg.indexOf("linear-gradient") !== -1)
                    {
                        var colors = Sheets.util.getLinearGradientColors(backgroundImg);
                        for (var i = 0, len = colors.length; i < len; i++)
                        {
                            var color = colors[i];
                            gradFill.addColorStop(color.point, color.color)
                        }
                    }
                    else if (backgroundColor)
                    {
                        gradFill.addColorStop(0, "#DDDDDD");
                        gradFill.addColorStop(1, backgroundColor)
                    }
                    return gradFill
                };
                _GcTab.prototype.paintTabs = function(ctx, clipRect)
                {
                    var self = this,
                        sp = self._spread;
                    if (!ctx || !sp)
                    {
                        return
                    }
                    var rect = self.getBounds();
                    ctx.save();
                    ctx.font = self._font;
                    if (clipRect)
                    {
                        ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height)
                    }
                    else
                    {
                        ctx.rect(rect.x, rect.y, rect.width, rect.height)
                    }
                    ctx.clip();
                    ctx.beginPath();
                    ctx.fillStyle = self._getTabStripBackColor(ctx, rect);
                    ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
                    var tabSize = 60,
                        tabStartPosition = self._getTabStartPosition(),
                        pos = tabStartPosition;
                    self._tabSizes = [];
                    var i,
                        sheets = sp.sheets;
                    for (i = 0; i < sheets.length; i++)
                    {
                        tabSize = ctx.measureText(sheets[i]._name).width + self._tabRightPadding + self._tabLeftPadding;
                        self._tabSizes.push(tabSize)
                    }
                    var tabs = [],
                        firstTab = self._firstTab;
                    if (firstTab > 0 && self._getPreVisibleIndex(firstTab) >= 0)
                    {
                        pos += self._firstTabSpace
                    }
                    if (firstTab >= 0)
                    {
                        for (i = firstTab; i < sheets.length; i++)
                        {
                            var visible = sheets[i].visible();
                            tabSize = self._tabSizes[i];
                            if (pos > rect.x + rect.width)
                            {
                                break
                            }
                            tabs.push({
                                i: i, x: pos, w: tabSize, t: sheets[i]._name, visible: visible
                            });
                            if (visible)
                            {
                                pos += (tabSize + self._tabSpace)
                            }
                        }
                    }
                    var hoverTab = self._hoverTab;
                    if (sp._newTabVisible)
                    {
                        self._newTabSize = ctx.measureText(Sheets.SR.NewTab).width + self._tabLeftPadding;
                        self.drawTab(ctx, pos, 0, self._newTabSize, rect.height, 5, false, hoverTab === -2, Sheets.SR.NewTab)
                    }
                    self._activeIndex = sp.getActiveSheetIndex();
                    var activeIndex = self._activeIndex;
                    if (sheets.length > 0)
                    {
                        for (i = tabs.length - 1; i >= 0; i--)
                        {
                            var t = tabs[i];
                            if (t.i !== activeIndex && t.visible)
                            {
                                self.drawTab(ctx, t.x, 0, t.w, rect.height, 5, false, t.i === hoverTab, t.t)
                            }
                        }
                        if (firstTab > 0 && self._getPreVisibleIndex(firstTab) >= 0)
                        {
                            var index = firstTab - 1;
                            tabSize = self._tabSizes[index];
                            self.drawTab(ctx, tabStartPosition + self._firstTabSpace - tabSize - self._tabSpace, 0, tabSize, rect.height, 5, activeIndex === index, hoverTab === index, "")
                        }
                        var at = tabs[activeIndex - firstTab];
                        if (activeIndex >= firstTab && activeIndex < sheets.length && at && at.visible)
                        {
                            self.drawTab(ctx, at.x, 0, at.w, rect.height, 5, true, false, at.t)
                        }
                    }
                    ctx.fillStyle = color_92A5C7;
                    ctx.fillRect(rect.x, rect.y, tabStartPosition - 1, rect.height);
                    var triangleSize = 5,
                        navigationButtonWidth = self._getNavigationButtonWidth(),
                        navigationButtonHeight = self._getNavigationButtonHeight();
                    var x = navigationButtonWidth / 2;
                    var y = navigationButtonHeight / 2;
                    var hoverNavButton = self._hoverNavButton;
                    self.drawNavButton(ctx, x, y, x + triangleSize, y + triangleSize, x + triangleSize, y - triangleSize, true, x - triangleSize, (hoverNavButton === 0));
                    x += navigationButtonWidth;
                    self.drawNavButton(ctx, x, y, x + triangleSize, y + triangleSize, x + triangleSize, y - triangleSize, true, keyword_null, (hoverNavButton === 1));
                    x += navigationButtonWidth;
                    self.drawNavButton(ctx, x, y, x - triangleSize, y + triangleSize, x - triangleSize, y - triangleSize, false, keyword_null, (hoverNavButton === 2));
                    x += navigationButtonWidth;
                    self.drawNavButton(ctx, x, y, x - triangleSize, y + triangleSize, x - triangleSize, y - triangleSize, false, x + 4, (hoverNavButton === 3));
                    var _width = self._resizeBarWidth;
                    var getExternalThemeStyle = window.gcGlobal.getExternalThemeStyle;
                    var hoverStyle = getExternalThemeStyle(4, "gc-tabStripResizeBarInner"),
                        headerStyle = getExternalThemeStyle(0, "gc-tabStripResizeBarOuter");
                    if (sp.showHorizontalScrollbar())
                    {
                        x = rect.x + rect.width - _width;
                        ctx.fillStyle = headerStyle.backgroundColor;
                        ctx.fillRect(x, rect.y, _width, rect.height);
                        ctx.fillStyle = hoverStyle.backgroundColor;
                        ctx.fillRect(x + 1, rect.y + 1, _width - 2, rect.height - 2);
                        ctx.fillStyle = hoverStyle.color;
                        ctx.fillRect(x + _width / 2 - 1, rect.y + 4, 2, rect.height - 8)
                    }
                    ctx.beginPath();
                    ctx.restore()
                };
                _GcTab.prototype.drawNavButton = function(ctx, x1, y1, x2, y2, x3, y3, left, linePosition, highlight)
                {
                    ctx.save();
                    var self = this;
                    var rect = self.getBounds(),
                        navigationButtonWidth = self._getNavigationButtonWidth();
                    var getExternalThemeStyle = window.gcGlobal.getExternalThemeStyle;
                    var hoverStyle = getExternalThemeStyle(4, "gc-navButton-hover");
                    var tmpStyle = getExternalThemeStyle(0, "gc-navButton-normal"),
                        backgroundImg = tmpStyle && tmpStyle.backgroundImage,
                        backgroundColor = tmpStyle && tmpStyle.backgroundColor;
                    if (highlight)
                    {
                        ctx.fillStyle = hoverStyle.backgroundColor;
                        ctx.fillRect(x1 - navigationButtonWidth / 2 + 2, rect.y + 2, navigationButtonWidth - 4, rect.height - 4)
                    }
                    else
                    {
                        if (backgroundImg && backgroundImg.indexOf("linear-gradient") !== -1)
                        {
                            var fill = ctx.createLinearGradient(rect.x + 0.7 * rect.height, rect.y + 0, 0.7 * rect.height, rect.height);
                            var colors = Sheets.util.getLinearGradientColors(backgroundImg);
                            for (var i = 0, len = colors.length; i < len; i++)
                            {
                                var color = colors[i];
                                fill.addColorStop(color.point, color.color)
                            }
                            ctx.fillStyle = fill
                        }
                        else if (backgroundColor)
                        {
                            ctx.fillStyle = backgroundColor
                        }
                        ctx.fillRect(x1 - navigationButtonWidth / 2, rect.y + 1, navigationButtonWidth, rect.height - 2)
                    }
                    if (highlight)
                    {
                        ctx.fillStyle = hoverStyle.color
                    }
                    else
                    {
                        ctx.fillStyle = tmpStyle.color
                    }
                    if (linePosition !== keyword_undefined && linePosition !== keyword_null)
                    {
                        ctx.fillRect(linePosition, Math_min(y2, y3), 1, Math_max(y2, y3) - Math_min(y2, y3))
                    }
                    if (left)
                    {
                        x1 -= 2;
                        x2 -= 2;
                        x3 -= 2
                    }
                    else
                    {
                        x1 += 2;
                        x2 += 2;
                        x3 += 2
                    }
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.lineTo(x3, y3);
                    ctx.lineTo(x1, y1);
                    ctx.fill();
                    ctx.restore()
                };
                _GcTab.prototype._getTabBackColor = function(ctx, isActive, isHover, text, externalThemeStyle)
                {
                    var self = this;
                    var rect = self.getBounds();
                    var fillStyle = ctx.createLinearGradient(rect.x + 0.7 * rect.height, rect.y + 0, 0.7 * rect.height, rect.height);
                    var sheet = self._spread.getSheetFromName(text);
                    if (text === "" && self._firstTab > 0)
                    {
                        sheet = self._spread.getSheet(self._firstTab - 1)
                    }
                    if (sheet && sheet._sheetTabColor)
                    {
                        var transparentColor = "rgba(0, 0, 0, 0)";
                        ctx.fillStyle = transparentColor;
                        ctx.fillStyle = Sheets._ThemeContext.getColor(sheet, sheet._sheetTabColor);
                        var color = ctx.fillStyle;
                        if (color !== transparentColor)
                        {
                            if (isHover || isActive)
                            {
                                fillStyle.addColorStop(0, color_FFFFFF);
                                fillStyle.addColorStop(0.45, "#F1F6FD");
                                fillStyle.addColorStop(0.9, color);
                                fillStyle.addColorStop(1, color_FFFFFF)
                            }
                            else
                            {
                                fillStyle = color
                            }
                        }
                    }
                    else if (externalThemeStyle)
                    {
                        var backgroundImg = externalThemeStyle && externalThemeStyle.backgroundImage,
                            backgroundColor = externalThemeStyle && externalThemeStyle.backgroundColor;
                        if (backgroundImg && backgroundImg.indexOf("linear-gradient") !== -1)
                        {
                            var colors = Sheets.util.getLinearGradientColors(backgroundImg);
                            for (var i = 0, len = colors.length; i < len; i++)
                            {
                                var color = colors[i];
                                fillStyle.addColorStop(color.point, color.color)
                            }
                        }
                        else if (backgroundColor)
                        {
                            fillStyle.addColorStop(0, backgroundColor)
                        }
                    }
                    return fillStyle
                };
                _GcTab.prototype._getTabForeColor = function(externalThemeStyle, solidBackColor)
                {
                    var foreColor = color_black;
                    if (externalThemeStyle)
                    {
                        foreColor = externalThemeStyle.color
                    }
                    else if (solidBackColor)
                    {
                        var c = Sheets._Color.parse(solidBackColor);
                        if (c && c.getBrightness() < 255 / 2)
                        {
                            foreColor = color_white
                        }
                    }
                    return foreColor
                };
                _GcTab.prototype.drawTab = function(ctx, x, y, width, height, cornerRadius, isActive, isHover, text)
                {
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x, y + height - cornerRadius);
                    ctx.arcTo(x, y + height, x + width, y + height, cornerRadius);
                    ctx.lineTo(x + width, y + height);
                    ctx.lineTo(x + width + height, y);
                    if (!isActive)
                    {
                        ctx.lineTo(x, y)
                    }
                    var self = this;
                    var visualStata = 0;
                    if (isActive || isHover)
                    {
                        visualStata = 4
                    }
                    var externalThemeStyle = window.gcGlobal.getExternalThemeStyle(visualStata, "gc-tab-" + Sheets.VisualState[visualStata].toLowerCase());
                    var backColor = self._getTabBackColor(ctx, isActive, isHover, text, externalThemeStyle);
                    ctx.fillStyle = backColor;
                    ctx.fill();
                    ctx.strokeStyle = color_92A5C7;
                    ctx.stroke();
                    ctx.textBaseline = cssTop;
                    var solidBackColor;
                    if (typeof(backColor) === "string")
                    {
                        solidBackColor = backColor
                    }
                    ctx.fillStyle = self._getTabForeColor(externalThemeStyle, solidBackColor);
                    var adjX = self._tabLeftPadding;
                    ctx.textBaseline = "middle";
                    ctx.fillText(text, x + adjX, y + height / 2);
                    ctx.restore()
                };
                return _GcTab
            })()
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}));
var GcSpread;
(function(GcSpread)
{
    (function(Sheets)
    {
        Sheets.feature("core.spread_ui", ["core.migrate", "core.common", "core.spread"]);
        var const_undefined = "undefined";
        var $ = jQuery;
        var GcSpreadSheetsOptions = (function()
            {
                function GcSpreadSheetsOptions()
                {
                    var self = this;
                    self.sheetCount = 1;
                    self.name = "";
                    self.font = "10pt Arial";
                    self.allowUserZoom = true;
                    self.allowUserResize = true;
                    self.tabStripVisible = true;
                    self.tabEditable = true;
                    self.newTabVisible = true;
                    self.tabStripRatio = 0.5;
                    self.activeSheetIndex = 0;
                    self.sheets = []
                }
                return GcSpreadSheetsOptions
            })();
        Sheets.GcSpreadSheetsOptions = GcSpreadSheetsOptions;
        var gcSpreadSheetsOptions = new GcSpreadSheetsOptions;
        Sheets.WijspreadOptions = GcSpreadSheetsOptions;
        var methods = {
                init: function(options)
                {
                    options = $.extend(true, gcSpreadSheetsOptions, options);
                    var host = this.get(0);
                    new Sheets.Spread(host, options)
                }, spread: function()
                    {
                        return this.data("spread")
                    }, destroy: function()
                    {
                        var spreadTmp = this.data("spread");
                        if (spreadTmp)
                        {
                            spreadTmp.destroy()
                        }
                    }, refresh: function()
                    {
                        var spreadTmp = this.data("spread");
                        if (spreadTmp)
                        {
                            spreadTmp.refresh()
                        }
                    }, repaint: function()
                    {
                        var spreadTmp = this.data("spread");
                        if (spreadTmp)
                        {
                            spreadTmp.repaint()
                        }
                    }
            };
        $.fn.wijspread = function(method)
        {
            if (methods[method])
            {
                return methods[method].apply(this, Array.prototype.slice.call(arguments, 1))
            }
            else if (typeof method === 'object' || !method)
            {
                return methods.init.apply(this, arguments)
            }
        };
        if (typeof $.wijmo === const_undefined)
        {
            $.wijmo = {wijspread: undefined}
        }
        $.wijmo.wijspread = GcSpread.Sheets;
        if (typeof window.wijmo === const_undefined)
        {
            window.wijmo = {spread: undefined}
        }
        window.wijmo.spread = GcSpread.Sheets;
        var ko = window.ko;
        if (ko)
        {
            ko.GcSpread = ko.GcSpread || {};
            ko.GcSpread.gcspreadsheetsBinding = {
                init: function(element, valueAccessor, allBindingsAccessor, viewModel)
                {
                    new Sheets.Spread($("#" + element.id)[0], valueAccessor())
                }, update: function(element, valueAccessor, allBindingsAccessor, viewModel){}
            };
            ko.bindingHandlers["gcspread-sheets"] = ko.GcSpread.gcspreadsheetsBinding;
            ko.wijmo = ko.GcSpread;
            ko.bindingHandlers["wijspread"] = ko.GcSpread.gcspreadsheetsBinding
        }
    })(GcSpread.Sheets || (GcSpread.Sheets = {}));
    var Sheets = GcSpread.Sheets
})(GcSpread || (GcSpread = {}))

