/*
 *
 * SpreadJS Library 8.40.20151.0
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 *
 * Licensed under the SpreadJS Commercial License. 
 * spread.sales@grapecity.com
 * http://spread.grapecity.com/Pages/Spread-JS-License/
 *
 *
 **/
var GcSpread;(function(n){(function(n){var c,f,y,o,s,l,a;n.feature("comment",["core.common","core.sheet_action"]);var t=null,i=undefined,r=Math.max,u=Math.min,e=Math.floor,v=Math.atan2,h=Math.abs;(function(n){n[n.AlwaysShown=1]="AlwaysShown";n[n.HoverShown=2]="HoverShown"})(n.DisplayMode||(n.DisplayMode={}));c=n.DisplayMode;f=function(){function n(n,t,i,r){this.left=0;this.top=0;this.right=0;this.bottom=0;var u=this;arguments.length===1?u.top=u.right=u.bottom=u.left=n:arguments.length===4&&(u.top=n,u.right=t,u.bottom=i,u.left=r)}return n.prototype.toString=function(){var n=this;return n.top+"px "+n.right+"px "+n.bottom+"px "+n.left+"px"},n}();n.Padding=f,function(n){n[n.TopLeft=0]="TopLeft";n[n.TopRight=1]="TopRight";n[n.BottomLeft=2]="BottomLeft";n[n.BottomRight=3]="BottomRight";n[n.MiddleLeft=4]="MiddleLeft";n[n.MiddleRight=5]="MiddleRight";n[n.TopCenter=6]="TopCenter";n[n.BottomCenter=7]="BottomCenter"}(n.ResizeDirection||(n.ResizeDirection={}));y=n.ResizeDirection;o=function(){function r(){var i=this;i._defaultLocation=new n.Point(9,-18);i._text="";i._location=i._defaultLocation;i._displayMode=2;i._commentState=3;i._width=160;i._height=100;i._fontFamily="Arial";i._fontStyle="normal";i._fontSize="9pt";i._fontWeight="normal";i._textDecoration=0;i._foreColor="black";i._backColor="#FFFFE1";i._opacity=1;i._locked=!0;i._lockText=!0;i._dynamicMove=!0;i._dynamicSize=!0;i._horizontalAlign=0;i._autoSize=!1;i._borderWidth=1;i._borderStyle="solid";i._borderColor="black";i._padding=t;i._zIndex=-1;i._showShadow=!1;i._timeout=t;i._rowIndex=-1;i._colIndex=-1;i._sheet=t}return r.prototype.text=function(n){var t=this;return arguments.length===0?t._text:(typeof n=="string"&&t._text!==n&&t._changeProperty("text",n),t)},r.prototype.location=function(t){var i=this;return arguments.length===0?i._location:(t instanceof n.Point&&i._location!==t&&i._changeProperty("location",t),i)},r.prototype.width=function(n){var t=this;return arguments.length===0?t._width:(typeof n=="number"&&n>0&&t._width!==n&&(t._autoSize=!1,t._changeProperty("width",n)),t)},r.prototype.height=function(n){var t=this;return arguments.length===0?t._height:(typeof n=="number"&&n>0&&t._height!==n&&(t._autoSize=!1,t._changeProperty("height",n)),t)},r.prototype.fontFamily=function(n){var t=this;return arguments.length===0?t._fontFamily:(typeof n=="string"&&t._fontFamily!==n&&t._changeProperty("fontFamily",n),t)},r.prototype.fontStyle=function(n){var t=this;return arguments.length===0?t._fontStyle:(typeof n=="string"&&t._fontStyle!==n&&t._changeProperty("fontStyle",n),t)},r.prototype.fontSize=function(n){var t=this;return arguments.length===0?t._fontSize:(typeof n=="string"&&t._fontSize!==n&&t._changeProperty("fontSize",n),t)},r.prototype.fontWeight=function(n){var t=this;return arguments.length===0?t._fontWeight:(typeof n=="string"&&t._fontWeight!==n&&t._changeProperty("fontWeight",n),t)},r.prototype.textDecoration=function(t){var r=this;return arguments.length===0?r._textDecoration:(n.TextDecorationType[t]!==i&&r._textDecoration!==t&&r._changeProperty("textDecoration",t),r)},r.prototype.foreColor=function(n){var t=this;return arguments.length===0?t._foreColor:(typeof n=="string"&&t._foreColor!==n&&t._changeProperty("foreColor",n),t)},r.prototype.locked=function(n){var t=this;return arguments.length===0?t._locked:(typeof n=="boolean"&&t._locked!==n&&t._changeProperty("locked",n),t)},r.prototype.lockText=function(n){var t=this;return arguments.length===0?t._lockText:(typeof n=="boolean"&&t._lockText!==n&&t._changeProperty("lockText",n),t)},r.prototype.horizontalAlign=function(t){var r=this;return arguments.length===0?r._horizontalAlign:(n.HorizontalAlign[t]!==i&&r._horizontalAlign!==t&&r._changeProperty("horizontalAlign",t),r)},r.prototype.autoSize=function(n){var t=this;return arguments.length===0?t._autoSize:(typeof n=="boolean"&&t._autoSize!==n&&t._changeProperty("autoSize",n),t)},r.prototype.dynamicSize=function(n){var t=this;if(arguments.length===0)return t._dynamicSize;else{if(typeof n=="boolean"&&t._dynamicSize!==n){if(n===!0&&t._dynamicMove===!1)return t;t._changeProperty("dynamicSize",n)}return t}},r.prototype.dynamicMove=function(n){var t=this;return arguments.length===0?t._dynamicMove:(typeof n=="boolean"&&t._dynamicMove!==n&&(n===!1&&t._dynamicSize===!0&&(t._dynamicSize=!1),t._changeProperty("dynamicMove",n)),t)},r.prototype.backColor=function(n){var t=this;return arguments.length===0?t._backColor:(typeof n=="string"&&t._backColor!==n&&t._changeProperty("backColor",n),t)},r.prototype.opacity=function(n){var t=this;return arguments.length===0?t._opacity:(typeof n=="number"&&n>=0&&n<=1&&t._opacity!==n&&t._changeProperty("opacity",n),t)},r.prototype.borderWidth=function(n){var t=this;return arguments.length===0?t._borderWidth:(typeof n=="number"&&n>0&&t._borderWidth!==n&&t._changeProperty("borderWidth",n),t)},r.prototype.borderStyle=function(n){var t=this;return arguments.length===0?t._borderStyle:(typeof n=="string"&&t._borderStyle!==n&&t._changeProperty("borderStyle",n),t)},r.prototype.borderColor=function(n){var t=this;return arguments.length===0?t._borderColor:(typeof n=="string"&&t._borderColor!==n&&t._changeProperty("borderColor",n),t)},r.prototype.padding=function(n){var i=this;return arguments.length===0?i._padding:((n===t||n instanceof f)&&i._padding!==n&&i._changeProperty("padding",n),i)},r.prototype.showShadow=function(n){var t=this;return arguments.length===0?t._showShadow:(typeof n=="boolean"&&t._showShadow!==n&&t._changeProperty("showShadow",n),t)},r.prototype.displayMode=function(n){var t=this;return arguments.length===0?t._displayMode:(c[n]!==i&&t._displayMode!==n&&t._changeProperty("displayMode",n),t)},r.prototype.commentState=function(t){var r=this;return arguments.length===0?r._commentState:(n.CommentState[t]!==i&&r._commentState!==t&&r._changeProperty("commentState",t),r)},r.prototype.zIndex=function(n){var t=this;return arguments.length===0?t._zIndex:(typeof n=="number"&&t._zIndex!==n&&t._changeProperty("zIndex",n),t)},r.prototype._changeProperty=function(n,t){var i=this,r=i._sheet,u="_"+n;r?r._bindToAutoRefresh(function(n){i.hasOwnProperty(u)&&(i[u]=n)})(t):i.hasOwnProperty(u)&&(i[u]=t);this._sheet&&this._sheet.triggerCommentChanged({sheet:r,sheetName:r?r._name:"",comment:i,propertyName:n})},r.prototype.clone=function(){var t=this,i=new r;return i._text=t._text,i._location=new n.Point(t._location.x,t._location.y),t._defaultLocation&&(i._defaultLocation=new n.Point(t._defaultLocation.x,t._defaultLocation.y)),i._width=t._width,i._height=t._height,i._fontFamily=t._fontFamily,i._fontStyle=t._fontStyle,i._fontSize=t._fontSize,i._fontWeight=t._fontWeight,i._textDecoration=t._textDecoration,i._foreColor=t._foreColor,i._locked=t._locked,i._lockText=t._lockText,i._horizontalAlign=t._horizontalAlign,i._autoSize=t._autoSize,i._dynamicMove=t._dynamicMove,i._dynamicSize=t._dynamicSize,i._backColor=t._backColor,i._opacity=t._opacity,i._borderWidth=t._borderWidth,i._borderStyle=t._borderStyle,i._borderColor=t._borderColor,t._padding&&(i._padding=new f(t._padding.top,t._padding.right,t._padding.bottom,t._padding.left)),i._showShadow=t._showShadow,i._displayMode=t._displayMode,i._commentState=t._commentState,i._sheet=t._sheet,i._rowIndex=t._rowIndex,i._colIndex=t._colIndex,i._zIndex=t._zIndex,i},r.prototype.toJSON=function(){var n=this,r={text:n._text,location:n._location,displayMode:n._displayMode,commentState:n._commentState,width:n._width,height:n._height,fontFamily:n._fontFamily,fontStyle:n._fontStyle,fontSize:n._fontSize,fontWeight:n._fontWeight,textDecoration:n._textDecoration,foreColor:n._foreColor,backColor:n._backColor,opacity:n._opacity,locked:n._locked,lockText:n._lockText,dynamicMove:n._dynamicMove,dynamicSize:n._dynamicSize,horizontalAlign:n._horizontalAlign,autoSize:n._autoSize,borderWidth:n._borderWidth,borderStyle:n._borderStyle,borderColor:n._borderColor,padding:n._padding,zIndex:n._zIndex,showShadow:n._showShadow,rowIndex:n._rowIndex,colIndex:n._colIndex},u={},t,i;for(t in r)i=r[t],n._isDefaultValue(t,i)||(u[t]=i);return u},r.prototype._isDefaultValue=function(n,t){switch(n){case"text":return t==="";case"location":return t.x===9&&t.y===-18;case"displayMode":return t===2;case"commentState":return t===3;case"width":return t===160;case"height":return t===100;case"fontFamily":return t==="Arial";case"fontStyle":return t==="normal";case"fontSize":return t==="9pt";case"fontWeight":return t==="normal";case"textDecoration":return t===0;case"foreColor":return t==="black";case"backColor":return t==="#FFFFE1";case"opacity":return t===1;case"locked":return t===!0;case"lockText":return t===!0;case"dynamicMove":return t===!0;case"dynamicSize":return t===!0;case"horizontalAlign":return t===0;case"autoSize":return t===!1;case"borderWidth":return t===1;case"borderStyle":return t==="solid";case"borderColor":return t==="black";case"padding":return t===null;case"zIndex":return t===-1;case"showShadow":return t===!1;case"rowIndex":return t===-1;case"colIndex":return t===-1;default:return!1}},r.prototype.fromJSON=function(t,r){var u,o,e;t&&(u=this,t.text!==i&&(u._text=t.text),o=t.location,o!==i&&(u._location=new n.Point(o.x,o.y)),t.displayMode!==i&&(u._displayMode=t.displayMode),t.commentState!==i&&(u._commentState=t.commentState),t.width!==i&&(u._width=t.width),t.height!==i&&(u._height=t.height),t.fontFamily!==i&&(u._fontFamily=t.fontFamily),t.fontStyle!==i&&(u._fontStyle=t.fontStyle),t.fontSize!==i&&(u._fontSize=t.fontSize),t.fontWeight!==i&&(u._fontWeight=t.fontWeight),t.textDecoration!==i&&(u._textDecoration=t.textDecoration),t.foreColor!==i&&(u._foreColor=t.foreColor),t.backColor!==i&&(u._backColor=t.backColor),t.opacity!==i&&(u._opacity=t.opacity),t.locked!==i&&(u._locked=t.locked),t.lockText!==i&&(u._lockText=t.lockText),t.dynamicMove!==i&&(u._dynamicMove=t.dynamicMove),t.dynamicSize!==i&&(u._dynamicSize=t.dynamicSize),t.horizontalAlign!==i&&(u._horizontalAlign=t.horizontalAlign),t.autoSize!==i&&(u._autoSize=t.autoSize),t.borderWidth!==i&&(u._borderWidth=t.borderWidth),t.borderStyle!==i&&(u._borderStyle=t.borderStyle),t.borderColor!==i&&(u._borderColor=t.borderColor),e=t.padding,e!==i&&(u._padding=new f(e.top,e.right,e.bottom,e.left)),t.zIndex!==i&&(u._zIndex=t.zIndex),t.showShadow!==i&&(u._showShadow=t.showShadow),t.rowIndex!==i&&(u._rowIndex=t.rowIndex),t.colIndex!==i&&(u._colIndex=t.colIndex))},r}();n.Comment=o;s=function(){function f(n,t){this._rowViewportIndex=1;this._columnViewportIndex=1;var i=this,r=n&&n._sheet;i._comment=n;i._updateCommentViewportIndex();i._zoomFactor=r._zoomFactor;i._commentManager=t;i._editor=t._editorDom;i._init();i._absLocation=i._getAbsLocation();i._updateStartCoordinate();i._updateEndCoordinate()}return f.prototype._init=function(){var i=this,r;i._commentLayoutPanel=t;i._floatBlockCanvasContainer=t;i._floatBlockCanvas=t;i._hostContainer=t;i._host=t;i._lineCanvasContainer=t;i._lineCanvas=t;i._floatBlockCanvasContainerClassName="gc-spread-floatBlockCanvas-container";i._floatBlockCanvasClassName="gc-spread-floatBlockCanvas";i._hostContainerClassName="gc-spread-host-container";i._hostClassName="gc-spread-host";i._lineCanvasContainerClassName="gc-spread-lineCanvas-container";i._lineCanvasClassName="gc-spread-lineCanvas";i._floatBlockCanvasContainer=document.createElement("div");$(i._floatBlockCanvasContainer).addClass(i._floatBlockCanvasContainerClassName).css("position","absolute").css("overflow","hidden");i._floatBlockCanvas=document.createElement("canvas");n.DPIHelper.adjustDevicePixel(i._floatBlockCanvas,null,i._commentManager._sheet);$(i._floatBlockCanvas).addClass(i._floatBlockCanvasClassName).css("left",0).css("top",0).css("position","absolute");i._hostContainer=document.createElement("div");$(i._hostContainer).addClass(i._hostContainerClassName).css("position","absolute").css("box-sizing","content-box");i._host=document.createElement("div");$(i._host).addClass(i._hostClassName).css("left",0).css("top",0).css("width","100%").css("height","100%").css("position","absolute").css("word-wrap","break-word").css("word-break","normal").css("white-space","pre-wrap").css("overflow","hidden");$(i._hostContainer).append(i._host);$(i._floatBlockCanvasContainer).append(i._floatBlockCanvas,i._hostContainer);i._lineCanvasContainer=document.createElement("div");$(i._lineCanvasContainer).addClass(i._lineCanvasContainerClassName).css("position","absolute").css("overflow","hidden");i._lineCanvas=document.createElement("canvas");n.DPIHelper.adjustDevicePixel(i._lineCanvas,null,i._commentManager._sheet);$(i._lineCanvas).addClass(i._lineCanvasClassName).css("left",0).css("right",0).css("position","absolute");$(i._lineCanvasContainer).append(i._lineCanvas);i._adornerDrawState=t;i._resizeHitRects=[];i._hostMargin=7;i._isMoving=!1;i._isResizing=!1;r=i._comment._sheet;n.features.touch&&(i._touchManager=new n.CommentTouchManager(i._floatBlockCanvas,i,r.parent._touchEventProvider),i._touchManager.attach(),i._touchContentManager=new n.CommentContentTouchManager(i._host,i,r.parent._touchEventProvider),i._touchContentManager.attach())},f.prototype.open=function(){var n=this,t=n._comment._sheet;(n._commentLayoutPanel||(t&&(n._commentLayoutPanel=t._commentRender._commentLayoutPanel),n._commentLayoutPanel))&&(n._commentLayoutPanel.appendChild(n._lineCanvasContainer),n._attachLineCanvasEventHandler(),n._commentLayoutPanel.appendChild(n._floatBlockCanvasContainer),n._attachFloatBlockCanvasEventHandler(),n._attachHostContainerEventHandler(),n.isEditing()?n._attachEditorEventHandler():n._attachHostEventHandler(),n._absLocation=n._getAbsLocation(),n.updateLayout())},f.prototype.close=function(){var n=this;n._floatBlockCanvasContainer&&n._lineCanvasContainer&&n._commentLayoutPanel&&(n._detachFloatBlockCanvasEventHandler(),n._detachHostContainerEventHandler(),n._detachHostEventHandler(),n._detachLineCanvasEventHandler(),n._detachEditorEventHandler(),$(n._floatBlockCanvasContainer).remove(),$(n._lineCanvasContainer).remove())},f.prototype.getComment=function(){return this._comment},f.prototype._getActualWidth=function(){return this._comment.width()*this._zoomFactor},f.prototype._getActualHeight=function(){return this._comment.height()*this._zoomFactor},f.prototype._getAbsLocation=function(){var n=this,t=n._comment;return t===n._commentManager.getHoverShownComment()&&t.commentState()===3?n._convertRelLocationToAbsLocation(t._defaultLocation):n._convertRelLocationToAbsLocation(t.location())},f.prototype._convertRelLocationToAbsLocation=function(i){var u=this,f=u._comment,e=f&&f._sheet,s=u._zoomFactor,h=t,r,o;return e&&(r=u._getCellRect(e,f._rowIndex,f._colIndex,u._rowViewportIndex,u._columnViewportIndex),r.x!==null&&r.x!==undefined&&r.y!==null&&r.y!==undefined&&r.width&&r.height&&(o=e._getSheetLayout(),h=new n.Point(r.x+r.width+i.x*s-o.rowHeaderWidth,r.y+i.y*s-o.colHeaderHeight))),h},f.prototype._getCellRect=function(f,e,o,s,h){for(var p,a,g=this,c=new n.Rect(0,0,0,0),l=f._getSheetLayout(),w=f.getViewportTopRow(s),b=f.getViewportLeftColumn(h),nt=u(w,e),tt=r(w,e),it=u(b,o),rt=r(b,o),k=0,d=0,y=g._zoomFactor,v=nt;v<tt;v++)d+=f.getRowHeight(v,3)*y;for(a=it;a<rt;a++)k+=f.getColumnWidth(a,3)*y;if(c.y=e>=w?d:-d,c.x=o>=b?k:-k,p=f.getSpan(e,o),p!=i&&p!=t){for(v=0;v<p.rowCount;v++)c.height+=f.getRowHeight(e+v)*y;for(a=0;a<p.colCount;a++)c.width+=f.getColumnWidth(o+a)*y}else c.height=f.getRowHeight(e)*y,c.width=f.getColumnWidth(o)*y;return c.x+=l.rowHeaderWidth,c.y+=l.colHeaderHeight,s===1?c.y+=l.frozenHeight:s===2&&(c.y+=l.frozenHeight+l.viewportHeight),h===1?c.x+=l.frozenWidth:h===2&&(c.x+=l.frozenWidth+l.viewportWidth),c},f.prototype._convertAbsLocationToRelLocation=function(i){var u=this,f=u._comment,e=f&&f._sheet,o=u._zoomFactor,s=t,r;if(e&&(r=u._getCellRect(e,f._rowIndex,f._colIndex,u._rowViewportIndex,u._columnViewportIndex),r.x!==null&&r.x!==undefined&&r.y!==null&&r.y!==undefined&&r.width&&r.height)){var h=e._getSheetLayout(),c=(i.x-(r.x+r.width-h.rowHeaderWidth))/o,l=(i.y-(r.y-h.colHeaderHeight))/o;s=new n.Point(c,l)}return s},f.prototype.updateLayoutWhenLocationChanged=function(){var n=this;n._absLocation=n._getAbsLocation();n._updateStartCoordinate();n._updateEndCoordinate();n.updateLayout()},f.prototype.updateLayoutWhenWidthHeightChanged=function(){var n=this;n._absLocation=n._getAbsLocation();n._updateEndCoordinate()},f.prototype.updateLayoutWhenRowColumnChanged=function(){var n=this,t=n._comment,i;t.dynamicMove()?t.dynamicSize()?(n._updateSizeByCoordinate(),n._updateLocationByCoordinate()):(n._updateLocationByCoordinate(),n._updateEndCoordinate()):(n._updateStartCoordinate(),n._updateEndCoordinate(),i=n._convertAbsLocationToRelLocation(n._absLocation),t.location(i))},f.prototype.updateLayoutWhenCellSpanChanged=function(){var n=this;n._absLocation=n._getAbsLocation();n.updateLayout()},f.prototype.updateLayoutWhenSheetScroll=function(){var n=this;n._absLocation=n._getAbsLocation();n.updateLayout()},f.prototype._updateLocationByCoordinate=function(){var n=this,t=n._comment,r=t&&t._sheet,i=n._getLocationByCoordinate();n._absLocation=i;t._location=n._convertAbsLocationToRelLocation(i);n.updateLayout()},f.prototype._getLocationByCoordinate=function(){var t=this,c=t._comment,i=c&&c._sheet,f=t._zoomFactor,l=i.getViewportLeftColumn(t._columnViewportIndex),a=i.getViewportTopRow(t._rowViewportIndex),v=t._getViewportRect(t._rowViewportIndex,t._columnViewportIndex),r,e,s,u,o,h;for(t._columnViewportIndex===0?r=0:t._columnViewportIndex===1?r=i.getViewportWidth(0):t._columnViewportIndex===2&&(r=i.getViewportWidth(0)+i.getViewportWidth(1)),e=l;e<t._startColumn;e++)r+=i.getColumnWidth(e,3)*f;for(s=i.getColumnWidth(t._startColumn,3),s<t._startColumnOffset&&(t._startColumnOffset=s),r=r+t._startColumnOffset*f,t._rowViewportIndex===0?u=0:t._rowViewportIndex===1?u=i.getViewportHeight(0):t._rowViewportIndex===2&&(u=i.getViewportHeight(0)+i.getViewportHeight(1)),o=a;o<t._startRow;o++)u+=i.getRowHeight(o,3)*f;return h=i.getRowHeight(t._startRow,3),h<t._startRowOffset&&(t._startRowOffset=h),u=u+t._startRowOffset*f,new n.Point(r,u)},f.prototype._updateSizeByCoordinate=function(){for(var o,s,i,f,h,c,n=this,r=n._comment,t=r&&r._sheet,l=n._zoomFactor,u=0,e=n._startColumn;e<n._endColumn;e++)u+=t.getColumnWidth(e,3);for(o=t.getColumnWidth(n._startColumn,3),o<n._startColumnOffset&&(n._startColumnOffset=o),s=t.getColumnWidth(n._endColumn,3),s<n._endColumnOffset&&(n._endColumnOffset=s),u=u-n._startColumnOffset+n._endColumnOffset,i=0,f=n._startRow;f<n._endRow;f++)i+=t.getRowHeight(f,3);h=t.getRowHeight(n._startRow,3);h<n._startRowOffset&&(n._startRowOffset=h);c=t.getRowHeight(n._endRow,3);c<n._endRowOffset&&(n._endRowOffset=c);i=i-n._startRowOffset+n._endRowOffset;r.width(u);r.height(i)},f.prototype._updateStartCoordinate=function(){var t=this,v=t._comment,i=v&&v._sheet,f=t._zoomFactor,o,r,l,u,a;if(t._absLocation){var w=t._getViewportRect(t._rowViewportIndex,t._columnViewportIndex),y=i.getViewportLeftColumn(t._columnViewportIndex),p=i.getViewportTopRow(t._rowViewportIndex),e;t._columnViewportIndex===0?e=t._absLocation.x:t._columnViewportIndex===1?e=t._absLocation.x-i.getViewportWidth(0):t._columnViewportIndex===2&&(e=t._absLocation.x-(i.getViewportWidth(0)+i.getViewportWidth(1)));t._rowViewportIndex===0?o=t._absLocation.y:t._rowViewportIndex===1?o=t._absLocation.y-i.getViewportHeight(0):t._rowViewportIndex===2&&(o=t._absLocation.y-(i.getViewportHeight(0)+i.getViewportHeight(1)));var s=new n.Point(e,o),h=0,c=0;for(r=y;r<i.getColumnCount();r++)if(l=i.getColumnWidth(r,3)*f,h+l<s.x)h+=l;else{t._startColumn=r;t._startColumnOffset=(s.x-h)/f;break}for(u=p;u<i.getRowCount();u++)if(a=i.getRowHeight(u,3)*f,c+a<s.y)c+=a;else{t._startRow=u;t._startRowOffset=(s.y-c)/f;break}}},f.prototype._updateEndCoordinate=function(){var t=this,v=t._comment,i=v&&v._sheet,f=t._zoomFactor,o,r,l,u,a;if(t._absLocation){var w=t._getViewportRect(t._rowViewportIndex,t._columnViewportIndex),y=i.getViewportLeftColumn(t._columnViewportIndex),p=i.getViewportTopRow(t._rowViewportIndex),e;t._columnViewportIndex===0?e=t._absLocation.x+t._getActualWidth():t._columnViewportIndex===1?e=t._absLocation.x+t._getActualWidth()-i.getViewportWidth(0):t._columnViewportIndex===2&&(e=t._absLocation.x+t._getActualWidth()-(i.getViewportWidth(0)+i.getViewportWidth(1)));t._rowViewportIndex===0?o=t._absLocation.y+t._getActualHeight():t._rowViewportIndex===1?o=t._absLocation.y+t._getActualHeight()-i.getViewportHeight(0):t._rowViewportIndex===2&&(o=t._absLocation.y+t._getActualHeight()-(i.getViewportHeight(0)+i.getViewportHeight(1)));var s=new n.Point(e,o),h=0,c=0;for(r=y;r<i.getColumnCount();r++)if(l=i.getColumnWidth(r,3)*f,h+l<s.x)h+=l;else{t._endColumn=r;t._endColumnOffset=(s.x-h)/f;break}for(u=p;u<i.getRowCount();u++)if(a=i.getRowHeight(u,3)*f,c+a<s.y)c+=a;else{t._endRow=u;t._endRowOffset=(s.y-c)/f;break}}},f.prototype.addRows=function(n,t){var i=this,r=i._comment;n<=i._startRow?r.dynamicMove()&&(i._startRow+=t,i._endRow+=t):n>i._startRow&&n<=i._endRow&&r.dynamicSize()&&(i._endRow+=t);i._updateSizeByCoordinate();i._updateLocationByCoordinate()},f.prototype.addColumns=function(n,t){var i=this,r=i._comment;n<=i._startColumn?r.dynamicMove()&&(i._startColumn+=t,i._endColumn+=t):n>i._startColumn&&n<=i._endColumn&&r.dynamicSize()&&(i._endColumn+=t);i._updateSizeByCoordinate();i._updateLocationByCoordinate()},f.prototype.removeRows=function(n,t){var i=this,r=i._comment,u=n+t-1;n<i._startRow?u<i._startRow?r.dynamicMove()&&(i._startRow-=t,i._endRow-=t):u<i._endRow&&r.dynamicMove()&&(i._endRow-=r.dynamicSize()?t:i._startRow-n+1,i._startRow=n,i._startRowOffset=0):n<=i._endRow&&(u<i._endRow?r.dynamicSize()&&(i._endRow-=t):r.dynamicSize()&&(i._endRow=n,i._endRowOffset=0));i._updateSizeByCoordinate();i._updateLocationByCoordinate()},f.prototype.removeColumns=function(n,t){var i=this,r=i._comment,u=n+t-1;n<i._startColumn?u<i._startColumn?r.dynamicMove()&&(i._startColumn-=t,i._endColumn-=t):u<i._endColumn&&r.dynamicMove()&&(i._endColumn-=r.dynamicSize()?t:i._startColumn-n+1,i._startColumn=n,i._startColumnOffset=0):n<=i._endColumn&&(u<i._endColumn?r.dynamicSize()&&(i._endColumn-=t):r.dynamicSize()&&(i._endColumn=n,i._endColumnOffset=0));i._updateSizeByCoordinate();i._updateLocationByCoordinate()},f.prototype.updateLayout=function(){var n=this,i=n._comment,t=i._sheet;n.isOpen()&&(n._zoomFactor!==t._zoomFactor?(n._zoomFactor=t._zoomFactor,n._absLocation=n._getLocationByCoordinate()):n._zoomFactor=t._zoomFactor,n._updateCommentViewportIndex(),n._updateIndicatorSize(),n._formatComment(),n._updateLineContainerLayout(),n._updateAdornerLayout(),$.browser.chrome&&n._offsetCommentLayoutInChrome(),i.autoSize()&&!n._isAutosizing&&n._doAutosize())},f.prototype._updateIndicatorSize=function(){var n=this,t=n._comment._sheet,i=t.parent&&t.parent.useTouchLayout();n._hostMargin=i?11:7},f.prototype._updateCommentViewportIndex=function(){var e=this,t=e._comment,n=t&&t._sheet,i=t._rowIndex,r=t._colIndex,u=1,f=1,o=n.frozenRowCount,s=n.frozenColCount,h=n._frozenTrailingRowCount,c=n._frozenTrailingColCount,l=n.getRowCount(),a=n.getColumnCount();i<o?u=0:i>=o&&i<=l-h-1?u=1:i>l-h-1&&(u=2);r<s?f=0:r>=s&&r<=a-c-1?f=1:r>a-c-1&&(f=2);e._rowViewportIndex=u;e._columnViewportIndex=f},f.prototype._formatComment=function(){var n=this,i=n._comment,t=i.commentState()===2?n._editor:n._host;n._formatCommentState();n._formatCommentStyle(t);n._formatCommentText(t);n._formatCommentRect(t);n._formatCommentProtection()},f.prototype._formatCommentText=function(n){var t=this,i=t._comment;n===t._host&&(n.innerHTML=i.text().replace(/\r\n|\n|\r/g,"<br/>"))},f.prototype._formatCommentRect=function(t){var i=this,e=i._comment,it=e&&e._sheet,y=i._absLocation,v=i._zoomFactor,h,p,w,b,k,d,g;if(y){h=i._isResizing?i._getAdjustedCommentRect(y,e.width(),e.height()):i._getAdjustedCommentRect(y);i._adjustCommentRect(h);var c=h.width*v,l=h.height*v,o=h.x,s=h.y,nt=o+c,tt=s+l,a=i._hostMargin,f=i._getViewportRect(i._rowViewportIndex,i._columnViewportIndex);o<f.x?($(i._floatBlockCanvas).css("left",o-f.x),$(i._hostContainer).css("left",o+a-f.x),c+=o-f.x,o=f.x):($(i._floatBlockCanvas).css("left",0),$(i._hostContainer).css("left",a),nt>f.x+f.width&&(c+=f.x+f.width-1-nt));c=u(f.width-1,c);s<f.y?($(i._floatBlockCanvas).css("top",s-f.y),$(i._hostContainer).css("top",s+a-f.y),l+=s-f.y,s=f.y):($(i._floatBlockCanvas).css("top",0),$(i._hostContainer).css("top",a),tt>f.y+f.height&&(l+=f.y+f.height-1-tt));l=u(f.height-1,l);$(i._floatBlockCanvasContainer).css({left:o,top:s,width:c,height:l});p=e.width()*v;w=e.height()*v;n.DPIHelper.setSize(i._floatBlockCanvas,p,w);b=r(0,p-2*(a+e.borderWidth()));k=r(0,w-2*(a+e.borderWidth()));$(i._hostContainer).css({width:b,height:k});d=b;g=k;e.padding()&&(d-=parseInt(e.padding().left)+parseInt(e.padding().right),g-=parseInt(e.padding().top)+parseInt(e.padding().bottom));$(t).css({width:r(0,d),height:r(0,g)})}},f.prototype._adjustCommentRect=function(t){var r=this,i=r._comment,f=r._absLocation;if(t.x!==f.x||t.y!==f.y||t.width!==i.width()||t.height!==i.height()){var u=r._convertAbsLocationToRelLocation(new n.Point(t.x,t.y)),e=t.width,o=t.height;(u.x!==i.location().x||u.y!==i.location().y)&&(i._location=u);e!==i.width()&&(i._width=e);o!==i.height()&&(i._height=o)}},f.prototype._formatCommentProtection=function(){var n=this,t=n._comment,i=t&&t._sheet;i.isProtected?(t.locked()?(n._detachFloatBlockCanvasEventHandler(),n._attachMouseWheelEvent(n._floatBlockCanvas),n._detachHostContainerEventHandler(),n._attachMouseWheelEvent(n._hostContainer),n._floatBlockCanvas.style.cursor="default",n._hostContainer.style.cursor="default"):(n._attachFloatBlockCanvasEventHandler(),n._attachHostContainerEventHandler()),t.lockText()?(n._detachHostEventHandler(),n._attachMouseWheelEvent(n._host),n._detachEditorEventHandler(),n._attachMouseWheelEvent(n._editor),(t.locked()||t.commentState()!==1)&&t.commentState(3),n._host.style.cursor=t.locked()?"default":"move"):(n._attachHostEventHandler(),n._attachEditorEventHandler()),n._attachLineCanvasEventHandler()):(n._attachFloatBlockCanvasEventHandler(),n._attachHostContainerEventHandler(),n._attachLineCanvasEventHandler(),n._attachHostEventHandler(),n._attachEditorEventHandler())},f.prototype._formatCommentState=function(){var r=this,u=r._comment,f=r._commentManager,i=u&&u._sheet;switch(u.commentState()){case 1:f.activateComment(u);r.isEditing()&&r.detachEditor();i.getSelections().length>0&&i._saveAndClearSheetSelections();n.FocusHelper.setActiveElement(i);break;case 2:f.activateComment(u);r.isEditing()||r._attachEditor();i.getSelections().length>0&&i._saveAndClearSheetSelections();n.FocusHelper.setActiveElement(t);break;case 3:u===f.getActiveComment()&&(f.deactivateComment(),i.getSelections().length===0&&i._loadAndSetSheetSelections());break}},f.prototype._formatCommentStyle=function(t){var r=this,i=r._comment,u=$(t),f;u.css("font-family",i.fontFamily()).css("font-style",i.fontStyle()).css("font-size",parseInt(i.fontSize())*r._zoomFactor+"pt").css("font-weight",i.fontWeight());u.css("text-decoration",r._getTextDecorationString(i.textDecoration()));u.css("text-align",n.HorizontalAlign[i.horizontalAlign()]);i.padding()?u.css("padding",i.padding().toString()):u.css("padding","0px");u.css("background-color",i.backColor()).css("color",i.foreColor()).css("opacity",i.opacity());$(r._hostContainer).css("border-width",i.borderWidth()).css("border-style",i.borderStyle()).css("border-color",i.borderColor());f=r._commentManager.getCommentActualZIndex(i);$(r._lineCanvasContainer).css("z-index",f);$(r._floatBlockCanvasContainer).css("z-index",f)},f.prototype._getTextDecorationString=function(n){var t="";return n!==0?((n|1)===n&&(t+=" underline"),(n|2)===n&&(t+=" line-through"),(n|4)===n&&(t+=" overline")):t+="none",t},f.prototype._offsetCommentLayoutInChrome=function(){var r=this,i=this._comment._sheet,n=$(r._hostContainer);if(i&&n){var t=i._eventHandler._getCanvasOffset(),u=t.left-Math.floor(t.left)>=.5?.5:0,f=t.top-Math.floor(t.top)>=.5?.5:0;n.css("left",parseFloat(n.css("left"))+u);n.css("top",parseFloat(n.css("top"))+f)}},f.prototype._updateLineContainerLayout=function(){var r=this,w=r._comment,k=w._sheet,b=r._getCellRect(k,w._rowIndex,w._colIndex,r._rowViewportIndex,r._columnViewportIndex),d=k._getSheetLayout(),f=t,tt=b.x+b.width-d.rowHeaderWidth,it=b.y-d.colHeaderHeight;f=new n.Point(tt,it);var e=t,o=$(r._floatBlockCanvasContainer).position(),s=$(r._hostContainer).position(),y=$(r._hostContainer);e=o.left+s.left>f.x?new n.Point(o.left+s.left,o.top+s.top):o.top+s.top+y.height()<f.y?new n.Point(o.left+s.left+y.width(),o.top+s.top+y.height()):new n.Point(o.left+s.left+y.width(),o.top+s.top);var p=r._hostMargin,c=h(f.x-e.x)+2*p,l=h(f.y-e.y)+2*p,a=u(f.x,e.x)-p,v=u(f.y,e.y)-p,g=a+c,nt=v+l,i=r._getViewportRect(r._rowViewportIndex,r._columnViewportIndex);a<i.x&&(c-=i.x-a,a=i.x);g>i.x+i.width&&(c-=g-(i.x+i.width));c=u(i.width,c);v<i.y&&(l-=i.y-v,v=i.y);nt>i.y+i.height&&(l-=nt-(i.y+i.height));l=u(i.height,l);$(r._lineCanvasContainer).css("left",a).css("top",v).css("width",c).css("height",l);n.DPIHelper.setSize(r._lineCanvas,c,l);f.x=f.x-a;f.y=f.y-v;e.x=e.x-a;e.y=e.y-v;r._drawLine(f,e)},f.prototype._drawLine=function(t,i){var u=this,r,f,e;u._lineCtx||(u._lineCtx=u._lineCanvas.getContext("2d"));r=u._lineCtx;f=u._comment.borderColor();r.strokeStyle=f;r.clearRect(0,0,n.DPIHelper.getLogicWidth(u._lineCanvas),n.DPIHelper.getLogicHeight(u._lineCanvas));r.beginPath();r.moveTo(t.x,t.y);r.lineTo(i.x,i.y);r.stroke();r.save();r.translate(t.x,t.y);r.fillStyle=f;r.beginPath();e=v(i.y-t.y,i.x-t.x);r.rotate(e);r.moveTo(0,0);r.lineTo(7,-4);r.lineTo(7,4);r.lineTo(0,0);r.fill();r.closePath();r.restore()},f.prototype._updateAdornerLayout=function(){var t=this,f=t._comment,h=f._sheet;t._adornerDrawState=t._comment.commentState();t._adornerCtx||(t._adornerCtx=t._floatBlockCanvas.getContext("2d"));var i=t._adornerCtx,r=n.DPIHelper.getLogicWidth(t._floatBlockCanvas),u=n.DPIHelper.getLogicHeight(t._floatBlockCanvas),e=$(t._hostContainer).outerWidth(),o=$(t._hostContainer).outerHeight(),s=t._hostMargin;i.clearRect(0,0,r,u);t._comment.showShadow()&&(t._drawShadowAdorner(i,s,e,o),t._drawStateAdorner(i,r,u));h.isProtected&&f.locked()||t._drawResizeAdorner(i,s,r,u,e,o);i.restore()},f.prototype._drawShadowAdorner=function(n,t,i,r){n.fillRect(t+2,t+2,i,r)},f.prototype._drawStateAdorner=function(n,t,i){var u,r;switch(this._adornerDrawState){case 1:for(n.beginPath(),u=0;u<i;u++)for(r=u%2==0?1:3;r<t;)n.moveTo(r,u),n.lineTo(r+1,u+1),r=r+4;n.stroke();n.closePath();break;case 2:n.beginPath();for(var r=0,u=0,f=4;r<t+i;)n.moveTo(r+f,0),n.lineTo(0,u+f),r=r+f,u=u+f;n.stroke();n.closePath();break;default:}},f.prototype._drawResizeAdorner=function(i,r,u,f,o,s){var h=this,c,l,a,v,y,p,w,b;(h._adornerDrawState===1||h._adornerDrawState===2)&&(h._resizeHitRects.splice(0,h._resizeHitRects.length),c=new n.Rect(0,0,r,r),h._resizeHitRects.push(c),l=new n.Rect(u-r,0,r,r),h._resizeHitRects.push(l),a=new n.Rect(0,f-r,r,r),h._resizeHitRects.push(a),v=new n.Rect(u-r,f-r,r,r),h._resizeHitRects.push(v),s>=3*r?(y=new n.Rect(0,e(f/2-r/2),r,r),h._resizeHitRects.push(y),p=new n.Rect(u-r,e(f/2-r/2),r,r),h._resizeHitRects.push(p)):(h._resizeHitRects.push(t),h._resizeHitRects.push(t)),o>=3*r?(w=new n.Rect(e(u/2-r/2),0,r,r),h._resizeHitRects.push(w),b=new n.Rect(e(u/2-r/2),f-r,r,r),h._resizeHitRects.push(b)):(h._resizeHitRects.push(t),h._resizeHitRects.push(t)),i.save(),i.fillStyle="white",i.strokeStyle="#939393",i.linewidth=1,i.translate(.5,.5),$(h._resizeHitRects).each(function(){if(h){var n=this,t=n.x,r=n.y,u=n.width,f=n.height;i.beginPath();i.fillRect(t,r,u-1,f-1);i.strokeRect(t,r,u-1,f-1);i.stroke();i.closePath()}}))},f.prototype._drawMoveResizeContainer=function(){var n=this,u=n._commentManager;n._moveResizeContainerDom?$(n._moveResizeContainerDom).remove():n._moveResizeContainerDom=document.createElement("div");n._moveResizePanelDom?$(n._moveResizePanelDom).remove():n._moveResizePanelDom=document.createElement("div");var i=$(n._moveResizePanelDom),f=$(n._moveResizeContainerDom),e=u._mouseCapture,r=$(n._hostContainer),t=n._getViewportRect(n._rowViewportIndex,n._columnViewportIndex);i.css({position:"absolute",overflow:"hidden",top:t.y,left:t.x,width:t.width,height:t.height}).css("z-index",901).bind("mousemove",function(t){n._doMouseMove(t)}).bind("mouseup",function(t){n._doMouseUp(t)});f.addClass("gc-spread-moveResizeContainer").css("position","absolute").css("left",n._absLocation.x+n._hostMargin-t.x).css("top",n._absLocation.y+n._hostMargin-t.y).css("width",r.outerWidth()-2).css("height",r.outerHeight()-2).css("border","gray solid thin");i.append(n._moveResizeContainerDom);n._commentLayoutPanel&&n._commentLayoutPanel.appendChild(n._moveResizePanelDom)},f.prototype._doMoveResizeContainer=function(t){var i=this,a=i._comment,y=a&&a._sheet,k=i._absLocation,o=i._hostMargin,c=i._zoomFactor,p=y._commentManager,e=p._mouseCapture,s,l,r,h;if(e.capture){var v=i._getViewportScrollOffset(),u=t.pageX/c-e.x+v.x,f=t.pageY/c-e.y+v.y;if(u===0&&f===0)return;if(s=i._getViewportRect(i._rowViewportIndex,i._columnViewportIndex),l=$(i._moveResizeContainerDom),e.resizeDirct==-100){var w=e.cachedRect.x+u,b=e.cachedRect.y+f,h=i._convertRelLocationToAbsLocation(new n.Point(w,b));l.css("left",h.x+o-s.x).css("top",h.y+o-s.y)}else{switch(e.resizeDirct){case 0:r=i._getCommentTopLeftResizeRect(u,f);break;case 1:r=i._getCommentTopRightResizeRect(u,f);break;case 2:r=i._getCommentBottomLeftResizeRect(u,f);break;case 3:r=i._getCommentBottomRightResizeRect(u,f);break;case 4:r=i._getCommentMiddleLeftResizeRect(u);break;case 5:r=i._getCommentMiddleRightResizeRect(u);break;case 6:r=i._getCommentTopCenterResizeRect(f);break;case 7:r=i._getCommentBottomCenterResizeRect(f);break}h=i._convertRelLocationToAbsLocation(new n.Point(r.x,r.y));l.css("left",h.x+o-s.x).css("top",h.y+o-s.y).css("width",r.width*c-2*o-2).css("height",r.height*c-2*o-2)}}},f.prototype._attachEditor=function(){var n=this,i=n._comment,t;n.isEditing()||(t=n._commentManager._editorDom,$(n._host).remove(),n._detachHostEventHandler(),$(t).remove(),$(n._hostContainer).append(t),n._setDomStyle(t),n._formatCommentRect(t),$(t).focus(),t.selectionStart=t.value.length,n._attachEditorEventHandler(),i.commentState()!==2&&i.commentState(2))},f.prototype.detachEditor=function(){var t=this,i=t._comment,u=i._sheet,r,f;t.isEditing()&&(r=t._commentManager._editorDom,$(r).remove(),t._detachEditorEventHandler(),$(t._hostContainer).append(t._host),t._setDomStyle(t._host),t._attachHostEventHandler(),n.features.touch&&(t._touchContentManager=new n.CommentContentTouchManager(t._host,t,u.parent._touchEventProvider),t._touchContentManager.attach()),i.commentState()===2&&i.commentState(3),$(r).val()!==i.text()&&(f=new n.UndoRedo.CommentPropertyUndoAction(u,i,i.text(),$(r).val(),"text"),u._doCommand(f)))},f.prototype._getSheetHeight=function(n){var u,f,r;if(n===t||n===i)return-1;for(u=0,f=n.getRowCount(),r=0;r<f;r++)u+=n.getRowHeight(r,3)*this._zoomFactor;return u},f.prototype._getSheetWidth=function(n){var u,f,r;if(n===t||n===i)return-1;for(u=0,f=n.getColumnCount(),r=0;r<f;r++)u+=n.getColumnWidth(r,3)*this._zoomFactor;return u},f.prototype._getViewportHeight=function(n){var r=this,u=r._comment,t=u&&u._sheet,i;if(n===0||n===2)return t.getViewportHeight(n);else if(n===1){var e=t.getViewportBottomRow(0)+1,o=t.getViewportTopRow(2),f=0;for(i=e;i<=o;i++)f+=t.getRowHeight(i,3)*r._zoomFactor;return f}return-1},f.prototype._getViewportWidth=function(n){var r=this,u=r._comment,t=u&&u._sheet,i;if(n===0||n===2)return t.getViewportWidth(n);else if(n===1){var e=t.getViewportRightColumn(0)+1,o=t.getViewportLeftColumn(2),f=0;for(i=e;i<=o;i++)f+=t.getColumnWidth(i,3)*r._zoomFactor;return f}return-1},f.prototype._getTwoColumnDistance=function(n,t,i){for(var o=u(t,i),s=r(t,i),e=0,f=o;f<s;f++)e+=n.getColumnWidth(f,3)*this._zoomFactor;return e},f.prototype._getTwoRowDistance=function(n,t,i){for(var o=u(t,i),s=r(t,i),e=0,f=o;f<s;f++)e+=n.getRowHeight(f,3)*this._zoomFactor;return e},f.prototype._getViewportRect=function(t,i){var f=this,e=f._comment,o=e._sheet,s=f._commentManager,h=s.getCommentView(e),r=o._getSheetLayout(),u=new n.Rect(0,0,0,0);return u=r.viewportRect(t,i),t===0&&i===0||t===0&&i===2||t===2&&i===0||t===2&&i===2?(u.x=0,u.y=0,u.width=r.frozenWidth+r.viewportWidth+r.frozenTrailingWidth,u.height=r.frozenHeight+r.viewportHeight+r.frozenTrailingHeight):t===0&&i===1||t===2&&i===1?(u.x=r.frozenWidth,u.y=0,u.width=r.viewportWidth,u.height=r.frozenHeight+r.viewportHeight+r.frozenTrailingHeight):t===1&&i===0||t===1&&i===2?(u.x=0,u.y=r.frozenHeight,u.width=r.frozenWidth+r.viewportWidth+r.frozenTrailingWidth,u.height=r.viewportHeight):t===1&&i===1&&(u.x=r.frozenWidth,u.y=r.frozenHeight,u.width=r.viewportWidth,u.height=r.viewportHeight),u},f.prototype._setDomStyle=function(n){var i=this,t=i._comment,r=$(n);(n===i._editor||n===i._host)&&(n===i._editor?n.value=t.text():n.innerHTML=t.text().replace(/\r\n|\n|\r/g,"<br/>"),r.css("font-family",t.fontFamily()).css("font-style",t.fontStyle()).css("font-size",t.fontSize()).css("font-weight",t.fontWeight()).css("color",t.foreColor()).css("background-color",t.backColor()).css("text-align",t.horizontalAlign()).css("text-decoration",t.textDecoration()),t.padding()?r.css("padding",t.padding().toString()):r.css("padding","0px"))},f.prototype.isOpen=function(){var n=this;return n._floatBlockCanvasContainer&&n._floatBlockCanvasContainer.parentNode?!0:!1},f.prototype.isActive=function(){var n=this;return n.isOpen()&&n._comment===n._commentManager.getActiveComment()?!0:!1},f.prototype.isEditing=function(){var n=this;return n.isActive()?$(n._hostContainer).find("textarea").length>0:!1},f.prototype.getCommentRect=function(){var i=this,u=i._comment,e=u&&u._sheet,o=i._zoomFactor,f=t,r;return i.isOpen()&&(r=i._comment._sheet._getSheetLayout(),f=new n.Rect(i._absLocation.x+r.headerX+r.rowHeaderWidth,i._absLocation.y+r.headerY+r.colHeaderHeight,i._getActualWidth(),i._getActualHeight())),f},f.prototype.getCommentEditAreaRect=function(){var i=this,u=i._comment,a=u&&u._sheet,o=i._zoomFactor,r,s,h,c,l,f,e;return i.isOpen()&&(r=i.getCommentRect(),r)?(f=(i._hostMargin+u.borderWidth())*o,e=(i._hostMargin+u.borderWidth())*o,s=r.x+f,h=r.y+e,c=r.width-2*f,l=r.height-2*e,new n.Rect(s,h,c,l)):t},f.prototype._setCursorState=function(n){var i=this,r=i._comment,u=r._sheet,t=n.target,f=i._commentManager._mouseCapture,e;if(f.capture){(t.className===i._hostClassName||t.className===i._floatBlockCanvasClassName||t.className===i._lineCanvasClassName||t.className==="gc-spread-floatPanel")&&(t.style.cursor=f.resizeDirct>=0?"crosshair":"move");return}else{if(t.className===i._hostClassName)if(u.isProtected&&r.lockText()){t.style.cursor=r.locked()?"default":"move";return}else{t.style.cursor="text";return}if(t.className===i._floatBlockCanvasClassName||t.className===i._hostContainerClassName)if(u.isProtected&&r.locked()){t.style.cursor="default";return}else{e=i._getResizeDirection(n);switch(e){case 0:t.style.cursor="nw-resize";return;case 1:t.style.cursor="ne-resize";return;case 2:t.style.cursor="sw-resize";return;case 3:t.style.cursor="se-resize";return;case 4:t.style.cursor="w-resize";return;case 5:t.style.cursor="e-resize";return;case 6:t.style.cursor="n-resize";return;case 7:t.style.cursor="s-resize";return;default:t.style.cursor="move";return}}}t.style.cursor="default"},f.prototype._doMouseDownToEdit=function(t){var i=this,r=i._comment,u=r&&r._sheet;if(u.endEdit(),u.unSelectAllFloatingObjects(),i._touchContentManager&&!t.isTouch&&i._touchContentManager.preProcessMouseDown(t)){n.util.cancelDefault(t);return}return i._commentManager.activateComment(r),r.commentState(2),i._doMouseUp(t),n.util.cancelDefault(t)},f.prototype._doMouseDownToDragOrResize=function(t){var i=this,r=i._comment,u=r&&r._sheet,h=i._zoomFactor,c=i._commentManager,f=c._mouseCapture;if(u.endEdit(),u.unSelectAllFloatingObjects(),i._touchManager&&!t.isTouch&&i._touchManager.preProcessMouseDown(t)){n.util.cancelDefault(t);return}f.x=t.pageX/h;f.y=t.pageY/h;f.cachedRect=new n.Rect(r.location().x,r.location().y,r.width(),r.height());f.resizeDirct=i._getResizeDirection(t);i._handleDocumentMouseMove();f.capture=!0;i._setCursorState(t);c.activateComment(r);r.commentState(1);u.isProtected&&r.locked()||(i._moveInfo={},i._moveInfo.startTopRow=u.getViewportTopRow(i._rowViewportIndex),i._moveInfo.startLeftColumn=u.getViewportLeftColumn(i._columnViewportIndex),i._drawMoveResizeContainer(),f.resizeDirct===-100?i._isMoving=!0:i._isResizing=!0);var e=u._eventHandler,l=e._getCanvasOffset(),o=new n.Point(t.pageX-l.left,t.pageY-l.top),s=u.hitTest(o.x,o.y);e.startHitInfo={scrollRowViewportIndex:s.rowViewportIndex,scrollColViewportIndex:s.colViewportIndex,hitTestType:s.hitTestType};e.mousePosition=o;e.startScroll();e.isCommentWorking=!0;t.stopPropagation()},f.prototype._getAdjustedCommentRect=function(t,i,r){var u=this,g=u._comment,f=g&&g._sheet,e=u._hostMargin,b=u._zoomFactor,nt=u._getSheetWidth(f),tt=u._getSheetHeight(f),it=u._getViewportRect(u._rowViewportIndex,u._columnViewportIndex),o,s,h,ut,ft,et,ot;arguments.length===1?(o=u._getActualWidth(),s=u._getActualHeight(),h=!1):arguments.length===3&&(o=i*b,s=r*b,h=!0);var p=t.x,w=t.y,c=f._getSheetLayout(),rt=u._getCellRect(f,0,0,u._rowViewportIndex,u._columnViewportIndex),k=t.x+(0-(rt.x-c.rowHeaderWidth))+o-e,d=t.y+(0-(rt.y-c.colHeaderHeight))+s-e,l,a,v,y;return u._columnViewportIndex===0?(l=0-e,v=c.width-c.rowHeaderWidth):u._columnViewportIndex===1?(ut=u._getTwoColumnDistance(f,f.getViewportRightColumn(0)+1,f.getViewportLeftColumn(1)),l=it.x-e-ut,ft=u._getViewportWidth(2),v=nt-ft):u._columnViewportIndex===2&&(l=0-e,v=nt),p<l&&(h&&(o-=l-p),p=l),k>v&&(h?o-=k-v:p-=k-v),u._rowViewportIndex===0?(a=0-e,y=c.height-c.colHeaderHeight):u._rowViewportIndex===1?(et=u._getTwoRowDistance(f,f.getViewportBottomRow(0)+1,f.getViewportTopRow(1)),a=it.y-e-et,ot=u._getViewportHeight(2),y=tt-ot):u._rowViewportIndex===2&&(a=0-e,y=tt),w<a&&(h&&(s-=a-w),w=a),d>y&&(h?s-=d-y:w-=d-y),new n.Rect(p,w,o/b,s/b)},f.prototype._getViewportScrollOffset=function(){var t=this,i=t._comment._sheet,r,u,f=t._moveInfo.startTopRow,e=t._moveInfo.startLeftColumn,o=i.getViewportTopRow(t._rowViewportIndex),s=i.getViewportLeftColumn(t._columnViewportIndex),h=t._getTwoRowDistance(i,f,o),c=t._getTwoColumnDistance(i,e,s);return r=e<s?c:-c,u=f<o?h:-h,new n.Point(r,u)},f.prototype._doMoveResizeComment=function(t){var i=this,r=i._comment,s=r&&r._sheet,a=i._zoomFactor,p=s._commentManager,h=p._mouseCapture,u;if(h.capture){var v=i._getViewportScrollOffset(),f=t.pageX/a-h.x+v.x,e=t.pageY/a-h.y+v.y;if(f===0&&e===0)return;if(h.resizeDirct==-100){var w=h.cachedRect.x+f,b=h.cachedRect.y+e,y=i._convertRelLocationToAbsLocation(new n.Point(w,b)),o=i._getAdjustedCommentRect(y),c=i._convertAbsLocationToRelLocation(new n.Point(o.x,o.y));(c.x!==r.location().x||c.x!==r.location().y)&&s._doCommand(new n.UndoRedo.CommentPropertyUndoAction(s,r,r.location().clone(),c,"location"))}else{r._autoSize=!1;switch(h.resizeDirct){case 0:u=i._getCommentTopLeftResizeRect(f,e);break;case 1:u=i._getCommentTopRightResizeRect(f,e);break;case 2:u=i._getCommentBottomLeftResizeRect(f,e);break;case 3:u=i._getCommentBottomRightResizeRect(f,e);break;case 4:u=i._getCommentMiddleLeftResizeRect(f);break;case 5:u=i._getCommentMiddleRightResizeRect(f);break;case 6:u=i._getCommentTopCenterResizeRect(e);break;case 7:u=i._getCommentBottomCenterResizeRect(e);break}var y=i._convertRelLocationToAbsLocation(new n.Point(u.x,u.y)),o=i._getAdjustedCommentRect(y,u.width,u.height),c=i._convertAbsLocationToRelLocation(new n.Point(o.x,o.y)),l=new n.UndoRedo.CommentUndoTransaction;(c.x!==r.location().x||c.y!==r.location().y)&&l.add(new n.UndoRedo.CommentPropertyUndoAction(s,r,r.location().clone(),c,"location"));o.width!==r.width()&&l.add(new n.UndoRedo.CommentPropertyUndoAction(s,r,r.width(),o.width,"width"));o.height!==r.height()&&l.add(new n.UndoRedo.CommentPropertyUndoAction(s,r,r.height(),o.height,"height"));s._doCommand(l)}}},f.prototype._doMouseMove=function(t){var i=this,u=i._comment._sheet;if(this._setCursorState(t),!u.getSelections()||!(u.getSelections().length>0)){if(i._touchManager&&!t.isTouch&&i._touchManager.preProcessMouseMove(t)){n.util.cancelDefault(t);return}if(i._touchContentManager&&!t.isTouch&&i._touchContentManager.preProcessMouseMove(t)){n.util.cancelDefault(t);return}var o=i._commentManager,s=t.target,r=u._eventHandler,f=r._getCanvasOffset(),e=new n.Point(t.pageX-f.left,t.pageY-f.top);return s&&o._mouseCapture.capture&&(i._moveResizeContainerDom&&i._doMoveResizeContainer(t),i._rowViewportIndex===1&&(r.mousePosition.y=e.y),i._columnViewportIndex===1&&(r.mousePosition.x=e.x),r.continueScroll()),n.util.cancelDefault(t)}},f.prototype._doMouseUp=function(t){var i=this,r=i._comment._sheet;if(!r.getSelections()||!(r.getSelections().length>0)){if(i._touchManager&&!t.isTouch&&i._touchManager.preProcessMouseUp(t)){n.util.cancelDefault(t);return}if(i._touchContentManager&&!t.isTouch&&i._touchContentManager.preProcessMouseUp(t)){n.util.cancelDefault(t);return}var f=t.target,e=i._commentManager,u=r._eventHandler;return u.isCommentWorking=!1,u.stopScroll(),f&&(i._doMoveResizeComment(t),i._moveResizePanelDom&&($(i._moveResizePanelDom).remove(),i._moveResizePanelDom=null,i._isMoving=!1,i._isResizing=!1),i._unhandleDocumentMouseMove(),e._mouseCapture.capture=!1,i._setCursorState(t)),n.util.cancelDefault(t)}},f.prototype._getResizeDirection=function(n){var i=this;if(i._resizeHitRects.length>0&&(i._adornerDrawState===1||i._adornerDrawState===2)){var f=n.target,r=n.pageX-$(f).offset().left,u=n.pageY-$(f).offset().top,t=i._resizeHitRects[0];if(t&&t.contains(r,u))return 0;if(t=i._resizeHitRects[1],t&&t.contains(r,u))return 1;if(t=i._resizeHitRects[2],t&&t.contains(r,u))return 2;if(t=i._resizeHitRects[3],t&&t.contains(r,u))return 3;if(t=i._resizeHitRects[4],t&&t.contains(r,u))return 4;if(t=i._resizeHitRects[5],t&&t.contains(r,u))return 5;if(t=i._resizeHitRects[6],t&&t.contains(r,u))return 6;if(t=i._resizeHitRects[7],t&&t.contains(r,u))return 7}return-100},f.prototype._getCommentTopLeftResizeRect=function(t,i){var r=this,f,e,o,s,u=r._commentManager._mouseCapture,h=u.cachedRect.width-2*r._hostMargin-t,c=u.cachedRect.height-2*r._hostMargin-i;return h>=0?(f=u.cachedRect.x+t,o=h+2*r._hostMargin):(f=u.cachedRect.x+u.cachedRect.width-2*r._hostMargin,o=-h+2*r._hostMargin),c>=0?(e=u.cachedRect.y+i,s=c+2*r._hostMargin):(e=u.cachedRect.y+u.cachedRect.height-2*r._hostMargin,s=-c+2*r._hostMargin),new n.Rect(f,e,o,s)},f.prototype._getCommentTopRightResizeRect=function(t,i){var r=this,e,o,s,h,u=r._commentManager._mouseCapture,f=u.cachedRect.width-2*r._hostMargin+t,c=u.cachedRect.height-2*r._hostMargin-i;return f>=0?(e=u.cachedRect.x,s=f+2*r._hostMargin):(e=u.cachedRect.x+f,s=-f+2*r._hostMargin),c>=0?(o=u.cachedRect.y+i,h=c+2*r._hostMargin):(o=u.cachedRect.y+u.cachedRect.height-2*r._hostMargin,h=-c+2*r._hostMargin),new n.Rect(e,o,s,h)},f.prototype._getCommentBottomLeftResizeRect=function(t,i){var r=this,e,o,s,h,u=r._commentManager._mouseCapture,c=u.cachedRect.width-2*r._hostMargin-t,f=u.cachedRect.height-2*r._hostMargin+i;return c>=0?(e=u.cachedRect.x+t,s=c+2*r._hostMargin):(e=u.cachedRect.x+u.cachedRect.width-2*r._hostMargin,s=-c+2*r._hostMargin),f>=0?(o=u.cachedRect.y,h=f+2*r._hostMargin):(o=u.cachedRect.y+f,h=-f+2*r._hostMargin),new n.Rect(e,o,s,h)},f.prototype._getCommentBottomRightResizeRect=function(t,i){var r=this,o,s,h,c,u=r._commentManager._mouseCapture,f=u.cachedRect.width-2*r._hostMargin+t,e=u.cachedRect.height-2*r._hostMargin+i;return f>=0?(o=u.cachedRect.x,h=f+2*r._hostMargin):(o=u.cachedRect.x+f,h=-f+2*r._hostMargin),e>=0?(s=u.cachedRect.y,c=e+2*r._hostMargin):(s=u.cachedRect.y+e,c=-e+2*r._hostMargin),new n.Rect(o,s,h,c)},f.prototype._getCommentMiddleLeftResizeRect=function(t){var r=this,u,o,f,s,i=r._commentManager._mouseCapture,e=i.cachedRect.width-2*r._hostMargin-t;return e>=0?(u=i.cachedRect.x+t,f=e+2*r._hostMargin):(u=i.cachedRect.x+i.cachedRect.width-2*r._hostMargin,f=-e+2*r._hostMargin),o=i.cachedRect.y,s=i.cachedRect.height,new n.Rect(u,o,f,s)},f.prototype._getCommentMiddleRightResizeRect=function(t){var r=this,f,o,e,s,i=r._commentManager._mouseCapture,u=i.cachedRect.width-2*r._hostMargin+t;return u>=0?(f=i.cachedRect.x,e=u+2*r._hostMargin):(f=i.cachedRect.x+u,e=-u+2*r._hostMargin),o=i.cachedRect.y,s=i.cachedRect.height,new n.Rect(f,o,e,s)},f.prototype._getCommentTopCenterResizeRect=function(t){var r=this,o,u,s,f,i=r._commentManager._mouseCapture,e=i.cachedRect.height-2*r._hostMargin-t;return o=i.cachedRect.x,s=i.cachedRect.width,e>=0?(u=i.cachedRect.y+t,f=e+2*r._hostMargin):(u=i.cachedRect.y+i.cachedRect.height-2*r._hostMargin,f=-e+2*r._hostMargin),new n.Rect(o,u,s,f)},f.prototype._getCommentBottomCenterResizeRect=function(t){var r=this,o,f,s,e,i=r._commentManager._mouseCapture,u=i.cachedRect.height-2*r._hostMargin+t;return o=i.cachedRect.x,s=i.cachedRect.width,u>=0?(f=i.cachedRect.y,e=u+2*r._hostMargin):(f=i.cachedRect.y+u,e=-u+2*r._hostMargin),new n.Rect(o,f,s,e)},f.prototype._attachMouseWheelEvent=function(t){var r=this,u=this._comment._sheet,i;if(t){i="";switch(t){case r._floatBlockCanvas:i=".floatBlockCanvas";case r._hostContainer:i=".hostContainer";case r._lineCanvasContainer:i=".lineCanvasContainer";case r._host:i=".host";case r._editor:i=".editor"}i&&($(t).unbind("gcmousewheel"+i),$(t).bind("gcmousewheel"+i,function(t){u._mouseWheelDelegate(t.originalEvent);n.util.cancelDefault(t)}))}},f.prototype._attachFloatBlockCanvasEventHandler=function(){var n=this,i=n._comment,r=i&&i&&i._sheet,t;n._detachFloatBlockCanvasEventHandler();t=".floatBlockCanvas";$(n._floatBlockCanvas).bind("mousedown"+t,function(t){n._doMouseDownToDragOrResize(t)}).bind("mousemove"+t,function(t){n._doMouseMove(t)}).bind("mouseup"+t,function(t){n._doMouseUp(t)}).bind("gcmousewheel"+t,function(n){r&&r._mouseWheelDelegate(n.originalEvent)})},f.prototype._detachFloatBlockCanvasEventHandler=function(){var n=this;$(n._floatBlockCanvas).unbind(".floatBlockCanvas")},f.prototype._attachHostContainerEventHandler=function(){var n=this,i=n._comment,r=i&&i._sheet,t;n._detachHostContainerEventHandler();t=".hostContainer";$(n._hostContainer).bind("mousedown"+t,function(t){n._doMouseDownToDragOrResize(t)}).bind("mousemove"+t,function(t){n._doMouseMove(t)}).bind("mouseup"+t,function(t){n._doMouseUp(t)}).bind("gcmousewheel"+t,function(n){r&&r._mouseWheelDelegate(n.originalEvent)})},f.prototype._detachHostContainerEventHandler=function(){var n=this;$(n._hostContainer).unbind(".hostContainer")},f.prototype._attachLineCanvasEventHandler=function(){var t=this,f=t._comment,n=f&&f._sheet,u=n._commentManager,i,r;(t._detachLineCanvasEventHandler(),n)&&(i=n._eventHandler._getCanvasOffset(),r=".lineCanvas",$(t._lineCanvas).bind("mousedown"+r,function(r){var s=n.hitTest(r.pageX-i.left,r.pageY-i.top),f=s.commentHitInfo,o,e;f?(o=f.comment,e=u.getCommentView(o),f.area==="editArea"?e._doMouseDownToEdit(r):f.area==="moveResizeArea"&&e._doMouseDownToDragOrResize(r),$(e._floatBlockCanvasContainer).css("z-index",parseInt($(t._lineCanvasContainer).css("z-index")+1))):n._mouseDownDelegate(r)}).bind("mousemove"+r,function(r){var h=n.hitTest(r.pageX-i.left,r.pageY-i.top),f=h.commentHitInfo,o,s,e;f?(o=f.comment,s=u.getCommentView(o),s._doMouseMove(r),f.area==="editArea"?t._lineCanvas.style.cursor="text":f.area==="moveResizeArea"&&(t._lineCanvas.style.cursor="move")):(n._mouseMoveDelegate(r),e=n._getCanvas(),e&&(t._lineCanvas.style.cursor=e.style.cursor))}).bind("mouseup"+r,function(t){var o=n.hitTest(t.pageX-i.left,t.pageY-i.top),r=o.commentHitInfo,f,e;r?(f=r.comment,e=u.getCommentView(f),e._doMouseUp(t)):n._mouseUpDelegate(t)}).bind("dblclick"+r,function(t){n._dblClickDelegate(t)}).bind("gcmousewheel"+r,function(t){n._mouseWheelDelegate(t.originalEvent)}))},f.prototype._detachLineCanvasEventHandler=function(){var n=this;$(n._lineCanvas).unbind(".lineCanvas")},f.prototype._attachHostEventHandler=function(){var n=this,i=n._comment,r=i&&i._sheet,t;i.commentState()!==2&&n._host&&(n._detachHostEventHandler(),t=".host",$(n._host).bind("mousedown"+t,function(t){n._doMouseDownToEdit(t)}).bind("mousemove"+t,function(t){n._doMouseMove(t)}).bind("mouseup"+t,function(t){n._doMouseUp(t)}).bind("gcmousewheel"+t,function(n){r&&r._mouseWheelDelegate(n.originalEvent)}))},f.prototype._detachHostEventHandler=function(){var n=this,t=n._comment;t.commentState()!==2&&n._host&&$(n._host).unbind(".host")},f.prototype._attachEditorEventHandler=function(){var r=this,i=r._comment,u=i&&i._sheet,f=r._editor,t;i.commentState()===2&&f&&(this._detachEditorEventHandler(),t=".editor",$(f).bind("mousedown"+t,function(n){n.stopPropagation()}).bind("mousemove"+t,function(n){n.stopPropagation()}).bind("mouseup"+t,function(n){n.stopPropagation()}).bind("gcmousewheel"+t,function(n){u&&u._mouseWheelDelegate(n.originalEvent)}).bind("input"+t,function(n){i.autoSize()&&r._doAutosize()}).bind("keydown"+t,function(t){(t.keyCode===27||t.keyCode===9)&&(i.commentState(1),n.util.cancelDefault(t),n.FocusHelper.setActiveElement(u))}))},f.prototype._doAutosize=function(){var f=this,n=f._comment,l=n&&n._sheet,t,i,v,y,h,c,p,w,b;n.commentState()===2?(t=f._editor,i=t.value.split("\n")):(t=f._host,i=t.innerHTML.split("<br>"));var k=$(t).height(),d=$(t).width(),e,o,s=0,a=t.style,u="";if(a.font?(s=l._getFontHeight(a.font),u+=a.font):(n.fontStyle()&&(u+=" "+n.fontStyle()),n.fontWeight()&&(u+=" "+n.fontWeight()),n.fontSize()&&(u+=" "+n.fontSize()),n.fontFamily()&&(u+=" "+n.fontFamily()),s=l._getFontHeight(u)),v=s,y=5,i&&i.length>0){for(e=r(i.length*s,v),h=0,c=0;c<i.length;c++)p=l._getStringWidth(i[c],u),h<p&&(h=p);o=r(h,y)}else e=v,o=y;$(t).css("height",e).css("width",o);n.commentState()===2&&(n._text=t.value);f._isAutosizing=!0;w=e-k;w!==0&&n._changeProperty("height",n.height()+w);b=o-d;b!==0&&n._changeProperty("width",n.width()+b);f._isAutosizing=!1},f.prototype._detachEditorEventHandler=function(){var n=this,i=n._comment,t=n._editor;i.commentState()===2&&t&&$(t).unbind(".editor")},f.prototype._handleDocumentMouseMove=function(){var t=this,i=this._commentManager._mouseCapture,n;i.capture||(n=".gcComment",$(document).bind("mousemove"+n,function(n){t._doMouseMove(n)}).bind("mouseup"+n,function(n){t._doMouseUp(n)}),i.capture=!0)},f.prototype._unhandleDocumentMouseMove=function(){var n=this._commentManager._mouseCapture;n.capture&&(n.capture=!1,$(document).unbind(".gcComment"))},f}();n.CommentView=s;l=function(){function r(n){var i=this;i._sheet=n;i._mouseCapture={capture:!1,x:0,y:0,cachedRect:t,resizeDirct:-100};i._editorDom=t;i._hoverShowComment=t;i._activeComment=t;i._commentList=[];i._commentViewList=[];i.createEditDom();i._bindEventsOnSheet()}return r.prototype.createEditDom=function(){var n=document.createElement("textarea");$(n).addClass("gc-comment-editor").css("left",0).css("top",0).css("position","absolute").css("margin",0).css("padding",0).css("word-wrap","break-word").css("word-break","normal").css("overflow","hidden").css("resize","none").css("outline","none").css("border","0px").attr("autocomplete","off").attr("gcUIElement","gcEditingInput");this._editorDom=n},r.prototype.getCommentList=function(){for(var t=this,i=[],n=0;n<t._commentList.length;n++)i.push(t._commentList[n]);return i},r.prototype.getHoverShownComment=function(){return this._hoverShowComment},r.prototype._bindEventsOnSheet=function(){var t=this,i=t._sheet;i&&(i._bind(n.Events.ColumnChanged,function(n,i){var r=i.propertyName;(r==="width"||r==="isVisible")&&t._updateCommentsLayoutWhenRowColumnChanged()}),i._bind(n.Events.RowChanged,function(n,i){var r=i.propertyName;(r==="height"||r==="isVisible")&&t._updateCommentsLayoutWhenRowColumnChanged()}),i._bind(n.Events.ColumnWidthChanged,function(n,i){t._updateCommentsLayoutWhenRowColumnChanged()}),i._bind(n.Events.RowHeightChanged,function(n,i){t._updateCommentsLayoutWhenRowColumnChanged()}),i._bind(n.Events.CommentChanged,function(n,i){var r=i&&i.propertyName,u=t.getCommentView(i.comment);u&&(r==="location"?u.updateLayoutWhenLocationChanged():(r==="width"||r==="height")&&u.updateLayoutWhenWidthHeightChanged())}))},r.prototype._addCommentView=function(t){var i=this;t&&n.ArrayHelper.indexOf(i._commentViewList,t)===-1&&this._commentViewList.push(t)},r.prototype._removeCommentView=function(t){this._commentViewList.splice(n.ArrayHelper.indexOf(this._commentViewList,t),1)},r.prototype.getCommentView=function(n){var i,r;if(!n)return t;for(i=0;i<this._commentViewList.length;i++)if(r=this._commentViewList[i],r.getComment()===n)return r;return t},r.prototype.hasComment=function(){return this._commentList.length>0},r.prototype.addComment=function(n,t,i){var r=this;i&&!r.containsComment(i)&&(i._sheet=r._sheet,i._rowIndex=n,i._colIndex=t,i._zIndex=898,r._updateCommentZIndex(),r._commentList.push(i),r._sheet.invalidate())},r.prototype._updateCommentZIndex=function(){for(var i=this,t=i._commentList,n=0;n<t.length;n++)t[n]._zIndex--},r.prototype._getTopCommentZIndex=function(){var n=this,t,i,r;if(n._commentList.length>0){for(t=n._commentList[0].zIndex(),i=1;i<n._commentList.length;i++)r=n._commentList[i],t<r.zIndex()&&(t=r.zIndex());return t}return 0},r.prototype.removeComment=function(t){var i=this,u=i._commentList,r;t&&(i.hideComment(t),u.splice(n.ArrayHelper.indexOf(u,t),1),r=i.getCommentView(t),r&&i._removeCommentView(r))},r.prototype.containsComment=function(t){var i=this;return n.ArrayHelper.indexOf(i._commentList,t)!==-1?!0:!1},r.prototype.clear=function(n,i,r,u){var h=this,f=h._sheet,c=f.isPaintSuspended(),e,o,s;for(f.isPaintSuspended(!0),e=0;e<r;e++)for(o=0;o<u;o++)s=f.getComment(e+n,o+i),s&&(h.removeComment(s),f.setComment(e+n,o+i,t));f.isPaintSuspended(c)},r.prototype.addRows=function(n,t){for(var r,u,f=this,e=f._commentList,o=f._commentViewList,i=0;i<e.length;i++)r=e[i],n<=r._rowIndex&&(r._rowIndex+=t);for(i=0;i<o.length;i++)u=o[i],u.isOpen()&&u.addRows(n,t)},r.prototype.addColumns=function(n,t){for(var r,u,f=this,e=f._commentList,o=f._commentViewList,i=0;i<e.length;i++)r=e[i],n<=r._colIndex&&(r._colIndex+=t);for(i=0;i<o.length;i++)u=o[i],u.isOpen()&&u.addColumns(n,t)},r.prototype.removeRows=function(n,t){for(var r,e,f=this,u=f._commentList,o=f._commentViewList,i=0;i<u.length;i++)r=u[i],r._rowIndex>=n&&r._rowIndex<n+t&&(f.removeComment(r),i--);for(i=0;i<u.length;i++)r=u[i],n<r._rowIndex&&(r._rowIndex-=t);for(i=0;i<o.length;i++)e=o[i],e.isOpen()&&e.removeRows(n,t)},r.prototype.removeColumns=function(n,t){for(var r,e,f=this,u=f._commentList,o=f._commentViewList,i=0;i<u.length;i++)r=u[i],r._colIndex>=n&&r._colIndex<n+t&&(f.removeComment(r),i--);for(i=0;i<u.length;i++)r=u[i],n<r._colIndex&&(r._colIndex-=t);for(i=0;i<o.length;i++)e=o[i],e.isOpen()&&e.removeColumns(n,t)},r.prototype.getActiveComment=function(){return this._activeComment},r.prototype.activateComment=function(n){var t=this;n&&n!==t._activeComment&&(t.deactivateComment(),t._activeComment=n)},r.prototype.deactivateComment=function(){var i=this,r=i._activeComment,n;r&&(n=i.getCommentView(r),!n||n._isMoving||n._isResizing||(n.isEditing()&&n.detachEditor(),r.commentState(3),i._activeComment=t))},r.prototype.showComment=function(n){var i=this,t;n&&(t=i.getCommentView(n),t||(t=new s(n,i),i._addCommentView(t)),t.open())},r.prototype.showAllComments=function(){for(var n=0;n<this._commentList.length;n++)this.showComment(this._commentList[n])},r.prototype.showCommentLayoutPanel=function(){var n=this._sheet;$(n._commentRender._commentLayoutPanel).show()},r.prototype.hideComment=function(n){var i=this,r=i.getCommentView(n);r&&r.isOpen()&&(r.close(),n===i._activeComment&&i._sheet._loadAndSetSheetSelections());clearTimeout(n._timeout);n._timeout=t},r.prototype.hideAllComments=function(){for(var n=0;n<this._commentList.length;n++)this.hideComment(this._commentList[n])},r.prototype.hideCommentLayoutPanel=function(){var n=this._sheet;$(n._commentRender._commentLayoutPanel).hide()},r.prototype.hoverShowComment=function(n){var i=this,r=i._activeComment;if(r)if(r.displayMode()===1){if(r.commentState()===2)return}else if(r.commentState()===2||r.commentState()===1)return;n!==i._hoverShowComment&&(i._hoverShowComment&&i.hideComment(i._hoverShowComment),n&&n.displayMode()==2?i._mouseCapture.capture||n._timeout||(i._hoverShowComment=n,n._timeout=setTimeout(function(){i.showComment(n)},200)):i._hoverShowComment=t)},r.prototype._isHitTestComment=function(n,t,i){var u=this.getCommentView(n),r;return u&&(r=u.getCommentRect(),r)?r.contains(t,i):!1},r.prototype._isHitTestCommentEditArea=function(n,t,i){var u=this.getCommentView(n),r;return u&&(r=u.getCommentEditAreaRect(),r)?r.contains(t,i):!1},r.prototype.getCommentHitInfo=function(n,i){for(var u,f=this,r=t,e=0;e<f._commentList.length;e++)u=f._commentList[e],f._isHitTestComment(u,n,i)&&(r?u.zIndex()>r.zIndex()&&(r=u):r=u);return r?f._isHitTestCommentEditArea(r,n,i)?{x:n,y:i,comment:r,area:"editArea"}:{x:n,y:i,comment:r,area:"moveResizeArea"}:t},r.prototype.getCommentActualZIndex=function(n){var t=this,r=t._sheet,i=t._getTopCommentZIndex();if(n===t._hoverShowComment)return i+2;else if(n===t._activeComment)return i+1;return n.zIndex()},r.prototype._updateCommentsLayoutWhenRowColumnChanged=function(){for(var i,t=this._commentViewList,n=0;n<t.length;n++)i=t[n],i.updateLayoutWhenRowColumnChanged()},r.prototype.updateCommentsLayoutWhenSheetScroll=function(){for(var i,t=this._commentViewList,n=0;n<t.length;n++)i=t[n],i.updateLayoutWhenSheetScroll()},r.prototype.fromJSON=function(n,t){var r,u,i;if(n&&n.length!==0)for(r=0;r<n.length;r++)u=n[r],i=new o,i.fromJSON(u,t),i.commentState()!==3&&(this._activeComment=i),this._sheet.setComment(i._rowIndex,i._colIndex,i)},r.prototype.toJSON=function(){var n=this._commentList,t,r;if(!n||n.length===0)return i;for(t=[],r=0;r<n.length;r++)t.push(n[r].toJSON());return t.length===0?i:t},r}();n.CommentManager=l;a=function(){function n(n){this._sheet=t;this.showWhenTouchMoveOrScroll=!0;var i=this;i._commentLayoutPanel=i._createCommentLayoutPanel();n.appendChild(i._commentLayoutPanel)}return n.prototype._createCommentLayoutPanel=function(){var t=this,n=document.createElement("div");return $(n).addClass("comment-layoutPanel").css("position","absolute").css("left",0).css("top",0).css("height",0).css("width",0).css("overflow","visible").css("z-index",701),n},n.prototype.renderCommentFloatPanel=function(n){var t=this,f=t._sheet||n,i,u,r;f._commentManager.hasComment()&&(i=n._getSheetLayout(),$(t._commentLayoutPanel).css("left",i.x+i.rowHeaderWidth).css("top",i.y+i.colHeaderHeight),t._sheet!==n&&(t._sheet&&(u=t._sheet._commentManager),u&&(r=u.getActiveComment(),r&&r.commentState()===2&&r._changeProperty("commentState",1)),t._sheet=n))},n.prototype.renderCommentCellAdorner=function(n,t,i){var c=i.row,l=i.col,u=i.x,f=i.y,r=i.width,o=i.height,s=this,h,e;t===3&&s._sheet&&(h=s._sheet.getComment(c,l),h&&(e=6,n&&r>0&&o>0&&(n.save(),n.rect(u,f,r,o),n.clip(),n.fillStyle="red",n.beginPath(),n.moveTo(u+r-e,f),n.lineTo(u+r,f),n.lineTo(u+r,f+e),n.lineTo(u+r-e,f),n.fill(),n.restore())))},n.prototype.renderComment=function(n){var f,e,u,i,r,o,s;if(this.showWhenTouchMoveOrScroll)n.showCommentLayoutPanel();else{n.hideCommentLayoutPanel();return}for(f=this._sheet,e=n.getCommentList(),u=0;u<e.length;u++)i=e[u],r=n.getCommentView(i),this._canShowComment(n,i)?(i.displayMode()===1&&i===n.getHoverShownComment()&&(n._hoverShowComment=t),r&&r.isOpen()?r.updateLayout():n.showComment(i)):r&&r.isOpen()&&n.hideComment(i);o=n.getActiveComment();o&&(s=n.getCommentView(o),s&&s.isOpen()&&f.getSelections().length>0&&f._selectionModel.clear())},n.prototype._canShowComment=function(n,t){var i=this._sheet;if(i.getColumnWidth(t._colIndex)&&i.getRowHeight(t._rowIndex))switch(t.displayMode()){case 1:return!0;case 2:if(t.commentState()===3){if(t===n.getHoverShownComment())return!0}else return n&&t!==n.getHoverShownComment()&&(n._hoverShowComment=t),!0}return!1},n}();n.CommentRender=a})(n.Sheets||(n.Sheets={}));var t=n.Sheets})(GcSpread||(GcSpread={}))
